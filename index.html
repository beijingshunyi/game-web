<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Telegram监控管理系统</title>
  <!-- 引入 Element Plus CSS 和图标 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.7.0/dist/index.css">
  <script src="https://unpkg.com/element-plus@2.7.0/dist/index.full.min.js"></script>
  <script src="https://unpkg.com/axios@1.6.8/dist/axios.min.js"></script>
  <!-- 配置 Tailwind 自定义样式 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#409EFF',
            sidebar: '#272E3B',
            sidebarActive: '#1F2530'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sidebar-item {
        @apply flex items-center px-4 py-3 text-white hover:bg-sidebarActive cursor-pointer transition-colors;
      }
      .sidebar-item-active {
        @apply bg-sidebarActive border-l-4 border-primary;
      }
      .card-header {
        @apply flex justify-between items-center mb-4;
      }
    }
  </style>
</head>
<body class="flex h-screen overflow-hidden">
  <!-- 侧边栏 -->
  <div class="w-64 bg-sidebar flex-shrink-0">
    <div class="p-4 text-white text-xl font-bold border-b border-gray-700">
      监控管理系统
    </div>
    <div class="mt-4">
      <div class="sidebar-item sidebar-item-active" data-page="dashboard">
        <i class="el-icon-menu mr-3"></i>
        <span>仪表盘</span>
      </div>
      <div class="sidebar-item" data-page="monitorLogs">
        <i class="el-icon-document mr-3"></i>
        <span>监控日志</span>
      </div>
      <div class="sidebar-item" data-page="sendRecords">
        <i class="el-icon-message mr-3"></i>
        <span>发送记录</span>
      </div>
      <div class="sidebar-item" data-page="keywords">
        <i class="el-icon-setting mr-3"></i>
        <span>关键词管理</span>
      </div>
      <div class="sidebar-item" data-page="groups">
        <i class="el-icon-user-group mr-3"></i>
        <span>群组管理</span>
      </div>
      <div class="sidebar-item" data-page="system">
        <i class="el-icon-cog mr-3"></i>
        <span>系统配置</span>
      </div>
    </div>
  </div>

  <!-- 主内容区 -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- 顶部导航 -->
    <div class="h-14 border-b border-gray-200 flex justify-end items-center px-6">
      <el-dropdown>
        <span class="flex items-center cursor-pointer text-gray-700">
          <i class="el-icon-user mr-2"></i>
          <span>管理员</span>
          <i class="el-icon-arrow-down ml-2"></i>
        </span>
        <template #dropdown>
          <el-dropdown-menu>
            <el-dropdown-item>个人中心</el-dropdown-item>
            <el-dropdown-item>退出登录</el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
    </div>

    <!-- 内容区域 -->
    <div class="flex-1 overflow-auto p-6">
      <!-- 仪表盘页面 -->
      <div id="dashboard" class="page-content">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6">
          <!-- 今日日志卡片 -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-gray-500 text-sm">今日监控日志</p>
                <h3 id="todayLogs" class="text-3xl font-bold mt-1">0</h3>
              </div>
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-primary">
                <i class="el-icon-document"></i>
              </div>
            </div>
            <div class="text-sm text-green-500">
              <i class="el-icon-arrow-up"></i> 12% 较昨日
            </div>
          </div>

          <!-- 今日发送卡片 -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-gray-500 text-sm">今日发送私信</p>
                <h3 id="todaySends" class="text-3xl font-bold mt-1">0</h3>
              </div>
              <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-500">
                <i class="el-icon-message"></i>
              </div>
            </div>
            <div class="text-sm text-green-500">
              <i class="el-icon-arrow-up"></i> 8% 较昨日
            </div>
          </div>

          <!-- 启用关键词卡片 -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-gray-500 text-sm">启用关键词</p>
                <h3 id="activeKeywords" class="text-3xl font-bold mt-1">0</h3>
              </div>
              <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-500">
                <i class="el-icon-tags"></i>
              </div>
            </div>
            <div class="text-sm text-gray-500">
              共 <span id="totalKeywords">0</span> 个关键词
            </div>
          </div>

          <!-- 启用群组卡片 -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-gray-500 text-sm">启用监控群组</p>
                <h3 id="activeGroups" class="text-3xl font-bold mt-1">0</h3>
              </div>
              <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center text-orange-500">
                <i class="el-icon-user-group"></i>
              </div>
            </div>
            <div class="text-sm text-gray-500">
              共 <span id="totalGroups">0</span> 个群组
            </div>
          </div>
        </div>

        <!-- 最近日志表格 -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">最近监控日志</h2>
            <el-button type="text" size="small" id="refreshDashboard">
              <i class="el-icon-refresh"></i> 刷新
            </el-button>
          </div>
          <el-table id="recentLogsTable" border :data="[]" style="width: 100%">
            <el-table-column prop="created_at" label="时间" width="180"></el-table-column>
            <el-table-column prop="group_id" label="群组ID" width="140"></el-table-column>
            <el-table-column prop="user_id" label="用户ID" width="140"></el-table-column>
            <el-table-column prop="matched_keywords" label="匹配关键词"></el-table-column>
            <el-table-column prop="message" label="消息内容" show-overflow-tooltip></el-table-column>
          </el-table>
        </div>
      </div>

      <!-- 监控日志页面 -->
      <div id="monitorLogs" class="page-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">监控日志管理</h2>
            <div class="flex items-center">
              <el-input 
                v-model="logSearch" 
                placeholder="搜索消息内容" 
                size="small" 
                style="width: 240px; margin-right: 10px;"
                @keyup.enter="fetchMonitorLogs"
              ></el-input>
              <el-button type="primary" size="small" @click="fetchMonitorLogs">
                <i class="el-icon-search"></i> 搜索
              </el-button>
            </div>
          </div>
          <el-table id="monitorLogsTable" border :data="[]" style="width: 100%; margin-bottom: 16px;">
            <el-table-column prop="id" label="ID" width="180"></el-table-column>
            <el-table-column prop="created_at" label="时间" width="180"></el-table-column>
            <el-table-column prop="group_id" label="群组ID" width="140"></el-table-column>
            <el-table-column prop="user_id" label="用户ID" width="140"></el-table-column>
            <el-table-column prop="matched_keywords" label="匹配关键词"></el-table-column>
            <el-table-column prop="message" label="消息内容" show-overflow-tooltip></el-table-column>
          </el-table>
          <el-pagination
            id="logPagination"
            @size-change="handleLogSizeChange"
            @current-change="handleLogCurrentChange"
            :current-page="1"
            :page-sizes="[10, 20, 50]"
            :page-size="10"
            layout="total, sizes, prev, pager, next, jumper"
            :total="0"
          ></el-pagination>
        </div>
      </div>

      <!-- 发送记录页面 -->
      <div id="sendRecords" class="page-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">私信发送记录</h2>
            <el-button type="text" size="small" @click="fetchSendRecords">
              <i class="el-icon-refresh"></i> 刷新
            </el-button>
          </div>
          <el-table id="sendRecordsTable" border :data="[]" style="width: 100%; margin-bottom: 16px;">
            <el-table-column prop="id" label="ID" width="180"></el-table-column>
            <el-table-column prop="created_at" label="发送时间" width="180"></el-table-column>
            <el-table-column prop="group_id" label="来源群组" width="140"></el-table-column>
            <el-table-column prop="user_id" label="接收用户" width="140"></el-table-column>
            <el-table-column prop="status" label="状态">
              <template #default="scope">
                <el-tag :type="scope.row.status === 'success' ? 'success' : 'danger'">
                  {{ scope.row.status === 'success' ? '发送成功' : '发送失败' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="message" label="发送内容" show-overflow-tooltip></el-table-column>
          </el-table>
        </div>
      </div>

      <!-- 关键词管理页面 -->
      <div id="keywords" class="page-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">关键词管理</h2>
            <el-button type="primary" size="small" @click="openAddKeywordDialog">
              <i class="el-icon-plus"></i> 添加关键词
            </el-button>
          </div>
          <el-table id="keywordsTable" border :data="[]" style="width: 100%; margin-bottom: 16px;">
            <el-table-column prop="id" label="ID" width="180"></el-table-column>
            <el-table-column prop="keyword" label="关键词" width="200"></el-table-column>
            <el-table-column prop="is_active" label="状态">
              <template #default="scope">
                <el-switch 
                  v-model="scope.row.is_active" 
                  active-color="#13ce66" 
                  inactive-color="#ff4949"
                  @change="updateKeywordStatus(scope.row)"
                ></el-switch>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
            <el-table-column label="操作" width="120">
              <template #default="scope">
                <el-button 
                  type="text" 
                  size="small" 
                  @click="deleteKeyword(scope.row.id)"
                  style="color: #ff4949;"
                >
                  <i class="el-icon-delete"></i> 删除
                </el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>
      </div>

      <!-- 群组管理页面 -->
      <div id="groups" class="page-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">群组管理</h2>
            <el-button type="primary" size="small" @click="openAddGroupDialog">
              <i class="el-icon-plus"></i> 添加群组
            </el-button>
          </div>
          <el-table id="groupsTable" border :data="[]" style="width: 100%; margin-bottom: 16px;">
            <el-table-column prop="id" label="ID" width="180"></el-table-column>
            <el-table-column prop="group_id" label="群组ID" width="180"></el-table-column>
            <el-table-column prop="group_name" label="群组名称"></el-table-column>
            <el-table-column prop="is_active" label="监控状态">
              <template #default="scope">
                <el-switch 
                  v-model="scope.row.is_active" 
                  active-color="#13ce66" 
                  inactive-color="#ff4949"
                  @change="updateGroupStatus(scope.row)"
                ></el-switch>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="添加时间" width="180"></el-table-column>
          </el-table>
        </div>
      </div>

      <!-- 系统配置页面 -->
      <div id="system" class="page-content hidden">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="card-header">
            <h2 class="text-lg font-semibold">系统配置</h2>
            <el-button type="primary" size="small" @click="saveSystemConfig">
              <i class="el-icon-save"></i> 保存配置
            </el-button>
          </div>
          <el-form id="systemConfigForm" :model="systemConfig" label-width="160px" style="width: 600px;">
            <el-form-item label="Telegram API ID">
              <el-input v-model="systemConfig.telegram_api_id"></el-input>
            </el-form-item>
            <el-form-item label="Telegram API HASH">
              <el-input v-model="systemConfig.telegram_api_hash"></el-input>
            </el-form-item>
            <el-form-item label="Telegram 账号ID">
              <el-input v-model="systemConfig.telegram_account_id"></el-input>
            </el-form-item>
            <el-form-item label="Worker API 地址">
              <el-input v-model="systemConfig.worker_api_url" placeholder="https://xxx.workers.dev/api"></el-input>
            </el-form-item>
          </el-form>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加关键词弹窗 -->
  <el-dialog title="添加关键词" id="addKeywordDialog" width="30%" :visible.sync="addKeywordVisible">
    <el-form :model="newKeyword" label-width="80px">
      <el-form-item label="关键词">
        <el-input v-model="newKeyword.keyword" placeholder="请输入要监控的关键词"></el-input>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="addKeywordVisible = false">取消</el-button>
      <el-button type="primary" @click="addKeyword">确定</el-button>
    </template>
  </el-dialog>

  <!-- 添加群组弹窗 -->
  <el-dialog title="添加群组" id="addGroupDialog" width="30%" :visible.sync="addGroupVisible">
    <el-form :model="newGroup" label-width="80px">
      <el-form-item label="群组ID">
        <el-input v-model="newGroup.group_id" placeholder="请输入群组ID（负数）"></el-input>
      </el-form-item>
      <el-form-item label="群组名称">
        <el-input v-model="newGroup.group_name" placeholder="请输入群组名称"></el-input>
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="addGroupVisible = false">取消</el-button>
      <el-button type="primary" @click="addGroup">确定</el-button>
    </template>
  </el-dialog>

  <script>
    // 全局配置
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
    let currentPage = 'dashboard';
    
    // 全局状态
    const state = {
      // 分页参数
      logPage: 1,
      logPageSize: 10,
      logTotal: 0,
      logSearch: '',
      
      // 弹窗状态
      addKeywordVisible: false,
      addGroupVisible: false,
      
      // 表单数据
      newKeyword: { keyword: '' },
      newGroup: { group_id: '', group_name: '未知群组' },
      systemConfig: {}
    };

    // 初始化 Element Plus 组件
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化分页组件
      state.logPagination = window.ElMessageBox.MessageBox.$refs.logPagination;
      
      // 侧边栏切换事件
      document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', () => {
          // 切换激活状态
          document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('sidebar-item-active'));
          item.classList.add('sidebar-item-active');
          
          // 切换页面内容
          const page = item.getAttribute('data-page');
          currentPage = page;
          document.querySelectorAll('.page-content').forEach(content => content.classList.add('hidden'));
          document.getElementById(page).classList.remove('hidden');
          
          // 加载对应页面数据
          loadPageData(page);
        });
      });

      // 初始化仪表盘数据
      loadPageData('dashboard');

      // 绑定刷新按钮事件
      document.getElementById('refreshDashboard').addEventListener('click', () => {
        loadPageData('dashboard');
      });
    });

    // 加载页面数据
    async function loadPageData(page) {
      try {
        switch(page) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'monitorLogs':
            await fetchMonitorLogs();
            break;
          case 'sendRecords':
            await fetchSendRecords();
            break;
          case 'keywords':
            await fetchKeywords();
            break;
          case 'groups':
            await fetchGroups();
            break;
          case 'system':
            await fetchSystemConfig();
            break;
        }
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`加载数据失败: ${error.message}`);
      }
    }

    // 1. 加载仪表盘数据
    async function loadDashboardData() {
      // 获取今日日志数
      const logRes = await axios.get(`${API_BASE_URL}/logs/monitor?limit=10`);
      const logs = logRes.data.logs;
      const totalLogs = logRes.data.total;
      
      // 获取发送记录
      const sendRes = await axios.get(`${API_BASE_URL}/logs/send`);
      const sends = sendRes.data;
      
      // 获取关键词
      const keywordRes = await axios.get(`${API_BASE_URL}/config/keywords`);
      const keywords = keywordRes.data;
      const activeKeywords = keywords.filter(k => k.is_active).length;
      
      // 获取群组
      const groupRes = await axios.get(`${API_BASE_URL}/config/groups`);
      const groups = groupRes.data;
      const activeGroups = groups.filter(g => g.is_active).length;
      
      // 更新DOM
      document.getElementById('todayLogs').textContent = totalLogs;
      document.getElementById('todaySends').textContent = sends.length;
      document.getElementById('activeKeywords').textContent = activeKeywords;
      document.getElementById('totalKeywords').textContent = keywords.length;
      document.getElementById('activeGroups').textContent = activeGroups;
      document.getElementById('totalGroups').textContent = groups.length;
      
      // 更新最近日志表格
      const logsTable = document.getElementById('recentLogsTable');
      window.ElTable.Table.setProps(logsTable, { data: logs });
    }

    // 2. 获取监控日志
    async function fetchMonitorLogs() {
      try {
        const res = await axios.get(
          `${API_BASE_URL}/logs/monitor?page=${state.logPage}&limit=${state.logPageSize}` +
          (state.logSearch ? `&search=${state.logSearch}` : '')
        );
        
        const logs = res.data.logs;
        state.logTotal = res.data.total;
        
        // 更新表格和分页
        const logsTable = document.getElementById('monitorLogsTable');
        window.ElTable.Table.setProps(logsTable, { data: logs });
        
        const pagination = document.getElementById('logPagination');
        window.ElPagination.Pagination.setProps(pagination, {
          currentPage: state.logPage,
          pageSize: state.logPageSize,
          total: state.logTotal
        });
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`获取日志失败: ${error.message}`);
      }
    }

    // 日志分页事件
    function handleLogSizeChange(val) {
      state.logPageSize = val;
      fetchMonitorLogs();
    }

    function handleLogCurrentChange(val) {
      state.logPage = val;
      fetchMonitorLogs();
    }

    // 3. 获取发送记录
    async function fetchSendRecords() {
      try {
        const res = await axios.get(`${API_BASE_URL}/logs/send`);
        const records = res.data;
        
        // 更新表格
        const recordsTable = document.getElementById('sendRecordsTable');
        window.ElTable.Table.setProps(recordsTable, { data: records });
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`获取发送记录失败: ${error.message}`);
      }
    }

    // 4. 获取关键词列表
    async function fetchKeywords() {
      try {
        const res = await axios.get(`${API_BASE_URL}/config/keywords`);
        const keywords = res.data;
        
        // 更新表格
        const keywordsTable = document.getElementById('keywordsTable');
        window.ElTable.Table.setProps(keywordsTable, { data: keywords });
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`获取关键词失败: ${error.message}`);
      }
    }

    // 添加关键词
    function openAddKeywordDialog() {
      state.addKeywordVisible = true;
      state.newKeyword.keyword = '';
      // 显示弹窗
      const dialog = document.getElementById('addKeywordDialog');
      window.ElDialog.Dialog.setProps(dialog, { visible: true });
    }

    async function addKeyword() {
      if (!state.newKeyword.keyword.trim()) {
        window.ElMessageBox.MessageBox.warning('请输入关键词');
        return;
      }
      
      try {
        await axios.post(`${API_BASE_URL}/config/keywords`, {
          keyword: state.newKeyword.keyword.trim(),
          is_active: true
        });
        
        // 关闭弹窗并刷新列表
        state.addKeywordVisible = false;
        const dialog = document.getElementById('addKeywordDialog');
        window.ElDialog.Dialog.setProps(dialog, { visible: false });
        fetchKeywords();
        
        window.ElMessageBox.MessageBox.success('关键词添加成功');
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`添加关键词失败: ${error.message}`);
      }
    }

    // 更新关键词状态
    async function updateKeywordStatus(keyword) {
      try {
        await axios.patch(`${API_BASE_URL}/config/keywords`, {
          id: keyword.id,
          is_active: keyword.is_active
        });
      } catch (error) {
        // 回滚状态
        keyword.is_active = !keyword.is_active;
        window.ElMessageBox.MessageBox.error(`更新关键词状态失败: ${error.message}`);
      }
    }

    // 删除关键词
    async function deleteKeyword(id) {
      try {
        await window.ElMessageBox.MessageBox.confirm(
          '确定要删除该关键词吗？',
          '提示',
          {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }
        );
        
        await axios.delete(`${API_BASE_URL}/config/keywords?id=${id}`);
        fetchKeywords();
        window.ElMessageBox.MessageBox.success('关键词删除成功');
      } catch (error) {
        if (error.name !== 'Cancel') {
          window.ElMessageBox.MessageBox.error(`删除关键词失败: ${error.message}`);
        }
      }
    }

    // 5. 获取群组列表
    async function fetchGroups() {
      try {
        const res = await axios.get(`${API_BASE_URL}/config/groups`);
        const groups = res.data;
        
        // 更新表格
        const groupsTable = document.getElementById('groupsTable');
        window.ElTable.Table.setProps(groupsTable, { data: groups });
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`获取群组失败: ${error.message}`);
      }
    }

    // 添加群组
    function openAddGroupDialog() {
      state.addGroupVisible = true;
      state.newGroup.group_id = '';
      state.newGroup.group_name = '未知群组';
      // 显示弹窗
      const dialog = document.getElementById('addGroupDialog');
      window.ElDialog.Dialog.setProps(dialog, { visible: true });
    }

    async function addGroup() {
      if (!state.newGroup.group_id.trim() || isNaN(Number(state.newGroup.group_id))) {
        window.ElMessageBox.MessageBox.warning('请输入有效的群组ID（数字）');
        return;
      }
      
      try {
        await axios.post(`${API_BASE_URL}/config/groups`, {
          group_id: Number(state.newGroup.group_id.trim()),
          group_name: state.newGroup.group_name.trim() || '未知群组',
          is_active: true
        });
        
        // 关闭弹窗并刷新列表
        state.addGroupVisible = false;
        const dialog = document.getElementById('addGroupDialog');
        window.ElDialog.Dialog.setProps(dialog, { visible: false });
        fetchGroups();
        
        window.ElMessageBox.MessageBox.success('群组添加成功');
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`添加群组失败: ${error.message}`);
      }
    }

    // 更新群组状态
    async function updateGroupStatus(group) {
      try {
        await axios.patch(`${API_BASE_URL}/config/groups`, {
          id: group.id,
          is_active: group.is_active
        });
      } catch (error) {
        // 回滚状态
        group.is_active = !group.is_active;
        window.ElMessageBox.MessageBox.error(`更新群组状态失败: ${error.message}`);
      }
    }

    // 6. 获取系统配置
    async function fetchSystemConfig() {
      try {
        const res = await axios.get(`${API_BASE_URL}/config/system`);
        const configList = res.data;
        
        // 转换为键值对
        const config = {};
        configList.forEach(item => {
          config[item.config_key] = item.config_value;
        });
        
        // 设置默认值
        config.worker_api_url = config.worker_api_url || API_BASE_URL;
        state.systemConfig = config;
        
        // 更新表单
        const form = document.getElementById('systemConfigForm');
        window.ElForm.Form.setProps(form, { model: state.systemConfig });
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`获取系统配置失败: ${error.message}`);
      }
    }

    // 保存系统配置
    async function saveSystemConfig() {
      try {
        // 转换为数组格式
        const configList = Object.entries(state.systemConfig).map(([key, value]) => ({
          config_key: key,
          config_value: value
        }));
        
        // 批量更新
        for (const config of configList) {
          const res = await axios.get(`${API_BASE_URL}/config/system?config_key=${config.config_key}`);
          if (res.data.length > 0) {
            await axios.patch(`${API_BASE_URL}/config/system`, {
              id: res.data[0].id,
              config_value: config.config_value
            });
          }
        }
        
        window.ElMessageBox.MessageBox.success('系统配置保存成功');
      } catch (error) {
        window.ElMessageBox.MessageBox.error(`保存系统配置失败: ${error.message}`);
      }
    }

    // 绑定全局变量到window，供Element组件调用
    window.state = state;
    window.loadPageData = loadPageData;
    window.fetchMonitorLogs = fetchMonitorLogs;
    window.handleLogSizeChange = handleLogSizeChange;
    window.handleLogCurrentChange = handleLogCurrentChange;
    window.fetchSendRecords = fetchSendRecords;
    window.fetchKeywords = fetchKeywords;
    window.openAddKeywordDialog = openAddKeywordDialog;
    window.addKeyword = addKeyword;
    window.updateKeywordStatus = updateKeywordStatus;
    window.deleteKeyword = deleteKeyword;
    window.fetchGroups = fetchGroups;
    window.openAddGroupDialog = openAddGroupDialog;
    window.addGroup = addGroup;
    window.updateGroupStatus = updateGroupStatus;
    window.fetchSystemConfig = fetchSystemConfig;
    window.saveSystemConfig = saveSystemConfig;
  </script>
</body>
</html>
