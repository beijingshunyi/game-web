<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegramæ¶ˆæ¯ç›‘æ§ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  
  <!-- é…ç½®Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            danger: '#EF4444',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-shadow {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <!-- å¯¼èˆªæ  -->
  <nav class="gradient-bg text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-telegram text-2xl"></i>
        <h1 class="text-xl font-bold">Telegramæ¶ˆæ¯ç›‘æ§ç³»ç»Ÿ</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span id="system-status" class="flex items-center">
          <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
          <span>è¿è¡Œä¸­</span>
        </span>
        <button id="refresh-btn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md transition">
          <i class="fa fa-refresh mr-1"></i>åˆ·æ–°
        </button>
      </div>
    </div>
  </nav>

  <!-- ä¸»å†…å®¹åŒº -->
  <main class="container mx-auto px-4 py-8">
    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex justify-between items-start mb-4">
          <div>
            <p class="text-gray-500 text-sm">æ€»æ¶ˆæ¯æ•°</p>
            <h3 id="total-messages" class="text-3xl font-bold">0</h3>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg">
            <i class="fa fa-comments text-primary text-xl"></i>
          </div>
        </div>
        <div class="text-sm text-green-600 flex items-center">
          <i class="fa fa-arrow-up mr-1"></i>
          <span id="message-increase">0%</span>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex justify-between items-start mb-4">
          <div>
            <p class="text-gray-500 text-sm">å·²å›å¤æ¶ˆæ¯</p>
            <h3 id="replied-messages" class="text-3xl font-bold">0</h3>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="fa fa-reply text-secondary text-xl"></i>
          </div>
        </div>
        <div class="text-sm text-gray-500">
          <span>å æ€»æ¶ˆæ¯æ¯”ä¾‹: </span>
          <span id="reply-rate">0%</span>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex justify-between items-start mb-4">
          <div>
            <p class="text-gray-500 text-sm">æ´»è·ƒç”¨æˆ·</p>
            <h3 id="active-users" class="text-3xl font-bold">0</h3>
          </div>
          <div class="bg-purple-100 p-3 rounded-lg">
            <i class="fa fa-users text-purple-600 text-xl"></i>
          </div>
        </div>
        <div class="text-sm text-gray-500">
          <span>æœ€è¿‘24å°æ—¶æ–°å¢: </span>
          <span id="new-users">0</span>
        </div>
      </div>
    </div>
    
    <!-- å›¾è¡¨å’Œæ¶ˆæ¯åˆ—è¡¨ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- æ¶ˆæ¯è¶‹åŠ¿å›¾è¡¨ -->
      <div class="lg:col-span-1 bg-white rounded-xl p-6 card-shadow">
        <h2 class="text-lg font-semibold mb-4">æ¶ˆæ¯è¶‹åŠ¿</h2>
        <div class="h-64">
          <canvas id="messageChart"></canvas>
        </div>
      </div>
      
      <!-- æœ€è¿‘æ¶ˆæ¯ -->
      <div class="lg:col-span-2 bg-white rounded-xl p-6 card-shadow">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">æœ€è¿‘æ¶ˆæ¯</h2>
          <div class="relative">
            <input type="text" id="message-filter" placeholder="æœç´¢æ¶ˆæ¯..." 
                  class="pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
            <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          </div>
        </div>
        
        <div class="overflow-y-auto max-h-80" id="recent-messages">
          <!-- æ¶ˆæ¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
          <div class="text-center text-gray-500 py-10">
            <i class="fa fa-spinner fa-spin text-2xl mb-2"></i>
            <p>åŠ è½½æ¶ˆæ¯ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- é…ç½®åŒºåŸŸ -->
    <div class="mt-8 bg-white rounded-xl p-6 card-shadow">
      <h2 class="text-lg font-semibold mb-4">ç³»ç»Ÿé…ç½®</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-medium mb-3">å…³é”®å­—è®¾ç½®</h3>
          <div id="keywords-list" class="flex flex-wrap gap-2 mb-4">
            <!-- å…³é”®å­—å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
          </div>
          <div class="flex">
            <input type="text" id="new-keyword" placeholder="æ·»åŠ æ–°å…³é”®å­—..." 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
            <button id="add-keyword" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition">
              æ·»åŠ 
            </button>
          </div>
        </div>
        
        <div>
          <h3 class="font-medium mb-3">å›å¤æ¶ˆæ¯è®¾ç½®</h3>
          <textarea id="reply-message" rows="6" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
                   placeholder="è®¾ç½®è‡ªåŠ¨å›å¤æ¶ˆæ¯..."></textarea>
          <button id="save-reply" class="mt-3 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
            ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- é¡µè„š -->
  <footer class="bg-dark text-white mt-12 py-6">
    <div class="container mx-auto px-4 text-center">
      <p>Telegramæ¶ˆæ¯ç›‘æ§ç³»ç»Ÿ &copy; 2023</p>
      <p class="text-gray-400 text-sm mt-1">åŸºäºCloudflare Workerå’ŒSupabaseæ„å»º</p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // é…ç½®
    const SUPABASE_URL = 'https://ylnfjlltesnlfanrxfoy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsbmZqbGx0ZXNubGZhbnJ4Zm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDc0MjMsImV4cCI6MjA3MTY4MzQyM30.czuQwYoFd7Ew9f-PBaojhsWJkXrBEtkqTRdhfX-DWFk';
    const WORKER_URL = 'https://wanhua-game.bingkuijing.workers.dev/';
    
    // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
    const supabase = {
      url: SUPABASE_URL,
      key: SUPABASE_KEY,
      async fetch(path, options = {}) {
        const url = `${this.url}/rest/v1${path}`;
        const headers = {
          'apikey': this.key,
          'Authorization': `Bearer ${this.key}`,
          'Content-Type': 'application/json'
        };
        
        return fetch(url, { ...options, headers });
      }
    };
    
    // æ¶ˆæ¯å›¾è¡¨
    let messageChart;
    
    // åˆå§‹åŒ–å›¾è¡¨
    const initChart = () => {
      const ctx = document.getElementById('messageChart').getContext('2d');
      messageChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'æ¶ˆæ¯æ•°é‡',
            data: [],
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    };
    
    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    const updateStats = async () => {
      try {
        // è·å–æ€»æ¶ˆæ¯æ•°
        const totalResponse = await supabase.fetch('/messages?select=count(*)', { method: 'GET' });
        const totalData = await totalResponse.json();
        const totalMessages = totalData[0].count;
        document.getElementById('total-messages').textContent = totalMessages;
        
        // è·å–å·²å›å¤æ¶ˆæ¯æ•°
        const repliedResponse = await supabase.fetch('/messages?has_replied=eq.true&select=count(*)', { method: 'GET' });
        const repliedData = await repliedResponse.json();
        const repliedMessages = repliedData[0].count;
        document.getElementById('replied-messages').textContent = repliedMessages;
        
        // è®¡ç®—å›å¤ç‡
        const replyRate = totalMessages > 0 ? Math.round((repliedMessages / totalMessages) * 100) : 0;
        document.getElementById('reply-rate').textContent = `${replyRate}%`;
        
        // è·å–æ´»è·ƒç”¨æˆ·æ•°
        const usersResponse = await supabase.fetch('/messages?select=user_id,username&group=user_id', { method: 'GET' });
        const usersData = await usersResponse.json();
        document.getElementById('active-users').textContent = usersData.length;
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        updateChartData();
        
      } catch (error) {
        console.error('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
      }
    };
    
    // æ›´æ–°å›¾è¡¨æ•°æ®
    const updateChartData = async () => {
      try {
        // è·å–æœ€è¿‘7å¤©çš„æ¶ˆæ¯æ•°æ®
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        const formattedDate = sevenDaysAgo.toISOString().split('T')[0];
        
        const response = await supabase.fetch(
          `/messages?timestamp=gte.${formattedDate}&select=date_trunc('day', timestamp) as day, count(*) as count&group=day&order=day.asc`,
          { method: 'GET' }
        );
        
        const data = await response.json();
        
        // å‡†å¤‡å›¾è¡¨æ•°æ®
        const labels = data.map(item => {
          const date = new Date(item.day);
          return `${date.getMonth() + 1}/${date.getDate()}`;
        });
        
        const counts = data.map(item => item.count);
        
        // æ›´æ–°å›¾è¡¨
        messageChart.data.labels = labels;
        messageChart.data.datasets[0].data = counts;
        messageChart.update();
        
      } catch (error) {
        console.error('æ›´æ–°å›¾è¡¨æ•°æ®å¤±è´¥:', error);
      }
    };
    
    // åŠ è½½æœ€è¿‘æ¶ˆæ¯
    const loadRecentMessages = async () => {
      try {
        const response = await supabase.fetch(
          '/messages?order=timestamp.desc&limit=10',
          { method: 'GET' }
        );
        
        const messages = await response.json();
        const messagesContainer = document.getElementById('recent-messages');
        
        if (messages.length === 0) {
          messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 py-10">
              <p>æš‚æ— æ¶ˆæ¯è®°å½•</p>
            </div>
          `;
          return;
        }
        
        // ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨HTML
        let messagesHTML = '';
        messages.forEach(msg => {
          const date = new Date(msg.timestamp);
          const formattedDate = date.toLocaleString();
          
          messagesHTML += `
            <div class="border-b border-gray-100 py-3 last:border-0">
              <div class="flex justify-between items-start">
                <div class="font-medium">${msg.username || `ç”¨æˆ·${msg.user_id}`}</div>
                <div class="text-xs text-gray-500">${formattedDate}</div>
              </div>
              <div class="mt-1 text-gray-700">${msg.message}</div>
              <div class="mt-2 flex items-center">
                <span class="text-xs ${msg.has_replied ? 'text-green-600' : 'text-gray-500'}">
                  ${msg.has_replied ? 'å·²å›å¤' : 'æœªå›å¤'}
                </span>
                ${containsKeyword(msg.message) ? 
                  '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">å«å…³é”®å­—</span>' : ''}
              </div>
            </div>
          `;
        });
        
        messagesContainer.innerHTML = messagesHTML;
        
      } catch (error) {
        console.error('åŠ è½½æœ€è¿‘æ¶ˆæ¯å¤±è´¥:', error);
        document.getElementById('recent-messages').innerHTML = `
          <div class="text-center text-red-500 py-10">
            <p>åŠ è½½æ¶ˆæ¯å¤±è´¥ï¼Œè¯·é‡è¯•</p>
          </div>
        `;
      }
    };
    
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«å…³é”®å­—
    const containsKeyword = (message) => {
      // æ›´æ–°ä¸ºæ–°çš„å…³é”®å­—åˆ—è¡¨
      const keywords = [
        'åŒ—äº¬', 'åŒ—äº¬ä¸­å°', 'åŒ—äº¬å°å§', 'æœé˜³', 'æµ·æ·€', 'ä¸°å°', 
        'é¡ºä¹‰', 'æˆ¿å±±', 'ä¸œåŸ', 'è¥¿åŸ', 'æ˜Œå¹³', 'çŸ³æ™¯å±±', 'åŒ—äº¬å¤–å›´'
      ];
      if (!message) return false;
      const lowerMessage = message.toLowerCase();
      return keywords.some(keyword => lowerMessage.includes(keyword.toLowerCase()));
    };
    
    // åŠ è½½å…³é”®å­—åˆ—è¡¨
    const loadKeywords = () => {
      // æ›´æ–°ä¸ºæ–°çš„å…³é”®å­—åˆ—è¡¨
      const keywords = [
        'åŒ—äº¬', 'åŒ—äº¬ä¸­å°', 'åŒ—äº¬å°å§', 'æœé˜³', 'æµ·æ·€', 'ä¸°å°', 
        'é¡ºä¹‰', 'æˆ¿å±±', 'ä¸œåŸ', 'è¥¿åŸ', 'æ˜Œå¹³', 'çŸ³æ™¯å±±', 'åŒ—äº¬å¤–å›´'
      ];
      const keywordsContainer = document.getElementById('keywords-list');
      
      keywordsContainer.innerHTML = '';
      keywords.forEach((keyword, index) => {
        const keywordElement = document.createElement('div');
        keywordElement.className = 'bg-blue-50 text-primary px-3 py-1 rounded-full text-sm flex items-center';
        keywordElement.innerHTML = `
          ${keyword}
          <button class="ml-1 text-primary/70 hover:text-primary" data-index="${index}">
            <i class="fa fa-times"></i>
          </button>
        `;
        keywordsContainer.appendChild(keywordElement);
      });
      
      // æ·»åŠ åˆ é™¤å…³é”®å­—äº‹ä»¶
      document.querySelectorAll('#keywords-list button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = e.target.closest('button').dataset.index;
          alert(`å…³é”®å­— "${keywords[index]}" å°†è¢«åˆ é™¤`);
          loadKeywords(); // é‡æ–°åŠ è½½åˆ—è¡¨
        });
      });
    };
    
    // åˆå§‹åŒ–é¡µé¢
    const initPage = () => {
      initChart();
      updateStats();
      loadRecentMessages();
      loadKeywords();
      
      // è®¾ç½®å¸¦è¡¨æƒ…çš„é»˜è®¤å›å¤æ¶ˆæ¯
      document.getElementById('reply-message').value = `æ‚¨å¥½å‘€ï¼ğŸ‘‹ çœ‹åˆ°æ‚¨æåˆ°äº†åŒ—äº¬ç›¸å…³çš„å†…å®¹ï¼Œç»™æ‚¨æ¨èä¸€ä¸ªåŒ—äº¬è½¦ä¸»ä»¬éƒ½åœ¨å…³æ³¨çš„ä¼˜è´¨ç¤¾ç¾¤é›†åˆâ€”â€”åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘ï¼ğŸš—ğŸ’¨

è¿™é‡Œæœ‰å„ç§å®ç”¨çš„ä¿®è½¦ç›¸å…³ç¾¤ç»„ï¼Œæ¶µç›–ä½œä¸šä¿¡æ¯ã€å…¬å¼€æ¦œå•ã€è€å¸ˆç­¾åˆ°ã€è®¤è¯ä¿¡æ¯ã€ç‹¼å‹äº¤æµå’Œé»‘è½¦æŠ•è¯‰ç­‰å¤šä¸ªæ–¹é¢ï¼Œæ— è®ºæ‚¨æ˜¯æƒ³äº†è§£ä¿®è½¦çŸ¥è¯†ã€äº¤æµç»éªŒè¿˜æ˜¯åé¦ˆé—®é¢˜ï¼Œéƒ½èƒ½æ‰¾åˆ°å¯¹åº”çš„ç¤¾ç¾¤å“¦ï¼ğŸ˜‰

ä¸€é”®å…³æ³¨æ‰€æœ‰ç¾¤ç»„å¾ˆæ–¹ä¾¿å“¦ï¼š
https://t.me/addlist/iP3W6rxTdbQ1YzFh

ä¹Ÿå¯ä»¥ç›´æ¥åŠ å…¥æ„Ÿå…´è¶£çš„ç¾¤ç»„ï¼š
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘å‡ºå‡»ä½œä¸šï¼š@bjxczhuoye
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘å…¬å¼€æ¦œï¼š@bjxcgongkaibang
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘è€å¸ˆç­¾åˆ°ç¾¤ï¼š@bjxcqiandao
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘è€å¸ˆè®¤è¯æ¦œï¼š@bjxcrengzheng
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘ç‹¼å‹äº¤æµç¾¤ï¼š@bjxclangyou
- åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘é»‘è½¦æŠ•è¯‰æ¦œï¼š@bjxctoushu

å¦‚æœæ‚¨æƒ³äº†è§£ä¸Šæ¦œç›¸å…³äº‹å®œï¼Œæ¬¢è¿è”ç³»@bjxc010 å’¨è¯¢è¯¦æƒ…ï¼ŒæœŸå¾…æ‚¨çš„åŠ å…¥å“¦ï¼ğŸ˜Š`;
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.getElementById('refresh-btn').addEventListener('click', () => {
        updateStats();
        loadRecentMessages();
      });
      
      document.getElementById('add-keyword').addEventListener('click', () => {
        const newKeyword = document.getElementById('new-keyword').value.trim();
        if (newKeyword) {
          alert(`å…³é”®å­— "${newKeyword}" å°†è¢«æ·»åŠ `);
          document.getElementById('new-keyword').value = '';
          loadKeywords(); // é‡æ–°åŠ è½½åˆ—è¡¨
        }
      });
      
      document.getElementById('save-reply').addEventListener('click', () => {
        const replyMessage = document.getElementById('reply-message').value.trim();
        if (replyMessage) {
          alert('å›å¤æ¶ˆæ¯å·²ä¿å­˜');
        }
      });
      
      document.getElementById('message-filter').addEventListener('input', (e) => {
        const filterText = e.target.value.toLowerCase();
        console.log('è¿‡æ»¤æ¶ˆæ¯:', filterText);
      });
      
      // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°æ•°æ®
      setInterval(() => {
        updateStats();
        loadRecentMessages();
      }, 30000);
    };
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
