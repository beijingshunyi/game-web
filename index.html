<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万花消消乐 - Telegram小游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // 配置Tailwind自定义主题
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6', // 主色调：紫色
                        secondary: '#EC4899', // 辅助色：粉色
                        accent: '#F59E0B', // 强调色：橙色
                        background: '#FEF3C7', // 背景色：浅黄色
                        board: '#FFFBEB', // 棋盘背景色
                    },
                    fontFamily: {
                        game: ['"Comic Sans MS"', '"Marker Felt"', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .game-shadow {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            }
            .tile-shadow {
                box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            }
            .animate-pop {
                animation: pop 0.3s ease-out;
            }
            .animate-clear {
                animation: clear 0.5s ease-in-out;
            }
            .animate-fall {
                transition: transform 0.5s ease-out;
            }
            .prize-badge {
                position: relative;
            }
            .prize-badge::after {
                content: attr(data-prize);
                position: absolute;
                top: -5px;
                right: -5px;
                background-color: #EC4899;
                color: white;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                font-size: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes clear {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(0); opacity: 0; }
        }
    </style>
</head>
<body class="bg-background min-h-screen font-game text-gray-800 overflow-x-hidden">
    <!-- 顶部导航 -->
    <header class="bg-gradient-to-r from-primary to-secondary text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-gamepad text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold">万花消消乐</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-1">
                    <i class="fa fa-diamond text-accent"></i>
                    <span id="coin-count" class="font-bold">0</span>
                    <span>个"万花币"</span>
                </div>
                <div class="flex items-center space-x-1">
                    <i class="fa fa-play-circle"></i>
                    <span id="game-attempts">剩余次数: 6</span>
                </div>
                <div class="flex items-center space-x-1">
                    <i class="fa fa-map-signs"></i>
                    <span id="level-display">关卡: 1</span>
                </div>
                <button id="user-btn" class="bg-white/20 hover:bg-white/30 rounded-full w-8 h-8 flex items-center justify-center transition-all">
                    <i class="fa fa-user"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 每日签到 -->
    <div class="container mx-auto px-4 py-2">
        <div class="bg-white rounded-xl p-3 game-shadow flex items-center justify-between">
            <div class="flex items-center">
                <i class="fa fa-calendar-check-o text-accent text-xl mr-2"></i>
                <span>每日签到</span>
            </div>
            <div class="flex items-center space-x-2">
                <span id="checkin-reward" class="text-sm text-gray-600">今日可领: 15个"万花币"</span>
                <button id="checkin-btn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded-lg text-sm transition-all">
                    签到
                </button>
            </div>
        </div>
    </div>

    <!-- 游戏状态区 -->
    <div class="container mx-auto px-4 py-4">
        <div class="bg-white rounded-xl p-4 game-shadow mb-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-3 md:mb-0">
                    <h2 class="text-lg font-bold">目标: 获得 <span id="target-score" class="text-accent">500</span> 分</h2>
                </div>
                <div class="flex space-x-6">
                    <div class="text-center">
                        <div class="text-sm opacity-70">当前得分</div>
                        <div id="current-score" class="text-2xl font-bold text-primary">0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm opacity-70">剩余步数</div>
                        <div id="remaining-moves" class="text-2xl font-bold text-secondary">20</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游戏主区域 -->
        <div class="flex flex-col md:flex-row gap-4">
            <!-- 游戏棋盘 -->
            <div class="flex-1">
                <div class="relative bg-board rounded-xl p-4 md:p-6 game-shadow aspect-square max-w-md mx-auto">
                    <div id="game-board" class="grid grid-cols-5 gap-1 w-full h-full">
                        <!-- 游戏方块将通过JS动态生成 -->
                    </div>
                    
                    <!-- 游戏结束遮罩 -->
                    <div id="game-over" class="absolute inset-0 bg-black/70 rounded-xl flex flex-col items-center justify-center hidden">
                        <h2 id="game-over-title" class="text-white text-3xl font-bold mb-4"></h2>
                        <p id="game-over-message" class="text-white text-xl mb-6"></p>
                        <div class="flex space-x-3">
                            <button id="retry-btn" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all">
                                重试
                            </button>
                            <button id="next-level-btn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-2 rounded-lg transition-all hidden">
                                下一关
                            </button>
                        </div>
                    </div>
                    
                    <!-- 次数用完遮罩 -->
                    <div id="no-attempts" class="absolute inset-0 bg-black/70 rounded-xl flex flex-col items-center justify-center hidden">
                        <h2 class="text-white text-2xl font-bold mb-4">游戏次数已用完</h2>
                        <p class="text-white mb-6">今日剩余次数: <span id="remaining-attempts">0</span>/6</p>
                        <div class="flex flex-col space-y-3 w-3/4">
                            <button id="watch-ad-btn" class="bg-accent hover:bg-accent/90 text-white px-6 py-2 rounded-lg transition-all flex items-center justify-center">
                                <i class="fa fa-play-circle mr-2"></i>观看广告获得1次机会
                            </button>
                            <button id="share-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-all flex items-center justify-center">
                                <i class="fa fa-share-alt mr-2"></i>分享游戏获得1次机会
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <div class="w-full md:w-64 space-y-4">
                <!-- 提现按钮 -->
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 game-shadow text-white">
                    <h3 class="text-lg font-bold mb-2 flex items-center">
                        <i class="fa fa-money mr-2"></i>提现
                    </h3>
                    <p class="text-sm opacity-90 mb-3">10000个"万花币" = 10元人民币</p>
                    <button id="withdraw-btn" class="w-full bg-white text-green-600 hover:bg-green-50 rounded-lg py-2 font-bold transition-all">
                        立即提现
                    </button>
                </div>
                
                <!-- 道具区 -->
                <div class="bg-white rounded-xl p-4 game-shadow">
                    <h3 class="text-lg font-bold mb-3 flex items-center">
                        <i class="fa fa-magic text-accent mr-2"></i>道具
                    </h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="prop-btn flex flex-col items-center p-2 rounded-lg border border-gray-200 hover:border-primary transition-all" data-prop="shuffle">
                            <i class="fa fa-refresh text-xl mb-1"></i>
                            <span class="text-xs">洗牌</span>
                            <span class="text-xs text-primary">30</span>
                        </button>
                        <button class="prop-btn flex flex-col items-center p-2 rounded-lg border border-gray-200 hover:border-primary transition-all" data-prop="boom">
                            <i class="fa fa-bomb text-xl mb-1"></i>
                            <span class="text-xs">爆炸</span>
                            <span class="text-xs text-primary">60</span>
                        </button>
                        <button class="prop-btn flex flex-col items-center p-2 rounded-lg border border-gray-200 hover:border-primary transition-all" data-prop="add_step">
                            <i class="fa fa-plus-circle text-xl mb-1"></i>
                            <span class="text-xs">加步</span>
                            <span class="text-xs text-primary">40</span>
                        </button>
                    </div>
                </div>

                <!-- 全服排行榜 -->
                <div class="bg-white rounded-xl p-4 game-shadow">
                    <h3 class="text-lg font-bold mb-3 flex items-center">
                        <i class="fa fa-trophy text-accent mr-2"></i>全服排行
                    </h3>
                    <ul class="space-y-2">
                        <li class="flex items-center prize-badge" data-prize="¥50">
                            <div class="w-6 h-6 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">1</div>
                            <span class="flex-1" id="rank-1">加载中...</span>
                            <span class="font-bold" id="rank-1-score">--分</span>
                        </li>
                        <li class="flex items-center prize-badge" data-prize="¥30">
                            <div class="w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center text-xs font-bold mr-2">2</div>
                            <span class="flex-1" id="rank-2">加载中...</span>
                            <span class="font-bold" id="rank-2-score">--分</span>
                        </li>
                        <li class="flex items-center prize-badge" data-prize="¥20">
                            <div class="w-6 h-6 bg-amber-700 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">3</div>
                            <span class="flex-1" id="rank-3">加载中...</span>
                            <span class="font-bold" id="rank-3-score">--分</span>
                        </li>
                        <li class="flex items-center prize-badge" data-prize="¥10">
                            <div class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">4</div>
                            <span class="flex-1" id="rank-4">加载中...</span>
                            <span class="font-bold" id="rank-4-score">--分</span>
                        </li>
                        <li class="flex items-center prize-badge" data-prize="¥5">
                            <div class="w-6 h-6 bg-gray-400 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">5</div>
                            <span class="flex-1" id="rank-5">加载中...</span>
                            <span class="font-bold" id="rank-5-score">--分</span>
                        </li>
                    </ul>
                    <button id="claim-rank-reward" class="mt-3 w-full bg-primary/10 hover:bg-primary/20 text-primary rounded-lg py-1 text-sm transition-all hidden">
                        领取排名奖励
                    </button>
                </div>

                <!-- 每日任务 -->
                <div class="bg-white rounded-xl p-4 game-shadow">
                    <h3 class="text-lg font-bold mb-3 flex items-center">
                        <i class="fa fa-tasks text-accent mr-2"></i>每日任务
                    </h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-center">
                            <i class="fa fa-check-circle text-green-500 mr-2"></i>
                            <span>完成3局游戏</span>
                            <span class="ml-auto text-primary">+30个"万花币"</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-circle-o text-gray-300 mr-2"></i>
                            <span>合成1个十字特效</span>
                            <span class="ml-auto text-primary">+25个"万花币"</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-circle-o text-gray-300 mr-2"></i>
                            <span>获得1000分</span>
                            <span class="ml-auto text-primary">+40个"万花币"</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fa fa-circle-o text-gray-300 mr-2"></i>
                            <span>分享游戏1次</span>
                            <span class="ml-auto text-primary">+20个"万花币"</span>
                        </li>
                    </ul>
                    <button class="mt-3 w-full bg-primary/10 hover:bg-primary/20 text-primary rounded-lg py-1 text-sm transition-all">
                        领取奖励
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部信息 -->
    <footer class="mt-8 bg-white py-4 border-t">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-600">
                本游戏由北京修车【万花楼】赞助 
                由 <a href="https://t.me/bjxc010" target="_blank" class="text-primary hover:underline">@bjxc010</a> 开发
            </p>
            <div class="flex justify-center space-x-4 mt-2">
                <button class="text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-share-alt mr-1"></i>分享游戏
                </button>
                <button class="text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-question-circle mr-1"></i>帮助
                </button>
                <button class="text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-cog mr-1"></i>设置
                </button>
            </div>
        </div>
    </footer>

    <!-- 登录模态框 -->
    <div id="login-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md game-shadow">
            <h3 class="text-xl font-bold mb-4">登录游戏</h3>
            <p class="text-gray-600 mb-6">通过Telegram账号登录，同步你的游戏进度</p>
            <button id="telegram-login" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center transition-all">
                <i class="fa fa-telegram text-2xl mr-2"></i>
                用Telegram登录
            </button>
            <button id="close-login" class="w-full mt-3 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg transition-all">
                稍后登录
            </button>
        </div>
    </div>

    <!-- 提现模态框 -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md game-shadow">
            <h3 class="text-xl font-bold mb-4">提现到支付宝</h3>
            <p class="text-gray-600 mb-4">10000个"万花币" = 10元人民币，提现后12小时内到账</p>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">可提现金额</label>
                <div class="bg-gray-100 p-2 rounded-lg">
                    <span id="withdrawable-amount">0.00元</span>
                    <span class="text-gray-500 text-sm ml-2">(<span id="withdrawable-coins">0</span>个"万花币")</span>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="alipay-name" class="block text-sm font-medium text-gray-700 mb-1">真实姓名</label>
                <input type="text" id="alipay-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请输入真实姓名">
            </div>
            
            <div class="mb-6">
                <label for="alipay-account" class="block text-sm font-medium text-gray-700 mb-1">支付宝账号</label>
                <input type="text" id="alipay-account" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请输入支付宝账号">
            </div>
            
            <div class="flex space-x-3">
                <button id="confirm-withdraw" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition-all">
                    确认提现
                </button>
                <button id="close-withdraw" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg transition-all">
                    取消
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-4 text-center">
                请确保填写正确的支付宝信息，否则可能导致提现失败
            </p>
        </div>
    </div>

    <!-- 提现成功模态框 -->
    <div id="withdraw-success" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md game-shadow text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa fa-check text-green-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">提现申请提交成功</h3>
            <p class="text-gray-600 mb-6">
                你的提现申请已提交，我们将在12小时内处理并转账到你的支付宝账户
            </p>
            <button id="close-success" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-all">
                确定
            </button>
        </div>
    </div>

    <script>
        // 游戏配置和状态
        const gameConfig = {
            gridSize: 5, // 5x5网格
            elements: ['flower', 'star', 'moon', 'sun', 'gem', 'bell'],
            baseScore: 10,
            currentLevel: 1,
            targetScore: 500,
            moves: 20,
            dailyAttempts: 6, // 每日游戏次数
            coinsToCashRate: 1000, // 1000个"万花币" = 1元人民币
            minWithdrawCoins: 10000, // 最低提现10000个"万花币"
        };

        const gameState = {
            board: [],
            score: 0,
            remainingMoves: gameConfig.moves,
            selectedTile: null,
            isProcessing: false,
            coins: 0,
            remainingAttempts: gameConfig.dailyAttempts,
            props: {
                shuffle: 0,
                boom: 0,
                add_step: 0
            },
            hasCheckedIn: false, // 是否已签到
            userId: 'guest', // 默认游客ID
            userName: '游客' // 默认游客名称
        };

        // 初始化Supabase
        const supabaseUrl = 'https://ylnfjlltesnlfanrxfoy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsbmZqbGx0ZXNubGZhbnJ4Zm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDc0MjMsImV4cCI6MjA3MTY4MzQyM30.czuQwYoFd7Ew9f-PBaojhsWJkXrBEtkqTRdhfX-DWFk';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Telegram配置
        const BOT_TOKEN = "7058588982:AAGaWY3tDT7np7-rwAp350i6gBhC0d_UxjI";
        const BOT_USERNAME = "bjxcwhljiluBot";
        const ADMIN_ID = "8392100400";

        // DOM元素
        const gameBoard = document.getElementById('game-board');
        const currentScoreEl = document.getElementById('current-score');
        const remainingMovesEl = document.getElementById('remaining-moves');
        const targetScoreEl = document.getElementById('target-score');
        const coinCountEl = document.getElementById('coin-count');
        const levelDisplayEl = document.getElementById('level-display');
        const gameOverEl = document.getElementById('game-over');
        const gameOverTitleEl = document.getElementById('game-over-title');
        const gameOverMessageEl = document.getElementById('game-over-message');
        const retryBtn = document.getElementById('retry-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const userBtn = document.getElementById('user-btn');
        const loginModal = document.getElementById('login-modal');
        const telegramLoginBtn = document.getElementById('telegram-login');
        const closeLoginBtn = document.getElementById('close-login');
        const propBtns = document.querySelectorAll('.prop-btn');
        const gameAttemptsEl = document.getElementById('game-attempts');
        const noAttemptsEl = document.getElementById('no-attempts');
        const remainingAttemptsEl = document.getElementById('remaining-attempts');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const shareGameBtn = document.getElementById('share-game-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const withdrawModal = document.getElementById('withdraw-modal');
        const closeWithdrawBtn = document.getElementById('close-withdraw');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw');
        const alipayNameEl = document.getElementById('alipay-name');
        const alipayAccountEl = document.getElementById('alipay-account');
        const withdrawableAmountEl = document.getElementById('withdrawable-amount');
        const withdrawableCoinsEl = document.getElementById('withdrawable-coins');
        const withdrawSuccessEl = document.getElementById('withdraw-success');
        const closeSuccessBtn = document.getElementById('close-success');
        const checkinBtn = document.getElementById('checkin-btn');
        const claimRankRewardBtn = document.getElementById('claim-rank-reward');

        // 元素图标映射
        const elementIcons = {
            flower: 'fa-pagelines',
            star: 'fa-star',
            moon: 'fa-moon-o',
            sun: 'fa-sun-o',
            gem: 'fa-diamond',
            bell: 'fa-bell'
        };

        // 元素颜色映射
        const elementColors = {
            flower: 'text-green-500',
            star: 'text-purple-500',
            moon: 'text-blue-500',
            sun: 'text-yellow-500',
            gem: 'text-red-500',
            bell: 'text-amber-500'
        };

        // 初始化游戏
        function initGame() {
            // 检查是否还有游戏次数
            if (gameState.remainingAttempts <= 0) {
                noAttemptsEl.classList.remove('hidden');
                remainingAttemptsEl.textContent = gameState.remainingAttempts;
                return;
            }
            
            // 重置游戏状态
            gameState.score = 0;
            gameState.remainingMoves = gameConfig.moves;
            gameState.selectedTile = null;
            gameState.isProcessing = false;
            
            // 更新UI
            updateScore();
            updateRemainingMoves();
            targetScoreEl.textContent = gameConfig.targetScore;
            levelDisplayEl.textContent = `关卡: ${gameConfig.currentLevel}`;
            
            // 生成游戏板
            generateBoard();
            
            // 检查初始是否有可消除的组合，如果有则重新生成
            while (checkForMatches().length > 0) {
                generateBoard();
            }
            
            // 渲染游戏板
            renderBoard();
            
            // 隐藏游戏结束界面
            gameOverEl.classList.add('hidden');
            noAttemptsEl.classList.add('hidden');
        }

        // 生成游戏板
        function generateBoard() {
            gameState.board = [];
            for (let row = 0; row < gameConfig.gridSize; row++) {
                const currentRow = [];
                for (let col = 0; col < gameConfig.gridSize; col++) {
                    // 确保不会在初始状态下生成可消除的组合
                    let validElements = [...gameConfig.elements];
                    
                    // 检查左侧两个元素，避免横向三连
                    if (col >= 2) {
                        if (currentRow[col-1] === currentRow[col-2]) {
                            validElements = validElements.filter(el => el !== currentRow[col-1]);
                        }
                    }
                    
                    // 检查上方两个元素，避免纵向三连
                    if (row >= 2) {
                        if (gameState.board[row-1][col] === gameState.board[row-2][col]) {
                            validElements = validElements.filter(el => el !== gameState.board[row-1][col]);
                        }
                    }
                    
                    // 随机选择一个有效的元素
                    const randomIndex = Math.floor(Math.random() * validElements.length);
                    currentRow.push(validElements[randomIndex]);
                }
                gameState.board.push(currentRow);
            }
        }

        // 渲染游戏板
        function renderBoard() {
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${gameConfig.gridSize}, 1fr)`;
            
            for (let row = 0; row < gameConfig.gridSize; row++) {
                for (let col = 0; col < gameConfig.gridSize; col++) {
                    const element = gameState.board[row][col];
                    const tile = document.createElement('div');
                    tile.className = `tile bg-white rounded-lg flex items-center justify-center tile-shadow cursor-pointer hover:scale-105 transition-transform`;
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    
                    const icon = document.createElement('i');
                    icon.className = `fa ${elementIcons[element]} text-2xl md:text-3xl ${elementColors[element]}`;
                    tile.appendChild(icon);
                    
                    tile.addEventListener('click', () => handleTileClick(row, col));
                    
                    gameBoard.appendChild(tile);
                }
            }
        }

        // 处理方块点击
        function handleTileClick(row, col) {
            if (gameState.isProcessing) return;
            
            // 如果没有选中的方块，选中当前方块
            if (!gameState.selectedTile) {
                gameState.selectedTile = { row, col };
                highlightSelectedTile(row, col);
                return;
            }
            
            // 如果点击的是已经选中的方块，取消选中
            if (gameState.selectedTile.row === row && gameState.selectedTile.col === col) {
                gameState.selectedTile = null;
                removeHighlights();
                return;
            }
            
            // 检查是否相邻（上下左右）
            const isAdjacent = 
                (Math.abs(gameState.selectedTile.row - row) === 1 && gameState.selectedTile.col === col) ||
                (Math.abs(gameState.selectedTile.col - col) === 1 && gameState.selectedTile.row === row);
            
            if (!isAdjacent) {
                // 不相邻，选中新的方块
                gameState.selectedTile = { row, col };
                removeHighlights();
                highlightSelectedTile(row, col);
                return;
            }
            
            // 相邻，尝试交换
            swapTiles(gameState.selectedTile.row, gameState.selectedTile.col, row, col);
        }

        // 高亮选中的方块
        function highlightSelectedTile(row, col) {
            const tiles = document.querySelectorAll('.tile');
            const index = row * gameConfig.gridSize + col;
            tiles[index].classList.add('ring-4', 'ring-accent', 'scale-110');
        }

        // 移除所有高亮
        function removeHighlights() {
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => {
                tile.classList.remove('ring-4', 'ring-accent', 'scale-110');
            });
        }

        // 交换方块
        function swapTiles(row1, col1, row2, col2) {
            gameState.isProcessing = true;
            
            // 交换数据
            const temp = gameState.board[row1][col1];
            gameState.board[row1][col1] = gameState.board[row2][col2];
            gameState.board[row2][col2] = temp;
            
            // 重新渲染
            renderBoard();
            
            // 检查是否有匹配
            setTimeout(() => {
                const matches = checkForMatches();
                
                if (matches.length > 0) {
                    // 有匹配，处理消除
                    processMatches(matches);
                    gameState.remainingMoves--;
                    updateRemainingMoves();
                    
                    // 检查游戏是否结束
                    checkGameStatus();
                } else {
                    // 没有匹配，交换回来
                    const temp = gameState.board[row1][col1];
                    gameState.board[row1][col1] = gameState.board[row2][col2];
                    gameState.board[row2][col2] = temp;
                    
                    // 重新渲染
                    renderBoard();
                    
                    // 添加动画效果表示无效交换
                    const tiles = document.querySelectorAll('.tile');
                    const index1 = row1 * gameConfig.gridSize + col1;
                    const index2 = row2 * gameConfig.gridSize + col2;
                    tiles[index1].classList.add('animate-shake');
                    tiles[index2].classList.add('animate-shake');
                    
                    setTimeout(() => {
                        tiles[index1].classList.remove('animate-shake');
                        tiles[index2].classList.remove('animate-shake');
                        gameState.isProcessing = false;
                    }, 500);
                }
                
                // 重置选中状态
                gameState.selectedTile = null;
                removeHighlights();
            }, 300);
        }

        // 检查匹配
        function checkForMatches() {
            const matches = [];
            
            // 检查水平匹配
            for (let row = 0; row < gameConfig.gridSize; row++) {
                let col = 0;
                while (col < gameConfig.gridSize - 2) {
                    const current = gameState.board[row][col];
                    if (current && 
                        current === gameState.board[row][col + 1] && 
                        current === gameState.board[row][col + 2]) {
                        
                        // 找到匹配，检查是否有更长的匹配
                        let matchLength = 3;
                        let nextCol = col + 3;
                        
                        while (nextCol < gameConfig.gridSize && gameState.board[row][nextCol] === current) {
                            matchLength++;
                            nextCol++;
                        }
                        
                        // 添加匹配的位置
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row, col: col + i, type: getSpecialType(matchLength, 'horizontal') });
                        }
                        
                        col = nextCol;
                    } else {
                        col++;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let col = 0; col < gameConfig.gridSize; col++) {
                let row = 0;
                while (row < gameConfig.gridSize - 2) {
                    const current = gameState.board[row][col];
                    if (current && 
                        current === gameState.board[row + 1][col] && 
                        current === gameState.board[row + 2][col]) {
                        
                        // 找到匹配，检查是否有更长的匹配
                        let matchLength = 3;
                        let nextRow = row + 3;
                        
                        while (nextRow < gameConfig.gridSize && gameState.board[nextRow][col] === current) {
                            matchLength++;
                            nextRow++;
                        }
                        
                        // 添加匹配的位置
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row: row + i, col, type: getSpecialType(matchLength, 'vertical') });
                        }
                        
                        row = nextRow;
                    } else {
                        row++;
                    }
                }
            }
            
            // 检查L/T型匹配（十字特效）
            const lMatches = checkLMatches();
            matches.push(...lMatches);
            
            return matches;
        }

        // 检查L/T型匹配
        function checkLMatches() {
            const matches = [];
            
            for (let row = 1; row < gameConfig.gridSize - 1; row++) {
                for (let col = 1; col < gameConfig.gridSize - 1; col++) {
                    const center = gameState.board[row][col];
                    if (!center) continue;
                    
                    // 检查T型匹配
                    if (center === gameState.board[row-1][col] && 
                        center === gameState.board[row+1][col] && 
                        center === gameState.board[row][col-1] && 
                        center === gameState.board[row][col+1]) {
                        // 十字匹配（5个元素）
                        matches.push(
                            { row, col, type: 'cross' },
                            { row-1, col, type: 'cross' },
                            { row+1, col, type: 'cross' },
                            { row, col-1, type: 'cross' },
                            { row, col+1, type: 'cross' }
                        );
                    } 
                    // 检查L型匹配（3+2模式）
                    else if (
                        (center === gameState.board[row-1][col] && 
                         center === gameState.board[row+1][col] && 
                         center === gameState.board[row][col-1]) ||
                        
                        (center === gameState.board[row-1][col] && 
                         center === gameState.board[row+1][col] && 
                         center === gameState.board[row][col+1]) ||
                        
                        (center === gameState.board[row][col-1] && 
                         center === gameState.board[row][col+1] && 
                         center === gameState.board[row-1][col]) ||
                        
                        (center === gameState.board[row][col-1] && 
                         center === gameState.board[row][col+1] && 
                         center === gameState.board[row+1][col])
                    ) {
                        // L型匹配
                        matches.push(
                            { row, col, type: 'cross' },
                            { row-1, col, type: 'cross' },
                            { row+1, col, type: 'cross' },
                            { row, col-1, type: 'cross' },
                            { row, col+1, type: 'cross' }
                        );
                    }
                }
            }
            
            return matches;
        }

        // 确定特殊类型
        function getSpecialType(matchLength, direction) {
            if (matchLength >= 5) {
                return 'boom'; // 爆炸特效
            } else if (matchLength >= 4) {
                return 'line'; // 直线特效
            }
            return 'normal'; // 普通消除
        }

        // 处理匹配
        function processMatches(matches) {
            if (matches.length === 0) {
                gameState.isProcessing = false;
                return;
            }
            
            // 计算得分
            let scoreToAdd = 0;
            matches.forEach(match => {
                switch(match.type) {
                    case 'normal':
                        scoreToAdd += gameConfig.baseScore;
                        break;
                    case 'line':
                        scoreToAdd += gameConfig.baseScore * 2;
                        break;
                    case 'boom':
                        scoreToAdd += gameConfig.baseScore * 3;
                        break;
                    case 'cross':
                        scoreToAdd += gameConfig.baseScore * 4;
                        break;
                }
            });
            
            gameState.score += scoreToAdd;
            updateScore();
            
            // 添加消除动画
            const tiles = document.querySelectorAll('.tile');
            matches.forEach(match => {
                const index = match.row * gameConfig.gridSize + match.col;
                tiles[index].classList.add('animate-clear');
            });
            
            // 移除匹配的元素
            setTimeout(() => {
                // 处理特殊特效
                let specialEffects = [];
                matches.forEach(match => {
                    gameState.board[match.row][match.col] = null;
                    if (match.type !== 'normal') {
                        specialEffects.push(match);
                    }
                });
                
                // 触发特殊特效
                if (specialEffects.length > 0) {
                    triggerSpecialEffects(specialEffects);
                } else {
                    // 让元素下落
                    dropElements();
                    
                    // 填充新元素
                    setTimeout(() => {
                        fillEmptySpaces();
                        
                        // 检查是否有新的匹配
                        setTimeout(() => {
                            const newMatches = checkForMatches();
                            processMatches(newMatches);
                        }, 500);
                    }, 500);
                }
            }, 500);
        }

        // 触发特殊特效
        function triggerSpecialEffects(effects) {
            let allMatches = [];
            
            effects.forEach(effect => {
                switch(effect.type) {
                    case 'line':
                        // 直线特效 - 消除整行或整列
                        const isHorizontal = Math.random() > 0.5;
                        if (isHorizontal) {
                            // 消除整行
                            for (let col = 0; col < gameConfig.gridSize; col++) {
                                allMatches.push({row: effect.row, col, type: 'normal'});
                                gameState.board[effect.row][col] = null;
                            }
                        } else {
                            // 消除整列
                            for (let row = 0; row < gameConfig.gridSize; row++) {
                                allMatches.push({row, col: effect.col, type: 'normal'});
                                gameState.board[row][effect.col] = null;
                            }
                        }
                        break;
                        
                    case 'boom':
                        // 爆炸特效 - 消除3x3范围
                        for (let r = Math.max(0, effect.row - 1); r <= Math.min(gameConfig.gridSize - 1, effect.row + 1); r++) {
                            for (let c = Math.max(0, effect.col - 1); c <= Math.min(gameConfig.gridSize - 1, effect.col + 1); c++) {
                                allMatches.push({row: r, col: c, type: 'normal'});
                                gameState.board[r][c] = null;
                            }
                        }
                        break;
                        
                    case 'cross':
                        // 十字特效 - 消除交叉行和列
                        // 消除整行
                        for (let col = 0; col < gameConfig.gridSize; col++) {
                            allMatches.push({row: effect.row, col, type: 'normal'});
                            gameState.board[effect.row][col] = null;
                        }
                        // 消除整列
                        for (let row = 0; row < gameConfig.gridSize; row++) {
                            allMatches.push({row, col: effect.col, type: 'normal'});
                            gameState.board[row][effect.col] = null;
                        }
                        break;
                }
            });
            
            // 重新渲染以显示特效结果
            renderBoard();
            
            // 延迟后继续处理
            setTimeout(() => {
                // 让元素下落
                dropElements();
                
                // 填充新元素
                setTimeout(() => {
                    fillEmptySpaces();
                    
                    // 检查是否有新的匹配
                    setTimeout(() => {
                        const newMatches = checkForMatches();
                        processMatches(newMatches);
                    }, 500);
                }, 500);
            }, 800);
        }

        // 让元素下落
        function dropElements() {
            for (let col = 0; col < gameConfig.gridSize; col++) {
                for (let row = gameConfig.gridSize - 1; row > 0; row--) {
                    if (gameState.board[row][col] === null) {
                        // 找到当前列上方第一个非空元素
                        for (let r = row - 1; r >= 0; r--) {
                            if (gameState.board[r][col] !== null) {
                                // 下落
                                gameState.board[row][col] = gameState.board[r][col];
                                gameState.board[r][col] = null;
                                break;
                            }
                        }
                    }
                }
            }
            
            renderBoard();
        }

        // 填充空白位置
        function fillEmptySpaces() {
            for (let row = 0; row < gameConfig.gridSize; row++) {
                for (let col = 0; col < gameConfig.gridSize; col++) {
                    if (gameState.board[row][col] === null) {
                        // 随机选择一个元素
                        const randomIndex = Math.floor(Math.random() * gameConfig.elements.length);
                        gameState.board[row][col] = gameConfig.elements[randomIndex];
                    }
                }
            }
            
            renderBoard();
        }

        // 更新分数
        function updateScore() {
            currentScoreEl.textContent = gameState.score;
            
            // 添加分数变化动画
            currentScoreEl.classList.add('animate-pop');
            setTimeout(() => {
                currentScoreEl.classList.remove('animate-pop');
            }, 300);
        }

        // 更新剩余步数
        function updateRemainingMoves() {
            remainingMovesEl.textContent = gameState.remainingMoves;
            
            // 步数较少时添加警告颜色
            if (gameState.remainingMoves <= 5) {
                remainingMovesEl.classList.add('text-red-500');
            } else {
                remainingMovesEl.classList.remove('text-red-500');
            }
        }

        // 更新游戏次数显示
        function updateGameAttempts() {
            gameAttemptsEl.textContent = `剩余次数: ${gameState.remainingAttempts}`;
            remainingAttemptsEl.textContent = gameState.remainingAttempts;
        }

        // 检查游戏状态
        function checkGameStatus() {
            if (gameState.remainingMoves <= 0) {
                // 步数用完
                if (gameState.score >= gameConfig.targetScore) {
                    // 通关
                    endGame(true);
                } else {
                    // 未通关
                    endGame(false);
                }
            } else if (gameState.score >= gameConfig.targetScore) {
                // 提前完成目标
                endGame(true);
            }
        }

        // 游戏结束
        function endGame(isWin) {
            gameState.isProcessing = true;
            // 减少游戏次数
            gameState.remainingAttempts--;
            updateGameAttempts();
            
            if (isWin) {
                gameOverTitleEl.textContent = '恭喜过关！';
                const coinsEarned = Math.floor(gameState.score / 10);
                gameOverMessageEl.textContent = `得分: ${gameState.score} 分，获得 ${coinsEarned} 个"万花币"`;
                
                // 增加"万花币"
                gameState.coins += coinsEarned;
                coinCountEl.textContent = gameState.coins;
                
                // 显示下一关按钮
                nextLevelBtn.classList.remove('hidden');
                
                // 保存"万花币"
                saveCoins();
            } else {
                gameOverTitleEl.textContent = '游戏结束';
                gameOverMessageEl.textContent = `得分: ${gameState.score} 分，目标: ${gameConfig.targetScore} 分`;
                nextLevelBtn.classList.add('hidden');
            }
            
            // 显示游戏结束界面
            gameOverEl.classList.remove('hidden');
            
            // 保存游戏进度到数据库
            saveGameProgress(isWin);
        }

        // 保存游戏进度到数据库
        async function saveGameProgress(isWin) {
            try {
                if (gameState.userId === 'guest') return;
                
                if (isWin && gameConfig.currentLevel > localStorage.getItem('maxLevel')) {
                    localStorage.setItem('maxLevel', gameConfig.currentLevel);
                }
                
                // 保存游戏记录
                const { data, error } = await supabase
                    .from('game_records')
                    .insert([
                        { 
                            user_id: gameState.userId, 
                            level: gameConfig.currentLevel, 
                            score: gameState.score, 
                            is_win: isWin,
                            coins_earned: isWin ? Math.floor(gameState.score / 10) : 0
                        }
                    ]);
                
                if (error) throw error;
                
                // 更新用户信息
                if (isWin) {
                    const { error: userError } = await supabase
                        .from('users')
                        .upsert([
                            { 
                                user_id: gameState.userId, 
                                max_level: Math.max(gameConfig.currentLevel, parseInt(localStorage.getItem('maxLevel') || 0)),
                                kaleido_coins: gameState.coins,
                                total_score: gameState.score + (await getTotalScore())
                            }
                        ]);
                        
                    if (userError) throw userError;
                }
                
                // 更新排行榜
                fetchLeaderboard();
                
            } catch (error) {
                console.error('保存游戏进度失败:', error);
            }
        }

        // 获取用户总得分
        async function getTotalScore() {
            try {
                if (gameState.userId === 'guest') return 0;
                
                const { data, error } = await supabase
                    .from('users')
                    .select('total_score')
                    .eq('user_id', gameState.userId)
                    .single();
                    
                if (error || !data) return 0;
                return data.total_score || 0;
                
            } catch (error) {
                console.error('获取总得分失败:', error);
                return 0;
            }
        }

        // 保存"万花币"数量
        async function saveCoins() {
            try {
                if (gameState.userId === 'guest') return;
                
                const { error } = await supabase
                    .from('users')
                    .update({ kaleido_coins: gameState.coins })
                    .eq('user_id', gameState.userId);
                    
                if (error) throw error;
                
            } catch (error) {
                console.error('保存"万花币"失败:', error);
            }
        }

        // 加载用户数据
        async function loadUserData() {
            try {
                // 检查本地存储的用户ID
                const savedUserId = localStorage.getItem('userId');
                if (savedUserId) {
                    gameState.userId = savedUserId;
                    gameState.userName = localStorage.getItem('userName') || '玩家';
                }
                
                if (gameState.userId === 'guest') {
                    // 游客用户，使用本地存储的数据
                    gameState.coins = parseInt(localStorage.getItem('guestCoins') || '0');
                    gameState.remainingAttempts = parseInt(localStorage.getItem('guestAttempts') || gameConfig.dailyAttempts);
                    
                    // 检查是否是新的一天，重置游戏次数
                    const lastPlayDate = localStorage.getItem('lastPlayDate');
                    const today = new Date().toDateString();
                    if (!lastPlayDate || lastPlayDate !== today) {
                        gameState.remainingAttempts = gameConfig.dailyAttempts;
                        localStorage.setItem('lastPlayDate', today);
                        gameState.hasCheckedIn = false;
                        localStorage.setItem('hasCheckedIn', 'false');
                    } else {
                        gameState.hasCheckedIn = localStorage.getItem('hasCheckedIn') === 'true';
                    }
                } else {
                    // 登录用户，从数据库加载
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', gameState.userId)
                        .single();
                    
                    if (error) {
                        // 用户不存在，创建新用户
                        await supabase
                            .from('users')
                            .insert([
                                { 
                                    user_id: gameState.userId, 
                                    username: gameState.userName,
                                    max_level: 1, 
                                    kaleido_coins: 0,
                                    total_score: 0
                                }
                            ]);
                            
                        gameState.coins = 0;
                        gameState.remainingAttempts = gameConfig.dailyAttempts;
                        gameConfig.currentLevel = 1;
                        gameState.hasCheckedIn = false;
                    } else {
                        gameState.coins = data.kaleido_coins || 0;
                        gameConfig.currentLevel = data.max_level || 1;
                        gameState.remainingAttempts = data.daily_attempts || gameConfig.dailyAttempts;
                        
                        // 检查签到状态
                        const lastCheckinDate = data.last_checkin ? new Date(data.last_checkin).toDateString() : null;
                        const today = new Date().toDateString();
                        gameState.hasCheckedIn = lastCheckinDate === today;
                        
                        // 检查是否是新的一天，重置游戏次数
                        const lastPlayDate = data.last_play ? new Date(data.last_play).toDateString() : null;
                        if (!lastPlayDate || lastPlayDate !== today) {
                            gameState.remainingAttempts = gameConfig.dailyAttempts;
                            await supabase
                                .from('users')
                                .update({ daily_attempts: gameConfig.dailyAttempts, last_play: new Date() })
                                .eq('user_id', gameState.userId);
                        }
                    }
                }
                
                // 更新UI
                coinCountEl.textContent = gameState.coins;
                levelDisplayEl.textContent = `关卡: ${gameConfig.currentLevel}`;
                updateGameAttempts();
                
                // 更新签到按钮状态
                if (gameState.hasCheckedIn) {
                    checkinBtn.textContent = '已签到';
                    checkinBtn.disabled = true;
                    checkinBtn.classList.add('bg-gray-400');
                    checkinBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
                }
                
                // 从本地存储加载最大关卡
                const savedMaxLevel = localStorage.getItem('maxLevel');
                if (savedMaxLevel) {
                    gameConfig.currentLevel = parseInt(savedMaxLevel);
                }
                
                // 设置关卡目标
                gameConfig.targetScore = 500 + (gameConfig.currentLevel - 1) * 100;
                targetScoreEl.textContent = gameConfig.targetScore;
                
                // 更新可提现金额
                updateWithdrawableAmount();
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                // 失败时使用默认值
                gameState.coins = 0;
                gameConfig.currentLevel = 1;
                gameState.remainingAttempts = gameConfig.dailyAttempts;
                coinCountEl.textContent = gameState.coins;
                updateGameAttempts();
            }
        }

        // 进入下一关
        function nextLevel() {
            gameConfig.currentLevel++;
            
            // 每20关增加棋盘大小
            if (gameConfig.currentLevel === 21) {
                gameConfig.gridSize = 6;
            }
            
            // 增加难度
            gameConfig.targetScore = 500 + (gameConfig.currentLevel - 1) * 100;
            gameConfig.moves = Math.max(10, 20 - Math.floor((gameConfig.currentLevel - 1) / 5));
            
            // 保存最大关卡
            localStorage.setItem('maxLevel', gameConfig.currentLevel);
            
            // 重新开始游戏
            initGame();
        }

        // 使用道具
        function useProp(propType) {
            if (gameState.isProcessing) return;
            
            // 检查是否有足够的道具
            if (gameState.props[propType] <= 0) {
                // 提示购买道具
                const cost = getPropCost(propType);
                if (gameState.coins >= cost) {
                    if (confirm(`是否花费 ${cost} 个"万花币"购买该道具?`)) {
                        gameState.coins -= cost;
                        gameState.props[propType]++;
                        coinCountEl.textContent = gameState.coins;
                        saveCoins();
                    } else {
                        return;
                    }
                } else {
                    alert('道具不足，且"万花币"不够购买');
                    return;
                }
            }
            
            // 使用道具
            gameState.props[propType]--;
            
            switch(propType) {
                case 'shuffle':
                    // 洗牌道具
                    shuffleBoard();
                    break;
                case 'boom':
                    // 爆炸道具 - 让用户选择位置
                    selectBoomPosition();
                    break;
                case 'add_step':
                    // 增加步数
                    gameState.remainingMoves += 5;
                    updateRemainingMoves();
                    break;
            }
            
            // 更新道具显示
            updatePropDisplay();
        }

        // 获取道具成本
        function getPropCost(propType) {
            const costs = {
                shuffle: 30,
                boom: 60,
                add_step: 40
            };
            return costs[propType] || 0;
        }

        // 更新道具显示
        function updatePropDisplay() {
            propBtns.forEach(btn => {
                const propType = btn.dataset.prop;
                const costEl = btn.querySelector('.text-primary');
                // 显示拥有的数量/成本
                costEl.textContent = gameState.props[propType] > 0 ? gameState.props[propType] : getPropCost(propType);
            });
        }

        // 洗牌
        function shuffleBoard() {
            gameState.isProcessing = true;
            
            // 保存当前分数和步数
            const currentScore = gameState.score;
            const currentMoves = gameState.remainingMoves;
            
            // 重新生成棋盘
            generateBoard();
            
            // 确保不会生成无匹配的棋盘
            while (checkForMatches().length === 0) {
                generateBoard();
            }
            
            // 渲染新棋盘
            renderBoard();
            
            // 恢复状态
            gameState.score = currentScore;
            gameState.remainingMoves = currentMoves;
            gameState.isProcessing = false;
        }

        // 选择爆炸位置
        function selectBoomPosition() {
            gameState.isProcessing = true;
            alert('请点击要爆炸的位置');
            
            // 为所有方块添加爆炸点击事件
            const tiles = document.querySelectorAll('.tile');
            tiles.forEach(tile => {
                tile.classList.add('cursor-crosshair', 'hover:bg-red-100');
                
                // 添加临时点击事件
                const handleBoomClick = function() {
                    const row = parseInt(tile.dataset.row);
                    const col = parseInt(tile.dataset.col);
                    
                    // 移除所有临时事件和样式
                    tiles.forEach(t => {
                        t.classList.remove('cursor-crosshair', 'hover:bg-red-100');
                        t.removeEventListener('click', handleBoomClick);
                    });
                    
                    // 执行爆炸
                    executeBoom(row, col);
                };
                
                tile.addEventListener('click', handleBoomClick, { once: true });
            });
        }

        // 执行爆炸
        function executeBoom(row, col) {
            const matches = [];
            
            // 爆炸范围：3x3
            for (let r = Math.max(0, row - 1); r <= Math.min(gameConfig.gridSize - 1, row + 1); r++) {
                for (let c = Math.max(0, col - 1); c <= Math.min(gameConfig.gridSize - 1, col + 1); c++) {
                    matches.push({ row: r, col: c, type: 'boom' });
                }
            }
            
            // 处理爆炸消除
            processMatches(matches);
            
            // 减少一步
            gameState.remainingMoves--;
            updateRemainingMoves();
            
            // 检查游戏状态
            checkGameStatus();
        }

        // 显示提现模态框
        function showWithdrawModal() {
            if (gameState.userId === 'guest') {
                alert('请先登录以使用提现功能');
                loginModal.classList.remove('hidden');
                return;
            }
            
            updateWithdrawableAmount();
            withdrawModal.classList.remove('hidden');
        }

        // 更新可提现金额
        function updateWithdrawableAmount() {
            // 计算可提现的"万花币"数量（取10000的整数倍）
            const withdrawableCoins = Math.floor(gameState.coins / gameConfig.minWithdrawCoins) * gameConfig.minWithdrawCoins;
            const withdrawableAmount = withdrawableCoins / gameConfig.coinsToCashRate;
            
            withdrawableCoinsEl.textContent = withdrawableCoins;
            withdrawableAmountEl.textContent = withdrawableAmount.toFixed(2) + '元';
            
            // 禁用/启用提现按钮
            if (withdrawableCoins < gameConfig.minWithdrawCoins) {
                confirmWithdrawBtn.disabled = true;
                confirmWithdrawBtn.classList.add('bg-gray-400');
                confirmWithdrawBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            } else {
                confirmWithdrawBtn.disabled = false;
                confirmWithdrawBtn.classList.remove('bg-gray-400');
                confirmWithdrawBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            }
        }

        // 确认提现
        async function confirmWithdraw() {
            const alipayName = alipayNameEl.value.trim();
            const alipayAccount = alipayAccountEl.value.trim();
            
            if (!alipayName) {
                alert('请输入真实姓名');
                return;
            }
            
            if (!alipayAccount) {
                alert('请输入支付宝账号');
                return;
            }
            
            // 计算可提现的"万花币"数量
            const withdrawableCoins = Math.floor(gameState.coins / gameConfig.minWithdrawCoins) * gameConfig.minWithdrawCoins;
            
            if (withdrawableCoins < gameConfig.minWithdrawCoins) {
                alert(`最低提现金额为${gameConfig.minWithdrawCoins}个"万花币"`);
                return;
            }
            
            try {
                // 记录提现请求
                const { data, error } = await supabase
                    .from('withdrawals')
                    .insert([
                        { 
                            user_id: gameState.userId,
                            username: gameState.userName,
                            alipay_name: alipayName,
                            alipay_account: alipayAccount,
                            coins_amount: withdrawableCoins,
                            cash_amount: withdrawableCoins / gameConfig.coinsToCashRate,
                            status: 'pending',
                            created_at: new Date()
                        }
                    ]);
                
                if (error) throw error;
                
                // 扣除"万花币"
                gameState.coins -= withdrawableCoins;
                coinCountEl.textContent = gameState.coins;
                await saveCoins();
                
                // 更新用户表中的提现记录
                await supabase
                    .from('users')
                    .update({ 
                        last_withdraw: new Date(),
                        total_withdrawn: (await getTotalWithdrawn()) + (withdrawableCoins / gameConfig.coinsToCashRate)
                    })
                    .eq('user_id', gameState.userId);
                
                // 关闭提现模态框，显示成功消息
                withdrawModal.classList.add('hidden');
                withdrawSuccessEl.classList.remove('hidden');
                
                // 清空表单
                alipayNameEl.value = '';
                alipayAccountEl.value = '';
                
            } catch (error) {
                console.error('提现失败:', error);
                alert('提现申请提交失败，请稍后重试');
            }
        }

        // 获取用户总提现金额
        async function getTotalWithdrawn() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('total_withdrawn')
                    .eq('user_id', gameState.userId)
                    .single();
                    
                if (error || !data) return 0;
                return data.total_withdrawn || 0;
                
            } catch (error) {
                console.error('获取总提现金额失败:', error);
                return 0;
            }
        }

        // 观看广告获取游戏次数
        function watchAdForAttempt() {
            // 模拟观看广告
            alert('广告播放中...完成后将获得1次游戏机会');
            
            setTimeout(() => {
                gameState.remainingAttempts++;
                updateGameAttempts();
                noAttemptsEl.classList.add('hidden');
                
                // 保存游戏次数
                saveGameAttempts();
                
                // 自动开始游戏
                initGame();
            }, 3000);
        }

        // 分享游戏获取次数
        function shareGameForAttempt() {
            const shareText = `我在万花消消乐中获得了${gameState.score}分，快来挑战我吧！`;
            const shareUrl = window.location.href;
            
            // 检查是否支持Web Share API
            if (navigator.share) {
                navigator.share({
                    title: '万花消消乐',
                    text: shareText,
                    url: shareUrl,
                })
                .then(() => {
                    // 分享成功
                    gameState.remainingAttempts++;
                    updateGameAttempts();
                    noAttemptsEl.classList.add('hidden');
                    saveGameAttempts();
                    initGame();
                })
                .catch((error) => console.log('分享失败:', error));
            } else {
                // 不支持Web Share API，显示链接让用户复制
                prompt('复制链接分享给好友:', shareUrl);
                // 无论是否复制，都给予奖励
                gameState.remainingAttempts++;
                updateGameAttempts();
                noAttemptsEl.classList.add('hidden');
                saveGameAttempts();
                initGame();
            }
        }

        // 保存游戏次数
        async function saveGameAttempts() {
            try {
                if (gameState.userId === 'guest') {
                    // 游客用户，保存到本地存储
                    localStorage.setItem('guestAttempts', gameState.remainingAttempts);
                    return;
                }
                
                // 登录用户，保存到数据库
                const { error } = await supabase
                    .from('users')
                    .update({ daily_attempts: gameState.remainingAttempts })
                    .eq('user_id', gameState.userId);
                    
                if (error) throw error;
                
            } catch (error) {
                console.error('保存游戏次数失败:', error);
            }
        }

        // 每日签到
        async function dailyCheckin() {
            if (gameState.hasCheckedIn) return;
            
            // 签到奖励15个"万花币"
            const reward = 15;
            gameState.coins += reward;
            gameState.hasCheckedIn = true;
            coinCountEl.textContent = gameState.coins;
            
            // 更新签到按钮状态
            checkinBtn.textContent = '已签到';
            checkinBtn.disabled = true;
            checkinBtn.classList.add('bg-gray-400');
            checkinBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
            
            try {
                if (gameState.userId === 'guest') {
                    // 游客用户，保存到本地存储
                    localStorage.setItem('guestCoins', gameState.coins);
                    localStorage.setItem('hasCheckedIn', 'true');
                    return;
                }
                
                // 登录用户，保存到数据库
                const { error } = await supabase
                    .from('users')
                    .update({ 
                        kaleido_coins: gameState.coins,
                        last_checkin: new Date(),
                        checkin_streak: (await getCheckinStreak()) + 1
                    })
                    .eq('user_id', gameState.userId);
                    
                if (error) throw error;
                
                alert(`签到成功！获得${reward}个"万花币"`);
                
            } catch (error) {
                console.error('签到失败:', error);
                alert('签到失败，请稍后重试');
            }
        }

        // 获取连续签到天数
        async function getCheckinStreak() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('checkin_streak')
                    .eq('user_id', gameState.userId)
                    .single();
                    
                if (error || !data) return 0;
                return data.checkin_streak || 0;
                
            } catch (error) {
                console.error('获取连续签到天数失败:', error);
                return 0;
            }
        }

        // 获取排行榜数据
        async function fetchLeaderboard() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('username, total_score')
                    .order('total_score', { ascending: false })
                    .limit(5);
                    
                if (error) throw error;
                
                // 更新排行榜UI
                data.forEach((user, index) => {
                    document.getElementById(`rank-${index+1}`).textContent = user.username || `玩家${index+1}`;
                    document.getElementById(`rank-${index+1}-score`).textContent = user.total_score || 0;
                });
                
                // 检查当前用户是否在前5名
                checkUserInLeaderboard();
                
            } catch (error) {
                console.error('获取排行榜失败:', error);
            }
        }

        // 检查用户是否在排行榜前5名
        async function checkUserInLeaderboard() {
            try {
                if (gameState.userId === 'guest') return;
                
                // 获取用户排名
                const { data, error } = await supabase
                    .from('users')
                    .select('username, total_score, user_id')
                    .order('total_score', { ascending: false });
                    
                if (error) throw error;
                
                // 查找当前用户位置
                const userRank = data.findIndex(u => u.user_id === gameState.userId) + 1;
                
                // 如果在前5名且尚未领取奖励，显示领取按钮
                if (userRank <= 5) {
                    // 检查今天是否已领取
                    const today = new Date().toDateString();
                    const lastClaimDate = localStorage.getItem('lastRankRewardClaim');
                    
                    if (!lastClaimDate || lastClaimDate !== today) {
                        claimRankRewardBtn.classList.remove('hidden');
                        claimRankRewardBtn.dataset.rank = userRank;
                    }
                }
                
            } catch (error) {
                console.error('检查用户排名失败:', error);
            }
        }

        // 领取排名奖励
        async function claimRankReward() {
            const rank = parseInt(claimRankRewardBtn.dataset.rank);
            let rewardCoins = 0;
            
            // 根据排名设置奖励
            switch(rank) {
                case 1: rewardCoins = 5000; break; // 50元 = 5000个"万花币"
                case 2: rewardCoins = 3000; break; // 30元 = 3000个"万花币"
                case 3: rewardCoins = 2000; break; // 20元 = 2000个"万花币"
                case 4: rewardCoins = 1000; break; // 10元 = 1000个"万花币"
                case 5: rewardCoins = 500; break;  // 5元 = 500个"万花币"
            }
            
            try {
                // 增加"万花币"
                gameState.coins += rewardCoins;
                coinCountEl.textContent = gameState.coins;
                await saveCoins();
                
                // 记录领取日期
                const today = new Date().toDateString();
                localStorage.setItem('lastRankRewardClaim', today);
                
                // 隐藏领取按钮
                claimRankRewardBtn.classList.add('hidden');
                
                alert(`恭喜获得第${rank}名奖励：${rewardCoins}个"万花币"`);
                
            } catch (error) {
                console.error('领取排名奖励失败:', error);
                alert('领取奖励失败，请稍后重试');
            }
        }

        // Telegram登录
        function telegramLogin() {
            // 实际应用中应该使用Telegram登录API
            alert('将跳转到Telegram进行登录授权...');
            
            // 模拟登录成功
            setTimeout(() => {
                // 生成随机用户ID（实际应用中应从Telegram获取）
                const randomUserId = 'user_' + Math.floor(Math.random() * 1000000);
                const randomUserName = '玩家' + Math.floor(Math.random() * 10000);
                
                // 保存用户信息
                localStorage.setItem('userId', randomUserId);
                localStorage.setItem('userName', randomUserName);
                
                gameState.userId = randomUserId;
                gameState.userName = randomUserName;
                
                loginModal.classList.add('hidden');
                alert('登录成功！');
                
                // 重新加载用户数据
                loadUserData().then(() => {
                    // 初始化游戏
                    initGame();
                    // 加载排行榜
                    fetchLeaderboard();
                });
            }, 1000);
        }

        // 事件监听
        retryBtn.addEventListener('click', initGame);
        nextLevelBtn.addEventListener('click', nextLevel);
        userBtn.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
        });
        closeLoginBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });
        telegramLoginBtn.addEventListener('click', telegramLogin);
        withdrawBtn.addEventListener('click', showWithdrawModal);
        closeWithdrawBtn.addEventListener('click', () => {
            withdrawModal.classList.add('hidden');
        });
        confirmWithdrawBtn.addEventListener('click', confirmWithdraw);
        closeSuccessBtn.addEventListener('click', () => {
            withdrawSuccessEl.classList.add('hidden');
        });
        watchAdBtn.addEventListener('click', watchAdForAttempt);
        shareGameBtn.addEventListener('click', shareGameForAttempt);
        checkinBtn.addEventListener('click', dailyCheckin);
        claimRankRewardBtn.addEventListener('click', claimRankReward);
        
        // 道具按钮事件
        propBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const propType = btn.dataset.prop;
                useProp(propType);
            });
        });

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            .animate-shake {
                animation: shake 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);

        // 初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查本地存储的最大关卡
            const savedMaxLevel = localStorage.getItem('maxLevel');
            if (savedMaxLevel) {
                gameConfig.currentLevel = parseInt(savedMaxLevel);
            }
            
            // 设置关卡目标
            gameConfig.targetScore = 500 + (gameConfig.currentLevel - 1) * 100;
            
            // 加载用户数据
            loadUserData().then(() => {
                // 初始化游戏
                initGame();
                // 加载排行榜
                fetchLeaderboard();
            });
        });
    </script>
</body>
</html>
