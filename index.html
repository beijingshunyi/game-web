<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>万花楼消消乐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* 自定义样式 */
    :root {
      --primary: #FF6B6B;
      --secondary: #4ECDC4;
      --accent: #FFD166;
      --dark: #292F36;
      --light: #F7FFF7;
      --game-gradient: linear-gradient(135deg, #FF9A8B 0%, #FF6B6B 100%);
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      padding-bottom: 60px; /* 为底部栏留出空间 */
    }
    
    /* 游戏元素样式 */
    .game-tile {
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }
    
    .game-tile:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .game-tile.selected {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(255, 209, 102, 0.8);
      z-index: 10;
    }
    
    /* 方块类型样式 */
    .game-tile.flower {
      background: linear-gradient(135deg, #FF9A8B 0%, #FF6B6B 100%);
    }
    
    .game-tile.star {
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
    }
    
    .game-tile.moon {
      background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
    }
    
    .game-tile.sun {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }
    
    .game-tile.gem {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    }
    
    .game-tile.bell {
      background: linear-gradient(135deg, #c471ed 0%, #f64f59 100%);
    }
    
    /* 障碍物样式 */
    .obstacle-ice {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(173, 216, 230, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      z-index: 2;
    }
    
    .obstacle-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      background: #8B4513;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    
    .obstacle-chain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      z-index: 2;
    }
    
    .obstacle-chain::before {
      content: "";
      position: absolute;
      width: 80%;
      height: 80%;
      border: 3px solid #555;
      border-radius: 50%;
    }
    
    .obstacle-chain::after {
      content: "🔒";
      font-size: 1.5rem;
      z-index: 3;
    }
    
    /* 特效元素样式 */
    .special-line {
      position: relative;
    }
    
    .special-line::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
      border-radius: 10px;
      z-index: 1;
    }
    
    .special-bomb {
      position: relative;
    }
    
    .special-bomb::before {
      content: "💣";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      z-index: 2;
    }
    
    .special-cross {
      position: relative;
    }
    
    .special-cross::before {
      content: "✚";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: white;
      z-index: 2;
    }
    
    /* 底部导航栏 */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: none; /* 默认隐藏，登录后才显示 */
      justify-content: space-around;
      padding: 8px 0;
    }
    
    .bottom-nav.show {
      display: flex;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nav-item:hover {
      transform: translateY(-2px);
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    /* 道具样式 */
    .powerup-item {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin: 5px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .powerup-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .powerup-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    
    .powerup-name {
      font-size: 0.8rem;
      margin-bottom: 3px;
    }
    
    .powerup-cost {
      font-size: 0.7rem;
      color: var(--primary);
      font-weight: bold;
    }
    
    /* 个人中心 */
    .profile-header {
      background: var(--game-gradient);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: var(--card-shadow);
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      margin-bottom: 10px;
    }
    
    /* 动画效果 */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    
    .pulse-animation {
      animation: pulse 1.5s infinite;
    }
    
    .shake-animation {
      animation: shake 0.5s;
    }
    
    .fade-in {
      animation: fadeIn 0.5s;
    }
    
    .slide-up {
      animation: slideUp 0.5s;
    }
    
    .explode-animation {
      animation: explode 0.5s forwards;
    }
    
    /* 游戏板样式 */
    #game-board {
      display: grid;
      gap: 5px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      max-width: 90vw;
      max-height: 70vh;
      margin: 0 auto;
    }
    
    /* 消除特效 */
    .match-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    
    .particle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      pointer-events: none;
    }
    
    /* 底部版权信息 */
    .footer-info {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      text-align: center;
      padding: 10px;
      font-size: 0.7rem;
      color: #666;
      background: rgba(255, 255, 255, 0.8);
      z-index: 90;
      display: none; /* 默认隐藏，登录后才显示 */
    }
    
    .footer-info.show {
      display: block;
    }
    
    .footer-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: bold;
    }
    
    /* 响应式调整 */
    @media (min-width: 768px) {
      .game-container {
        max-width: 500px;
        margin: 0 auto;
      }
    }
    
    /* 提示框样式 */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .toast.success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .toast.info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    /* 模态框样式 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      max-width: 90%;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.8);
      transition: transform 0.3s;
    }
    
    .modal.show .modal-content {
      transform: scale(1);
    }
    
    /* 加载动画 */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 任务样式 */
    .task-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .task-progress {
      width: 100px;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .task-progress-bar {
      height: 100%;
      background: var(--primary);
    }
    
    /* 成就样式 */
    .achievement-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
    }
    
    .achievement-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.5rem;
    }
    
    /* 排行榜样式 */
    .leaderboard-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
    }
    
    .leaderboard-rank {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-weight: bold;
    }
    
    .leaderboard-rank.gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
    }
    
    .leaderboard-rank.silver {
      background: linear-gradient(135deg, #C0C0C0, #808080);
    }
    
    .leaderboard-rank.bronze {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
    }
    
    /* 道具栏样式 */
    .powerup-bar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 95;
      transition: transform 0.3s;
    }
    
    .powerup-bar.hidden {
      transform: translateY(100%);
    }
    
    /* 特效动画 */
    @keyframes lineEffect {
      0% { transform: scaleX(0); opacity: 1; }
      100% { transform: scaleX(1); opacity: 0; }
    }
    
    @keyframes bombEffect {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
    
    .line-effect {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      z-index: 50;
    }
    
    .horizontal-line {
      height: 3px;
      width: 100%;
      left: 0;
      animation: lineEffect 0.5s forwards;
    }
    
    .vertical-line {
      width: 3px;
      height: 100%;
      top: 0;
      animation: lineEffect 0.5s forwards;
    }
    
    .bomb-effect {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,100,100,0.8) 0%, rgba(255,100,100,0) 70%);
      z-index: 50;
      animation: bombEffect 0.5s forwards;
    }
    
    /* 登录页面样式 */
    .login-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .login-container::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 30s linear infinite;
    }
    
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .login-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
      z-index: 10;
      text-align: center;
    }
    
    .login-title {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    
    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .login-features {
      display: flex;
      justify-content: space-around;
      margin: 30px 0;
    }
    
    .login-feature {
      text-align: center;
    }
    
    .login-feature-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      color: white;
      font-size: 1.5rem;
    }
    
    .login-feature-text {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
  <script>
    // 配置Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B6B',
            secondary: '#4ECDC4',
            accent: '#FFD166',
            dark: '#292F36',
            light: '#F7FFF7'
          },
          fontFamily: {
            game: ['"PingFang SC"', '"Helvetica Neue"', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="bg-light min-h-screen font-game text-dark overflow-x-hidden">
  <!-- Telegram Web App初始化 -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // 全局状态管理
    const gameState = {
      user: null,
      balance: 0,
      currentLevel: 1,
      totalScore: 0,
      gamePlays: null,
      isPlaying: false,
      gameBoard: [],
      score: 0,
      moves: 0,
      targetScore: 0,
      movesAllowed: 0,
      levelData: null,
      leaderboard: [],
      tasks: [],
      achievements: [],
      powerups: {
        shuffle: 3,
        bomb: 1,
        steps: 2
      },
      boardSize: 5, // 默认5x5，20关后变为6x6
      selectedTiles: [],
      isDragging: false,
      dragStartTile: null,
      dragEndTile: null,
      specialTiles: [],
      levelType: 'score', // score, collect, obstacle, boss
      collectTarget: null,
      obstacleTarget: null,
      bossTarget: null,
      collectedItems: {},
      destroyedObstacles: 0,
      bossHits: {},
      timeLimit: null,
      timeRemaining: null,
      timerInterval: null,
      isLoggedIn: false, // 用户登录状态
      isProcessing: false, // 防止重复处理
      monthlyRewards: {
        1: 50,
        2: 40,
        3: 30,
        4: 20,
        5: 10
      }
    };
    
    // API基础URL
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
    
    // 工具函数 - 发起API请求
    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const url = `${API_BASE_URL}/${endpoint}`;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(url, options);
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || '请求失败');
        
        return result;
      } catch (error) {
        console.error('API请求错误:', error);
        showToast(error.message, 'error');
        throw error;
      }
    }
    
    // 显示提示信息
    function showToast(message, type = 'info') {
      // 移除现有提示
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // 显示提示
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 3秒后隐藏提示
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }
    
    // 页面导航
    function navigateTo(pageId) {
      // 隐藏所有页面
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
      });
      
      // 显示目标页面
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden');
      }
      
      // 更新导航栏状态
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // 设置对应导航项为激活状态
      const navMap = {
        'home-page': 'nav-home',
        'game-page': 'nav-game',
        'profile-page': 'nav-profile',
        'leaderboard-page': 'nav-leaderboard',
        'tasks-page': 'nav-tasks',
        'shop-page': 'nav-shop'
      };
      
      if (navMap[pageId]) {
        const navItem = document.getElementById(navMap[pageId]);
        if (navItem) navItem.classList.add('active');
      }
      
      // 特殊页面处理
      if (pageId === 'game-page' && !gameState.isPlaying) {
        startGame(gameState.currentLevel);
      } else if (pageId === 'leaderboard-page') {
        loadLeaderboard();
      } else if (pageId === 'profile-page') {
        loadUserProfile();
      } else if (pageId === 'tasks-page') {
        loadTasks();
      } else if (pageId === 'shop-page') {
        loadShop();
      }
    }
    
    // 初始化用户
    async function initUser() {
      try {
        // 从URL获取用户信息
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('user_id');
        
        if (!telegramId) {
          // 尝试从Telegram Web App获取用户信息
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            await apiRequest('login', 'POST', {
              queryId: tg.initDataUnsafe.query_id,
              userId: user.id,
              firstName: user.first_name,
              lastName: user.last_name || '',
              username: user.username || ''
            });
            window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            return;
          } else {
            navigateTo('login-page');
            return;
          }
        }
        
        // 加载用户数据
        const userData = await apiRequest(`user?telegram_id=${telegramId}`);
        gameState.user = userData.user;
        gameState.balance = userData.balance.万花币_balance;
        gameState.currentLevel = userData.progress.current_level;
        gameState.totalScore = userData.progress.total_score;
        gameState.gamePlays = userData.gamePlays;
        gameState.isLoggedIn = true;
        
        // 根据关卡设置棋盘大小
        gameState.boardSize = gameState.currentLevel > 20 ? 6 : 5;
        
        // 显示底部导航栏和版权信息
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) bottomNav.classList.add('show');
        
        const footerInfo = document.querySelector('.footer-info');
        if (footerInfo) footerInfo.classList.add('show');
        
        // 更新UI
        updateUserInterface();
        
        // 导航到首页
        navigateTo('home-page');
      } catch (error) {
        console.error('初始化用户失败:', error);
        showToast('登录失败，请重试', 'error');
        navigateTo('login-page');
      }
    }
    
    // 更新用户界面
    function updateUserInterface() {
      // 更新余额显示
      document.querySelectorAll('.balance-display').forEach(el => {
        el.textContent = gameState.balance;
      });
      
      // 更新当前关卡
      const levelDisplay = document.getElementById('current-level-display');
      if (levelDisplay) levelDisplay.textContent = gameState.currentLevel;
      
      // 更新总分数
      const scoreDisplay = document.getElementById('total-score-display');
      if (scoreDisplay) scoreDisplay.textContent = gameState.totalScore;
      
      // 更新游戏次数
      if (gameState.gamePlays) {
        const remainingFreePlays = 6 - gameState.gamePlays.free_plays_used;
        const playsDisplay = document.getElementById('remaining-plays');
        if (playsDisplay) playsDisplay.textContent = remainingFreePlays;
      }
      
      // 更新用户名和头像
      if (gameState.user) {
        document.querySelectorAll('.user-name').forEach(el => {
          el.textContent = gameState.user.username || gameState.user.first_name;
        });
        
        if (gameState.user.username) {
          const avatarUrl = `https://t.me/i/userpic/320/${gameState.user.username}.jpg`;
          document.querySelectorAll('.user-avatar').forEach(el => {
            el.src = avatarUrl;
          });
        }
      }
    }
    
    // 处理签到
    async function handleCheckin() {
      try {
        const result = await apiRequest('checkin', 'POST', {
          telegram_id: gameState.user.telegram_id
        });
        
        if (result.success) {
          gameState.balance = result.balance;
          showToast(`签到成功！获得${result.reward}万花币，连续签到${result.streak}天`, 'success');
          updateUserInterface();
          const checkinBtn = document.getElementById('checkin-btn');
          if (checkinBtn) {
            checkinBtn.disabled = true;
            checkinBtn.textContent = '今日已签到';
          }
        } else {
          showToast(result.message);
        }
      } catch (error) {
        console.error('签到失败:', error);
      }
    }
    
    // 检查是否可以玩游戏
    async function checkCanPlayGame() {
      try {
        const result = await apiRequest(`game-plays?telegram_id=${gameState.user.telegram_id}`);
        return result.canPlay;
      } catch (error) {
        console.error('检查游戏次数失败:', error);
        return false;
      }
    }
    
    // 记录游戏次数
    async function recordGamePlay(type) {
      try {
        const result = await apiRequest('record-play', 'POST', {
          telegram_id: gameState.user.telegram_id,
          type
        });
        
        gameState.gamePlays = result.gamePlays;
        updateUserInterface();
        return true;
      } catch (error) {
        console.error('记录游戏次数失败:', error);
        return false;
      }
    }
    
    // 增加游戏次数 (通过广告或分享)
    async function addGamePlays(type) {
      try {
        if (type === 'ad') {
          // 显示广告逻辑
          showToast('广告播放中...');
          // 模拟广告播放
          setTimeout(async () => {
            const result = await apiRequest('add-plays', 'POST', {
              telegram_id: gameState.user.telegram_id,
              type
            });
            
            if (result.success) {
              gameState.gamePlays = result.gamePlays;
              updateUserInterface();
              showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
            } else {
              showToast(result.message);
            }
          }, 3000);
        } else if (type === 'share') {
          // 分享逻辑
          const shareText = `来玩万花楼消消乐，经典消消乐强势登陆Telegram平台，游戏的同时可以赚取"万花币"，轻松积累提现！\n\n游戏链接: ${window.location.href}`;
          
          if (tg.openLink) {
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`;
            tg.openLink(shareUrl);
            
            // 分享完成后增加游戏次数
            setTimeout(async () => {
              const result = await apiRequest('add-plays', 'POST', {
                telegram_id: gameState.user.telegram_id,
                type
              });
              
              if (result.success) {
                gameState.gamePlays = result.gamePlays;
                updateUserInterface();
                showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
              } else {
                showToast(result.message);
              }
            }, 2000);
          } else {
            showToast('分享功能暂不可用', 'error');
          }
        }
      } catch (error) {
        console.error('增加游戏次数失败:', error);
      }
    }
    
    // 邀请好友
    function inviteFriends() {
      const inviteText = `来玩万花楼消消乐，经典消消乐强势登陆Telegram平台，游戏的同时可以赚取"万花币"，轻松积累提现！\n\n邀请链接: ${window.location.href}`;
      
      if (tg.openLink) {
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(inviteText)}`;
        tg.openLink(shareUrl);
        showToast('邀请链接已分享', 'success');
      } else {
        showToast('分享功能暂不可用', 'error');
      }
    }
    
    // 加载关卡数据
    async function loadLevelData(levelNumber) {
      try {
        const levelData = await apiRequest(`level?level=${levelNumber}`);
        gameState.levelData = levelData;
        
        // 根据关卡设置关卡类型
        if (levelNumber <= 10) {
          gameState.levelType = 'score';
          gameState.targetScore = levelData.target_score;
          gameState.movesAllowed = 0; // 无步数限制
          gameState.timeLimit = 180; // 3分钟
        } else if (levelNumber <= 20) {
          gameState.levelType = 'collect';
          gameState.collectTarget = 'flower';
          gameState.collectCount = 10;
          gameState.movesAllowed = 20 + Math.floor((levelNumber - 11) / 2);
          gameState.timeLimit = 0;
        } else if (levelNumber <= 40) {
          gameState.levelType = 'obstacle';
          gameState.obstacleTarget = 'chain';
          gameState.obstacleCount = 15;
          gameState.movesAllowed = 20 - Math.floor((levelNumber - 21) / 5);
          gameState.timeLimit = 0;
        } else {
          gameState.levelType = 'boss';
          gameState.bossCount = 5;
          gameState.bossHitsRequired = 3;
          gameState.movesAllowed = 15 - Math.floor((levelNumber - 41) / 10);
          gameState.timeLimit = 0;
        }
        
        return levelData;
      } catch (error) {
        console.error('加载关卡数据失败:', error);
        showToast('加载关卡失败，请重试', 'error');
        return null;
      }
    }
    
    // 初始化游戏板
    function initializeGameBoard() {
      const board = [];
      const tileTypes = ['flower', 'star', 'moon', 'sun', 'gem', 'bell'];
      const tileIcons = {
        'flower': '🌸',
        'star': '⭐',
        'moon': '🌙',
        'sun': '☀️',
        'gem': '💎',
        'bell': '🔔'
      };
      
      for (let i = 0; i < gameState.boardSize; i++) {
        const row = [];
        for (let j = 0; j < gameState.boardSize; j++) {
          // 确保不会初始形成三个相同的连线
          let type;
          do {
            type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
          } while (
            // 检查水平方向
            (j >= 2 && row[j-1] === type && row[j-2] === type) ||
            // 检查垂直方向
            (i >= 2 && board[i-1][j] === type && board[i-2][j] === type)
          );
          
          // 添加障碍物
          let hasObstacle = null;
          if (gameState.levelData.obstacles) {
            if (gameState.levelData.obstacles.type === 'ice' && Math.random() < 0.1) {
              hasObstacle = 'ice';
            } else if (gameState.levelData.obstacles.type === 'box' && Math.random() < 0.05) {
              hasObstacle = 'box';
            } else if (gameState.levelData.obstacles.type === 'chain' && Math.random() < 0.07) {
              hasObstacle = 'chain';
            } else if (gameState.levelData.obstacles.type === 'multiple' && gameState.levelData.obstacles.obstacles) {
              if (Math.random() < 0.15) {
                const obstacleType = gameState.levelData.obstacles.obstacles[Math.floor(Math.random() * gameState.levelData.obstacles.obstacles.length)];
                hasObstacle = obstacleType;
              }
            }
          }
          
          // 添加BOSS元素
          let isBoss = false;
          if (gameState.levelType === 'boss' && Math.random() < 0.05) {
            isBoss = true;
          }
          
          row.push({
            type,
            icon: tileIcons[type],
            obstacle: hasObstacle,
            x: j,
            y: i,
            matched: false,
            selected: false,
            special: null,
            isBoss: isBoss,
            bossHits: isBoss ? 0 : null
          });
        }
        board.push(row);
      }
      
      return board;
    }
    
    // 渲染游戏板
    function renderGameBoard() {
      const gameBoardElement = document.getElementById('game-board');
      if (!gameBoardElement) return;
      
      gameBoardElement.innerHTML = '';
      
      // 设置网格尺寸
      gameBoardElement.style.gridTemplateColumns = `repeat(${gameState.gameBoard[0].length}, 1fr)`;
      
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          const tileElement = document.createElement('div');
          tileElement.className = `game-tile aspect-square flex items-center justify-center tile-transition cursor-pointer ${
            tile.selected ? 'selected' : ''
          } ${tile.type}`;
          
          // 添加方块图标
          tileElement.textContent = tile.icon;
          
          // 添加特殊效果
          if (tile.special === 'line') {
            tileElement.classList.add('special-line');
          } else if (tile.special === 'bomb') {
            tileElement.classList.add('special-bomb');
          } else if (tile.special === 'cross') {
            tileElement.classList.add('special-cross');
          }
          
          // 添加障碍物
          if (tile.obstacle === 'ice') {
            tileElement.innerHTML += '<div class="obstacle-ice"><i class="fa fa-snowflake-o text-blue-800"></i></div>';
          } else if (tile.obstacle === 'box') {
            tileElement.innerHTML += '<div class="obstacle-box"><i class="fa fa-cube text-gray-400"></i></div>';
          } else if (tile.obstacle === 'chain') {
            tileElement.innerHTML += '<div class="obstacle-chain"></div>';
          }
          
          // 添加BOSS元素
          if (tile.isBoss) {
            tileElement.innerHTML += '<div class="boss-element">👹</div>';
            if (tile.bossHits > 0) {
              tileElement.innerHTML += `<div class="boss-hits">${tile.bossHits}/${gameState.bossHitsRequired}</div>`;
            }
          }
          
          // 添加触摸/鼠标事件
          tileElement.addEventListener('mousedown', (e) => handleTileMouseDown(rowIndex, colIndex));
          tileElement.addEventListener('mouseenter', (e) => handleTileMouseEnter(rowIndex, colIndex));
          tileElement.addEventListener('mouseup', (e) => handleTileMouseUp(rowIndex, colIndex));
          
          // 触摸事件
          tileElement.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleTileMouseDown(rowIndex, colIndex);
          });
          tileElement.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow && elementBelow.classList.contains('game-tile')) {
              const index = Array.from(elementBelow.parentNode.children).indexOf(elementBelow);
              const row = Math.floor(index / gameState.boardSize);
              const col = index % gameState.boardSize;
              handleTileMouseEnter(row, col);
            }
          });
          tileElement.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleTileMouseUp(rowIndex, colIndex);
          });
          
          gameBoardElement.appendChild(tileElement);
        });
      });
      
      // 更新游戏信息显示
      updateGameInfo();
    }
    
    // 更新游戏信息显示
    function updateGameInfo() {
      const gameScore = document.getElementById('game-score');
      if (gameScore) gameScore.textContent = gameState.score;
      
      const currentGameLevel = document.getElementById('current-game-level');
      if (currentGameLevel) currentGameLevel.textContent = gameState.currentLevel;
      
      // 根据关卡类型更新目标显示
      const targetElement = document.getElementById('game-target');
      if (targetElement) {
        if (gameState.levelType === 'score') {
          targetElement.innerHTML = `目标分数: ${gameState.targetScore}`;
        } else if (gameState.levelType === 'collect') {
          const collected = gameState.collectedItems[gameState.collectTarget] || 0;
          targetElement.innerHTML = `收集花朵: ${collected}/${gameState.collectCount}`;
        } else if (gameState.levelType === 'obstacle') {
          targetElement.innerHTML = `消除锁链: ${gameState.destroyedObstacles}/${gameState.obstacleCount}`;
        } else if (gameState.levelType === 'boss') {
          const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
          targetElement.innerHTML = `击败BOSS: ${bossesHit}/${gameState.bossCount}`;
        }
      }
      
      // 更新步数或时间显示
      const movesElement = document.getElementById('remaining-moves');
      if (movesElement) {
        if (gameState.movesAllowed > 0) {
          movesElement.innerHTML = `剩余步数: ${gameState.movesAllowed - gameState.moves}`;
        } else if (gameState.timeLimit > 0) {
          const minutes = Math.floor(gameState.timeRemaining / 60);
          const seconds = gameState.timeRemaining % 60;
          movesElement.innerHTML = `剩余时间: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
      }
    }
    
    // 处理方块鼠标按下
    function handleTileMouseDown(row, col) {
      if (gameState.isProcessing) return;
      
      gameState.isDragging = true;
      gameState.dragStartTile = { row, col };
      gameState.selectedTiles = [{ row, col }];
      
      // 选中当前方块
      gameState.gameBoard[row][col].selected = true;
      renderGameBoard();
    }
    
    // 处理方块鼠标进入
    function handleTileMouseEnter(row, col) {
      if (gameState.isProcessing || !gameState.isDragging || !gameState.dragStartTile) return;
      
      // 检查是否与起始方块相邻
      if (isAdjacent(gameState.dragStartTile.row, gameState.dragStartTile.col, row, col)) {
        gameState.dragEndTile = { row, col };
        
        // 交换方块
        swapTiles(gameState.dragStartTile.row, gameState.dragStartTile.col, row, col);
        
        // 检查是否有匹配
        const matches = findMatches();
        
        if (matches.length > 0) {
          // 有匹配，处理匹配
          processMatches(matches);
          gameState.moves++;
        } else {
          // 无匹配，交换回来
          setTimeout(() => {
            swapTiles(row, col, gameState.dragStartTile.row, gameState.dragStartTile.col);
            renderGameBoard();
          }, 300);
        }
        
        // 重置拖动状态
        gameState.isDragging = false;
        gameState.dragStartTile = null;
        gameState.dragEndTile = null;
        deselectAllTiles();
      }
    }
    
    // 处理方块鼠标释放
    function handleTileMouseUp(row, col) {
      gameState.isDragging = false;
      deselectAllTiles();
    }
    
    // 检查是否相邻
    function isAdjacent(row1, col1, row2, col2) {
      return (
        (Math.abs(row1 - row2) === 1 && col1 === col2) ||
        (Math.abs(col1 - col2) === 1 && row1 === row2)
      );
    }
    
    // 交换方块
    function swapTiles(row1, col1, row2, col2) {
      const temp = gameState.gameBoard[row1][col1];
      gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
      gameState.gameBoard[row2][col2] = temp;
      
      // 更新位置信息
      gameState.gameBoard[row1][col1].x = col1;
      gameState.gameBoard[row1][col1].y = row1;
      gameState.gameBoard[row2][col2].x = col2;
      gameState.gameBoard[row2][col2].y = row2;
      
      renderGameBoard();
    }
    
    // 取消所有选择
    function deselectAllTiles() {
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          tile.selected = false;
        });
      });
      renderGameBoard();
    }
    
    // 查找匹配
    function findMatches() {
      const matches = [];
      
      // 检查水平匹配
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        let j = 0;
        while (j < gameState.gameBoard[i].length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i][j+1];
          const next2 = gameState.gameBoard[i][j+2];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 0, 1);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i, col: j + k });
            }
            
            matches.push(match);
            j += matchLength;
          } else {
            j++;
          }
        }
      }
      
      // 检查垂直匹配
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        let i = 0;
        while (i < gameState.gameBoard.length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i+1][j];
          const next2 = gameState.gameBoard[i+2][j];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 1, 0);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i + k, col: j });
            }
            
            matches.push(match);
            i += matchLength;
          } else {
            i++;
          }
        }
      }
      
      return matches;
    }
    
    // 查找匹配长度
    function findMatchLength(startRow, startCol, rowDir, colDir) {
      const type = gameState.gameBoard[startRow][startCol].type;
      let length = 1;
      
      let currentRow = startRow + rowDir;
      let currentCol = startCol + colDir;
      
      while (
        currentRow < gameState.gameBoard.length &&
        currentCol < gameState.gameBoard[0].length &&
        gameState.gameBoard[currentRow][currentCol].type === type
      ) {
        length++;
        currentRow += rowDir;
        currentCol += colDir;
      }
      
      return length;
    }
    
    // 处理匹配
    function processMatches(matches) {
      if (gameState.isProcessing) return;
      
      gameState.isProcessing = true;
      
      if (matches.length === 0) {
        // 检查游戏是否结束
        checkGameEnd();
        gameState.isProcessing = false;
        return;
      }
      
      // 标记匹配的方块
      matches.forEach(match => {
        match.forEach(position => {
          const tile = gameState.gameBoard[position.row][position.col];
          tile.matched = true;
          
          // 根据匹配长度和障碍物类型计算分数
          let points = 10;
          if (match.length >= 4) points = 20;
          if (match.length >= 5) points = 50;
          
          if (tile.obstacle === 'ice') points += 5;
          if (tile.obstacle === 'box') points += 15;
          if (tile.obstacle === 'chain') points += 10;
          
          gameState.score += points;
          
          // 收集元素
          if (gameState.levelType === 'collect' && tile.type === gameState.collectTarget) {
            if (!gameState.collectedItems[tile.type]) {
              gameState.collectedItems[tile.type] = 0;
            }
            gameState.collectedItems[tile.type]++;
          }
          
          // 处理障碍物
          if (tile.obstacle) {
            if (tile.obstacle === 'ice') {
              // 冰障碍物只需要一次匹配即可消除
              tile.obstacle = null;
            } else if (tile.obstacle === 'box') {
              // 箱子障碍物需要两次匹配
              tile.obstacle = 'box_damaged';
            } else if (tile.obstacle === 'box_damaged') {
              // 受损箱子一次匹配即可消除
              tile.obstacle = null;
            } else if (tile.obstacle === 'chain') {
              // 链条障碍物需要一次匹配即可消除
              tile.obstacle = null;
              gameState.destroyedObstacles++;
            }
          }
          
          // 处理BOSS元素
          if (tile.isBoss) {
            tile.bossHits++;
            if (!gameState.bossHits[`${position.row}-${position.col}`]) {
              gameState.bossHits[`${position.row}-${position.col}`] = 0;
            }
            gameState.bossHits[`${position.row}-${position.col}`] = tile.bossHits;
          }
        });
        
        // 创建特殊元素
        if (match.length >= 4) {
          const centerTile = match[Math.floor(match.length / 2)];
          const tile = gameState.gameBoard[centerTile.row][centerTile.col];
          
          if (match.length === 4) {
            // 4连消除：直线特效
            tile.special = 'line';
            createLineEffect(centerTile.row, centerTile.col);
          } else if (match.length === 5) {
            // 5连消除：爆炸特效
            tile.special = 'bomb';
            createBombEffect(centerTile.row, centerTile.col);
          }
        }
        
        // 检查L/T型消除
        if (match.length === 3) {
          const isLShape = checkLShape(match);
          if (isLShape) {
            const centerTile = match[1]; // L/T型的中心点
            const tile = gameState.gameBoard[centerTile.row][centerTile.col];
            tile.special = 'cross';
          }
        }
      });
      
      // 重新渲染以显示匹配的方块
      renderGameBoard();
      
      // 移除匹配的方块并填充新方块
      setTimeout(() => {
        removeMatchedTiles();
        fillEmptySpaces();
        
        // 检查是否有新的匹配
        setTimeout(() => {
          gameState.isProcessing = false;
          const newMatches = findMatches();
          processMatches(newMatches);
        }, 500);
      }, 500);
    }
    
    // 创建直线特效
    function createLineEffect(row, col) {
      const gameBoard = document.getElementById('game-board');
      if (!gameBoard) return;
      
      const direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
      const effect = document.createElement('div');
      
      if (direction === 'horizontal') {
        effect.className = 'line-effect horizontal-line';
        effect.style.top = `${row * 100 / gameState.boardSize + 50 / gameState.boardSize}%`;
      } else {
        effect.className = 'line-effect vertical-line';
        effect.style.left = `${col * 100 / gameState.boardSize + 50 / gameState.boardSize}%`;
      }
      
      gameBoard.appendChild(effect);
      
      // 动画结束后移除特效
      setTimeout(() => {
        effect.remove();
      }, 500);
    }
    
    // 创建爆炸特效
    function createBombEffect(row, col) {
      const gameBoard = document.getElementById('game-board');
      if (!gameBoard) return;
      
      const effect = document.createElement('div');
      effect.className = 'bomb-effect';
      
      // 计算特效位置和大小
      const tileSize = 100 / gameState.boardSize;
      const size = tileSize * 3;
      const left = col * tileSize - tileSize;
      const top = row * tileSize - tileSize;
      
      effect.style.width = `${size}%`;
      effect.style.height = `${size}%`;
      effect.style.left = `${left}%`;
      effect.style.top = `${top}%`;
      
      gameBoard.appendChild(effect);
      
      // 动画结束后移除特效
      setTimeout(() => {
        effect.remove();
      }, 500);
    }
    
    // 检查L/T型消除
    function checkLShape(match) {
      if (match.length !== 3) return false;
      
      // 检查是否形成L或T型
      const sorted = [...match].sort((a, b) => {
        if (a.row !== b.row) return a.row - b.row;
        return a.col - b.col;
      });
      
      // 检查L型
      if (
        (sorted[0].row === sorted[1].row && sorted[1].row === sorted[2].row - 1 && sorted[0].col === sorted[1].col - 1 && sorted[1].col === sorted[2].col) ||
        (sorted[0].row === sorted[1].row && sorted[1].row === sorted[2].row - 1 && sorted[0].col === sorted[1].col + 1 && sorted[1].col === sorted[2].col) ||
        (sorted[0].col === sorted[1].col && sorted[1].col === sorted[2].col - 1 && sorted[0].row === sorted[1].row - 1 && sorted[1].row === sorted[2].row) ||
        (sorted[0].col === sorted[1].col && sorted[1].col === sorted[2].col - 1 && sorted[0].row === sorted[1].row + 1 && sorted[1].row === sorted[2].row)
      ) {
        return true;
      }
      
      return false;
    }
    
    // 移除匹配的方块
    function removeMatchedTiles() {
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j].matched) {
            // 处理特殊元素
            if (gameState.gameBoard[i][j].special) {
              // 触发特殊效果
              triggerSpecialEffect(i, j, gameState.gameBoard[i][j].special);
            }
            
            // 普通方块直接替换
            gameState.gameBoard[i][j] = null;
          }
        }
      }
    }
    
    // 触发特殊效果
    function triggerSpecialEffect(row, col, specialType) {
      if (specialType === 'line') {
        // 直线特效：消除整行或整列
        const direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
        
        if (direction === 'horizontal') {
          // 消除整行
          for (let j = 0; j < gameState.gameBoard[row].length; j++) {
            if (j !== col) {
              gameState.gameBoard[row][j].matched = true;
              gameState.score += 5;
            }
          }
        } else {
          // 消除整列
          for (let i = 0; i < gameState.gameBoard.length; i++) {
            if (i !== row) {
              gameState.gameBoard[i][col].matched = true;
              gameState.score += 5;
            }
          }
        }
      } else if (specialType === 'bomb') {
        // 爆炸特效：消除3x3范围
        for (let i = Math.max(0, row - 1); i <= Math.min(gameState.gameBoard.length - 1, row + 1); i++) {
          for (let j = Math.max(0, col - 1); j <= Math.min(gameState.gameBoard[0].length - 1, col + 1); j++) {
            if (i !== row || j !== col) {
              gameState.gameBoard[i][j].matched = true;
              gameState.score += 8;
            }
          }
        }
      } else if (specialType === 'cross') {
        // 十字特效：消除交叉两行两列
        // 消除整行
        for (let j = 0; j < gameState.gameBoard[row].length; j++) {
          if (j !== col) {
            gameState.gameBoard[row][j].matched = true;
            gameState.score += 5;
          }
        }
        
        // 消除整列
        for (let i = 0; i < gameState.gameBoard.length; i++) {
          if (i !== row) {
            gameState.gameBoard[i][col].matched = true;
            gameState.score += 5;
          }
        }
      }
    }
    
    // 创建新方块
    function createNewTile(x, y) {
      const tileTypes = ['flower', 'star', 'moon', 'sun', 'gem', 'bell'];
      const tileIcons = {
        'flower': '🌸',
        'star': '⭐',
        'moon': '🌙',
        'sun': '☀️',
        'gem': '💎',
        'bell': '🔔'
      };
      
      const type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
      
      return {
        type,
        icon: tileIcons[type],
        obstacle: null,
        x,
        y,
        matched: false,
        selected: false,
        special: null,
        isBoss: false,
        bossHits: null
      };
    }
    
    // 填充空白位置
    function fillEmptySpaces() {
      // 处理每一列
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        // 下落现有方块
        for (let i = gameState.gameBoard.length - 1; i >= 0; i--) {
          if (gameState.gameBoard[i][j] === null) {
            // 查找上方最近的非空方块
            for (let k = i - 1; k >= 0; k--) {
              if (gameState.gameBoard[k][j] !== null) {
                // 下落方块
                gameState.gameBoard[i][j] = gameState.gameBoard[k][j];
                gameState.gameBoard[k][j] = null;
                gameState.gameBoard[i][j].y = i; // 更新位置
                break;
              }
            }
          }
        }
        
        // 顶部填充新方块
        for (let i = 0; i < gameState.gameBoard.length; i++) {
          if (gameState.gameBoard[i][j] === null) {
            gameState.gameBoard[i][j] = createNewTile(j, i);
          }
        }
      }
      
      renderGameBoard();
    }
    
    // 检查游戏是否结束
    function checkGameEnd() {
      let gameEnded = false;
      
      // 检查步数是否用完
      if (gameState.movesAllowed > 0 && gameState.moves >= gameState.movesAllowed) {
        gameEnded = true;
      }
      
      // 检查时间是否用完
      if (gameState.timeLimit > 0 && gameState.timeRemaining <= 0) {
        gameEnded = true;
      }
      
      // 检查是否达成目标
      let targetAchieved = false;
      if (gameState.levelType === 'score' && gameState.score >= gameState.targetScore) {
        targetAchieved = true;
      } else if (gameState.levelType === 'collect') {
        const collected = gameState.collectedItems[gameState.collectTarget] || 0;
        if (collected >= gameState.collectCount) {
          targetAchieved = true;
        }
      } else if (gameState.levelType === 'obstacle') {
        if (gameState.destroyedObstacles >= gameState.obstacleCount) {
          targetAchieved = true;
        }
      } else if (gameState.levelType === 'boss') {
        const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
        if (bossesHit >= gameState.bossCount) {
          targetAchieved = true;
        }
      }
      
      if (gameEnded) {
        // 游戏结束
        gameState.isPlaying = false;
        
        // 清除计时器
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = null;
        }
        
        if (targetAchieved) {
          // 通关成功
          showLevelComplete();
        } else {
          // 未通关
          showLevelFailed();
        }
      } else if (!hasPossibleMoves()) {
        // 没有可能的移动，自动洗牌
        showToast('没有可消除的方块，自动洗牌', 'info');
        shuffleBoard();
      }
    }
    
    // 检查是否有可能的移动
    function hasPossibleMoves() {
      // 检查所有可能的交换
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          // 检查右侧交换
          if (j < gameState.gameBoard[i].length - 1) {
            // 临时交换
            swapTiles(i, j, i, j + 1);
            
            // 检查是否有匹配
            const matches = findMatches();
            
            // 交换回来
            swapTiles(i, j, i, j + 1);
            
            if (matches.length > 0) {
              return true;
            }
          }
          
          // 检查下方交换
          if (i < gameState.gameBoard.length - 1) {
            // 临时交换
            swapTiles(i, j, i + 1, j);
            
            // 检查是否有匹配
            const matches = findMatches();
            
            // 交换回来
            swapTiles(i, j, i + 1, j);
            
            if (matches.length > 0) {
              return true;
            }
          }
        }
      }
      
      return false;
    }
    
    // 洗牌
    function shuffleBoard() {
      // 收集所有非空方块
      const tiles = [];
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j] !== null) {
            tiles.push(gameState.gameBoard[i][j]);
          }
        }
      }
      
      // 随机打乱
      for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
      }
      
      // 重新放置方块
      let index = 0;
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j] !== null) {
            gameState.gameBoard[i][j] = tiles[index];
            gameState.gameBoard[i][j].x = j;
            gameState.gameBoard[i][j].y = i;
            index++;
          }
        }
      }
      
      renderGameBoard();
    }
    
    // 使用道具
    function usePowerup(type) {
      if (gameState.powerups[type] <= 0) {
        showToast('道具数量不足', 'error');
        return;
      }
      
      if (type === 'shuffle') {
        // 洗牌道具
        shuffleBoard();
        gameState.powerups.shuffle--;
        updatePowerupDisplay();
      } else if (type === 'bomb') {
        // 爆炸道具
        // 标记所有方块为选中状态
        gameState.gameBoard.forEach(row => {
          row.forEach(tile => {
            tile.selected = true;
          });
        });
        
        renderGameBoard();
        
        // 等待用户选择一个方块
        showToast('请选择一个方块使用爆炸道具', 'info');
        
        // 设置点击事件
        const originalClickHandler = handleTileMouseDown;
        handleTileMouseDown = (row, col) => {
          // 触发爆炸效果
          for (let i = Math.max(0, row - 1); i <= Math.min(gameState.gameBoard.length - 1, row + 1); i++) {
            for (let j = Math.max(0, col - 1); j <= Math.min(gameState.gameBoard[0].length - 1, col + 1); j++) {
              gameState.gameBoard[i][j].matched = true;
              gameState.score += 10;
            }
          }
          
          // 处理匹配
          processMatches([]);
          
          // 恢复原始点击处理
          handleTileMouseDown = originalClickHandler;
          
          // 取消所有选择
          deselectAllTiles();
          
          // 减少道具数量
          gameState.powerups.bomb--;
          updatePowerupDisplay();
        };
      } else if (type === 'steps') {
        // 步数道具
        gameState.movesAllowed += 5;
        updateGameInfo();
        gameState.powerups.steps--;
        updatePowerupDisplay();
        showToast('获得5步额外步数', 'success');
      }
    }
    
    // 更新道具显示
    function updatePowerupDisplay() {
      const shuffleCount = document.getElementById('powerup-shuffle-count');
      if (shuffleCount) shuffleCount.textContent = gameState.powerups.shuffle;
      
      const bombCount = document.getElementById('powerup-bomb-count');
      if (bombCount) bombCount.textContent = gameState.powerups.bomb;
      
      const stepsCount = document.getElementById('powerup-steps-count');
      if (stepsCount) stepsCount.textContent = gameState.powerups.steps;
    }
    
    // 显示关卡完成
    async function showLevelComplete() {
      const modal = document.getElementById('level-complete-modal');
      if (modal) modal.classList.add('show');
      
      const levelCompleteScore = document.getElementById('level-complete-score');
      if (levelCompleteScore) levelCompleteScore.textContent = gameState.score;
      
      // 计算奖励
      const baseReward = gameState.levelData.reward;
      const bonusPercentage = Math.min(100, Math.floor((gameState.score - gameState.targetScore) / gameState.targetScore * 100));
      const bonus = Math.floor(baseReward * (bonusPercentage / 100));
      const totalReward = baseReward + bonus;
      
      const levelReward = document.getElementById('level-reward');
      if (levelReward) levelReward.textContent = totalReward;
      
      // 提交关卡完成
      try {
        await apiRequest('complete-level', 'POST', {
          telegram_id: gameState.user.telegram_id,
          levelNumber: gameState.currentLevel,
          score: gameState.score
        });
        
        // 更新用户数据
        await initUser();
      } catch (error) {
        console.error('提交关卡完成失败:', error);
      }
    }
    
    // 显示关卡失败
    function showLevelFailed() {
      const modal = document.getElementById('level-failed-modal');
      if (modal) modal.classList.add('show');
      
      const failedScore = document.getElementById('failed-score');
      if (failedScore) failedScore.textContent = gameState.score;
      
      // 根据关卡类型显示目标
      const failedTarget = document.getElementById('failed-target');
      if (failedTarget) {
        if (gameState.levelType === 'score') {
          failedTarget.textContent = gameState.targetScore;
        } else if (gameState.levelType === 'collect') {
          const collected = gameState.collectedItems[gameState.collectTarget] || 0;
          failedTarget.textContent = `${collected}/${gameState.collectCount}`;
        } else if (gameState.levelType === 'obstacle') {
          failedTarget.textContent = `${gameState.destroyedObstacles}/${gameState.obstacleCount}`;
        } else if (gameState.levelType === 'boss') {
          const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
          failedTarget.textContent = `${bossesHit}/${gameState.bossCount}`;
        }
      }
    }
    
    // 开始游戏
    async function startGame(levelNumber) {
      try {
        // 检查是否可以玩游戏
        const canPlay = await checkCanPlayGame();
        if (!canPlay) {
          showToast('没有剩余游戏次数，请观看广告或分享获取更多次数', 'error');
          navigateTo('home-page');
          return;
        }
        
        // 记录游戏次数
        await recordGamePlay('free');
        
        // 加载关卡数据
        const levelData = await loadLevelData(levelNumber);
        if (!levelData) return;
        
        // 初始化游戏状态
        gameState.isPlaying = true;
        gameState.score = 0;
        gameState.moves = 0;
        gameState.gameBoard = initializeGameBoard();
        gameState.collectedItems = {};
        gameState.destroyedObstacles = 0;
        gameState.bossHits = {};
        gameState.isProcessing = false;
        
        // 设置计时器
        if (gameState.timeLimit > 0) {
          gameState.timeRemaining = gameState.timeLimit;
          gameState.timerInterval = setInterval(() => {
            gameState.timeRemaining--;
            updateGameInfo();
            
            if (gameState.timeRemaining <= 0) {
              clearInterval(gameState.timerInterval);
              gameState.timerInterval = null;
              checkGameEnd();
            }
          }, 1000);
        }
        
        // 渲染游戏
        renderGameBoard();
        
        // 显示道具栏
        const powerupBar = document.getElementById('powerup-bar');
        if (powerupBar) powerupBar.classList.remove('hidden');
        updatePowerupDisplay();
      } catch (error) {
        console.error('开始游戏失败:', error);
        showToast('无法开始游戏，请重试', 'error');
        navigateTo('home-page');
      }
    }
    
    // 加载排行榜
    async function loadLeaderboard() {
      try {
        const leaderboard = await apiRequest('leaderboard');
        gameState.leaderboard = leaderboard;
        
        const leaderboardElement = document.getElementById('leaderboard-list');
        if (!leaderboardElement) return;
        
        leaderboardElement.innerHTML = '';
        
        if (leaderboard.length === 0) {
          leaderboardElement.innerHTML = '<div class="text-center py-8 text-gray-500">暂无排行榜数据</div>';
          return;
        }
        
        leaderboard.forEach((entry, index) => {
          const entryElement = document.createElement('div');
          entryElement.className = `leaderboard-item slide-up`;
          
          let rankClass = '';
          let rankIcon = '';
          
          if (index === 0) {
            rankClass = 'gold';
            rankIcon = '<i class="fa fa-trophy text-yellow-500 text-xl"></i>';
          } else if (index === 1) {
            rankClass = 'silver';
            rankIcon = '<i class="fa fa-trophy text-gray-400 text-xl"></i>';
          } else if (index === 2) {
            rankClass = 'bronze';
            rankIcon = '<i class="fa fa-trophy text-orange-600 text-xl"></i>';
          }
          
          entryElement.innerHTML = `
            <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
            <div class="flex-1">
              <div class="font-bold">${entry.username}</div>
              <div class="text-sm text-gray-500">总分: ${entry.score}</div>
            </div>
            ${rankIcon}
          `;
          
          leaderboardElement.appendChild(entryElement);
        });
        
        // 显示奖励说明
        const leaderboardRewards = document.getElementById('leaderboard-rewards');
        if (leaderboardRewards) {
          leaderboardRewards.innerHTML = `
            <div class="bg-white rounded-xl p-5 mt-4 game-shadow">
              <h3 class="font-bold text-lg mb-3">月度奖励</h3>
              <div class="space-y-2">
                <div class="flex justify-between items-center p-2 bg-yellow-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-yellow-500 mr-2"></i>第1名</span>
                  <span class="font-bold">¥${gameState.monthlyRewards[1]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-gray-400 mr-2"></i>第2名</span>
                  <span class="font-bold">¥${gameState.monthlyRewards[2]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-orange-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-orange-600 mr-2"></i>第3名</span>
                  <span class="font-bold">¥${gameState.monthlyRewards[3]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                  <span>第4名</span>
                  <span class="font-bold">¥${gameState.monthlyRewards[4]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                  <span>第5名</span>
                  <span class="font-bold">¥${gameState.monthlyRewards[5]}</span>
                </div>
              </div>
              <div class="text-sm text-gray-500 mt-3 text-center">
                奖励将在每月最后一天以现金形式发放
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('加载排行榜失败:', error);
        showToast('无法加载排行榜，请重试', 'error');
      }
    }
    
    // 加载用户资料
    async function loadUserProfile() {
      try {
        // 更新用户信息显示
        const profileUsername = document.getElementById('profile-username');
        if (profileUsername) profileUsername.textContent = gameState.user.username || gameState.user.first_name;
        
        const profileLevel = document.getElementById('profile-level');
        if (profileLevel) profileLevel.textContent = gameState.currentLevel;
        
        const profileScore = document.getElementById('profile-score');
        if (profileScore) profileScore.textContent = gameState.totalScore;
        
        const profileBalance = document.getElementById('profile-balance');
        if (profileBalance) profileBalance.textContent = gameState.balance;
        
        // 加载用户头像
        if (gameState.user.username) {
          const avatarUrl = `https://t.me/i/userpic/320/${gameState.user.username}.jpg`;
          const profileAvatar = document.getElementById('profile-avatar');
          if (profileAvatar) profileAvatar.src = avatarUrl;
        }
        
        // 加载用户成就
        loadUserAchievements();
      } catch (error) {
        console.error('加载用户资料失败:', error);
        showToast('无法加载用户资料，请重试', 'error');
      }
    }
    
    // 加载用户成就
    async function loadUserAchievements() {
      try {
        // 模拟成就数据
        const achievements = [
          { id: 1, name: '新手玩家', description: '完成第一关', icon: 'fa-star', progress: 100, completed: true },
          { id: 2, name: '消除大师', description: '消除1000个元素', icon: 'fa-fire', progress: 65, completed: false },
          { id: 3, name: '连胜达人', description: '连续通关10关', icon: 'fa-trophy', progress: 30, completed: false },
          { id: 4, name: '社交达人', description: '邀请3个好友', icon: 'fa-users', progress: 0, completed: false },
          { id: 5, name: '万花富翁', description: '累计获得10000万花币', icon: 'fa-diamond', progress: 45, completed: false }
        ];
        
        const achievementsElement = document.getElementById('profile-achievements');
        if (!achievementsElement) return;
        
        achievementsElement.innerHTML = '';
        
        achievements.forEach(achievement => {
          const achievementElement = document.createElement('div');
          achievementElement.className = 'achievement-item slide-up';
          
          achievementElement.innerHTML = `
            <div class="achievement-icon ${achievement.completed ? 'bg-accent' : 'bg-gray-200'}">
              <i class="fa ${achievement.icon}"></i>
            </div>
            <div class="flex-1">
              <div class="font-bold">${achievement.name}</div>
              <div class="text-sm text-gray-500">${achievement.description}</div>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                <div class="bg-primary h-2 rounded-full" style="width: ${achievement.progress}%"></div>
              </div>
            </div>
          `;
          
          achievementsElement.appendChild(achievementElement);
        });
      } catch (error) {
        console.error('加载用户成就失败:', error);
      }
    }
    
    // 加载任务
    async function loadTasks() {
      try {
        // 模拟任务数据
        const tasks = [
          { id: 1, name: '每日签到', description: '每天签到获得奖励', icon: 'fa-calendar-check-o', progress: 100, completed: true, reward: 15 },
          { id: 2, name: '消除花朵', description: '消除20个花朵元素', icon: 'fa-star-o', progress: 45, completed: false, reward: 20 },
          { id: 3, name: '合成特效', description: '合成1个十字特效', icon: 'fa-magic', progress: 0, completed: false, reward: 30 },
          { id: 4, name: '分享游戏', description: '分享游戏给好友', icon: 'fa-share-alt', progress: 0, completed: false, reward: 25 },
          { id: 5, name: '观看广告', description: '观看1个广告', icon: 'fa-play-circle-o', progress: 0, completed: false, reward: 25 }
        ];
        
        const tasksElement = document.getElementById('tasks-list');
        if (!tasksElement) return;
        
        tasksElement.innerHTML = '';
        
        tasks.forEach(task => {
          const taskElement = document.createElement('div');
          taskElement.className = 'task-item slide-up';
          
          taskElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                <i class="fa ${task.icon} text-primary"></i>
              </div>
              <div>
                <div class="font-bold">${task.name}</div>
                <div class="text-sm text-gray-500">${task.description}</div>
                <div class="task-progress mt-1">
                  <div class="task-progress-bar" style="width: ${task.progress}%"></div>
                </div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-primary">${task.reward} <i class="fa fa-diamond"></i></div>
              ${task.completed ? '<div class="text-xs text-green-500">已完成</div>' : `<button class="text-xs bg-primary text-white px-2 py-1 rounded-full mt-1">领取</button>`}
            </div>
          `;
          
          tasksElement.appendChild(taskElement);
        });
      } catch (error) {
        console.error('加载任务失败:', error);
        showToast('无法加载任务，请重试', 'error');
      }
    }
    
    // 加载商店
    async function loadShop() {
      try {
        // 模拟商品数据
        const items = [
          { id: 1, name: '洗牌道具', description: '重新排列当前棋盘', icon: 'fa-random', cost: 30, count: gameState.powerups.shuffle },
          { id: 2, name: '爆炸道具', description: '消除3x3范围内的所有元素', icon: 'fa-bomb', cost: 60, count: gameState.powerups.bomb },
          { id: 3, name: '步数道具', description: '增加5步额外步数', icon: 'fa-plus', cost: 40, count: gameState.powerups.steps },
          { id: 4, name: '花朵皮肤', description: '炫彩花朵元素皮肤', icon: 'fa-paint-brush', cost: 200, owned: false },
          { id: 5, name: '夏日背景', description: '夏日海滩主题背景', icon: 'fa-image', cost: 300, owned: false },
          { id: 6, name: '新手礼包', description: '包含多种道具的礼包', icon: 'fa-gift', cost: 100, owned: false }
        ];
        
        const shopElement = document.getElementById('shop-items');
        if (!shopElement) return;
        
        shopElement.innerHTML = '';
        
        items.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'bg-white rounded-xl p-4 game-shadow mb-4 slide-up';
          
          itemElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mr-4">
                <i class="fa ${item.icon} text-primary text-2xl"></i>
              </div>
              <div class="flex-1">
                <div class="font-bold text-lg">${item.name}</div>
                <div class="text-sm text-gray-500">${item.description}</div>
                <div class="mt-2 flex items-center">
                  <span class="font-bold text-primary">${item.cost} <i class="fa fa-diamond"></i></span>
                  ${item.count !== undefined ? `<span class="ml-2 text-sm text-gray-500">拥有: ${item.count}</span>` : ''}
                  ${item.owned ? '<span class="ml-2 text-sm text-green-500">已拥有</span>' : ''}
                </div>
              </div>
              <button class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg ${item.owned ? 'opacity-50 cursor-not-allowed' : ''}" ${item.owned ? 'disabled' : ''}>
                ${item.owned ? '已拥有' : '购买'}
              </button>
            </div>
          `;
          
          shopElement.appendChild(itemElement);
        });
      } catch (error) {
        console.error('加载商店失败:', error);
        showToast('无法加载商店，请重试', 'error');
      }
    }
    
    // 提交提现请求
    async function submitWithdrawal() {
      const amount = parseInt(document.getElementById('withdrawal-amount').value);
      const alipayAccount = document.getElementById('alipay-account').value;
      const alipayName = document.getElementById('alipay-name').value;
      
      if (!amount || !alipayAccount || !alipayName) {
        showToast('请填写完整信息', 'error');
        return;
      }
      
      if (amount % 1000 !== 0) {
        showToast('提现金额必须是1000的倍数', 'error');
        return;
      }
      
      if (amount < 1000) {
        showToast('最低提现金额为1000万花币', 'error');
        return;
      }
      
      if (amount > gameState.balance) {
        showToast('余额不足', 'error');
        return;
      }
      
      try {
        const result = await apiRequest('withdrawal', 'POST', {
          telegram_id: gameState.user.telegram_id,
          amount,
          alipayAccount,
          alipayName
        });
        
        if (result.success) {
          showToast('提现请求已提交，等待处理', 'success');
          // 重置表单
          const withdrawalForm = document.getElementById('withdrawal-form');
          if (withdrawalForm) withdrawalForm.reset();
          // 刷新余额
          await initUser();
          // 返回首页
          navigateTo('home-page');
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('提交提现请求失败:', error);
        showToast('提现请求失败，请重试', 'error');
      }
    }
    
    // 加载提现历史
    async function loadWithdrawalHistory() {
      try {
        const history = await apiRequest(`withdrawal-history?telegram_id=${gameState.user.telegram_id}`);
        
        const historyElement = document.getElementById('withdrawal-history');
        if (!historyElement) return;
        
        historyElement.innerHTML = '';
        
        if (history.length === 0) {
          historyElement.innerHTML = '<div class="text-center py-8 text-gray-500">暂无提现记录</div>';
          return;
        }
        
        history.forEach(request => {
          const statusClass = 
            request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
            request.status === 'approved' ? 'bg-green-100 text-green-800' :
            'bg-red-100 text-red-800';
          
          const statusText = 
            request.status === 'pending' ? '处理中' :
            request.status === 'approved' ? '已批准' :
            '已拒绝';
          
          const date = new Date(request.created_at).toLocaleString();
          
          const requestElement = document.createElement('div');
          requestElement.className = 'bg-white rounded-lg p-4 mb-3 game-shadow slide-up';
          
          requestElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-lg">${request.amount} 万花币</span>
              <span class="px-3 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
            </div>
            <div class="text-sm text-gray-600 mb-1">支付宝: ${request.alipay_account}</div>
            <div class="text-sm text-gray-600 mb-1">姓名: ${request.alipay_name}</div>
            <div class="text-xs text-gray-500">申请时间: ${date}</div>
          `;
          
          historyElement.appendChild(requestElement);
        });
      } catch (error) {
        console.error('加载提现历史失败:', error);
        showToast('无法加载提现历史，请重试', 'error');
      }
    }
    
    // 复活游戏
    async function reviveGame() {
      // 隐藏失败模态框
      const levelFailedModal = document.getElementById('level-failed-modal');
      if (levelFailedModal) levelFailedModal.classList.remove('show');
      
      // 显示复活选项
      const reviveModal = document.getElementById('revive-modal');
      if (reviveModal) reviveModal.classList.add('show');
      
      // 绑定复活按钮事件
      const reviveAdBtn = document.getElementById('revive-ad-btn');
      if (reviveAdBtn) {
        reviveAdBtn.onclick = async () => {
          reviveModal.classList.remove('show');
          showToast('观看广告中...');
          
          // 模拟广告播放
          setTimeout(() => {
            // 增加步数或时间
            if (gameState.movesAllowed > 0) {
              gameState.movesAllowed += 5;
            } else if (gameState.timeLimit > 0) {
              gameState.timeRemaining += 60;
            }
            
            gameState.isPlaying = true;
            updateGameInfo();
            showToast('复活成功！获得5步额外步数', 'success');
          }, 3000);
        };
      }
      
      const reviveCoinsBtn = document.getElementById('revive-coins-btn');
      if (reviveCoinsBtn) {
        reviveCoinsBtn.onclick = async () => {
          if (gameState.balance < 50) {
            showToast('万花币不足', 'error');
            return;
          }
          
          reviveModal.classList.remove('show');
          
          // 扣除万花币
          gameState.balance -= 50;
          updateUserInterface();
          
          // 增加步数或时间
          if (gameState.movesAllowed > 0) {
            gameState.movesAllowed += 5;
          } else if (gameState.timeLimit > 0) {
            gameState.timeRemaining += 60;
          }
          
          gameState.isPlaying = true;
          updateGameInfo();
          showToast('复活成功！获得5步额外步数', 'success');
        };
      }
      
      const reviveCancelBtn = document.getElementById('revive-cancel-btn');
      if (reviveCancelBtn) {
        reviveCancelBtn.onclick = () => {
          reviveModal.classList.remove('show');
          // 返回首页
          navigateTo('home-page');
        };
      }
    }
    
    // 打开Telegram聊天
    function openTelegramChat() {
      window.open(`https://t.me/bjxc010`, '_blank');
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', () => {
      // 绑定登录按钮
      const telegramLoginBtn = document.getElementById('telegram-login-btn');
      if (telegramLoginBtn) {
        telegramLoginBtn.addEventListener('click', async () => {
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            try {
              await apiRequest('login', 'POST', {
                queryId: tg.initDataUnsafe.query_id,
                userId: user.id,
                firstName: user.first_name,
                lastName: user.last_name || '',
                username: user.username || ''
              });
              window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            } catch (error) {
              console.error('登录失败:', error);
              showToast('登录失败，请重试', 'error');
            }
          } else {
            showToast('无法获取Telegram用户信息', 'error');
          }
        });
      }
      
      // 绑定导航事件
      const navHome = document.getElementById('nav-home');
      if (navHome) navHome.addEventListener('click', () => navigateTo('home-page'));
      
      const navGame = document.getElementById('nav-game');
      if (navGame) navGame.addEventListener('click', () => navigateTo('game-page'));
      
      const navProfile = document.getElementById('nav-profile');
      if (navProfile) navProfile.addEventListener('click', () => navigateTo('profile-page'));
      
      const navLeaderboard = document.getElementById('nav-leaderboard');
      if (navLeaderboard) navLeaderboard.addEventListener('click', () => navigateTo('leaderboard-page'));
      
      const navTasks = document.getElementById('nav-tasks');
      if (navTasks) navTasks.addEventListener('click', () => navigateTo('tasks-page'));
      
      const navShop = document.getElementById('nav-shop');
      if (navShop) navShop.addEventListener('click', () => navigateTo('shop-page'));
      
      // 绑定签到按钮
      const checkinBtn = document.getElementById('checkin-btn');
      if (checkinBtn) checkinBtn.addEventListener('click', handleCheckin);
      
      // 绑定广告和分享按钮
      const watchAdBtn = document.getElementById('watch-ad-btn');
      if (watchAdBtn) watchAdBtn.addEventListener('click', () => addGamePlays('ad'));
      
      const shareBtn = document.getElementById('share-btn');
      if (shareBtn) shareBtn.addEventListener('click', () => addGamePlays('share'));
      
      // 绑定邀请好友按钮
      const inviteFriendsBtn = document.getElementById('invite-friends-btn');
      if (inviteFriendsBtn) inviteFriendsBtn.addEventListener('click', inviteFriends);
      
      const inviteFriendsBtn2 = document.getElementById('invite-friends-btn-2');
      if (inviteFriendsBtn2) inviteFriendsBtn2.addEventListener('click', inviteFriends);
      
      // 绑定提现按钮
      const submitWithdrawalBtn = document.getElementById('submit-withdrawal-btn');
      if (submitWithdrawalBtn) submitWithdrawalBtn.addEventListener('click', submitWithdrawal);
      
      // 绑定游戏模态框按钮
      const nextLevelBtn = document.getElementById('next-level-btn');
      if (nextLevelBtn) {
        nextLevelBtn.addEventListener('click', () => {
          const levelCompleteModal = document.getElementById('level-complete-modal');
          if (levelCompleteModal) levelCompleteModal.classList.remove('show');
          startGame(gameState.currentLevel + 1);
        });
      }
      
      const retryLevelBtn = document.getElementById('retry-level-btn');
      if (retryLevelBtn) {
        retryLevelBtn.addEventListener('click', () => {
          const levelFailedModal = document.getElementById('level-failed-modal');
          if (levelFailedModal) levelFailedModal.classList.remove('show');
          startGame(gameState.currentLevel);
        });
      }
      
      const reviveBtn = document.getElementById('revive-btn');
      if (reviveBtn) reviveBtn.addEventListener('click', reviveGame);
      
      const exitLevelBtns = document.querySelectorAll('#exit-level-btn');
      exitLevelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const levelCompleteModal = document.getElementById('level-complete-modal');
          if (levelCompleteModal) levelCompleteModal.classList.remove('show');
          
          const levelFailedModal = document.getElementById('level-failed-modal');
          if (levelFailedModal) levelFailedModal.classList.remove('show');
          
          navigateTo('home-page');
        });
      });
      
      // 绑定道具按钮
      const powerupShuffle = document.getElementById('powerup-shuffle');
      if (powerupShuffle) powerupShuffle.addEventListener('click', () => usePowerup('shuffle'));
      
      const powerupBomb = document.getElementById('powerup-bomb');
      if (powerupBomb) powerupBomb.addEventListener('click', () => usePowerup('bomb'));
      
      const powerupSteps = document.getElementById('powerup-steps');
      if (powerupSteps) powerupSteps.addEventListener('click', () => usePowerup('steps'));
      
      // 绑定返回首页按钮
      const homeBtns = document.querySelectorAll('.home-btn');
      homeBtns.forEach(btn => {
        btn.addEventListener('click', () => navigateTo('home-page'));
      });
      
      // 绑定开始游戏按钮
      const playBtn = document.getElementById('play-btn');
      if (playBtn) playBtn.addEventListener('click', () => navigateTo('game-page'));
      
      // 绑定排行榜导航按钮
      const leaderboardNavBtn = document.getElementById('leaderboard-nav-btn');
      if (leaderboardNavBtn) leaderboardNavBtn.addEventListener('click', () => navigateTo('leaderboard-page'));
      
      // 绑定提现导航按钮
      const withdrawalNavBtn = document.getElementById('withdrawal-nav-btn');
      if (withdrawalNavBtn) withdrawalNavBtn.addEventListener('click', () => navigateTo('withdrawal-page'));
      
      // 初始化用户
      initUser();
    });
  </script>
  
  <!-- 登录页面 -->
  <div id="login-page" class="page login-container">
    <div class="login-card">
      <h1 class="login-title">万花楼消消乐</h1>
      <p class="login-subtitle">经典消消乐强势登陆Telegram平台，游戏的同时可以赚取"万花币"，轻松积累提现！</p>
      
      <div class="login-features">
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-gamepad"></i>
          </div>
          <div class="login-feature-text">经典玩法</div>
        </div>
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-diamond"></i>
          </div>
          <div class="login-feature-text">赚取奖励</div>
        </div>
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-money"></i>
          </div>
          <div class="login-feature-text">轻松提现</div>
        </div>
      </div>
      
      <button id="telegram-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-10 rounded-full flex items-center text-lg pulse-animation">
        <i class="fa fa-telegram mr-3 text-2xl"></i> 用Telegram登录
      </button>
    </div>
  </div>
  
  <!-- 首页 -->
  <div id="home-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-primary">万花楼消消乐</h1>
      <div class="bg-primary/10 text-primary px-4 py-2 rounded-full flex items-center">
        <i class="fa fa-diamond mr-2"></i>
        <span class="balance-display font-bold">0</span> 万花币
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow mb-6 slide-up">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">当前进度</h2>
        <button id="checkin-btn" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-5 rounded-full text-sm">
          每日签到
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-6 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl border border-blue-200">
          <div class="text-blue-500 text-sm mb-2">当前关卡</div>
          <div class="text-3xl font-bold text-blue-700" id="current-level-display">1</div>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-xl border border-green-200">
          <div class="text-green-500 text-sm mb-2">总得分</div>
          <div class="text-3xl font-bold text-green-700" id="total-score-display">0</div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-xl border border-purple-200">
          <div class="text-purple-500 text-sm mb-2">今日剩余次数</div>
          <div class="text-3xl font-bold text-purple-700" id="remaining-plays">6</div>
        </div>
        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-5 rounded-xl border border-yellow-200">
          <div class="text-yellow-500 text-sm mb-2">兑换比例</div>
          <div class="text-2xl font-bold text-yellow-700">1000:10元</div>
        </div>
      </div>
      
      <button id="play-btn" class="w-full bg-gradient-to-r from-primary to-pink-500 hover:from-primary/90 hover:to-pink-500/90 text-white font-bold py-4 rounded-xl text-lg pulse-animation">
        开始游戏
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-6 mb-6">
      <button id="watch-ad-btn" class="bg-white p-5 rounded-2xl game-shadow flex flex-col items-center justify-center slide-up">
        <i class="fa fa-play-circle text-3xl text-blue-500 mb-3"></i>
        <span class="font-bold">观看广告</span>
        <span class="text-sm text-gray-500 mt-1">+2次游戏机会</span>
      </button>
      <button id="share-btn" class="bg-white p-5 rounded-2xl game-shadow flex flex-col items-center justify-center slide-up">
        <i class="fa fa-share-alt text-3xl text-green-500 mb-3"></i>
        <span class="font-bold">分享游戏</span>
        <span class="text-sm text-gray-500 mt-1">+2次游戏机会</span>
      </button>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <div class="grid grid-cols-2 gap-6">
        <button id="leaderboard-nav-btn" class="p-4 border border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-gray-50 transition">
          <i class="fa fa-trophy text-3xl text-yellow-500 mb-2"></i>
          <span class="font-bold">排行榜</span>
          <span class="text-sm text-gray-500 mt-1">月度奖励</span>
        </button>
        <button id="withdrawal-nav-btn" class="p-4 border border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-gray-50 transition">
          <i class="fa fa-money text-3xl text-green-600 mb-2"></i>
          <span class="font-bold">提现</span>
          <span class="text-sm text-gray-500 mt-1">兑换现金</span>
        </button>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mt-6">
      <h3 class="text-xl font-bold mb-4">邀请好友</h3>
      <button id="invite-friends-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-lg flex items-center justify-center">
        <i class="fa fa-user-plus mr-2"></i> 邀请好友获得奖励
      </button>
    </div>
  </div>
  
  <!-- 游戏页面 -->
  <div id="game-page" class="page hidden p-2">
    <div class="flex justify-between items-center mb-3">
      <button class="bg-white/80 hover:bg-white p-2 rounded-full shadow home-btn">
        <i class="fa fa-home text-gray-700"></i>
      </button>
      <div class="text-center">
        <h2 class="font-bold text-lg">关卡 <span id="current-game-level">1</span></h2>
      </div>
      <div class="bg-white/80 text-primary px-3 py-1 rounded-full text-sm flex items-center shadow">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span>
      </div>
    </div>
    
    <div class="bg-white/90 rounded-xl p-3 mb-3 game-shadow">
      <div class="grid grid-cols-2 gap-2 text-center">
        <div class="bg-light p-2 rounded-lg">
          <div class="text-sm text-gray-500">当前得分</div>
          <div class="font-bold text-lg" id="game-score">0</div>
        </div>
        <div class="bg-light p-2 rounded-lg">
          <div class="text-sm text-gray-500">目标</div>
          <div class="font-bold text-lg" id="game-target">0</div>
        </div>
        <div class="bg-light p-2 rounded-lg col-span-2">
          <div class="text-sm text-gray-500">剩余</div>
          <div class="font-bold text-lg" id="remaining-moves">0</div>
        </div>
      </div>
    </div>
    
    <div id="game-board" class="w-full aspect-square bg-light/90 rounded-xl game-shadow grid gap-1 p-2 mb-3 overflow-hidden"></div>
    
    <div class="flex justify-between">
      <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg home-btn">
        退出
      </button>
      <button class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg" onclick="startGame(gameState.currentLevel)">
        重新开始
      </button>
    </div>
    
    <!-- 道具栏 -->
    <div id="powerup-bar" class="powerup-bar hidden">
      <div class="powerup-item" onclick="usePowerup('shuffle')">
        <i class="fa fa-random powerup-icon"></i>
        <div class="powerup-name">洗牌</div>
        <div class="powerup-cost"><span id="powerup-shuffle-count">3</span> <i class="fa fa-diamond"></i></div>
      </div>
      <div class="powerup-item" onclick="usePowerup('bomb')">
        <i class="fa fa-bomb powerup-icon"></i>
        <div class="powerup-name">爆炸</div>
        <div class="powerup-cost"><span id="powerup-bomb-count">1</span> <i class="fa fa-diamond"></i></div>
      </div>
      <div class="powerup-item" onclick="usePowerup('steps')">
        <i class="fa fa-plus powerup-icon"></i>
        <div class="powerup-name">+5步</div>
        <div class="powerup-cost"><span id="powerup-steps-count">2</span> <i class="fa fa-diamond"></i></div>
      </div>
    </div>
  </div>
  
  <!-- 个人中心页面 -->
  <div id="profile-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">个人中心</h1>
      <div class="w-8"></div> <!-- 占位 -->
    </div>
    
    <div class="profile-header mb-6">
      <div class="flex flex-col items-center">
        <img id="profile-avatar" src="https://via.placeholder.com/80" alt="用户头像" class="profile-avatar">
        <h2 id="profile-username" class="text-xl font-bold mt-3">用户名</h2>
        <div class="flex mt-4 space-x-6">
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-level">1</div>
            <div class="text-sm opacity-80">关卡</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-score">0</div>
            <div class="text-sm opacity-80">总分</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-balance">0</div>
            <div class="text-sm opacity-80">万花币</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h3 class="text-xl font-bold mb-4">我的成就</h3>
      <div id="profile-achievements" class="space-y-3">
        <!-- 成就将在这里动态加载 -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h3 class="text-xl font-bold mb-4">游戏设置</h3>
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>音效</span>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>背景音乐</span>
          <label class="switch">
            <input type="checkbox">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>振动反馈</span>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider round"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 排行榜页面 -->
  <div id="leaderboard-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">全服排行榜</h1>
      <div class="w-8"></div> <!-- 占位 -->
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4 text-center">本月排名</h2>
      <div id="leaderboard-list" class="space-y-3">
        <!-- 排行榜数据将在这里动态加载 -->
      </div>
      <div id="leaderboard-rewards">
        <!-- 奖励信息将在这里动态加载 -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">好友排行榜</h2>
      <div class="text-center py-8 text-gray-500">
        <i class="fa fa-users text-4xl mb-3"></i>
        <p>暂无好友数据</p>
        <button class="mt-3 bg-primary text-white px-4 py-2 rounded-lg" id="invite-friends-btn-2">邀请好友</button>
      </div>
    </div>
  </div>
  
  <!-- 任务页面 -->
  <div id="tasks-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">每日任务</h1>
      <div class="w-8"></div> <!-- 占位 -->
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">今日任务</h2>
        <div class="text-sm text-gray-500">每日刷新</div>
      </div>
      <div id="tasks-list">
        <!-- 任务将在这里动态加载 -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">任务宝箱</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-4 text-center border border-yellow-200">
          <i class="fa fa-gift text-3xl text-yellow-500 mb-2"></i>
          <div class="font-bold">新手宝箱</div>
          <div class="text-xs text-gray-500 mt-1">完成所有新手任务</div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border border-blue-200">
          <i class="fa fa-gift text-3xl text-blue-500 mb-2"></i>
          <div class="font-bold">每日宝箱</div>
          <div class="text-xs text-gray-500 mt-1">完成所有每日任务</div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center border border-purple-200">
          <i class="fa fa-gift text-3xl text-purple-500 mb-2"></i>
          <div class="font-bold">周常宝箱</div>
          <div class="text-xs text-gray-500 mt-1">完成所有周常任务</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 商店页面 -->
  <div id="shop-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">游戏商店</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4">道具</h2>
      <div id="shop-items">
        <!-- 商品将在这里动态加载 -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">礼包</h2>
      <div class="space-y-4">
        <div class="bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl p-5 text-white">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-xl font-bold">新手礼包</h3>
              <p class="text-sm opacity-80">包含多种道具的超值礼包</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">¥6</div>
              <button class="mt-2 bg-white text-blue-500 px-3 py-1 rounded-lg text-sm font-bold">购买</button>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl p-5 text-white">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-xl font-bold">超值礼包</h3>
              <p class="text-sm opacity-80">大量道具和万花币</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">¥30</div>
              <button class="mt-2 bg-white text-yellow-500 px-3 py-1 rounded-lg text-sm font-bold">购买</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 提现页面 -->
  <div id="withdrawal-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">提现中心</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span> 万花币
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-5">申请提现</h2>
      <form id="withdrawal-form" class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2 font-medium">提现金额 (万花币)</label>
          <input 
            type="number" 
            id="withdrawal-amount" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="1000" 
            step="1000" 
            min="1000"
          >
          <p class="text-sm text-gray-500 mt-2">最低1000万花币，必须是1000的倍数</p>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2 font-medium">支付宝账号</label>
          <input 
            type="text" 
            id="alipay-account" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="请输入支付宝账号"
          >
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2 font-medium">支付宝姓名</label>
          <input 
            type="text" 
            id="alipay-name" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="请输入真实姓名"
          >
        </div>
        
        <button 
          type="button" 
          id="submit-withdrawal-btn" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-lg"
        >
          提交提现申请
        </button>
      </form>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow">
      <h2 class="text-xl font-bold mb-4">提现历史</h2>
      <div id="withdrawal-history">
        <!-- 提现历史将在这里动态加载 -->
      </div>
    </div>
  </div>
  
  <!-- 关卡完成模态框 -->
  <div id="level-complete-modal" class="modal">
    <div class="modal-content">
      <div class="text-green-500 text-6xl mb-5 text-center">
        <i class="fa fa-check-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-3 text-center">关卡完成！</h2>
      <p class="mb-5 text-center text-gray-600">恭喜你通过了关卡 <span id="completed-level">1</span></p>
      <div class="bg-green-50 p-5 rounded-xl mb-5">
        <div class="mb-2 text-center">你的得分: <span id="level-complete-score" class="font-bold text-lg">0</span></div>
        <div class="text-green-600 font-bold text-center text-lg">获得奖励: <span id="level-reward">0</span> 万花币</div>
      </div>
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-bold">
          返回首页
        </button>
        <button id="next-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg font-bold">
          下一关
        </button>
      </div>
    </div>
  </div>
  
  <!-- 关卡失败模态框 -->
  <div id="level-failed-modal" class="modal">
    <div class="modal-content">
      <div class="text-red-500 text-6xl mb-5 text-center">
        <i class="fa fa-times-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-3 text-center">挑战失败</h2>
      <p class="mb-5 text-center text-gray-600">再接再厉，争取通过关卡！</p>
      <div class="bg-red-50 p-5 rounded-xl mb-5">
        <div class="mb-2 text-center">你的得分: <span id="failed-score" class="font-bold text-lg">0</span></div>
        <div class="text-red-600 text-center font-bold text-lg">目标: <span id="failed-target" class="font-bold">0</span></div>
      </div>
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-bold">
          返回首页
        </button>
        <button id="revive-btn" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-bold">
          复活
        </button>
        <button id="retry-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg font-bold
