<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* è‡ªå®šä¹‰æ ·å¼ */
    :root {
      --primary: #FF6B6B;
      --secondary: #4ECDC4;
      --accent: #FFD166;
      --dark: #292F36;
      --light: #F7FFF7;
      --game-gradient: linear-gradient(135deg, #FF9A8B 0%, #FF6B6B 100%);
      --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      padding-bottom: 60px; /* ä¸ºåº•éƒ¨æ ç•™å‡ºç©ºé—´ */
    }
    
    /* æ¸¸æˆå…ƒç´ æ ·å¼ */
    .game-tile {
      border-radius: 10px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }
    
    .game-tile:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .game-tile.selected {
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(255, 209, 102, 0.8);
      z-index: 10;
    }
    
    /* æ–¹å—ç±»å‹æ ·å¼ */
    .game-tile.flower {
      background: linear-gradient(135deg, #FF9A8B 0%, #FF6B6B 100%);
    }
    
    .game-tile.star {
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
    }
    
    .game-tile.moon {
      background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
    }
    
    .game-tile.sun {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }
    
    .game-tile.gem {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    }
    
    .game-tile.bell {
      background: linear-gradient(135deg, #c471ed 0%, #f64f59 100%);
    }
    
    /* éšœç¢ç‰©æ ·å¼ */
    .obstacle-ice {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(173, 216, 230, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      z-index: 2;
    }
    
    .obstacle-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 70%;
      background: #8B4513;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    
    .obstacle-chain {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      z-index: 2;
    }
    
    .obstacle-chain::before {
      content: "";
      position: absolute;
      width: 80%;
      height: 80%;
      border: 3px solid #555;
      border-radius: 50%;
    }
    
    .obstacle-chain::after {
      content: "ğŸ”’";
      font-size: 1.5rem;
      z-index: 3;
    }
    
    /* ç‰¹æ•ˆå…ƒç´ æ ·å¼ */
    .special-line {
      position: relative;
    }
    
    .special-line::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
      border-radius: 10px;
      z-index: 1;
    }
    
    .special-bomb {
      position: relative;
    }
    
    .special-bomb::before {
      content: "ğŸ’£";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      z-index: 2;
    }
    
    .special-cross {
      position: relative;
    }
    
    .special-cross::before {
      content: "âœš";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: white;
      z-index: 2;
    }
    
    /* åº•éƒ¨å¯¼èˆªæ  */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: none; /* é»˜è®¤éšè—ï¼Œç™»å½•åæ‰æ˜¾ç¤º */
      justify-content: space-around;
      padding: 8px 0;
    }
    
    .bottom-nav.show {
      display: flex;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .nav-item:hover {
      transform: translateY(-2px);
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    /* é“å…·æ ·å¼ */
    .powerup-item {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin: 5px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .powerup-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .powerup-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }
    
    .powerup-name {
      font-size: 0.8rem;
      margin-bottom: 3px;
    }
    
    .powerup-cost {
      font-size: 0.7rem;
      color: var(--primary);
      font-weight: bold;
    }
    
    /* ä¸ªäººä¸­å¿ƒ */
    .profile-header {
      background: var(--game-gradient);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      box-shadow: var(--card-shadow);
    }
    
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid white;
      margin-bottom: 10px;
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes explode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    
    .pulse-animation {
      animation: pulse 1.5s infinite;
    }
    
    .shake-animation {
      animation: shake 0.5s;
    }
    
    .fade-in {
      animation: fadeIn 0.5s;
    }
    
    .slide-up {
      animation: slideUp 0.5s;
    }
    
    .explode-animation {
      animation: explode 0.5s forwards;
    }
    
    /* æ¸¸æˆæ¿æ ·å¼ */
    #game-board {
      display: grid;
      gap: 5px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      max-width: 90vw;
      max-height: 70vh;
      margin: 0 auto;
    }
    
    /* æ¶ˆé™¤ç‰¹æ•ˆ */
    .match-effect {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    
    .particle {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      pointer-events: none;
    }
    
    /* åº•éƒ¨ç‰ˆæƒä¿¡æ¯ */
    .footer-info {
      position: fixed;
      bottom: 60px;
      left: 0;
      right: 0;
      text-align: center;
      padding: 10px;
      font-size: 0.7rem;
      color: #666;
      background: rgba(255, 255, 255, 0.8);
      z-index: 90;
      display: none; /* é»˜è®¤éšè—ï¼Œç™»å½•åæ‰æ˜¾ç¤º */
    }
    
    .footer-info.show {
      display: block;
    }
    
    .footer-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: bold;
    }
    
    /* å“åº”å¼è°ƒæ•´ */
    @media (min-width: 768px) {
      .game-container {
        max-width: 500px;
        margin: 0 auto;
      }
    }
    
    /* æç¤ºæ¡†æ ·å¼ */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 30px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .toast.success {
      background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    }
    
    .toast.error {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .toast.info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      max-width: 90%;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      transform: scale(0.8);
      transition: transform 0.3s;
    }
    
    .modal.show .modal-content {
      transform: scale(1);
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ä»»åŠ¡æ ·å¼ */
    .task-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .task-progress {
      width: 100px;
      height: 8px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .task-progress-bar {
      height: 100%;
      background: var(--primary);
    }
    
    /* æˆå°±æ ·å¼ */
    .achievement-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
    }
    
    .achievement-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 1.5rem;
    }
    
    /* æ’è¡Œæ¦œæ ·å¼ */
    .leaderboard-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
    }
    
    .leaderboard-rank {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-weight: bold;
    }
    
    .leaderboard-rank.gold {
      background: linear-gradient(135deg, #FFD700, #FFA500);
    }
    
    .leaderboard-rank.silver {
      background: linear-gradient(135deg, #C0C0C0, #808080);
    }
    
    .leaderboard-rank.bronze {
      background: linear-gradient(135deg, #CD7F32, #8B4513);
    }
    
    /* é“å…·æ æ ·å¼ */
    .powerup-bar {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      display: flex;
      justify-content: space-around;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 95;
      transition: transform 0.3s;
    }
    
    .powerup-bar.hidden {
      transform: translateY(100%);
    }
    
    /* ç‰¹æ•ˆåŠ¨ç”» */
    @keyframes lineEffect {
      0% { transform: scaleX(0); opacity: 1; }
      100% { transform: scaleX(1); opacity: 0; }
    }
    
    @keyframes bombEffect {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }
    
    .line-effect {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      z-index: 50;
    }
    
    .horizontal-line {
      height: 3px;
      width: 100%;
      left: 0;
      animation: lineEffect 0.5s forwards;
    }
    
    .vertical-line {
      width: 3px;
      height: 100%;
      top: 0;
      animation: lineEffect 0.5s forwards;
    }
    
    .bomb-effect {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,100,100,0.8) 0%, rgba(255,100,100,0) 70%);
      z-index: 50;
      animation: bombEffect 0.5s forwards;
    }
    
    /* ç™»å½•é¡µé¢æ ·å¼ */
    .login-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .login-container::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: rotate 30s linear infinite;
    }
    
    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .login-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
      z-index: 10;
      text-align: center;
    }
    
    .login-title {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    
    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .login-features {
      display: flex;
      justify-content: space-around;
      margin: 30px 0;
    }
    
    .login-feature {
      text-align: center;
    }
    
    .login-feature-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      color: white;
      font-size: 1.5rem;
    }
    
    .login-feature-text {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
  <script>
    // é…ç½®Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B6B',
            secondary: '#4ECDC4',
            accent: '#FFD166',
            dark: '#292F36',
            light: '#F7FFF7'
          },
          fontFamily: {
            game: ['"PingFang SC"', '"Helvetica Neue"', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>
</head>
<body class="bg-light min-h-screen font-game text-dark overflow-x-hidden">
  <!-- Telegram Web Appåˆå§‹åŒ– -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // å…¨å±€çŠ¶æ€ç®¡ç†
    const gameState = {
      user: null,
      balance: 0,
      currentLevel: 1,
      totalScore: 0,
      gamePlays: null,
      isPlaying: false,
      gameBoard: [],
      score: 0,
      moves: 0,
      targetScore: 0,
      movesAllowed: 0,
      levelData: null,
      leaderboard: [],
      tasks: [],
      achievements: [],
      powerups: {
        shuffle: 3,
        bomb: 1,
        steps: 2
      },
      boardSize: 5, // é»˜è®¤5x5ï¼Œ20å…³åå˜ä¸º6x6
      selectedTiles: [],
      isDragging: false,
      dragStartTile: null,
      dragEndTile: null,
      specialTiles: [],
      levelType: 'score', // score, collect, obstacle, boss
      collectTarget: null,
      obstacleTarget: null,
      bossTarget: null,
      collectedItems: {},
      destroyedObstacles: 0,
      bossHits: {},
      timeLimit: null,
      timeRemaining: null,
      timerInterval: null,
      isLoggedIn: false, // ç”¨æˆ·ç™»å½•çŠ¶æ€
      isProcessing: false, // é˜²æ­¢é‡å¤å¤„ç†
      monthlyRewards: {
        1: 50,
        2: 40,
        3: 30,
        4: 20,
        5: 10
      }
    };
    
    // APIåŸºç¡€URL
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
    
    // å·¥å…·å‡½æ•° - å‘èµ·APIè¯·æ±‚
    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const url = `${API_BASE_URL}/${endpoint}`;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(url, options);
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || 'è¯·æ±‚å¤±è´¥');
        
        return result;
      } catch (error) {
        console.error('APIè¯·æ±‚é”™è¯¯:', error);
        showToast(error.message, 'error');
        throw error;
      }
    }
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showToast(message, type = 'info') {
      // ç§»é™¤ç°æœ‰æç¤º
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // æ˜¾ç¤ºæç¤º
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 3ç§’åéšè—æç¤º
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }
    
    // é¡µé¢å¯¼èˆª
    function navigateTo(pageId) {
      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
      });
      
      // æ˜¾ç¤ºç›®æ ‡é¡µé¢
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.remove('hidden');
      }
      
      // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // è®¾ç½®å¯¹åº”å¯¼èˆªé¡¹ä¸ºæ¿€æ´»çŠ¶æ€
      const navMap = {
        'home-page': 'nav-home',
        'game-page': 'nav-game',
        'profile-page': 'nav-profile',
        'leaderboard-page': 'nav-leaderboard',
        'tasks-page': 'nav-tasks',
        'shop-page': 'nav-shop'
      };
      
      if (navMap[pageId]) {
        const navItem = document.getElementById(navMap[pageId]);
        if (navItem) navItem.classList.add('active');
      }
      
      // ç‰¹æ®Šé¡µé¢å¤„ç†
      if (pageId === 'game-page' && !gameState.isPlaying) {
        startGame(gameState.currentLevel);
      } else if (pageId === 'leaderboard-page') {
        loadLeaderboard();
      } else if (pageId === 'profile-page') {
        loadUserProfile();
      } else if (pageId === 'tasks-page') {
        loadTasks();
      } else if (pageId === 'shop-page') {
        loadShop();
      }
    }
    
    // åˆå§‹åŒ–ç”¨æˆ·
    async function initUser() {
      try {
        // ä»URLè·å–ç”¨æˆ·ä¿¡æ¯
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('user_id');
        
        if (!telegramId) {
          // å°è¯•ä»Telegram Web Appè·å–ç”¨æˆ·ä¿¡æ¯
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            await apiRequest('login', 'POST', {
              queryId: tg.initDataUnsafe.query_id,
              userId: user.id,
              firstName: user.first_name,
              lastName: user.last_name || '',
              username: user.username || ''
            });
            window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            return;
          } else {
            navigateTo('login-page');
            return;
          }
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        const userData = await apiRequest(`user?telegram_id=${telegramId}`);
        gameState.user = userData.user;
        gameState.balance = userData.balance.ä¸‡èŠ±å¸_balance;
        gameState.currentLevel = userData.progress.current_level;
        gameState.totalScore = userData.progress.total_score;
        gameState.gamePlays = userData.gamePlays;
        gameState.isLoggedIn = true;
        
        // æ ¹æ®å…³å¡è®¾ç½®æ£‹ç›˜å¤§å°
        gameState.boardSize = gameState.currentLevel > 20 ? 6 : 5;
        
        // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆªæ å’Œç‰ˆæƒä¿¡æ¯
        const bottomNav = document.querySelector('.bottom-nav');
        if (bottomNav) bottomNav.classList.add('show');
        
        const footerInfo = document.querySelector('.footer-info');
        if (footerInfo) footerInfo.classList.add('show');
        
        // æ›´æ–°UI
        updateUserInterface();
        
        // å¯¼èˆªåˆ°é¦–é¡µ
        navigateTo('home-page');
      } catch (error) {
        console.error('åˆå§‹åŒ–ç”¨æˆ·å¤±è´¥:', error);
        showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        navigateTo('login-page');
      }
    }
    
    // æ›´æ–°ç”¨æˆ·ç•Œé¢
    function updateUserInterface() {
      // æ›´æ–°ä½™é¢æ˜¾ç¤º
      document.querySelectorAll('.balance-display').forEach(el => {
        el.textContent = gameState.balance;
      });
      
      // æ›´æ–°å½“å‰å…³å¡
      const levelDisplay = document.getElementById('current-level-display');
      if (levelDisplay) levelDisplay.textContent = gameState.currentLevel;
      
      // æ›´æ–°æ€»åˆ†æ•°
      const scoreDisplay = document.getElementById('total-score-display');
      if (scoreDisplay) scoreDisplay.textContent = gameState.totalScore;
      
      // æ›´æ–°æ¸¸æˆæ¬¡æ•°
      if (gameState.gamePlays) {
        const remainingFreePlays = 6 - gameState.gamePlays.free_plays_used;
        const playsDisplay = document.getElementById('remaining-plays');
        if (playsDisplay) playsDisplay.textContent = remainingFreePlays;
      }
      
      // æ›´æ–°ç”¨æˆ·åå’Œå¤´åƒ
      if (gameState.user) {
        document.querySelectorAll('.user-name').forEach(el => {
          el.textContent = gameState.user.username || gameState.user.first_name;
        });
        
        if (gameState.user.username) {
          const avatarUrl = `https://t.me/i/userpic/320/${gameState.user.username}.jpg`;
          document.querySelectorAll('.user-avatar').forEach(el => {
            el.src = avatarUrl;
          });
        }
      }
    }
    
    // å¤„ç†ç­¾åˆ°
    async function handleCheckin() {
      try {
        const result = await apiRequest('checkin', 'POST', {
          telegram_id: gameState.user.telegram_id
        });
        
        if (result.success) {
          gameState.balance = result.balance;
          showToast(`ç­¾åˆ°æˆåŠŸï¼è·å¾—${result.reward}ä¸‡èŠ±å¸ï¼Œè¿ç»­ç­¾åˆ°${result.streak}å¤©`, 'success');
          updateUserInterface();
          const checkinBtn = document.getElementById('checkin-btn');
          if (checkinBtn) {
            checkinBtn.disabled = true;
            checkinBtn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
          }
        } else {
          showToast(result.message);
        }
      } catch (error) {
        console.error('ç­¾åˆ°å¤±è´¥:', error);
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç©æ¸¸æˆ
    async function checkCanPlayGame() {
      try {
        const result = await apiRequest(`game-plays?telegram_id=${gameState.user.telegram_id}`);
        return result.canPlay;
      } catch (error) {
        console.error('æ£€æŸ¥æ¸¸æˆæ¬¡æ•°å¤±è´¥:', error);
        return false;
      }
    }
    
    // è®°å½•æ¸¸æˆæ¬¡æ•°
    async function recordGamePlay(type) {
      try {
        const result = await apiRequest('record-play', 'POST', {
          telegram_id: gameState.user.telegram_id,
          type
        });
        
        gameState.gamePlays = result.gamePlays;
        updateUserInterface();
        return true;
      } catch (error) {
        console.error('è®°å½•æ¸¸æˆæ¬¡æ•°å¤±è´¥:', error);
        return false;
      }
    }
    
    // å¢åŠ æ¸¸æˆæ¬¡æ•° (é€šè¿‡å¹¿å‘Šæˆ–åˆ†äº«)
    async function addGamePlays(type) {
      try {
        if (type === 'ad') {
          // æ˜¾ç¤ºå¹¿å‘Šé€»è¾‘
          showToast('å¹¿å‘Šæ’­æ”¾ä¸­...');
          // æ¨¡æ‹Ÿå¹¿å‘Šæ’­æ”¾
          setTimeout(async () => {
            const result = await apiRequest('add-plays', 'POST', {
              telegram_id: gameState.user.telegram_id,
              type
            });
            
            if (result.success) {
              gameState.gamePlays = result.gamePlays;
              updateUserInterface();
              showToast(`è·å¾—2æ¬¡æ¸¸æˆæœºä¼šï¼å‰©ä½™æ¬¡æ•°: ${6 - result.gamePlays.free_plays_used}`, 'success');
            } else {
              showToast(result.message);
            }
          }, 3000);
        } else if (type === 'share') {
          // åˆ†äº«é€»è¾‘
          const shareText = `æ¥ç©ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹ï¼Œç»å…¸æ¶ˆæ¶ˆä¹å¼ºåŠ¿ç™»é™†Telegramå¹³å°ï¼Œæ¸¸æˆçš„åŒæ—¶å¯ä»¥èµšå–"ä¸‡èŠ±å¸"ï¼Œè½»æ¾ç§¯ç´¯æç°ï¼\n\næ¸¸æˆé“¾æ¥: ${window.location.href}`;
          
          if (tg.openLink) {
            const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`;
            tg.openLink(shareUrl);
            
            // åˆ†äº«å®Œæˆåå¢åŠ æ¸¸æˆæ¬¡æ•°
            setTimeout(async () => {
              const result = await apiRequest('add-plays', 'POST', {
                telegram_id: gameState.user.telegram_id,
                type
              });
              
              if (result.success) {
                gameState.gamePlays = result.gamePlays;
                updateUserInterface();
                showToast(`è·å¾—2æ¬¡æ¸¸æˆæœºä¼šï¼å‰©ä½™æ¬¡æ•°: ${6 - result.gamePlays.free_plays_used}`, 'success');
              } else {
                showToast(result.message);
              }
            }, 2000);
          } else {
            showToast('åˆ†äº«åŠŸèƒ½æš‚ä¸å¯ç”¨', 'error');
          }
        }
      } catch (error) {
        console.error('å¢åŠ æ¸¸æˆæ¬¡æ•°å¤±è´¥:', error);
      }
    }
    
    // é‚€è¯·å¥½å‹
    function inviteFriends() {
      const inviteText = `æ¥ç©ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹ï¼Œç»å…¸æ¶ˆæ¶ˆä¹å¼ºåŠ¿ç™»é™†Telegramå¹³å°ï¼Œæ¸¸æˆçš„åŒæ—¶å¯ä»¥èµšå–"ä¸‡èŠ±å¸"ï¼Œè½»æ¾ç§¯ç´¯æç°ï¼\n\né‚€è¯·é“¾æ¥: ${window.location.href}`;
      
      if (tg.openLink) {
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(inviteText)}`;
        tg.openLink(shareUrl);
        showToast('é‚€è¯·é“¾æ¥å·²åˆ†äº«', 'success');
      } else {
        showToast('åˆ†äº«åŠŸèƒ½æš‚ä¸å¯ç”¨', 'error');
      }
    }
    
    // åŠ è½½å…³å¡æ•°æ®
    async function loadLevelData(levelNumber) {
      try {
        const levelData = await apiRequest(`level?level=${levelNumber}`);
        gameState.levelData = levelData;
        
        // æ ¹æ®å…³å¡è®¾ç½®å…³å¡ç±»å‹
        if (levelNumber <= 10) {
          gameState.levelType = 'score';
          gameState.targetScore = levelData.target_score;
          gameState.movesAllowed = 0; // æ— æ­¥æ•°é™åˆ¶
          gameState.timeLimit = 180; // 3åˆ†é’Ÿ
        } else if (levelNumber <= 20) {
          gameState.levelType = 'collect';
          gameState.collectTarget = 'flower';
          gameState.collectCount = 10;
          gameState.movesAllowed = 20 + Math.floor((levelNumber - 11) / 2);
          gameState.timeLimit = 0;
        } else if (levelNumber <= 40) {
          gameState.levelType = 'obstacle';
          gameState.obstacleTarget = 'chain';
          gameState.obstacleCount = 15;
          gameState.movesAllowed = 20 - Math.floor((levelNumber - 21) / 5);
          gameState.timeLimit = 0;
        } else {
          gameState.levelType = 'boss';
          gameState.bossCount = 5;
          gameState.bossHitsRequired = 3;
          gameState.movesAllowed = 15 - Math.floor((levelNumber - 41) / 10);
          gameState.timeLimit = 0;
        }
        
        return levelData;
      } catch (error) {
        console.error('åŠ è½½å…³å¡æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½å…³å¡å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        return null;
      }
    }
    
    // åˆå§‹åŒ–æ¸¸æˆæ¿
    function initializeGameBoard() {
      const board = [];
      const tileTypes = ['flower', 'star', 'moon', 'sun', 'gem', 'bell'];
      const tileIcons = {
        'flower': 'ğŸŒ¸',
        'star': 'â­',
        'moon': 'ğŸŒ™',
        'sun': 'â˜€ï¸',
        'gem': 'ğŸ’',
        'bell': 'ğŸ””'
      };
      
      for (let i = 0; i < gameState.boardSize; i++) {
        const row = [];
        for (let j = 0; j < gameState.boardSize; j++) {
          // ç¡®ä¿ä¸ä¼šåˆå§‹å½¢æˆä¸‰ä¸ªç›¸åŒçš„è¿çº¿
          let type;
          do {
            type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
          } while (
            // æ£€æŸ¥æ°´å¹³æ–¹å‘
            (j >= 2 && row[j-1] === type && row[j-2] === type) ||
            // æ£€æŸ¥å‚ç›´æ–¹å‘
            (i >= 2 && board[i-1][j] === type && board[i-2][j] === type)
          );
          
          // æ·»åŠ éšœç¢ç‰©
          let hasObstacle = null;
          if (gameState.levelData.obstacles) {
            if (gameState.levelData.obstacles.type === 'ice' && Math.random() < 0.1) {
              hasObstacle = 'ice';
            } else if (gameState.levelData.obstacles.type === 'box' && Math.random() < 0.05) {
              hasObstacle = 'box';
            } else if (gameState.levelData.obstacles.type === 'chain' && Math.random() < 0.07) {
              hasObstacle = 'chain';
            } else if (gameState.levelData.obstacles.type === 'multiple' && gameState.levelData.obstacles.obstacles) {
              if (Math.random() < 0.15) {
                const obstacleType = gameState.levelData.obstacles.obstacles[Math.floor(Math.random() * gameState.levelData.obstacles.obstacles.length)];
                hasObstacle = obstacleType;
              }
            }
          }
          
          // æ·»åŠ BOSSå…ƒç´ 
          let isBoss = false;
          if (gameState.levelType === 'boss' && Math.random() < 0.05) {
            isBoss = true;
          }
          
          row.push({
            type,
            icon: tileIcons[type],
            obstacle: hasObstacle,
            x: j,
            y: i,
            matched: false,
            selected: false,
            special: null,
            isBoss: isBoss,
            bossHits: isBoss ? 0 : null
          });
        }
        board.push(row);
      }
      
      return board;
    }
    
    // æ¸²æŸ“æ¸¸æˆæ¿
    function renderGameBoard() {
      const gameBoardElement = document.getElementById('game-board');
      if (!gameBoardElement) return;
      
      gameBoardElement.innerHTML = '';
      
      // è®¾ç½®ç½‘æ ¼å°ºå¯¸
      gameBoardElement.style.gridTemplateColumns = `repeat(${gameState.gameBoard[0].length}, 1fr)`;
      
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          const tileElement = document.createElement('div');
          tileElement.className = `game-tile aspect-square flex items-center justify-center tile-transition cursor-pointer ${
            tile.selected ? 'selected' : ''
          } ${tile.type}`;
          
          // æ·»åŠ æ–¹å—å›¾æ ‡
          tileElement.textContent = tile.icon;
          
          // æ·»åŠ ç‰¹æ®Šæ•ˆæœ
          if (tile.special === 'line') {
            tileElement.classList.add('special-line');
          } else if (tile.special === 'bomb') {
            tileElement.classList.add('special-bomb');
          } else if (tile.special === 'cross') {
            tileElement.classList.add('special-cross');
          }
          
          // æ·»åŠ éšœç¢ç‰©
          if (tile.obstacle === 'ice') {
            tileElement.innerHTML += '<div class="obstacle-ice"><i class="fa fa-snowflake-o text-blue-800"></i></div>';
          } else if (tile.obstacle === 'box') {
            tileElement.innerHTML += '<div class="obstacle-box"><i class="fa fa-cube text-gray-400"></i></div>';
          } else if (tile.obstacle === 'chain') {
            tileElement.innerHTML += '<div class="obstacle-chain"></div>';
          }
          
          // æ·»åŠ BOSSå…ƒç´ 
          if (tile.isBoss) {
            tileElement.innerHTML += '<div class="boss-element">ğŸ‘¹</div>';
            if (tile.bossHits > 0) {
              tileElement.innerHTML += `<div class="boss-hits">${tile.bossHits}/${gameState.bossHitsRequired}</div>`;
            }
          }
          
          // æ·»åŠ è§¦æ‘¸/é¼ æ ‡äº‹ä»¶
          tileElement.addEventListener('mousedown', (e) => handleTileMouseDown(rowIndex, colIndex));
          tileElement.addEventListener('mouseenter', (e) => handleTileMouseEnter(rowIndex, colIndex));
          tileElement.addEventListener('mouseup', (e) => handleTileMouseUp(rowIndex, colIndex));
          
          // è§¦æ‘¸äº‹ä»¶
          tileElement.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleTileMouseDown(rowIndex, colIndex);
          });
          tileElement.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            if (elementBelow && elementBelow.classList.contains('game-tile')) {
              const index = Array.from(elementBelow.parentNode.children).indexOf(elementBelow);
              const row = Math.floor(index / gameState.boardSize);
              const col = index % gameState.boardSize;
              handleTileMouseEnter(row, col);
            }
          });
          tileElement.addEventListener('touchend', (e) => {
            e.preventDefault();
            handleTileMouseUp(rowIndex, colIndex);
          });
          
          gameBoardElement.appendChild(tileElement);
        });
      });
      
      // æ›´æ–°æ¸¸æˆä¿¡æ¯æ˜¾ç¤º
      updateGameInfo();
    }
    
    // æ›´æ–°æ¸¸æˆä¿¡æ¯æ˜¾ç¤º
    function updateGameInfo() {
      const gameScore = document.getElementById('game-score');
      if (gameScore) gameScore.textContent = gameState.score;
      
      const currentGameLevel = document.getElementById('current-game-level');
      if (currentGameLevel) currentGameLevel.textContent = gameState.currentLevel;
      
      // æ ¹æ®å…³å¡ç±»å‹æ›´æ–°ç›®æ ‡æ˜¾ç¤º
      const targetElement = document.getElementById('game-target');
      if (targetElement) {
        if (gameState.levelType === 'score') {
          targetElement.innerHTML = `ç›®æ ‡åˆ†æ•°: ${gameState.targetScore}`;
        } else if (gameState.levelType === 'collect') {
          const collected = gameState.collectedItems[gameState.collectTarget] || 0;
          targetElement.innerHTML = `æ”¶é›†èŠ±æœµ: ${collected}/${gameState.collectCount}`;
        } else if (gameState.levelType === 'obstacle') {
          targetElement.innerHTML = `æ¶ˆé™¤é”é“¾: ${gameState.destroyedObstacles}/${gameState.obstacleCount}`;
        } else if (gameState.levelType === 'boss') {
          const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
          targetElement.innerHTML = `å‡»è´¥BOSS: ${bossesHit}/${gameState.bossCount}`;
        }
      }
      
      // æ›´æ–°æ­¥æ•°æˆ–æ—¶é—´æ˜¾ç¤º
      const movesElement = document.getElementById('remaining-moves');
      if (movesElement) {
        if (gameState.movesAllowed > 0) {
          movesElement.innerHTML = `å‰©ä½™æ­¥æ•°: ${gameState.movesAllowed - gameState.moves}`;
        } else if (gameState.timeLimit > 0) {
          const minutes = Math.floor(gameState.timeRemaining / 60);
          const seconds = gameState.timeRemaining % 60;
          movesElement.innerHTML = `å‰©ä½™æ—¶é—´: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
      }
    }
    
    // å¤„ç†æ–¹å—é¼ æ ‡æŒ‰ä¸‹
    function handleTileMouseDown(row, col) {
      if (gameState.isProcessing) return;
      
      gameState.isDragging = true;
      gameState.dragStartTile = { row, col };
      gameState.selectedTiles = [{ row, col }];
      
      // é€‰ä¸­å½“å‰æ–¹å—
      gameState.gameBoard[row][col].selected = true;
      renderGameBoard();
    }
    
    // å¤„ç†æ–¹å—é¼ æ ‡è¿›å…¥
    function handleTileMouseEnter(row, col) {
      if (gameState.isProcessing || !gameState.isDragging || !gameState.dragStartTile) return;
      
      // æ£€æŸ¥æ˜¯å¦ä¸èµ·å§‹æ–¹å—ç›¸é‚»
      if (isAdjacent(gameState.dragStartTile.row, gameState.dragStartTile.col, row, col)) {
        gameState.dragEndTile = { row, col };
        
        // äº¤æ¢æ–¹å—
        swapTiles(gameState.dragStartTile.row, gameState.dragStartTile.col, row, col);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
        const matches = findMatches();
        
        if (matches.length > 0) {
          // æœ‰åŒ¹é…ï¼Œå¤„ç†åŒ¹é…
          processMatches(matches);
          gameState.moves++;
        } else {
          // æ— åŒ¹é…ï¼Œäº¤æ¢å›æ¥
          setTimeout(() => {
            swapTiles(row, col, gameState.dragStartTile.row, gameState.dragStartTile.col);
            renderGameBoard();
          }, 300);
        }
        
        // é‡ç½®æ‹–åŠ¨çŠ¶æ€
        gameState.isDragging = false;
        gameState.dragStartTile = null;
        gameState.dragEndTile = null;
        deselectAllTiles();
      }
    }
    
    // å¤„ç†æ–¹å—é¼ æ ‡é‡Šæ”¾
    function handleTileMouseUp(row, col) {
      gameState.isDragging = false;
      deselectAllTiles();
    }
    
    // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
    function isAdjacent(row1, col1, row2, col2) {
      return (
        (Math.abs(row1 - row2) === 1 && col1 === col2) ||
        (Math.abs(col1 - col2) === 1 && row1 === row2)
      );
    }
    
    // äº¤æ¢æ–¹å—
    function swapTiles(row1, col1, row2, col2) {
      const temp = gameState.gameBoard[row1][col1];
      gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
      gameState.gameBoard[row2][col2] = temp;
      
      // æ›´æ–°ä½ç½®ä¿¡æ¯
      gameState.gameBoard[row1][col1].x = col1;
      gameState.gameBoard[row1][col1].y = row1;
      gameState.gameBoard[row2][col2].x = col2;
      gameState.gameBoard[row2][col2].y = row2;
      
      renderGameBoard();
    }
    
    // å–æ¶ˆæ‰€æœ‰é€‰æ‹©
    function deselectAllTiles() {
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          tile.selected = false;
        });
      });
      renderGameBoard();
    }
    
    // æŸ¥æ‰¾åŒ¹é…
    function findMatches() {
      const matches = [];
      
      // æ£€æŸ¥æ°´å¹³åŒ¹é…
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        let j = 0;
        while (j < gameState.gameBoard[i].length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i][j+1];
          const next2 = gameState.gameBoard[i][j+2];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 0, 1);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i, col: j + k });
            }
            
            matches.push(match);
            j += matchLength;
          } else {
            j++;
          }
        }
      }
      
      // æ£€æŸ¥å‚ç›´åŒ¹é…
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        let i = 0;
        while (i < gameState.gameBoard.length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i+1][j];
          const next2 = gameState.gameBoard[i+2][j];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 1, 0);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i + k, col: j });
            }
            
            matches.push(match);
            i += matchLength;
          } else {
            i++;
          }
        }
      }
      
      return matches;
    }
    
    // æŸ¥æ‰¾åŒ¹é…é•¿åº¦
    function findMatchLength(startRow, startCol, rowDir, colDir) {
      const type = gameState.gameBoard[startRow][startCol].type;
      let length = 1;
      
      let currentRow = startRow + rowDir;
      let currentCol = startCol + colDir;
      
      while (
        currentRow < gameState.gameBoard.length &&
        currentCol < gameState.gameBoard[0].length &&
        gameState.gameBoard[currentRow][currentCol].type === type
      ) {
        length++;
        currentRow += rowDir;
        currentCol += colDir;
      }
      
      return length;
    }
    
    // å¤„ç†åŒ¹é…
    function processMatches(matches) {
      if (gameState.isProcessing) return;
      
      gameState.isProcessing = true;
      
      if (matches.length === 0) {
        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
        checkGameEnd();
        gameState.isProcessing = false;
        return;
      }
      
      // æ ‡è®°åŒ¹é…çš„æ–¹å—
      matches.forEach(match => {
        match.forEach(position => {
          const tile = gameState.gameBoard[position.row][position.col];
          tile.matched = true;
          
          // æ ¹æ®åŒ¹é…é•¿åº¦å’Œéšœç¢ç‰©ç±»å‹è®¡ç®—åˆ†æ•°
          let points = 10;
          if (match.length >= 4) points = 20;
          if (match.length >= 5) points = 50;
          
          if (tile.obstacle === 'ice') points += 5;
          if (tile.obstacle === 'box') points += 15;
          if (tile.obstacle === 'chain') points += 10;
          
          gameState.score += points;
          
          // æ”¶é›†å…ƒç´ 
          if (gameState.levelType === 'collect' && tile.type === gameState.collectTarget) {
            if (!gameState.collectedItems[tile.type]) {
              gameState.collectedItems[tile.type] = 0;
            }
            gameState.collectedItems[tile.type]++;
          }
          
          // å¤„ç†éšœç¢ç‰©
          if (tile.obstacle) {
            if (tile.obstacle === 'ice') {
              // å†°éšœç¢ç‰©åªéœ€è¦ä¸€æ¬¡åŒ¹é…å³å¯æ¶ˆé™¤
              tile.obstacle = null;
            } else if (tile.obstacle === 'box') {
              // ç®±å­éšœç¢ç‰©éœ€è¦ä¸¤æ¬¡åŒ¹é…
              tile.obstacle = 'box_damaged';
            } else if (tile.obstacle === 'box_damaged') {
              // å—æŸç®±å­ä¸€æ¬¡åŒ¹é…å³å¯æ¶ˆé™¤
              tile.obstacle = null;
            } else if (tile.obstacle === 'chain') {
              // é“¾æ¡éšœç¢ç‰©éœ€è¦ä¸€æ¬¡åŒ¹é…å³å¯æ¶ˆé™¤
              tile.obstacle = null;
              gameState.destroyedObstacles++;
            }
          }
          
          // å¤„ç†BOSSå…ƒç´ 
          if (tile.isBoss) {
            tile.bossHits++;
            if (!gameState.bossHits[`${position.row}-${position.col}`]) {
              gameState.bossHits[`${position.row}-${position.col}`] = 0;
            }
            gameState.bossHits[`${position.row}-${position.col}`] = tile.bossHits;
          }
        });
        
        // åˆ›å»ºç‰¹æ®Šå…ƒç´ 
        if (match.length >= 4) {
          const centerTile = match[Math.floor(match.length / 2)];
          const tile = gameState.gameBoard[centerTile.row][centerTile.col];
          
          if (match.length === 4) {
            // 4è¿æ¶ˆé™¤ï¼šç›´çº¿ç‰¹æ•ˆ
            tile.special = 'line';
            createLineEffect(centerTile.row, centerTile.col);
          } else if (match.length === 5) {
            // 5è¿æ¶ˆé™¤ï¼šçˆ†ç‚¸ç‰¹æ•ˆ
            tile.special = 'bomb';
            createBombEffect(centerTile.row, centerTile.col);
          }
        }
        
        // æ£€æŸ¥L/Tå‹æ¶ˆé™¤
        if (match.length === 3) {
          const isLShape = checkLShape(match);
          if (isLShape) {
            const centerTile = match[1]; // L/Tå‹çš„ä¸­å¿ƒç‚¹
            const tile = gameState.gameBoard[centerTile.row][centerTile.col];
            tile.special = 'cross';
          }
        }
      });
      
      // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºåŒ¹é…çš„æ–¹å—
      renderGameBoard();
      
      // ç§»é™¤åŒ¹é…çš„æ–¹å—å¹¶å¡«å……æ–°æ–¹å—
      setTimeout(() => {
        removeMatchedTiles();
        fillEmptySpaces();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„åŒ¹é…
        setTimeout(() => {
          gameState.isProcessing = false;
          const newMatches = findMatches();
          processMatches(newMatches);
        }, 500);
      }, 500);
    }
    
    // åˆ›å»ºç›´çº¿ç‰¹æ•ˆ
    function createLineEffect(row, col) {
      const gameBoard = document.getElementById('game-board');
      if (!gameBoard) return;
      
      const direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
      const effect = document.createElement('div');
      
      if (direction === 'horizontal') {
        effect.className = 'line-effect horizontal-line';
        effect.style.top = `${row * 100 / gameState.boardSize + 50 / gameState.boardSize}%`;
      } else {
        effect.className = 'line-effect vertical-line';
        effect.style.left = `${col * 100 / gameState.boardSize + 50 / gameState.boardSize}%`;
      }
      
      gameBoard.appendChild(effect);
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤ç‰¹æ•ˆ
      setTimeout(() => {
        effect.remove();
      }, 500);
    }
    
    // åˆ›å»ºçˆ†ç‚¸ç‰¹æ•ˆ
    function createBombEffect(row, col) {
      const gameBoard = document.getElementById('game-board');
      if (!gameBoard) return;
      
      const effect = document.createElement('div');
      effect.className = 'bomb-effect';
      
      // è®¡ç®—ç‰¹æ•ˆä½ç½®å’Œå¤§å°
      const tileSize = 100 / gameState.boardSize;
      const size = tileSize * 3;
      const left = col * tileSize - tileSize;
      const top = row * tileSize - tileSize;
      
      effect.style.width = `${size}%`;
      effect.style.height = `${size}%`;
      effect.style.left = `${left}%`;
      effect.style.top = `${top}%`;
      
      gameBoard.appendChild(effect);
      
      // åŠ¨ç”»ç»“æŸåç§»é™¤ç‰¹æ•ˆ
      setTimeout(() => {
        effect.remove();
      }, 500);
    }
    
    // æ£€æŸ¥L/Tå‹æ¶ˆé™¤
    function checkLShape(match) {
      if (match.length !== 3) return false;
      
      // æ£€æŸ¥æ˜¯å¦å½¢æˆLæˆ–Tå‹
      const sorted = [...match].sort((a, b) => {
        if (a.row !== b.row) return a.row - b.row;
        return a.col - b.col;
      });
      
      // æ£€æŸ¥Lå‹
      if (
        (sorted[0].row === sorted[1].row && sorted[1].row === sorted[2].row - 1 && sorted[0].col === sorted[1].col - 1 && sorted[1].col === sorted[2].col) ||
        (sorted[0].row === sorted[1].row && sorted[1].row === sorted[2].row - 1 && sorted[0].col === sorted[1].col + 1 && sorted[1].col === sorted[2].col) ||
        (sorted[0].col === sorted[1].col && sorted[1].col === sorted[2].col - 1 && sorted[0].row === sorted[1].row - 1 && sorted[1].row === sorted[2].row) ||
        (sorted[0].col === sorted[1].col && sorted[1].col === sorted[2].col - 1 && sorted[0].row === sorted[1].row + 1 && sorted[1].row === sorted[2].row)
      ) {
        return true;
      }
      
      return false;
    }
    
    // ç§»é™¤åŒ¹é…çš„æ–¹å—
    function removeMatchedTiles() {
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j].matched) {
            // å¤„ç†ç‰¹æ®Šå…ƒç´ 
            if (gameState.gameBoard[i][j].special) {
              // è§¦å‘ç‰¹æ®Šæ•ˆæœ
              triggerSpecialEffect(i, j, gameState.gameBoard[i][j].special);
            }
            
            // æ™®é€šæ–¹å—ç›´æ¥æ›¿æ¢
            gameState.gameBoard[i][j] = null;
          }
        }
      }
    }
    
    // è§¦å‘ç‰¹æ®Šæ•ˆæœ
    function triggerSpecialEffect(row, col, specialType) {
      if (specialType === 'line') {
        // ç›´çº¿ç‰¹æ•ˆï¼šæ¶ˆé™¤æ•´è¡Œæˆ–æ•´åˆ—
        const direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
        
        if (direction === 'horizontal') {
          // æ¶ˆé™¤æ•´è¡Œ
          for (let j = 0; j < gameState.gameBoard[row].length; j++) {
            if (j !== col) {
              gameState.gameBoard[row][j].matched = true;
              gameState.score += 5;
            }
          }
        } else {
          // æ¶ˆé™¤æ•´åˆ—
          for (let i = 0; i < gameState.gameBoard.length; i++) {
            if (i !== row) {
              gameState.gameBoard[i][col].matched = true;
              gameState.score += 5;
            }
          }
        }
      } else if (specialType === 'bomb') {
        // çˆ†ç‚¸ç‰¹æ•ˆï¼šæ¶ˆé™¤3x3èŒƒå›´
        for (let i = Math.max(0, row - 1); i <= Math.min(gameState.gameBoard.length - 1, row + 1); i++) {
          for (let j = Math.max(0, col - 1); j <= Math.min(gameState.gameBoard[0].length - 1, col + 1); j++) {
            if (i !== row || j !== col) {
              gameState.gameBoard[i][j].matched = true;
              gameState.score += 8;
            }
          }
        }
      } else if (specialType === 'cross') {
        // åå­—ç‰¹æ•ˆï¼šæ¶ˆé™¤äº¤å‰ä¸¤è¡Œä¸¤åˆ—
        // æ¶ˆé™¤æ•´è¡Œ
        for (let j = 0; j < gameState.gameBoard[row].length; j++) {
          if (j !== col) {
            gameState.gameBoard[row][j].matched = true;
            gameState.score += 5;
          }
        }
        
        // æ¶ˆé™¤æ•´åˆ—
        for (let i = 0; i < gameState.gameBoard.length; i++) {
          if (i !== row) {
            gameState.gameBoard[i][col].matched = true;
            gameState.score += 5;
          }
        }
      }
    }
    
    // åˆ›å»ºæ–°æ–¹å—
    function createNewTile(x, y) {
      const tileTypes = ['flower', 'star', 'moon', 'sun', 'gem', 'bell'];
      const tileIcons = {
        'flower': 'ğŸŒ¸',
        'star': 'â­',
        'moon': 'ğŸŒ™',
        'sun': 'â˜€ï¸',
        'gem': 'ğŸ’',
        'bell': 'ğŸ””'
      };
      
      const type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
      
      return {
        type,
        icon: tileIcons[type],
        obstacle: null,
        x,
        y,
        matched: false,
        selected: false,
        special: null,
        isBoss: false,
        bossHits: null
      };
    }
    
    // å¡«å……ç©ºç™½ä½ç½®
    function fillEmptySpaces() {
      // å¤„ç†æ¯ä¸€åˆ—
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        // ä¸‹è½ç°æœ‰æ–¹å—
        for (let i = gameState.gameBoard.length - 1; i >= 0; i--) {
          if (gameState.gameBoard[i][j] === null) {
            // æŸ¥æ‰¾ä¸Šæ–¹æœ€è¿‘çš„éç©ºæ–¹å—
            for (let k = i - 1; k >= 0; k--) {
              if (gameState.gameBoard[k][j] !== null) {
                // ä¸‹è½æ–¹å—
                gameState.gameBoard[i][j] = gameState.gameBoard[k][j];
                gameState.gameBoard[k][j] = null;
                gameState.gameBoard[i][j].y = i; // æ›´æ–°ä½ç½®
                break;
              }
            }
          }
        }
        
        // é¡¶éƒ¨å¡«å……æ–°æ–¹å—
        for (let i = 0; i < gameState.gameBoard.length; i++) {
          if (gameState.gameBoard[i][j] === null) {
            gameState.gameBoard[i][j] = createNewTile(j, i);
          }
        }
      }
      
      renderGameBoard();
    }
    
    // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
    function checkGameEnd() {
      let gameEnded = false;
      
      // æ£€æŸ¥æ­¥æ•°æ˜¯å¦ç”¨å®Œ
      if (gameState.movesAllowed > 0 && gameState.moves >= gameState.movesAllowed) {
        gameEnded = true;
      }
      
      // æ£€æŸ¥æ—¶é—´æ˜¯å¦ç”¨å®Œ
      if (gameState.timeLimit > 0 && gameState.timeRemaining <= 0) {
        gameEnded = true;
      }
      
      // æ£€æŸ¥æ˜¯å¦è¾¾æˆç›®æ ‡
      let targetAchieved = false;
      if (gameState.levelType === 'score' && gameState.score >= gameState.targetScore) {
        targetAchieved = true;
      } else if (gameState.levelType === 'collect') {
        const collected = gameState.collectedItems[gameState.collectTarget] || 0;
        if (collected >= gameState.collectCount) {
          targetAchieved = true;
        }
      } else if (gameState.levelType === 'obstacle') {
        if (gameState.destroyedObstacles >= gameState.obstacleCount) {
          targetAchieved = true;
        }
      } else if (gameState.levelType === 'boss') {
        const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
        if (bossesHit >= gameState.bossCount) {
          targetAchieved = true;
        }
      }
      
      if (gameEnded) {
        // æ¸¸æˆç»“æŸ
        gameState.isPlaying = false;
        
        // æ¸…é™¤è®¡æ—¶å™¨
        if (gameState.timerInterval) {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = null;
        }
        
        if (targetAchieved) {
          // é€šå…³æˆåŠŸ
          showLevelComplete();
        } else {
          // æœªé€šå…³
          showLevelFailed();
        }
      } else if (!hasPossibleMoves()) {
        // æ²¡æœ‰å¯èƒ½çš„ç§»åŠ¨ï¼Œè‡ªåŠ¨æ´—ç‰Œ
        showToast('æ²¡æœ‰å¯æ¶ˆé™¤çš„æ–¹å—ï¼Œè‡ªåŠ¨æ´—ç‰Œ', 'info');
        shuffleBoard();
      }
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¯èƒ½çš„ç§»åŠ¨
    function hasPossibleMoves() {
      // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„äº¤æ¢
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          // æ£€æŸ¥å³ä¾§äº¤æ¢
          if (j < gameState.gameBoard[i].length - 1) {
            // ä¸´æ—¶äº¤æ¢
            swapTiles(i, j, i, j + 1);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
            const matches = findMatches();
            
            // äº¤æ¢å›æ¥
            swapTiles(i, j, i, j + 1);
            
            if (matches.length > 0) {
              return true;
            }
          }
          
          // æ£€æŸ¥ä¸‹æ–¹äº¤æ¢
          if (i < gameState.gameBoard.length - 1) {
            // ä¸´æ—¶äº¤æ¢
            swapTiles(i, j, i + 1, j);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
            const matches = findMatches();
            
            // äº¤æ¢å›æ¥
            swapTiles(i, j, i + 1, j);
            
            if (matches.length > 0) {
              return true;
            }
          }
        }
      }
      
      return false;
    }
    
    // æ´—ç‰Œ
    function shuffleBoard() {
      // æ”¶é›†æ‰€æœ‰éç©ºæ–¹å—
      const tiles = [];
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j] !== null) {
            tiles.push(gameState.gameBoard[i][j]);
          }
        }
      }
      
      // éšæœºæ‰“ä¹±
      for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
      }
      
      // é‡æ–°æ”¾ç½®æ–¹å—
      let index = 0;
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j] !== null) {
            gameState.gameBoard[i][j] = tiles[index];
            gameState.gameBoard[i][j].x = j;
            gameState.gameBoard[i][j].y = i;
            index++;
          }
        }
      }
      
      renderGameBoard();
    }
    
    // ä½¿ç”¨é“å…·
    function usePowerup(type) {
      if (gameState.powerups[type] <= 0) {
        showToast('é“å…·æ•°é‡ä¸è¶³', 'error');
        return;
      }
      
      if (type === 'shuffle') {
        // æ´—ç‰Œé“å…·
        shuffleBoard();
        gameState.powerups.shuffle--;
        updatePowerupDisplay();
      } else if (type === 'bomb') {
        // çˆ†ç‚¸é“å…·
        // æ ‡è®°æ‰€æœ‰æ–¹å—ä¸ºé€‰ä¸­çŠ¶æ€
        gameState.gameBoard.forEach(row => {
          row.forEach(tile => {
            tile.selected = true;
          });
        });
        
        renderGameBoard();
        
        // ç­‰å¾…ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ–¹å—
        showToast('è¯·é€‰æ‹©ä¸€ä¸ªæ–¹å—ä½¿ç”¨çˆ†ç‚¸é“å…·', 'info');
        
        // è®¾ç½®ç‚¹å‡»äº‹ä»¶
        const originalClickHandler = handleTileMouseDown;
        handleTileMouseDown = (row, col) => {
          // è§¦å‘çˆ†ç‚¸æ•ˆæœ
          for (let i = Math.max(0, row - 1); i <= Math.min(gameState.gameBoard.length - 1, row + 1); i++) {
            for (let j = Math.max(0, col - 1); j <= Math.min(gameState.gameBoard[0].length - 1, col + 1); j++) {
              gameState.gameBoard[i][j].matched = true;
              gameState.score += 10;
            }
          }
          
          // å¤„ç†åŒ¹é…
          processMatches([]);
          
          // æ¢å¤åŸå§‹ç‚¹å‡»å¤„ç†
          handleTileMouseDown = originalClickHandler;
          
          // å–æ¶ˆæ‰€æœ‰é€‰æ‹©
          deselectAllTiles();
          
          // å‡å°‘é“å…·æ•°é‡
          gameState.powerups.bomb--;
          updatePowerupDisplay();
        };
      } else if (type === 'steps') {
        // æ­¥æ•°é“å…·
        gameState.movesAllowed += 5;
        updateGameInfo();
        gameState.powerups.steps--;
        updatePowerupDisplay();
        showToast('è·å¾—5æ­¥é¢å¤–æ­¥æ•°', 'success');
      }
    }
    
    // æ›´æ–°é“å…·æ˜¾ç¤º
    function updatePowerupDisplay() {
      const shuffleCount = document.getElementById('powerup-shuffle-count');
      if (shuffleCount) shuffleCount.textContent = gameState.powerups.shuffle;
      
      const bombCount = document.getElementById('powerup-bomb-count');
      if (bombCount) bombCount.textContent = gameState.powerups.bomb;
      
      const stepsCount = document.getElementById('powerup-steps-count');
      if (stepsCount) stepsCount.textContent = gameState.powerups.steps;
    }
    
    // æ˜¾ç¤ºå…³å¡å®Œæˆ
    async function showLevelComplete() {
      const modal = document.getElementById('level-complete-modal');
      if (modal) modal.classList.add('show');
      
      const levelCompleteScore = document.getElementById('level-complete-score');
      if (levelCompleteScore) levelCompleteScore.textContent = gameState.score;
      
      // è®¡ç®—å¥–åŠ±
      const baseReward = gameState.levelData.reward;
      const bonusPercentage = Math.min(100, Math.floor((gameState.score - gameState.targetScore) / gameState.targetScore * 100));
      const bonus = Math.floor(baseReward * (bonusPercentage / 100));
      const totalReward = baseReward + bonus;
      
      const levelReward = document.getElementById('level-reward');
      if (levelReward) levelReward.textContent = totalReward;
      
      // æäº¤å…³å¡å®Œæˆ
      try {
        await apiRequest('complete-level', 'POST', {
          telegram_id: gameState.user.telegram_id,
          levelNumber: gameState.currentLevel,
          score: gameState.score
        });
        
        // æ›´æ–°ç”¨æˆ·æ•°æ®
        await initUser();
      } catch (error) {
        console.error('æäº¤å…³å¡å®Œæˆå¤±è´¥:', error);
      }
    }
    
    // æ˜¾ç¤ºå…³å¡å¤±è´¥
    function showLevelFailed() {
      const modal = document.getElementById('level-failed-modal');
      if (modal) modal.classList.add('show');
      
      const failedScore = document.getElementById('failed-score');
      if (failedScore) failedScore.textContent = gameState.score;
      
      // æ ¹æ®å…³å¡ç±»å‹æ˜¾ç¤ºç›®æ ‡
      const failedTarget = document.getElementById('failed-target');
      if (failedTarget) {
        if (gameState.levelType === 'score') {
          failedTarget.textContent = gameState.targetScore;
        } else if (gameState.levelType === 'collect') {
          const collected = gameState.collectedItems[gameState.collectTarget] || 0;
          failedTarget.textContent = `${collected}/${gameState.collectCount}`;
        } else if (gameState.levelType === 'obstacle') {
          failedTarget.textContent = `${gameState.destroyedObstacles}/${gameState.obstacleCount}`;
        } else if (gameState.levelType === 'boss') {
          const bossesHit = Object.values(gameState.bossHits).filter(hits => hits >= gameState.bossHitsRequired).length;
          failedTarget.textContent = `${bossesHit}/${gameState.bossCount}`;
        }
      }
    }
    
    // å¼€å§‹æ¸¸æˆ
    async function startGame(levelNumber) {
      try {
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç©æ¸¸æˆ
        const canPlay = await checkCanPlayGame();
        if (!canPlay) {
          showToast('æ²¡æœ‰å‰©ä½™æ¸¸æˆæ¬¡æ•°ï¼Œè¯·è§‚çœ‹å¹¿å‘Šæˆ–åˆ†äº«è·å–æ›´å¤šæ¬¡æ•°', 'error');
          navigateTo('home-page');
          return;
        }
        
        // è®°å½•æ¸¸æˆæ¬¡æ•°
        await recordGamePlay('free');
        
        // åŠ è½½å…³å¡æ•°æ®
        const levelData = await loadLevelData(levelNumber);
        if (!levelData) return;
        
        // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
        gameState.isPlaying = true;
        gameState.score = 0;
        gameState.moves = 0;
        gameState.gameBoard = initializeGameBoard();
        gameState.collectedItems = {};
        gameState.destroyedObstacles = 0;
        gameState.bossHits = {};
        gameState.isProcessing = false;
        
        // è®¾ç½®è®¡æ—¶å™¨
        if (gameState.timeLimit > 0) {
          gameState.timeRemaining = gameState.timeLimit;
          gameState.timerInterval = setInterval(() => {
            gameState.timeRemaining--;
            updateGameInfo();
            
            if (gameState.timeRemaining <= 0) {
              clearInterval(gameState.timerInterval);
              gameState.timerInterval = null;
              checkGameEnd();
            }
          }, 1000);
        }
        
        // æ¸²æŸ“æ¸¸æˆ
        renderGameBoard();
        
        // æ˜¾ç¤ºé“å…·æ 
        const powerupBar = document.getElementById('powerup-bar');
        if (powerupBar) powerupBar.classList.remove('hidden');
        updatePowerupDisplay();
      } catch (error) {
        console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
        showToast('æ— æ³•å¼€å§‹æ¸¸æˆï¼Œè¯·é‡è¯•', 'error');
        navigateTo('home-page');
      }
    }
    
    // åŠ è½½æ’è¡Œæ¦œ
    async function loadLeaderboard() {
      try {
        const leaderboard = await apiRequest('leaderboard');
        gameState.leaderboard = leaderboard;
        
        const leaderboardElement = document.getElementById('leaderboard-list');
        if (!leaderboardElement) return;
        
        leaderboardElement.innerHTML = '';
        
        if (leaderboard.length === 0) {
          leaderboardElement.innerHTML = '<div class="text-center py-8 text-gray-500">æš‚æ— æ’è¡Œæ¦œæ•°æ®</div>';
          return;
        }
        
        leaderboard.forEach((entry, index) => {
          const entryElement = document.createElement('div');
          entryElement.className = `leaderboard-item slide-up`;
          
          let rankClass = '';
          let rankIcon = '';
          
          if (index === 0) {
            rankClass = 'gold';
            rankIcon = '<i class="fa fa-trophy text-yellow-500 text-xl"></i>';
          } else if (index === 1) {
            rankClass = 'silver';
            rankIcon = '<i class="fa fa-trophy text-gray-400 text-xl"></i>';
          } else if (index === 2) {
            rankClass = 'bronze';
            rankIcon = '<i class="fa fa-trophy text-orange-600 text-xl"></i>';
          }
          
          entryElement.innerHTML = `
            <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
            <div class="flex-1">
              <div class="font-bold">${entry.username}</div>
              <div class="text-sm text-gray-500">æ€»åˆ†: ${entry.score}</div>
            </div>
            ${rankIcon}
          `;
          
          leaderboardElement.appendChild(entryElement);
        });
        
        // æ˜¾ç¤ºå¥–åŠ±è¯´æ˜
        const leaderboardRewards = document.getElementById('leaderboard-rewards');
        if (leaderboardRewards) {
          leaderboardRewards.innerHTML = `
            <div class="bg-white rounded-xl p-5 mt-4 game-shadow">
              <h3 class="font-bold text-lg mb-3">æœˆåº¦å¥–åŠ±</h3>
              <div class="space-y-2">
                <div class="flex justify-between items-center p-2 bg-yellow-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-yellow-500 mr-2"></i>ç¬¬1å</span>
                  <span class="font-bold">Â¥${gameState.monthlyRewards[1]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-gray-400 mr-2"></i>ç¬¬2å</span>
                  <span class="font-bold">Â¥${gameState.monthlyRewards[2]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-orange-50 rounded-lg">
                  <span class="flex items-center"><i class="fa fa-trophy text-orange-600 mr-2"></i>ç¬¬3å</span>
                  <span class="font-bold">Â¥${gameState.monthlyRewards[3]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                  <span>ç¬¬4å</span>
                  <span class="font-bold">Â¥${gameState.monthlyRewards[4]}</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                  <span>ç¬¬5å</span>
                  <span class="font-bold">Â¥${gameState.monthlyRewards[5]}</span>
                </div>
              </div>
              <div class="text-sm text-gray-500 mt-3 text-center">
                å¥–åŠ±å°†åœ¨æ¯æœˆæœ€åä¸€å¤©ä»¥ç°é‡‘å½¢å¼å‘æ”¾
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
        showToast('æ— æ³•åŠ è½½æ’è¡Œæ¦œï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åŠ è½½ç”¨æˆ·èµ„æ–™
    async function loadUserProfile() {
      try {
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        const profileUsername = document.getElementById('profile-username');
        if (profileUsername) profileUsername.textContent = gameState.user.username || gameState.user.first_name;
        
        const profileLevel = document.getElementById('profile-level');
        if (profileLevel) profileLevel.textContent = gameState.currentLevel;
        
        const profileScore = document.getElementById('profile-score');
        if (profileScore) profileScore.textContent = gameState.totalScore;
        
        const profileBalance = document.getElementById('profile-balance');
        if (profileBalance) profileBalance.textContent = gameState.balance;
        
        // åŠ è½½ç”¨æˆ·å¤´åƒ
        if (gameState.user.username) {
          const avatarUrl = `https://t.me/i/userpic/320/${gameState.user.username}.jpg`;
          const profileAvatar = document.getElementById('profile-avatar');
          if (profileAvatar) profileAvatar.src = avatarUrl;
        }
        
        // åŠ è½½ç”¨æˆ·æˆå°±
        loadUserAchievements();
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
        showToast('æ— æ³•åŠ è½½ç”¨æˆ·èµ„æ–™ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åŠ è½½ç”¨æˆ·æˆå°±
    async function loadUserAchievements() {
      try {
        // æ¨¡æ‹Ÿæˆå°±æ•°æ®
        const achievements = [
          { id: 1, name: 'æ–°æ‰‹ç©å®¶', description: 'å®Œæˆç¬¬ä¸€å…³', icon: 'fa-star', progress: 100, completed: true },
          { id: 2, name: 'æ¶ˆé™¤å¤§å¸ˆ', description: 'æ¶ˆé™¤1000ä¸ªå…ƒç´ ', icon: 'fa-fire', progress: 65, completed: false },
          { id: 3, name: 'è¿èƒœè¾¾äºº', description: 'è¿ç»­é€šå…³10å…³', icon: 'fa-trophy', progress: 30, completed: false },
          { id: 4, name: 'ç¤¾äº¤è¾¾äºº', description: 'é‚€è¯·3ä¸ªå¥½å‹', icon: 'fa-users', progress: 0, completed: false },
          { id: 5, name: 'ä¸‡èŠ±å¯Œç¿', description: 'ç´¯è®¡è·å¾—10000ä¸‡èŠ±å¸', icon: 'fa-diamond', progress: 45, completed: false }
        ];
        
        const achievementsElement = document.getElementById('profile-achievements');
        if (!achievementsElement) return;
        
        achievementsElement.innerHTML = '';
        
        achievements.forEach(achievement => {
          const achievementElement = document.createElement('div');
          achievementElement.className = 'achievement-item slide-up';
          
          achievementElement.innerHTML = `
            <div class="achievement-icon ${achievement.completed ? 'bg-accent' : 'bg-gray-200'}">
              <i class="fa ${achievement.icon}"></i>
            </div>
            <div class="flex-1">
              <div class="font-bold">${achievement.name}</div>
              <div class="text-sm text-gray-500">${achievement.description}</div>
              <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                <div class="bg-primary h-2 rounded-full" style="width: ${achievement.progress}%"></div>
              </div>
            </div>
          `;
          
          achievementsElement.appendChild(achievementElement);
        });
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·æˆå°±å¤±è´¥:', error);
      }
    }
    
    // åŠ è½½ä»»åŠ¡
    async function loadTasks() {
      try {
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const tasks = [
          { id: 1, name: 'æ¯æ—¥ç­¾åˆ°', description: 'æ¯å¤©ç­¾åˆ°è·å¾—å¥–åŠ±', icon: 'fa-calendar-check-o', progress: 100, completed: true, reward: 15 },
          { id: 2, name: 'æ¶ˆé™¤èŠ±æœµ', description: 'æ¶ˆé™¤20ä¸ªèŠ±æœµå…ƒç´ ', icon: 'fa-star-o', progress: 45, completed: false, reward: 20 },
          { id: 3, name: 'åˆæˆç‰¹æ•ˆ', description: 'åˆæˆ1ä¸ªåå­—ç‰¹æ•ˆ', icon: 'fa-magic', progress: 0, completed: false, reward: 30 },
          { id: 4, name: 'åˆ†äº«æ¸¸æˆ', description: 'åˆ†äº«æ¸¸æˆç»™å¥½å‹', icon: 'fa-share-alt', progress: 0, completed: false, reward: 25 },
          { id: 5, name: 'è§‚çœ‹å¹¿å‘Š', description: 'è§‚çœ‹1ä¸ªå¹¿å‘Š', icon: 'fa-play-circle-o', progress: 0, completed: false, reward: 25 }
        ];
        
        const tasksElement = document.getElementById('tasks-list');
        if (!tasksElement) return;
        
        tasksElement.innerHTML = '';
        
        tasks.forEach(task => {
          const taskElement = document.createElement('div');
          taskElement.className = 'task-item slide-up';
          
          taskElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mr-3">
                <i class="fa ${task.icon} text-primary"></i>
              </div>
              <div>
                <div class="font-bold">${task.name}</div>
                <div class="text-sm text-gray-500">${task.description}</div>
                <div class="task-progress mt-1">
                  <div class="task-progress-bar" style="width: ${task.progress}%"></div>
                </div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-primary">${task.reward} <i class="fa fa-diamond"></i></div>
              ${task.completed ? '<div class="text-xs text-green-500">å·²å®Œæˆ</div>' : `<button class="text-xs bg-primary text-white px-2 py-1 rounded-full mt-1">é¢†å–</button>`}
            </div>
          `;
          
          tasksElement.appendChild(taskElement);
        });
      } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
        showToast('æ— æ³•åŠ è½½ä»»åŠ¡ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åŠ è½½å•†åº—
    async function loadShop() {
      try {
        // æ¨¡æ‹Ÿå•†å“æ•°æ®
        const items = [
          { id: 1, name: 'æ´—ç‰Œé“å…·', description: 'é‡æ–°æ’åˆ—å½“å‰æ£‹ç›˜', icon: 'fa-random', cost: 30, count: gameState.powerups.shuffle },
          { id: 2, name: 'çˆ†ç‚¸é“å…·', description: 'æ¶ˆé™¤3x3èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ', icon: 'fa-bomb', cost: 60, count: gameState.powerups.bomb },
          { id: 3, name: 'æ­¥æ•°é“å…·', description: 'å¢åŠ 5æ­¥é¢å¤–æ­¥æ•°', icon: 'fa-plus', cost: 40, count: gameState.powerups.steps },
          { id: 4, name: 'èŠ±æœµçš®è‚¤', description: 'ç‚«å½©èŠ±æœµå…ƒç´ çš®è‚¤', icon: 'fa-paint-brush', cost: 200, owned: false },
          { id: 5, name: 'å¤æ—¥èƒŒæ™¯', description: 'å¤æ—¥æµ·æ»©ä¸»é¢˜èƒŒæ™¯', icon: 'fa-image', cost: 300, owned: false },
          { id: 6, name: 'æ–°æ‰‹ç¤¼åŒ…', description: 'åŒ…å«å¤šç§é“å…·çš„ç¤¼åŒ…', icon: 'fa-gift', cost: 100, owned: false }
        ];
        
        const shopElement = document.getElementById('shop-items');
        if (!shopElement) return;
        
        shopElement.innerHTML = '';
        
        items.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = 'bg-white rounded-xl p-4 game-shadow mb-4 slide-up';
          
          itemElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mr-4">
                <i class="fa ${item.icon} text-primary text-2xl"></i>
              </div>
              <div class="flex-1">
                <div class="font-bold text-lg">${item.name}</div>
                <div class="text-sm text-gray-500">${item.description}</div>
                <div class="mt-2 flex items-center">
                  <span class="font-bold text-primary">${item.cost} <i class="fa fa-diamond"></i></span>
                  ${item.count !== undefined ? `<span class="ml-2 text-sm text-gray-500">æ‹¥æœ‰: ${item.count}</span>` : ''}
                  ${item.owned ? '<span class="ml-2 text-sm text-green-500">å·²æ‹¥æœ‰</span>' : ''}
                </div>
              </div>
              <button class="bg-primary hover:bg-primary/80 text-white font-bold py-2 px-4 rounded-lg ${item.owned ? 'opacity-50 cursor-not-allowed' : ''}" ${item.owned ? 'disabled' : ''}>
                ${item.owned ? 'å·²æ‹¥æœ‰' : 'è´­ä¹°'}
              </button>
            </div>
          `;
          
          shopElement.appendChild(itemElement);
        });
      } catch (error) {
        console.error('åŠ è½½å•†åº—å¤±è´¥:', error);
        showToast('æ— æ³•åŠ è½½å•†åº—ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // æäº¤æç°è¯·æ±‚
    async function submitWithdrawal() {
      const amount = parseInt(document.getElementById('withdrawal-amount').value);
      const alipayAccount = document.getElementById('alipay-account').value;
      const alipayName = document.getElementById('alipay-name').value;
      
      if (!amount || !alipayAccount || !alipayName) {
        showToast('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
      }
      
      if (amount % 1000 !== 0) {
        showToast('æç°é‡‘é¢å¿…é¡»æ˜¯1000çš„å€æ•°', 'error');
        return;
      }
      
      if (amount < 1000) {
        showToast('æœ€ä½æç°é‡‘é¢ä¸º1000ä¸‡èŠ±å¸', 'error');
        return;
      }
      
      if (amount > gameState.balance) {
        showToast('ä½™é¢ä¸è¶³', 'error');
        return;
      }
      
      try {
        const result = await apiRequest('withdrawal', 'POST', {
          telegram_id: gameState.user.telegram_id,
          amount,
          alipayAccount,
          alipayName
        });
        
        if (result.success) {
          showToast('æç°è¯·æ±‚å·²æäº¤ï¼Œç­‰å¾…å¤„ç†', 'success');
          // é‡ç½®è¡¨å•
          const withdrawalForm = document.getElementById('withdrawal-form');
          if (withdrawalForm) withdrawalForm.reset();
          // åˆ·æ–°ä½™é¢
          await initUser();
          // è¿”å›é¦–é¡µ
          navigateTo('home-page');
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('æäº¤æç°è¯·æ±‚å¤±è´¥:', error);
        showToast('æç°è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // åŠ è½½æç°å†å²
    async function loadWithdrawalHistory() {
      try {
        const history = await apiRequest(`withdrawal-history?telegram_id=${gameState.user.telegram_id}`);
        
        const historyElement = document.getElementById('withdrawal-history');
        if (!historyElement) return;
        
        historyElement.innerHTML = '';
        
        if (history.length === 0) {
          historyElement.innerHTML = '<div class="text-center py-8 text-gray-500">æš‚æ— æç°è®°å½•</div>';
          return;
        }
        
        history.forEach(request => {
          const statusClass = 
            request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
            request.status === 'approved' ? 'bg-green-100 text-green-800' :
            'bg-red-100 text-red-800';
          
          const statusText = 
            request.status === 'pending' ? 'å¤„ç†ä¸­' :
            request.status === 'approved' ? 'å·²æ‰¹å‡†' :
            'å·²æ‹’ç»';
          
          const date = new Date(request.created_at).toLocaleString();
          
          const requestElement = document.createElement('div');
          requestElement.className = 'bg-white rounded-lg p-4 mb-3 game-shadow slide-up';
          
          requestElement.innerHTML = `
            <div class="flex justify-between items-center mb-2">
              <span class="font-bold text-lg">${request.amount} ä¸‡èŠ±å¸</span>
              <span class="px-3 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
            </div>
            <div class="text-sm text-gray-600 mb-1">æ”¯ä»˜å®: ${request.alipay_account}</div>
            <div class="text-sm text-gray-600 mb-1">å§“å: ${request.alipay_name}</div>
            <div class="text-xs text-gray-500">ç”³è¯·æ—¶é—´: ${date}</div>
          `;
          
          historyElement.appendChild(requestElement);
        });
      } catch (error) {
        console.error('åŠ è½½æç°å†å²å¤±è´¥:', error);
        showToast('æ— æ³•åŠ è½½æç°å†å²ï¼Œè¯·é‡è¯•', 'error');
      }
    }
    
    // å¤æ´»æ¸¸æˆ
    async function reviveGame() {
      // éšè—å¤±è´¥æ¨¡æ€æ¡†
      const levelFailedModal = document.getElementById('level-failed-modal');
      if (levelFailedModal) levelFailedModal.classList.remove('show');
      
      // æ˜¾ç¤ºå¤æ´»é€‰é¡¹
      const reviveModal = document.getElementById('revive-modal');
      if (reviveModal) reviveModal.classList.add('show');
      
      // ç»‘å®šå¤æ´»æŒ‰é’®äº‹ä»¶
      const reviveAdBtn = document.getElementById('revive-ad-btn');
      if (reviveAdBtn) {
        reviveAdBtn.onclick = async () => {
          reviveModal.classList.remove('show');
          showToast('è§‚çœ‹å¹¿å‘Šä¸­...');
          
          // æ¨¡æ‹Ÿå¹¿å‘Šæ’­æ”¾
          setTimeout(() => {
            // å¢åŠ æ­¥æ•°æˆ–æ—¶é—´
            if (gameState.movesAllowed > 0) {
              gameState.movesAllowed += 5;
            } else if (gameState.timeLimit > 0) {
              gameState.timeRemaining += 60;
            }
            
            gameState.isPlaying = true;
            updateGameInfo();
            showToast('å¤æ´»æˆåŠŸï¼è·å¾—5æ­¥é¢å¤–æ­¥æ•°', 'success');
          }, 3000);
        };
      }
      
      const reviveCoinsBtn = document.getElementById('revive-coins-btn');
      if (reviveCoinsBtn) {
        reviveCoinsBtn.onclick = async () => {
          if (gameState.balance < 50) {
            showToast('ä¸‡èŠ±å¸ä¸è¶³', 'error');
            return;
          }
          
          reviveModal.classList.remove('show');
          
          // æ‰£é™¤ä¸‡èŠ±å¸
          gameState.balance -= 50;
          updateUserInterface();
          
          // å¢åŠ æ­¥æ•°æˆ–æ—¶é—´
          if (gameState.movesAllowed > 0) {
            gameState.movesAllowed += 5;
          } else if (gameState.timeLimit > 0) {
            gameState.timeRemaining += 60;
          }
          
          gameState.isPlaying = true;
          updateGameInfo();
          showToast('å¤æ´»æˆåŠŸï¼è·å¾—5æ­¥é¢å¤–æ­¥æ•°', 'success');
        };
      }
      
      const reviveCancelBtn = document.getElementById('revive-cancel-btn');
      if (reviveCancelBtn) {
        reviveCancelBtn.onclick = () => {
          reviveModal.classList.remove('show');
          // è¿”å›é¦–é¡µ
          navigateTo('home-page');
        };
      }
    }
    
    // æ‰“å¼€TelegramèŠå¤©
    function openTelegramChat() {
      window.open(`https://t.me/bjxc010`, '_blank');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      // ç»‘å®šç™»å½•æŒ‰é’®
      const telegramLoginBtn = document.getElementById('telegram-login-btn');
      if (telegramLoginBtn) {
        telegramLoginBtn.addEventListener('click', async () => {
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            try {
              await apiRequest('login', 'POST', {
                queryId: tg.initDataUnsafe.query_id,
                userId: user.id,
                firstName: user.first_name,
                lastName: user.last_name || '',
                username: user.username || ''
              });
              window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            } catch (error) {
              console.error('ç™»å½•å¤±è´¥:', error);
              showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
          } else {
            showToast('æ— æ³•è·å–Telegramç”¨æˆ·ä¿¡æ¯', 'error');
          }
        });
      }
      
      // ç»‘å®šå¯¼èˆªäº‹ä»¶
      const navHome = document.getElementById('nav-home');
      if (navHome) navHome.addEventListener('click', () => navigateTo('home-page'));
      
      const navGame = document.getElementById('nav-game');
      if (navGame) navGame.addEventListener('click', () => navigateTo('game-page'));
      
      const navProfile = document.getElementById('nav-profile');
      if (navProfile) navProfile.addEventListener('click', () => navigateTo('profile-page'));
      
      const navLeaderboard = document.getElementById('nav-leaderboard');
      if (navLeaderboard) navLeaderboard.addEventListener('click', () => navigateTo('leaderboard-page'));
      
      const navTasks = document.getElementById('nav-tasks');
      if (navTasks) navTasks.addEventListener('click', () => navigateTo('tasks-page'));
      
      const navShop = document.getElementById('nav-shop');
      if (navShop) navShop.addEventListener('click', () => navigateTo('shop-page'));
      
      // ç»‘å®šç­¾åˆ°æŒ‰é’®
      const checkinBtn = document.getElementById('checkin-btn');
      if (checkinBtn) checkinBtn.addEventListener('click', handleCheckin);
      
      // ç»‘å®šå¹¿å‘Šå’Œåˆ†äº«æŒ‰é’®
      const watchAdBtn = document.getElementById('watch-ad-btn');
      if (watchAdBtn) watchAdBtn.addEventListener('click', () => addGamePlays('ad'));
      
      const shareBtn = document.getElementById('share-btn');
      if (shareBtn) shareBtn.addEventListener('click', () => addGamePlays('share'));
      
      // ç»‘å®šé‚€è¯·å¥½å‹æŒ‰é’®
      const inviteFriendsBtn = document.getElementById('invite-friends-btn');
      if (inviteFriendsBtn) inviteFriendsBtn.addEventListener('click', inviteFriends);
      
      const inviteFriendsBtn2 = document.getElementById('invite-friends-btn-2');
      if (inviteFriendsBtn2) inviteFriendsBtn2.addEventListener('click', inviteFriends);
      
      // ç»‘å®šæç°æŒ‰é’®
      const submitWithdrawalBtn = document.getElementById('submit-withdrawal-btn');
      if (submitWithdrawalBtn) submitWithdrawalBtn.addEventListener('click', submitWithdrawal);
      
      // ç»‘å®šæ¸¸æˆæ¨¡æ€æ¡†æŒ‰é’®
      const nextLevelBtn = document.getElementById('next-level-btn');
      if (nextLevelBtn) {
        nextLevelBtn.addEventListener('click', () => {
          const levelCompleteModal = document.getElementById('level-complete-modal');
          if (levelCompleteModal) levelCompleteModal.classList.remove('show');
          startGame(gameState.currentLevel + 1);
        });
      }
      
      const retryLevelBtn = document.getElementById('retry-level-btn');
      if (retryLevelBtn) {
        retryLevelBtn.addEventListener('click', () => {
          const levelFailedModal = document.getElementById('level-failed-modal');
          if (levelFailedModal) levelFailedModal.classList.remove('show');
          startGame(gameState.currentLevel);
        });
      }
      
      const reviveBtn = document.getElementById('revive-btn');
      if (reviveBtn) reviveBtn.addEventListener('click', reviveGame);
      
      const exitLevelBtns = document.querySelectorAll('#exit-level-btn');
      exitLevelBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const levelCompleteModal = document.getElementById('level-complete-modal');
          if (levelCompleteModal) levelCompleteModal.classList.remove('show');
          
          const levelFailedModal = document.getElementById('level-failed-modal');
          if (levelFailedModal) levelFailedModal.classList.remove('show');
          
          navigateTo('home-page');
        });
      });
      
      // ç»‘å®šé“å…·æŒ‰é’®
      const powerupShuffle = document.getElementById('powerup-shuffle');
      if (powerupShuffle) powerupShuffle.addEventListener('click', () => usePowerup('shuffle'));
      
      const powerupBomb = document.getElementById('powerup-bomb');
      if (powerupBomb) powerupBomb.addEventListener('click', () => usePowerup('bomb'));
      
      const powerupSteps = document.getElementById('powerup-steps');
      if (powerupSteps) powerupSteps.addEventListener('click', () => usePowerup('steps'));
      
      // ç»‘å®šè¿”å›é¦–é¡µæŒ‰é’®
      const homeBtns = document.querySelectorAll('.home-btn');
      homeBtns.forEach(btn => {
        btn.addEventListener('click', () => navigateTo('home-page'));
      });
      
      // ç»‘å®šå¼€å§‹æ¸¸æˆæŒ‰é’®
      const playBtn = document.getElementById('play-btn');
      if (playBtn) playBtn.addEventListener('click', () => navigateTo('game-page'));
      
      // ç»‘å®šæ’è¡Œæ¦œå¯¼èˆªæŒ‰é’®
      const leaderboardNavBtn = document.getElementById('leaderboard-nav-btn');
      if (leaderboardNavBtn) leaderboardNavBtn.addEventListener('click', () => navigateTo('leaderboard-page'));
      
      // ç»‘å®šæç°å¯¼èˆªæŒ‰é’®
      const withdrawalNavBtn = document.getElementById('withdrawal-nav-btn');
      if (withdrawalNavBtn) withdrawalNavBtn.addEventListener('click', () => navigateTo('withdrawal-page'));
      
      // åˆå§‹åŒ–ç”¨æˆ·
      initUser();
    });
  </script>
  
  <!-- ç™»å½•é¡µé¢ -->
  <div id="login-page" class="page login-container">
    <div class="login-card">
      <h1 class="login-title">ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</h1>
      <p class="login-subtitle">ç»å…¸æ¶ˆæ¶ˆä¹å¼ºåŠ¿ç™»é™†Telegramå¹³å°ï¼Œæ¸¸æˆçš„åŒæ—¶å¯ä»¥èµšå–"ä¸‡èŠ±å¸"ï¼Œè½»æ¾ç§¯ç´¯æç°ï¼</p>
      
      <div class="login-features">
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-gamepad"></i>
          </div>
          <div class="login-feature-text">ç»å…¸ç©æ³•</div>
        </div>
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-diamond"></i>
          </div>
          <div class="login-feature-text">èµšå–å¥–åŠ±</div>
        </div>
        <div class="login-feature">
          <div class="login-feature-icon">
            <i class="fa fa-money"></i>
          </div>
          <div class="login-feature-text">è½»æ¾æç°</div>
        </div>
      </div>
      
      <button id="telegram-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-10 rounded-full flex items-center text-lg pulse-animation">
        <i class="fa fa-telegram mr-3 text-2xl"></i> ç”¨Telegramç™»å½•
      </button>
    </div>
  </div>
  
  <!-- é¦–é¡µ -->
  <div id="home-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-primary">ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</h1>
      <div class="bg-primary/10 text-primary px-4 py-2 rounded-full flex items-center">
        <i class="fa fa-diamond mr-2"></i>
        <span class="balance-display font-bold">0</span> ä¸‡èŠ±å¸
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow mb-6 slide-up">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">å½“å‰è¿›åº¦</h2>
        <button id="checkin-btn" class="bg-accent hover:bg-accent/80 text-dark font-bold py-2 px-5 rounded-full text-sm">
          æ¯æ—¥ç­¾åˆ°
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-6 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-xl border border-blue-200">
          <div class="text-blue-500 text-sm mb-2">å½“å‰å…³å¡</div>
          <div class="text-3xl font-bold text-blue-700" id="current-level-display">1</div>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-xl border border-green-200">
          <div class="text-green-500 text-sm mb-2">æ€»å¾—åˆ†</div>
          <div class="text-3xl font-bold text-green-700" id="total-score-display">0</div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-5 rounded-xl border border-purple-200">
          <div class="text-purple-500 text-sm mb-2">ä»Šæ—¥å‰©ä½™æ¬¡æ•°</div>
          <div class="text-3xl font-bold text-purple-700" id="remaining-plays">6</div>
        </div>
        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-5 rounded-xl border border-yellow-200">
          <div class="text-yellow-500 text-sm mb-2">å…‘æ¢æ¯”ä¾‹</div>
          <div class="text-2xl font-bold text-yellow-700">1000:10å…ƒ</div>
        </div>
      </div>
      
      <button id="play-btn" class="w-full bg-gradient-to-r from-primary to-pink-500 hover:from-primary/90 hover:to-pink-500/90 text-white font-bold py-4 rounded-xl text-lg pulse-animation">
        å¼€å§‹æ¸¸æˆ
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-6 mb-6">
      <button id="watch-ad-btn" class="bg-white p-5 rounded-2xl game-shadow flex flex-col items-center justify-center slide-up">
        <i class="fa fa-play-circle text-3xl text-blue-500 mb-3"></i>
        <span class="font-bold">è§‚çœ‹å¹¿å‘Š</span>
        <span class="text-sm text-gray-500 mt-1">+2æ¬¡æ¸¸æˆæœºä¼š</span>
      </button>
      <button id="share-btn" class="bg-white p-5 rounded-2xl game-shadow flex flex-col items-center justify-center slide-up">
        <i class="fa fa-share-alt text-3xl text-green-500 mb-3"></i>
        <span class="font-bold">åˆ†äº«æ¸¸æˆ</span>
        <span class="text-sm text-gray-500 mt-1">+2æ¬¡æ¸¸æˆæœºä¼š</span>
      </button>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <div class="grid grid-cols-2 gap-6">
        <button id="leaderboard-nav-btn" class="p-4 border border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-gray-50 transition">
          <i class="fa fa-trophy text-3xl text-yellow-500 mb-2"></i>
          <span class="font-bold">æ’è¡Œæ¦œ</span>
          <span class="text-sm text-gray-500 mt-1">æœˆåº¦å¥–åŠ±</span>
        </button>
        <button id="withdrawal-nav-btn" class="p-4 border border-gray-200 rounded-xl flex flex-col items-center justify-center hover:bg-gray-50 transition">
          <i class="fa fa-money text-3xl text-green-600 mb-2"></i>
          <span class="font-bold">æç°</span>
          <span class="text-sm text-gray-500 mt-1">å…‘æ¢ç°é‡‘</span>
        </button>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mt-6">
      <h3 class="text-xl font-bold mb-4">é‚€è¯·å¥½å‹</h3>
      <button id="invite-friends-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white font-bold py-3 rounded-lg flex items-center justify-center">
        <i class="fa fa-user-plus mr-2"></i> é‚€è¯·å¥½å‹è·å¾—å¥–åŠ±
      </button>
    </div>
  </div>
  
  <!-- æ¸¸æˆé¡µé¢ -->
  <div id="game-page" class="page hidden p-2">
    <div class="flex justify-between items-center mb-3">
      <button class="bg-white/80 hover:bg-white p-2 rounded-full shadow home-btn">
        <i class="fa fa-home text-gray-700"></i>
      </button>
      <div class="text-center">
        <h2 class="font-bold text-lg">å…³å¡ <span id="current-game-level">1</span></h2>
      </div>
      <div class="bg-white/80 text-primary px-3 py-1 rounded-full text-sm flex items-center shadow">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span>
      </div>
    </div>
    
    <div class="bg-white/90 rounded-xl p-3 mb-3 game-shadow">
      <div class="grid grid-cols-2 gap-2 text-center">
        <div class="bg-light p-2 rounded-lg">
          <div class="text-sm text-gray-500">å½“å‰å¾—åˆ†</div>
          <div class="font-bold text-lg" id="game-score">0</div>
        </div>
        <div class="bg-light p-2 rounded-lg">
          <div class="text-sm text-gray-500">ç›®æ ‡</div>
          <div class="font-bold text-lg" id="game-target">0</div>
        </div>
        <div class="bg-light p-2 rounded-lg col-span-2">
          <div class="text-sm text-gray-500">å‰©ä½™</div>
          <div class="font-bold text-lg" id="remaining-moves">0</div>
        </div>
      </div>
    </div>
    
    <div id="game-board" class="w-full aspect-square bg-light/90 rounded-xl game-shadow grid gap-1 p-2 mb-3 overflow-hidden"></div>
    
    <div class="flex justify-between">
      <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg home-btn">
        é€€å‡º
      </button>
      <button class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg" onclick="startGame(gameState.currentLevel)">
        é‡æ–°å¼€å§‹
      </button>
    </div>
    
    <!-- é“å…·æ  -->
    <div id="powerup-bar" class="powerup-bar hidden">
      <div class="powerup-item" onclick="usePowerup('shuffle')">
        <i class="fa fa-random powerup-icon"></i>
        <div class="powerup-name">æ´—ç‰Œ</div>
        <div class="powerup-cost"><span id="powerup-shuffle-count">3</span> <i class="fa fa-diamond"></i></div>
      </div>
      <div class="powerup-item" onclick="usePowerup('bomb')">
        <i class="fa fa-bomb powerup-icon"></i>
        <div class="powerup-name">çˆ†ç‚¸</div>
        <div class="powerup-cost"><span id="powerup-bomb-count">1</span> <i class="fa fa-diamond"></i></div>
      </div>
      <div class="powerup-item" onclick="usePowerup('steps')">
        <i class="fa fa-plus powerup-icon"></i>
        <div class="powerup-name">+5æ­¥</div>
        <div class="powerup-cost"><span id="powerup-steps-count">2</span> <i class="fa fa-diamond"></i></div>
      </div>
    </div>
  </div>
  
  <!-- ä¸ªäººä¸­å¿ƒé¡µé¢ -->
  <div id="profile-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">ä¸ªäººä¸­å¿ƒ</h1>
      <div class="w-8"></div> <!-- å ä½ -->
    </div>
    
    <div class="profile-header mb-6">
      <div class="flex flex-col items-center">
        <img id="profile-avatar" src="https://via.placeholder.com/80" alt="ç”¨æˆ·å¤´åƒ" class="profile-avatar">
        <h2 id="profile-username" class="text-xl font-bold mt-3">ç”¨æˆ·å</h2>
        <div class="flex mt-4 space-x-6">
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-level">1</div>
            <div class="text-sm opacity-80">å…³å¡</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-score">0</div>
            <div class="text-sm opacity-80">æ€»åˆ†</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold" id="profile-balance">0</div>
            <div class="text-sm opacity-80">ä¸‡èŠ±å¸</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h3 class="text-xl font-bold mb-4">æˆ‘çš„æˆå°±</h3>
      <div id="profile-achievements" class="space-y-3">
        <!-- æˆå°±å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h3 class="text-xl font-bold mb-4">æ¸¸æˆè®¾ç½®</h3>
      <div class="space-y-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>éŸ³æ•ˆ</span>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>èƒŒæ™¯éŸ³ä¹</span>
          <label class="switch">
            <input type="checkbox">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span>æŒ¯åŠ¨åé¦ˆ</span>
          <label class="switch">
            <input type="checkbox" checked>
            <span class="slider round"></span>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ’è¡Œæ¦œé¡µé¢ -->
  <div id="leaderboard-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">å…¨æœæ’è¡Œæ¦œ</h1>
      <div class="w-8"></div> <!-- å ä½ -->
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4 text-center">æœ¬æœˆæ’å</h2>
      <div id="leaderboard-list" class="space-y-3">
        <!-- æ’è¡Œæ¦œæ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
      <div id="leaderboard-rewards">
        <!-- å¥–åŠ±ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">å¥½å‹æ’è¡Œæ¦œ</h2>
      <div class="text-center py-8 text-gray-500">
        <i class="fa fa-users text-4xl mb-3"></i>
        <p>æš‚æ— å¥½å‹æ•°æ®</p>
        <button class="mt-3 bg-primary text-white px-4 py-2 rounded-lg" id="invite-friends-btn-2">é‚€è¯·å¥½å‹</button>
      </div>
    </div>
  </div>
  
  <!-- ä»»åŠ¡é¡µé¢ -->
  <div id="tasks-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">æ¯æ—¥ä»»åŠ¡</h1>
      <div class="w-8"></div> <!-- å ä½ -->
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ä»Šæ—¥ä»»åŠ¡</h2>
        <div class="text-sm text-gray-500">æ¯æ—¥åˆ·æ–°</div>
      </div>
      <div id="tasks-list">
        <!-- ä»»åŠ¡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">ä»»åŠ¡å®ç®±</h2>
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-4 text-center border border-yellow-200">
          <i class="fa fa-gift text-3xl text-yellow-500 mb-2"></i>
          <div class="font-bold">æ–°æ‰‹å®ç®±</div>
          <div class="text-xs text-gray-500 mt-1">å®Œæˆæ‰€æœ‰æ–°æ‰‹ä»»åŠ¡</div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center border border-blue-200">
          <i class="fa fa-gift text-3xl text-blue-500 mb-2"></i>
          <div class="font-bold">æ¯æ—¥å®ç®±</div>
          <div class="text-xs text-gray-500 mt-1">å®Œæˆæ‰€æœ‰æ¯æ—¥ä»»åŠ¡</div>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center border border-purple-200">
          <i class="fa fa-gift text-3xl text-purple-500 mb-2"></i>
          <div class="font-bold">å‘¨å¸¸å®ç®±</div>
          <div class="text-xs text-gray-500 mt-1">å®Œæˆæ‰€æœ‰å‘¨å¸¸ä»»åŠ¡</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å•†åº—é¡µé¢ -->
  <div id="shop-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">æ¸¸æˆå•†åº—</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span>
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4">é“å…·</h2>
      <div id="shop-items">
        <!-- å•†å“å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">ç¤¼åŒ…</h2>
      <div class="space-y-4">
        <div class="bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl p-5 text-white">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-xl font-bold">æ–°æ‰‹ç¤¼åŒ…</h3>
              <p class="text-sm opacity-80">åŒ…å«å¤šç§é“å…·çš„è¶…å€¼ç¤¼åŒ…</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">Â¥6</div>
              <button class="mt-2 bg-white text-blue-500 px-3 py-1 rounded-lg text-sm font-bold">è´­ä¹°</button>
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-xl p-5 text-white">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-xl font-bold">è¶…å€¼ç¤¼åŒ…</h3>
              <p class="text-sm opacity-80">å¤§é‡é“å…·å’Œä¸‡èŠ±å¸</p>
            </div>
            <div class="text-right">
              <div class="text-2xl font-bold">Â¥30</div>
              <button class="mt-2 bg-white text-yellow-500 px-3 py-1 rounded-lg text-sm font-bold">è´­ä¹°</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æç°é¡µé¢ -->
  <div id="withdrawal-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full home-btn">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">æç°ä¸­å¿ƒ</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display font-bold">0</span> ä¸‡èŠ±å¸
      </div>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-5">ç”³è¯·æç°</h2>
      <form id="withdrawal-form" class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-2 font-medium">æç°é‡‘é¢ (ä¸‡èŠ±å¸)</label>
          <input 
            type="number" 
            id="withdrawal-amount" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="1000" 
            step="1000" 
            min="1000"
          >
          <p class="text-sm text-gray-500 mt-2">æœ€ä½1000ä¸‡èŠ±å¸ï¼Œå¿…é¡»æ˜¯1000çš„å€æ•°</p>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2 font-medium">æ”¯ä»˜å®è´¦å·</label>
          <input 
            type="text" 
            id="alipay-account" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="è¯·è¾“å…¥æ”¯ä»˜å®è´¦å·"
          >
        </div>
        
        <div>
          <label class="block text-gray-700 mb-2 font-medium">æ”¯ä»˜å®å§“å</label>
          <input 
            type="text" 
            id="alipay-name" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
            placeholder="è¯·è¾“å…¥çœŸå®å§“å"
          >
        </div>
        
        <button 
          type="button" 
          id="submit-withdrawal-btn" 
          class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 rounded-lg"
        >
          æäº¤æç°ç”³è¯·
        </button>
      </form>
    </div>
    
    <div class="bg-white rounded-2xl p-6 game-shadow">
      <h2 class="text-xl font-bold mb-4">æç°å†å²</h2>
      <div id="withdrawal-history">
        <!-- æç°å†å²å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
  </div>
  
  <!-- å…³å¡å®Œæˆæ¨¡æ€æ¡† -->
  <div id="level-complete-modal" class="modal">
    <div class="modal-content">
      <div class="text-green-500 text-6xl mb-5 text-center">
        <i class="fa fa-check-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-3 text-center">å…³å¡å®Œæˆï¼</h2>
      <p class="mb-5 text-center text-gray-600">æ­å–œä½ é€šè¿‡äº†å…³å¡ <span id="completed-level">1</span></p>
      <div class="bg-green-50 p-5 rounded-xl mb-5">
        <div class="mb-2 text-center">ä½ çš„å¾—åˆ†: <span id="level-complete-score" class="font-bold text-lg">0</span></div>
        <div class="text-green-600 font-bold text-center text-lg">è·å¾—å¥–åŠ±: <span id="level-reward">0</span> ä¸‡èŠ±å¸</div>
      </div>
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-bold">
          è¿”å›é¦–é¡µ
        </button>
        <button id="next-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg font-bold">
          ä¸‹ä¸€å…³
        </button>
      </div>
    </div>
  </div>
  
  <!-- å…³å¡å¤±è´¥æ¨¡æ€æ¡† -->
  <div id="level-failed-modal" class="modal">
    <div class="modal-content">
      <div class="text-red-500 text-6xl mb-5 text-center">
        <i class="fa fa-times-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-3 text-center">æŒ‘æˆ˜å¤±è´¥</h2>
      <p class="mb-5 text-center text-gray-600">å†æ¥å†å‰ï¼Œäº‰å–é€šè¿‡å…³å¡ï¼</p>
      <div class="bg-red-50 p-5 rounded-xl mb-5">
        <div class="mb-2 text-center">ä½ çš„å¾—åˆ†: <span id="failed-score" class="font-bold text-lg">0</span></div>
        <div class="text-red-600 text-center font-bold text-lg">ç›®æ ‡: <span id="failed-target" class="font-bold">0</span></div>
      </div>
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg font-bold">
          è¿”å›é¦–é¡µ
        </button>
        <button id="revive-btn" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-bold">
          å¤æ´»
        </button>
        <button id="retry-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg font-bold
