<!-- game.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .game-container {
            max-width: 500px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
        }
        
        .game-info span {
            margin: 5px 0;
            font-weight: bold;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 2px;
            background-color: #ddd;
            padding: 2px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tile {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tile:hover {
            transform: scale(1.05);
        }
        
        .tile.selected {
            border: 3px solid #ff9800;
            transform: scale(1.1);
        }
        
        .game-controls {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .control-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .control-btn:hover {
            background-color: #45a049;
        }
        
        .control-btn.secondary {
            background-color: #2196F3;
        }
        
        .control-btn.secondary:hover {
            background-color: #0b7dda;
        }
        
        .game-footer {
            margin-top: 20px;
            text-align: center;
            color: #888;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 80%;
            text-align: center;
        }
        
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .modal-btn.primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .modal-btn.secondary {
            background-color: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-info">
                <span>å…³å¡: <span id="level">1</span></span>
                <span>åˆ†æ•°: <span id="score">0</span>/<span id="target-score">1000</span></span>
                <span>æ­¥æ•°: <span id="moves">0</span></span>
            </div>
            <div class="game-info">
                <span>ä¸‡èŠ±å¸: <span id="flowers">0</span></span>
                <span>å‰©ä½™æ¬¡æ•°: <span id="remaining-plays">6</span></span>
            </div>
        </div>
        
        <div class="game-board" id="game-board">
            <!-- æ¸¸æˆæ–¹å—å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="game-controls">
            <button class="control-btn secondary" id="shuffle-btn">ğŸ”„ æ‰“ä¹±</button>
            <button class="control-btn" id="end-game-btn">âŒ ç»“æŸæ¸¸æˆ</button>
        </div>
        
        <div class="game-footer">
            æœ¬æ¸¸æˆæœ‰åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘èµåŠ©å¼€å‘<br>
            ç”±@bjxc010å¼€å‘
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸæ¨¡æ€æ¡† -->
    <div class="modal" id="game-over-modal">
        <div class="modal-content">
            <h2 id="modal-title">æ¸¸æˆç»“æŸ</h2>
            <p id="modal-message">æ‚¨çš„æœ€ç»ˆå¾—åˆ†: 0</p>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="play-again-btn">å†ç©ä¸€æ¬¡</button>
                <button class="modal-btn secondary" id="back-to-menu-btn">è¿”å›ä¸»èœå•</button>
            </div>
        </div>
    </div>
    
    <!-- æç°æ¨¡æ€æ¡† -->
    <div class="modal" id="withdraw-modal">
        <div class="modal-content">
            <h2>æç°</h2>
            <p>æ‚¨çš„ä¸‡èŠ±å¸ä½™é¢: <span id="withdraw-flowers">0</span></p>
            <p>å¯æç°é‡‘é¢: Â¥<span id="withdraw-amount">0.00</span></p>
            <div class="modal-buttons">
                <button class="modal-btn primary" id="confirm-withdraw-btn">ç¡®è®¤æç°</button>
                <button class="modal-btn secondary" id="cancel-withdraw-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // æ¸¸æˆé…ç½®
        const TILE_TYPES = ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒ¼', 'ğŸŒµ', 'ğŸŒ²'];
        const BOARD_SIZE = 12;
        const TARGET_SCORE_BASE = 1000;
        const TARGET_SCORE_INCREMENT = 500;
        
        // æ¸¸æˆçŠ¶æ€
        let game = {
            level: 1,
            score: 0,
            moves: 0,
            board: [],
            selectedTile: null,
            targetScore: TARGET_SCORE_BASE,
            flowers: 0,
            remainingPlays: 6,
            isGameOver: false
        };
        
        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            // ä»Telegram Web Appè·å–ç”¨æˆ·ä¿¡æ¯
            const tg = window.Telegram.WebApp;
            tg.expand();
            
            // åˆå§‹åŒ–æ¸¸æˆæ¿
            initializeBoard();
            
            // æ¸²æŸ“æ¸¸æˆ
            renderGame();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('shuffle-btn').addEventListener('click', shuffleBoard);
            document.getElementById('end-game-btn').addEventListener('click', endGame);
            document.getElementById('play-again-btn').addEventListener('click', () => {
                document.getElementById('game-over-modal').style.display = 'none';
                resetGame();
            });
            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                tg.close();
            });
            document.getElementById('confirm-withdraw-btn').addEventListener('click', confirmWithdraw);
            document.getElementById('cancel-withdraw-btn').addEventListener('click', () => {
                document.getElementById('withdraw-modal').style.display = 'none';
            });
        }
        
        // åˆå§‹åŒ–æ¸¸æˆæ¿
        function initializeBoard() {
            game.board = [];
            for (let i = 0; i < BOARD_SIZE; i++) {
                game.board[i] = [];
                for (let j = 0; j < BOARD_SIZE; j++) {
                    game.board[i][j] = getRandomTileType();
                }
            }
            
            // ç¡®ä¿åˆå§‹æ¿ä¸Šæ²¡æœ‰åŒ¹é…
            while (findMatches().length > 0) {
                shuffleBoardInternal();
            }
        }
        
        // è·å–éšæœºæ–¹å—ç±»å‹
        function getRandomTileType() {
            const maxTypes = Math.max(3, TILE_TYPES.length - Math.floor(game.level / 3));
            return TILE_TYPES[Math.floor(Math.random() * maxTypes)];
        }
        
        // æŸ¥æ‰¾åŒ¹é…
        function findMatches() {
            const matches = [];
            
            // æ£€æŸ¥æ°´å¹³åŒ¹é…
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE - 2; j++) {
                    if (game.board[i][j] && 
                        game.board[i][j] === game.board[i][j + 1] && 
                        game.board[i][j] === game.board[i][j + 2]) {
                        
                        const match = [{row: i, col: j}, {row: i, col: j + 1}, {row: i, col: j + 2}];
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šç›¸åŒçš„æ–¹å—
                        let k = j + 3;
                        while (k < BOARD_SIZE && game.board[i][j] === game.board[i][k]) {
                            match.push({row: i, col: k});
                            k++;
                        }
                        
                        matches.push(match);
                        j = k - 1;  // è·³è¿‡å·²åŒ¹é…çš„æ–¹å—
                    }
                }
            }
            
            // æ£€æŸ¥å‚ç›´åŒ¹é…
            for (let j = 0; j < BOARD_SIZE; j++) {
                for (let i = 0; i < BOARD_SIZE - 2; i++) {
                    if (game.board[i][j] && 
                        game.board[i][j] === game.board[i + 1][j] && 
                        game.board[i][j] === game.board[i + 2][j]) {
                        
                        const match = [{row: i, col: j}, {row: i + 1, col: j}, {row: i + 2, col: j}];
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ›´å¤šç›¸åŒçš„æ–¹å—
                        let k = i + 3;
                        while (k < BOARD_SIZE && game.board[i][j] === game.board[k][j]) {
                            match.push({row: k, col: j});
                            k++;
                        }
                        
                        matches.push(match);
                        i = k - 1;  // è·³è¿‡å·²åŒ¹é…çš„æ–¹å—
                    }
                }
            }
            
            return matches;
        }
        
        // å¤„ç†åŒ¹é…
        function processMatches() {
            let totalMatches = 0;
            let matches = findMatches();
            
            while (matches.length > 0) {
                removeMatches(matches);
                totalMatches += matches.length;
                
                // åº”ç”¨é‡åŠ›ï¼Œä½¿æ–¹å—ä¸‹è½
                applyGravity();
                
                // å¡«å……ç©ºä½
                fillEmptySpaces();
                
                // æ£€æŸ¥æ–°çš„åŒ¹é…
                matches = findMatches();
            }
            
            // æ›´æ–°åˆ†æ•°
            game.score += totalMatches * 10 * game.level;
            
            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°
            if (game.score >= game.targetScore) {
                levelComplete();
            }
            
            return totalMatches;
        }
        
        // ç§»é™¤åŒ¹é…çš„æ–¹å—
        function removeMatches(matches) {
            for (const match of matches) {
                for (const tile of match) {
                    game.board[tile.row][tile.col] = null;
                }
            }
        }
        
        // åº”ç”¨é‡åŠ›
        function applyGravity() {
            for (let j = 0; j < BOARD_SIZE; j++) {
                let emptySpaces = 0;
                
                // ä»åº•éƒ¨å‘ä¸Šæ‰«æ
                for (let i = BOARD_SIZE - 1; i >= 0; i--) {
                    if (game.board[i][j] === null) {
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        // å°†æ–¹å—ä¸‹ç§»
                        game.board[i + emptySpaces][j] = game.board[i][j];
                        game.board[i][j] = null;
                    }
                }
            }
        }
        
        // å¡«å……ç©ºä½
        function fillEmptySpaces() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    if (game.board[i][j] === null) {
                        game.board[i][j] = getRandomTileType();
                    }
                }
            }
        }
        
        // äº¤æ¢æ–¹å—
        function swapTiles(row1, col1, row2, col2) {
            // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
            const isAdjacent = 
                (Math.abs(row1 - row2) === 1 && col1 === col2) ||
                (Math.abs(col1 - col2) === 1 && row1 === row2);
            
            if (!isAdjacent) {
                return false;
            }
            
            // äº¤æ¢æ–¹å—
            const temp = game.board[row1][col1];
            game.board[row1][col1] = game.board[row2][col2];
            game.board[row2][col2] = temp;
            
            // æ£€æŸ¥æ˜¯å¦äº§ç”ŸåŒ¹é…
            const matches = findMatches();
            if (matches.length === 0) {
                // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œäº¤æ¢å›æ¥
                game.board[row2][col2] = game.board[row1][col1];
                game.board[row1][col1] = temp;
                return false;
            }
            
            // å¤„ç†åŒ¹é…
            game.moves++;
            processMatches();
            renderGame();
            return true;
        }
        
        // æ‰“ä¹±æ¸¸æˆæ¿
        function shuffleBoard() {
            shuffleBoardInternal();
            renderGame();
        }
        
        // å†…éƒ¨æ‰“ä¹±æ¸¸æˆæ¿
        function shuffleBoardInternal() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    game.board[i][j] = getRandomTileType();
                }
            }
        }
        
        // å…³å¡å®Œæˆ
        function levelComplete() {
            // å¢åŠ å…³å¡
            game.level++;
            
            // è®¡ç®—æ–°çš„ç›®æ ‡åˆ†æ•°
            game.targetScore = TARGET_SCORE_BASE + TARGET_SCORE_INCREMENT * (game.level - 1);
            
            // å¥–åŠ±ä¸‡èŠ±å¸
            const flowersEarned = 100 * game.level;
            game.flowers += flowersEarned;
            
            // æ˜¾ç¤ºå…³å¡å®Œæˆæ¶ˆæ¯
            showModal('å…³å¡å®Œæˆï¼', `æ­å–œæ‚¨é€šè¿‡äº†ç¬¬${game.level-1}å…³ï¼\nè·å¾—${flowersEarned}ä¸‡èŠ±å¸ï¼`);
            
            // é‡ç½®æ¸¸æˆæ¿
            initializeBoard();
            renderGame();
        }
        
        // ç»“æŸæ¸¸æˆ
        function endGame() {
            game.isGameOver = true;
            
            // è®¡ç®—å¥–åŠ±
            const flowersEarned = Math.floor(game.score / 10);
            game.flowers += flowersEarned;
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¨¡æ€æ¡†
            document.getElementById('modal-title').textContent = 'æ¸¸æˆç»“æŸ';
            document.getElementById('modal-message').textContent = `æ‚¨çš„æœ€ç»ˆå¾—åˆ†: ${game.score}\nè·å¾—${flowersEarned}ä¸‡èŠ±å¸ï¼`;
            document.getElementById('game-over-modal').style.display = 'flex';
        }
        
        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            game = {
                level: 1,
                score: 0,
                moves: 0,
                board: [],
                selectedTile: null,
                targetScore: TARGET_SCORE_BASE,
                flowers: game.flowers,
                remainingPlays: game.remainingPlays - 1,
                isGameOver: false
            };
            
            initializeBoard();
            renderGame();
        }
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('game-over-modal').style.display = 'flex';
        }
        
        // ç¡®è®¤æç°
        function confirmWithdraw() {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIè¿›è¡Œæç°
            alert('æç°è¯·æ±‚å·²æäº¤ï¼Œå°†åœ¨12å°æ—¶å†…å¤„ç†ï¼');
            document.getElementById('withdraw-modal').style.display = 'none';
        }
        
        // æ¸²æŸ“æ¸¸æˆ
        function renderGame() {
            // æ›´æ–°æ¸¸æˆä¿¡æ¯
            document.getElementById('level').textContent = game.level;
            document.getElementById('score').textContent = game.score;
            document.getElementById('target-score').textContent = game.targetScore;
            document.getElementById('moves').textContent = game.moves;
            document.getElementById('flowers').textContent = game.flowers;
            document.getElementById('remaining-plays').textContent = game.remainingPlays;
            
            // æ¸²æŸ“æ¸¸æˆæ¿
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';
            
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    const tile = document.createElement('div');
                    tile.className = 'tile';
                    tile.dataset.row = i;
                    tile.dataset.col = j;
                    
                    // è®¾ç½®æ–¹å—é¢œè‰²
                    const colors = {
                        'ğŸŒ¸': '#FF9AA2',
                        'ğŸŒº': '#FFB7B2',
                        'ğŸŒ»': '#FFDAC1',
                        'ğŸŒ·': '#E2F0CB',
                        'ğŸŒ¹': '#B5EAD7',
                        'ğŸŒ¼': '#C7CEEA',
                        'ğŸŒµ': '#F8B195',
                        'ğŸŒ²': '#F67280'
                    };
                    
                    tile.style.backgroundColor = colors[game.board[i][j]] || '#CCCCCC';
                    tile.textContent = game.board[i][j];
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    tile.addEventListener('click', handleTileClick);
                    
                    gameBoard.appendChild(tile);
                }
            }
        }
        
        // å¤„ç†æ–¹å—ç‚¹å‡»
        function handleTileClick(event) {
            if (game.isGameOver) return;
            
            const row = parseInt(event.target.dataset.row);
            const col = parseInt(event.target.dataset.col);
            
            if (game.selectedTile === null) {
                // é€‰æ‹©ç¬¬ä¸€ä¸ªæ–¹å—
                game.selectedTile = { row, col };
                event.target.classList.add('selected');
            } else {
                // é€‰æ‹©ç¬¬äºŒä¸ªæ–¹å—å¹¶å°è¯•äº¤æ¢
                const firstTile = document.querySelector(`.tile[data-row="${game.selectedTile.row}"][data-col="${game.selectedTile.col}"]`);
                firstTile.classList.remove('selected');
                
                if (game.selectedTile.row === row && game.selectedTile.col === col) {
                    // ç‚¹å‡»åŒä¸€ä¸ªæ–¹å—ï¼Œå–æ¶ˆé€‰æ‹©
                    game.selectedTile = null;
                } else {
                    // å°è¯•äº¤æ¢æ–¹å—
                    swapTiles(game.selectedTile.row, game.selectedTile.col, row, col);
                    game.selectedTile = null;
                }
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
