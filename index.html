<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* å…¥å£é¡µé¢æ ·å¼ */
        .entry-screen {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .entry-logo {
            width: 120px;
            height: 120px;
            background-color: #ff6b6b;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .entry-logo i {
            font-size: 60px;
            color: white;
        }
        
        .entry-title {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .entry-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .entry-button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .entry-button:hover {
            background-color: #ff5252;
            transform: scale(1.05);
        }
        
        .entry-button i {
            margin-right: 10px;
        }
        
        .entry-qr {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .entry-qr img {
            width: 150px;
            height: 150px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .entry-qr-text {
            font-size: 14px;
            color: #666;
        }
        
        /* ä¸»ç•Œé¢æ ·å¼ */
        .main-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        .coins {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .coins i {
            margin-right: 5px;
        }
        
        .level-map {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        
        .level-map h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .levels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .level {
            aspect-ratio: 1;
            background-color: #f0f0f0;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .level.unlocked {
            background-color: #4ecdc4;
            color: white;
        }
        
        .level.completed {
            background-color: #ff6b6b;
            color: white;
        }
        
        .level-stars {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            font-size: 10px;
        }
        
        .bottom-nav {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            transform: translateY(-3px);
        }
        
        .nav-item i {
            font-size: 24px;
            margin-bottom: 5px;
            color: #ff6b6b;
        }
        
        .nav-item span {
            font-size: 12px;
        }
        
        /* æ¸¸æˆç•Œé¢æ ·å¼ */
        .game-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .game-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
        }
        
        .game-info h3 {
            margin-bottom: 5px;
        }
        
        .game-stats {
            display: flex;
            gap: 15px;
        }
        
        .game-board {
            background-color: white;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 5px;
            aspect-ratio: 1;
            flex-grow: 1;
        }
        
        .tile {
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tile.selected {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
        }
        
        .tile.red { background-color: #ff6b6b; }
        .tile.blue { background-color: #4dabf7; }
        .tile.green { background-color: #51cf66; }
        .tile.yellow { background-color: #ffd43b; }
        .tile.purple { background-color: #9775fa; }
        
        .game-footer {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .game-item {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .game-item:hover {
            transform: scale(1.1);
        }
        
        .game-item i {
            font-size: 24px;
            color: #ff6b6b;
        }
        
        /* ä»»åŠ¡ç•Œé¢æ ·å¼ */
        .tasks-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .tasks-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .tasks-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .task-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .task-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .task-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .task-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-info h4 {
            margin-bottom: 5px;
        }
        
        .task-info p {
            font-size: 14px;
            color: #666;
        }
        
        .task-progress {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .task-progress-bar {
            height: 100%;
            background-color: #4ecdc4;
            border-radius: 4px;
        }
        
        .task-reward {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .task-reward-amount {
            background-color: #ffd43b;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .task-claim-btn {
            background-color: #4ecdc4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-claim-btn:hover {
            background-color: #3dbcb3;
        }
        
        .task-claim-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        /* ç­¾åˆ°ç•Œé¢æ ·å¼ */
        .checkin-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .checkin-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .checkin-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .checkin-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
            width: 100%;
        }
        
        .checkin-day {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            position: relative;
        }
        
        .checkin-day.checked {
            background-color: #4ecdc4;
            color: white;
        }
        
        .checkin-day.today {
            border: 2px solid #ff6b6b;
        }
        
        .checkin-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .checkin-day-reward {
            font-size: 12px;
        }
        
        .checkin-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .checkin-btn:hover {
            background-color: #ff5252;
            transform: scale(1.05);
        }
        
        .checkin-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        /* æ’è¡Œæ¦œç•Œé¢æ ·å¼ */
        .leaderboard-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .leaderboard-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .leaderboard-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .leaderboard-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .leaderboard-rank.top1 {
            background-color: #ffd43b;
            color: #333;
        }
        
        .leaderboard-rank.top2 {
            background-color: #adb5bd;
            color: white;
        }
        
        .leaderboard-rank.top3 {
            background-color: #cd7f32;
            color: white;
        }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .leaderboard-coins {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .leaderboard-coins i {
            margin-right: 5px;
            color: #ffd43b;
        }
        
        /* æç°ç•Œé¢æ ·å¼ */
        .withdraw-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .withdraw-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .withdraw-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .withdraw-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .withdraw-amount-label {
            font-weight: bold;
        }
        
        .withdraw-amount-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .withdraw-submit {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .withdraw-submit:hover {
            background-color: #ff5252;
        }
        
        .withdraw-history {
            margin-top: 30px;
        }
        
        .withdraw-history h3 {
            margin-bottom: 15px;
        }
        
        .withdraw-history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .withdraw-history-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .withdraw-history-info {
            display: flex;
            flex-direction: column;
        }
        
        .withdraw-history-amount {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .withdraw-history-date {
            font-size: 14px;
            color: #666;
        }
        
        .withdraw-history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .withdraw-history-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .withdraw-history-status.approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .withdraw-history-status.rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* é¡µè„šæ ·å¼ */
        .footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .footer a {
            color: #ff6b6b;
            text-decoration: none;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .modal-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .modal-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .modal-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .game-over-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .game-over-score {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .game-over-stars {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .game-over-star {
            font-size: 30px;
            color: #e9ecef;
            margin: 0 5px;
        }
        
        .game-over-star.filled {
            color: #ffd43b;
        }
        
        .game-over-reward {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .game-over-reward-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .game-over-reward-amount {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .game-over-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .game-over-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .game-over-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .game-over-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .game-over-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .game-over-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* æ¸¸æˆæ¬¡æ•°æç¤º */
        .play-limit {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .play-limit-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .play-limit-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .play-limit-message {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .play-limit-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .play-limit-btn {
            padding: 12px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .play-limit-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .play-limit-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .play-limit-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .play-limit-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
            }
            
            .level-map {
                padding: 15px;
            }
            
            .levels {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å…¥å£é¡µé¢ -->
        <div class="entry-screen" id="entryScreen">
            <div class="entry-logo">
                <i class="fas fa-gamepad"></i>
            </div>
            <h1 class="entry-title">ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹</h1>
            <p class="entry-message">è¯·é€šè¿‡Telegramæœºå™¨äººè¿›å…¥æ¸¸æˆ</p>
            <button class="entry-button" onclick="openTelegramBot()">
                <i class="fab fa-telegram"></i> æ‰“å¼€Telegramæœºå™¨äºº
            </button>
            <div class="entry-qr">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://t.me/bjxcwhljiluBot" alt="Telegramæœºå™¨äººäºŒç»´ç ">
                <p class="entry-qr-text">æ‰«æäºŒç»´ç æˆ–æœç´¢ @bjxcwhljiluBot</p>
            </div>
        </div>
        
        <!-- ä¸»ç•Œé¢ -->
        <div class="main-screen" id="mainScreen">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="username">ç©å®¶</span>
                </div>
                <div class="coins">
                    <i class="fas fa-coins"></i>
                    <span id="userCoins">0</span>
                </div>
            </div>
            
            <div class="level-map">
                <h2>å…³å¡åœ°å›¾</h2>
                <div class="levels" id="levelsList">
                    <!-- å…³å¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="bottom-nav">
                <div class="nav-item" onclick="showScreen('tasksScreen')">
                    <i class="fas fa-tasks"></i>
                    <span>ä»»åŠ¡</span>
                </div>
                <div class="nav-item" onclick="showScreen('checkinScreen')">
                    <i class="fas fa-calendar-check"></i>
                    <span>ç­¾åˆ°</span>
                </div>
                <div class="nav-item" onclick="showScreen('leaderboardScreen')">
                    <i class="fas fa-trophy"></i>
                    <span>æ’è¡Œæ¦œ</span>
                </div>
                <div class="nav-item" onclick="showScreen('withdrawScreen')">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>æç°</span>
                </div>
            </div>
        </div>
        
        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="game-screen" id="gameScreen">
            <div class="game-header">
                <div class="game-info">
                    <h3 id="levelName">ç¬¬1å…³</h3>
                    <div>ç›®æ ‡: <span id="levelTarget">1000</span>åˆ†</div>
                </div>
                <div class="game-stats">
                    <div>æ­¥æ•°: <span id="movesLeft">20</span></div>
                    <div>åˆ†æ•°: <span id="currentScore">0</span></div>
                </div>
            </div>
            
            <div class="game-board" id="gameBoard">
                <!-- æ¸¸æˆæ£‹ç›˜å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="game-footer">
                <div class="game-item" onclick="useItem('refresh')">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="game-item" onclick="useItem('bomb')">
                    <i class="fas fa-bomb"></i>
                </div>
                <div class="game-item" onclick="useItem('rocket')">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="game-item" onclick="useItem('rainbow')">
                    <i class="fas fa-rainbow"></i>
                </div>
            </div>
        </div>
        
        <!-- ä»»åŠ¡ç•Œé¢ -->
        <div class="tasks-screen" id="tasksScreen">
            <div class="tasks-header">
                <h2>ä»»åŠ¡ä¸­å¿ƒ</h2>
            </div>
            
            <div class="tasks-content">
                <div class="task-tabs">
                    <div class="task-tab active" onclick="switchTaskTab('daily')">æ¯æ—¥ä»»åŠ¡</div>
                    <div class="task-tab" onclick="switchTaskTab('achievement')">æˆå°±</div>
                </div>
                
                <div class="task-list" id="dailyTasksList">
                    <!-- æ¯æ—¥ä»»åŠ¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="task-list" id="achievementsList" style="display: none;">
                    <!-- æˆå°±å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- ç­¾åˆ°ç•Œé¢ -->
        <div class="checkin-screen" id="checkinScreen">
            <div class="checkin-header">
                <h2>æ¯æ—¥ç­¾åˆ°</h2>
            </div>
            
            <div class="checkin-content">
                <div class="checkin-calendar" id="checkinCalendar">
                    <!-- ç­¾åˆ°æ—¥å†å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <button class="checkin-btn" id="checkinBtn" onclick="checkin()">ç­¾åˆ°</button>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œç•Œé¢ -->
        <div class="leaderboard-screen" id="leaderboardScreen">
            <div class="leaderboard-header">
                <h2>æ’è¡Œæ¦œ</h2>
            </div>
            
            <div class="leaderboard-content">
                <div class="leaderboard-tabs">
                    <div class="leaderboard-tab active" onclick="switchLeaderboardTab('monthly')">æœˆæ¦œ</div>
                    <div class="leaderboard-tab" onclick="switchLeaderboardTab('total')">æ€»æ¦œ</div>
                </div>
                
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- æ’è¡Œæ¦œå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- æç°ç•Œé¢ -->
        <div class="withdraw-screen" id="withdrawScreen">
            <div class="withdraw-header">
                <h2>æç°</h2>
            </div>
            
            <div class="withdraw-content">
                <div class="withdraw-amount">
                    <span class="withdraw-amount-label">å¯æç°é‡‘é¢</span>
                    <span class="withdraw-amount-value" id="withdrawAmount">0</span>
                </div>
                
                <form class="withdraw-form" id="withdrawForm" onsubmit="submitWithdraw(event)">
                    <div class="form-group">
                        <label for="alipayAccount">æ”¯ä»˜å®è´¦å·</label>
                        <input type="text" id="alipayAccount" required placeholder="è¯·è¾“å…¥æ”¯ä»˜å®è´¦å·">
                    </div>
                    
                    <div class="form-group">
                        <label for="realName">çœŸå®å§“å</label>
                        <input type="text" id="realName" required placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                    </div>
                    
                    <button type="submit" class="withdraw-submit">æç°</button>
                </form>
                
                <div class="withdraw-history">
                    <h3>æç°è®°å½•</h3>
                    <div class="withdraw-history-list" id="withdrawHistoryList">
                        <!-- æç°è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é¡µè„š -->
        <div class="footer">
            æœ¬æ¸¸æˆç”±åŒ—äº¬ä¿®è½¦ã€ä¸‡èŠ±æ¥¼ã€‘èµåŠ©ï¼›ç”± <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> å¼€å‘
        </div>
    </div>
    
    <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <div class="game-over-title" id="gameOverTitle">å…³å¡å®Œæˆ</div>
            <div class="game-over-score">å¾—åˆ†: <span id="gameOverScore">0</span></div>
            <div class="game-over-stars" id="gameOverStars">
                <div class="game-over-star"><i class="fas fa-star"></i></div>
                <div class="game-over-star"><i class="fas fa-star"></i></div>
                <div class="game-over-star"><i class="fas fa-star"></i></div>
            </div>
            <div class="game-over-reward">
                <div class="game-over-reward-label">è·å¾—å¥–åŠ±</div>
                <div class="game-over-reward-amount"><i class="fas fa-coins"></i> <span id="gameOverReward">0</span></div>
            </div>
            <div class="game-over-buttons">
                <button class="game-over-btn-secondary" onclick="backToMain()">è¿”å›åœ°å›¾</button>
                <button class="game-over-btn-primary" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
            </div>
        </div>
    </div>
    
    <!-- æ¸¸æˆæ¬¡æ•°æç¤º -->
    <div class="play-limit" id="playLimit">
        <div class="play-limit-content">
            <div class="play-limit-title">æ¸¸æˆæ¬¡æ•°å·²ç”¨å®Œ</div>
            <div class="play-limit-message">
                ä»Šæ—¥å…è´¹æ¸¸æˆæ¬¡æ•°å·²ç”¨å®Œï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–é¢å¤–æ¸¸æˆæ¬¡æ•°ï¼š
            </div>
            <div class="play-limit-options">
                <button class="play-limit-btn-primary" onclick="shareToTelegram()">åˆ†äº«åˆ°Telegramç¾¤ç»„ (+2æ¬¡)</button>
                <button class="play-limit-btn-secondary" onclick="watchAd()">è§‚çœ‹å¹¿å‘Š (+1æ¬¡)</button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev';
        const BOT_USERNAME = 'bjxcwhljiluBot';
        let currentUser = null;
        let currentLevel = null;
        let gameBoard = [];
        let selectedTile = null;
        let movesLeft = 0;
        let currentScore = 0;
        let gameActive = false;
        let playCount = 0;
        const MAX_PLAYS_PER_DAY = 7;
        
        // ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
        function handleError(error, message = 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•') {
            console.error(error);
            alert(message);
        }
        
        // æ•°æ®éªŒè¯å‡½æ•°
        function validateFormData(data) {
            const errors = [];
            
            // éªŒè¯æ”¯ä»˜å®è´¦å·
            if (data.alipayAccount) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                const phoneRegex = /^1[3-9]\d{9}$/;
                
                if (!emailRegex.test(data.alipayAccount) && !phoneRegex.test(data.alipayAccount)) {
                    errors.push('æ”¯ä»˜å®è´¦å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥é‚®ç®±æˆ–æ‰‹æœºå·ç ');
                }
            }
            
            // éªŒè¯çœŸå®å§“å
            if (data.realName && !/^[\u4e00-\u9fa5a-zA-Z]{2,20}$/.test(data.realName)) {
                errors.push('çœŸå®å§“ååªèƒ½åŒ…å«ä¸­æ–‡æˆ–è‹±æ–‡ï¼Œé•¿åº¦2-20ä¸ªå­—ç¬¦');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        // æ¸¸æˆå…ƒç´ ç±»å‹
        const TILE_TYPES = [
            { type: 'red', icon: 'ğŸ' },
            { type: 'blue', icon: 'ğŸ‡' },
            { type: 'green', icon: 'ğŸŠ' },
            { type: 'yellow', icon: 'ğŸ‹' },
            { type: 'purple', icon: 'ğŸ’' }
        ];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦é€šè¿‡Telegramè¿›å…¥
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            
            if (!userId) {
                // æ˜¾ç¤ºå…¥å£é¡µé¢
                document.getElementById('entryScreen').style.display = 'flex';
            } else {
                // ç›´æ¥è¿›å…¥æ¸¸æˆ
                initGame(userId);
            }
        });
        
        // æ‰“å¼€Telegramæœºå™¨äºº
        function openTelegramBot() {
            // æ£€æŸ¥æ˜¯å¦åœ¨Telegramåº”ç”¨å†…
            if (window.Telegram && window.Telegram.WebApp) {
                // åœ¨Telegramåº”ç”¨å†…ï¼Œå¯ä»¥ç›´æ¥æ‰“å¼€æœºå™¨äºº
                window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
            } else {
                // ä¸åœ¨Telegramåº”ç”¨å†…ï¼Œå°è¯•æ‰“å¼€Telegramåº”ç”¨
                const telegramUrl = `tg://resolve?domain=${BOT_USERNAME}`;
                
                // å°è¯•æ‰“å¼€Telegramåº”ç”¨
                window.open(telegramUrl, '_blank');
                
                // å¦‚æœæ— æ³•æ‰“å¼€ï¼Œåˆ™æ‰“å¼€ç½‘é¡µç‰ˆ
                setTimeout(() => {
                    window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
                }, 500);
            }
        }
        
        // åˆå§‹åŒ–æ¸¸æˆ
        async function initGame(userId) {
            try {
                showLoader();
                
                // éšè—å…¥å£é¡µé¢
                document.getElementById('entryScreen').style.display = 'none';
                
                // è·å–ç”¨æˆ·ä¿¡æ¯
                await loadUserInfo(userId);
                
                // åŠ è½½å…³å¡
                await loadLevels();
                
                // åŠ è½½æ¯æ—¥ä»»åŠ¡
                await loadDailyTasks();
                
                // åŠ è½½æˆå°±
                await loadAchievements();
                
                // åˆå§‹åŒ–ç­¾åˆ°æ—¥å†
                initCheckinCalendar();
                
                // æ˜¾ç¤ºä¸»ç•Œé¢
                showScreen('mainScreen');
            } catch (error) {
                console.error('Error initializing game:', error);
                alert('åˆå§‹åŒ–æ¸¸æˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                hideLoader();
            }
        }
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoader() {
            document.getElementById('loader').style.display = 'flex';
        }
        
        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }
        
        // æ˜¾ç¤ºç•Œé¢
        function showScreen(screenId) {
            // éšè—æ‰€æœ‰ç•Œé¢
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('tasksScreen').style.display = 'none';
            document.getElementById('checkinScreen').style.display = 'none';
            document.getElementById('leaderboardScreen').style.display = 'none';
            document.getElementById('withdrawScreen').style.display = 'none';
            
            // æ˜¾ç¤ºæŒ‡å®šç•Œé¢
            document.getElementById(screenId).style.display = 'flex';
            
            // å¦‚æœæ˜¯æ’è¡Œæ¦œç•Œé¢ï¼ŒåŠ è½½æ•°æ®
            if (screenId === 'leaderboardScreen') {
                loadLeaderboard();
            }
            
            // å¦‚æœæ˜¯æç°ç•Œé¢ï¼Œæ›´æ–°å¯æç°é‡‘é¢
            if (screenId === 'withdrawScreen') {
                updateWithdrawAmount();
                loadWithdrawHistory();
            }
        }
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/info?user_id=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    const usernameEl = document.getElementById('username');
                    const userCoinsEl = document.getElementById('userCoins');
                    
                    if (usernameEl) usernameEl.textContent = currentUser.first_name || 'ç©å®¶';
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // æ£€æŸ¥ä»Šæ—¥æ¸¸æˆæ¬¡æ•°
                    const today = new Date().toDateString();
                    const lastPlayDate = new Date(currentUser.last_play_date).toDateString();
                    
                    if (today === lastPlayDate) {
                        playCount = currentUser.play_count;
                    } else {
                        playCount = 0;
                    }
                } else {
                    handleError(data.error || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                    throw new Error(data.error || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                handleError(error, 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                throw error;
            }
        }
        
        // åŠ è½½å…³å¡
        async function loadLevels() {
            try {
                if (!currentUser || !currentUser.telegram_id) {
                    handleError('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´', 'åŠ è½½å…³å¡å¤±è´¥');
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
                }
                
                const response = await fetch(`${API_BASE_URL}/api/user/levels?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const levelsList = document.getElementById('levelsList');
                    if (!levelsList) return;
                    
                    levelsList.innerHTML = '';
                    
                    // ç”Ÿæˆ10ä¸ªå…³å¡
                    for (let i = 1; i <= 10; i++) {
                        const userLevel = data.find(ul => ul.level_id === i);
                        const level = document.createElement('div');
                        level.className = 'level';
                        level.textContent = i;
                        
                        if (userLevel) {
                            if (userLevel.completed) {
                                level.classList.add('completed');
                                
                                // æ·»åŠ æ˜Ÿæ˜Ÿ
                                const stars = document.createElement('div');
                                stars.className = 'level-stars';
                                for (let j = 0; j < userLevel.stars; j++) {
                                    stars.innerHTML += '<i class="fas fa-star"></i>';
                                }
                                level.appendChild(stars);
                            } else {
                                level.classList.add('unlocked');
                            }
                        } else if (i === 1 || (data[i-2] && data[i-2].completed)) {
                            level.classList.add('unlocked');
                        }
                        
                        level.onclick = () => startLevel(i);
                        levelsList.appendChild(level);
                    }
                } else {
                    handleError('åŠ è½½å…³å¡å¤±è´¥', 'åŠ è½½å…³å¡å¤±è´¥');
                    throw new Error('åŠ è½½å…³å¡å¤±è´¥');
                }
            } catch (error) {
                handleError(error, 'åŠ è½½å…³å¡å¤±è´¥');
                throw error;
            }
        }
        
        // å¼€å§‹å…³å¡
        async function startLevel(levelId) {
            // æ£€æŸ¥æ¸¸æˆæ¬¡æ•°
            if (playCount >= MAX_PLAYS_PER_DAY) {
                document.getElementById('playLimit').style.display = 'flex';
                return;
            }
            
            // è·å–å…³å¡ä¿¡æ¯
            let level;
            if (levelId <= 5) {
                level = {
                    id: levelId,
                    name: `ç¬¬${levelId}å…³`,
                    difficulty: 1,
                    target_score: 1000 * levelId,
                    target_moves: 20 + (levelId - 1) * 5
                };
            } else {
                level = {
                    id: levelId,
                    name: `ç¬¬${levelId}å…³`,
                    difficulty: 2,
                    target_score: 4000 + (levelId - 6) * 1000,
                    target_moves: 30 + (levelId - 6) * 5
                };
            }
            
            currentLevel = level;
            movesLeft = level.target_moves;
            currentScore = 0;
            
            // æ›´æ–°æ¸¸æˆç•Œé¢
            document.getElementById('levelName').textContent = level.name;
            document.getElementById('levelTarget').textContent = level.target_score;
            document.getElementById('movesLeft').textContent = movesLeft;
            document.getElementById('currentScore').textContent = currentScore;
            
            // åˆå§‹åŒ–æ¸¸æˆæ£‹ç›˜
            initGameBoard();
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            showScreen('gameScreen');
            
            // æ¿€æ´»æ¸¸æˆ
            gameActive = true;
        }
        
        // åˆå§‹åŒ–æ¸¸æˆæ£‹ç›˜
        function initGameBoard() {
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';
            gameBoard = [];
            
            // åˆ›å»º8x8çš„æ£‹ç›˜
            for (let row = 0; row < 8; row++) {
                gameBoard[row] = [];
                for (let col = 0; col < 8; col++) {
                    // éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ ç±»å‹
                    const tileType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)];
                    
                    // åˆ›å»ºæ£‹ç›˜å…ƒç´ 
                    const tile = document.createElement('div');
                    tile.className = `tile ${tileType.type}`;
                    tile.textContent = tileType.icon;
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    tile.dataset.type = tileType.type;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    tile.addEventListener('click', () => {
                        if (gameActive && typeof selectTile === 'function' && row !== undefined && col !== undefined) {
                            selectTile(row, col);
                        }
                    });
                    
                    boardElement.appendChild(tile);
                    gameBoard[row][col] = {
                        type: tileType.type,
                        element: tile
                    };
                }
            }
            
            // ç¡®ä¿åˆå§‹æ£‹ç›˜æ²¡æœ‰åŒ¹é…
            while (hasMatches()) {
                shuffleBoard();
            }
        }
        
        // é€‰æ‹©æ£‹ç›˜å…ƒç´ 
        function selectTile(row, col) {
            if (!gameActive) return;
            
            const tile = gameBoard[row][col].element;
            
            if (selectedTile === null) {
                // é€‰æ‹©ç¬¬ä¸€ä¸ªå…ƒç´ 
                selectedTile = { row, col };
                tile.classList.add('selected');
            } else {
                // é€‰æ‹©ç¬¬äºŒä¸ªå…ƒç´ 
                const prevTile = gameBoard[selectedTile.row][selectedTile.col].element;
                prevTile.classList.remove('selected');
                
                // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
                if (isAdjacent(selectedTile.row, selectedTile.col, row, col)) {
                    // äº¤æ¢å…ƒç´ 
                    swapTiles(selectedTile.row, selectedTile.col, row, col);
                    
                    // æ£€æŸ¥åŒ¹é…
                    setTimeout(() => {
                        if (!checkMatches()) {
                            // å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œäº¤æ¢å›æ¥
                            swapTiles(selectedTile.row, selectedTile.col, row, col);
                        }
                    }, 300);
                }
                
                selectedTile = null;
            }
        }
        
        // æ£€æŸ¥ä¸¤ä¸ªå…ƒç´ æ˜¯å¦ç›¸é‚»
        function isAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }
        
        // äº¤æ¢ä¸¤ä¸ªå…ƒç´ 
        function swapTiles(row1, col1, row2, col2) {
            // äº¤æ¢æ•°æ®
            const temp = gameBoard[row1][col1];
            gameBoard[row1][col1] = gameBoard[row2][col2];
            gameBoard[row2][col2] = temp;
            
            // æ›´æ–°DOM
            const tile1 = gameBoard[row1][col1].element;
            const tile2 = gameBoard[row2][col2].element;
            
            tile1.dataset.row = row1;
            tile1.dataset.col = col1;
            
            tile2.dataset.row = row2;
            tile2.dataset.col = col2;
            
            // æ›´æ–°æ ·å¼
            updateTileDisplay(row1, col1);
            updateTileDisplay(row2, col2);
        }
        
        // æ›´æ–°å…ƒç´ æ˜¾ç¤º
        function updateTileDisplay(row, col) {
            const tile = gameBoard[row][col];
            const tileType = TILE_TYPES.find(t => t.type === tile.type);
            
            tile.element.className = `tile ${tile.type}`;
            tile.element.textContent = tileType.icon;
            tile.element.dataset.type = tile.type;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…
        function hasMatches() {
            // æ£€æŸ¥æ°´å¹³åŒ¹é…
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 6; col++) {
                    if (gameBoard[row][col].type === gameBoard[row][col + 1].type &&
                        gameBoard[row][col].type === gameBoard[row][col + 2].type) {
                        return true;
                    }
                }
            }
            
            // æ£€æŸ¥å‚ç›´åŒ¹é…
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 8; col++) {
                    if (gameBoard[row][col].type === gameBoard[row + 1][col].type &&
                        gameBoard[row][col].type === gameBoard[row + 2][col].type) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // æ£€æŸ¥å¹¶å¤„ç†åŒ¹é…
        function checkMatches() {
            const matches = [];
            
            // æ£€æŸ¥æ°´å¹³åŒ¹é…
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 6; col++) {
                    if (gameBoard[row][col].type === gameBoard[row][col + 1].type &&
                        gameBoard[row][col].type === gameBoard[row][col + 2].type) {
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰4ä¸ªæˆ–æ›´å¤šåŒ¹é…
                        let matchLength = 3;
                        while (col + matchLength < 8 && gameBoard[row][col].type === gameBoard[row][col + matchLength].type) {
                            matchLength++;
                        }
                        
                        // æ·»åŠ åŒ¹é…
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row, col: col + i });
                        }
                        
                        col += matchLength - 1;
                    }
                }
            }
            
            // æ£€æŸ¥å‚ç›´åŒ¹é…
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 8; col++) {
                    if (gameBoard[row][col].type === gameBoard[row + 1][col].type &&
                        gameBoard[row][col].type === gameBoard[row + 2][col].type) {
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰4ä¸ªæˆ–æ›´å¤šåŒ¹é…
                        let matchLength = 3;
                        while (row + matchLength < 8 && gameBoard[row][col].type === gameBoard[row + matchLength][col].type) {
                            matchLength++;
                        }
                        
                        // æ·»åŠ åŒ¹é…
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row: row + i, col });
                        }
                        
                        row += matchLength - 1;
                    }
                }
            }
            
            // å¦‚æœæœ‰åŒ¹é…ï¼Œå¤„ç†å®ƒä»¬
            if (matches.length > 0) {
                processMatches(matches);
                return true;
            }
            
            return false;
        }
        
        // å¤„ç†åŒ¹é…
        function processMatches(matches) {
            // æ ‡è®°åŒ¹é…çš„å…ƒç´ 
            const matchedTiles = new Set();
            matches.forEach(match => {
                const key = `${match.row},${match.col}`;
                matchedTiles.add(key);
            });
            
            // è®¡ç®—åˆ†æ•°
            const scoreGain = matches.length * 10;
            currentScore += scoreGain;
            const currentScoreEl = document.getElementById('currentScore');
            if (currentScoreEl) currentScoreEl.textContent = currentScore;
            
            // ç§»é™¤åŒ¹é…çš„å…ƒç´ 
            matchedTiles.forEach(key => {
                const [row, col] = key.split(',').map(Number);
                gameBoard[row][col].element.style.opacity = '0.5';
            });
            
            // ä½¿ç”¨setTimeouté“¾æ›¿ä»£åµŒå¥—setTimeoutï¼Œæé«˜æ€§èƒ½
            setTimeout(processMatchesStep1, 300);
        }
        
        function processMatchesStep1() {
            dropTiles();
            setTimeout(processMatchesStep2, 300);
        }
        
        function processMatchesStep2() {
            fillBoard();
            setTimeout(processMatchesStep3, 300);
        }
        
        function processMatchesStep3() {
            if (!checkMatches()) {
                // æ²¡æœ‰æ›´å¤šåŒ¹é…ï¼Œå‡å°‘æ­¥æ•°
                movesLeft--;
                const movesLeftEl = document.getElementById('movesLeft');
                if (movesLeftEl) movesLeftEl.textContent = movesLeft;
                
                // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
                if (movesLeft <= 0 || currentScore >= currentLevel.target_score) {
                    endGame();
                }
            }
        }
        
        // ä¸‹è½å…ƒç´ 
        function dropTiles() {
            for (let col = 0; col < 8; col++) {
                let emptySpaces = 0;
                
                // ä»åº•éƒ¨å‘ä¸Šæ‰«æ
                for (let row = 7; row >= 0; row--) {
                    if (gameBoard[row][col].element.style.opacity === '0.5') {
                        // æ ‡è®°ä¸ºç©º
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        // ä¸‹è½å…ƒç´ 
                        gameBoard[row + emptySpaces][col] = gameBoard[row][col];
                        gameBoard[row][col] = { type: null, element: gameBoard[row][col].element };
                        
                        // æ›´æ–°DOM
                        gameBoard[row + emptySpaces][col].element.dataset.row = row + emptySpaces;
                        updateTileDisplay(row + emptySpaces, col);
                        
                        // é‡ç½®åŸä½ç½®
                        gameBoard[row][col].element.style.opacity = '1';
                    }
                }
            }
        }
        
        // å¡«å……æ£‹ç›˜
        function fillBoard() {
            for (let col = 0; col < 8; col++) {
                for (let row = 0; row < 8; row++) {
                    if (!gameBoard[row][col].type) {
                        // éšæœºé€‰æ‹©ä¸€ä¸ªå…ƒç´ ç±»å‹
                        const tileType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)];
                        
                        // æ›´æ–°æ•°æ®
                        gameBoard[row][col].type = tileType.type;
                        
                        // æ›´æ–°DOM
                        updateTileDisplay(row, col);
                    }
                }
            }
        }
        
        // æ´—ç‰Œ
        function shuffleBoard() {
            // æ”¶é›†æ‰€æœ‰å…ƒç´ ç±»å‹
            const types = [];
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    types.push(gameBoard[row][col].type);
                }
            }
            
            // éšæœºæ’åº
            for (let i = types.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [types[i], types[j]] = [types[j], types[i]];
            }
            
            // é‡æ–°åˆ†é…ç±»å‹
            let index = 0;
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    gameBoard[row][col].type = types[index++];
                    updateTileDisplay(row, col);
                }
            }
        }
        
        // ä½¿ç”¨é“å…·
        function useItem(itemType) {
            if (!gameActive) return;
            
            switch (itemType) {
                case 'refresh':
                    shuffleBoard();
                    break;
                case 'bomb':
                    // éšæœºæ¶ˆé™¤3x3åŒºåŸŸ
                    const centerRow = Math.floor(Math.random() * 6) + 1;
                    const centerCol = Math.floor(Math.random() * 6) + 1;
                    
                    const matches = [];
                    for (let row = centerRow - 1; row <= centerRow + 1; row++) {
                        for (let col = centerCol - 1; col <= centerCol + 1; col++) {
                            matches.push({ row, col });
                        }
                    }
                    
                    processMatches(matches);
                    break;
                case 'rocket':
                    // éšæœºæ¶ˆé™¤ä¸€è¡Œæˆ–ä¸€åˆ—
                    const isRow = Math.random() > 0.5;
                    const index = Math.floor(Math.random() * 8);
                    
                    const rocketMatches = [];
                    if (isRow) {
                        for (let col = 0; col < 8; col++) {
                            rocketMatches.push({ row: index, col });
                        }
                    } else {
                        for (let row = 0; row < 8; row++) {
                            rocketMatches.push({ row, col: index });
                        }
                    }
                    
                    processMatches(rocketMatches);
                    break;
                case 'rainbow':
                    // éšæœºé€‰æ‹©ä¸€ç§ç±»å‹å¹¶æ¶ˆé™¤æ‰€æœ‰è¯¥ç±»å‹çš„å…ƒç´ 
                    const targetType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)].type;
                    
                    const rainbowMatches = [];
                    for (let row = 0; row < 8; row++) {
                        for (let col = 0; col < 8; col++) {
                            if (gameBoard[row][col].type === targetType) {
                                rainbowMatches.push({ row, col });
                            }
                        }
                    }
                    
                    processMatches(rainbowMatches);
                    break;
            }
        }
        
        // ç»“æŸæ¸¸æˆ
        async function endGame() {
            gameActive = false;
            
            // è®¡ç®—æ˜Ÿæ˜Ÿæ•°é‡
            let stars = 0;
            const scorePercentage = currentScore / currentLevel.target_score;
            
            if (scorePercentage >= 1) {
                stars = 3;
            } else if (scorePercentage >= 0.7) {
                stars = 2;
            } else if (scorePercentage >= 0.4) {
                stars = 1;
            }
            
            // è®¡ç®—å¥–åŠ±
            const isCompleted = currentScore >= currentLevel.target_score;
            let reward = 0;
            
            if (isCompleted) {
                if (currentLevel.difficulty === 1) {
                    reward = 10 + (stars - 1) * 5;
                } else {
                    reward = 25 + (stars - 1) * 5;
                }
            }
            
            // æ›´æ–°æ¸¸æˆç»“æŸç•Œé¢
            const gameOverTitleEl = document.getElementById('gameOverTitle');
            const gameOverScoreEl = document.getElementById('gameOverScore');
            const gameOverRewardEl = document.getElementById('gameOverReward');
            const gameOverEl = document.getElementById('gameOver');
            
            if (gameOverTitleEl) gameOverTitleEl.textContent = isCompleted ? 'å…³å¡å®Œæˆ' : 'æ¸¸æˆç»“æŸ';
            if (gameOverScoreEl) gameOverScoreEl.textContent = currentScore;
            
            // æ›´æ–°æ˜Ÿæ˜Ÿ
            const starElements = document.querySelectorAll('.game-over-star');
            if (starElements.length > 0) {
                starElements.forEach((star, index) => {
                    if (index < stars) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            }
            
            if (gameOverRewardEl) gameOverRewardEl.textContent = reward;
            if (gameOverEl) gameOverEl.style.display = 'flex';
            
            // ä¿å­˜æ¸¸æˆç»“æœ
            if (isCompleted) {
                try {
                    if (!currentUser || !currentUser.telegram_id) {
                        throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/api/game/session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: currentUser.telegram_id,
                            levelId: currentLevel.id,
                            score: currentScore,
                            moves: currentLevel.target_moves - movesLeft,
                            stars: stars,
                            completed: true
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // æ›´æ–°ç”¨æˆ·ä¸‡èŠ±å¸
                        currentUser.flower_coins += data.reward;
                        const userCoinsEl = document.getElementById('userCoins');
                        if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                        
                        // æ›´æ–°å…³å¡ä»»åŠ¡è¿›åº¦
                        if (typeof updateDailyTaskProgress === 'function') {
                            updateDailyTaskProgress('level', 1);
                            
                            // æ›´æ–°åˆ†æ•°ä»»åŠ¡è¿›åº¦
                            updateDailyTaskProgress('score', currentScore);
                        }
                        
                        // æ›´æ–°æˆå°±è¿›åº¦
                        if (typeof updateAchievementProgress === 'function') {
                            updateAchievementProgress('levels_completed', currentLevel.id);
                            updateAchievementProgress('single_score', currentScore);
                        }
                    } else {
                        handleError('Failed to save game session: ' + data.error, 'ä¿å­˜æ¸¸æˆè®°å½•å¤±è´¥');
                    }
                } catch (error) {
                    handleError(error, 'ä¿å­˜æ¸¸æˆè®°å½•å¤±è´¥');
                }
            }
            
            // å¢åŠ æ¸¸æˆæ¬¡æ•°å¹¶ç¡®ä¿ä¸ä¼šä¸ºè´Ÿ
            playCount = Math.max(0, playCount + 1);
        }
        
        // è¿”å›ä¸»ç•Œé¢
        function backToMain() {
            document.getElementById('gameOver').style.display = 'none';
            showScreen('mainScreen');
        }
        
        // ä¸‹ä¸€å…³
        function nextLevel() {
            document.getElementById('gameOver').style.display = 'none';
            
            if (currentLevel.id < 10) {
                startLevel(currentLevel.id + 1);
            } else {
                showScreen('mainScreen');
            }
        }
        
        // åŠ è½½æ¯æ—¥ä»»åŠ¡
        async function loadDailyTasks() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const tasksList = document.getElementById('dailyTasksList');
                    if (!tasksList) return;
                    
                    tasksList.innerHTML = '';
                    
                    // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µä»¥å‡å°‘DOMæ“ä½œ
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item';
                        
                        const progressPercentage = Math.min(100, (task.progress / task.target_value) * 100);
                        
                        taskItem.innerHTML = `
                            <div class="task-info">
                                <h4>${task.name}</h4>
                                <p>${task.description}</p>
                                <div class="task-progress">
                                    <div class="task-progress-bar" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                            <div class="task-reward">
                                <div class="task-reward-amount"><i class="fas fa-coins"></i> ${task.reward}</div>
                                <button class="task-claim-btn" onclick="claimDailyTaskReward(${task.id})" ${!task.completed || task.rewarded ? 'disabled' : ''}>
                                    ${task.rewarded ? 'å·²é¢†å–' : (task.completed ? 'é¢†å–' : 'æœªå®Œæˆ')}
                                </button>
                            </div>
                        `;
                        
                        fragment.appendChild(taskItem);
                    });
                    
                    // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ 
                    tasksList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, 'åŠ è½½æ¯æ—¥ä»»åŠ¡å¤±è´¥');
            }
        }
        
        // é¢†å–æ¯æ—¥ä»»åŠ¡å¥–åŠ±
        async function claimDailyTaskReward(taskId) {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        taskId: taskId,
                        action: 'claim'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·ä¸‡èŠ±å¸
                    currentUser.flower_coins += data.reward;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // é‡æ–°åŠ è½½ä»»åŠ¡
                    await loadDailyTasks();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`æˆåŠŸé¢†å– ${data.reward} ä¸‡èŠ±å¸ï¼`);
                } else {
                    handleError(data.error || 'é¢†å–å¥–åŠ±å¤±è´¥', 'é¢†å–å¥–åŠ±å¤±è´¥');
                }
            } catch (error) {
                handleError(error, 'é¢†å–å¥–åŠ±å¤±è´¥');
            } finally {
                hideLoader();
            }
        }
        
        // æ›´æ–°æ¯æ—¥ä»»åŠ¡è¿›åº¦
        async function updateDailyTaskProgress(taskType, progress) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        taskType: taskType,
                        progress: progress
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.taskCompleted) {
                    // ä»»åŠ¡å®Œæˆï¼Œé‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    await loadDailyTasks();
                }
            } catch (error) {
                console.error('Error updating daily task progress:', error);
            }
        }
        
        // åŠ è½½æˆå°±
        async function loadAchievements() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/achievements?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const achievementsList = document.getElementById('achievementsList');
                    if (!achievementsList) return;
                    
                    achievementsList.innerHTML = '';
                    
                    // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µä»¥å‡å°‘DOMæ“ä½œ
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach(achievement => {
                        const achievementItem = document.createElement('div');
                        achievementItem.className = 'task-item';
                        
                        const progressPercentage = Math.min(100, (achievement.progress / achievement.target_value) * 100);
                        
                        achievementItem.innerHTML = `
                            <div class="task-info">
                                <h4>${achievement.name}</h4>
                                <p>${achievement.description}</p>
                                <div class="task-progress">
                                    <div class="task-progress-bar" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                            <div class="task-reward">
                                <div class="task-reward-amount"><i class="fas fa-coins"></i> ${achievement.reward}</div>
                                <button class="task-claim-btn" onclick="claimAchievementReward(${achievement.id})" ${!achievement.completed || achievement.rewarded ? 'disabled' : ''}>
                                    ${achievement.rewarded ? 'å·²é¢†å–' : (achievement.completed ? 'é¢†å–' : 'æœªå®Œæˆ')}
                                </button>
                            </div>
                        `;
                        
                        fragment.appendChild(achievementItem);
                    });
                    
                    // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ 
                    achievementsList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, 'åŠ è½½æˆå°±å¤±è´¥');
            }
        }
        
        // é¢†å–æˆå°±å¥–åŠ±
        async function claimAchievementReward(achievementId) {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/achievements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        achievementId: achievementId,
                        action: 'claim'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·ä¸‡èŠ±å¸
                    currentUser.flower_coins += data.reward;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // é‡æ–°åŠ è½½æˆå°±
                    await loadAchievements();
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`æˆåŠŸé¢†å–æˆå°±å¥–åŠ± ${data.reward} ä¸‡èŠ±å¸ï¼`);
                } else {
                    handleError(data.error || 'é¢†å–æˆå°±å¥–åŠ±å¤±è´¥', 'é¢†å–æˆå°±å¥–åŠ±å¤±è´¥');
                }
            } catch (error) {
                handleError(error, 'é¢†å–æˆå°±å¥–åŠ±å¤±è´¥');
            } finally {
                hideLoader();
            }
        }
        
        // æ›´æ–°æˆå°±è¿›åº¦
        async function updateAchievementProgress(achievementType, progress) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/achievements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        achievementType: achievementType,
                        progress: progress
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.achievementCompleted) {
                    // æˆå°±å®Œæˆï¼Œé‡æ–°åŠ è½½æˆå°±åˆ—è¡¨
                    await loadAchievements();
                }
            } catch (error) {
                console.error('Error updating achievement progress:', error);
            }
        }
        
        // åˆå§‹åŒ–ç­¾åˆ°æ—¥å†
        function initCheckinCalendar() {
            const calendar = document.getElementById('checkinCalendar');
            calendar.innerHTML = '';
            
            // è·å–å½“å‰æ—¥æœŸ
            const now = new Date();
            const currentDay = now.getDate();
            
            // ç”Ÿæˆ7å¤©çš„ç­¾åˆ°æ—¥å†
            for (let i = 1; i <= 7; i++) {
                const day = document.createElement('div');
                day.className = 'checkin-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'checkin-day-number';
                dayNumber.textContent = i;
                
                const dayReward = document.createElement('div');
                dayReward.className = 'checkin-day-reward';
                dayReward.textContent = Math.min(10 + (i - 1) * 5, 70);
                
                day.appendChild(dayNumber);
                day.appendChild(dayReward);
                
                if (i === currentDay) {
                    day.classList.add('today');
                }
                
                calendar.appendChild(day);
            }
        }
        
        // ç­¾åˆ°
        async function checkin() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·ä¸‡èŠ±å¸
                    currentUser.flower_coins += data.reward;
                    document.getElementById('userCoins').textContent = currentUser.flower_coins;
                    
                    // æ›´æ–°ç­¾åˆ°æŒ‰é’®
                    const checkinBtn = document.getElementById('checkinBtn');
                    checkinBtn.textContent = 'å·²ç­¾åˆ°';
                    checkinBtn.disabled = true;
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`ç­¾åˆ°æˆåŠŸï¼è·å¾— ${data.reward} ä¸‡èŠ±å¸ï¼Œè¿ç»­ç­¾åˆ° ${data.consecutiveDays} å¤©`);
                } else {
                    alert('ç­¾åˆ°å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('Error checking in:', error);
                alert('ç­¾åˆ°å¤±è´¥');
            } finally {
                hideLoader();
            }
        }
        
        // åŠ è½½æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/leaderboard?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const leaderboardList = document.getElementById('leaderboardList');
                    if (!leaderboardList) return;
                    
                    leaderboardList.innerHTML = '';
                    
                    // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µä»¥å‡å°‘DOMæ“ä½œ
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach((player, index) => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'leaderboard-item';
                        
                        let rankClass = '';
                        if (index === 0) rankClass = 'top1';
                        else if (index === 1) rankClass = 'top2';
                        else if (index === 2) rankClass = 'top3';
                        
                        playerItem.innerHTML = `
                            <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                            <div class="leaderboard-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${player.users?.first_name || 'ç©å®¶'}</div>
                                <div class="leaderboard-coins">
                                    <i class="fas fa-coins"></i> ${player.flower_coins}
                                </div>
                            </div>
                        `;
                        
                        fragment.appendChild(playerItem);
                    });
                    
                    // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ 
                    leaderboardList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, 'åŠ è½½æ’è¡Œæ¦œå¤±è´¥');
            } finally {
                hideLoader();
            }
        }
        
        // æ›´æ–°æç°é‡‘é¢
        function updateWithdrawAmount() {
            const withdrawAmount = Math.floor(currentUser.flower_coins / 1000) * 10;
            document.getElementById('withdrawAmount').textContent = `${withdrawAmount}å…ƒ`;
        }
        
        // æäº¤æç°
        async function submitWithdraw(event) {
            event.preventDefault();
            
            const alipayAccountInput = document.getElementById('alipayAccount');
            const realNameInput = document.getElementById('realName');
            const withdrawForm = document.getElementById('withdrawForm');
            
            if (!alipayAccountInput || !realNameInput) {
                handleError('è¡¨å•å…ƒç´ ä¸å­˜åœ¨', 'æç°æœ‰è¯¯');
                return;
            }
            
            const alipayAccount = alipayAccountInput.value.trim();
            const realName = realNameInput.value.trim();
            
            // è®¡ç®—æç°é‡‘é¢ï¼ˆ1000ä¸‡èŠ±å¸ = 10å…ƒï¼‰
            const amount = Math.floor(currentUser.flower_coins / 1000) * 1000;
            
            if (amount < 1000) {
                handleError('æç°é‡‘é¢ä¸è¶³ï¼Œè‡³å°‘éœ€è¦1000ä¸‡èŠ±å¸', 'æç°é‡‘é¢ä¸è¶³');
                return;
            }
            
            // éªŒè¯è¡¨å•æ•°æ®
            const validation = validateFormData({ alipayAccount, realName });
            if (!validation.isValid) {
                alert(validation.errors.join('\n'));
                return;
            }
            
            try {
                showLoader();
                
                if (!currentUser || !currentUser.telegram_id) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
                }
                
                const response = await fetch(`${API_BASE_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        amount: amount,
                        alipayAccount: alipayAccount,
                        realName: realName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·ä¸‡èŠ±å¸
                    currentUser.flower_coins -= amount;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // æ›´æ–°æç°é‡‘é¢
                    if (typeof updateWithdrawAmount === 'function') {
                        updateWithdrawAmount();
                    }
                    
                    // é‡æ–°åŠ è½½æç°è®°å½•
                    if (typeof loadWithdrawHistory === 'function') {
                        await loadWithdrawHistory();
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert('æç°ç”³è¯·å·²æäº¤ï¼Œè¯·ç­‰å¾…å®¡æ ¸');
                    
                    // é‡ç½®è¡¨å•
                    if (withdrawForm) {
                        withdrawForm.reset();
                    }
                } else {
                    handleError(data.error || 'æç°å¤±è´¥', 'æç°æœ‰è¯¯');
                }
            } catch (error) {
                handleError(error, 'æç°æœ‰è¯¯');
            } finally {
                hideLoader();
            }
        }
        
        // åŠ è½½æç°è®°å½•
        async function loadWithdrawHistory() {
            try {
                const withdrawHistoryList = document.getElementById('withdrawHistoryList');
                if (!withdrawHistoryList) return;
                
                // è¿™é‡Œåº”è¯¥æœ‰ä¸€ä¸ªè·å–æç°è®°å½•çš„API
                // ç”±äºæ²¡æœ‰å®ç°ï¼Œæš‚æ—¶æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®
                
                // æ¨¡æ‹Ÿæ•°æ®
                const mockWithdrawals = [
                    { date: '2023-07-15', amount: 50, status: 'å·²å®Œæˆ' },
                    { date: '2023-07-01', amount: 30, status: 'å·²å®Œæˆ' }
                ];
                
                if (mockWithdrawals.length === 0) {
                    withdrawHistoryList.innerHTML = '<div style="text-align: center; color: #666;">æš‚æ— æç°è®°å½•</div>';
                    return;
                }
                
                withdrawHistoryList.innerHTML = '';
                
                mockWithdrawals.forEach(withdrawal => {
                    const item = document.createElement('div');
                    item.className = 'withdraw-history-item';
                    item.innerHTML = `
                        <div class="withdraw-history-date">${withdrawal.date}</div>
                        <div class="withdraw-history-amount">${withdrawal.amount}å…ƒ</div>
                        <div class="withdraw-history-status ${withdrawal.status === 'å·²å®Œæˆ' ? 'completed' : 'pending'}">
                            ${withdrawal.status}
                        </div>
                    `;
                    withdrawHistoryList.appendChild(item);
                });
            } catch (error) {
                handleError(error, 'åŠ è½½æç°è®°å½•å¤±è´¥');
            }
        }
        
        // åˆ†äº«åˆ°Telegram
        function shareToTelegram() {
            const text = `æˆ‘åœ¨ç©ä¸‡èŠ±æ¥¼æ¶ˆæ¶ˆä¹ï¼Œå¿«æ¥ä¸€èµ·ç©å§ï¼\nhttps://beijingshunyi.github.io/game-web/?user_id=${currentUser.telegram_id}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(text)}`;
            
            window.open(url, '_blank');
            
            // å‡è®¾åˆ†äº«æˆåŠŸï¼Œå¢åŠ æ¸¸æˆæ¬¡æ•°
            playCount = Math.max(0, playCount - 2);
            document.getElementById('playLimit').style.display = 'none';
            
            alert('åˆ†äº«æˆåŠŸï¼Œè·å¾—2æ¬¡æ¸¸æˆæœºä¼šï¼');
        }
        
        // è§‚çœ‹å¹¿å‘Š
        function watchAd() {
            // è¿™é‡Œåº”è¯¥æœ‰è§‚çœ‹å¹¿å‘Šçš„é€»è¾‘
            // ç”±äºæ²¡æœ‰å®ç°ï¼Œæ¨¡æ‹Ÿå¹¿å‘Šè§‚çœ‹æµç¨‹
            try {
                const adContainer = document.createElement('div');
                adContainer.className = 'ad-container';
                adContainer.innerHTML = `
                    <div class="ad-content">
                        <div class="ad-title">å¹¿å‘Šè§‚çœ‹</div>
                        <div class="ad-message">æ­£åœ¨æ’­æ”¾å¹¿å‘Š...</div>
                        <div class="ad-countdown">10ç§’åå…³é—­</div>
                        <button class="ad-close-btn" disabled>å…³é—­</button>
                    </div>
                `;
                
                document.body.appendChild(adContainer);
                
                // æ¨¡æ‹Ÿå¹¿å‘Šå€’è®¡æ—¶
                let countdown = 10;
                const countdownEl = adContainer.querySelector('.ad-countdown');
                const closeBtn = adContainer.querySelector('.ad-close-btn');
                
                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = `${countdown}ç§’åå…³é—­`;
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                        closeBtn.disabled = false;
                        closeBtn.textContent = 'å…³é—­';
                    }
                }, 1000);
                
                closeBtn.addEventListener('click', () => {
                    clearInterval(timer);
                    document.body.removeChild(adContainer);
                    
                    // å¢åŠ æ¸¸æˆæ¬¡æ•°
                    playCount = Math.max(0, playCount - 1);
                    const playLimitEl = document.getElementById('playLimit');
                    if (playLimitEl) playLimitEl.style.display = 'none';
                    
                    alert('å¹¿å‘Šè§‚çœ‹å®Œæˆï¼Œè·å¾—1æ¬¡æ¸¸æˆæœºä¼š');
                });
            } catch (error) {
                handleError(error, 'å¹¿å‘Šè§‚çœ‹å¤±è´¥');
            }
        }
        
        // åˆ‡æ¢ä»»åŠ¡æ ‡ç­¾
        function switchTaskTab(tab) {
            const tabs = document.querySelectorAll('.task-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'daily') {
                document.getElementById('dailyTasksList').style.display = 'flex';
                document.getElementById('achievementsList').style.display = 'none';
            } else {
                document.getElementById('dailyTasksList').style.display = 'none';
                document.getElementById('achievementsList').style.display = 'flex';
            }
        }
        
        // åˆ‡æ¢æ’è¡Œæ¦œæ ‡ç­¾
        function switchLeaderboardTab(tab) {
            const tabs = document.querySelectorAll('.leaderboard-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            
            // é‡æ–°åŠ è½½æ’è¡Œæ¦œ
            loadLeaderboard();
        }
    </script>
</body>
</html>
