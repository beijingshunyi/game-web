<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>万花消消乐</title>
    
    <!-- 引入外部资源 -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Phaser游戏引擎 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5B21B6',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                        background: '#F8FAFC',
                        board: '#FFFFFF'
                    },
                    fontFamily: {
                        game: ['"Inter"', '"PingFang SC"', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02)',
                        'button': '0 4px 6px -1px rgba(91, 33, 182, 0.2), 0 2px 4px -1px rgba(91, 33, 182, 0.1)',
                    }
                }
            }
        }
    </script>
    
    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
            }
            .btn-hover:active {
                transform: translateY(0);
            }
            .tile-vanish {
                animation: vanish 0.3s ease-out forwards;
            }
            @keyframes vanish {
                0% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.2); opacity: 0.8; }
                100% { transform: scale(0); opacity: 0; }
            }
            .score-popup {
                animation: scorePopup 0.8s ease-out forwards;
                position: absolute;
                pointer-events: none;
                font-weight: bold;
            }
            @keyframes scorePopup {
                0% { transform: translateY(0); opacity: 1; }
                100% { transform: translateY(-30px); opacity: 0; }
            }
            .modal-transition {
                transition: all 0.3s ease;
            }
        }
    </style>
    
    <!-- 项目配置和初始化 -->
    <script>
        // 配置API基础URL（请替换为你的Cloudflare Worker域名）
        const API_BASE_URL = 'https://your-worker-subdomain.workers.dev';
        
        // 全局游戏数据存储
        window.gameData = {
            user: null,
            isAuthenticated: false,
            currentLevel: 1,
            gameSession: null,
            defaultHeaders: {}
        };
        
        // 游戏配置
        const GAME_CONFIG = {
            rows: 8,
            cols: 8,
            tileTypes: [
                { color: '#6366F1', icon: 'diamond' },
                { color: '#EC4899', icon: 'heart' },
                { color: '#F59E0B', icon: 'star' },
                { color: '#10B981', icon: 'leaf' },
                { color: '#EF4444', icon: 'bolt' },
                { color: '#3B82F6', icon: 'snowflake-o' },
                { color: '#8B5CF6', icon: 'moon-o' }
            ],
            timeLimit: 60,
            baseScore: 10,
            comboMultiplier: 1.5
        };
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 初始化Telegram WebApp
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.BackButton.hide();
                
                // 获取initData并登录
                const initData = tg.initData;
                if (!initData) {
                    showError('无法获取Telegram身份信息');
                    return;
                }
                
                await loginWithTelegram(initData);
                
                // 初始化游戏UI
                if (window.gameData.isAuthenticated) {
                    initGameUI();
                    // 初始化Phaser游戏
                    initPhaserGame();
                }
                
            } catch (error) {
                console.error('初始化错误:', error);
                showError('游戏初始化失败，请重试');
            }
        });
        
        // Telegram登录函数
        async function loginWithTelegram(initData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ initData })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '登录失败');
                }
                
                // 存储用户数据
                window.gameData.user = data.user;
                window.gameData.isAuthenticated = true;
                window.gameData.defaultHeaders = {
                    'Content-Type': 'application/json',
                    'X-Telegram-User-ID': data.user.tg_id
                };
                
                // 获取用户完整信息
                await getUserData();
                
                console.log('登录成功', data.user);
                return data.user;
                
            } catch (error) {
                console.error('登录错误:', error);
                showError(error.message);
                throw error;
            }
        }
        
        // 获取用户数据
        async function getUserData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user`, {
                    method: 'GET',
                    headers: window.gameData.defaultHeaders
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '获取用户数据失败');
                }
                
                window.gameData.user = data.user;
                window.gameData.rank = data.rank;
                
                updateGameInfoUI();
                return data;
                
            } catch (error) {
                console.error('获取用户数据错误:', error);
                showError(error.message);
                throw error;
            }
        }
        
        // 显示提示消息
        function showMessage(message, type = 'error') {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            
            messageDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 modal-transition`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        // 初始化游戏UI
        function initGameUI() {
            const infoBar = document.getElementById('gameInfoBar');
            infoBar.style.display = 'flex';
            
            // 更新UI数据
            updateGameInfoUI();
            
            // 绑定按钮事件
            bindButtonEvents();
            
            // 加载排行榜数据
            loadLeaderboard();
        }
        
        // 更新游戏信息UI
        function updateGameInfoUI() {
            const user = window.gameData.user;
            if (!user) return;
            
            document.getElementById('coinsDisplay').textContent = user.coins;
            document.getElementById('energyDisplay').textContent = user.energy;
            document.getElementById('levelDisplay').textContent = user.max_level;
            document.getElementById('rankDisplay').textContent = window.gameData.rank || '--';
            
            // 更新提现模态框余额
            document.getElementById('withdrawBalance').textContent = 
                `${user.coins}个"万花币"`;
            
            // 更新提现按钮状态
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (user.coins >= 1000) {
                withdrawBtn.disabled = false;
                withdrawBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                withdrawBtn.disabled = true;
                withdrawBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // 绑定按钮事件
        function bindButtonEvents() {
            // 签到按钮
            document.getElementById('signInBtn').addEventListener('click', signIn);
            
            // 看广告按钮
            document.getElementById('watchAdBtn').addEventListener('click', watchAd);
            
            // 分享按钮
            document.getElementById('shareBtn').addEventListener('click', shareGame);
            
            // 提现按钮
            document.getElementById('withdrawBtn').addEventListener('click', openWithdrawModal);
            
            // 关闭提现模态框
            document.getElementById('closeWithdrawModal').addEventListener('click', closeWithdrawModal);
            
            // 提交提现申请
            document.getElementById('submitWithdrawBtn').addEventListener('click', submitWithdrawRequest);
        }
        
        // 签到功能
        async function signIn() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/sign`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '签到失败');
                }
                
                // 更新用户数据
                window.gameData.user.coins = data.total_coins;
                window.gameData.user.sign_streak = data.sign_streak;
                window.gameData.user.last_sign_date = data.last_sign_date;
                
                updateGameInfoUI();
                showSuccess(`签到成功！获得${data.coins_earned}个"万花币"，连续签到${data.sign_streak}天`);
                
            } catch (error) {
                console.error('签到错误:', error);
                showError(error.message);
            }
        }
        
        // 看广告功能
        async function watchAd() {
            try {
                // 模拟广告播放（实际项目中替换为真实广告SDK）
                const adConfirmed = confirm('广告播放完成，是否领取奖励？');
                if (!adConfirmed) return;
                
                const response = await fetch(`${API_BASE_URL}/api/watch-ad`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '领取奖励失败');
                }
                
                // 更新用户数据
                window.gameData.user.coins = data.total_coins;
                window.gameData.user.energy = data.total_energy;
                
                updateGameInfoUI();
                showSuccess(`获得${data.coins_earned}个"万花币"和${data.energy_earned}点体力`);
                
            } catch (error) {
                console.error('看广告错误:', error);
                showError(error.message);
            }
        }
        
        // 分享游戏功能
        async function shareGame() {
            try {
                const tg = window.Telegram.WebApp;
                
                // 使用Telegram内置分享功能
                tg.Share.shareText(
                    `我在万花消消乐中已经玩到第${window.gameData.user.max_level}关啦，快来挑战我！`,
                    '万花消消乐'
                );
                
                const response = await fetch(`${API_BASE_URL}/api/share`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '领取分享奖励失败');
                }
                
                // 更新用户数据
                window.gameData.user.coins = data.total_coins;
                window.gameData.user.energy = data.total_energy;
                
                updateGameInfoUI();
                showSuccess(`分享成功！获得${data.coins_earned}个"万花币"和${data.energy_earned}点体力`);
                
            } catch (error) {
                console.error('分享错误:', error);
                showError(error.message);
            }
        }
        
        // 提现相关功能
        function openWithdrawModal() {
            const user = window.gameData.user;
            if (!user) return;
            
            // 填充已有信息
            if (user.alipay_account) {
                document.getElementById('alipayAccount').value = user.alipay_account;
            }
            if (user.real_name) {
                document.getElementById('realName').value = user.real_name;
            }
            
            // 显示模态框
            document.getElementById('withdrawModal').classList.add('active');
        }
        
        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.remove('active');
        }
        
        async function submitWithdrawRequest() {
            try {
                const alipayAccount = document.getElementById('alipayAccount').value.trim();
                const realName = document.getElementById('realName').value.trim();
                
                if (!alipayAccount) {
                    showError('请输入支付宝账号');
                    return;
                }
                
                if (!realName) {
                    showError('请输入真实姓名');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/withdraw/request`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id,
                        alipay_account: alipayAccount,
                        real_name: realName
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '提现申请失败');
                }
                
                // 更新用户数据
                window.gameData.user.coins = data.remaining_coins;
                
                updateGameInfoUI();
                closeWithdrawModal();
                
                showSuccess(`提现申请提交成功！\n金额：${data.amount}个"万花币"\n预计12小时内到账`);
                
            } catch (error) {
                console.error('提现错误:', error);
                showError(error.message);
            }
        }
        
        // 加载排行榜数据
        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/leaderboard`, {
                    method: 'GET',
                    headers: window.gameData.defaultHeaders
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '获取排行榜失败');
                }
                
                window.gameData.leaderboard = data.leaderboard;
                console.log('排行榜数据', data.leaderboard);
                
            } catch (error) {
                console.error('加载排行榜错误:', error);
            }
        }
        
        // 游戏开始前调用API验证
        async function startGameLevel(levelId) {
            try {
                if (!window.gameData.isAuthenticated) {
                    showError('请先登录');
                    return false;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/game/start`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id,
                        level_id: levelId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '无法开始游戏');
                }
                
                // 更新用户体力
                window.gameData.user.energy = data.remaining_energy;
                updateGameInfoUI();
                
                window.gameData.currentLevel = levelId;
                showSuccess(`开始第${levelId}关！`);
                return true;
                
            } catch (error) {
                console.error('开始游戏错误:', error);
                showError(error.message);
                
                if (error.message.includes('体力不足')) {
                    if (confirm('体力不足，是否观看广告补充体力？')) {
                        watchAd();
                    }
                }
                
                return false;
            }
        }
        
        // 游戏结束时调用API
        async function endGameLevel(score, isSuccess) {
            try {
                if (!window.gameData.isAuthenticated) {
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/game/end`, {
                    method: 'POST',
                    headers: window.gameData.defaultHeaders,
                    body: JSON.stringify({
                        tg_id: window.gameData.user.tg_id,
                        level_id: window.gameData.currentLevel,
                        score: score,
                        is_success: isSuccess
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '游戏记录失败');
                }
                
                // 更新用户数据
                window.gameData.user.coins = data.total_coins;
                window.gameData.user.max_level = data.max_level;
                updateGameInfoUI();
                
                if (isSuccess) {
                    showSuccess(`通关成功！获得${data.coins_earned}个"万花币"`);
                } else {
                    showError('挑战失败，请重试');
                }
                
            } catch (error) {
                console.error('结束游戏错误:', error);
                showError(error.message);
            }
        }
        
        // Phaser游戏初始化
        function initPhaserGame() {
            const config = {
                type: Phaser.AUTO,
                width: Math.min(window.innerWidth - 20, 500),
                height: Math.min(window.innerWidth - 20, 500),
                parent: 'gameContainer',
                backgroundColor: '#F8FAFC',
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                },
                scale: {
                    mode: Phaser.Scale.FIT,
                    autoCenter: Phaser.Scale.CENTER_BOTH
                }
            };
            
            const game = new Phaser.Game(config);
            
            // 游戏状态
            let gameState = {
                board: [],
                score: 0,
                timeLeft: GAME_CONFIG.timeLimit,
                selectedTile: null,
                isProcessing: false,
                combo: 0,
                timerEvent: null
            };
            
            // 预加载资源
            function preload() {
                // 加载图标（使用Font Awesome，无需额外加载图片）
                this.load.html('tileTemplate', '<div class="w-full h-full flex items-center justify-center rounded-lg"></div>');
            }
            
            // 创建游戏场景
            function create() {
                // 创建分数显示
                this.scoreText = this.add.text(10, 10, `得分: 0`, { 
                    fontSize: '16px', 
                    fill: '#5B21B6',
                    fontWeight: 'bold',
                    backgroundColor: 'rgba(255,255,255,0.8)',
                    padding: { x: 8, y: 4 },
                    borderRadius: 4
                }).setDepth(10);
                
                // 创建时间显示
                this.timeText = this.add.text(config.width - 10, 10, `时间: ${GAME_CONFIG.timeLimit}s`, { 
                    fontSize: '16px', 
                    fill: '#5B21B6',
                    fontWeight: 'bold',
                    backgroundColor: 'rgba(255,255,255,0.8)',
                    padding: { x: 8, y: 4 },
                    borderRadius: 4
                }).setOrigin(1, 0).setDepth(10);
                
                // 创建关卡显示
                this.levelText = this.add.text(config.width / 2, 10, `关卡: ${window.gameData.currentLevel}`, { 
                    fontSize: '16px', 
                    fill: '#5B21B6',
                    fontWeight: 'bold',
                    backgroundColor: 'rgba(255,255,255,0.8)',
                    padding: { x: 8, y: 4 },
                    borderRadius: 4
                }).setOrigin(0.5, 0).setDepth(10);
                
                // 创建开始按钮
                this.startButton = this.add.text(config.width / 2, config.height / 2, '开始游戏', {
                    fontSize: '24px',
                    fill: '#FFFFFF',
                    fontWeight: 'bold',
                    backgroundColor: '#5B21B6',
                    padding: { x: 20, y: 10 },
                    borderRadius: 8
                }).setOrigin(0.5).setDepth(20).setInteractive();
                
                this.startButton.on('pointerdown', async () => {
                    const canStart = await startGameLevel(window.gameData.currentLevel);
                    if (canStart) {
                        this.startButton.destroy();
                        initGameBoard.call(this);
                        startGameTimer.call(this);
                    }
                });
                
                // 初始化游戏板
                function initGameBoard() {
                    // 计算每个方块的大小
                    const tileSize = Math.floor((config.width - 40) / GAME_CONFIG.cols);
                    const startX = (config.width - (tileSize * GAME_CONFIG.cols)) / 2;
                    const startY = 50;
                    
                    // 初始化游戏板数据
                    gameState.board = [];
                    for (let i = 0; i < GAME_CONFIG.rows; i++) {
                        gameState.board[i] = [];
                        for (let j = 0; j < GAME_CONFIG.cols; j++) {
                            // 确保不会初始就有可消除的组合
                            let validTypes = [...Array(GAME_CONFIG.tileTypes.length).keys()];
                            
                            if (j >= 2 && 
                                gameState.board[i][j-1] === gameState.board[i][j-2]) {
                                validTypes = validTypes.filter(type => type !== gameState.board[i][j-1]);
                            }
                            
                            if (i >= 2 && 
                                gameState.board[i-1][j] === gameState.board[i-2][j]) {
                                validTypes = validTypes.filter(type => type !== gameState.board[i-1][j]);
                            }
                            
                            const typeIndex = validTypes[Math.floor(Math.random() * validTypes.length)];
                            gameState.board[i][j] = typeIndex;
                            
                            // 创建方块
                            createTile.call(this, i, j, typeIndex, tileSize, startX, startY);
                        }
                    }
                }
                
                // 创建方块
                function createTile(row, col, typeIndex, tileSize, startX, startY) {
                    const tileType = GAME_CONFIG.tileTypes[typeIndex];
                    const x = startX + col * tileSize;
                    const y = startY + row * tileSize;
                    
                    // 创建方块背景
                    const tileBg = this.add.rectangle(x + tileSize/2, y + tileSize/2, 
                        tileSize - 4, tileSize - 4, 
                        Phaser.Display.Color.HexStringToColor(tileType.color).color)
                        .setInteractive()
                        .setData('row', row)
                        .setData('col', col)
                        .setData('type', typeIndex)
                        .setDepth(5)
                        .setRadius(8)
                        .setShadow(0, 4, 0x000000, 0.1);
                    
                    // 创建图标（使用Font Awesome）
                    const icon = this.add.dom(x + tileSize/2, y + tileSize/2)
                        .createFromHTML(`<<i class="fa fa-${tileType.icon} text-white text-2xl"></</i>`)
                        .setOrigin(0.5)
                        .setDepth(6);
                    
                    // 存储相关引用
                    tileBg.setData('icon', icon);
                    tileBg.setData('tile', { row, col, typeIndex });
                    
                    // 添加点击事件
                    tileBg.on('pointerdown', handleTileClick.bind(this));
                    
                    // 存储到场景中
                    if (!this.tiles) this.tiles = [];
                    if (!this.tiles[row]) this.tiles[row] = [];
                    this.tiles[row][col] = tileBg;
                }
                
                // 开始游戏计时器
                function startGameTimer() {
                    gameState.timeLeft = GAME_CONFIG.timeLimit;
                    gameState.timerEvent = this.time.addEvent({
                        delay: 1000,
                        callback: updateTimer,
                        callbackScope: this,
                        loop: true
                    });
                    
                    function updateTimer() {
                        gameState.timeLeft--;
                        this.timeText.setText(`时间: ${gameState.timeLeft}s`);
                        
                        // 时间少于10秒时变红
                        if (gameState.timeLeft <= 10) {
                            this.timeText.setFill('#EF4444');
                        }
                        
                        if (gameState.timeLeft <= 0) {
                            gameState.timerEvent.remove();
                            endGame.call(this, false);
                        }
                    }
                }
                
                // 处理方块点击
                function handleTileClick(pointer, localX, localY) {
                    if (gameState.isProcessing) return;
                    
                    const tile = this;
                    const row = tile.getData('row');
                    const col = tile.getData('col');
                    
                    // 取消之前的选择
                    if (gameState.selectedTile) {
                        const prevTile = this.tiles[gameState.selectedTile.row][gameState.selectedTile.col];
                        prevTile.setScale(1);
                        prevTile.setShadow(0, 4, 0x000000, 0.1);
                    }
                    
                    // 选中当前方块
                    if (!gameState.selectedTile || 
                        (gameState.selectedTile.row !== row || gameState.selectedTile.col !== col)) {
                        gameState.selectedTile = { row, col };
                        tile.setScale(1.1);
                        tile.setShadow(0, 6, 0x000000, 0.2);
                        return;
                    }
                    
                    // 点击了已选中的方块，取消选择
                    gameState.selectedTile = null;
                    tile.setScale(1);
                    tile.setShadow(0, 4, 0x000000, 0.1);
                }
            }
            
            // 游戏更新
            function update(time, delta) {
                // 处理方块交换（通过键盘或其他方式）
                // 这里简化处理，实际项目中可以添加交换逻辑
            }
            
            // 结束游戏
            function endGame(isSuccess) {
                gameState.isProcessing = true;
                
                // 停止计时器
                if (gameState.timerEvent) {
                    gameState.timerEvent.remove();
                }
                
                // 调用API记录游戏结果
                endGameLevel(gameState.score, isSuccess);
                
                // 显示结果
                const resultText = isSuccess ? '通关成功！' : '游戏结束！';
                const resultColor = isSuccess ? '#10B981' : '#EF4444';
                
                const resultBox = this.add.rectangle(config.width / 2, config.height / 2, 
                    300, 200, 0xFFFFFF, 0.9)
                    .setDepth(30)
                    .setRadius(12)
                    .setShadow(0, 10, 0x000000, 0.2);
                
                const resultTitle = this.add.text(config.width / 2, config.height / 2 - 40, resultText, {
                    fontSize: '24px',
                    fill: resultColor,
                    fontWeight: 'bold'
                }).setOrigin(0.5).setDepth(31);
                
                const scoreText = this.add.text(config.width / 2, config.height / 2, 
                    `最终得分: ${gameState.score}`, {
                    fontSize: '18px',
                    fill: '#333333'
                }).setOrigin(0.5).setDepth(31);
                
                const restartButton = this.add.text(config.width / 2, config.height / 2 + 40, '再来一局', {
                    fontSize: '18px',
                    fill: '#FFFFFF',
                    backgroundColor: '#5B21B6',
                    padding: { x: 20, y: 8 },
                    borderRadius: 8
                }).setOrigin(0.5).setDepth(31).setInteractive();
                
                restartButton.on('pointerdown', async () => {
                    const canStart = await startGameLevel(window.gameData.currentLevel);
                    if (canStart) {
                        // 清除当前场景
                        this.children.removeAll();
                        gameState = {
                            board: [],
                            score: 0,
                            timeLeft: GAME_CONFIG.timeLimit,
                            selectedTile: null,
                            isProcessing: false,
                            combo: 0,
                            timerEvent: null
                        };
                        // 重新创建游戏
                        create.call(this);
                    }
                });
            }
        }
    </script>
</head>
<body class="bg-background font-game text-gray-800 overflow-x-hidden">
    <!-- 游戏信息栏 -->
    <div id="gameInfoBar" class="flex justify-between items-center p-3 bg-white rounded-xl shadow-card mb-3" style="display: none;">
        <div class="flex flex-col items-center px-2">
            <div class="text-xs text-gray-500 mb-1">万花币</div>
            <div id="coinsDisplay" class="text-lg font-bold text-primary">0</div>
        </div>
        
        <div class="flex flex-col items-center px-2">
            <div class="text-xs text-gray-500 mb-1">体力</div>
            <div id="energyDisplay" class="text-lg font-bold text-primary">0</div>
        </div>
        
        <div class="flex flex-col items-center px-2">
            <div class="text-xs text-gray-500 mb-1">关卡</div>
            <div id="levelDisplay" class="text-lg font-bold text-primary">1</div>
        </div>
        
        <div class="flex flex-col items-center px-2">
            <div class="text-xs text-gray-500 mb-1">排名</div>
            <div class="text-lg font-bold text-primary">
                <span id="rankDisplay">--</span>
                <span class="text-xs bg-accent text-white px-1.5 py-0.5 rounded-full ml-1">#</span>
            </div>
        </div>
        
        <button id="signInBtn" class="bg-primary text-white px-3 py-1.5 rounded-lg text-sm font-medium shadow-button btn-hover">
            <<i class="fa fa-calendar-check-o mr-1"></</i>签到
        </button>
        
        <button id="watchAdBtn" class="bg-secondary text-white px-3 py-1.5 rounded-lg text-sm font-medium shadow-button btn-hover">
            <<i class="fa fa-play-circle-o mr-1"></</i>看广告
        </button>
        
        <button id="shareBtn" class="bg-accent text-white px-3 py-1.5 rounded-lg text-sm font-medium shadow-button btn-hover">
            <<i class="fa fa-share-alt mr-1"></</i>分享
        </button>
        
        <button id="withdrawBtn" class="bg-success text-white px-3 py-1.5 rounded-lg text-sm font-medium shadow-button btn-hover">
            <<i class="fa fa-money mr-1"></</i>提现
        </button>
    </div>
    
    <!-- 游戏容器 -->
    <div id="gameContainer" class="w-full"></div>
    
    <!-- 提现模态框 -->
    <div id="withdrawModal" class="fixed inset-0 bg-black/50 flex justify-center items-center z-50 modal-transition opacity-0 invisible">
        <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-md p-5 modal-transition transform translate-y-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">申请提现</h3>
                <button id="closeWithdrawModal" class="text-gray-500 text-xl">
                    <<i class="fa fa-times"></</i>
                </button>
            </div>
            
            <div class="text-sm text-gray-600 mb-4">
                <p>最低提现金额：1000个"万花币"（约10元人民币）</p>
                <p>提现后12小时内到账，请注意查收</p>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">支付宝账号</label>
                <input type="text" id="alipayAccount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请输入支付宝账号">
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">真实姓名</label>
                <input type="text" id="realName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请输入真实姓名（与支付宝一致）">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">当前余额</label>
                <div id="withdrawBalance" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 cursor-default">
                    0个"万花币"
                </div>
            </div>
            
            <button id="submitWithdrawBtn" class="w-full bg-primary text-white py-2.5 rounded-lg font-medium shadow-button btn-hover">
                提交提现申请
            </button>
        </div>
    </div>
    
    <!-- 页脚信息 -->
    <footer class="text-center text-gray-500 text-sm py-4 mt-4">
        <p>本游戏由北京修车【万花楼】赞助</p>
        <p class="mt-1">由 <a href="https://t.me/bjxc010" target="_blank" class="text-primary hover:underline">@bjxc010</a> 开发</p>
    </footer>
    
    <!-- 模态框样式补充 -->
    <style>
        #withdrawModal.active {
            opacity: 1;
            visibility: visible;
        }
        #withdrawModal.active .modal-transition {
            transform: translateY(0);
        }
    </style>
</body>
</html>
