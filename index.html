<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram监听系统管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold">Telegram监听系统</h1>
            <div id="status-indicator" class="flex items-center">
                <span id="status-text" class="mr-2">未连接</span>
                <span id="status-dot" class="w-3 h-3 rounded-full bg-red-500"></span>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="flex flex-wrap -mx-4">
            <!-- 侧边栏 -->
            <div class="w-full md:w-1/4 px-4 mb-6 md:mb-0">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <ul class="space-y-2">
                        <li>
                            <a href="#dashboard" class="nav-link block p-2 hover:bg-blue-100 rounded-md active">
                                <i class="fa fa-tachometer mr-2"></i>仪表盘
                            </a>
                        </li>
                        <li>
                            <a href="#keywords" class="nav-link block p-2 hover:bg-blue-100 rounded-md">
                                <i class="fa fa-tags mr-2"></i>关键词管理
                            </a>
                        </li>
                        <li>
                            <a href="#responses" class="nav-link block p-2 hover:bg-blue-100 rounded-md">
                                <i class="fa fa-reply mr-2"></i>回复内容
                            </a>
                        </li>
                        <li>
                            <a href="#channels" class="nav-link block p-2 hover:bg-blue-100 rounded-md">
                                <i class="fa fa-sitemap mr-2"></i>频道管理
                            </a>
                        </li>
                        <li>
                            <a href="#logs" class="nav-link block p-2 hover:bg-blue-100 rounded-md">
                                <i class="fa fa-history mr-2"></i>监听日志
                            </a>
                        </li>
                        <li>
                            <a href="#settings" class="nav-link block p-2 hover:bg-blue-100 rounded-md">
                                <i class="fa fa-cog mr-2"></i>系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="w-full md:w-3/4 px-4">
                <!-- 仪表盘 -->
                <div id="dashboard-section" class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6">仪表盘</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-blue-600 font-semibold mb-2">活跃关键词</h3>
                            <p id="keyword-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-green-600 font-semibold mb-2">监控频道</h3>
                            <p id="channel-count" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-purple-600 font-semibold mb-2">今日回复</h3>
                            <p id="response-count" class="text-3xl font-bold">0</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">最近活动</h3>
                        <div id="recent-activity" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- 活动内容将通过JS加载 -->
                            <p class="text-gray-500 italic">加载中...</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-4">回复统计</h3>
                        <canvas id="response-chart" height="200"></canvas>
                    </div>
                </div>

                <!-- 关键词管理 -->
                <div id="keywords-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">关键词管理</h2>
                        <button id="add-keyword-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fa fa-plus mr-1"></i> 添加关键词
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left">关键词</th>
                                    <th class="px-4 py-3 text-left">添加时间</th>
                                    <th class="px-4 py-3 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="keywords-table-body">
                                <!-- 关键词内容将通过JS加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 回复内容 -->
                <div id="responses-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h2 class="text-2xl font-bold mb-6">回复内容管理</h2>
                    
                    <div class="mb-6">
                        <textarea id="response-content" class="w-full p-3 border border-gray-300 rounded-md h-60" placeholder="输入回复内容..."></textarea>
                    </div>
                    
                    <button id="save-response-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        <i class="fa fa-save mr-1"></i> 保存回复内容
                    </button>
                </div>

                <!-- 频道管理 -->
                <div id="channels-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">频道管理</h2>
                        <button id="add-channel-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fa fa-plus mr-1"></i> 添加频道
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left">频道用户名</th>
                                    <th class="px-4 py-3 text-left">状态</th>
                                    <th class="px-4 py-3 text-left">添加时间</th>
                                    <th class="px-4 py-3 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody id="channels-table-body">
                                <!-- 频道内容将通过JS加载 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 监听日志 -->
                <div id="logs-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">监听日志</h2>
                        <div>
                            <input type="text" id="log-search" placeholder="搜索..." class="px-3 py-1 border border-gray-300 rounded-md">
                            <button id="clear-logs-btn" class="bg-red-600 text-white px-4 py-1 rounded-md hover:bg-red-700 ml-2">
                                <i class="fa fa-trash mr-1"></i> 清空日志
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-3 text-left">时间</th>
                                    <th class="px-4 py-3 text-left">频道</th>
                                    <th class="px-4 py-3 text-left">用户</th>
                                    <th class="px-4 py-3 text-left">关键词</th>
                                    <th class="px-4 py-3 text-left">状态</th>
                                </tr>
                            </thead>
                            <tbody id="logs-table-body">
                                <!-- 日志内容将通过JS加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between">
                        <button id="prev-page" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 disabled:opacity-50" disabled>
                            <i class="fa fa-chevron-left mr-1"></i> 上一页
                        </button>
                        <span id="page-info">第 1 页</span>
                        <button id="next-page" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">
                            下一页 <i class="fa fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>

                <!-- 系统设置 -->
                <div id="settings-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                    <h2 class="text-2xl font-bold mb-6">系统设置</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-gray-700 mb-2">监听频率 (秒)</label>
                            <input type="number" id="check-interval" class="w-full p-2 border border-gray-300 rounded-md" min="1" value="5">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">相同用户再次回复间隔 (分钟)</label>
                            <input type="number" id="user-cooldown" class="w-full p-2 border border-gray-300 rounded-md" min="1" value="60">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">最大日志保留天数</label>
                            <input type="number" id="log-retention" class="w-full p-2 border border-gray-300 rounded-md" min="1" value="30">
                        </div>
                        
                        <button id="save-settings-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            <i class="fa fa-save mr-1"></i> 保存设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 id="modal-title" class="text-xl font-bold mb-4">添加关键词</h3>
            <div id="modal-content">
                <input type="text" id="modal-input" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="输入内容...">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="modal-cancel" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100">取消</button>
                <button id="modal-save" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 配置
        const SUPABASE_URL = 'https://ylnfjlltesnlfanrxfoy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsbmZqbGx0ZXNubGZhbnJ4Zm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDc0MjMsImV4cCI6MjA3MTY4MzQyM30.czuQwYoFd7Ew9f-PBaojhsWJkXrBEtkqTRdhfX-DWFk';
        const WORKER_URL = 'https://wanhua-game.bingkuijing.workers.dev/';
        
        // Supabase客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 当前页码
        let currentPage = 1;
        const itemsPerPage = 20;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化导航
            initNavigation();
            
            // 加载仪表盘数据
            loadDashboardData();
            
            // 初始化图表
            initChart();
            
            // 检查系统状态
            checkSystemStatus();
            
            // 设置定时刷新
            setInterval(() => {
                checkSystemStatus();
                loadDashboardData();
            }, 10000);
            
            // 绑定事件处理程序
            bindEventHandlers();
        });
        
        // 初始化导航
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 更新活跃状态
                    navLinks.forEach(l => l.classList.remove('active', 'bg-blue-100'));
                    link.classList.add('active', 'bg-blue-100');
                    
                    // 显示对应区域
                    const targetId = link.getAttribute('href').substring(1);
                    document.querySelectorAll('div[id$="-section"]').forEach(section => {
                        section.classList.add('hidden');
                    });
                    document.getElementById(`${targetId}-section`).classList.remove('hidden');
                    
                    // 加载对应数据
                    if (targetId === 'keywords') loadKeywords();
                    if (targetId === 'responses') loadResponse();
                    if (targetId === 'channels') loadChannels();
                    if (targetId === 'logs') loadLogs();
                    if (targetId === 'settings') loadSettings();
                });
            });
        }
        
        // 绑定事件处理程序
        function bindEventHandlers() {
            // 添加关键词按钮
            document.getElementById('add-keyword-btn').addEventListener('click', () => {
                openModal('添加关键词', 'keyword');
            });
            
            // 添加频道按钮
            document.getElementById('add-channel-btn').addEventListener('click', () => {
                openModal('添加频道', 'channel');
            });
            
            // 保存回复按钮
            document.getElementById('save-response-btn').addEventListener('click', saveResponse);
            
            // 保存设置按钮
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            
            // 清空日志按钮
            document.getElementById('clear-logs-btn').addEventListener('click', clearLogs);
            
            // 模态框取消按钮
            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            
            // 模态框保存按钮
            document.getElementById('modal-save').addEventListener('click', saveModalData);
            
            // 日志分页按钮
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadLogs();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                currentPage++;
                loadLogs();
            });
            
            // 日志搜索
            document.getElementById('log-search').addEventListener('input', (e) => {
                currentPage = 1;
                loadLogs(e.target.value);
            });
        }
        
        // 打开模态框
        function openModal(title, type) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-input').value = '';
            document.getElementById('modal').dataset.type = type;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal-input').focus();
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }
        
        // 保存模态框数据
        function saveModalData() {
            const type = document.getElementById('modal').dataset.type;
            const value = document.getElementById('modal-input').value.trim();
            
            if (!value) {
                alert('请输入内容');
                return;
            }
            
            if (type === 'keyword') {
                addKeyword(value);
            } else if (type === 'channel') {
                addChannel(value);
            }
            
            closeModal();
        }
        
        // 检查系统状态
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${WORKER_URL}/status`);
                const data = await response.json();
                
                const statusDot = document.getElementById('status-dot');
                const statusText = document.getElementById('status-text');
                
                if (data.status === 'running') {
                    statusDot.className = 'w-3 h-3 rounded-full bg-green-500';
                    statusText.textContent = '运行中';
                } else {
                    statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
                    statusText.textContent = '已停止';
                }
            } catch (error) {
                console.error('检查系统状态失败:', error);
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 加载关键词数量
                const { count: keywordCount } = await supabase
                    .from('keywords')
                    .select('*', { count: 'exact', head: true });
                
                document.getElementById('keyword-count').textContent = keywordCount || 0;
                
                // 加载频道数量
                const { count: channelCount } = await supabase
                    .from('channels')
                    .select('*', { count: 'exact', head: true })
                    .eq('is_active', true);
                
                document.getElementById('channel-count').textContent = channelCount || 0;
                
                // 加载今日回复数量
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const { count: responseCount } = await supabase
                    .from('logs')
                    .select('*', { count: 'exact', head: true })
                    .eq('response_sent', true)
                    .gte('created_at', today.toISOString());
                
                document.getElementById('response-count').textContent = responseCount || 0;
                
                // 加载最近活动
                const { data: recentLogs } = await supabase
                    .from('logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                const activityContainer = document.getElementById('recent-activity');
                activityContainer.innerHTML = '';
                
                if (recentLogs && recentLogs.length > 0) {
                    recentLogs.forEach(log => {
                        const date = new Date(log.created_at);
                        const formattedDate = date.toLocaleString();
                        
                        const statusText = log.response_sent ? 
                            '<span class="text-green-600">已回复</span>' : 
                            '<span class="text-gray-500">已检测</span>';
                        
                        const activityItem = document.createElement('div');
                        activityItem.className = 'p-2 border-b border-gray-100';
                        activityItem.innerHTML = `
                            <p>${formattedDate} - 在 <strong>${log.channel_username}</strong> 中检测到关键词 <strong>${log.matched_keyword}</strong></p>
                            <p>用户: ${log.user_username || log.user_id} - ${statusText}</p>
                        `;
                        
                        activityContainer.appendChild(activityItem);
                    });
                } else {
                    activityContainer.innerHTML = '<p class="text-gray-500 italic">暂无活动记录</p>';
                }
                
                // 更新图表数据
                updateChart();
                
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('response-chart').getContext('2d');
            
            window.responseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '回复数量',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        // 更新图表数据
        async function updateChart() {
            try {
                // 获取过去7天的数据
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                
                const { data } = await supabase
                    .from('logs')
                    .select(`
                        created_at::date as date,
                        count(*) as count
                    `)
                    .eq('response_sent', true)
                    .gte('created_at', sevenDaysAgo.toISOString())
                    .groupBy('date')
                    .order('date');
                
                const labels = [];
                const counts = [];
                
                // 填充过去7天的日期
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString());
                    
                    // 查找对应日期的数据
                    const dayData = data.find(item => item.date === dateStr);
                    counts.push(dayData ? dayData.count : 0);
                }
                
                // 更新图表
                window.responseChart.data.labels = labels;
                window.responseChart.data.datasets[0].data = counts;
                window.responseChart.update();
                
            } catch (error) {
                console.error('更新图表数据失败:', error);
            }
        }
        
        // 加载关键词
        async function loadKeywords() {
            try {
                const { data } = await supabase
                    .from('keywords')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const tableBody = document.getElementById('keywords-table-body');
                tableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(keyword => {
                        const date = new Date(keyword.created_at);
                        const formattedDate = date.toLocaleString();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3">${keyword.word}</td>
                            <td class="px-4 py-3">${formattedDate}</td>
                            <td class="px-4 py-3">
                                <button class="text-red-600 hover:text-red-800 delete-keyword" data-id="${keyword.id}">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // 绑定删除事件
                    document.querySelectorAll('.delete-keyword').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            deleteKeyword(id);
                        });
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-center text-gray-500">
                                暂无关键词，请添加
                            </td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('加载关键词失败:', error);
            }
        }
        
        // 添加关键词
        async function addKeyword(word) {
            try {
                const { error } = await supabase
                    .from('keywords')
                    .insert([{ word }]);
                
                if (error) throw error;
                
                // 重新加载关键词列表
                loadKeywords();
                
                // 通知Worker更新关键词
                await fetch(`${WORKER_URL}/refresh-keywords`, { method: 'POST' });
                
            } catch (error) {
                console.error('添加关键词失败:', error);
                alert('添加关键词失败: ' + error.message);
            }
        }
        
        // 删除关键词
        async function deleteKeyword(id) {
            if (!confirm('确定要删除这个关键词吗？')) return;
            
            try {
                const { error } = await supabase
                    .from('keywords')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // 重新加载关键词列表
                loadKeywords();
                
                // 通知Worker更新关键词
                await fetch(`${WORKER_URL}/refresh-keywords`, { method: 'POST' });
                
            } catch (error) {
                console.error('删除关键词失败:', error);
                alert('删除关键词失败: ' + error.message);
            }
        }
        
        // 加载回复内容
        async function loadResponse() {
            try {
                const { data } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('is_active', true)
                    .single();
                
                if (data) {
                    document.getElementById('response-content').value = data.content;
                }
                
            } catch (error) {
                console.error('加载回复内容失败:', error);
            }
        }
        
        // 保存回复内容
        async function saveResponse() {
            const content = document.getElementById('response-content').value.trim();
            
            if (!content) {
                alert('回复内容不能为空');
                return;
            }
            
            try {
                // 查找当前活跃的回复
                const { data: activeResponses } = await supabase
                    .from('responses')
                    .select('*')
                    .eq('is_active', true);
                
                if (activeResponses && activeResponses.length > 0) {
                    // 更新现有回复
                    await supabase
                        .from('responses')
                        .update({ content, updated_at: new Date() })
                        .eq('id', activeResponses[0].id);
                } else {
                    // 创建新回复
                    await supabase
                        .from('responses')
                        .insert([{ content }]);
                }
                
                // 通知Worker更新回复内容
                await fetch(`${WORKER_URL}/refresh-response`, { method: 'POST' });
                
                alert('回复内容保存成功');
                
            } catch (error) {
                console.error('保存回复内容失败:', error);
                alert('保存回复内容失败: ' + error.message);
            }
        }
        
        // 加载频道
        async function loadChannels() {
            try {
                const { data } = await supabase
                    .from('channels')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                const tableBody = document.getElementById('channels-table-body');
                tableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(channel => {
                        const date = new Date(channel.created_at);
                        const formattedDate = date.toLocaleString();
                        const statusClass = channel.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
                        const statusText = channel.is_active ? '活跃' : '已停用';
                        const toggleText = channel.is_active ? '停用' : '启用';
                        const toggleIcon = channel.is_active ? 'fa-pause' : 'fa-play';
                        const toggleColor = channel.is_active ? 'text-yellow-600' : 'text-green-600';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3">@${channel.username}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
                            </td>
                            <td class="px-4 py-3">${formattedDate}</td>
                            <td class="px-4 py-3">
                                <button class="mr-2 ${toggleColor} hover:text-blue-800 toggle-channel" data-id="${channel.id}" data-active="${channel.is_active}">
                                    <i class="fa ${toggleIcon}"></i> ${toggleText}
                                </button>
                                <button class="text-red-600 hover:text-red-800 delete-channel" data-id="${channel.id}">
                                    <i class="fa fa-trash"></i> 删除
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // 绑定切换状态事件
                    document.querySelectorAll('.toggle-channel').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            const isActive = e.currentTarget.getAttribute('data-active') === 'true';
                            toggleChannelStatus(id, !isActive);
                        });
                    });
                    
                    // 绑定删除事件
                    document.querySelectorAll('.delete-channel').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            deleteChannel(id);
                        });
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-4 py-3 text-center text-gray-500">
                                暂无频道，请添加
                            </td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('加载频道失败:', error);
            }
        }
        
        // 添加频道
        async function addChannel(username) {
            // 移除可能的@符号
            username = username.replace('@', '').trim();
            
            try {
                const { error } = await supabase
                    .from('channels')
                    .insert([{ username }]);
                
                if (error) throw error;
                
                // 重新加载频道列表
                loadChannels();
                
                // 通知Worker更新频道
                await fetch(`${WORKER_URL}/refresh-channels`, { method: 'POST' });
                
            } catch (error) {
                console.error('添加频道失败:', error);
                alert('添加频道失败: ' + error.message);
            }
        }
        
        // 切换频道状态
        async function toggleChannelStatus(id, isActive) {
            try {
                const { error } = await supabase
                    .from('channels')
                    .update({ is_active: isActive, updated_at: new Date() })
                    .eq('id', id);
                
                if (error) throw error;
                
                // 重新加载频道列表
                loadChannels();
                
                // 通知Worker更新频道
                await fetch(`${WORKER_URL}/refresh-channels`, { method: 'POST' });
                
            } catch (error) {
                console.error('切换频道状态失败:', error);
                alert('切换频道状态失败: ' + error.message);
            }
        }
        
        // 删除频道
        async function deleteChannel(id) {
            if (!confirm('确定要删除这个频道吗？')) return;
            
            try {
                const { error } = await supabase
                    .from('channels')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // 重新加载频道列表
                loadChannels();
                
                // 通知Worker更新频道
                await fetch(`${WORKER_URL}/refresh-channels`, { method: 'POST' });
                
            } catch (error) {
                console.error('删除频道失败:', error);
                alert('删除频道失败: ' + error.message);
            }
        }
        
        // 加载日志
        async function loadLogs(searchText = '') {
            try {
                let query = supabase
                    .from('logs')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage - 1);
                
                // 如果有搜索文本，添加搜索条件
                if (searchText) {
                    query = query.or(
                        `channel_username.ilike.%${searchText}%,` +
                        `user_username.ilike.%${searchText}%,` +
                        `matched_keyword.ilike.%${searchText}%,` +
                        `message_text.ilike.%${searchText}%`
                    );
                }
                
                const { data, count, error } = await query;
                
                if (error) throw error;
                
                const tableBody = document.getElementById('logs-table-body');
                tableBody.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(log => {
                        const date = new Date(log.created_at);
                        const formattedDate = date.toLocaleString();
                        const statusClass = log.response_sent ? 'text-green-600' : 'text-gray-500';
                        const statusText = log.response_sent ? '已回复' : '已检测';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3">${formattedDate}</td>
                            <td class="px-4 py-3">@${log.channel_username}</td>
                            <td class="px-4 py-3">${log.user_username || log.user_id}</td>
                            <td class="px-4 py-3">${log.matched_keyword || '-'}</td>
                            <td class="px-4 py-3"><span class="${statusClass}">${statusText}</span></td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-4 py-3 text-center text-gray-500">
                                暂无日志记录
                            </td>
                        </tr>
                    `;
                }
                
                // 更新分页信息
                document.getElementById('page-info').textContent = `第 ${currentPage} 页`;
                
                // 更新分页按钮状态
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage * itemsPerPage >= count;
                
            } catch (error) {
                console.error('加载日志失败:', error);
            }
        }
        
        // 清空日志
        async function clearLogs() {
            if (!confirm('确定要清空所有日志吗？此操作不可恢复！')) return;
            
            try {
                const { error } = await supabase
                    .from('logs')
                    .delete()
                    .neq('id', ''); // 删除所有记录
                
                if (error) throw error;
                
                // 重新加载日志
                currentPage = 1;
                loadLogs();
                
            } catch (error) {
                console.error('清空日志失败:', error);
                alert('清空日志失败: ' + error.message);
            }
        }
        
        // 加载设置
        async function loadSettings() {
            try {
                const { data } = await supabase
                    .from('settings')
                    .select('*');
                
                if (data && data.length > 0) {
                    const settings = {};
                    data.forEach(setting => {
                        settings[setting.key] = setting.value;
                    });
                    
                    document.getElementById('check-interval').value = settings.check_interval || 5;
                    document.getElementById('user-cooldown').value = settings.user_cooldown || 60;
                    document.getElementById('log-retention').value = settings.log_retention || 30;
                }
                
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }
        
        // 保存设置
        async function saveSettings() {
            const checkInterval = document.getElementById('check-interval').value;
            const userCooldown = document.getElementById('user-cooldown').value;
            const logRetention = document.getElementById('log-retention').value;
            
            if (!checkInterval || !userCooldown || !logRetention) {
                alert('请填写所有设置项');
                return;
            }
            
            try {
                // 先删除现有设置
                await supabase
                    .from('settings')
                    .delete()
                    .neq('id', '');
                
                // 插入新设置
                const { error } = await supabase
                    .from('settings')
                    .insert([
                        { key: 'check_interval', value: checkInterval },
                        { key: 'user_cooldown', value: userCooldown },
                        { key: 'log_retention', value: logRetention }
                    ]);
                
                if (error) throw error;
                
                // 通知Worker更新设置
                await fetch(`${WORKER_URL}/refresh-settings`, { method: 'POST' });
                
                alert('设置保存成功');
                
            } catch (error) {
                console.error('保存设置失败:', error);
                alert('保存设置失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
