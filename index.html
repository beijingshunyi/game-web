<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram监控管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // Tailwind配置 - iOS风格
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007AFF',
                        secondary: '#34C759',
                        danger: '#FF3B30',
                        warning: '#FF9500',
                        gray: {
                            50: '#F9F9F9',
                            100: '#F2F2F7',
                            200: '#E5E5EA',
                            300: '#D1D1D6',
                            400: '#C7C7CC',
                            500: '#AEAEB2',
                            600: '#8E8E93',
                            700: '#636366',
                            800: '#3A3A3C',
                            900: '#1C1C1E',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'ios': '0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24)',
                        'ios-hover': '0 3px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.12)',
                        'ios-button': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    }
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .ios-card {
                @apply bg-white rounded-xl shadow-ios transition-shadow duration-300 hover:shadow-ios-hover overflow-hidden;
            }
            .ios-button {
                @apply bg-primary text-white font-medium py-2 px-4 rounded-lg shadow-ios-button transition-all duration-200 hover:bg-primary/90 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .ios-button-secondary {
                @apply bg-gray-100 text-gray-800 font-medium py-2 px-4 rounded-lg shadow-ios-button transition-all duration-200 hover:bg-gray-200 active:scale-95 focus:outline-none focus:ring-2 focus:ring-gray-300;
            }
            .ios-button-danger {
                @apply bg-danger text-white font-medium py-2 px-4 rounded-lg shadow-ios-button transition-all duration-200 hover:bg-danger/90 active:scale-95 focus:outline-none focus:ring-2 focus:ring-danger/50;
            }
            .ios-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition duration-200;
            }
            .ios-label {
                @apply block text-gray-700 text-sm font-medium mb-1;
            }
            .nav-item {
                @apply flex flex-col items-center justify-center p-3 text-gray-600 hover:text-primary transition-colors duration-200;
            }
            .nav-item.active {
                @apply text-primary;
            }
            .section-title {
                @apply text-xl font-semibold text-gray-800 mb-4;
            }
            .list-item {
                @apply flex items-center justify-between p-3 border-b border-gray-100 last:border-b-0;
            }
            .badge {
                @apply text-xs font-medium px-2 py-1 rounded-full;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 py-3 px-4 sticky top-0 z-10">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-semibold" id="page-title">Telegram监控管理</h1>
            <button id="settings-btn" class="text-gray-600 hover:text-primary transition-colors">
                <i class="fa fa-cog text-xl"></i>
            </button>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 overflow-y-auto">
        <!-- 控制面板页面 -->
        <section id="dashboard-page" class="p-4">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="ios-card p-4">
                    <div class="text-gray-600 text-sm mb-1">监控群组</div>
                    <div class="text-2xl font-semibold" id="group-count">0</div>
                </div>
                <div class="ios-card p-4">
                    <div class="text-gray-600 text-sm mb-1">关键词</div>
                    <div class="text-2xl font-semibold" id="keyword-count">0</div>
                </div>
                <div class="ios-card p-4">
                    <div class="text-gray-600 text-sm mb-1">已发送用户</div>
                    <div class="text-2xl font-semibold" id="sent-users-count">0</div>
                </div>
                <div class="ios-card p-4">
                    <div class="text-gray-600 text-sm mb-1">今日发送</div>
                    <div class="text-2xl font-semibold" id="today-sent-count">0</div>
                </div>
            </div>

            <h2 class="section-title">最近活动</h2>
            <div class="ios-card mb-6">
                <div class="p-3 border-b border-gray-100 bg-gray-50">
                    <div class="font-medium">监控日志</div>
                </div>
                <div id="recent-activity" class="max-h-64 overflow-y-auto">
                    <!-- 活动日志将在这里动态加载 -->
                    <div class="list-item">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 关键词管理页面 -->
        <section id="keywords-page" class="p-4 hidden">
            <h2 class="section-title">监控关键词</h2>
            
            <div class="ios-card mb-6">
                <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div class="font-medium">关键词列表</div>
                    <button id="add-keyword-btn" class="ios-button text-sm py-1">
                        <i class="fa fa-plus mr-1"></i> 添加
                    </button>
                </div>
                <div id="keywords-list" class="max-h-[calc(100vh-220px)] overflow-y-auto">
                    <!-- 关键词列表将在这里动态加载 -->
                    <div class="list-item">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 群组管理页面 -->
        <section id="groups-page" class="p-4 hidden">
            <h2 class="section-title">监控群组</h2>
            
            <div class="ios-card mb-6">
                <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div class="font-medium">群组列表</div>
                    <button id="add-group-btn" class="ios-button text-sm py-1">
                        <i class="fa fa-plus mr-1"></i> 添加
                    </button>
                </div>
                <div id="groups-list" class="max-h-[calc(100vh-220px)] overflow-y-auto">
                    <!-- 群组列表将在这里动态加载 -->
                    <div class="list-item">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 回复消息页面 -->
        <section id="reply-page" class="p-4 hidden">
            <h2 class="section-title">自动回复消息</h2>
            
            <div class="ios-card mb-6">
                <div class="p-4">
                    <label class="ios-label" for="reply-content">回复内容</label>
                    <textarea id="reply-content" class="ios-input h-40" placeholder="输入自动回复的内容..."></textarea>
                    <div class="mt-4 flex justify-end">
                        <button id="save-reply-btn" class="ios-button">保存修改</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 发送记录页面 -->
        <section id="logs-page" class="p-4 hidden">
            <h2 class="section-title">监控与发送记录</h2>
            
            <div class="ios-card mb-6">
                <div class="p-3 border-b border-gray-100 bg-gray-50">
                    <div class="font-medium">发送记录</div>
                </div>
                <div id="send-records-list" class="max-h-[calc(100vh-220px)] overflow-y-auto">
                    <!-- 发送记录将在这里动态加载 -->
                    <div class="list-item">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 已发送用户页面 -->
        <section id="sent-users-page" class="p-4 hidden">
            <h2 class="section-title">已发送用户</h2>
            
            <div class="ios-card mb-6">
                <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <div class="font-medium">用户列表</div>
                    <button id="clear-sent-users-btn" class="ios-button-danger text-sm py-1">
                        <i class="fa fa-trash mr-1"></i> 清空
                    </button>
                </div>
                <div id="sent-users-list" class="max-h-[calc(100vh-220px)] overflow-y-auto">
                    <!-- 已发送用户列表将在这里动态加载 -->
                    <div class="list-item">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 底部导航栏 -->
    <footer class="bg-white border-t border-gray-200 py-2 px-4 sticky bottom-0 z-10">
        <div class="flex justify-around">
            <button class="nav-item active" data-page="dashboard-page">
                <i class="fa fa-tachometer text-xl mb-1"></i>
                <span class="text-xs">控制台</span>
            </button>
            <button class="nav-item" data-page="keywords-page">
                <i class="fa fa-tags text-xl mb-1"></i>
                <span class="text-xs">关键词</span>
            </button>
            <button class="nav-item" data-page="groups-page">
                <i class="fa fa-users text-xl mb-1"></i>
                <span class="text-xs">群组</span>
            </button>
            <button class="nav-item" data-page="reply-page">
                <i class="fa fa-comment text-xl mb-1"></i>
                <span class="text-xs">回复</span>
            </button>
            <button class="nav-item" data-page="logs-page">
                <i class="fa fa-history text-xl mb-1"></i>
                <span class="text-xs">记录</span>
            </button>
        </div>
    </footer>

    <!-- 添加关键词模态框 -->
    <div id="keyword-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="keyword-modal-title">添加关键词</h3>
                <button id="close-keyword-modal" class="text-gray-500 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="ios-label" for="keyword-input">关键词</label>
                <input type="text" id="keyword-input" class="ios-input" placeholder="输入关键词">
            </div>
            <input type="hidden" id="keyword-id">
            <div class="flex justify-end gap-2">
                <button id="cancel-keyword-btn" class="ios-button-secondary">取消</button>
                <button id="save-keyword-btn" class="ios-button">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加群组模态框 -->
    <div id="group-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="group-modal-title">添加群组</h3>
                <button id="close-group-modal" class="text-gray-500 hover:text-gray-800">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="ios-label" for="group-id-input">群组ID</label>
                <input type="text" id="group-id-input" class="ios-input" placeholder="输入群组ID">
            </div>
            <div class="mb-4">
                <label class="ios-label" for="group-name-input">群组名称（可选）</label>
                <input type="text" id="group-name-input" class="ios-input" placeholder="输入群组名称">
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="group-active-input" class="mr-2" checked>
                    <span>启用监控</span>
                </label>
            </div>
            <input type="hidden" id="group-id">
            <div class="flex justify-end gap-2">
                <button id="cancel-group-btn" class="ios-button-secondary">取消</button>
                <button id="save-group-btn" class="ios-button">保存</button>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-5">
            <h3 class="text-lg font-semibold mb-3" id="confirm-title">确认操作</h3>
            <p class="text-gray-600 mb-5" id="confirm-message">您确定要执行此操作吗？</p>
            <input type="hidden" id="confirm-action">
            <input type="hidden" id="confirm-id">
            <div class="flex justify-end gap-2">
                <button id="cancel-confirm-btn" class="ios-button-secondary">取消</button>
                <button id="confirm-btn" class="ios-button-danger">确认</button>
            </div>
        </div>
    </div>

    <!-- 通知提示 -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <script>
        // 配置
        const API_URL = "https://wanhua-game.bingkuijing.workers.dev/api";
        const ADMIN_TOKEN = "your-secure-admin-token"; // 替换为你设置的ADMIN_TOKEN
        
        // DOM元素
        const pages = document.querySelectorAll('main > section');
        const navItems = document.querySelectorAll('.nav-item');
        const pageTitle = document.getElementById('page-title');
        
        // 导航切换
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // 移除所有活动状态
                navItems.forEach(i => i.classList.remove('active'));
                pages.forEach(page => page.classList.add('hidden'));
                
                // 设置当前活动状态
                item.classList.add('active');
                const pageId = item.getAttribute('data-page');
                document.getElementById(pageId).classList.remove('hidden');
                
                // 更新页面标题
                switch(pageId) {
                    case 'dashboard-page':
                        pageTitle.textContent = 'Telegram监控管理';
                        break;
                    case 'keywords-page':
                        pageTitle.textContent = '监控关键词';
                        loadKeywords();
                        break;
                    case 'groups-page':
                        pageTitle.textContent = '监控群组';
                        loadGroups();
                        break;
                    case 'reply-page':
                        pageTitle.textContent = '自动回复消息';
                        loadReplyMessage();
                        break;
                    case 'logs-page':
                        pageTitle.textContent = '监控与发送记录';
                        loadSendRecords();
                        break;
                    case 'sent-users-page':
                        pageTitle.textContent = '已发送用户';
                        loadSentUsers();
                        break;
                }
            });
        });
        
        // API请求函数
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_TOKEN}`
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API请求错误:', error);
                showToast('操作失败，请稍后重试');
                return null;
            }
        }
        
        // 显示提示消息
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }
        
        // 加载控制面板数据
        async function loadDashboard() {
            // 加载群组数量
            const groups = await apiRequest('/groups');
            if (groups) {
                document.getElementById('group-count').textContent = groups.length;
            }
            
            // 加载关键词数量
            const keywords = await apiRequest('/keywords');
            if (keywords) {
                document.getElementById('keyword-count').textContent = keywords.length;
            }
            
            // 加载已发送用户数量
            const sentUsers = await apiRequest('/sent-users');
            if (sentUsers) {
                document.getElementById('sent-users-count').textContent = sentUsers.length;
            }
            
            // 加载最近活动
            const logs = await apiRequest('/monitor-logs');
            if (logs) {
                const activityContainer = document.getElementById('recent-activity');
                activityContainer.innerHTML = '';
                
                if (logs.length === 0) {
                    activityContainer.innerHTML = `
                        <div class="list-item">
                            <div class="text-gray-500">暂无监控记录</div>
                        </div>
                    `;
                    return;
                }
                
                logs.slice(0, 5).forEach(log => {
                    const date = new Date(log.created_at).toLocaleString();
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.innerHTML = `
                        <div>
                            <div class="font-medium">用户 ${log.user_id}</div>
                            <div class="text-sm text-gray-600">匹配关键词: ${log.matched_keywords.join(', ')}</div>
                            <div class="text-xs text-gray-500">${date}</div>
                        </div>
                    `;
                    activityContainer.appendChild(item);
                });
            }
            
            // 计算今日发送数量
            const sendRecords = await apiRequest('/send-records');
            if (sendRecords) {
                const today = new Date().toISOString().split('T')[0];
                const todayCount = sendRecords.filter(record => 
                    record.created_at.startsWith(today) && record.status === 'success'
                ).length;
                document.getElementById('today-sent-count').textContent = todayCount;
            }
        }
        
        // 加载关键词
        async function loadKeywords() {
            const keywords = await apiRequest('/keywords');
            const container = document.getElementById('keywords-list');
            
            if (!keywords) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">加载关键词失败</div>
                    </div>
                `;
                return;
            }
            
            if (keywords.length === 0) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">暂无关键词，请添加</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            keywords.forEach(keyword => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div class="font-medium">${keyword.keyword}</div>
                    <div class="flex gap-2">
                        <button class="edit-keyword-btn text-primary" data-id="${keyword.id}" data-keyword="${keyword.keyword}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-keyword-btn text-danger" data-id="${keyword.id}" data-name="${keyword.keyword}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-keyword-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openKeywordModal(btn.getAttribute('data-id'), btn.getAttribute('data-keyword'));
                });
            });
            
            document.querySelectorAll('.delete-keyword-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openConfirmModal(
                        '删除关键词', 
                        `确定要删除关键词"${btn.getAttribute('data-name')}"吗？`,
                        'delete-keyword',
                        btn.getAttribute('data-id')
                    );
                });
            });
        }
        
        // 打开关键词模态框
        function openKeywordModal(id = null, keyword = '') {
            const modal = document.getElementById('keyword-modal');
            const title = document.getElementById('keyword-modal-title');
            const input = document.getElementById('keyword-input');
            const keywordId = document.getElementById('keyword-id');
            
            if (id) {
                title.textContent = '编辑关键词';
                input.value = keyword;
                keywordId.value = id;
            } else {
                title.textContent = '添加关键词';
                input.value = '';
                keywordId.value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            input.focus();
        }
        
        // 关闭关键词模态框
        function closeKeywordModal() {
            const modal = document.getElementById('keyword-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
        
        // 保存关键词
        async function saveKeyword() {
            const id = document.getElementById('keyword-id').value;
            const keyword = document.getElementById('keyword-input').value.trim();
            
            if (!keyword) {
                showToast('请输入关键词');
                return;
            }
            
            let result;
            if (id) {
                result = await apiRequest(`/keywords/${id}`, 'PUT', { keyword });
            } else {
                result = await apiRequest('/keywords', 'POST', { keyword });
            }
            
            if (result) {
                showToast(id ? '关键词更新成功' : '关键词添加成功');
                closeKeywordModal();
                loadKeywords();
                loadDashboard(); // 刷新控制面板数据
            }
        }
        
        // 删除关键词
        async function deleteKeyword(id) {
            const result = await apiRequest(`/keywords/${id}`, 'DELETE');
            if (result && result.success !== false) {
                showToast('关键词删除成功');
                loadKeywords();
                loadDashboard(); // 刷新控制面板数据
            }
        }
        
        // 加载群组
        async function loadGroups() {
            const groups = await apiRequest('/groups');
            const container = document.getElementById('groups-list');
            
            if (!groups) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">加载群组失败</div>
                    </div>
                `;
                return;
            }
            
            if (groups.length === 0) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">暂无群组，请添加</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            groups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <div class="font-medium">${group.group_name || '未命名群组'}</div>
                        <div class="text-sm text-gray-600">ID: ${group.group_id}</div>
                        <div class="text-xs text-gray-500">
                            ${group.is_active ? 
                                '<span class="badge bg-secondary/20 text-secondary">已启用</span>' : 
                                '<span class="badge bg-gray-200 text-gray-600">已禁用</span>'
                            }
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-group-btn text-primary" 
                            data-id="${group.id}" 
                            data-group-id="${group.group_id}"
                            data-group-name="${group.group_name || ''}"
                            data-active="${group.is_active}">
                            <i class="fa fa-pencil"></i>
                        </button>
                        <button class="delete-group-btn text-danger" 
                            data-id="${group.id}" 
                            data-name="${group.group_name || group.group_id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            // 添加编辑和删除事件监听
            document.querySelectorAll('.edit-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openGroupModal(
                        btn.getAttribute('data-id'),
                        btn.getAttribute('data-group-id'),
                        btn.getAttribute('data-group-name'),
                        btn.getAttribute('data-active') === 'true'
                    );
                });
            });
            
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openConfirmModal(
                        '删除群组', 
                        `确定要删除群组"${btn.getAttribute('data-name')}"吗？`,
                        'delete-group',
                        btn.getAttribute('data-id')
                    );
                });
            });
        }
        
        // 打开群组模态框
        function openGroupModal(id = null, groupId = '', groupName = '', isActive = true) {
            const modal = document.getElementById('group-modal');
            const title = document.getElementById('group-modal-title');
            const groupIdInput = document.getElementById('group-id-input');
            const groupNameInput = document.getElementById('group-name-input');
            const groupActiveInput = document.getElementById('group-active-input');
            const groupIdField = document.getElementById('group-id');
            
            if (id) {
                title.textContent = '编辑群组';
                groupIdInput.value = groupId;
                groupNameInput.value = groupName;
                groupActiveInput.checked = isActive;
                groupIdField.value = id;
            } else {
                title.textContent = '添加群组';
                groupIdInput.value = '';
                groupNameInput.value = '';
                groupActiveInput.checked = true;
                groupIdField.value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            groupIdInput.focus();
        }
        
        // 关闭群组模态框
        function closeGroupModal() {
            const modal = document.getElementById('group-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
        
        // 保存群组
        async function saveGroup() {
            const id = document.getElementById('group-id').value;
            const groupId = document.getElementById('group-id-input').value.trim();
            const groupName = document.getElementById('group-name-input').value.trim();
            const isActive = document.getElementById('group-active-input').checked;
            
            if (!groupId) {
                showToast('请输入群组ID');
                return;
            }
            
            if (!/^-?\d+$/.test(groupId)) {
                showToast('群组ID必须是数字');
                return;
            }
            
            let result;
            const data = {
                group_id: parseInt(groupId),
                group_name: groupName,
                is_active: isActive
            };
            
            if (id) {
                result = await apiRequest(`/groups/${id}`, 'PUT', data);
            } else {
                result = await apiRequest('/groups', 'POST', data);
            }
            
            if (result) {
                showToast(id ? '群组更新成功' : '群组添加成功');
                closeGroupModal();
                loadGroups();
                loadDashboard(); // 刷新控制面板数据
            }
        }
        
        // 删除群组
        async function deleteGroup(id) {
            const result = await apiRequest(`/groups/${id}`, 'DELETE');
            if (result && result.success !== false) {
                showToast('群组删除成功');
                loadGroups();
                loadDashboard(); // 刷新控制面板数据
            }
        }
        
        // 加载回复消息
        async function loadReplyMessage() {
            const message = await apiRequest('/reply-message');
            const textarea = document.getElementById('reply-content');
            
            if (message && message.content) {
                textarea.value = message.content;
            } else {
                textarea.value = '';
                showToast('加载回复消息失败');
            }
        }
        
        // 保存回复消息
        async function saveReplyMessage() {
            const content = document.getElementById('reply-content').value;
            
            if (!content.trim()) {
                showToast('回复消息不能为空');
                return;
            }
            
            const result = await apiRequest('/reply-message', 'PUT', { content });
            if (result) {
                showToast('回复消息保存成功');
            }
        }
        
        // 加载发送记录
        async function loadSendRecords() {
            const records = await apiRequest('/send-records');
            const container = document.getElementById('send-records-list');
            
            if (!records) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">加载发送记录失败</div>
                    </div>
                `;
                return;
            }
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">暂无发送记录</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            records.forEach(record => {
                const date = new Date(record.created_at).toLocaleString();
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <div class="font-medium">用户 ${record.user_id}</div>
                        <div class="text-sm text-gray-600">
                            群组: ${record.group_id} | 
                            ${record.status === 'success' ? 
                                '<span class="text-secondary">发送成功</span>' : 
                                '<span class="text-danger">发送失败</span>'
                            }
                        </div>
                        <div class="text-xs text-gray-500">${date}</div>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // 加载已发送用户
        async function loadSentUsers() {
            const users = await apiRequest('/sent-users');
            const container = document.getElementById('sent-users-list');
            
            if (!users) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">加载已发送用户失败</div>
                    </div>
                `;
                return;
            }
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="list-item">
                        <div class="text-gray-500">暂无已发送用户记录</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            users.forEach(user => {
                const date = new Date(user.created_at).toLocaleString();
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <div class="font-medium">用户ID: ${user.user_id}</div>
                        <div class="text-xs text-gray-500">发送时间: ${date}</div>
                    </div>
                    <button class="delete-sent-user-btn text-danger" data-id="${user.user_id}">
                        <i class="fa fa-trash"></i>
                    </button>
                `;
                container.appendChild(item);
            });
            
            // 添加删除事件监听
            document.querySelectorAll('.delete-sent-user-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openConfirmModal(
                        '移除已发送记录', 
                        `确定要移除用户 ${btn.getAttribute('data-id')} 的已发送记录吗？`,
                        'delete-sent-user',
                        btn.getAttribute('data-id')
                    );
                });
            });
        }
        
        // 删除已发送用户记录
        async function deleteSentUser(userId) {
            const result = await apiRequest(`/sent-users/${userId}`, 'DELETE');
            if (result && result.success) {
                showToast('已发送记录删除成功');
                loadSentUsers();
                loadDashboard(); // 刷新控制面板数据
            }
        }
        
        // 清空已发送用户记录
        async function clearSentUsers() {
            const sentUsers = await apiRequest('/sent-users');
            if (!sentUsers || sentUsers.length === 0) {
                showToast('没有可清空的记录');
                return;
            }
            
            // 批量删除所有已发送用户记录
            let success = true;
            for (const user of sentUsers) {
                const result = await apiRequest(`/sent-users/${user.user_id}`, 'DELETE');
                if (!result || !result.success) {
                    success = false;
                    break;
                }
            }
            
            if (success) {
                showToast('已清空所有已发送记录');
                loadSentUsers();
                loadDashboard(); // 刷新控制面板数据
            } else {
                showToast('清空记录失败，请重试');
            }
        }
        
        // 打开确认对话框
        function openConfirmModal(title, message, action, id) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-action').value = action;
            document.getElementById('confirm-id').value = id;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        // 关闭确认对话框
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }
        
        // 执行确认操作
        function executeConfirmAction() {
            const action = document.getElementById('confirm-action').value;
            const id = document.getElementById('confirm-id').value;
            
            switch(action) {
                case 'delete-keyword':
                    deleteKeyword(id);
                    break;
                case 'delete-group':
                    deleteGroup(id);
                    break;
                case 'delete-sent-user':
                    deleteSentUser(id);
                    break;
                case 'clear-sent-users':
                    clearSentUsers();
                    break;
            }
            
            closeConfirmModal();
        }
        
        // 事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 加载默认页面
            loadDashboard();
            
            // 关键词相关
            document.getElementById('add-keyword-btn').addEventListener('click', () => openKeywordModal());
            document.getElementById('close-keyword-modal').addEventListener('click', closeKeywordModal);
            document.getElementById('cancel-keyword-btn').addEventListener('click', closeKeywordModal);
            document.getElementById('save-keyword-btn').addEventListener('click', saveKeyword);
            
            // 群组相关
            document.getElementById('add-group-btn').addEventListener('click', () => openGroupModal());
            document.getElementById('close-group-modal').addEventListener('click', closeGroupModal);
            document.getElementById('cancel-group-btn').addEventListener('click', closeGroupModal);
            document.getElementById('save-group-btn').addEventListener('click', saveGroup);
            
            // 回复消息相关
            document.getElementById('save-reply-btn').addEventListener('click', saveReplyMessage);
            
            // 已发送用户相关
            document.getElementById('clear-sent-users-btn').addEventListener('click', () => {
                openConfirmModal(
                    '清空已发送记录', 
                    '确定要清空所有已发送用户记录吗？这将允许重新向这些用户发送消息。',
                    'clear-sent-users',
                    ''
                );
            });
            
            // 确认对话框相关
            document.getElementById('cancel-confirm-btn').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-btn').addEventListener('click', executeConfirmAction);
            
            // 设置按钮 - 跳转到已发送用户页面
            document.getElementById('settings-btn').addEventListener('click', () => {
                document.querySelector('[data-page="sent-users-page"]').click();
            });
        });
    </script>
</body>
</html>
