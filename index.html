<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>万花币消消乐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // 配置Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B6B',
            secondary: '#4ECDC4',
            accent: '#FFD166',
            dark: '#292F36',
            light: '#F7FFF7'
          },
          fontFamily: {
            game: ['"Comic Sans MS"', '"Marker Felt"', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .game-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
      }
      .tile-transition {
        transition: all 0.2s ease-in-out;
      }
      .tile-hover {
        transform: scale(1.05);
      }
      .pulse-animation {
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
    }
  </style>
</head>
<body class="bg-light min-h-screen font-game text-dark overflow-x-hidden">
  <!-- Telegram Web App初始化 -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // 全局状态管理
    const gameState = {
      user: null,
      balance: 0,
      currentLevel: 1,
      totalScore: 0,
      gamePlays: null,
      isPlaying: false,
      gameBoard: [],
      score: 0,
      moves: 0,
      targetScore: 0,
      movesAllowed: 0,
      levelData: null,
      leaderboard: []
    };
    
    // API基础URL
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
    
    // 工具函数 - 发起API请求
    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const url = `${API_BASE_URL}/${endpoint}`;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(url, options);
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || '请求失败');
        
        return result;
      } catch (error) {
        console.error('API请求错误:', error);
        showToast(error.message, 'error');
        throw error;
      }
    }
    
    // 显示提示信息
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg z-50 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 'bg-blue-500'
      } text-white`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // 页面导航
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('hidden');
      });
      document.getElementById(pageId).classList.remove('hidden');
      
      // 特殊页面处理
      if (pageId === 'game-page' && !gameState.isPlaying) {
        startGame(gameState.currentLevel);
      } else if (pageId === 'leaderboard-page') {
        loadLeaderboard();
      }
    }
    
    // 初始化用户
    async function initUser() {
      try {
        // 从URL获取用户信息
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('user_id');
        
        if (!telegramId) {
          // 尝试从Telegram Web App获取用户信息
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            await apiRequest('login', 'POST', {
              queryId: tg.initDataUnsafe.query_id,
              userId: user.id,
              firstName: user.first_name,
              lastName: user.last_name || '',
              username: user.username || ''
            });
            window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            return;
          } else {
            navigateTo('login-page');
            return;
          }
        }
        
        // 加载用户数据
        const userData = await apiRequest(`user?telegram_id=${telegramId}`);
        gameState.user = userData.user;
        gameState.balance = userData.balance.万花币_balance;
        gameState.currentLevel = userData.progress.current_level;
        gameState.totalScore = userData.progress.total_score;
        gameState.gamePlays = userData.gamePlays;
        
        // 更新UI
        updateUserInterface();
        
        // 导航到首页
        navigateTo('home-page');
      } catch (error) {
        console.error('初始化用户失败:', error);
        showToast('登录失败，请重试', 'error');
        navigateTo('login-page');
      }
    }
    
    // 更新用户界面
    function updateUserInterface() {
      // 更新余额显示
      document.querySelectorAll('.balance-display').forEach(el => {
        el.textContent = gameState.balance;
      });
      
      // 更新当前关卡
      document.getElementById('current-level-display').textContent = gameState.currentLevel;
      
      // 更新总分数
      document.getElementById('total-score-display').textContent = gameState.totalScore;
      
      // 更新游戏次数
      if (gameState.gamePlays) {
        const remainingFreePlays = 6 - gameState.gamePlays.free_plays_used;
        document.getElementById('remaining-plays').textContent = remainingFreePlays;
      }
    }
    
    // 处理签到
    async function handleCheckin() {
      try {
        const result = await apiRequest('checkin', 'POST', {
          telegram_id: gameState.user.telegram_id
        });
        
        if (result.success) {
          gameState.balance = result.balance;
          showToast(`签到成功！获得${result.reward}万花币，连续签到${result.streak}天`, 'success');
          updateUserInterface();
          document.getElementById('checkin-btn').disabled = true;
          document.getElementById('checkin-btn').textContent = '今日已签到';
        } else {
          showToast(result.message);
        }
      } catch (error) {
        console.error('签到失败:', error);
      }
    }
    
    // 检查是否可以玩游戏
    async function checkCanPlayGame() {
      try {
        const result = await apiRequest(`game-plays?telegram_id=${gameState.user.telegram_id}`);
        return result.canPlay;
      } catch (error) {
        console.error('检查游戏次数失败:', error);
        return false;
      }
    }
    
    // 记录游戏次数
    async function recordGamePlay(type) {
      try {
        const result = await apiRequest('record-play', 'POST', {
          telegram_id: gameState.user.telegram_id,
          type
        });
        
        gameState.gamePlays = result.gamePlays;
        updateUserInterface();
        return true;
      } catch (error) {
        console.error('记录游戏次数失败:', error);
        return false;
      }
    }
    
    // 增加游戏次数 (通过广告或分享)
    async function addGamePlays(type) {
      try {
        if (type === 'ad') {
          // 显示广告逻辑
          showToast('广告播放中...');
          // 模拟广告播放
          setTimeout(async () => {
            const result = await apiRequest('add-plays', 'POST', {
              telegram_id: gameState.user.telegram_id,
              type
            });
            
            if (result.success) {
              gameState.gamePlays = result.gamePlays;
              updateUserInterface();
              showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
            } else {
              showToast(result.message);
            }
          }, 3000);
        } else if (type === 'share') {
          // 分享逻辑
          if (tg.ShareButton) {
            tg.ShareButton.show();
            tg.onEvent('shareCompleted', async () => {
              const result = await apiRequest('add-plays', 'POST', {
                telegram_id: gameState.user.telegram_id,
                type
              });
              
              if (result.success) {
                gameState.gamePlays = result.gamePlays;
                updateUserInterface();
                showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
              } else {
                showToast(result.message);
              }
            });
          } else {
            showToast('分享功能暂不可用');
          }
        }
      } catch (error) {
        console.error('增加游戏次数失败:', error);
      }
    }
    
    // 加载关卡数据
    async function loadLevelData(levelNumber) {
      try {
        const levelData = await apiRequest(`level?level=${levelNumber}`);
        gameState.levelData = levelData;
        return levelData;
      } catch (error) {
        console.error('加载关卡数据失败:', error);
        showToast('加载关卡失败，请重试', 'error');
        return null;
      }
    }
    
    // 初始化游戏板
    function initializeGameBoard(rows = 8, cols = 8, obstacles = {}) {
      const board = [];
      const tileTypes = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
      
      for (let i = 0; i < rows; i++) {
        const row = [];
        for (let j = 0; j < cols; j++) {
          // 确保不会初始形成三个相同的连线
          let type;
          do {
            type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
          } while (
            // 检查水平方向
            (j >= 2 && row[j-1] === type && row[j-2] === type) ||
            // 检查垂直方向
            (i >= 2 && board[i-1][j] === type && board[i-2][j] === type)
          );
          
          // 添加障碍物
          let hasObstacle = false;
          if (obstacles.type === 'ice' && Math.random() < 0.1) {
            hasObstacle = 'ice';
          } else if (obstacles.type === 'box' && Math.random() < 0.05) {
            hasObstacle = 'box';
          } else if (obstacles.type === 'chain' && Math.random() < 0.07) {
            hasObstacle = 'chain';
          } else if (obstacles.type === 'multiple' && obstacles.obstacles) {
            if (Math.random() < 0.15) {
              const obstacleType = obstacles.obstacles[Math.floor(Math.random() * obstacles.obstacles.length)];
              hasObstacle = obstacleType;
            }
          }
          
          row.push({
            type,
            obstacle: hasObstacle,
            x: j,
            y: i,
            matched: false,
            selected: false
          });
        }
        board.push(row);
      }
      
      return board;
    }
    
    // 渲染游戏板
    function renderGameBoard() {
      const gameBoardElement = document.getElementById('game-board');
      gameBoardElement.innerHTML = '';
      
      // 设置网格尺寸
      gameBoardElement.style.gridTemplateColumns = `repeat(${gameState.gameBoard[0].length}, 1fr)`;
      
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          const tileElement = document.createElement('div');
          tileElement.className = `aspect-square flex items-center justify-center rounded-md tile-transition cursor-pointer ${
            tile.selected ? 'ring-4 ring-accent scale-110' : ''
          }`;
          
          // 设置颜色
          switch (tile.type) {
            case 'red': tileElement.classList.add('bg-red-500'); break;
            case 'blue': tileElement.classList.add('bg-blue-500'); break;
            case 'green': tileElement.classList.add('bg-green-500'); break;
            case 'yellow': tileElement.classList.add('bg-yellow-500'); break;
            case 'purple': tileElement.classList.add('bg-purple-500'); break;
            case 'orange': tileElement.classList.add('bg-orange-500'); break;
          }
          
          // 添加障碍物
          if (tile.obstacle === 'ice') {
            tileElement.innerHTML += '<div class="absolute w-full h-full bg-blue-200/50 flex items-center justify-center"><i class="fa fa-snowflake-o text-blue-800"></i></div>';
          } else if (tile.obstacle === 'box') {
            tileElement.innerHTML += '<div class="absolute w-3/4 h-3/4 bg-gray-700 rounded-sm flex items-center justify-center"><i class="fa fa-cube text-gray-400"></i></div>';
          } else if (tile.obstacle === 'chain') {
            tileElement.innerHTML += '<div class="absolute w-full h-full flex items-center justify-center"><i class="fa fa-link text-gray-800 text-xl"></i></div>';
          }
          
          // 添加点击事件
          tileElement.addEventListener('click', () => handleTileClick(rowIndex, colIndex));
          
          // 添加悬停效果
          tileElement.addEventListener('mouseenter', () => {
            if (!tile.selected) tileElement.classList.add('tile-hover');
          });
          tileElement.addEventListener('mouseleave', () => {
            if (!tile.selected) tileElement.classList.remove('tile-hover');
          });
          
          gameBoardElement.appendChild(tileElement);
        });
      });
      
      // 更新分数和步数显示
      document.getElementById('game-score').textContent = gameState.score;
      document.getElementById('target-score').textContent = gameState.targetScore;
      document.getElementById('remaining-moves').textContent = gameState.movesAllowed - gameState.moves;
    }
    
    // 处理方块点击
    function handleTileClick(row, col) {
      const selectedTile = gameState.gameBoard[row][col];
      
      // 检查是否有已选中的方块
      const alreadySelected = gameState.gameBoard.find(row => 
        row.find(tile => tile.selected)
      );
      
      if (alreadySelected) {
        // 找到已选中的方块
        const [selectedRow, selectedCol] = findSelectedTile();
        
        // 检查是否相邻
        if (isAdjacent(selectedRow, selectedCol, row, col)) {
          // 交换方块
          swapTiles(selectedRow, selectedCol, row, col);
          
          // 检查是否有匹配
          const matches = findMatches();
          
          if (matches.length > 0) {
            // 有匹配，处理匹配
            processMatches(matches);
            gameState.moves++;
          } else {
            // 无匹配，交换回来
            setTimeout(() => {
              swapTiles(row, col, selectedRow, selectedCol);
              renderGameBoard();
            }, 300);
          }
          
          // 取消选择
          deselectAllTiles();
        } else {
          // 不相邻，取消之前的选择，选择新的
          deselectAllTiles();
          selectedTile.selected = true;
          renderGameBoard();
        }
      } else {
        // 没有已选中的，选中当前方块
        selectedTile.selected = true;
        renderGameBoard();
      }
    }
    
    // 查找已选中的方块
    function findSelectedTile() {
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j].selected) {
            return [i, j];
          }
        }
      }
      return [-1, -1];
    }
    
    // 检查是否相邻
    function isAdjacent(row1, col1, row2, col2) {
      return (
        (Math.abs(row1 - row2) === 1 && col1 === col2) ||
        (Math.abs(col1 - col2) === 1 && row1 === row2)
      );
    }
    
    // 交换方块
    function swapTiles(row1, col1, row2, col2) {
      const temp = gameState.gameBoard[row1][col1];
      gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
      gameState.gameBoard[row2][col2] = temp;
      
      // 更新位置信息
      gameState.gameBoard[row1][col1].x = col1;
      gameState.gameBoard[row1][col1].y = row1;
      gameState.gameBoard[row2][col2].x = col2;
      gameState.gameBoard[row2][col2].y = row2;
      
      renderGameBoard();
    }
    
    // 取消所有选择
    function deselectAllTiles() {
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          tile.selected = false;
        });
      });
    }
    
    // 查找匹配
    function findMatches() {
      const matches = [];
      
      // 检查水平匹配
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        let j = 0;
        while (j < gameState.gameBoard[i].length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i][j+1];
          const next2 = gameState.gameBoard[i][j+2];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 0, 1);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i, col: j + k });
            }
            
            matches.push(match);
            j += matchLength;
          } else {
            j++;
          }
        }
      }
      
      // 检查垂直匹配
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        let i = 0;
        while (i < gameState.gameBoard.length - 2) {
          const current = gameState.gameBoard[i][j];
          const next1 = gameState.gameBoard[i+1][j];
          const next2 = gameState.gameBoard[i+2][j];
          
          if (current.type === next1.type && current.type === next2.type) {
            const matchLength = findMatchLength(i, j, 1, 0);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i + k, col: j });
            }
            
            matches.push(match);
            i += matchLength;
          } else {
            i++;
          }
        }
      }
      
      return matches;
    }
    
    // 查找匹配长度
    function findMatchLength(startRow, startCol, rowDir, colDir) {
      const type = gameState.gameBoard[startRow][startCol].type;
      let length = 1;
      
      let currentRow = startRow + rowDir;
      let currentCol = startCol + colDir;
      
      while (
        currentRow < gameState.gameBoard.length &&
        currentCol < gameState.gameBoard[0].length &&
        gameState.gameBoard[currentRow][currentCol].type === type
      ) {
        length++;
        currentRow += rowDir;
        currentCol += colDir;
      }
      
      return length;
    }
    
    // 处理匹配
    function processMatches(matches) {
      if (matches.length === 0) {
        // 检查游戏是否结束
        checkGameEnd();
        return;
      }
      
      // 标记匹配的方块
      matches.forEach(match => {
        match.forEach(position => {
          const tile = gameState.gameBoard[position.row][position.col];
          tile.matched = true;
          
          // 根据匹配长度和障碍物类型计算分数
          let points = 10;
          if (match.length >= 4) points = 20;
          if (match.length >= 5) points = 50;
          
          if (tile.obstacle === 'ice') points += 5;
          if (tile.obstacle === 'box') points += 15;
          if (tile.obstacle === 'chain') points += 10;
          
          gameState.score += points;
        });
      });
      
      // 重新渲染以显示匹配的方块
      renderGameBoard();
      
      // 移除匹配的方块并填充新方块
      setTimeout(() => {
        removeMatchedTiles();
        fillEmptySpaces();
        
        // 检查是否有新的匹配
        setTimeout(() => {
          const newMatches = findMatches();
          processMatches(newMatches);
        }, 500);
      }, 500);
    }
    
    // 移除匹配的方块
    function removeMatchedTiles() {
      for (let i = 0; i < gameState.gameBoard.length; i++) {
        for (let j = 0; j < gameState.gameBoard[i].length; j++) {
          if (gameState.gameBoard[i][j].matched) {
            // 处理障碍物
            if (gameState.gameBoard[i][j].obstacle === 'ice') {
              // 冰障碍物只需要一次匹配即可消除
              gameState.gameBoard[i][j] = createNewTile(j, i);
              gameState.gameBoard[i][j].obstacle = null;
            } else if (gameState.gameBoard[i][j].obstacle === 'box') {
              // 箱子障碍物需要两次匹配
              gameState.gameBoard[i][j] = createNewTile(j, i);
              gameState.gameBoard[i][j].obstacle = 'box_damaged';
            } else if (gameState.gameBoard[i][j].obstacle === 'box_damaged') {
              // 受损箱子一次匹配即可消除
              gameState.gameBoard[i][j] = createNewTile(j, i);
              gameState.gameBoard[i][j].obstacle = null;
            } else if (gameState.gameBoard[i][j].obstacle === 'chain') {
              // 链条障碍物需要一次匹配即可消除
              gameState.gameBoard[i][j] = createNewTile(j, i);
              gameState.gameBoard[i][j].obstacle = null;
            } else {
              // 普通方块直接替换
              gameState.gameBoard[i][j] = null;
            }
          }
        }
      }
    }
    
    // 创建新方块
    function createNewTile(x, y) {
      const tileTypes = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];
      const type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
      
      return {
        type,
        obstacle: null,
        x,
        y,
        matched: false,
        selected: false
      };
    }
    
    // 填充空白位置
    function fillEmptySpaces() {
      // 处理每一列
      for (let j = 0; j < gameState.gameBoard[0].length; j++) {
        // 下落现有方块
        for (let i = gameState.gameBoard.length - 1; i >= 0; i--) {
          if (gameState.gameBoard[i][j] === null) {
            // 查找上方最近的非空方块
            for (let k = i - 1; k >= 0; k--) {
              if (gameState.gameBoard[k][j] !== null) {
                // 下落方块
                gameState.gameBoard[i][j] = gameState.gameBoard[k][j];
                gameState.gameBoard[k][j] = null;
                gameState.gameBoard[i][j].y = i; // 更新位置
                break;
              }
            }
          }
        }
        
        // 顶部填充新方块
        for (let i = 0; i < gameState.gameBoard.length; i++) {
          if (gameState.gameBoard[i][j] === null) {
            gameState.gameBoard[i][j] = createNewTile(j, i);
          }
        }
      }
      
      renderGameBoard();
    }
    
    // 检查游戏是否结束
    function checkGameEnd() {
      if (gameState.moves >= gameState.movesAllowed) {
        // 步数用完，游戏结束
        gameState.isPlaying = false;
        
        if (gameState.score >= gameState.targetScore) {
          // 通关成功
          showLevelComplete();
        } else {
          // 未通关
          showLevelFailed();
        }
      }
    }
    
    // 显示关卡完成
    async function showLevelComplete() {
      document.getElementById('level-complete-modal').classList.remove('hidden');
      document.getElementById('level-complete-score').textContent = gameState.score;
      
      // 计算奖励
      const baseReward = gameState.levelData.reward;
      const bonusPercentage = Math.min(100, Math.floor((gameState.score - gameState.targetScore) / gameState.targetScore * 100));
      const bonus = Math.floor(baseReward * (bonusPercentage / 100));
      const totalReward = baseReward + bonus;
      
      document.getElementById('level-reward').textContent = totalReward;
      
      // 提交关卡完成
      try {
        await apiRequest('complete-level', 'POST', {
          telegram_id: gameState.user.telegram_id,
          levelNumber: gameState.currentLevel,
          score: gameState.score
        });
        
        // 更新用户数据
        await initUser();
      } catch (error) {
        console.error('提交关卡完成失败:', error);
      }
    }
    
    // 显示关卡失败
    function showLevelFailed() {
      document.getElementById('level-failed-modal').classList.remove('hidden');
      document.getElementById('failed-score').textContent = gameState.score;
      document.getElementById('failed-target').textContent = gameState.targetScore;
    }
    
    // 开始游戏
    async function startGame(levelNumber) {
      try {
        // 检查是否可以玩游戏
        const canPlay = await checkCanPlayGame();
        if (!canPlay) {
          showToast('没有剩余游戏次数，请观看广告或分享获取更多次数', 'error');
          navigateTo('home-page');
          return;
        }
        
        // 记录游戏次数
        await recordGamePlay('free');
        
        // 加载关卡数据
        const levelData = await loadLevelData(levelNumber);
        if (!levelData) return;
        
        // 初始化游戏状态
        gameState.isPlaying = true;
        gameState.score = 0;
        gameState.moves = 0;
        gameState.targetScore = levelData.target_score;
        gameState.movesAllowed = levelData.moves_allowed;
        gameState.gameBoard = initializeGameBoard(8, 8, levelData.obstacles);
        
        // 渲染游戏
        renderGameBoard();
        
        // 显示当前关卡
        document.getElementById('current-game-level').textContent = levelNumber;
      } catch (error) {
        console.error('开始游戏失败:', error);
        showToast('无法开始游戏，请重试', 'error');
        navigateTo('home-page');
      }
    }
    
    // 加载排行榜
    async function loadLeaderboard() {
      try {
        const leaderboard = await apiRequest('leaderboard');
        gameState.leaderboard = leaderboard;
        
        const leaderboardElement = document.getElementById('leaderboard-list');
        leaderboardElement.innerHTML = '';
        
        leaderboard.forEach((entry, index) => {
          const entryElement = document.createElement('div');
          entryElement.className = `flex items-center justify-between p-3 mb-2 rounded-lg ${
            index === 0 ? 'bg-yellow-100 border-2 border-yellow-400' :
            index === 1 ? 'bg-gray-100 border-2 border-gray-400' :
            index === 2 ? 'bg-orange-100 border-2 border-orange-400' :
            'bg-white'
          }`;
          
          entryElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center mr-3 font-bold">
                ${entry.rank}
              </div>
              <div>
                <div class="font-bold">${entry.username}</div>
                <div class="text-sm text-gray-500">总分: ${entry.score}</div>
              </div>
            </div>
            ${index === 0 ? '<i class="fa fa-trophy text-yellow-500 text-2xl"></i>' : 
              index === 1 ? '<i class="fa fa-trophy text-gray-400 text-2xl"></i>' :
              index === 2 ? '<i class="fa fa-trophy text-orange-600 text-2xl"></i>' : ''}
          `;
          
          leaderboardElement.appendChild(entryElement);
        });
        
        // 显示奖励说明
        document.getElementById('leaderboard-rewards').innerHTML = `
          <div class="p-4 bg-gray-50 rounded-lg mt-4">
            <h3 class="font-bold text-lg mb-2">月度奖励</h3>
            <div class="flex justify-between items-center mb-1">
              <span>第1名: <i class="fa fa-trophy text-yellow-500"></i></span>
              <span class="font-bold">¥100</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第2名: <i class="fa fa-trophy text-gray-400"></i></span>
              <span class="font-bold">¥50</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第3名: <i class="fa fa-trophy text-orange-600"></i></span>
              <span class="font-bold">¥30</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第4名:</span>
              <span class="font-bold">¥20</span>
            </div>
            <div class="flex justify-between items-center">
              <span>第5名:</span>
              <span class="font-bold">¥10</span>
            </div>
            <div class="text-sm text-gray-500 mt-2">
              奖励将在每月最后一天以现金形式发放
            </div>
          </div>
        `;
      } catch (error) {
        console.error('加载排行榜失败:', error);
        showToast('无法加载排行榜，请重试', 'error');
      }
    }
    
    // 提交提现请求
    async function submitWithdrawal() {
      const amount = parseInt(document.getElementById('withdrawal-amount').value);
      const alipayAccount = document.getElementById('alipay-account').value;
      const alipayName = document.getElementById('alipay-name').value;
      
      if (!amount || !alipayAccount || !alipayName) {
        showToast('请填写完整信息', 'error');
        return;
      }
      
      if (amount % 1000 !== 0) {
        showToast('提现金额必须是1000的倍数', 'error');
        return;
      }
      
      if (amount < 1000) {
        showToast('最低提现金额为1000万花币', 'error');
        return;
      }
      
      if (amount > gameState.balance) {
        showToast('余额不足', 'error');
        return;
      }
      
      try {
        const result = await apiRequest('withdrawal', 'POST', {
          telegram_id: gameState.user.telegram_id,
          amount,
          alipayAccount,
          alipayName
        });
        
        if (result.success) {
          showToast('提现请求已提交，等待处理', 'success');
          // 重置表单
          document.getElementById('withdrawal-form').reset();
          // 刷新余额
          await initUser();
          // 返回首页
          navigateTo('home-page');
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('提交提现请求失败:', error);
        showToast('提现请求失败，请重试', 'error');
      }
    }
    
    // 加载提现历史
    async function loadWithdrawalHistory() {
      try {
        const history = await apiRequest(`withdrawal-history?telegram_id=${gameState.user.telegram_id}`);
        
        const historyElement = document.getElementById('withdrawal-history');
        historyElement.innerHTML = '';
        
        if (history.length === 0) {
          historyElement.innerHTML = '<div class="text-center py-8 text-gray-500">暂无提现记录</div>';
          return;
        }
        
        history.forEach(request => {
          const statusClass = 
            request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
            request.status === 'approved' ? 'bg-green-100 text-green-800' :
            'bg-red-100 text-red-800';
          
          const statusText = 
            request.status === 'pending' ? '处理中' :
            request.status === 'approved' ? '已批准' :
            '已拒绝';
          
          const date = new Date(request.created_at).toLocaleString();
          
          const requestElement = document.createElement('div');
          requestElement.className = 'p-3 mb-2 rounded-lg border';
          requestElement.innerHTML = `
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold">${request.amount} 万花币</span>
              <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
            </div>
            <div class="text-sm text-gray-600 mb-1">支付宝: ${request.alipay_account}</div>
            <div class="text-sm text-gray-600 mb-1">姓名: ${request.alipay_name}</div>
            <div class="text-xs text-gray-500">申请时间: ${date}</div>
          `;
          
          historyElement.appendChild(requestElement);
        });
      } catch (error) {
        console.error('加载提现历史失败:', error);
        showToast('无法加载提现历史，请重试', 'error');
      }
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', () => {
      // 绑定导航事件
      document.getElementById('home-btn').addEventListener('click', () => navigateTo('home-page'));
      document.getElementById('play-btn').addEventListener('click', () => navigateTo('game-page'));
      document.getElementById('leaderboard-nav-btn').addEventListener('click', () => navigateTo('leaderboard-page'));
      document.getElementById('withdrawal-nav-btn').addEventListener('click', () => {
        navigateTo('withdrawal-page');
        loadWithdrawalHistory();
      });
      
      // 绑定签到按钮
      document.getElementById('checkin-btn').addEventListener('click', handleCheckin);
      
      // 绑定广告和分享按钮
      document.getElementById('watch-ad-btn').addEventListener('click', () => addGamePlays('ad'));
      document.getElementById('share-btn').addEventListener('click', () => addGamePlays('share'));
      
      // 绑定提现按钮
      document.getElementById('submit-withdrawal-btn').addEventListener('click', submitWithdrawal);
      
      // 绑定游戏模态框按钮
      document.getElementById('next-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete-modal').classList.add('hidden');
        startGame(gameState.currentLevel);
      });
      
      document.getElementById('retry-level-btn').addEventListener('click', () => {
        document.getElementById('level-failed-modal').classList.add('hidden');
        startGame(gameState.currentLevel);
      });
      
      document.getElementById('exit-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete-modal').classList.add('hidden');
        document.getElementById('level-failed-modal').classList.add('hidden');
        navigateTo('home-page');
      });
      
      // 初始化用户
      initUser();
    });
  </script>
  
  <!-- 登录页面 -->
  <div id="login-page" class="page flex flex-col items-center justify-center min-h-screen p-4">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-primary mb-2">万花币消消乐</h1>
      <p class="text-gray-600">通过Telegram账号登录</p>
    </div>
    <button id="telegram-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full flex items-center">
      <i class="fa fa-telegram mr-2 text-xl"></i> 用Telegram登录
    </button>
  </div>
  
  <!-- 首页 -->
  <div id="home-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-primary">万花币消消乐</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display">0</span> 万花币
      </div>
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">当前进度</h2>
        <button id="checkin-btn" class="bg-accent hover:bg-accent/80 text-dark font-bold py-1 px-4 rounded-full text-sm">
          每日签到
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-light p-4 rounded-lg border">
          <div class="text-gray-500 text-sm mb-1">当前关卡</div>
          <div class="text-2xl font-bold" id="current-level-display">1</div>
        </div>
        <div class="bg-light p-4 rounded-lg border">
          <div class="text-gray-500 text-sm mb-1">总得分</div>
          <div class="text-2xl font-bold" id="total-score-display">0</div>
        </div>
        <div class="bg-light p-4 rounded-lg border">
          <div class="text-gray-500 text-sm mb-1">今日剩余次数</div>
          <div class="text-2xl font-bold" id="remaining-plays">6</div>
        </div>
        <div class="bg-light p-4 rounded-lg border">
          <div class="text-gray-500 text-sm mb-1">兑换比例</div>
          <div class="text-2xl font-bold">1000:10元</div>
        </div>
      </div>
      
      <button id="play-btn" class="w-full bg-primary hover:bg-primary/80 text-white font-bold py-3 rounded-lg text-lg pulse-animation">
        开始游戏
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-4 mb-6">
      <button id="watch-ad-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center">
        <i class="fa fa-play-circle text-xl text-blue-500 mb-2"></i>
        <span>观看广告</span>
        <span class="text-sm text-gray-500">+2次游戏机会</span>
      </button>
      <button id="share-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center">
        <i class="fa fa-share-alt text-xl text-green-500 mb-2"></i>
        <span>分享游戏</span>
        <span class="text-sm text-gray-500">+2次游戏机会</span>
      </button>
    </div>
    
    <div class="bg-white rounded-xl p-4 game-shadow">
      <div class="grid grid-cols-2 gap-4">
        <button id="leaderboard-nav-btn" class="p-4 border rounded-lg flex flex-col items-center justify-center">
          <i class="fa fa-trophy text-2xl text-yellow-500 mb-2"></i>
          <span class="font-bold">排行榜</span>
          <span class="text-sm text-gray-500">月度奖励</span>
        </button>
        <button id="withdrawal-nav-btn" class="p-4 border rounded-lg flex flex-col items-center justify-center">
          <i class="fa fa-money text-2xl text-green-600 mb-2"></i>
          <span class="font-bold">提现</span>
          <span class="text-sm text-gray-500">兑换现金</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- 游戏页面 -->
  <div id="game-page" class="page hidden p-2">
    <div class="flex justify-between items-center mb-2">
      <button id="home-btn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full">
        <i class="fa fa-home"></i>
      </button>
      <div class="text-center">
        <h2 class="font-bold">关卡 <span id="current-game-level">1</span></h2>
      </div>
      <div class="bg-primary/10 text-primary px-2 py-1 rounded-full text-sm flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display">0</span>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-3 mb-3 game-shadow">
      <div class="grid grid-cols-2 gap-2 text-center">
        <div class="bg-light p-2 rounded">
          <div class="text-sm text-gray-500">当前得分</div>
          <div class="font-bold text-lg" id="game-score">0</div>
        </div>
        <div class="bg-light p-2 rounded">
          <div class="text-sm text-gray-500">目标得分</div>
          <div class="font-bold text-lg" id="target-score">0</div>
        </div>
        <div class="bg-light p-2 rounded col-span-2">
          <div class="text-sm text-gray-500">剩余步数</div>
          <div class="font-bold text-lg" id="remaining-moves">0</div>
        </div>
      </div>
    </div>
    
    <div id="game-board" class="w-full aspect-square bg-light rounded-lg game-shadow grid gap-1 p-1 mb-3 overflow-hidden"></div>
    
    <div class="flex justify-between">
      <button id="game-exit-btn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg" onclick="navigateTo('home-page')">
        退出
      </button>
      <button id="game-restart-btn" class="bg-accent hover:bg-accent/80 px-4 py-2 rounded-lg" onclick="startGame(gameState.currentLevel)">
        重新开始
      </button>
    </div>
  </div>
  
  <!-- 关卡完成模态框 -->
  <div id="level-complete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
      <div class="text-green-500 text-5xl mb-4">
        <i class="fa fa-check-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">关卡完成！</h2>
      <p class="mb-4">恭喜你通过了关卡 <span id="completed-level">1</span></p>
      <div class="bg-light p-4 rounded-lg mb-4">
        <div class="mb-2">你的得分: <span id="level-complete-score" class="font-bold">0</span></div>
        <div class="text-green-600 font-bold">获得奖励: <span id="level-reward">0</span> 万花币</div>
      </div>
      <div class="flex gap-2">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded-lg">
          返回首页
        </button>
        <button id="next-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-2 rounded-lg">
          下一关
        </button>
      </div>
    </div>
  </div>
  
  <!-- 关卡失败模态框 -->
  <div id="level-failed-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full text-center">
      <div class="text-red-500 text-5xl mb-4">
        <i class="fa fa-times-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">挑战失败</h2>
      <p class="mb-4">再接再厉，争取通过关卡！</p>
      <div class="bg-light p-4 rounded-lg mb-4">
        <div class="mb-2">你的得分: <span id="failed-score" class="font-bold">0</span></div>
        <div class="text-red-600">目标得分: <span id="failed-target" class="font-bold">0</span></div>
      </div>
      <div class="flex gap-2">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded-lg">
          返回首页
        </button>
        <button id="retry-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-2 rounded-lg">
          再试一次
        </button>
      </div>
    </div>
  </div>
  
  <!-- 排行榜页面 -->
  <div id="leaderboard-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button id="home-btn-2" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full" onclick="navigateTo('home-page')">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">全服排行榜</h1>
      <div class="w-8"></div> <!-- 占位 -->
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4 text-center">本月排名</h2>
      <div id="leaderboard-list" class="space-y-2"></div>
      <div id="leaderboard-rewards"></div>
    </div>
  </div>
  
  <!-- 提现页面 -->
  <div id="withdrawal-page" class="page hidden p-4">
    <div class="flex justify-between items-center mb-6">
      <button id="home-btn-3" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full" onclick="navigateTo('home-page')">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">提现中心</h1>
      <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
        <i class="fa fa-diamond mr-1"></i>
        <span class="balance-display">0</span> 万花币
      </div>
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow mb-6">
      <h2 class="text-xl font-bold mb-4">申请提现</h2>
      <form id="withdrawal-form" class="space-y-4">
        <div>
          <label class="block text-gray-700 mb-1">提现金额 (万花币)</label>
          <input 
            type="number" 
            id="withdrawal-amount" 
            class="w-full p-2 border rounded-lg" 
            placeholder="1000" 
            step="1000" 
            min="1000"
          >
          <p class="text-sm text-gray-500 mt-1">最低1000万花币，必须是1000的倍数</p>
        </div>
        
        <div>
          <label class="block text-gray-700 mb-1">支付宝账号</label>
          <input 
            type="text" 
            id="alipay-account" 
            class="w-full p-2 border rounded-lg" 
            placeholder="请输入支付宝账号"
          >
        </div>
        
        <div>
          <label class="block text-gray-700 mb-1">支付宝姓名</label>
          <input 
            type="text" 
            id="alipay-name" 
            class="w-full p-2 border rounded-lg" 
            placeholder="请输入真实姓名"
          >
        </div>
        
        <button 
          type="button" 
          id="submit-withdrawal-btn" 
          class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg"
        >
          提交提现申请
        </button>
      </form>
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow">
      <h2 class="text-xl font-bold mb-4">提现历史</h2>
      <div id="withdrawal-history"></div>
    </div>
  </div>
</body>
</html>
