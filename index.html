<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万象谜题 - 创意解谜游戏</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            color: white;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            flex-grow: 1;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }
        
        .user-details {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-right: 15px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .user-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .user-level {
            color: #666;
            font-size: 0.9rem;
        }
        
        .wanhua-coins {
            display: flex;
            align-items: center;
            background: #ffd700;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .wanhua-coins i {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        
        .game-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .game-mode {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .game-mode:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .game-mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .game-mode-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .game-mode-description {
            color: #666;
            font-size: 0.9rem;
        }
        
        .daily-activities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .activity-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: #667eea;
        }
        
        .activity-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .activity-title i {
            margin-right: 8px;
            color: #667eea;
        }
        
        .activity-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .activity-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            width: 100%;
        }
        
        .activity-button:hover {
            background: #5a67d8;
        }
        
        .activity-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .leaderboard-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
            color: #667eea;
        }
        
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            position: relative;
        }
        
        .leaderboard-tab.active {
            color: #667eea;
        }
        
        .leaderboard-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background: #667eea;
        }
        
        .leaderboard-list {
            list-style: none;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .leaderboard-rank.top-1 {
            background: #ffd700;
            color: white;
        }
        
        .leaderboard-rank.top-2 {
            background: #c0c0c0;
            color: white;
        }
        
        .leaderboard-rank.top-3 {
            background: #cd7f32;
            color: white;
        }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .leaderboard-score {
            color: #666;
            font-size: 0.9rem;
        }
        
        .withdraw-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .withdraw-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .withdraw-rates {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .withdraw-rate {
            text-align: center;
            flex: 1;
        }
        
        .withdraw-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .withdraw-coins {
            color: #666;
            font-size: 0.9rem;
        }
        
        .withdraw-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .form-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .withdraw-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .withdraw-button:hover {
            background: #5a67d8;
        }
        
        .withdraw-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .withdraw-history {
            margin-top: 20px;
        }
        
        .withdraw-history-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .withdraw-history-list {
            list-style: none;
        }
        
        .withdraw-history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .withdraw-history-amount {
            font-weight: bold;
        }
        
        .withdraw-history-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
        }
        
        .footer-link {
            color: white;
            text-decoration: none;
            margin: 0 10px;
        }
        
        .footer-link:hover {
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .level-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .level-type {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .type-puzzle {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .type-strategy {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-action {
            background: #ffebee;
            color: #c62828;
        }
        
        .type-memory {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .level-difficulty {
            display: flex;
            margin-bottom: 10px;
        }
        
        .difficulty-star {
            color: #ffd700;
            font-size: 1.2rem;
            margin-right: 2px;
        }
        
        .game-area {
            background: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .game-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .game-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .game-button:hover {
            background: #5a67d8;
        }
        
        .game-button.secondary {
            background: #6c757d;
        }
        
        .game-button.secondary:hover {
            background: #5a6268;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 4px solid #667eea;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            max-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .notification-message {
            color: #666;
            font-size: 0.9rem;
        }
        
        .notification.success {
            border-left: 4px solid #28a745;
        }
        
        .notification.error {
            border-left: 4px solid #dc3545;
        }
        
        .notification.info {
            border-left: 4px solid #17a2b8;
        }
        
        .telegram-login {
            text-align: center;
            padding: 40px 20px;
        }
        
        .telegram-login-button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            transition: background 0.3s;
        }
        
        .telegram-login-button:hover {
            background: #0077b3;
        }
        
        .telegram-login-button i {
            margin-right: 10px;
        }
        
        .ad-banner {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .ad-label {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        .ad-content {
            color: #666;
            font-size: 0.9rem;
        }
        
        .ad-cta {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .ad-cta:hover {
            background: #5a67d8;
        }
        
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 3000;
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: none;
        }
        
        .achievement-popup.show {
            display: block;
            animation: popIn 0.5s;
        }
        
        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .achievement-icon {
            font-size: 4rem;
            color: #ffd700;
            margin-bottom: 20px;
        }
        
        .achievement-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .achievement-description {
            color: #666;
            margin-bottom: 20px;
        }
        
        .achievement-reward {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .achievement-close {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
            }
            
            .user-details {
                margin-bottom: 15px;
            }
            
            .game-modes {
                grid-template-columns: 1fr;
            }
            
            .daily-activities {
                grid-template-columns: 1fr;
            }
            
            .withdraw-rates {
                flex-direction: column;
            }
            
            .withdraw-rate {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>万象谜题</h1>
            <p class="subtitle">创意解谜游戏，挑战你的智力极限</p>
        </header>
        
        <div class="main-content" id="mainContent">
            <!-- 用户未登录时显示 -->
            <div class="telegram-login" id="telegramLogin">
                <h2>欢迎来到《万象谜题》</h2>
                <p style="margin: 20px 0; color: #666;">请使用Telegram账号登录开始游戏</p>
                <button class="telegram-login-button" id="telegramLoginButton">
                    <i class="fab fa-telegram-plane"></i> 使用Telegram登录
                </button>
            </div>
            
            <!-- 用户登录后显示的内容 -->
            <div id="gameContent" style="display: none;">
                <div class="user-info">
                    <div class="user-details">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div class="user-name" id="userName">用户名</div>
                            <div class="user-level">当前关卡: <span id="userLevel">1</span></div>
                        </div>
                    </div>
                    <div class="wanhua-coins">
                        <i class="fas fa-coins"></i>
                        <span id="wanhuaCoins">0</span> 万花币
                    </div>
                </div>
                
                <div class="ad-banner">
                    <div class="ad-label">广告</div>
                    <div class="ad-content">观看广告获得额外万花币奖励</div>
                    <button class="ad-cta" id="watchAdButton">观看广告 (+5万花币)</button>
                </div>
                
                <h2 class="section-title">
                    <i class="fas fa-gamepad"></i> 游戏模式
                </h2>
                <div class="game-modes">
                    <div class="game-mode" data-mode="puzzle">
                        <div class="game-mode-icon">
                            <i class="fas fa-puzzle-piece"></i>
                        </div>
                        <div class="game-mode-title">解谜关卡</div>
                        <div class="game-mode-description">挑战各种谜题，锻炼逻辑思维能力</div>
                    </div>
                    <div class="game-mode" data-mode="strategy">
                        <div class="game-mode-icon">
                            <i class="fas fa-chess"></i>
                        </div>
                        <div class="game-mode-title">策略关卡</div>
                        <div class="game-mode-description">制定合理策略，优化资源分配</div>
                    </div>
                    <div class="game-mode" data-mode="action">
                        <div class="game-mode-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <div class="game-mode-title">动作关卡</div>
                        <div class="game-mode-description">考验操作技巧，挑战反应速度</div>
                    </div>
                    <div class="game-mode" data-mode="memory">
                        <div class="game-mode-icon">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="game-mode-title">记忆关卡</div>
                        <div class="game-mode-description">训练记忆力，提高信息处理能力</div>
                    </div>
                </div>
                
                <h2 class="section-title">
                    <i class="fas fa-calendar-day"></i> 每日活动
                </h2>
                <div class="daily-activities">
                    <div class="activity-card">
                        <div class="activity-title">
                            <i class="fas fa-calendar-check"></i> 每日签到
                        </div>
                        <div class="activity-description">
                            连续签到获得更多奖励，7天签到有额外惊喜
                        </div>
                        <button class="activity-button" id="checkInButton">签到</button>
                    </div>
                    <div class="activity-card">
                        <div class="activity-title">
                            <i class="fas fa-share-alt"></i> 分享游戏
                        </div>
                        <div class="activity-description">
                            分享游戏到Telegram群组或频道，获得万花币奖励
                        </div>
                        <button class="activity-button" id="shareButton">分享游戏</button>
                    </div>
                    <div class="activity-card">
                        <div class="activity-title">
                            <i class="fas fa-gift"></i> 领取奖励
                        </div>
                        <div class="activity-description">
                            查看并领取已完成的成就奖励
                        </div>
                        <button class="activity-button" id="claimRewardsButton">领取奖励</button>
                    </div>
                </div>
                
                <div class="leaderboard-section">
                    <div class="section-title">
                        <i class="fas fa-trophy"></i> 排行榜
                    </div>
                    <div class="leaderboard-tabs">
                        <div class="leaderboard-tab active" data-tab="monthly">月度排行</div>
                        <div class="leaderboard-tab" data-tab="friends">好友排行</div>
                    </div>
                    <ul class="leaderboard-list" id="leaderboardList">
                        <li class="leaderboard-item">
                            <div class="loading">
                                <div class="spinner"></div>
                                <div>加载中...</div>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="withdraw-section">
                    <div class="section-title">
                        <i class="fas fa-money-bill-wave"></i> 提现
                    </div>
                    <div class="withdraw-info">
                        <div class="withdraw-rates">
                            <div class="withdraw-rate">
                                <div class="withdraw-amount">10元</div>
                                <div class="withdraw-coins">1000万花币</div>
                            </div>
                            <div class="withdraw-rate">
                                <div class="withdraw-amount">20元</div>
                                <div class="withdraw-coins">2000万花币</div>
                            </div>
                            <div class="withdraw-rate">
                                <div class="withdraw-amount">50元</div>
                                <div class="withdraw-coins">5000万花币</div>
                            </div>
                            <div class="withdraw-rate">
                                <div class="withdraw-amount">100元</div>
                                <div class="withdraw-coins">10000万花币</div>
                            </div>
                        </div>
                        <p style="color: #666; font-size: 0.9rem;">提现申请提交后，需经过人工审核，审核通过后3-5个工作日内到账</p>
                    </div>
                    <div class="withdraw-form">
                        <div class="form-group">
                            <label class="form-label">提现金额</label>
                            <select class="form-input" id="withdrawAmount">
                                <option value="10">10元 (1000万花币)</option>
                                <option value="20">20元 (2000万花币)</option>
                                <option value="50">50元 (5000万花币)</option>
                                <option value="100">100元 (10000万花币)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">支付宝账号</label>
                            <input type="text" class="form-input" id="alipayAccount" placeholder="请输入支付宝账号">
                        </div>
                        <div class="form-group">
                            <label class="form-label">真实姓名</label>
                            <input type="text" class="form-input" id="realName" placeholder="请输入真实姓名（与支付宝实名一致）">
                        </div>
                        <button class="withdraw-button" id="withdrawButton">申请提现</button>
                    </div>
                    <div class="withdraw-history">
                        <div class="withdraw-history-title">提现记录</div>
                        <ul class="withdraw-history-list" id="withdrawHistoryList">
                            <li class="withdraw-history-item">
                                <div>暂无提现记录</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" class="footer-link" target="_blank">@bjxc010</a> 开发</p>
        </footer>
    </div>
    
    <!-- 游戏关卡模态框 -->
    <div class="modal" id="levelModal">
        <div class="modal-content">
            <span class="modal-close" id="levelModalClose">&times;</span>
            <h2 class="modal-title" id="levelModalTitle">关卡 1</h2>
            <div class="level-info">
                <div id="levelTypeContainer"></div>
                <div class="level-difficulty" id="levelDifficultyContainer"></div>
                <div>奖励: <span id="levelReward">0</span> 万花币</div>
                <div id="levelDescription"></div>
            </div>
            <div class="game-area" id="gameArea">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>加载中...</div>
                </div>
            </div>
            <div class="game-controls">
                <button class="game-button secondary" id="hintButton">获取提示 (3万花币)</button>
                <button class="game-button" id="startLevelButton">开始挑战</button>
            </div>
        </div>
    </div>
    
    <!-- 通知组件 -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-message" id="notificationMessage"></div>
    </div>
    
    <!-- 成就弹窗 -->
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="achievement-title" id="achievementTitle">成就解锁</div>
        <div class="achievement-description" id="achievementDescription">成就描述</div>
        <div class="achievement-reward">
            奖励: <span id="achievementReward">0</span> 万花币
        </div>
        <button class="achievement-close" id="achievementClose">确定</button>
    </div>
    
    <script>
        // 游戏配置
        const config = {
            apiBaseUrl: 'https://wanhua-game.bingkuijing.workers.dev/api',
            telegramBotUsername: 'bjxcyouxiBot',
            levels: {
                puzzle: {
                    name: '解谜关卡',
                    icon: 'fas fa-puzzle-piece'
                },
                strategy: {
                    name: '策略关卡',
                    icon: 'fas fa-chess'
                },
                action: {
                    name: '动作关卡',
                    icon: 'fas fa-running'
                },
                memory: {
                    name: '记忆关卡',
                    icon: 'fas fa-brain'
                }
            }
        };
        
        // 游戏状态
        let gameState = {
            user: null,
            userData: null,
            currentLevel: null,
            gameTimer: null,
            startTime: null,
            hintsUsed: 0
        };
        
        // DOM元素
        const elements = {
            telegramLogin: document.getElementById('telegramLogin'),
            gameContent: document.getElementById('gameContent'),
            telegramLoginButton: document.getElementById('telegramLoginButton'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userLevel: document.getElementById('userLevel'),
            wanhuaCoins: document.getElementById('wanhuaCoins'),
            checkInButton: document.getElementById('checkInButton'),
            shareButton: document.getElementById('shareButton'),
            claimRewardsButton: document.getElementById('claimRewardsButton'),
            watchAdButton: document.getElementById('watchAdButton'),
            leaderboardList: document.getElementById('leaderboardList'),
            withdrawButton: document.getElementById('withdrawButton'),
            withdrawAmount: document.getElementById('withdrawAmount'),
            alipayAccount: document.getElementById('alipayAccount'),
            realName: document.getElementById('realName'),
            withdrawHistoryList: document.getElementById('withdrawHistoryList'),
            levelModal: document.getElementById('levelModal'),
            levelModalClose: document.getElementById('levelModalClose'),
            levelModalTitle: document.getElementById('levelModalTitle'),
            levelTypeContainer: document.getElementById('levelTypeContainer'),
            levelDifficultyContainer: document.getElementById('levelDifficultyContainer'),
            levelReward: document.getElementById('levelReward'),
            levelDescription: document.getElementById('levelDescription'),
            gameArea: document.getElementById('gameArea'),
            hintButton: document.getElementById('hintButton'),
            startLevelButton: document.getElementById('startLevelButton'),
            notification: document.getElementById('notification'),
            notificationTitle: document.getElementById('notificationTitle'),
            notificationMessage: document.getElementById('notificationMessage'),
            achievementPopup: document.getElementById('achievementPopup'),
            achievementTitle: document.getElementById('achievementTitle'),
            achievementDescription: document.getElementById('achievementDescription'),
            achievementReward: document.getElementById('achievementReward'),
            achievementClose: document.getElementById('achievementClose')
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查是否已登录
            const savedUser = localStorage.getItem('wanhua_user');
            if (savedUser) {
                try {
                    gameState.user = JSON.parse(savedUser);
                    await loadUserData();
                    showGameContent();
                } catch (error) {
                    console.error('Failed to parse saved user:', error);
                    localStorage.removeItem('wanhua_user');
                }
            }
            
            // 绑定事件
            bindEvents();
            
            // 设置Telegram登录
            setupTelegramLogin();
        });
        
        // 绑定事件
        function bindEvents() {
            // Telegram登录按钮
            elements.telegramLoginButton.addEventListener('click', () => {
                window.location.href = `https://t.me/${config.telegramBotUsername}`;
            });
            
            // 游戏模式选择
            document.querySelectorAll('.game-mode').forEach(mode => {
                mode.addEventListener('click', () => {
                    const modeType = mode.dataset.mode;
                    startGameMode(modeType);
                });
            });
            
            // 签到按钮
            elements.checkInButton.addEventListener('click', async () => {
                if (!gameState.user) return;
                
                try {
                    elements.checkInButton.disabled = true;
                    elements.checkInButton.textContent = '签到中...';
                    
                    const response = await fetch(config.apiBaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'checkIn',
                            userId: gameState.user.id
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('success', '签到成功', `获得 ${result.reward_coins} 万花币`);
                        await loadUserData();
                        
                        if (result.is_weekly_bonus) {
                            showNotification('success', '连续签到7天', '获得额外10万花币奖励！');
                        }
                    } else {
                        showNotification('info', '签到失败', result.message);
                    }
                } catch (error) {
                    console.error('Check in error:', error);
                    showNotification('error', '签到失败', '请稍后再试');
                } finally {
                    elements.checkInButton.disabled = false;
                    elements.checkInButton.textContent = '签到';
                }
            });
            
            // 分享按钮
            elements.shareButton.addEventListener('click', async () => {
                if (!gameState.user) return;
                
                try {
                    const shareText = `我正在玩《万象谜题》，一款极具挑战性的创意解谜游戏，已经完成了${gameState.userData.game_progress.levels_completed}个关卡！快来挑战吧！`;
                    const shareUrl = `https://t.me/${config.telegramBotUsername}?start=share_${gameState.user.id}`;
                    
                    if (navigator.share) {
                        await navigator.share({
                            title: '万象谜题',
                            text: shareText,
                            url: shareUrl
                        });
                    } else {
                        // 复制到剪贴板
                        await navigator.clipboard.writeText(`${shareText}\n${shareUrl}`);
                        showNotification('info', '已复制到剪贴板', '请粘贴并分享');
                    }
                    
                    // 记录分享
                    const response = await fetch(config.apiBaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'recordShare',
                            userId: gameState.user.id,
                            shareType: 'telegram',
                            shareContent: shareText
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('success', '分享成功', `获得 ${result.reward_coins} 万花币`);
                        await loadUserData();
                    }
                } catch (error) {
                    console.error('Share error:', error);
                    showNotification('error', '分享失败', '请稍后再试');
                }
            });
            
            // 观看广告按钮
            elements.watchAdButton.addEventListener('click', async () => {
                if (!gameState.user) return;
                
                try {
                    elements.watchAdButton.disabled = true;
                    elements.watchAdButton.textContent = '加载中...';
                    
                    // 模拟观看广告
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // 记录广告观看
                    const response = await fetch(config.apiBaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'recordAdView',
                            userId: gameState.user.id,
                            adType: 'rewarded'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('success', '广告观看完成', `获得 ${result.reward_coins} 万花币`);
                        await loadUserData();
                    }
                } catch (error) {
                    console.error('Watch ad error:', error);
                    showNotification('error', '广告观看失败', '请稍后再试');
                } finally {
                    elements.watchAdButton.disabled = false;
                    elements.watchAdButton.textContent = '观看广告 (+5万花币)';
                }
            });
            
            // 排行榜标签切换
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabType = tab.dataset.tab;
                    loadLeaderboard(tabType);
                });
            });
            
            // 提现按钮
            elements.withdrawButton.addEventListener('click', async () => {
                if (!gameState.user) return;
                
                const amount = parseInt(elements.withdrawAmount.value);
                const alipayAccount = elements.alipayAccount.value.trim();
                const realName = elements.realName.value.trim();
                
                if (!alipayAccount || !realName) {
                    showNotification('error', '信息不完整', '请填写支付宝账号和真实姓名');
                    return;
                }
                
                try {
                    elements.withdrawButton.disabled = true;
                    elements.withdrawButton.textContent = '提交中...';
                    
                    const response = await fetch(config.apiBaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'requestWithdrawal',
                            userId: gameState.user.id,
                            amount,
                            alipayAccount,
                            realName
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('success', '提现申请成功', result.message);
                        elements.alipayAccount.value = '';
                        elements.realName.value = '';
                        await loadUserData();
                        loadWithdrawHistory();
                    } else {
                        showNotification('error', '提现申请失败', result.error || '请稍后再试');
                    }
                } catch (error) {
                    console.error('Withdraw error:', error);
                    showNotification('error', '提现申请失败', '请稍后再试');
                } finally {
                    elements.withdrawButton.disabled = false;
                    elements.withdrawButton.textContent = '申请提现';
                }
            });
            
            // 关卡模态框关闭按钮
            elements.levelModalClose.addEventListener('click', () => {
                elements.levelModal.style.display = 'none';
                resetGame();
            });
            
            // 提示按钮
            elements.hintButton.addEventListener('click', async () => {
                if (!gameState.user || !gameState.currentLevel) return;
                
                try {
                    if (gameState.userData.user.total_wanhua_coins < 3) {
                        showNotification('error', '万花币不足', '获取提示需要3个万花币');
                        return;
                    }
                    
                    // 使用提示
                    gameState.hintsUsed++;
                    showGameHint();
                    
                    // 扣除万花币
                    const response = await fetch(config.apiBaseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'useCoins',
                            userId: gameState.user.id,
                            amount: 3
                        })
                    });
                    
                    await loadUserData();
                } catch (error) {
                    console.error('Use hint error:', error);
                    showNotification('error', '使用提示失败', '请稍后再试');
                }
            });
            
            // 开始关卡按钮
            elements.startLevelButton.addEventListener('click', () => {
                if (!gameState.currentLevel) return;
                
                if (elements.startLevelButton.textContent === '开始挑战') {
                    startGameLevel();
                } else if (elements.startLevelButton.textContent === '重新挑战') {
                    resetGameLevel();
                    startGameLevel();
                } else if (elements.startLevelButton.textContent === '下一关') {
                    elements.levelModal.style.display = 'none';
                    startGameMode(gameState.currentLevel.type);
                }
            });
            
            // 成就弹窗关闭按钮
            elements.achievementClose.addEventListener('click', () => {
                elements.achievementPopup.classList.remove('show');
            });
        }
        
        // 设置Telegram登录
        function setupTelegramLogin() {
            // 检查URL参数中是否有Telegram登录数据
            const urlParams = new URLSearchParams(window.location.search);
            const tgData = urlParams.get('tg_data');
            
            if (tgData) {
                try {
                    const userData = JSON.parse(atob(tgData));
                    if (userData.id) {
                        // 保存用户数据
                        gameState.user = userData;
                        localStorage.setItem('wanhua_user', JSON.stringify(userData));
                        
                        // 加载用户数据
                        loadUserData().then(() => {
                            showGameContent();
                            
                            // 清理URL参数
                            const newUrl = window.location.pathname;
                            window.history.pushState({}, document.title, newUrl);
                        });
                    }
                } catch (error) {
                    console.error('Failed to parse Telegram data:', error);
                }
            }
        }
        
        // 加载用户数据
        async function loadUserData() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(config.apiBaseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'getUserData',
                        userId: gameState.user.id
                    })
                });
                
                const userData = await response.json();
                
                if (userData.error) {
                    throw new Error(userData.error);
                }
                
                gameState.userData = userData;
                
                // 更新UI
                updateUserInterface();
                
                // 加载排行榜
                loadLeaderboard('monthly');
                
                // 加载提现记录
                loadWithdrawHistory();
                
                // 检查签到状态
                updateCheckInButton();
                
                // 检查成就
                checkAchievements();
            } catch (error) {
                console.error('Load user data error:', error);
                showNotification('error', '加载用户数据失败', '请稍后再试');
            }
        }
        
        // 更新用户界面
        function updateUserInterface() {
            if (!gameState.userData) return;
            
            const { user } = gameState.userData;
            
            // 更新用户信息
            elements.userAvatar.textContent = (user.username || user.first_name || 'U').charAt(0).toUpperCase();
            elements.userName.textContent = user.username || user.first_name || '用户';
            elements.userLevel.textContent = user.current_level;
            elements.wanhuaCoins.textContent = user.total_wanhua_coins;
            
            // 更新提现选项
            updateWithdrawOptions();
        }
        
        // 更新签到按钮
        function updateCheckInButton() {
            if (!gameState.userData) return;
            
            if (gameState.userData.today_check_in) {
                elements.checkInButton.textContent = '已签到';
                elements.checkInButton.disabled = true;
            } else {
                elements.checkInButton.textContent = '签到';
                elements.checkInButton.disabled = false;
            }
        }
        
        // 更新提现选项
        function updateWithdrawOptions() {
            if (!gameState.userData) return;
            
            const coins = gameState.userData.user.total_wanhua_coins;
            
            // 更新提现选项
            const options = elements.withdrawAmount.options;
            for (let i = 0; i < options.length; i++) {
                const amount = parseInt(options[i].value);
                const requiredCoins = amount * 100;
                
                if (coins < requiredCoins) {
                    options[i].disabled = true;
                    options[i].textContent = `${amount}元 (万花币不足)`;
                } else {
                    options[i].disabled = false;
                    options[i].textContent = `${amount}元 (${requiredCoins}万花币)`;
                }
            }
        }
        
        // 加载排行榜
        async function loadLeaderboard(type) {
            try {
                // 显示加载状态
                elements.leaderboardList.innerHTML = `
                    <li class="leaderboard-item">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>加载中...</div>
                        </div>
                    </li>
                `;
                
                // 模拟API调用
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 模拟排行榜数据
                const leaderboardData = [
                    { rank: 1, name: '玩家一', score: 15000, levels: 50 },
                    { rank: 2, name: '玩家二', score: 12000, levels: 45 },
                    { rank: 3, name: '玩家三', score: 10000, levels: 40 },
                    { rank: 4, name: '玩家四', score: 8000, levels: 35 },
                    { rank: 5, name: '玩家五', score: 6000, levels: 30 },
                    { rank: 6, name: '玩家六', score: 5000, levels: 28 },
                    { rank: 7, name: '玩家七', score: 4000, levels: 25 },
                    { rank: 8, name: '玩家八', score: 3000, levels: 22 },
                    { rank: 9, name: '玩家九', score: 2000, levels: 20 },
                    { rank: 10, name: '玩家十', score: 1000, levels: 18 }
                ];
                
                // 更新排行榜UI
                elements.leaderboardList.innerHTML = '';
                
                leaderboardData.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item';
                    
                    const rankClass = player.rank <= 3 ? `top-${player.rank}` : '';
                    
                    li.innerHTML = `
                        <div class="leaderboard-rank ${rankClass}">${player.rank}</div>
                        <div class="leaderboard-avatar">${player.name.charAt(0)}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${player.name}</div>
                            <div class="leaderboard-score">完成关卡: ${player.levels} | 得分: ${player.score}</div>
                        </div>
                    `;
                    
                    elements.leaderboardList.appendChild(li);
                });
            } catch (error) {
                console.error('Load leaderboard error:', error);
                elements.leaderboardList.innerHTML = `
                    <li class="leaderboard-item">
                        <div>加载排行榜失败</div>
                    </li>
                `;
            }
        }
        
        // 加载提现记录
        async function loadWithdrawHistory() {
            if (!gameState.userData) return;
            
            try {
                const withdrawals = gameState.userData.withdrawals || [];
                
                if (withdrawals.length === 0) {
                    elements.withdrawHistoryList.innerHTML = `
                        <li class="withdraw-history-item">
                            <div>暂无提现记录</div>
                        </li>
                    `;
                    return;
                }
                
                elements.withdrawHistoryList.innerHTML = '';
                
                withdrawals.forEach(withdrawal => {
                    const li = document.createElement('li');
                    li.className = 'withdraw-history-item';
                    
                    const statusClass = `status-${withdrawal.status}`;
                    const statusText = withdrawal.status === 'pending' ? '审核中' : 
                                      withdrawal.status === 'approved' ? '已通过' : '已拒绝';
                    
                    li.innerHTML = `
                        <div>${withdrawal.amount}元 - ${withdrawal.created_at}</div>
                        <div class="withdraw-history-status ${statusClass}">${statusText}</div>
                    `;
                    
                    elements.withdrawHistoryList.appendChild(li);
                });
            } catch (error) {
                console.error('Load withdrawal history error:', error);
                elements.withdrawHistoryList.innerHTML = `
                    <li class="withdraw-history-item">
                        <div>加载提现记录失败</div>
                    </li>
                `;
            }
        }
        
        // 检查成就
        function checkAchievements() {
            if (!gameState.userData) return;
            
            const unclaimedAchievements = gameState.userData.achievements.filter(a => !a.claimed);
            
            if (unclaimedAchievements.length > 0) {
                // 显示第一个未领取的成就
                const achievement = unclaimedAchievements[0];
                showAchievementPopup(achievement);
                
                // 标记为已领取
                achievement.claimed = true;
            }
        }
        
        // 显示成就弹窗
        function showAchievementPopup(achievement) {
            elements.achievementTitle.textContent = achievement.achievement.name;
            elements.achievementDescription.textContent = achievement.achievement.description;
            elements.achievementReward.textContent = achievement.achievement.reward_coins;
            elements.achievementPopup.classList.add('show');
        }
        
        // 显示游戏内容
        function showGameContent() {
            elements.telegramLogin.style.display = 'none';
            elements.gameContent.style.display = 'block';
        }
        
        // 开始游戏模式
        function startGameMode(mode) {
            // 模拟根据模式获取关卡
            const levelNumber = gameState.userData.user.current_level;
            
            // 显示关卡模态框
            showLevelModal(levelNumber);
        }
        
        // 显示关卡模态框
        async function showLevelModal(levelNumber) {
            try {
                // 重置游戏状态
                resetGame();
                
                // 显示加载状态
                elements.levelModal.style.display = 'flex';
                elements.levelModalTitle.textContent = `关卡 ${levelNumber}`;
                elements.levelTypeContainer.innerHTML = '<div class="loading">加载中...</div>';
                elements.levelDifficultyContainer.innerHTML = '';
                elements.levelReward.textContent = '0';
                elements.levelDescription.textContent = '';
                elements.gameArea.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>加载中...</div>
                    </div>
                `;
                
                // 模拟获取关卡数据
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // 模拟关卡数据
                const levelData = {
                    id: `level_${levelNumber}`,
                    level_number: levelNumber,
                    name: `关卡 ${levelNumber}`,
                    type: ['puzzle', 'strategy', 'action', 'memory'][Math.floor(Math.random() * 4)],
                    difficulty: Math.floor(Math.random() * 5) + 1,
                    description: '这是一个示例关卡描述，实际游戏中会根据关卡类型和难度显示不同的描述。',
                    reward_coins: Math.floor(Math.random() * 20) + 1,
                    config: {}
                };
                
                gameState.currentLevel = levelData;
                
                // 更新关卡信息
                const typeClass = `type-${levelData.type}`;
                const typeName = config.levels[levelData.type].name;
                
                elements.levelTypeContainer.innerHTML = `
                    <span class="level-type ${typeClass}">${typeName}</span>
                `;
                
                // 更新难度星级
                elements.levelDifficultyContainer.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('i');
                    star.className = 'fas fa-star difficulty-star';
                    if (i < levelData.difficulty) {
                        star.style.color = '#ffd700';
                    } else {
                        star.style.color = '#ddd';
                    }
                    elements.levelDifficultyContainer.appendChild(star);
                }
                
                elements.levelReward.textContent = levelData.reward_coins;
                elements.levelDescription.textContent = levelData.description;
                
                // 初始化游戏区域
                initGameArea(levelData);
            } catch (error) {
                console.error('Show level modal error:', error);
                showNotification('error', '加载关卡失败', '请稍后再试');
                elements.levelModal.style.display = 'none';
            }
        }
        
        // 初始化游戏区域
        function initGameArea(levelData) {
            elements.gameArea.innerHTML = '';
            
            // 根据关卡类型初始化不同的游戏
            switch (levelData.type) {
                case 'puzzle':
                    initPuzzleGame(levelData);
                    break;
                case 'strategy':
                    initStrategyGame(levelData);
                    break;
                case 'action':
                    initActionGame(levelData);
                    break;
                case 'memory':
                    initMemoryGame(levelData);
                    break;
                default:
                    elements.gameArea.innerHTML = '<div>未知关卡类型</div>';
            }
        }
        
        // 初始化解谜游戏
        function initPuzzleGame(levelData) {
            const gameContainer = document.createElement('div');
            gameContainer.style.width = '100%';
            gameContainer.style.height = '100%';
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.alignItems = 'center';
            gameContainer.style.justifyContent = 'center';
            
            const puzzleTitle = document.createElement('h3');
            puzzleTitle.textContent = '图形拼接谜题';
            puzzleTitle.style.marginBottom = '20px';
            gameContainer.appendChild(puzzleTitle);
            
            const puzzleContainer = document.createElement('div');
            puzzleContainer.style.width = '300px';
            puzzleContainer.style.height = '300px';
            puzzleContainer.style.border = '2px dashed #ccc';
            puzzleContainer.style.borderRadius = '10px';
            puzzleContainer.style.position = 'relative';
            puzzleContainer.style.marginBottom = '20px';
            
            // 创建目标图形
            const targetShape = document.createElement('div');
            targetShape.style.width = '150px';
            targetShape.style.height = '150px';
            targetShape.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
            targetShape.style.border = '2px solid #667eea';
            targetShape.style.position = 'absolute';
            targetShape.style.top = '50%';
            targetShape.style.left = '50%';
            targetShape.style.transform = 'translate(-50%, -50%)';
            puzzleContainer.appendChild(targetShape);
            
            // 创建拼图碎片
            const piecesContainer = document.createElement('div');
            piecesContainer.style.display = 'flex';
            piecesContainer.style.flexWrap = 'wrap';
            piecesContainer.style.justifyContent = 'center';
            piecesContainer.style.maxWidth = '300px';
            
            const pieceCount = Math.min(levelData.difficulty + 2, 6);
            for (let i = 0; i < pieceCount; i++) {
                const piece = document.createElement('div');
                piece.style.width = '60px';
                piece.style.height = '60px';
                piece.style.backgroundColor = `hsl(${i * 60}, 70%, 80%)`;
                piece.style.border = '1px solid #667eea';
                piece.style.borderRadius = '5px';
                piece.style.margin = '5px';
                piece.style.cursor = 'pointer';
                piece.dataset.pieceId = i;
                
                piece.addEventListener('click', () => {
                    piece.style.display = 'none';
                    checkPuzzleComplete();
                });
                
                piecesContainer.appendChild(piece);
            }
            
            gameContainer.appendChild(puzzleContainer);
            gameContainer.appendChild(piecesContainer);
            elements.gameArea.appendChild(gameContainer);
        }
        
        // 检查拼图是否完成
        function checkPuzzleComplete() {
            const pieces = elements.gameArea.querySelectorAll('[data-piece-id]');
            const visiblePieces = Array.from(pieces).filter(piece => piece.style.display !== 'none');
            
            if (visiblePieces.length === 0) {
                // 拼图完成
                completeGameLevel();
            }
        }
        
        // 初始化策略游戏
        function initStrategyGame(levelData) {
            const gameContainer = document.createElement('div');
            gameContainer.style.width = '100%';
            gameContainer.style.height = '100%';
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.alignItems = 'center';
            gameContainer.style.justifyContent = 'center';
            
            const strategyTitle = document.createElement('h3');
            strategyTitle.textContent = '资源分配策略';
            strategyTitle.style.marginBottom = '20px';
            gameContainer.appendChild(strategyTitle);
            
            const resourcesContainer = document.createElement('div');
            resourcesContainer.style.width = '100%';
            resourcesContainer.style.maxWidth = '400px';
            resourcesContainer.style.marginBottom = '20px';
            
            const totalEnergy = 10;
            const energyDisplay = document.createElement('div');
            energyDisplay.textContent = `总能量: ${totalEnergy}`;
            energyDisplay.style.fontSize = '1.2rem';
            energyDisplay.style.fontWeight = 'bold';
            energyDisplay.style.marginBottom = '15px';
            energyDisplay.style.textAlign = 'center';
            resourcesContainer.appendChild(energyDisplay);
            
            const devicesContainer = document.createElement('div');
            
            const deviceCount = Math.min(levelData.difficulty + 1, 4);
            const devices = [];
            
            for (let i = 0; i < deviceCount; i++) {
                const deviceContainer = document.createElement('div');
                deviceContainer.style.display = 'flex';
                deviceContainer.style.alignItems = 'center';
                deviceContainer.style.marginBottom = '10px';
                
                const deviceName = document.createElement('div');
                deviceName.textContent = `设备 ${i + 1}`;
                deviceName.style.width = '80px';
                deviceContainer.appendChild(deviceName);
                
                const energyInput = document.createElement('input');
                energyInput.type = 'number';
                energyInput.min = '0';
                energyInput.max = '10';
                energyInput.value = '0';
                energyInput.style.width = '60px';
                energyInput.style.margin = '0 10px';
                energyInput.dataset.deviceId = i;
                
                energyInput.addEventListener('input', () => {
                    updateEnergyAllocation();
                });
                
                deviceContainer.appendChild(energyInput);
                
                const energyLabel = document.createElement('div');
                energyLabel.textContent = '能量';
                deviceContainer.appendChild(energyLabel);
                
                devicesContainer.appendChild(deviceContainer);
                
                devices.push({
                    id: i,
                    input: energyInput,
                    required: Math.floor(Math.random() * 3) + 2
                });
            }
            
            resourcesContainer.appendChild(devicesContainer);
            
            const remainingEnergy = document.createElement('div');
            remainingEnergy.textContent = `剩余能量: ${totalEnergy}`;
            remainingEnergy.style.fontSize = '1rem';
            remainingEnergy.style.marginTop = '10px';
            remainingEnergy.style.textAlign = 'center';
            resourcesContainer.appendChild(remainingEnergy);
            
            const checkButton = document.createElement('button');
            checkButton.textContent = '检查分配';
            checkButton.style.padding = '8px 15px';
            checkButton.style.backgroundColor = '#667eea';
            checkButton.style.color = 'white';
            checkButton.style.border = 'none';
            checkButton.style.borderRadius = '5px';
            checkButton.style.cursor = 'pointer';
            checkButton.style.marginTop = '15px';
            
            checkButton.addEventListener('click', () => {
                checkStrategyComplete(devices, totalEnergy);
            });
            
            resourcesContainer.appendChild(checkButton);
            
            gameContainer.appendChild(resourcesContainer);
            elements.gameArea.appendChild(gameContainer);
            
            // 更新能量分配函数
            window.updateEnergyAllocation = () => {
                let allocatedEnergy = 0;
                devices.forEach(device => {
                    allocatedEnergy += parseInt(device.input.value) || 0;
                });
                
                const remaining = totalEnergy - allocatedEnergy;
                remainingEnergy.textContent = `剩余能量: ${remaining}`;
                
                if (remaining < 0) {
                    remainingEnergy.style.color = 'red';
                } else {
                    remainingEnergy.style.color = 'black';
                }
            };
        }
        
        // 检查策略游戏是否完成
        function checkStrategyComplete(devices, totalEnergy) {
            let allocatedEnergy = 0;
            let satisfiedDevices = 0;
            
            devices.forEach(device => {
                const energy = parseInt(device.input.value) || 0;
                allocatedEnergy += energy;
                
                if (energy >= device.required) {
                    satisfiedDevices++;
                }
            });
            
            if (allocatedEnergy <= totalEnergy && satisfiedDevices >= Math.ceil(devices.length / 2)) {
                // 策略完成
                completeGameLevel();
            } else {
                showNotification('info', '分配不合理', '请重新分配能量，确保至少一半设备满足要求且不超过总能量');
            }
        }
        
        // 初始化动作游戏
        function initActionGame(levelData) {
            const gameContainer = document.createElement('div');
            gameContainer.style.width = '100%';
            gameContainer.style.height = '100%';
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.alignItems = 'center';
            gameContainer.style.justifyContent = 'center';
            
            const actionTitle = document.createElement('h3');
            actionTitle.textContent = '精准点击挑战';
            actionTitle.style.marginBottom = '20px';
            gameContainer.appendChild(actionTitle);
            
            const gameBoard = document.createElement('div');
            gameBoard.style.width = '300px';
            gameBoard.style.height = '300px';
            gameBoard.style.border = '2px solid #667eea';
            gameBoard.style.borderRadius = '10px';
            gameBoard.style.position = 'relative';
            gameBoard.style.marginBottom = '20px';
            gameBoard.style.backgroundColor = '#f8f9fa';
            
            const scoreDisplay = document.createElement('div');
            scoreDisplay.textContent = '得分: 0/5';
            scoreDisplay.style.fontSize = '1.2rem';
            scoreDisplay.style.fontWeight = 'bold';
            scoreDisplay.style.marginBottom = '10px';
            gameContainer.appendChild(scoreDisplay);
            
            const timerDisplay = document.createElement('div');
            timerDisplay.textContent = '时间: 30秒';
            timerDisplay.style.fontSize = '1rem';
            timerDisplay.style.marginBottom = '20px';
            gameContainer.appendChild(timerDisplay);
            
            let score = 0;
            let timeLeft = 30;
            let gameActive = false;
            let targets = [];
            
            const startButton = document.createElement('button');
            startButton.textContent = '开始挑战';
            startButton.style.padding = '10px 20px';
            startButton.style.backgroundColor = '#667eea';
            startButton.style.color = 'white';
            startButton.style.border = 'none';
            startButton.style.borderRadius = '5px';
            startButton.style.cursor = 'pointer';
            
            startButton.addEventListener('click', () => {
                if (gameActive) return;
                
                // 重置游戏状态
                score = 0;
                timeLeft = 30;
                gameActive = true;
                scoreDisplay.textContent = '得分: 0/5';
                timerDisplay.textContent = '时间: 30秒';
                startButton.textContent = '游戏中...';
                startButton.disabled = true;
                
                // 清除现有目标
                targets.forEach(target => target.remove());
                targets = [];
                
                // 开始计时器
                const timer = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = `时间: ${timeLeft}秒`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        endActionGame(score >= 5);
                    }
                }, 1000);
                
                // 创建目标
                const createTarget = () => {
                    if (!gameActive) return;
                    
                    const target = document.createElement('div');
                    target.style.width = '40px';
                    target.style.height = '40px';
                    target.style.backgroundColor = '#ff6b6b';
                    target.style.borderRadius = '50%';
                    target.style.position = 'absolute';
                    target.style.cursor = 'pointer';
                    
                    // 随机位置
                    const maxX = gameBoard.offsetWidth - 40;
                    const maxY = gameBoard.offsetHeight - 40;
                    target.style.left = `${Math.random() * maxX}px`;
                    target.style.top = `${Math.random() * maxY}px`;
                    
                    target.addEventListener('click', () => {
                        score++;
                        scoreDisplay.textContent = `得分: ${score}/5`;
                        target.remove();
                        
                        if (score >= 5) {
                            endActionGame(true);
                        }
                    });
                    
                    gameBoard.appendChild(target);
                    targets.push(target);
                    
                    // 目标自动消失
                    setTimeout(() => {
                        if (target.parentNode) {
                            target.remove();
                            const index = targets.indexOf(target);
                            if (index > -1) {
                                targets.splice(index, 1);
                            }
                        }
                    }, 2000);
                };
                
                // 定期创建目标
                const targetInterval = setInterval(() => {
                    if (!gameActive) {
                        clearInterval(targetInterval);
                        return;
                    }
                    createTarget();
                }, 1000);
                
                // 立即创建第一个目标
                createTarget();
                
                // 结束游戏函数
                window.endActionGame = (success) => {
                    gameActive = false;
                    clearInterval(timer);
                    clearInterval(targetInterval);
                    
                    // 清除所有目标
                    targets.forEach(target => target.remove());
                    targets = [];
                    
                    startButton.textContent = '开始挑战';
                    startButton.disabled = false;
                    
                    if (success) {
                        completeGameLevel();
                    } else {
                        showNotification('info', '挑战失败', '请在30秒内点击5个目标');
                    }
                };
            });
            
            gameContainer.appendChild(gameBoard);
            gameContainer.appendChild(startButton);
            elements.gameArea.appendChild(gameContainer);
        }
        
        // 初始化记忆游戏
        function initMemoryGame(levelData) {
            const gameContainer = document.createElement('div');
            gameContainer.style.width = '100%';
            gameContainer.style.height = '100%';
            gameContainer.style.display = 'flex';
            gameContainer.style.flexDirection = 'column';
            gameContainer.style.alignItems = 'center';
            gameContainer.style.justifyContent = 'center';
            
            const memoryTitle = document.createElement('h3');
            memoryTitle.textContent = '数字记忆挑战';
            memoryTitle.style.marginBottom = '20px';
            gameContainer.appendChild(memoryTitle);
            
            const sequenceDisplay = document.createElement('div');
            sequenceDisplay.style.fontSize = '2rem';
            sequenceDisplay.style.fontWeight = 'bold';
            sequenceDisplay.style.marginBottom = '20px';
            sequenceDisplay.style.minHeight = '50px';
            gameContainer.appendChild(sequenceDisplay);
            
            const inputContainer = document.createElement('div');
            inputContainer.style.marginBottom = '20px';
            
            const sequenceInput = document.createElement('input');
            sequenceInput.type = 'text';
            sequenceInput.placeholder = '请输入记住的数字序列';
            sequenceInput.style.padding = '10px';
            sequenceInput.style.border = '1px solid #ddd';
            sequenceInput.style.borderRadius = '5px';
            sequenceInput.style.fontSize = '1rem';
            sequenceInput.style.width = '250px';
            inputContainer.appendChild(sequenceInput);
            
            gameContainer.appendChild(inputContainer);
            
            const checkButton = document.createElement('button');
            checkButton.textContent = '检查答案';
            checkButton.style.padding = '10px 20px';
            checkButton.style.backgroundColor = '#667eea';
            checkButton.style.color = 'white';
            checkButton.style.border = 'none';
            checkButton.style.borderRadius = '5px';
            checkButton.style.cursor = 'pointer';
            checkButton.style.marginBottom = '20px';
            
            gameContainer.appendChild(checkButton);
            
            const startButton = document.createElement('button');
            startButton.textContent = '开始记忆';
            startButton.style.padding = '10px 20px';
            startButton.style.backgroundColor = '#28a745';
            startButton.style.color = 'white';
            startButton.style.border = 'none';
            startButton.style.borderRadius = '5px';
            startButton.style.cursor = 'pointer';
            
            let sequence = '';
            let showingSequence = false;
            
            startButton.addEventListener('click', () => {
                if (showingSequence) return;
                
                // 生成随机序列
                const sequenceLength = Math.min(levelData.difficulty + 2, 6);
                sequence = '';
                for (let i = 0; i < sequenceLength; i++) {
                    sequence += Math.floor(Math.random() * 10);
                }
                
                // 显示序列
                showingSequence = true;
                sequenceDisplay.textContent = sequence;
                sequenceInput.value = '';
                sequenceInput.disabled = true;
                checkButton.disabled = true;
                startButton.disabled = true;
                
                // 3秒后隐藏序列
                setTimeout(() => {
                    sequenceDisplay.textContent = '';
                    sequenceInput.disabled = false;
                    checkButton.disabled = false;
                    startButton.disabled = false;
                    showingSequence = false;
                }, 3000);
            });
            
            checkButton.addEventListener('click', () => {
                if (sequenceInput.value === sequence) {
                    completeGameLevel();
                } else {
                    showNotification('info', '记忆错误', '请重新尝试');
                }
            });
            
            gameContainer.appendChild(startButton);
            elements.gameArea.appendChild(gameContainer);
        }
        
        // 开始游戏关卡
        function startGameLevel() {
            if (!gameState.currentLevel) return;
            
            // 更新按钮状态
            elements.startLevelButton.textContent = '游戏中...';
            elements.startLevelButton.disabled = true;
            elements.hintButton.disabled = false;
            
            // 记录开始时间
            gameState.startTime = Date.now();
            
            // 根据关卡类型开始游戏
            switch (gameState.currentLevel.type) {
                case 'puzzle':
                    // 拼图游戏已在初始化时设置好事件监听
                    break;
                case 'strategy':
                    // 策略游戏已在初始化时设置好事件监听
                    break;
                case 'action':
                    // 动作游戏需要手动触发开始
                    if (window.startActionGame) {
                        window.startActionGame();
                    }
                    break;
                case 'memory':
                    // 记忆游戏需要手动触发开始
                    if (window.startMemoryGame) {
                        window.startMemoryGame();
                    }
                    break;
            }
        }
        
        // 完成游戏关卡
        async function completeGameLevel() {
            if (!gameState.currentLevel || !gameState.user) return;
            
            try {
                // 计算完成时间
                const completionTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                
                // 更新按钮状态
                elements.startLevelButton.textContent = '完成中...';
                elements.startLevelButton.disabled = true;
                
                // 调用API完成关卡
                const response = await fetch(config.apiBaseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'completeLevel',
                        userId: gameState.user.id,
                        levelId: gameState.currentLevel.id,
                        completionTime,
                        hintsUsed: gameState.hintsUsed
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 显示成功消息
                    elements.gameArea.innerHTML = `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: #28a745; margin-bottom: 20px;"></i>
                            <h3>关卡完成！</h3>
                            <p>用时: ${completionTime}秒</p>
                            <p>获得: ${result.reward_coins} 万花币</p>
                        </div>
                    `;
                    
                    // 更新按钮状态
                    elements.startLevelButton.textContent = '下一关';
                    elements.startLevelButton.disabled = false;
                    
                    // 更新用户数据
                    await loadUserData();
                } else {
                    throw new Error(result.error || '完成关卡失败');
                }
            } catch (error) {
                console.error('Complete level error:', error);
                showNotification('error', '完成关卡失败', '请稍后再试');
                
                // 更新按钮状态
                elements.startLevelButton.textContent = '重新挑战';
                elements.startLevelButton.disabled = false;
            }
        }
        
        // 重置游戏
        function resetGame() {
            gameState.currentLevel = null;
            gameState.startTime = null;
            gameState.hintsUsed = 0;
            
            if (gameState.gameTimer) {
                clearInterval(gameState.gameTimer);
                gameState.gameTimer = null;
            }
        }
        
        // 重置游戏关卡
        function resetGameLevel() {
            gameState.startTime = null;
            gameState.hintsUsed = 0;
            
            if (gameState.gameTimer) {
                clearInterval(gameState.gameTimer);
                gameState.gameTimer = null;
            }
            
            // 重新初始化游戏区域
            if (gameState.currentLevel) {
                initGameArea(gameState.currentLevel);
            }
        }
        
        // 显示游戏提示
        function showGameHint() {
            if (!gameState.currentLevel) return;
            
            let hintText = '';
            
            switch (gameState.currentLevel.type) {
                case 'puzzle':
                    hintText = '提示：点击所有拼图碎片，将它们全部隐藏即可完成拼图。';
                    break;
                case 'strategy':
                    hintText = '提示：合理分配能量，确保至少一半设备满足其最低能量需求。';
                    break;
                case 'action':
                    hintText = '提示：快速点击出现的红色目标，在30秒内点击5个目标即可完成挑战。';
                    break;
                case 'memory':
                    hintText = '提示：仔细记住显示的数字序列，3秒后输入正确的序列。';
                    break;
            }
            
            showNotification('info', '游戏提示', hintText);
        }
        
        // 显示通知
        function showNotification(type, title, message) {
            elements.notification.className = `notification ${type}`;
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notification.classList.add('show');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
