<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰∏áËä±Ê∂àÊ∂à‰πê</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFD166;
            --dark-color: #2D3436;
            --light-color: #F8F9FA;
            --success-color: #06D6A0;
            --warning-color: #FFD166;
            --danger-color: #EF476F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 414px;
            height: 100vh;
            max-height: 896px;
            background-color: var(--light-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
        }

        .coins-display {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .coins-icon {
            margin-right: 5px;
            color: var(--accent-color);
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .page {
            display: none;
            width: 100%;
            height: 100%;
            padding: 15px;
        }

        .page.active {
            display: block;
        }

        /* ÁôªÂΩïÈ°µÈù¢ */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        .login-page.active {
            display: flex;
        }

        .game-logo {
            width: 150px;
            height: 150px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .game-logo i {
            font-size: 80px;
            color: white;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .login-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            color: #666;
        }

        .login-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* ‰∏ªËèúÂçïÈ°µÈù¢ */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .user-info {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar i {
            font-size: 30px;
            color: white;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .user-coins {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
        }

        .menu-buttons {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-button {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .menu-button i {
            font-size: 30px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .menu-button span {
            font-weight: bold;
        }

        .daily-checkin {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .checkin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkin-title {
            font-size: 18px;
            font-weight: bold;
        }

        .checkin-button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkin-button:hover {
            background-color: var(--light-color);
        }

        .checkin-button:disabled {
            background-color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .checkin-progress {
            display: flex;
            justify-content: space-between;
        }

        .checkin-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }

        .checkin-day-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .checkin-day-circle.checked {
            background-color: white;
            color: var(--primary-color);
        }

        .checkin-day-label {
            font-size: 10px;
        }

        .daily-tasks {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tasks-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-progress {
            font-size: 14px;
            color: #666;
        }

        .task-reward {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
        }

        .task-claim-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .task-claim-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* ÂÖ≥Âç°ÈÄâÊã©È°µÈù¢ */
        .level-select {
            padding-bottom: 60px;
        }

        .level-map {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .level-path {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: #ddd;
            transform: translateY(-50%);
        }

        .level-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .level-node:hover {
            transform: scale(1.1);
        }

        .level-node.locked {
            background-color: #ccc;
            border-color: #999;
            color: #666;
            cursor: not-allowed;
        }

        .level-node.completed {
            background-color: var(--success-color);
            color: white;
        }

        .level-stars {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .level-star {
            color: var(--warning-color);
            font-size: 12px;
            margin: 0 1px;
        }

        .game-plays {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            padding: 15px;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plays-count {
            display: flex;
            align-items: center;
        }

        .plays-icon {
            margin-right: 5px;
            color: var(--primary-color);
        }

        .plays-actions {
            display: flex;
        }

        .play-action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .play-action-button i {
            margin-right: 5px;
        }

        /* Ê∏∏ÊàèÈ°µÈù¢ */
        .game-board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .game-info {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .game-level {
            font-weight: bold;
        }

        .game-score {
            display: flex;
            align-items: center;
        }

        .game-score i {
            margin-right: 5px;
            color: var(--primary-color);
        }

        .game-moves {
            display: flex;
            align-items: center;
        }

        .game-moves i {
            margin-right: 5px;
            color: var(--secondary-color);
        }

        .game-board {
            background-color: #f0f0f0;
            border-radius: 15px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-gap: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .game-cell {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .game-cell:hover {
            transform: scale(1.05);
        }

        .game-cell.selected {
            box-shadow: 0 0 0 3px var(--primary-color);
            transform: scale(1.1);
        }

        .game-cell.matched {
            animation: matchedAnimation 0.5s;
        }

        @keyframes matchedAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(0); opacity: 0; }
        }

        .game-element {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .element-red {
            background-color: #FF6B6B;
        }

        .element-blue {
            background-color: #4D96FF;
        }

        .element-green {
            background-color: #6BCB77;
        }

        .element-yellow {
            background-color: #FFD93D;
        }

        .element-purple {
            background-color: #9C51E0;
        }

        .element-orange {
            background-color: #FF9A3D;
        }

        .element-rocket-h {
            background-color: #FF6B6B;
            width: 100%;
            height: 40%;
            border-radius: 10px;
        }

        .element-rocket-v {
            background-color: #FF6B6B;
            width: 40%;
            height: 100%;
            border-radius: 10px;
        }

        .element-bomb {
            background-color: #FF6B6B;
            width: 80%;
            height: 80%;
            border-radius: 10px;
        }

        .element-rainbow {
            background: linear-gradient(45deg, #FF6B6B, #4D96FF, #6BCB77, #FFD93D, #9C51E0);
            width: 80%;
            height: 80%;
            border-radius: 50%;
        }

        .game-obstacle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .obstacle-ice {
            background-color: rgba(173, 216, 230, 0.7);
        }

        .obstacle-ice::after {
            content: "‚ùÑÔ∏è";
            font-size: 20px;
        }

        .obstacle-cage {
            background-color: rgba(169, 169, 169, 0.7);
        }

        .obstacle-cage::after {
            content: "üîí";
            font-size: 20px;
        }

        .game-powerups {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .powerup-button {
            background-color: white;
            border-radius: 15px;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .powerup-button:hover {
            transform: translateY(-5px);
        }

        .powerup-button.active {
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        .powerup-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* ÊàêÂ∞±È°µÈù¢ */
        .achievements-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .achievement-card {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
            font-size: 24px;
        }

        .achievement-icon.completed {
            background-color: var(--success-color);
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .achievement-progress {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
            margin-left: 10px;
        }

        /* ÊéíË°åÊ¶úÈ°µÈù¢ */
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 15px;
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .leaderboard-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .leaderboard-list {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .leaderboard-rank.top1 {
            background-color: gold;
            color: white;
        }

        .leaderboard-rank.top2 {
            background-color: silver;
            color: white;
        }

        .leaderboard-rank.top3 {
            background-color: #CD7F32;
            color: white;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .leaderboard-avatar i {
            font-size: 20px;
            color: white;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-coins {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-size: 14px;
        }

        .leaderboard-reward {
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ÊèêÁé∞È°µÈù¢ */
        .withdrawal-form {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .withdrawal-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .withdrawal-rate {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .withdrawal-amount {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
        }

        .withdrawal-button {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .withdrawal-button:hover {
            background-color: #e55555;
        }

        .withdrawal-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .withdrawal-history {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .withdrawal-history-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .withdrawal-history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .withdrawal-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .withdrawal-history-item:last-child {
            border-bottom: none;
        }

        .withdrawal-history-details {
            flex: 1;
        }

        .withdrawal-history-amount {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .withdrawal-history-date {
            font-size: 14px;
            color: #666;
        }

        .withdrawal-history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Â∫ïÈÉ®ÂØºËà™ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .nav-item:hover {
            transform: translateY(-3px);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* È°µËÑö */
        .app-footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ÊèêÁ§∫Ê°Ü */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }

        .modal-button-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .modal-button-secondary {
            background-color: #f0f0f0;
            color: var(--dark-color);
            border: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-title">‰∏áËä±Ê∂àÊ∂à‰πê</div>
            <div class="coins-display">
                <i class="fas fa-coins coins-icon"></i>
                <span id="header-coins">0</span>
            </div>
        </div>

        <div class="app-content">
            <!-- ÁôªÂΩïÈ°µÈù¢ -->
            <div class="page login-page active" id="login-page">
                <div class="game-logo">
                    <i class="fas fa-gem"></i>
                </div>
                <h1 class="login-title">‰∏áËä±Ê∂àÊ∂à‰πê</h1>
                <p class="login-subtitle">Ê∂àÈô§ÂÆùÁü≥ÔºåËµ¢Âèñ‰∏áËä±Â∏Å</p>
                <button class="login-button" id="login-button">
                    <i class="fab fa-telegram-plane"></i> ‰ΩøÁî®TelegramÁôªÂΩï
                </button>
            </div>

            <!-- ‰∏ªËèúÂçïÈ°µÈù¢ -->
            <div class="page main-menu" id="main-menu-page">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="user-name">Áé©ÂÆ∂</h3>
                        <div class="user-coins">
                            <i class="fas fa-coins"></i>
                            <span id="user-coins">0</span> ‰∏áËä±Â∏Å
                        </div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <div class="menu-button" id="play-button">
                        <i class="fas fa-play"></i>
                        <span>ÂºÄÂßãÊ∏∏Êàè</span>
                    </div>
                    <div class="menu-button" id="achievements-button">
                        <i class="fas fa-trophy"></i>
                        <span>ÊàêÂ∞±</span>
                    </div>
                    <div class="menu-button" id="leaderboard-button">
                        <i class="fas fa-crown"></i>
                        <span>ÊéíË°åÊ¶ú</span>
                    </div>
                    <div class="menu-button" id="withdrawal-button">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>ÊèêÁé∞</span>
                    </div>
                </div>

                <div class="daily-checkin">
                    <div class="checkin-header">
                        <div class="checkin-title">ÊØèÊó•Á≠æÂà∞</div>
                        <button class="checkin-button" id="checkin-button">Á≠æÂà∞</button>
                    </div>
                    <div class="checkin-progress" id="checkin-progress">
                        <!-- Á≠æÂà∞ËøõÂ∫¶Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>

                <div class="daily-tasks">
                    <div class="tasks-header">
                        <div class="tasks-title">ÊØèÊó•‰ªªÂä°</div>
                    </div>
                    <div id="daily-tasks-list">
                        <!-- ÊØèÊó•‰ªªÂä°Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>

            <!-- ÂÖ≥Âç°ÈÄâÊã©È°µÈù¢ -->
            <div class="page level-select" id="level-select-page">
                <div class="level-map" id="level-map">
                    <div class="level-path"></div>
                    <!-- ÂÖ≥Âç°ËäÇÁÇπÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                </div>
                <div class="game-plays">
                    <div class="plays-count">
                        <i class="fas fa-gamepad plays-icon"></i>
                        <span>Ââ©‰ΩôÊ¨°Êï∞: <span id="remaining-plays">0</span></span>
                    </div>
                    <div class="plays-actions">
                        <button class="play-action-button" id="watch-ad-button">
                            <i class="fas fa-ad"></i> ÁúãÂπøÂëä
                        </button>
                        <button class="play-action-button" id="share-button">
                            <i class="fas fa-share-alt"></i> ÂàÜ‰∫´
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ê∏∏ÊàèÈ°µÈù¢ -->
            <div class="page game-page" id="game-page">
                <div class="game-board-container">
                    <div class="game-info">
                        <div class="game-level">ÂÖ≥Âç° <span id="current-level">1</span></div>
                        <div class="game-score">
                            <i class="fas fa-star"></i>
                            <span id="game-score">0</span>
                        </div>
                        <div class="game-moves">
                            <i class="fas fa-hand-pointer"></i>
                            <span id="game-moves">0</span>
                        </div>
                    </div>
                    <div class="game-board" id="game-board">
                        <!-- Ê∏∏ÊàèÊ£ãÁõòÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                    </div>
                    <div class="game-powerups">
                        <div class="powerup-button" id="powerup-refresh">
                            <i class="fas fa-sync-alt"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-bomb">
                            <i class="fas fa-bomb"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-hammer">
                            <i class="fas fa-hammer"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-color">
                            <i class="fas fa-palette"></i>
                            <div class="powerup-count">3</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊàêÂ∞±È°µÈù¢ -->
            <div class="page achievements-page" id="achievements-page">
                <div class="achievements-list" id="achievements-list">
                    <!-- ÊàêÂ∞±ÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- ÊéíË°åÊ¶úÈ°µÈù¢ -->
            <div class="page leaderboard-page" id="leaderboard-page">
                <div class="leaderboard-tabs">
                    <div class="leaderboard-tab active" data-period="daily">Êó•Ê¶ú</div>
                    <div class="leaderboard-tab" data-period="weekly">Âë®Ê¶ú</div>
                    <div class="leaderboard-tab" data-period="monthly">ÊúàÊ¶ú</div>
                </div>
                <div class="leaderboard-list" id="leaderboard-list">
                    <!-- ÊéíË°åÊ¶úÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>

            <!-- ÊèêÁé∞È°µÈù¢ -->
            <div class="page withdrawal-page" id="withdrawal-page">
                <div class="withdrawal-form">
                    <div class="form-group">
                        <label class="form-label">ÊèêÁé∞ÈáëÈ¢ù (‰∏áËä±Â∏Å)</label>
                        <input type="number" class="form-input" id="withdrawal-amount" placeholder="ÊúÄÂ∞ë1000‰∏áËä±Â∏Å" min="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÊîØ‰ªòÂÆùË¥¶Âè∑</label>
                        <input type="text" class="form-input" id="alipay-account" placeholder="ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùË¥¶Âè∑">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÁúüÂÆûÂßìÂêç</label>
                        <input type="text" class="form-input" id="real-name" placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç">
                    </div>
                    <div class="withdrawal-info">
                        <div class="withdrawal-rate">
                            <span>Ê±áÁéá</span>
                            <span>1000‰∏áËä±Â∏Å = 10ÂÖÉ</span>
                        </div>
                        <div class="withdrawal-amount">
                            <span>È¢ÑËÆ°Âà∞Ë¥¶</span>
                            <span id="withdrawal-rmb">0ÂÖÉ</span>
                        </div>
                    </div>
                    <button class="withdrawal-button" id="submit-withdrawal">Êèê‰∫§ÊèêÁé∞Áî≥ËØ∑</button>
                </div>
                <div class="withdrawal-history">
                    <div class="withdrawal-history-header">ÊèêÁé∞ËÆ∞ÂΩï</div>
                    <div class="withdrawal-history-list" id="withdrawal-history-list">
                        <!-- ÊèêÁé∞ËÆ∞ÂΩïÂ∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Â∫ïÈÉ®ÂØºËà™ -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="main-menu-page">
                <i class="fas fa-home nav-icon"></i>
                <div class="nav-label">È¶ñÈ°µ</div>
            </div>
            <div class="nav-item" data-page="level-select-page">
                <i class="fas fa-gamepad nav-icon"></i>
                <div class="nav-label">Ê∏∏Êàè</div>
            </div>
            <div class="nav-item" data-page="achievements-page">
                <i class="fas fa-trophy nav-icon"></i>
                <div class="nav-label">ÊàêÂ∞±</div>
            </div>
            <div class="nav-item" data-page="leaderboard-page">
                <i class="fas fa-crown nav-icon"></i>
                <div class="nav-label">ÊéíË°å</div>
            </div>
            <div class="nav-item" data-page="withdrawal-page">
                <i class="fas fa-money-bill-wave nav-icon"></i>
                <div class="nav-label">ÊèêÁé∞</div>
            </div>
        </div>

        <div class="app-footer">
            Êú¨Ê∏∏ÊàèÁî±Âåó‰∫¨‰øÆËΩ¶„Äê‰∏áËä±Ê•º„ÄëËµûÂä©ÔºõÁî± <a href="https://t.me/bjxc010" target="_blank" class="footer-link">@bjxc010</a> ÂºÄÂèë
        </div>
    </div>

    <!-- ÊèêÁ§∫Ê°Ü -->
    <div class="toast" id="toast"></div>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">ÊèêÁ§∫</div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Ê®°ÊÄÅÊ°ÜÊåâÈíÆ -->
            </div>
        </div>
    </div>

    <script>
        // APIÂú∞ÂùÄ
        const API_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';

        // Ê∏∏ÊàèÁä∂ÊÄÅ
        const gameState = {
            user: null,
            currentLevel: 1,
            gameBoard: [],
            selectedCell: null,
            score: 0,
            moves: 0,
            maxMoves: 20,
            gameActive: false,
            powerups: {
                refresh: 3,
                bomb: 3,
                hammer: 3,
                color: 3
            }
        };

        // DOMÂÖÉÁ¥†
        const elements = {
            // È°µÈù¢
            pages: {
                login: document.getElementById('login-page'),
                mainMenu: document.getElementById('main-menu-page'),
                levelSelect: document.getElementById('level-select-page'),
                game: document.getElementById('game-page'),
                achievements: document.getElementById('achievements-page'),
                leaderboard: document.getElementById('leaderboard-page'),
                withdrawal: document.getElementById('withdrawal-page')
            },
            // Áî®Êà∑‰ø°ÊÅØ
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            userCoins: document.getElementById('user-coins'),
            headerCoins: document.getElementById('header-coins'),
            // Ê∏∏ÊàèÂÖÉÁ¥†
            gameBoard: document.getElementById('game-board'),
            currentLevel: document.getElementById('current-level'),
            gameScore: document.getElementById('game-score'),
            gameMoves: document.getElementById('game-moves'),
            // ÂÖ≥Âç°ÈÄâÊã©
            levelMap: document.getElementById('level-map'),
            remainingPlays: document.getElementById('remaining-plays'),
            // Á≠æÂà∞
            checkinButton: document.getElementById('checkin-button'),
            checkinProgress: document.getElementById('checkin-progress'),
            // ÊØèÊó•‰ªªÂä°
            dailyTasksList: document.getElementById('daily-tasks-list'),
            // ÊàêÂ∞±
            achievementsList: document.getElementById('achievements-list'),
            // ÊéíË°åÊ¶ú
            leaderboardTabs: document.querySelectorAll('.leaderboard-tab'),
            leaderboardList: document.getElementById('leaderboard-list'),
            // ÊèêÁé∞
            withdrawalAmount: document.getElementById('withdrawal-amount'),
            alipayAccount: document.getElementById('alipay-account'),
            realName: document.getElementById('real-name'),
            withdrawalRmb: document.getElementById('withdrawal-rmb'),
            withdrawalHistoryList: document.getElementById('withdrawal-history-list'),
            // ÂÖ∂‰ªñ
            toast: document.getElementById('toast'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalFooter: document.getElementById('modal-footer'),
            modalClose: document.getElementById('modal-close')
        };

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // Ê£ÄÊü•URLÂèÇÊï∞‰∏≠ÊòØÂê¶Êúâuser_id
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            
            if (userId) {
                // Â¶ÇÊûúÊúâuser_idÔºåÁõ¥Êé•Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                fetchUser(userId);
            } else {
                // Âê¶ÂàôÊòæÁ§∫ÁôªÂΩïÈ°µÈù¢
                showPage('login');
            }
            
            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents();
        });

        // ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            // ÁôªÂΩïÊåâÈíÆ
            document.getElementById('login-button').addEventListener('click', () => {
                // Âú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøôÈáåÂ∫îËØ•Ë∞ÉÁî®TelegramÁôªÂΩïAPI
                // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Ê®°ÊãüÁôªÂΩï
                const mockUser = {
                    id: 123456789,
                    first_name: 'ÊµãËØï',
                    last_name: 'Áî®Êà∑',
                    username: 'testuser',
                    photo_url: null
                };
                
                login(mockUser);
            });
            
            // Â∫ïÈÉ®ÂØºËà™
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const pageId = item.getAttribute('data-page');
                    showPage(pageId);
                    
                    // Êõ¥Êñ∞ÂØºËà™Ê†èÊøÄÊ¥ªÁä∂ÊÄÅ
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    item.classList.add('active');
                });
            });
            
            // ‰∏ªËèúÂçïÊåâÈíÆ
            document.getElementById('play-button').addEventListener('click', () => {
                showPage('levelSelect');
                loadLevelMap();
                loadGamePlays();
            });
            
            document.getElementById('achievements-button').addEventListener('click', () => {
                showPage('achievements');
                loadAchievements();
            });
            
            document.getElementById('leaderboard-button').addEventListener('click', () => {
                showPage('leaderboard');
                loadLeaderboard('monthly');
            });
            
            document.getElementById('withdrawal-button').addEventListener('click', () => {
                showPage('withdrawal');
                loadWithdrawalHistory();
            });
            
            // Á≠æÂà∞ÊåâÈíÆ
            elements.checkinButton.addEventListener('click', () => {
                dailyCheckin();
            });
            
            // Ê∏∏ÊàèÊ¨°Êï∞ÊåâÈíÆ
            document.getElementById('watch-ad-button').addEventListener('click', () => {
                // Ê®°ÊãüÁúãÂπøÂëä
                addGamePlay('ad');
            });
            
            document.getElementById('share-button').addEventListener('click', () => {
                // Ê®°ÊãüÂàÜ‰∫´
                shareGame();
            });
            
            // ÊèêÁé∞Ë°®Âçï
            elements.withdrawalAmount.addEventListener('input', updateWithdrawalRmb);
            document.getElementById('submit-withdrawal').addEventListener('click', submitWithdrawal);
            
            // ÊéíË°åÊ¶úÊ†áÁ≠æ
            elements.leaderboardTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const period = tab.getAttribute('data-period');
                    
                    // Êõ¥Êñ∞Ê†áÁ≠æÊøÄÊ¥ªÁä∂ÊÄÅ
                    elements.leaderboardTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Âä†ËΩΩÂØπÂ∫îÊéíË°åÊ¶ú
                    loadLeaderboard(period);
                });
            });
            
            // Ê®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÊåâÈíÆ
            elements.modalClose.addEventListener('click', closeModal);
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            elements.modal.addEventListener('click', (e) => {
                if (e.target === elements.modal) {
                    closeModal();
                }
            });
        }

        // ÊòæÁ§∫È°µÈù¢
        function showPage(pageId) {
            // ÈöêËóèÊâÄÊúâÈ°µÈù¢
            Object.values(elements.pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
            if (elements.pages[pageId]) {
                elements.pages[pageId].classList.add('active');
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫
        function showToast(message, duration = 3000) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, duration);
        }

        // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
        function showModal(title, content, buttons = []) {
            elements.modalTitle.textContent = title;
            elements.modalBody.innerHTML = content;
            
            // Ê∏ÖÁ©∫ÊåâÈíÆÂÆπÂô®
            elements.modalFooter.innerHTML = '';
            
            // Ê∑ªÂä†ÊåâÈíÆ
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.textContent = button.text;
                btn.className = `modal-button ${button.primary ? 'modal-button-primary' : 'modal-button-secondary'}`;
                
                btn.addEventListener('click', () => {
                    if (button.onClick) {
                        button.onClick();
                    }
                    closeModal();
                });
                
                elements.modalFooter.appendChild(btn);
            });
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            elements.modal.classList.add('active');
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            elements.modal.classList.remove('active');
        }

        // ÁôªÂΩï
        async function login(telegramData) {
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ telegramData })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
                gameState.user = data.user;
                
                // Êõ¥Êñ∞UI
                updateUserUI();
                
                // ÊòæÁ§∫‰∏ªËèúÂçï
                showPage('mainMenu');
                
                // Êõ¥Êñ∞ÂØºËà™Ê†èÊøÄÊ¥ªÁä∂ÊÄÅ
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="main-menu-page"]').classList.add('active');
                
                // Âä†ËΩΩÁ≠æÂà∞Áä∂ÊÄÅ
                loadCheckinStatus();
                
                // Âä†ËΩΩÊØèÊó•‰ªªÂä°
                loadDailyTasks();
                
                // Â¶ÇÊûúÊòØÊñ∞Áî®Êà∑ÔºåÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
                if (data.isNewUser) {
                    showToast('Ê¨¢ËøéÊù•Âà∞‰∏áËä±Ê∂àÊ∂à‰πêÔºÅÊÇ®Â∑≤Ëé∑Âæó50‰∏áËä±Â∏Å‰Ωú‰∏∫Ê≥®ÂÜåÂ•ñÂä±„ÄÇ');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('ÁôªÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
        async function fetchUser(userId) {
            try {
                const response = await fetch(`${API_URL}/user?user_id=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    showPage('login');
                    return;
                }
                
                // ‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ
                gameState.user = data.user;
                
                // Êõ¥Êñ∞UI
                updateUserUI();
                
                // ÊòæÁ§∫‰∏ªËèúÂçï
                showPage('mainMenu');
                
                // Êõ¥Êñ∞ÂØºËà™Ê†èÊøÄÊ¥ªÁä∂ÊÄÅ
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="main-menu-page"]').classList.add('active');
                
                // Âä†ËΩΩÁ≠æÂà∞Áä∂ÊÄÅ
                loadCheckinStatus();
                
                // Âä†ËΩΩÊØèÊó•‰ªªÂä°
                loadDailyTasks();
            } catch (error) {
                console.error('Fetch user error:', error);
                showToast('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                showPage('login');
            }
        }

        // Êõ¥Êñ∞Áî®Êà∑UI
        function updateUserUI() {
            if (!gameState.user) return;
            
            // Êõ¥Êñ∞Áî®Êà∑Â§¥ÂÉè
            if (gameState.user.photo_url) {
                elements.userAvatar.innerHTML = `<img src="${gameState.user.photo_url}" alt="Avatar">`;
            } else {
                elements.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // Êõ¥Êñ∞Áî®Êà∑Âêç
            elements.userName.textContent = gameState.user.first_name || 'Áé©ÂÆ∂';
            
            // Êõ¥Êñ∞‰∏áËä±Â∏Å
            elements.userCoins.textContent = gameState.user.flower_coins || 0;
            elements.headerCoins.textContent = gameState.user.flower_coins || 0;
        }

        // Âä†ËΩΩÁ≠æÂà∞Áä∂ÊÄÅ
        async function loadCheckinStatus() {
            try {
                // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIËé∑ÂèñÁ≠æÂà∞Áä∂ÊÄÅ
                // ÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Ê®°Êãü
                const checkinData = {
                    consecutive_days: 3,
                    can_checkin: true
                };
                
                // Êõ¥Êñ∞Á≠æÂà∞ËøõÂ∫¶UI
                updateCheckinProgress(checkinData.consecutive_days);
                
                // Êõ¥Êñ∞Á≠æÂà∞ÊåâÈíÆ
                elements.checkinButton.disabled = !checkinData.can_checkin;
                elements.checkinButton.textContent = checkinData.can_checkin ? 'Á≠æÂà∞' : 'Â∑≤Á≠æÂà∞';
            } catch (error) {
                console.error('Load checkin status error:', error);
            }
        }

        // Êõ¥Êñ∞Á≠æÂà∞ËøõÂ∫¶UI
        function updateCheckinProgress(consecutiveDays) {
            elements.checkinProgress.innerHTML = '';
            
            for (let i = 1; i <= 7; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'checkin-day';
                
                const circleElement = document.createElement('div');
                circleElement.className = 'checkin-day-circle';
                
                if (i <= consecutiveDays) {
                    circleElement.classList.add('checked');
                }
                
                circleElement.textContent = i;
                
                const labelElement = document.createElement('div');
                labelElement.className = 'checkin-day-label';
                labelElement.textContent = `Á¨¨${i}Â§©`;
                
                dayElement.appendChild(circleElement);
                dayElement.appendChild(labelElement);
                
                elements.checkinProgress.appendChild(dayElement);
            }
        }

        // ÊØèÊó•Á≠æÂà∞
        async function dailyCheckin() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/daily_checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: gameState.user.id })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞Áî®Êà∑‰∏áËä±Â∏Å
                gameState.user.flower_coins += data.flower_coins_earned;
                updateUserUI();
                
                // Êõ¥Êñ∞Á≠æÂà∞ËøõÂ∫¶
                updateCheckinProgress(data.consecutive_days);
                
                // Á¶ÅÁî®Á≠æÂà∞ÊåâÈíÆ
                elements.checkinButton.disabled = true;
                elements.checkinButton.textContent = 'Â∑≤Á≠æÂà∞';
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showToast(`Á≠æÂà∞ÊàêÂäüÔºÅËé∑Âæó${data.flower_coins_earned}‰∏áËä±Â∏Å`);
            } catch (error) {
                console.error('Daily checkin error:', error);
                showToast('Á≠æÂà∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Âä†ËΩΩÊØèÊó•‰ªªÂä°
        async function loadDailyTasks() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/daily_tasks?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞ÊØèÊó•‰ªªÂä°UI
                updateDailyTasksUI(data.daily_tasks);
            } catch (error) {
                console.error('Load daily tasks error:', error);
                showToast('Âä†ËΩΩÊØèÊó•‰ªªÂä°Â§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞ÊØèÊó•‰ªªÂä°UI
        function updateDailyTasksUI(tasks) {
            elements.dailyTasksList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                
                const taskInfo = document.createElement('div');
                taskInfo.className = 'task-info';
                
                const taskName = document.createElement('div');
                taskName.className = 'task-name';
                taskName.textContent = task.description;
                
                const taskProgress = document.createElement('div');
                taskProgress.className = 'task-progress';
                taskProgress.textContent = `${task.progress_value}/${task.target_value}`;
                
                taskInfo.appendChild(taskName);
                taskInfo.appendChild(taskProgress);
                
                const taskReward = document.createElement('div');
                taskReward.className = 'task-reward';
                taskReward.innerHTML = `<i class="fas fa-coins"></i> ${task.flower_coins_reward}`;
                
                if (task.completed && !task.flower_coins_claimed) {
                    const claimButton = document.createElement('button');
                    claimButton.className = 'task-claim-button';
                    claimButton.textContent = 'È¢ÜÂèñ';
                    
                    claimButton.addEventListener('click', () => {
                        claimTaskReward(task.id);
                    });
                    
                    taskReward.appendChild(claimButton);
                }
                
                taskElement.appendChild(taskInfo);
                taskElement.appendChild(taskReward);
                
                elements.dailyTasksList.appendChild(taskElement);
            });
        }

        // È¢ÜÂèñ‰ªªÂä°Â•ñÂä±
        async function claimTaskReward(taskId) {
            if (!gameState.user) return;
            
            try {
                // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIÈ¢ÜÂèñ‰ªªÂä°Â•ñÂä±
                // ÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Ê®°Êãü
                const reward = 50;
                
                // Êõ¥Êñ∞Áî®Êà∑‰∏áËä±Â∏Å
                gameState.user.flower_coins += reward;
                updateUserUI();
                
                // ÈáçÊñ∞Âä†ËΩΩÊØèÊó•‰ªªÂä°
                loadDailyTasks();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showToast(`‰ªªÂä°Â•ñÂä±È¢ÜÂèñÊàêÂäüÔºÅËé∑Âæó${reward}‰∏áËä±Â∏Å`);
            } catch (error) {
                console.error('Claim task reward error:', error);
                showToast('È¢ÜÂèñ‰ªªÂä°Â•ñÂä±Â§±Ë¥•');
            }
        }

        // Âä†ËΩΩÂÖ≥Âç°Âú∞Âõæ
        async function loadLevelMap() {
            try {
                const response = await fetch(`${API_URL}/levels`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞ÂÖ≥Âç°Âú∞ÂõæUI
                updateLevelMapUI(data.levels);
            } catch (error) {
                console.error('Load levels error:', error);
                showToast('Âä†ËΩΩÂÖ≥Âç°Â§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞ÂÖ≥Âç°Âú∞ÂõæUI
        function updateLevelMapUI(levels) {
            // Ê∏ÖÈô§Áé∞ÊúâÂÖ≥Âç°ËäÇÁÇπ
            const existingNodes = elements.levelMap.querySelectorAll('.level-node');
            existingNodes.forEach(node => node.remove());
            
            // ÂàõÂª∫Êñ∞ÂÖ≥Âç°ËäÇÁÇπ
            levels.forEach((level, index) => {
                const node = document.createElement('div');
                node.className = 'level-node';
                node.textContent = level.level_number;
                
                // ËÆæÁΩÆ‰ΩçÁΩÆ
                const position = calculateNodePosition(index, levels.length);
                node.style.left = `${position.x}%`;
                node.style.top = `${position.y}%`;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                node.addEventListener('click', () => {
                    startLevel(level.id);
                });
                
                elements.levelMap.appendChild(node);
                
                // Â¶ÇÊûúÂÖ≥Âç°Â∑≤ÂÆåÊàêÔºåÊ∑ªÂä†ÊòüÊòü
                if (index < 3) { // Ê®°ÊãüÂâç3‰∏™ÂÖ≥Âç°Â∑≤ÂÆåÊàê
                    node.classList.add('completed');
                    
                    const stars = document.createElement('div');
                    stars.className = 'level-stars';
                    
                    for (let i = 0; i < 3; i++) {
                        const star = document.createElement('i');
                        star.className = 'fas fa-star level-star';
                        stars.appendChild(star);
                    }
                    
                    node.appendChild(stars);
                }
            });
        }

        // ËÆ°ÁÆóÂÖ≥Âç°ËäÇÁÇπ‰ΩçÁΩÆ
        function calculateNodePosition(index, total) {
            // ÁÆÄÂåñÂ§ÑÁêÜÔºåÂ∞ÜËäÇÁÇπÊéíÂàóÂú®‰∏ÄÊù°Êõ≤Á∫ø‰∏ä
            const x = (index / (total - 1)) * 80 + 10; // 10% - 90%
            const y = 50 + Math.sin((index / (total - 1)) * Math.PI) * 20; // Ê≥¢Êµ™ÂΩ¢
            
            return { x, y };
        }

        // Âä†ËΩΩÊ∏∏ÊàèÊ¨°Êï∞
        async function loadGamePlays() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/game_plays?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // ËÆ°ÁÆóÂâ©‰ΩôÊ∏∏ÊàèÊ¨°Êï∞
                const gamePlay = data.game_play;
                const remainingPlays = 7 - gamePlay.free_plays_used + 
                                     (5 - gamePlay.ad_plays_used) + 
                                     (3 - gamePlay.share_plays_used) + 
                                     gamePlay.gift_plays_used;
                
                // Êõ¥Êñ∞UI
                elements.remainingPlays.textContent = remainingPlays;
            } catch (error) {
                console.error('Load game plays error:', error);
                showToast('Âä†ËΩΩÊ∏∏ÊàèÊ¨°Êï∞Â§±Ë¥•');
            }
        }

        // Ê∑ªÂä†Ê∏∏ÊàèÊ¨°Êï∞
        async function addGamePlay(type) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/use_game_play`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: gameState.user.id,
                        play_type: type
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // ÈáçÊñ∞Âä†ËΩΩÊ∏∏ÊàèÊ¨°Êï∞
                loadGamePlays();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                if (type === 'ad') {
                    showToast('ËßÇÁúãÂπøÂëäÊàêÂäüÔºÅËé∑Âæó1Ê¨°Ê∏∏ÊàèÊú∫‰ºö');
                }
            } catch (error) {
                console.error('Add game play error:', error);
                showToast('Ê∑ªÂä†Ê∏∏ÊàèÊ¨°Êï∞Â§±Ë¥•');
            }
        }

        // ÂàÜ‰∫´Ê∏∏Êàè
        async function shareGame() {
            if (!gameState.user) return;
            
            try {
                // Ê®°ÊãüÂàÜ‰∫´Âà∞Telegram
                const shareUrl = `https://t.me/share/url?url=https://beijingshunyi.github.io/game-web/?user_id=${gameState.user.id}&text=Êù•Áé©‰∏áËä±Ê∂àÊ∂à‰πêÔºåÊ∂àÈô§ÂÆùÁü≥Ëµ¢Âèñ‰∏áËä±Â∏ÅÔºÅ`;
                window.open(shareUrl, '_blank');
                
                // ËÆ∞ÂΩïÂàÜ‰∫´
                const response = await fetch(`${API_URL}/record_share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: gameState.user.id,
                        share_type: 'telegram_group'
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // ÈáçÊñ∞Âä†ËΩΩÊ∏∏ÊàèÊ¨°Êï∞
                loadGamePlays();
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showToast('ÂàÜ‰∫´ÊàêÂäüÔºÅËé∑Âæó2Ê¨°Ê∏∏ÊàèÊú∫‰ºö');
            } catch (error) {
                console.error('Share game error:', error);
                showToast('ÂàÜ‰∫´Â§±Ë¥•');
            }
        }

        // ÂºÄÂßãÂÖ≥Âç°
        async function startLevel(levelId) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/level?level_id=${levelId}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // ‰øùÂ≠òÂÖ≥Âç°‰ø°ÊÅØ
                gameState.currentLevel = data.level;
                
                // ÂàùÂßãÂåñÊ∏∏Êàè
                initGame();
                
                // ÊòæÁ§∫Ê∏∏ÊàèÈ°µÈù¢
                showPage('game');
            } catch (error) {
                console.error('Start level error:', error);
                showToast('ÂºÄÂßãÂÖ≥Âç°Â§±Ë¥•');
            }
        }

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState.score = 0;
            gameState.moves = 0;
            gameState.gameActive = true;
            gameState.selectedCell = null;
            
            // Êõ¥Êñ∞UI
            elements.currentLevel.textContent = gameState.currentLevel.level_number;
            elements.gameScore.textContent = gameState.score;
            elements.gameMoves.textContent = gameState.moves;
            
            // ÁîüÊàêÊ∏∏ÊàèÊ£ãÁõò
            generateGameBoard();
        }

        // ÁîüÊàêÊ∏∏ÊàèÊ£ãÁõò
        function generateGameBoard() {
            // Ê∏ÖÁ©∫Ê£ãÁõò
            elements.gameBoard.innerHTML = '';
            
            // Ëé∑ÂèñÊ£ãÁõòÂ∞∫ÂØ∏
            const boardSize = gameState.currentLevel.board_config.size;
            const rows = boardSize[1];
            const cols = boardSize[0];
            
            // ËÆæÁΩÆÊ£ãÁõòÁΩëÊ†º
            elements.gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            elements.gameBoard.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            // ÁîüÊàêÊ∏∏ÊàèÂÖÉÁ¥†
            gameState.gameBoard = [];
            
            for (let row = 0; row < rows; row++) {
                gameState.gameBoard[row] = [];
                
                for (let col = 0; col < cols; col++) {
                    // ÂàõÂª∫ÂçïÂÖÉÊ†º
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // ÈöèÊú∫ÁîüÊàêÂÖÉÁ¥†Á±ªÂûã
                    const elementTypes = gameState.currentLevel.board_config.elements;
                    const elementType = elementTypes[Math.floor(Math.random() * elementTypes.length)];
                    
                    // ÂàõÂª∫Ê∏∏ÊàèÂÖÉÁ¥†
                    const element = document.createElement('div');
                    element.className = `game-element element-${elementType}`;
                    
                    // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                    cell.addEventListener('click', () => {
                        handleCellClick(row, col);
                    });
                    
                    cell.appendChild(element);
                    elements.gameBoard.appendChild(cell);
                    
                    // ‰øùÂ≠òÂà∞Ê∏∏ÊàèÁä∂ÊÄÅ
                    gameState.gameBoard[row][col] = {
                        type: elementType,
                        element: element,
                        cell: cell
                    };
                }
            }
        }

        // Â§ÑÁêÜÂçïÂÖÉÊ†ºÁÇπÂáª
        function handleCellClick(row, col) {
            if (!gameState.gameActive) return;
            
            const clickedCell = gameState.gameBoard[row][col];
            
            if (!gameState.selectedCell) {
                // ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂçïÂÖÉÊ†º
                gameState.selectedCell = { row, col };
                clickedCell.cell.classList.add('selected');
            } else {
                // Â∞ùËØïÂåπÈÖç
                const selectedRow = gameState.selectedCell.row;
                const selectedCol = gameState.selectedCell.col;
                
                // Ê£ÄÊü•ÊòØÂê¶Áõ∏ÈÇª
                const isAdjacent = 
                    (Math.abs(selectedRow - row) === 1 && selectedCol === col) ||
                    (Math.abs(selectedCol - col) === 1 && selectedRow === row);
                
                if (isAdjacent) {
                    // ‰∫§Êç¢ÂÖÉÁ¥†
                    swapElements(selectedRow, selectedCol, row, col);
                } else {
                    // ÈÄâÊã©Êñ∞ÁöÑÂçïÂÖÉÊ†º
                    gameState.gameBoard[selectedRow][selectedCol].cell.classList.remove('selected');
                    gameState.selectedCell = { row, col };
                    clickedCell.cell.classList.add('selected');
                }
            }
        }

        // ‰∫§Êç¢ÂÖÉÁ¥†
        function swapElements(row1, col1, row2, col2) {
            // ‰∫§Êç¢Ê∏∏ÊàèÁä∂ÊÄÅ‰∏≠ÁöÑÂÖÉÁ¥†
            const temp = gameState.gameBoard[row1][col1];
            gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
            gameState.gameBoard[row2][col2] = temp;
            
            // Êõ¥Êñ∞UI
            updateGameBoard();
            
            // Ê£ÄÊü•ÂåπÈÖç
            setTimeout(() => {
                const matches = findMatches();
                
                if (matches.length > 0) {
                    // ÊúâÂåπÈÖçÔºåÂ§ÑÁêÜÊ∂àÈô§
                    processMatches(matches);
                    
                    // Â¢ûÂä†ÁßªÂä®Ê¨°Êï∞
                    gameState.moves++;
                    elements.gameMoves.textContent = gameState.moves;
                    
                    // Ê£ÄÊü•Ê∏∏ÊàèÊòØÂê¶ÁªìÊùü
                    checkGameEnd();
                } else {
                    // Ê≤°ÊúâÂåπÈÖçÔºå‰∫§Êç¢ÂõûÊù•
                    const temp = gameState.gameBoard[row1][col1];
                    gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
                    gameState.gameBoard[row2][col2] = temp;
                    
                    // Êõ¥Êñ∞UI
                    updateGameBoard();
                }
                
                // Ê∏ÖÈô§ÈÄâÊã©
                if (gameState.selectedCell) {
                    gameState.gameBoard[gameState.selectedCell.row][gameState.selectedCell.col].cell.classList.remove('selected');
                    gameState.selectedCell = null;
                }
            }, 300);
        }

        // Êõ¥Êñ∞Ê∏∏ÊàèÊ£ãÁõòUI
        function updateGameBoard() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const cellData = gameState.gameBoard[row][col];
                    cellData.element.className = `game-element element-${cellData.type}`;
                }
            }
        }

        // Êü•ÊâæÂåπÈÖç
        function findMatches() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            const matches = [];
            
            // Ê£ÄÊü•Ê∞¥Âπ≥ÂåπÈÖç
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols - 2; col++) {
                    const type = gameState.gameBoard[row][col].type;
                    
                    if (type && 
                        gameState.gameBoard[row][col + 1].type === type && 
                        gameState.gameBoard[row][col + 2].type === type) {
                        
                        // ÊâæÂà∞ÂåπÈÖçÔºåÁªßÁª≠Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Â§ö
                        let matchLength = 3;
                        while (col + matchLength < cols && gameState.gameBoard[row][col + matchLength].type === type) {
                            matchLength++;
                        }
                        
                        // Ê∑ªÂä†Âà∞ÂåπÈÖçÂàóË°®
                        const match = [];
                        for (let i = 0; i < matchLength; i++) {
                            match.push({ row, col: col + i });
                        }
                        
                        matches.push(match);
                        
                        // Ë∑≥ËøáÂ∑≤ÂåπÈÖçÁöÑÂÖÉÁ¥†
                        col += matchLength - 1;
                    }
                }
            }
            
            // Ê£ÄÊü•ÂûÇÁõ¥ÂåπÈÖç
            for (let col = 0; col < cols; col++) {
                for (let row = 0; row < rows - 2; row++) {
                    const type = gameState.gameBoard[row][col].type;
                    
                    if (type && 
                        gameState.gameBoard[row + 1][col].type === type && 
                        gameState.gameBoard[row + 2][col].type === type) {
                        
                        // ÊâæÂà∞ÂåπÈÖçÔºåÁªßÁª≠Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Â§ö
                        let matchLength = 3;
                        while (row + matchLength < rows && gameState.gameBoard[row + matchLength][col].type === type) {
                            matchLength++;
                        }
                        
                        // Ê∑ªÂä†Âà∞ÂåπÈÖçÂàóË°®
                        const match = [];
                        for (let i = 0; i < matchLength; i++) {
                            match.push({ row: row + i, col });
                        }
                        
                        matches.push(match);
                        
                        // Ë∑≥ËøáÂ∑≤ÂåπÈÖçÁöÑÂÖÉÁ¥†
                        row += matchLength - 1;
                    }
                }
            }
            
            return matches;
        }

        // Â§ÑÁêÜÂåπÈÖç
        function processMatches(matches) {
            // Ê†áËÆ∞ÂåπÈÖçÁöÑÂÖÉÁ¥†
            const matchedCells = new Set();
            
            matches.forEach(match => {
                match.forEach(cell => {
                    const key = `${cell.row},${cell.col}`;
                    if (!matchedCells.has(key)) {
                        matchedCells.add(key);
                        gameState.gameBoard[cell.row][cell.col].cell.classList.add('matched');
                    }
                });
            });
            
            // ËÆ°ÁÆóÂæóÂàÜ
            const score = matchedCells.size * 10;
            gameState.score += score;
            elements.gameScore.textContent = gameState.score;
            
            // Â§ÑÁêÜÊ∂àÈô§Âíå‰∏ãËêΩ
            setTimeout(() => {
                // ÁßªÈô§ÂåπÈÖçÁöÑÂÖÉÁ¥†
                matchedCells.forEach(key => {
                    const [row, col] = key.split(',').map(Number);
                    gameState.gameBoard[row][col].type = null;
                });
                
                // ÂÖÉÁ¥†‰∏ãËêΩ
                dropElements();
                
                // Â°´ÂÖÖÊñ∞ÂÖÉÁ¥†
                fillBoard();
                
                // Êõ¥Êñ∞UI
                updateGameBoard();
                
                // Ê£ÄÊü•Êñ∞ÁöÑÂåπÈÖç
                setTimeout(() => {
                    const newMatches = findMatches();
                    
                    if (newMatches.length > 0) {
                        // ÊúâÊñ∞ÁöÑÂåπÈÖçÔºåÁªßÁª≠Â§ÑÁêÜ
                        processMatches(newMatches);
                    }
                }, 300);
            }, 500);
        }

        // ÂÖÉÁ¥†‰∏ãËêΩ
        function dropElements() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            
            // ‰ªé‰∏ãÂæÄ‰∏äÂ§ÑÁêÜÊØè‰∏ÄÂàó
            for (let col = 0; col < cols; col++) {
                let emptyRow = rows - 1;
                
                // ‰ªéÂ∫ïÈÉ®Âêë‰∏äÊü•ÊâæÁ©∫‰Ωç
                for (let row = rows - 1; row >= 0; row--) {
                    if (gameState.gameBoard[row][col].type !== null) {
                        // Â¶ÇÊûúÂΩìÂâçË°åÊúâÂÖÉÁ¥†Ôºå‰∏î‰∏ãÊñπÊúâÁ©∫‰ΩçÔºåÂàô‰∏ãËêΩ
                        if (row < emptyRow) {
                            gameState.gameBoard[emptyRow][col].type = gameState.gameBoard[row][col].type;
                            gameState.gameBoard[row][col].type = null;
                        }
                        emptyRow--;
                    }
                }
            }
        }

        // Â°´ÂÖÖÊ£ãÁõò
        function fillBoard() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            const elementTypes = gameState.currentLevel.board_config.elements;
            
            // Â°´ÂÖÖÁ©∫‰Ωç
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameState.gameBoard[row][col].type === null) {
                        // ÈöèÊú∫ÁîüÊàêÊñ∞ÂÖÉÁ¥†
                        const elementType = elementTypes[Math.floor(Math.random() * elementTypes.length)];
                        gameState.gameBoard[row][col].type = elementType;
                    }
                }
            }
        }

        // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
        function checkGameEnd() {
            // Ê£ÄÊü•Ê≠•Êï∞ÊòØÂê¶Áî®ÂÆå
            if (gameState.moves >= gameState.currentLevel.max_moves) {
                // Ê∏∏ÊàèÁªìÊùü
                gameState.gameActive = false;
                
                // ËÆ°ÁÆóÊòüÁ∫ß
                let stars = 0;
                const scorePercentage = gameState.score / gameState.currentLevel.objectives.target;
                
                if (scorePercentage >= 1) stars = 3;
                else if (scorePercentage >= 0.7) stars = 2;
                else if (scorePercentage >= 0.4) stars = 1;
                
                // ÊòæÁ§∫ÁªìÊûú
                showGameResult(stars);
            }
        }

        // ÊòæÁ§∫Ê∏∏ÊàèÁªìÊûú
        function showGameResult(stars) {
            const completed = stars > 0;
            
            // ËÆ°ÁÆóÂ•ñÂä±‰∏áËä±Â∏Å
            let flowerCoins = 0;
            if (completed) {
                if (gameState.currentLevel.difficulty === 'normal') {
                    flowerCoins = 10 + (stars - 1) * 5;  // 1Êòü10Ôºå2Êòü15Ôºå3Êòü20
                } else if (gameState.currentLevel.difficulty === 'hard') {
                    flowerCoins = 25 + (stars - 1) * 5;  // 1Êòü25Ôºå2Êòü30Ôºå3Êòü35
                }
            }
            
            // ÊûÑÂª∫ÁªìÊûúÊ∂àÊÅØ
            let message = `<div style="text-align: center;">`;
            message += `<h2>ÂÖ≥Âç° ${gameState.currentLevel.level_number} ${completed ? 'ÂÆåÊàê' : 'Â§±Ë¥•'}</h2>`;
            message += `<div style="margin: 20px 0;">`;
            
            // ÊòæÁ§∫ÊòüÁ∫ß
            for (let i = 0; i < 3; i++) {
                if (i < stars) {
                    message += `<i class="fas fa-star" style="color: gold; font-size: 30px; margin: 0 5px;"></i>`;
                } else {
                    message += `<i class="far fa-star" style="color: #ccc; font-size: 30px; margin: 0 5px;"></i>`;
                }
            }
            
            message += `</div>`;
            message += `<p>ÂæóÂàÜ: ${gameState.score}</p>`;
            
            if (completed) {
                message += `<p>Ëé∑Âæó: ${flowerCoins} ‰∏áËä±Â∏Å</p>`;
            }
            
            message += `</div>`;
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            showModal('Ê∏∏ÊàèÁªìÊûú', message, [
                {
                    text: 'ËøîÂõûÂÖ≥Âç°ÈÄâÊã©',
                    onClick: () => {
                        showPage('levelSelect');
                        loadGamePlays();
                    }
                }
            ]);
            
            // Êèê‰∫§Ê∏∏ÊàèÁªìÊûú
            submitGameResult(stars, flowerCoins);
        }

        // Êèê‰∫§Ê∏∏ÊàèÁªìÊûú
        async function submitGameResult(stars, flowerCoins) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/game_result`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: gameState.user.id,
                        level_id: gameState.currentLevel.id,
                        moves_used: gameState.moves,
                        score: gameState.score,
                        stars_earned: stars,
                        completed: stars > 0
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Submit game result error:', data.error);
                    return;
                }
                
                // Êõ¥Êñ∞Áî®Êà∑‰∏áËä±Â∏Å
                if (flowerCoins > 0) {
                    gameState.user.flower_coins += flowerCoins;
                    updateUserUI();
                }
            } catch (error) {
                console.error('Submit game result error:', error);
            }
        }

        // Âä†ËΩΩÊàêÂ∞±
        async function loadAchievements() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/achievements?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞ÊàêÂ∞±UI
                updateAchievementsUI(data.achievements);
            } catch (error) {
                console.error('Load achievements error:', error);
                showToast('Âä†ËΩΩÊàêÂ∞±Â§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞ÊàêÂ∞±UI
        function updateAchievementsUI(achievements) {
            elements.achievementsList.innerHTML = '';
            
            achievements.forEach(achievement => {
                const achievementElement = document.createElement('div');
                achievementElement.className = 'achievement-card';
                
                const iconElement = document.createElement('div');
                iconElement.className = 'achievement-icon';
                if (achievement.completed) {
                    iconElement.classList.add('completed');
                }
                iconElement.innerHTML = '<i class="fas fa-trophy"></i>';
                
                const detailsElement = document.createElement('div');
                detailsElement.className = 'achievement-details';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'achievement-name';
                nameElement.textContent = achievement.name;
                
                const descriptionElement = document.createElement('div');
                descriptionElement.className = 'achievement-description';
                descriptionElement.textContent = achievement.description;
                
                const progressElement = document.createElement('div');
                progressElement.className = 'achievement-progress';
                
                const progressBarElement = document.createElement('div');
                progressBarElement.className = 'achievement-progress-bar';
                
                // ËÆ°ÁÆóËøõÂ∫¶ÁôæÂàÜÊØî
                let progressPercentage = 0;
                if (achievement.progress_value > 0) {
                    // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆ‰∏çÂêåÁ±ªÂûãÁöÑÊàêÂ∞±ËÆ°ÁÆóËøõÂ∫¶
                    progressPercentage = Math.min(100, (achievement.progress_value / 10) * 100);
                }
                
                progressBarElement.style.width = `${progressPercentage}%`;
                
                progressElement.appendChild(progressBarElement);
                
                detailsElement.appendChild(nameElement);
                detailsElement.appendChild(descriptionElement);
                detailsElement.appendChild(progressElement);
                
                const rewardElement = document.createElement('div');
                rewardElement.className = 'achievement-reward';
                rewardElement.innerHTML = `<i class="fas fa-coins"></i> ${achievement.flower_coins_reward}`;
                
                achievementElement.appendChild(iconElement);
                achievementElement.appendChild(detailsElement);
                achievementElement.appendChild(rewardElement);
                
                elements.achievementsList.appendChild(achievementElement);
            });
        }

        // Âä†ËΩΩÊéíË°åÊ¶ú
        async function loadLeaderboard(period) {
            try {
                const response = await fetch(`${API_URL}/leaderboard?period=${period}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞ÊéíË°åÊ¶úUI
                updateLeaderboardUI(data.leaderboard);
            } catch (error) {
                console.error('Load leaderboard error:', error);
                showToast('Âä†ËΩΩÊéíË°åÊ¶úÂ§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞ÊéíË°åÊ¶úUI
        function updateLeaderboardUI(leaderboard) {
            elements.leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                elements.leaderboardList.innerHTML = '<div style="text-align: center; padding: 20px;">ÊöÇÊó†ÊéíË°åÊ¶úÊï∞ÊçÆ</div>';
                return;
            }
            
            leaderboard.forEach((entry, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'leaderboard-item';
                
                const rankElement = document.createElement('div');
                rankElement.className = 'leaderboard-rank';
                if (index === 0) rankElement.classList.add('top1');
                else if (index === 1) rankElement.classList.add('top2');
                else if (index === 2) rankElement.classList.add('top3');
                rankElement.textContent = index + 1;
                
                const avatarElement = document.createElement('div');
                avatarElement.className = 'leaderboard-avatar';
                
                if (entry.users && entry.users.photo_url) {
                    avatarElement.innerHTML = `<img src="${entry.users.photo_url}" alt="Avatar">`;
                } else {
                    avatarElement.innerHTML = '<i class="fas fa-user"></i>';
                }
                
                const infoElement = document.createElement('div');
                infoElement.className = 'leaderboard-info';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'leaderboard-name';
                nameElement.textContent = entry.users ? (entry.users.first_name || 'Áé©ÂÆ∂') : 'Áé©ÂÆ∂';
                
                const coinsElement = document.createElement('div');
                coinsElement.className = 'leaderboard-coins';
                coinsElement.innerHTML = `<i class="fas fa-coins"></i> ${entry.flower_coins_earned}`;
                
                infoElement.appendChild(nameElement);
                infoElement.appendChild(coinsElement);
                
                let rewardElement = null;
                if (index < 5) {
                    rewardElement = document.createElement('div');
                    rewardElement.className = 'leaderboard-reward';
                    
                    if (index === 0) rewardElement.textContent = '50ÂÖÉ';
                    else if (index === 1) rewardElement.textContent = '30ÂÖÉ';
                    else if (index === 2) rewardElement.textContent = '20ÂÖÉ';
                    else rewardElement.textContent = '10ÂÖÉ';
                }
                
                itemElement.appendChild(rankElement);
                itemElement.appendChild(avatarElement);
                itemElement.appendChild(infoElement);
                
                if (rewardElement) {
                    itemElement.appendChild(rewardElement);
                }
                
                elements.leaderboardList.appendChild(itemElement);
            });
        }

        // Êõ¥Êñ∞ÊèêÁé∞‰∫∫Ê∞ëÂ∏ÅÈáëÈ¢ù
        function updateWithdrawalRmb() {
            const amount = parseInt(elements.withdrawalAmount.value) || 0;
            const rmb = (amount / 1000) * 10;
            elements.withdrawalRmb.textContent = `${rmb.toFixed(2)}ÂÖÉ`;
        }

        // Êèê‰∫§ÊèêÁé∞Áî≥ËØ∑
        async function submitWithdrawal() {
            if (!gameState.user) return;
            
            const amount = parseInt(elements.withdrawalAmount.value);
            const alipayAccount = elements.alipayAccount.value.trim();
            const realName = elements.realName.value.trim();
            
            if (!amount || amount < 1000) {
                showToast('ÊèêÁé∞ÈáëÈ¢ùÊúÄÂ∞ë‰∏∫1000‰∏áËä±Â∏Å');
                return;
            }
            
            if (!alipayAccount) {
                showToast('ËØ∑ËæìÂÖ•ÊîØ‰ªòÂÆùË¥¶Âè∑');
                return;
            }
            
            if (!realName) {
                showToast('ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç');
                return;
            }
            
            if (amount > gameState.user.flower_coins) {
                showToast('‰∏áËä±Â∏Å‰ΩôÈ¢ù‰∏çË∂≥');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/withdrawal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: gameState.user.id,
                        amount,
                        alipay_account: alipayAccount,
                        real_name: realName
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞Áî®Êà∑‰∏áËä±Â∏Å
                gameState.user.flower_coins -= amount;
                updateUserUI();
                
                // Ê∏ÖÁ©∫Ë°®Âçï
                elements.withdrawalAmount.value = '';
                elements.alipayAccount.value = '';
                elements.realName.value = '';
                elements.withdrawalRmb.textContent = '0ÂÖÉ';
                
                // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                showToast('ÊèêÁé∞Áî≥ËØ∑Êèê‰∫§ÊàêÂäüÔºåËØ∑Á≠âÂæÖÂÆ°Ê†∏');
                
                // ÈáçÊñ∞Âä†ËΩΩÊèêÁé∞ËÆ∞ÂΩï
                loadWithdrawalHistory();
            } catch (error) {
                console.error('Submit withdrawal error:', error);
                showToast('Êèê‰∫§ÊèêÁé∞Áî≥ËØ∑Â§±Ë¥•');
            }
        }

        // Âä†ËΩΩÊèêÁé∞ËÆ∞ÂΩï
        async function loadWithdrawalHistory() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/withdrawal?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // Êõ¥Êñ∞ÊèêÁé∞ËÆ∞ÂΩïUI
                updateWithdrawalHistoryUI(data.withdrawals);
            } catch (error) {
                console.error('Load withdrawal history error:', error);
                showToast('Âä†ËΩΩÊèêÁé∞ËÆ∞ÂΩïÂ§±Ë¥•');
            }
        }

        // Êõ¥Êñ∞ÊèêÁé∞ËÆ∞ÂΩïUI
        function updateWithdrawalHistoryUI(withdrawals) {
            elements.withdrawalHistoryList.innerHTML = '';
            
            if (withdrawals.length === 0) {
                elements.withdrawalHistoryList.innerHTML = '<div style="text-align: center; padding: 20px;">ÊöÇÊó†ÊèêÁé∞ËÆ∞ÂΩï</div>';
                return;
            }
            
            withdrawals.forEach(withdrawal => {
                const itemElement = document.createElement('div');
                itemElement.className = 'withdrawal-history-item';
                
                const detailsElement = document.createElement('div');
                detailsElement.className = 'withdrawal-history-details';
                
                const amountElement = document.createElement('div');
                amountElement.className = 'withdrawal-history-amount';
                amountElement.textContent = `${withdrawal.amount}‰∏áËä±Â∏Å (${withdrawal.rmb_amount}ÂÖÉ)`;
                
                const dateElement = document.createElement('div');
                dateElement.className = 'withdrawal-history-date';
                dateElement.textContent = new Date(withdrawal.created_at).toLocaleString();
                
                detailsElement.appendChild(amountElement);
                detailsElement.appendChild(dateElement);
                
                const statusElement = document.createElement('div');
                statusElement.className = 'withdrawal-history-status';
                
                if (withdrawal.status === 'pending') {
                    statusElement.classList.add('status-pending');
                    statusElement.textContent = 'ÂæÖÂÆ°Ê†∏';
                } else if (withdrawal.status === 'approved') {
                    statusElement.classList.add('status-approved');
                    statusElement.textContent = 'Â∑≤ÈÄöËøá';
                } else if (withdrawal.status === 'rejected') {
                    statusElement.classList.add('status-rejected');
                    statusElement.textContent = 'Â∑≤ÊãíÁªù';
                }
                
                itemElement.appendChild(detailsElement);
                itemElement.appendChild(statusElement);
                
                elements.withdrawalHistoryList.appendChild(itemElement);
            });
        }
    </script>
</body>
</html>
