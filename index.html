<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万花楼-《万象谜题》</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f3f4f6;
            --white-color: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-color);
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            height: 90vh;
            max-height: 800px;
            background-color: var(--white-color);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .coins-display {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }

        .coins-icon {
            color: #fcd34d;
            margin-right: 5px;
        }

        .coins-amount {
            font-weight: bold;
        }

        .game-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-icon {
            margin-right: 8px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        .card {
            background-color: var(--white-color);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .card-body {
            color: var(--dark-color);
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }

        .list-item-content {
            flex: 1;
        }

        .list-item-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .list-item-subtitle {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .list-item-action {
            color: var(--primary-color);
            cursor: pointer;
        }

        .level-card {
            background-color: var(--white-color);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .level-card.completed {
            border-left: 4px solid var(--success-color);
        }

        .level-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .level-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: var(--primary-color);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .level-info {
            flex: 1;
        }

        .level-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .level-reward {
            font-size: 0.9rem;
            color: #6b7280;
            display: flex;
            align-items: center;
        }

        .level-reward .coins-icon {
            color: #fcd34d;
            margin-right: 3px;
            font-size: 0.8rem;
        }

        .level-status {
            font-size: 0.9rem;
            color: var(--success-color);
        }

        .sign-in-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--white-color);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
        }

        .sign-in-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .sign-in-streak {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .sign-in-btn {
            background-color: var(--white-color);
            color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sign-in-btn:hover {
            transform: scale(1.05);
        }

        .sign-in-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--light-color);
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .leaderboard-rank.top1 {
            background-color: #fcd34d;
            color: var(--dark-color);
        }

        .leaderboard-rank.top2 {
            background-color: #d1d5db;
            color: var(--dark-color);
        }

        .leaderboard-rank.top3 {
            background-color: #f97316;
            color: var(--white-color);
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-score {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .leaderboard-reward {
            font-size: 0.9rem;
            color: var(--success-color);
        }

        .achievement-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .achievement-item:last-child {
            border-bottom: none;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: var(--light-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }

        .achievement-icon.completed {
            background-color: var(--success-color);
            color: var(--white-color);
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .achievement-desc {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 3px;
        }

        .achievement-progress {
            height: 6px;
            background-color: var(--light-color);
            border-radius: 3px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
        }

        .achievement-reward {
            font-size: 0.9rem;
            color: var(--success-color);
            display: flex;
            align-items: center;
        }

        .achievement-reward .coins-icon {
            color: #fcd34d;
            margin-right: 3px;
            font-size: 0.8rem;
        }

        .withdrawal-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--light-color);
        }

        .withdrawal-item:last-child {
            border-bottom: none;
        }

        .withdrawal-info {
            flex: 1;
        }

        .withdrawal-amount {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .withdrawal-status {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .withdrawal-status.pending {
            color: var(--warning-color);
        }

        .withdrawal-status.approved {
            color: var(--success-color);
        }

        .withdrawal-status.rejected {
            color: var(--danger-color);
        }

        .withdrawal-date {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background-color: var(--white-color);
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-in-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-text {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .game-footer {
            background-color: var(--light-color);
            padding: 10px 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--dark-color);
            color: var(--white-color);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--danger-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        .ad-container {
            margin: 15px 0;
            text-align: center;
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .game-level {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        .game-level.active {
            display: flex;
        }

        .level-header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .level-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .level-description {
            text-align: center;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .puzzle-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
        }

        .puzzle-piece {
            position: absolute;
            cursor: move;
            transition: transform 0.2s ease;
        }

        .puzzle-piece.dragging {
            z-index: 10;
            transform: scale(1.05);
        }

        .puzzle-piece.correct {
            cursor: default;
        }

        .password-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .password-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 15px;
        }

        .password-clue {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .mechanism-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
            background-color: var(--light-color);
            border-radius: 10px;
        }

        .mechanism {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background-color: var(--primary-color);
            color: var(--white-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mechanism:hover {
            transform: scale(1.05);
        }

        .mechanism.active {
            background-color: var(--success-color);
        }

        .resource-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .resource-bar {
            height: 30px;
            background-color: var(--light-color);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .resource-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .resource-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--white-color);
            font-weight: bold;
        }

        .resource-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--light-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .resource-name {
            font-weight: bold;
        }

        .resource-value {
            display: flex;
            align-items: center;
        }

        .resource-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            margin: 0 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .path-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
            background-color: var(--light-color);
            border-radius: 10px;
        }

        .path-cell {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        .path-cell.empty {
            background-color: #e5e7eb;
        }

        .path-cell.wall {
            background-color: var(--dark-color);
        }

        .path-cell.start {
            background-color: var(--success-color);
        }

        .path-cell.end {
            background-color: var(--danger-color);
        }

        .path-cell.path {
            background-color: var(--primary-color);
        }

        .path-cell.player {
            background-color: var(--warning-color);
            z-index: 10;
        }

        .action-container {
            width: 100%;
            max-width: 300px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
            background-color: var(--light-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .action-target {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-target:hover {
            transform: scale(1.1);
        }

        .action-target.hit {
            background-color: var(--success-color);
        }

        .action-target.miss {
            background-color: var(--danger-color);
        }

        .memory-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .memory-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .memory-item {
            aspect-ratio: 1;
            background-color: var(--primary-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .memory-input {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .memory-input-item {
            aspect-ratio: 1;
            background-color: var(--light-color);
            border: 2px solid #d1d5db;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: bold;
        }

        .memory-input-item.filled {
            background-color: var(--primary-color);
            color: var(--white-color);
            border-color: var(--primary-color);
        }

        .memory-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .memory-option {
            aspect-ratio: 1;
            background-color: var(--light-color);
            border: 2px solid #d1d5db;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-color);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .memory-option:hover {
            background-color: var(--primary-color);
            color: var(--white-color);
            border-color: var(--primary-color);
        }

        .process-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .process-display {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .process-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .process-btn {
            padding: 15px;
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            background-color: var(--secondary-color);
        }

        .process-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .process-btn.active {
            background-color: var(--success-color);
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .attempts {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 15px;
            text-align: center;
        }

        .hint-btn {
            background-color: var(--warning-color);
            color: var(--white-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hint-btn:hover {
            background-color: #d97706;
        }

        .hint-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .hint-text {
            background-color: #fef3c7;
            color: #92400e;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .game-over {
            text-align: center;
            padding: 20px;
        }

        .game-over-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .game-over-message {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .game-over-stats {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .game-over-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .game-over-stat:last-child {
            margin-bottom: 0;
        }

        .game-over-stat-label {
            color: #6b7280;
        }

        .game-over-stat-value {
            font-weight: bold;
            color: var(--primary-color);
        }

        .sub-header {
            background-color: var(--light-color);
            padding: 10px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .sub-header-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--dark-color);
            flex: 1;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .back-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        @media (max-width: 480px) {
            .game-container {
                height: 100vh;
                max-height: none;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title">万花楼-《万象谜题》</div>
            <div class="coins-display">
                <i class="fas fa-coins coins-icon"></i>
                <span class="coins-amount" id="coinsAmount">0</span>
            </div>
        </div>

        <div class="game-content">
            <!-- 主页 -->
            <div class="page active" id="homePage">
                <div class="sign-in-card" id="signInCard">
                    <div class="sign-in-title">每日签到</div>
                    <div class="sign-in-streak" id="signInStreak">0</div>
                    <div>连续签到天数</div>
                    <button class="sign-in-btn" id="signInBtn">签到</button>
                </div>

                <div class="card">
                    <div class="card-header">游戏功能</div>
                    <div class="card-body">
                        <button class="btn btn-block" id="levelsBtn">
                            <i class="fas fa-puzzle-piece btn-icon"></i>关卡挑战
                        </button>
                        <button class="btn btn-block" id="leaderboardBtn">
                            <i class="fas fa-trophy btn-icon"></i>排行榜
                        </button>
                        <button class="btn btn-block" id="achievementsBtn">
                            <i class="fas fa-medal btn-icon"></i>成就系统
                        </button>
                        <button class="btn btn-block" id="withdrawBtn">
                            <i class="fas fa-money-bill-wave btn-icon"></i>提现管理
                        </button>
                    </div>
                </div>

                <div class="ad-container">
                    <i class="fas fa-ad"></i> 广告区域
                </div>
            </div>

            <!-- 关卡列表页 -->
            <div class="page" id="levelsPage">
                <div class="sub-header">
                    <button class="back-btn" id="backToHomeFromLevelsBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="sub-header-title">关卡列表</div>
                </div>
                <div class="card">
                    <div class="card-body" id="levelsList">
                        <!-- 关卡列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 排行榜页 -->
            <div class="page" id="leaderboardPage">
                <div class="sub-header">
                    <button class="back-btn" id="backToHomeFromLeaderboardBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="sub-header-title">排行榜</div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="monthlyLeaderboardBtn">月度排行</button>
                            <button class="btn btn-secondary" id="friendsLeaderboardBtn">好友排行</button>
                        </div>
                        <div id="leaderboardList">
                            <!-- 排行榜列表将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成就页 -->
            <div class="page" id="achievementsPage">
                <div class="sub-header">
                    <button class="back-btn" id="backToHomeFromAchievementsBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="sub-header-title">成就系统</div>
                </div>
                <div class="card">
                    <div class="card-body" id="achievementsList">
                        <!-- 成就列表将通过JS动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 提现页 -->
            <div class="page" id="withdrawPage">
                <div class="sub-header">
                    <button class="back-btn" id="backToHomeFromWithdrawBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="sub-header-title">提现管理</div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">当前万花币</label>
                            <div class="form-control" id="currentCoins">0</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">提现金额（元）</label>
                            <input type="number" class="form-control" id="withdrawAmount" min="10" step="10" placeholder="请输入提现金额">
                            <div class="form-text">1000个万花币 = 10元人民币</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">支付宝账号</label>
                            <input type="text" class="form-control" id="alipayAccount" placeholder="请输入支付宝账号">
                        </div>
                        <div class="form-group">
                            <label class="form-label">真实姓名</label>
                            <input type="text" class="form-control" id="realName" placeholder="请输入真实姓名">
                        </div>
                        <button class="btn btn-success btn-block" id="submitWithdrawBtn">提交提现申请</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">提现记录</div>
                    <div class="card-body" id="withdrawalsList">
                        <!-- 提现记录将通过JS动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 游戏关卡页 -->
            <div class="game-level" id="gameLevelPage">
                <div class="level-header">
                    <button class="btn btn-icon" id="backToLevelsBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="level-title" id="gameLevelTitle">关卡标题</div>
                    <div class="coins-display">
                        <i class="fas fa-coins coins-icon"></i>
                        <span class="coins-amount" id="gameLevelCoins">0</span>
                    </div>
                </div>

                <div class="level-content">
                    <div class="level-description" id="gameLevelDescription">关卡描述</div>
                    
                    <div class="timer" id="gameLevelTimer">00:00</div>
                    <div class="attempts" id="gameLevelAttempts">尝试次数: 0</div>
                    
                    <button class="hint-btn" id="gameLevelHintBtn">
                        <i class="fas fa-lightbulb"></i> 获取提示
                    </button>
                    <div class="hint-text" id="gameLevelHintText" style="display: none;"></div>

                    <!-- 不同类型关卡的游戏区域 -->
                    <div id="puzzleContainer" class="puzzle-container" style="display: none;">
                        <!-- 拼图碎片将通过JS动态生成 -->
                    </div>

                    <div id="passwordContainer" class="password-container" style="display: none;">
                        <div class="password-clue" id="passwordClue">密码线索</div>
                        <input type="text" class="password-input" id="passwordInput" placeholder="请输入密码">
                        <button class="btn btn-success btn-block" id="passwordSubmitBtn">提交</button>
                    </div>

                    <div id="mechanismContainer" class="mechanism-container" style="display: none;">
                        <!-- 机关将通过JS动态生成 -->
                    </div>

                    <div id="resourceContainer" class="resource-container" style="display: none;">
                        <div class="resource-bar">
                            <div class="resource-fill" id="resourceFill"></div>
                            <div class="resource-text" id="resourceText">0/10</div>
                        </div>
                        <div id="resourceItems">
                            <!-- 资源项将通过JS动态生成 -->
                        </div>
                        <button class="btn btn-success btn-block" id="resourceSubmitBtn">提交</button>
                    </div>

                    <div id="pathContainer" class="path-container" style="display: none;">
                        <!-- 路径网格将通过JS动态生成 -->
                    </div>

                    <div id="actionContainer" class="action-container" style="display: none;">
                        <!-- 动作目标将通过JS动态生成 -->
                    </div>

                    <div id="memoryContainer" class="memory-container" style="display: none;">
                        <div class="memory-display" id="memoryDisplay">
                            <!-- 记忆项将通过JS动态生成 -->
                        </div>
                        <div class="memory-input" id="memoryInput">
                            <!-- 记忆输入项将通过JS动态生成 -->
                        </div>
                        <div class="memory-options" id="memoryOptions">
                            <!-- 记忆选项将通过JS动态生成 -->
                        </div>
                        <button class="btn btn-success btn-block" id="memorySubmitBtn">提交</button>
                    </div>

                    <div id="processContainer" class="process-container" style="display: none;">
                        <div class="process-display" id="processDisplay">
                            <!-- 流程显示将通过JS动态生成 -->
                        </div>
                        <div class="process-buttons" id="processButtons">
                            <!-- 流程按钮将通过JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 游戏结束页 -->
            <div class="game-level" id="gameOverPage">
                <div class="level-header">
                    <button class="btn btn-icon" id="backToLevelsFromGameOverBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="level-title">关卡结果</div>
                    <div class="coins-display">
                        <i class="fas fa-coins coins-icon"></i>
                        <span class="coins-amount" id="gameOverCoins">0</span>
                    </div>
                </div>

                <div class="level-content">
                    <div class="game-over">
                        <div class="game-over-title" id="gameOverTitle">关卡完成</div>
                        <div class="game-over-message" id="gameOverMessage">恭喜你完成了关卡！</div>
                        
                        <div class="game-over-stats">
                            <div class="game-over-stat">
                                <div class="game-over-stat-label">完成时间</div>
                                <div class="game-over-stat-value" id="gameOverTime">00:00</div>
                            </div>
                            <div class="game-over-stat">
                                <div class="game-over-stat-label">尝试次数</div>
                                <div class="game-over-stat-value" id="gameOverAttempts">0</div>
                            </div>
                            <div class="game-over-stat">
                                <div class="game-over-stat-label">获得奖励</div>
                                <div class="game-over-stat-value" id="gameOverReward">0个万花币</div>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="retryLevelBtn">重试关卡</button>
                            <button class="btn" id="nextLevelBtn">下一关</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-footer">
            本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" class="footer-link" target="_blank">@bjxc010</a> 开发
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">标题</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                内容
            </div>
        </div>
    </div>

    <!-- 提示框 -->
    <div class="toast" id="toast"></div>

    <script>
        // API基础URL
        const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
        const BOT_USERNAME = "bjxcyouxiBot";
        
        // 游戏状态
        let gameState = {
            user: null,
            token: null,
            levels: [],
            currentLevel: null,
            levelAttempts: 0,
            levelStartTime: null,
            levelTimer: null,
            levelHints: 0,
            levelData: null
        };

        // DOM元素
        const elements = {
            // 页面元素
            pages: {
                home: document.getElementById('homePage'),
                levels: document.getElementById('levelsPage'),
                leaderboard: document.getElementById('leaderboardPage'),
                achievements: document.getElementById('achievementsPage'),
                withdraw: document.getElementById('withdrawPage'),
                gameLevel: document.getElementById('gameLevelPage'),
                gameOver: document.getElementById('gameOverPage')
            },
            
            // 按钮元素
            buttons: {
                levels: document.getElementById('levelsBtn'),
                leaderboard: document.getElementById('leaderboardBtn'),
                achievements: document.getElementById('achievementsBtn'),
                withdraw: document.getElementById('withdrawBtn'),
                signIn: document.getElementById('signInBtn'),
                monthlyLeaderboard: document.getElementById('monthlyLeaderboardBtn'),
                friendsLeaderboard: document.getElementById('friendsLeaderboardBtn'),
                submitWithdraw: document.getElementById('submitWithdrawBtn'),
                backToLevels: document.getElementById('backToLevelsBtn'),
                backToLevelsFromGameOver: document.getElementById('backToLevelsFromGameOverBtn'),
                retryLevel: document.getElementById('retryLevelBtn'),
                nextLevel: document.getElementById('nextLevelBtn'),
                gameLevelHint: document.getElementById('gameLevelHintBtn'),
                passwordSubmit: document.getElementById('passwordSubmitBtn'),
                resourceSubmit: document.getElementById('resourceSubmitBtn'),
                memorySubmit: document.getElementById('memorySubmitBtn'),
                // 返回主页按钮
                backToHomeFromLevels: document.getElementById('backToHomeFromLevelsBtn'),
                backToHomeFromLeaderboard: document.getElementById('backToHomeFromLeaderboardBtn'),
                backToHomeFromAchievements: document.getElementById('backToHomeFromAchievementsBtn'),
                backToHomeFromWithdraw: document.getElementById('backToHomeFromWithdrawBtn')
            },
            
            // 显示元素
            displays: {
                coinsAmount: document.getElementById('coinsAmount'),
                signInCard: document.getElementById('signInCard'),
                signInStreak: document.getElementById('signInStreak'),
                levelsList: document.getElementById('levelsList'),
                leaderboardList: document.getElementById('leaderboardList'),
                achievementsList: document.getElementById('achievementsList'),
                currentCoins: document.getElementById('currentCoins'),
                withdrawalsList: document.getElementById('withdrawalsList'),
                gameLevelTitle: document.getElementById('gameLevelTitle'),
                gameLevelDescription: document.getElementById('gameLevelDescription'),
                gameLevelCoins: document.getElementById('gameLevelCoins'),
                gameLevelTimer: document.getElementById('gameLevelTimer'),
                gameLevelAttempts: document.getElementById('gameLevelAttempts'),
                gameLevelHintText: document.getElementById('gameLevelHintText'),
                gameOverTitle: document.getElementById('gameOverTitle'),
                gameOverMessage: document.getElementById('gameOverMessage'),
                gameOverTime: document.getElementById('gameOverTime'),
                gameOverAttempts: document.getElementById('gameOverAttempts'),
                gameOverReward: document.getElementById('gameOverReward'),
                gameOverCoins: document.getElementById('gameOverCoins')
            },
            
            // 输入元素
            inputs: {
                withdrawAmount: document.getElementById('withdrawAmount'),
                alipayAccount: document.getElementById('alipayAccount'),
                realName: document.getElementById('realName'),
                passwordInput: document.getElementById('passwordInput')
            },
            
            // 游戏容器
            containers: {
                puzzle: document.getElementById('puzzleContainer'),
                password: document.getElementById('passwordContainer'),
                mechanism: document.getElementById('mechanismContainer'),
                resource: document.getElementById('resourceContainer'),
                path: document.getElementById('pathContainer'),
                action: document.getElementById('actionContainer'),
                memory: document.getElementById('memoryContainer'),
                process: document.getElementById('processContainer')
            },
            
            // 模态框元素
            modal: {
                modal: document.getElementById('modal'),
                title: document.getElementById('modalTitle'),
                body: document.getElementById('modalBody'),
                close: document.getElementById('modalClose')
            },
            
            // 提示框元素
            toast: document.getElementById('toast')
        };

        // 初始化游戏
        async function initGame() {
            // 检查本地存储中的用户信息
            const savedUser = localStorage.getItem('gameUser');
            const savedToken = localStorage.getItem('gameToken');
            
            if (savedUser && savedToken) {
                gameState.user = JSON.parse(savedUser);
                gameState.token = savedToken;
                
                // 更新UI
                updateUI();
                
                // 加载关卡列表
                await loadLevels();
                
                // 检查签到状态
                await checkSignInStatus();
            } else {
                // 显示Telegram登录提示
                showModal('登录提示', '请使用Telegram账号登录游戏');
                
                // 尝试通过Telegram登录
                if (window.Telegram && window.Telegram.WebApp) {
                    const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
                    
                    if (telegramUser) {
                        await loginWithTelegram(telegramUser);
                    }
                }
            }
            
            // 绑定事件
            bindEvents();
        }

        // Telegram登录
        async function loginWithTelegram(telegramUser) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        telegramData: {
                            id: telegramUser.id,
                            username: telegramUser.username,
                            first_name: telegramUser.first_name,
                            last_name: telegramUser.last_name,
                            auth_date: Math.floor(Date.now() / 1000),
                            hash: 'dummy_hash' // 实际应用中应该有正确的hash
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.user = data.user;
                    gameState.token = data.token;
                    
                    // 保存到本地存储
                    localStorage.setItem('gameUser', JSON.stringify(data.user));
                    localStorage.setItem('gameToken', data.token);
                    
                    // 更新UI
                    updateUI();
                    
                    // 加载关卡列表
                    await loadLevels();
                    
                    // 检查签到状态
                    await checkSignInStatus();
                    
                    // 绑定设备
                    await bindDevice();
                    
                    showToast('登录成功', 'success');
                } else {
                    showToast(`登录失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('登录失败，请稍后再试', 'error');
            }
        }

        // 绑定设备
        async function bindDevice() {
            try {
                // 生成设备ID
                let deviceId = localStorage.getItem('deviceId');
                
                if (!deviceId) {
                    deviceId = `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    localStorage.setItem('deviceId', deviceId);
                }
                
                // 获取设备信息
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                };
                
                const response = await fetch(`${API_BASE_URL}/bind-device`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    },
                    body: JSON.stringify({
                        deviceId,
                        deviceInfo
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    console.error('Bind device error:', data.error);
                }
            } catch (error) {
                console.error('Bind device error:', error);
            }
        }

        // 更新UI
        function updateUI() {
            if (gameState.user) {
                elements.displays.coinsAmount.textContent = gameState.user.total_coins;
                elements.displays.currentCoins.textContent = gameState.user.total_coins;
                elements.displays.gameLevelCoins.textContent = gameState.user.total_coins;
                elements.displays.gameOverCoins.textContent = gameState.user.total_coins;
                
                // 更新签到信息
                if (gameState.user.consecutive_sign_in_days !== undefined) {
                    elements.displays.signInStreak.textContent = gameState.user.consecutive_sign_in_days;
                }
            }
        }

        // 检查签到状态
        async function checkSignInStatus() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const lastSignIn = gameState.user.last_sign_in_date;
                
                if (lastSignIn === today) {
                    elements.buttons.signIn.textContent = '已签到';
                    elements.buttons.signIn.disabled = true;
                } else {
                    elements.buttons.signIn.textContent = '签到';
                    elements.buttons.signIn.disabled = false;
                }
            } catch (error) {
                console.error('Check sign in status error:', error);
            }
        }

        // 加载关卡列表
        async function loadLevels() {
            try {
                const response = await fetch(`${API_BASE_URL}/levels`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.levels = data.levels;
                    renderLevelsList();
                } else {
                    showToast(`加载关卡失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Load levels error:', error);
                showToast('加载关卡失败，请稍后再试', 'error');
            }
        }

        // 渲染关卡列表
        function renderLevelsList() {
            elements.displays.levelsList.innerHTML = '';
            
            gameState.levels.forEach(level => {
                const levelCard = document.createElement('div');
                levelCard.className = `level-card ${level.is_completed ? 'completed' : ''} ${!level.is_unlocked ? 'locked' : ''}`;
                
                let levelIcon = '';
                let levelTypeName = '';
                
                switch (level.type) {
                    case 'puzzle':
                        levelIcon = 'fa-puzzle-piece';
                        levelTypeName = '解谜';
                        break;
                    case 'strategy':
                        levelIcon = 'fa-chess';
                        levelTypeName = '策略';
                        break;
                    case 'action':
                        levelIcon = 'fa-running';
                        levelTypeName = '动作';
                        break;
                    case 'memory':
                        levelIcon = 'fa-brain';
                        levelTypeName = '记忆';
                        break;
                }
                
                levelCard.innerHTML = `
                    <div class="level-icon">
                        <i class="fas ${levelIcon}"></i>
                    </div>
                    <div class="level-info">
                        <div class="level-title">${level.name}</div>
                        <div class="level-reward">
                            <i class="fas fa-coins coins-icon"></i>
                            ${level.reward_coins} 个万花币
                        </div>
                    </div>
                    <div class="level-status">
                        ${level.is_completed ? '已完成' : level.is_unlocked ? '未完成' : '未解锁'}
                    </div>
                `;
                
                if (level.is_unlocked) {
                    levelCard.addEventListener('click', () => startLevel(level));
                }
                
                elements.displays.levelsList.appendChild(levelCard);
            });
        }

        // 开始关卡
        async function startLevel(level) {
            try {
                const response = await fetch(`${API_BASE_URL}/level-detail?levelId=${level.id}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.currentLevel = data.level;
                    gameState.levelAttempts = 0;
                    gameState.levelHints = 0;
                    gameState.levelStartTime = Date.now();
                    
                    // 隐藏所有游戏容器
                    Object.values(elements.containers).forEach(container => {
                        container.style.display = 'none';
                    });
                    
                    // 显示游戏关卡页面
                    showPage('gameLevel');
                    
                    // 更新关卡信息
                    elements.displays.gameLevelTitle.textContent = gameState.currentLevel.name;
                    elements.displays.gameLevelDescription.textContent = gameState.currentLevel.description || '挑战你的智慧！';
                    elements.displays.gameLevelAttempts.textContent = `尝试次数: ${gameState.levelAttempts}`;
                    
                    // 重置提示
                    elements.displays.gameLevelHintText.style.display = 'none';
                    elements.buttons.gameLevelHint.disabled = false;
                    
                    // 根据关卡类型初始化游戏
                    initGameLevel();
                    
                    // 开始计时
                    startLevelTimer();
                } else {
                    showToast(`加载关卡失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Start level error:', error);
                showToast('加载关卡失败，请稍后再试', 'error');
            }
        }

        // 初始化游戏关卡
        function initGameLevel() {
            const level = gameState.currentLevel;
            const parameters = level.parameters ? JSON.parse(level.parameters) : {};
            
            switch (level.type) {
                case 'puzzle':
                    switch (level.sub_type) {
                        case 'graphics':
                            initGraphicsPuzzle(parameters);
                            break;
                        case 'password':
                            initPasswordPuzzle(parameters);
                            break;
                        case 'mechanism':
                            initMechanismPuzzle(parameters);
                            break;
                    }
                    break;
                    
                case 'strategy':
                    switch (level.sub_type) {
                        case 'resource':
                            initResourceStrategy(parameters);
                            break;
                        case 'path':
                            initPathStrategy(parameters);
                            break;
                    }
                    break;
                    
                case 'action':
                    switch (level.sub_type) {
                        case 'precision':
                            initPrecisionAction(parameters);
                            break;
                        case 'reaction':
                            initReactionAction(parameters);
                            break;
                    }
                    break;
                    
                case 'memory':
                    switch (level.sub_type) {
                        case 'information':
                            initInformationMemory(parameters);
                            break;
                        case 'process':
                            initProcessMemory(parameters);
                            break;
                    }
                    break;
            }
        }

        // 初始化图形拼图
        function initGraphicsPuzzle(parameters) {
            elements.containers.puzzle.style.display = 'block';
            elements.containers.puzzle.innerHTML = '';
            
            const pieces = parameters.pieces || 3;
            const hints = parameters.hints !== false;
            const interference = parameters.interference || false;
            
            // 创建拼图容器
            const puzzleContainer = document.createElement('div');
            puzzleContainer.style.position = 'relative';
            puzzleContainer.style.width = '100%';
            puzzleContainer.style.height = '100%';
            
            // 创建目标图形
            const targetShape = document.createElement('div');
            targetShape.style.position = 'absolute';
            targetShape.style.width = '150px';
            targetShape.style.height = '150px';
            targetShape.style.backgroundColor = '#e5e7eb';
            targetShape.style.borderRadius = '10px';
            targetShape.style.top = '50%';
            targetShape.style.left = '50%';
            targetShape.style.transform = 'translate(-50%, -50%)';
            targetShape.style.zIndex = '1';
            
            puzzleContainer.appendChild(targetShape);
            
            // 创建拼图碎片
            for (let i = 0; i < pieces; i++) {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.style.width = `${150 / Math.sqrt(pieces)}px`;
                piece.style.height = `${150 / Math.sqrt(pieces)}px`;
                piece.style.backgroundColor = `hsl(${i * 360 / pieces}, 70%, 80%)`;
                piece.style.borderRadius = '5px';
                piece.style.left = `${Math.random() * 200}px`;
                piece.style.top = `${Math.random() * 200}px`;
                piece.style.zIndex = '2';
                piece.dataset.index = i;
                
                // 使拼图碎片可拖动
                makeDraggable(piece, targetShape);
                
                puzzleContainer.appendChild(piece);
            }
            
            elements.containers.puzzle.appendChild(puzzleContainer);
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'graphics',
                pieces: pieces,
                hints: hints,
                interference: interference,
                completedPieces: 0,
                totalPieces: pieces
            };
        }

        // 使元素可拖动
        function makeDraggable(element, target) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag);
            
            function startDrag(e) {
                isDragging = true;
                element.classList.add('dragging');
                
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
                
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', stopDrag);
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                
                let clientX, clientY;
                
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const dx = clientX - startX;
                const dy = clientY - startY;
                
                element.style.left = `${initialX + dx}px`;
                element.style.top = `${initialY + dy}px`;
            }
            
            function stopDrag() {
                isDragging = false;
                element.classList.remove('dragging');
                
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('touchend', stopDrag);
                
                // 检查是否放置在目标位置
                checkPiecePosition(element, target);
            }
        }

        // 检查拼图碎片位置
        function checkPiecePosition(piece, target) {
            const pieceRect = piece.getBoundingClientRect();
            const targetRect = target.getBoundingClientRect();
            
            const pieceCenterX = pieceRect.left + pieceRect.width / 2;
            const pieceCenterY = pieceRect.top + pieceRect.height / 2;
            
            const targetCenterX = targetRect.left + targetRect.width / 2;
            const targetCenterY = targetRect.top + targetRect.height / 2;
            
            const distance = Math.sqrt(
                Math.pow(pieceCenterX - targetCenterX, 2) + 
                Math.pow(pieceCenterY - targetCenterY, 2)
            );
            
            // 如果距离足够近，则认为放置正确
            if (distance < 30) {
                piece.classList.add('correct');
                piece.style.left = `${targetRect.left - piece.parentElement.getBoundingClientRect().left + (targetRect.width - pieceRect.width) / 2}px`;
                piece.style.top = `${targetRect.top - piece.parentElement.getBoundingClientRect().top + (targetRect.height - pieceRect.height) / 2}px`;
                
                // 更新游戏数据
                gameState.levelData.completedPieces++;
                
                // 检查是否完成拼图
                if (gameState.levelData.completedPieces === gameState.levelData.totalPieces) {
                    completeLevel();
                }
            }
        }

        // 初始化密码拼图
        function initPasswordPuzzle(parameters) {
            elements.containers.password.style.display = 'block';
            
            const length = parameters.length || 4;
            const complexity = parameters.complexity || 'low';
            const misleading = parameters.misleading || false;
            
            // 生成密码和线索
            let password = '';
            let clue = '';
            
            switch (complexity) {
                case 'low':
                    // 简单密码：纯数字
                    password = Math.floor(Math.random() * Math.pow(10, length)).toString().padStart(length, '0');
                    clue = `密码是一个${length}位数字`;
                    break;
                    
                case 'medium':
                    // 中等密码：数字和字母
                    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    for (let i = 0; i < length; i++) {
                        password += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    clue = `密码是一个${length}位的数字和字母组合`;
                    break;
                    
                case 'high':
                    // 高级密码：数字、字母和符号
                    const complexChars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*';
                    for (let i = 0; i < length; i++) {
                        password += complexChars.charAt(Math.floor(Math.random() * complexChars.length));
                    }
                    clue = `密码是一个${length}位的复杂组合，包含数字、字母和符号`;
                    break;
            }
            
            // 如果有误导线索，添加一些干扰信息
            if (misleading) {
                const misleadingClues = [
                    '密码的首字母是A',
                    '密码包含数字7',
                    '密码的末尾是0',
                    '密码的总和是15'
                ];
                clue += `，但请注意：${misleadingClues[Math.floor(Math.random() * misleadingClues.length)]}`;
            }
            
            elements.displays.passwordClue.textContent = clue;
            elements.inputs.passwordInput.value = '';
            elements.inputs.passwordInput.focus();
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'password',
                password: password,
                length: length,
                complexity: complexity,
                misleading: misleading
            };
        }

        // 初始化机关拼图
        function initMechanismPuzzle(parameters) {
            elements.containers.mechanism.style.display = 'block';
            elements.containers.mechanism.innerHTML = '';
            
            const mechanisms = parameters.mechanisms || 3;
            const timeLimit = parameters.time_limit;
            const multiplePaths = parameters.multiplePaths || false;
            
            // 创建机关
            const mechanismTypes = ['button', 'lever', 'gear', 'laser'];
            const mechanismIcons = ['fa-hand-pointer', 'fa-exchange-alt', 'fa-cog', 'fa-bolt'];
            
            for (let i = 0; i < mechanisms; i++) {
                const mechanism = document.createElement('div');
                mechanism.className = 'mechanism';
                mechanism.dataset.index = i;
                mechanism.dataset.active = 'false';
                
                const typeIndex = i % mechanismTypes.length;
                const icon = document.createElement('i');
                icon.className = `fas ${mechanismIcons[typeIndex]}`;
                mechanism.appendChild(icon);
                
                // 随机位置
                const x = Math.random() * 240;
                const y = Math.random() * 240;
                mechanism.style.left = `${x}px`;
                mechanism.style.top = `${y}px`;
                
                // 添加点击事件
                mechanism.addEventListener('click', () => toggleMechanism(mechanism));
                
                elements.containers.mechanism.appendChild(mechanism);
            }
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'mechanism',
                mechanisms: mechanisms,
                timeLimit: timeLimit,
                multiplePaths: multiplePaths,
                activeMechanisms: [],
                correctOrder: generateCorrectOrder(mechanisms),
                currentOrder: []
            };
            
            // 如果有时间限制，开始倒计时
            if (timeLimit) {
                startMechanismTimer(timeLimit);
            }
        }

        // 生成正确的机关顺序
        function generateCorrectOrder(mechanisms) {
            const order = [];
            for (let i = 0; i < mechanisms; i++) {
                order.push(i);
            }
            
            // 随机打乱顺序
            for (let i = order.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [order[i], order[j]] = [order[j], order[i]];
            }
            
            return order;
        }

        // 切换机关状态
        function toggleMechanism(mechanism) {
            const index = parseInt(mechanism.dataset.index);
            const isActive = mechanism.dataset.active === 'true';
            
            if (isActive) {
                mechanism.dataset.active = 'false';
                mechanism.classList.remove('active');
                
                // 从当前顺序中移除
                const pos = gameState.levelData.currentOrder.indexOf(index);
                if (pos !== -1) {
                    gameState.levelData.currentOrder.splice(pos, 1);
                }
            } else {
                mechanism.dataset.active = 'true';
                mechanism.classList.add('active');
                
                // 添加到当前顺序
                gameState.levelData.currentOrder.push(index);
            }
            
            // 检查是否完成
            checkMechanismCompletion();
        }

        // 检查机关是否完成
        function checkMechanismCompletion() {
            const { correctOrder, currentOrder, multiplePaths } = gameState.levelData;
            
            // 如果当前顺序与正确顺序匹配，则完成
            if (currentOrder.length === correctOrder.length) {
                let isCorrect = true;
                
                if (multiplePaths) {
                    // 多路径情况下，检查是否所有机关都被激活
                    isCorrect = currentOrder.length === gameState.levelData.mechanisms;
                } else {
                    // 单一路径情况下，检查顺序是否正确
                    for (let i = 0; i < correctOrder.length; i++) {
                        if (currentOrder[i] !== correctOrder[i]) {
                            isCorrect = false;
                            break;
                        }
                    }
                }
                
                if (isCorrect) {
                    completeLevel();
                }
            }
        }

        // 开始机关倒计时
        function startMechanismTimer(timeLimit) {
            let timeLeft = timeLimit;
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    failLevel('时间到！');
                }
            }, 1000);
            
            // 保存计时器ID
            gameState.levelData.timerInterval = timerInterval;
        }

        // 初始化资源策略
        function initResourceStrategy(parameters) {
            elements.containers.resource.style.display = 'block';
            
            const resources = parameters.resources || 10;
            const targets = parameters.targets || 3;
            const shortage = parameters.shortage || false;
            const fluctuation = parameters.fluctuation || false;
            
            // 创建资源项
            const resourceItems = document.getElementById('resourceItems');
            resourceItems.innerHTML = '';
            
            const targetResources = [];
            
            for (let i = 0; i < targets; i++) {
                const minResource = shortage ? Math.ceil(resources / targets) - 1 : Math.ceil(resources / targets);
                const maxResource = Math.ceil(resources / targets) + 1;
                const targetValue = Math.floor(Math.random() * (maxResource - minResource + 1)) + minResource;
                
                targetResources.push(targetValue);
                
                const item = document.createElement('div');
                item.className = 'resource-item';
                item.innerHTML = `
                    <div class="resource-name">设备 ${i + 1}</div>
                    <div class="resource-value">
                        <button class="resource-btn" data-index="${i}" data-action="decrease">-</button>
                        <span id="resource-value-${i}">0</span>
                        <button class="resource-btn" data-index="${i}" data-action="increase">+</button>
                    </div>
                `;
                
                resourceItems.appendChild(item);
            }
            
            // 添加按钮事件
            document.querySelectorAll('.resource-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    const action = btn.dataset.action;
                    const valueElement = document.getElementById(`resource-value-${index}`);
                    let value = parseInt(valueElement.textContent);
                    
                    if (action === 'increase' && value < resources) {
                        value++;
                    } else if (action === 'decrease' && value > 0) {
                        value--;
                    }
                    
                    valueElement.textContent = value;
                    updateResourceBar();
                });
            });
            
            // 更新资源条
            function updateResourceBar() {
                let totalUsed = 0;
                
                for (let i = 0; i < targets; i++) {
                    const valueElement = document.getElementById(`resource-value-${i}`);
                    totalUsed += parseInt(valueElement.textContent);
                }
                
                const percentage = (totalUsed / resources) * 100;
                elements.containers.resource.querySelector('#resourceFill').style.width = `${percentage}%`;
                elements.containers.resource.querySelector('#resourceText').textContent = `${totalUsed}/${resources}`;
            }
            
            updateResourceBar();
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'resource',
                resources: resources,
                targets: targets,
                shortage: shortage,
                fluctuation: fluctuation,
                targetResources: targetResources
            };
        }

        // 初始化路径策略
        function initPathStrategy(parameters) {
            elements.containers.path.style.display = 'block';
            elements.containers.path.innerHTML = '';
            
            const obstacles = parameters.obstacles || 3;
            const multiplePaths = parameters.multiplePaths || false;
            const dynamic = parameters.dynamic || false;
            
            // 创建网格
            const gridSize = 10;
            const cellSize = 30;
            
            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'path-cell empty';
                    cell.style.left = `${x * cellSize}px`;
                    cell.style.top = `${y * cellSize}px`;
                    cell.dataset.x = x;
                    cell.dataset.y = y;
                    
                    elements.containers.path.appendChild(cell);
                }
            }
            
            // 设置起点和终点
            const startCell = document.querySelector('.path-cell[data-x="0"][data-y="0"]');
            startCell.className = 'path-cell start';
            
            const endCell = document.querySelector('.path-cell[data-x="9"][data-y="9"]');
            endCell.className = 'path-cell end';
            
            // 添加障碍物
            const obstaclePositions = [];
            for (let i = 0; i < obstacles; i++) {
                let x, y;
                
                do {
                    x = Math.floor(Math.random() * gridSize);
                    y = Math.floor(Math.random() * gridSize);
                } while (
                    (x === 0 && y === 0) || 
                    (x === 9 && y === 9) || 
                    obstaclePositions.some(pos => pos.x === x && pos.y === y)
                );
                
                obstaclePositions.push({ x, y });
                
                const obstacleCell = document.querySelector(`.path-cell[data-x="${x}"][data-y="${y}"]`);
                obstacleCell.className = 'path-cell wall';
            }
            
            // 添加玩家
            const player = document.createElement('div');
            player.className = 'path-cell player';
            player.style.left = '0px';
            player.style.top = '0px';
            player.dataset.x = 0;
            player.dataset.y = 0;
            
            elements.containers.path.appendChild(player);
            
            // 添加键盘控制
            document.addEventListener('keydown', handlePathMovement);
            
            function handlePathMovement(e) {
                if (!gameState.levelData || gameState.levelData.type !== 'path') return;
                
                const player = document.querySelector('.path-cell.player');
                let x = parseInt(player.dataset.x);
                let y = parseInt(player.dataset.y);
                
                switch (e.key) {
                    case 'ArrowUp':
                        if (y > 0) y--;
                        break;
                    case 'ArrowDown':
                        if (y < gridSize - 1) y++;
                        break;
                    case 'ArrowLeft':
                        if (x > 0) x--;
                        break;
                    case 'ArrowRight':
                        if (x < gridSize - 1) x++;
                        break;
                    default:
                        return;
                }
                
                e.preventDefault();
                
                // 检查是否可以移动到新位置
                const targetCell = document.querySelector(`.path-cell[data-x="${x}"][data-y="${y}"]`);
                
                if (targetCell.classList.contains('wall')) {
                    return;
                }
                
                // 移动玩家
                player.style.left = `${x * cellSize}px`;
                player.style.top = `${y * cellSize}px`;
                player.dataset.x = x;
                player.dataset.y = y;
                
                // 添加路径标记
                const pathCell = document.querySelector(`.path-cell[data-x="${x}"][data-y="${y}"]:not(.start):not(.end):not(.player)`);
                if (pathCell) {
                    pathCell.className = 'path-cell path';
                }
                
                // 检查是否到达终点
                if (x === 9 && y === 9) {
                    completeLevel();
                }
            }
            
            // 如果是动态障碍物，设置定时器
            if (dynamic) {
                const dynamicInterval = setInterval(() => {
                    // 随机移动一个障碍物
                    if (obstaclePositions.length > 0) {
                        const index = Math.floor(Math.random() * obstaclePositions.length);
                        const obstacle = obstaclePositions[index];
                        
                        // 移除旧障碍物
                        const oldCell = document.querySelector(`.path-cell[data-x="${obstacle.x}"][data-y="${obstacle.y}"]`);
                        oldCell.className = 'path-cell empty';
                        
                        // 生成新位置
                        let newX, newY;
                        
                        do {
                            newX = Math.floor(Math.random() * gridSize);
                            newY = Math.floor(Math.random() * gridSize);
                        } while (
                            (newX === 0 && newY === 0) || 
                            (newX === 9 && newY === 9) || 
                            (newX === parseInt(player.dataset.x) && newY === parseInt(player.dataset.y)) ||
                            obstaclePositions.some((pos, i) => i !== index && pos.x === newX && pos.y === newY)
                        );
                        
                        // 更新障碍物位置
                        obstacle.x = newX;
                        obstacle.y = newY;
                        
                        // 添加新障碍物
                        const newCell = document.querySelector(`.path-cell[data-x="${newX}"][data-y="${newY}"]`);
                        newCell.className = 'path-cell wall';
                    }
                }, 3000);
                
                // 保存定时器ID
                gameState.levelData = {
                    type: 'path',
                    obstacles: obstacles,
                    multiplePaths: multiplePaths,
                    dynamic: dynamic,
                    dynamicInterval: dynamicInterval
                };
            } else {
                gameState.levelData = {
                    type: 'path',
                    obstacles: obstacles,
                    multiplePaths: multiplePaths,
                    dynamic: dynamic
                };
            }
        }

        // 初始化精准动作
        function initPrecisionAction(parameters) {
            elements.containers.action.style.display = 'block';
            elements.containers.action.innerHTML = '';
            
            const tolerance = parameters.tolerance || 5;
            const delay = parameters.delay || 0;
            
            // 创建目标
            const target = document.createElement('div');
            target.className = 'action-target';
            target.style.width = '40px';
            target.style.height = '40px';
            target.style.backgroundColor = '#ef4444';
            
            // 随机位置
            const x = Math.random() * 260;
            const y = Math.random() * 260;
            target.style.left = `${x}px`;
            target.style.top = `${y}px`;
            
            elements.containers.action.appendChild(target);
            
            // 添加点击事件
            target.addEventListener('click', (e) => {
                const rect = target.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const distance = Math.sqrt(
                    Math.pow(e.clientX - centerX, 2) + 
                    Math.pow(e.clientY - centerY, 2)
                );
                
                if (distance <= tolerance) {
                    target.classList.add('hit');
                    completeLevel();
                } else {
                    target.classList.add('miss');
                    setTimeout(() => {
                        target.classList.remove('miss');
                    }, 500);
                }
            });
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'precision',
                tolerance: tolerance,
                delay: delay
            };
        }

        // 初始化反应动作
        function initReactionAction(parameters) {
            elements.containers.action.style.display = 'block';
            elements.containers.action.innerHTML = '';
            
            const frequency = parameters.frequency || 1;
            const decoys = parameters.decoys || false;
            const timeLimit = parameters.time_limit || 3;
            
            let targets = [];
            let score = 0;
            let missed = 0;
            let gameActive = true;
            
            // 创建目标
            function createTarget(isDecoy = false) {
                const target = document.createElement('div');
                target.className = `action-target ${isDecoy ? 'miss' : ''}`;
                target.style.width = '40px';
                target.style.height = '40px';
                target.style.backgroundColor = isDecoy ? '#ef4444' : '#10b981';
                
                // 随机位置
                const x = Math.random() * 260;
                const y = Math.random() * 260;
                target.style.left = `${x}px`;
                target.style.top = `${y}px`;
                
                // 添加点击事件
                target.addEventListener('click', () => {
                    if (!gameActive) return;
                    
                    if (isDecoy) {
                        target.classList.add('hit');
                        missed++;
                        
                        if (missed >= 3) {
                            gameActive = false;
                            failLevel('点击了太多假目标！');
                        }
                    } else {
                        target.classList.add('hit');
                        score++;
                        
                        if (score >= 10) {
                            gameActive = false;
                            completeLevel();
                        }
                    }
                    
                    // 移除目标
                    setTimeout(() => {
                        target.remove();
                    }, 300);
                });
                
                elements.containers.action.appendChild(target);
                targets.push(target);
                
                // 自动移除目标
                setTimeout(() => {
                    if (target.parentElement && !target.classList.contains('hit')) {
                        target.remove();
                        
                        if (!isDecoy) {
                            missed++;
                            
                            if (missed >= 3) {
                                gameActive = false;
                                failLevel('错过了太多目标！');
                            }
                        }
                    }
                }, timeLimit * 1000);
            }
            
            // 定期创建目标
            const targetInterval = setInterval(() => {
                if (!gameActive) {
                    clearInterval(targetInterval);
                    return;
                }
                
                createTarget(false);
                
                if (decoys && Math.random() < 0.3) {
                    setTimeout(() => {
                        if (gameActive) {
                            createTarget(true);
                        }
                    }, Math.random() * 1000);
                }
            }, 1000 / frequency);
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'reaction',
                frequency: frequency,
                decoys: decoys,
                timeLimit: timeLimit,
                targetInterval: targetInterval,
                score: score,
                missed: missed,
                gameActive: gameActive
            };
        }

        // 初始化信息记忆
        function initInformationMemory(parameters) {
            elements.containers.memory.style.display = 'block';
            
            const items = parameters.items || 5;
            const interference = parameters.interference || false;
            const displayTime = parameters.displayTime || 10;
            
            // 生成记忆项
            const memoryItems = [];
            const memoryTypes = ['number', 'shape', 'color'];
            
            for (let i = 0; i < items; i++) {
                const type = memoryTypes[i % memoryTypes.length];
                let value;
                
                switch (type) {
                    case 'number':
                        value = Math.floor(Math.random() * 10);
                        break;
                    case 'shape':
                        const shapes = ['circle', 'square', 'triangle'];
                        value = shapes[Math.floor(Math.random() * shapes.length)];
                        break;
                    case 'color':
                        const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
                        value = colors[Math.floor(Math.random() * colors.length)];
                        break;
                }
                
                memoryItems.push({ type, value });
            }
            
            // 显示记忆项
            const memoryDisplay = document.getElementById('memoryDisplay');
            memoryDisplay.innerHTML = '';
            
            memoryItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'memory-item';
                
                switch (item.type) {
                    case 'number':
                        itemElement.textContent = item.value;
                        break;
                    case 'shape':
                        if (item.value === 'circle') {
                            itemElement.style.borderRadius = '50%';
                        } else if (item.value === 'triangle') {
                            itemElement.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                        }
                        break;
                    case 'color':
                        itemElement.style.backgroundColor = item.value;
                        itemElement.textContent = '';
                        break;
                }
                
                memoryDisplay.appendChild(itemElement);
            });
            
            // 创建输入区域
            const memoryInput = document.getElementById('memoryInput');
            memoryInput.innerHTML = '';
            
            for (let i = 0; i < items; i++) {
                const inputItem = document.createElement('div');
                inputItem.className = 'memory-input-item';
                inputItem.dataset.index = i;
                inputItem.addEventListener('click', () => selectMemoryInput(inputItem));
                
                memoryInput.appendChild(inputItem);
            }
            
            // 创建选项区域
            const memoryOptions = document.getElementById('memoryOptions');
            memoryOptions.innerHTML = '';
            
            // 添加所有可能的选项
            const allOptions = [];
            
            memoryItems.forEach(item => {
                if (!allOptions.includes(item.value)) {
                    allOptions.push(item.value);
                }
            });
            
            // 添加一些干扰项
            if (interference) {
                switch (memoryItems[0].type) {
                    case 'number':
                        for (let i = 0; i < 3; i++) {
                            let num;
                            do {
                                num = Math.floor(Math.random() * 10);
                            } while (allOptions.includes(num));
                            allOptions.push(num);
                        }
                        break;
                    case 'shape':
                        const allShapes = ['circle', 'square', 'triangle', 'star', 'diamond'];
                        allShapes.forEach(shape => {
                            if (!allOptions.includes(shape)) {
                                allOptions.push(shape);
                            }
                        });
                        break;
                    case 'color':
                        const allColors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink'];
                        allColors.forEach(color => {
                            if (!allOptions.includes(color)) {
                                allOptions.push(color);
                            }
                        });
                        break;
                }
            }
            
            // 随机排序选项
            allOptions.sort(() => Math.random() - 0.5);
            
            allOptions.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'memory-option';
                optionElement.dataset.value = option;
                
                switch (typeof option) {
                    case 'number':
                        optionElement.textContent = option;
                        break;
                    case 'string':
                        if (['circle', 'square', 'triangle'].includes(option)) {
                            if (option === 'circle') {
                                optionElement.style.borderRadius = '50%';
                            } else if (option === 'triangle') {
                                optionElement.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                            }
                            optionElement.textContent = '';
                        } else {
                            optionElement.style.backgroundColor = option;
                            optionElement.textContent = '';
                        }
                        break;
                }
                
                optionElement.addEventListener('click', () => selectMemoryOption(optionElement));
                
                memoryOptions.appendChild(optionElement);
            });
            
            let selectedInputIndex = 0;
            const inputValues = new Array(items).fill(null);
            
            // 选择输入项
            function selectMemoryInput(inputItem) {
                document.querySelectorAll('.memory-input-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                inputItem.classList.add('selected');
                selectedInputIndex = parseInt(inputItem.dataset.index);
            }
            
            // 选择选项
            function selectMemoryOption(optionElement) {
                const value = optionElement.dataset.value;
                const inputItem = document.querySelector(`.memory-input-item[data-index="${selectedInputIndex}"]`);
                
                inputValues[selectedInputIndex] = value;
                
                // 更新输入项显示
                switch (typeof value) {
                    case 'number':
                        inputItem.textContent = value;
                        break;
                    case 'string':
                        if (['circle', 'square', 'triangle'].includes(value)) {
                            if (value === 'circle') {
                                inputItem.style.borderRadius = '50%';
                            } else if (value === 'triangle') {
                                inputItem.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                            }
                            inputItem.textContent = '';
                        } else {
                            inputItem.style.backgroundColor = value;
                            inputItem.textContent = '';
                        }
                        break;
                }
                
                inputItem.classList.add('filled');
                
                // 选择下一个输入项
                if (selectedInputIndex < items - 1) {
                    selectedInputIndex++;
                    const nextInputItem = document.querySelector(`.memory-input-item[data-index="${selectedInputIndex}"]`);
                    selectMemoryInput(nextInputItem);
                }
            }
            
            // 默认选择第一个输入项
            selectMemoryInput(document.querySelector('.memory-input-item'));
            
            // 隐藏记忆项，显示输入区域
            setTimeout(() => {
                memoryDisplay.style.display = 'none';
            }, displayTime * 1000);
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'information',
                items: items,
                interference: interference,
                displayTime: displayTime,
                memoryItems: memoryItems,
                inputValues: inputValues
            };
        }

        // 初始化流程记忆
        function initProcessMemory(parameters) {
            elements.containers.process.style.display = 'block';
            
            const steps = parameters.steps || 3;
            const randomVariables = parameters.randomVariables || false;
            
            // 生成流程步骤
            const processSteps = [];
            const stepTypes = ['button', 'lever', 'switch', 'dial'];
            const stepIcons = ['fa-hand-pointer', 'fa-exchange-alt', 'fa-toggle-on', 'fa-sliders-h'];
            const stepColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
            
            for (let i = 0; i < steps; i++) {
                const typeIndex = i % stepTypes.length;
                processSteps.push({
                    type: stepTypes[typeIndex],
                    icon: stepIcons[typeIndex],
                    color: stepColors[typeIndex]
                });
            }
            
            // 显示流程
            const processDisplay = document.getElementById('processDisplay');
            processDisplay.innerHTML = '<div>请记住以下操作顺序：</div>';
            
            const stepsContainer = document.createElement('div');
            stepsContainer.style.display = 'flex';
            stepsContainer.style.justifyContent = 'center';
            stepsContainer.style.marginTop = '10px';
            
            processSteps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.style.width = '50px';
                stepElement.style.height = '50px';
                stepElement.style.borderRadius = '10px';
                stepElement.style.backgroundColor = step.color;
                stepElement.style.color = 'white';
                stepElement.style.display = 'flex';
                stepElement.style.alignItems = 'center';
                stepElement.style.justifyContent = 'center';
                stepElement.style.margin = '0 5px';
                
                const icon = document.createElement('i');
                icon.className = `fas ${step.icon}`;
                stepElement.appendChild(icon);
                
                stepsContainer.appendChild(stepElement);
            });
            
            processDisplay.appendChild(stepsContainer);
            
            // 创建按钮区域
            const processButtons = document.getElementById('processButtons');
            processButtons.innerHTML = '';
            
            // 如果有随机变量，打乱按钮顺序
            const buttonOrder = randomVariables ? 
                [...Array(steps).keys()].sort(() => Math.random() - 0.5) : 
                [...Array(steps).keys()];
            
            buttonOrder.forEach(originalIndex => {
                const step = processSteps[originalIndex];
                
                const button = document.createElement('button');
                button.className = 'process-btn';
                button.dataset.originalIndex = originalIndex;
                button.dataset.currentIndex = buttonOrder.indexOf(originalIndex);
                button.style.backgroundColor = step.color;
                
                const icon = document.createElement('i');
                icon.className = `fas ${step.icon}`;
                button.appendChild(icon);
                
                button.addEventListener('click', () => selectProcessButton(button));
                
                processButtons.appendChild(button);
            });
            
            let currentStep = 0;
            const selectedSteps = [];
            
            // 选择流程按钮
            function selectProcessButton(button) {
                const originalIndex = parseInt(button.dataset.originalIndex);
                
                // 如果已经选择过这个按钮，忽略
                if (selectedSteps.includes(originalIndex)) {
                    return;
                }
                
                // 标记按钮为已选择
                button.classList.add('active');
                button.disabled = true;
                selectedSteps.push(originalIndex);
                
                // 检查是否完成
                if (selectedSteps.length === steps) {
                    // 检查顺序是否正确
                    let isCorrect = true;
                    
                    for (let i = 0; i < steps; i++) {
                        if (selectedSteps[i] !== i) {
                            isCorrect = false;
                            break;
                        }
                    }
                    
                    if (isCorrect) {
                        completeLevel();
                    } else {
                        failLevel('顺序不正确！');
                    }
                }
            }
            
            // 隐藏流程，显示按钮
            setTimeout(() => {
                processDisplay.style.display = 'none';
            }, 5000);
            
            // 保存游戏数据
            gameState.levelData = {
                type: 'process',
                steps: steps,
                randomVariables: randomVariables,
                processSteps: processSteps,
                buttonOrder: buttonOrder,
                selectedSteps: selectedSteps
            };
        }

        // 开始关卡计时
        function startLevelTimer() {
            gameState.levelTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - gameState.levelStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                elements.displays.gameLevelTimer.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // 完成关卡
        async function completeLevel() {
            // 停止计时器
            if (gameState.levelTimer) {
                clearInterval(gameState.levelTimer);
                gameState.levelTimer = null;
            }
            
            // 停止其他可能的计时器
            if (gameState.levelData && gameState.levelData.timerInterval) {
                clearInterval(gameState.levelData.timerInterval);
            }
            
            if (gameState.levelData && gameState.levelData.targetInterval) {
                clearInterval(gameState.levelData.targetInterval);
            }
            
            if (gameState.levelData && gameState.levelData.dynamicInterval) {
                clearInterval(gameState.levelData.dynamicInterval);
            }
            
            // 计算完成时间
            const completionTime = Math.floor((Date.now() - gameState.levelStartTime) / 1000);
            
            try {
                const response = await fetch(`${API_BASE_URL}/complete-level`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    },
                    body: JSON.stringify({
                        levelId: gameState.currentLevel.id,
                        time: completionTime,
                        attempts: gameState.levelAttempts + 1
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户数据
                    gameState.user.total_coins = data.new_level ? gameState.user.total_coins + gameState.currentLevel.reward_coins : gameState.user.total_coins;
                    gameState.user.current_level = data.new_level || gameState.user.current_level;
                    
                    // 更新UI
                    updateUI();
                    
                    // 显示游戏结束页面
                    showGameOver(true, completionTime);
                } else {
                    showToast(`完成关卡失败: ${data.error}`, 'error');
                    showPage('levels');
                }
            } catch (error) {
                console.error('Complete level error:', error);
                showToast('完成关卡失败，请稍后再试', 'error');
                showPage('levels');
            }
        }

        // 失败关卡
        function failLevel(reason) {
            // 停止计时器
            if (gameState.levelTimer) {
                clearInterval(gameState.levelTimer);
                gameState.levelTimer = null;
            }
            
            // 停止其他可能的计时器
            if (gameState.levelData && gameState.levelData.timerInterval) {
                clearInterval(gameState.levelData.timerInterval);
            }
            
            if (gameState.levelData && gameState.levelData.targetInterval) {
                clearInterval(gameState.levelData.targetInterval);
            }
            
            if (gameState.levelData && gameState.levelData.dynamicInterval) {
                clearInterval(gameState.levelData.dynamicInterval);
            }
            
            // 增加尝试次数
            gameState.levelAttempts++;
            elements.displays.gameLevelAttempts.textContent = `尝试次数: ${gameState.levelAttempts}`;
            
            // 显示失败原因
            showToast(reason, 'error');
            
            // 检查是否可以使用提示
            if (gameState.levelAttempts >= 3 && gameState.levelHints < 3) {
                elements.buttons.gameLevelHint.disabled = false;
                showToast('可以观看广告获取提示', 'warning');
            }
            
            // 检查是否需要等待
            let waitTime = 0;
            
            if (gameState.levelAttempts >= 3 && gameState.levelAttempts < 5) {
                waitTime = 10;
            } else if (gameState.levelAttempts >= 5 && gameState.levelAttempts < 10) {
                waitTime = 30;
            } else if (gameState.levelAttempts >= 10) {
                waitTime = 60;
            }
            
            if (waitTime > 0) {
                showToast(`请等待 ${waitTime} 秒后再试`, 'warning');
                
                // 禁用所有交互
                if (gameState.levelData) {
                    switch (gameState.levelData.type) {
                        case 'password':
                            elements.inputs.passwordInput.disabled = true;
                            elements.buttons.passwordSubmit.disabled = true;
                            break;
                        case 'resource':
                            document.querySelectorAll('.resource-btn').forEach(btn => {
                                btn.disabled = true;
                            });
                            elements.buttons.resourceSubmit.disabled = true;
                            break;
                        case 'memory':
                            elements.buttons.memorySubmit.disabled = true;
                            break;
                    }
                }
                
                // 倒计时
                let timeLeft = waitTime;
                const waitInterval = setInterval(() => {
                    timeLeft--;
                    
                    if (timeLeft <= 0) {
                        clearInterval(waitInterval);
                        
                        // 恢复交互
                        if (gameState.levelData) {
                            switch (gameState.levelData.type) {
                                case 'password':
                                    elements.inputs.passwordInput.disabled = false;
                                    elements.buttons.passwordSubmit.disabled = false;
                                    break;
                                case 'resource':
                                    document.querySelectorAll('.resource-btn').forEach(btn => {
                                        btn.disabled = false;
                                    });
                                    elements.buttons.resourceSubmit.disabled = false;
                                    break;
                                case 'memory':
                                    elements.buttons.memorySubmit.disabled = false;
                                    break;
                            }
                        }
                        
                        // 重置关卡
                        resetLevel();
                    }
                }, 1000);
                
                // 保存计时器ID
                gameState.waitInterval = waitInterval;
            } else {
                // 直接重置关卡
                resetLevel();
            }
        }

        // 重置关卡
        function resetLevel() {
            // 清除等待计时器
            if (gameState.waitInterval) {
                clearInterval(gameState.waitInterval);
                gameState.waitInterval = null;
            }
            
            // 重置关卡开始时间
            gameState.levelStartTime = Date.now();
            
            // 重新初始化关卡
            initGameLevel();
            
            // 重新开始计时
            startLevelTimer();
        }

        // 显示游戏结束页面
        function showGameOver(isSuccess, completionTime) {
            // 更新游戏结束页面信息
            if (isSuccess) {
                elements.displays.gameOverTitle.textContent = '关卡完成';
                elements.displays.gameOverMessage.textContent = '恭喜你完成了关卡！';
            } else {
                elements.displays.gameOverTitle.textContent = '关卡失败';
                elements.displays.gameOverMessage.textContent = '再接再厉，下次一定可以成功！';
            }
            
            // 格式化时间
            const minutes = Math.floor(completionTime / 60);
            const seconds = completionTime % 60;
            elements.displays.gameOverTime.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            elements.displays.gameOverAttempts.textContent = gameState.levelAttempts + 1;
            elements.displays.gameOverReward.textContent = 
                `${gameState.currentLevel.reward_coins} 个万花币`;
            
            // 显示游戏结束页面
            showPage('gameOver');
        }

        // 显示提示
        function showHint() {
            if (gameState.levelHints >= 3) {
                showToast('已经使用过所有提示', 'warning');
                return;
            }
            
            // 观看广告获取提示
            watchAd('hint', () => {
                gameState.levelHints++;
                
                // 根据关卡类型显示提示
                if (gameState.levelData) {
                    let hintText = '';
                    
                    switch (gameState.levelData.type) {
                        case 'graphics':
                            hintText = '尝试将拼图碎片拖到目标位置，当碎片变成绿色时表示位置正确';
                            break;
                        case 'password':
                            hintText = `密码长度是 ${gameState.levelData.length} 位`;
                            break;
                        case 'mechanism':
                            hintText = '按照正确的顺序点击机关';
                            break;
                        case 'resource':
                            hintText = '合理分配资源，确保每个设备都能运行';
                            break;
                        case 'path':
                            hintText = '使用方向键移动，避开障碍物到达终点';
                            break;
                        case 'precision':
                            hintText = `点击目标的中心位置，误差范围是 ${gameState.levelData.tolerance} 像素`;
                            break;
                        case 'reaction':
                            hintText = '快速点击绿色目标，避开红色目标';
                            break;
                        case 'information':
                            hintText = '记住显示的信息，然后在下方按顺序选择';
                            break;
                        case 'process':
                            hintText = '记住按钮的操作顺序，然后按照相同顺序点击';
                            break;
                    }
                    
                    elements.displays.gameLevelHintText.textContent = hintText;
                    elements.displays.gameLevelHintText.style.display = 'block';
                    
                    showToast('提示已显示', 'success');
                }
            });
        }

        // 观看广告
        function watchAd(type, callback) {
            // 在实际应用中，这里应该集成广告SDK
            // 这里我们模拟观看广告的过程
            
            showToast('正在加载广告...', 'info');
            
            setTimeout(() => {
                // 记录广告观看
                recordAdView(type, () => {
                    if (callback) callback();
                });
            }, 1000);
        }

        // 记录广告观看
        async function recordAdView(adType, callback) {
            try {
                const response = await fetch(`${API_BASE_URL}/ad-view`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    },
                    body: JSON.stringify({
                        adType: adType,
                        rewardType: adType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 如果有万花币奖励，更新用户数据
                    if (data.reward_coins > 0) {
                        gameState.user.total_coins += data.reward_coins;
                        updateUI();
                        showToast(`获得 ${data.reward_coins} 个万花币`, 'success');
                    }
                    
                    if (callback) callback();
                } else {
                    showToast(`广告观看失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Record ad view error:', error);
                showToast('广告观看失败，请稍后再试', 'error');
            }
        }

        // 签到
        async function signIn() {
            try {
                const response = await fetch(`${API_BASE_URL}/sign-in`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户数据
                    gameState.user.total_coins += data.reward_coins;
                    gameState.user.consecutive_sign_in_days = data.consecutive_days;
                    
                    // 更新UI
                    updateUI();
                    
                    // 更新签到按钮
                    elements.buttons.signIn.textContent = '已签到';
                    elements.buttons.signIn.disabled = true;
                    
                    // 显示签到成功消息
                    let message = `签到成功！获得 ${data.reward_coins} 个万花币`;
                    
                    if (data.is_extra_reward) {
                        message += '\n额外奖励：10 个万花币';
                    }
                    
                    showToast(message, 'success');
                } else {
                    showToast(`签到失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Sign in error:', error);
                showToast('签到失败，请稍后再试', 'error');
            }
        }

        // 加载排行榜
        async function loadLeaderboard(type = 'monthly') {
            try {
                const yearMonth = new Date().toISOString().slice(0, 7);
                const response = await fetch(`${API_BASE_URL}/leaderboard?type=${type}&yearMonth=${yearMonth}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderLeaderboard(data.leaderboard, data.user_rank);
                } else {
                    showToast(`加载排行榜失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Load leaderboard error:', error);
                showToast('加载排行榜失败，请稍后再试', 'error');
            }
        }

        // 渲染排行榜
        function renderLeaderboard(leaderboard, userRank) {
            elements.displays.leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                elements.displays.leaderboardList.innerHTML = '<div style="text-align: center; padding: 20px;">暂无排行数据</div>';
                return;
            }
            
            leaderboard.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let rankClass = '';
                if (entry.rank === 1) rankClass = 'top1';
                else if (entry.rank === 2) rankClass = 'top2';
                else if (entry.rank === 3) rankClass = 'top3';
                
                item.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${entry.rank}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${entry.telegram_username || '匿名用户'}</div>
                        <div class="leaderboard-score">得分: ${entry.score}</div>
                    </div>
                    <div class="leaderboard-reward">
                        ${entry.cash_reward > 0 ? `${entry.cash_reward / 100}元 ` : ''}
                        ${entry.coins_reward > 0 ? `${entry.coins_reward}币` : ''}
                    </div>
                `;
                
                elements.displays.leaderboardList.appendChild(item);
            });
            
            // 显示用户排名
            if (userRank) {
                const userItem = document.createElement('div');
                userItem.className = 'leaderboard-item';
                userItem.style.backgroundColor = '#f3f4f6';
                userItem.style.fontWeight = 'bold';
                
                userItem.innerHTML = `
                    <div class="leaderboard-rank">${userRank.rank}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">你的排名</div>
                        <div class="leaderboard-score">得分: ${userRank.score}</div>
                    </div>
                `;
                
                elements.displays.leaderboardList.appendChild(userItem);
            }
        }

        // 加载成就
        async function loadAchievements() {
            try {
                const response = await fetch(`${API_BASE_URL}/achievements`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderAchievements(data.achievements);
                } else {
                    showToast(`加载成就失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Load achievements error:', error);
                showToast('加载成就失败，请稍后再试', 'error');
            }
        }

        // 渲染成就
        function renderAchievements(achievements) {
            elements.displays.achievementsList.innerHTML = '';
            
            if (achievements.length === 0) {
                elements.displays.achievementsList.innerHTML = '<div style="text-align: center; padding: 20px;">暂无成就数据</div>';
                return;
            }
            
            achievements.forEach(achievement => {
                const item = document.createElement('div');
                item.className = 'achievement-item';
                
                const progressPercentage = (achievement.progress / achievement.target_value) * 100;
                
                item.innerHTML = `
                    <div class="achievement-icon ${achievement.is_completed ? 'completed' : ''}">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="achievement-info">
                        <div class="achievement-title">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                        <div class="achievement-progress">
                            <div class="achievement-progress-bar" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    <div class="achievement-reward">
                        <i class="fas fa-coins coins-icon"></i>
                        ${achievement.reward_coins}
                    </div>
                `;
                
                elements.displays.achievementsList.appendChild(item);
            });
        }

        // 提交提现申请
        async function submitWithdrawal() {
            const amount = parseInt(elements.inputs.withdrawAmount.value);
            const alipayAccount = elements.inputs.alipayAccount.value.trim();
            const realName = elements.inputs.realName.value.trim();
            
            if (!amount || amount < 10) {
                showToast('提现金额不能少于10元', 'error');
                return;
            }
            
            if (!alipayAccount) {
                showToast('请输入支付宝账号', 'error');
                return;
            }
            
            if (!realName) {
                showToast('请输入真实姓名', 'error');
                return;
            }
            
            if (gameState.user.total_coins < amount * 100) {
                showToast('万花币余额不足', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    },
                    body: JSON.stringify({
                        amount,
                        alipayAccount,
                        realName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户数据
                    gameState.user.total_coins -= amount * 100;
                    updateUI();
                    
                    // 清空表单
                    elements.inputs.withdrawAmount.value = '';
                    elements.inputs.alipayAccount.value = '';
                    elements.inputs.realName.value = '';
                    
                    showToast('提现申请已提交，我们将在3-5个工作日内处理', 'success');
                    
                    // 重新加载提现记录
                    loadWithdrawals();
                } else {
                    showToast(`提现失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Withdraw error:', error);
                showToast('提现失败，请稍后再试', 'error');
            }
        }

        // 加载提现记录
        async function loadWithdrawals() {
            try {
                const response = await fetch(`${API_BASE_URL}/withdrawals`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${gameState.token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderWithdrawals(data.withdrawals);
                } else {
                    showToast(`加载提现记录失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Load withdrawals error:', error);
                showToast('加载提现记录失败，请稍后再试', 'error');
            }
        }

        // 渲染提现记录
        function renderWithdrawals(withdrawals) {
            elements.displays.withdrawalsList.innerHTML = '';
            
            if (withdrawals.length === 0) {
                elements.displays.withdrawalsList.innerHTML = '<div style="text-align: center; padding: 20px;">暂无提现记录</div>';
                return;
            }
            
            withdrawals.forEach(withdrawal => {
                const item = document.createElement('div');
                item.className = 'withdrawal-item';
                
                const statusClass = withdrawal.status;
                const statusText = {
                    'pending': '处理中',
                    'approved': '已到账',
                    'rejected': '已拒绝'
                }[withdrawal.status] || withdrawal.status;
                
                const date = new Date(withdrawal.created_at);
                const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                item.innerHTML = `
                    <div class="withdrawal-info">
                        <div class="withdrawal-amount">${withdrawal.amount} 元</div>
                        <div class="withdrawal-status ${statusClass}">${statusText}</div>
                        ${withdrawal.rejection_reason ? `<div style="font-size: 0.8rem; color: #ef4444;">${withdrawal.rejection_reason}</div>` : ''}
                        <div class="withdrawal-date">${dateStr}</div>
                    </div>
                `;
                
                elements.displays.withdrawalsList.appendChild(item);
            });
        }

        // 记录分享
        async function recordShare(shareType = 'telegram') {
            try {
                const response = await fetch(`${API_BASE_URL}/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${gameState.token}`
                    },
                    body: JSON.stringify({
                        shareType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 生成分享链接
                    const shareLink = `https://t.me/${BOT_USERNAME}?start=verify_share_${data.share_id}`;
                    
                    // 复制到剪贴板
                    navigator.clipboard.writeText(shareLink).then(() => {
                        showToast('分享链接已复制到剪贴板', 'success');
                    }).catch(() => {
                        showModal('分享链接', shareLink);
                    });
                } else {
                    showToast(`分享失败: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Share error:', error);
                showToast('分享失败，请稍后再试', 'error');
            }
        }

        // 显示页面
        function showPage(pageName) {
            // 隐藏所有页面
            Object.values(elements.pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            if (elements.pages[pageName]) {
                elements.pages[pageName].classList.add('active');
            }
        }

        // 显示模态框
        function showModal(title, content) {
            elements.modal.title.textContent = title;
            elements.modal.body.innerHTML = content;
            elements.modal.modal.classList.add('active');
        }

        // 隐藏模态框
        function hideModal() {
            elements.modal.modal.classList.remove('active');
        }

        // 显示提示
        function showToast(message, type = 'info') {
            elements.toast.textContent = message;
            elements.toast.className = `toast ${type}`;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }

        // 绑定事件
        function bindEvents() {
            // 导航按钮
            elements.buttons.levels.addEventListener('click', () => {
                showPage('levels');
            });
            
            elements.buttons.leaderboard.addEventListener('click', () => {
                showPage('leaderboard');
                loadLeaderboard('monthly');
            });
            
            elements.buttons.achievements.addEventListener('click', () => {
                showPage('achievements');
                loadAchievements();
            });
            
            elements.buttons.withdraw.addEventListener('click', () => {
                showPage('withdraw');
                loadWithdrawals();
            });
            
            // 返回主页按钮
            elements.buttons.backToHomeFromLevels.addEventListener('click', () => {
                showPage('home');
            });
            
            elements.buttons.backToHomeFromLeaderboard.addEventListener('click', () => {
                showPage('home');
            });
            
            elements.buttons.backToHomeFromAchievements.addEventListener('click', () => {
                showPage('home');
            });
            
            elements.buttons.backToHomeFromWithdraw.addEventListener('click', () => {
                showPage('home');
            });
            
            // 签到按钮
            elements.buttons.signIn.addEventListener('click', signIn);
            
            // 排行榜类型切换
            elements.buttons.monthlyLeaderboard.addEventListener('click', () => {
                loadLeaderboard('monthly');
            });
            
            elements.buttons.friendsLeaderboard.addEventListener('click', () => {
                loadLeaderboard('friends');
            });
            
            // 提现按钮
            elements.buttons.submitWithdraw.addEventListener('click', submitWithdrawal);
            
            // 返回按钮
            elements.buttons.backToLevels.addEventListener('click', () => {
                // 停止计时器
                if (gameState.levelTimer) {
                    clearInterval(gameState.levelTimer);
                    gameState.levelTimer = null;
                }
                
                // 停止其他可能的计时器
                if (gameState.levelData && gameState.levelData.timerInterval) {
                    clearInterval(gameState.levelData.timerInterval);
                }
                
                if (gameState.levelData && gameState.levelData.targetInterval) {
                    clearInterval(gameState.levelData.targetInterval);
                }
                
                if (gameState.levelData && gameState.levelData.dynamicInterval) {
                    clearInterval(gameState.levelData.dynamicInterval);
                }
                
                if (gameState.waitInterval) {
                    clearInterval(gameState.waitInterval);
                    gameState.waitInterval = null;
                }
                
                showPage('levels');
            });
            
            elements.buttons.backToLevelsFromGameOver.addEventListener('click', () => {
                showPage('levels');
            });
            
            // 游戏结束页面按钮
            elements.buttons.retryLevel.addEventListener('click', () => {
                startLevel(gameState.currentLevel);
            });
            
            elements.buttons.nextLevel.addEventListener('click', () => {
                const nextLevel = gameState.levels.find(level => level.id === gameState.currentLevel.id + 1);
                
                if (nextLevel && nextLevel.is_unlocked) {
                    startLevel(nextLevel);
                } else {
                    showPage('levels');
                }
            });
            
            // 游戏关卡按钮
            elements.buttons.gameLevelHint.addEventListener('click', showHint);
            
            // 密码提交按钮
            elements.buttons.passwordSubmit.addEventListener('click', () => {
                const password = elements.inputs.passwordInput.value.trim();
                
                if (!password) {
                    showToast('请输入密码', 'error');
                    return;
                }
                
                if (password === gameState.levelData.password) {
                    completeLevel();
                } else {
                    showToast('密码错误', 'error');
                    failLevel('密码错误！');
                }
            });
            
            // 资源提交按钮
            elements.buttons.resourceSubmit.addEventListener('click', () => {
                let totalUsed = 0;
                const resourceValues = [];
                
                for (let i = 0; i < gameState.levelData.targets; i++) {
                    const valueElement = document.getElementById(`resource-value-${i}`);
                    const value = parseInt(valueElement.textContent);
                    resourceValues.push(value);
                    totalUsed += value;
                }
                
                if (totalUsed > gameState.levelData.resources) {
                    showToast('资源超出限制', 'error');
                    return;
                }
                
                // 检查是否满足目标
                let isCorrect = true;
                
                for (let i = 0; i < gameState.levelData.targets; i++) {
                    if (resourceValues[i] < gameState.levelData.targetResources[i]) {
                        isCorrect = false;
                        break;
                    }
                }
                
                if (isCorrect) {
                    completeLevel();
                } else {
                    showToast('资源分配不正确', 'error');
                    failLevel('资源分配不正确！');
                }
            });
            
            // 记忆提交按钮
            elements.buttons.memorySubmit.addEventListener('click', () => {
                const inputValues = [];
                
                for (let i = 0; i < gameState.levelData.items; i++) {
                    const inputItem = document.querySelector(`.memory-input-item[data-index="${i}"]`);
                    inputValues.push(inputItem.dataset.value);
                }
                
                // 检查是否正确
                let isCorrect = true;
                
                for (let i = 0; i < gameState.levelData.items; i++) {
                    if (inputValues[i] !== gameState.levelData.memoryItems[i].value) {
                        isCorrect = false;
                        break;
                    }
                }
                
                if (isCorrect) {
                    completeLevel();
                } else {
                    showToast('记忆不正确', 'error');
                    failLevel('记忆不正确！');
                }
            });
            
            // 模态框关闭按钮
            elements.modal.close.addEventListener('click', hideModal);
            
            // 点击模态框外部关闭
            elements.modal.modal.addEventListener('click', (e) => {
                if (e.target === elements.modal.modal) {
                    hideModal();
                }
            });
            
            // 添加分享功能
            document.addEventListener('keydown', (e) => {
                // Ctrl+Shift+S 分享
                if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                    e.preventDefault();
                    recordShare();
                }
            });
        }

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
