<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>万花消消乐</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFD166;
            --dark-color: #2D3436;
            --light-color: #F8F9FA;
            --success-color: #06D6A0;
            --warning-color: #FFD166;
            --danger-color: #EF476F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--dark-color);
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 414px;
            height: 100vh;
            max-height: 896px;
            background-color: var(--light-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            font-size: 20px;
            font-weight: bold;
        }

        .coins-display {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .coins-icon {
            margin-right: 5px;
            color: var(--accent-color);
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .page {
            display: none;
            width: 100%;
            height: 100%;
            padding: 15px;
        }

        .page.active {
            display: block;
        }

        /* 登录页面 */
        .login-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }

        .login-page.active {
            display: flex;
        }

        .game-logo {
            width: 150px;
            height: 150px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .game-logo i {
            font-size: 80px;
            color: white;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .login-subtitle {
            font-size: 16px;
            margin-bottom: 30px;
            color: #666;
        }

        .login-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .login-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* 主菜单页面 */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .user-info {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar i {
            font-size: 30px;
            color: white;
        }

        .user-details h3 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .user-coins {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
        }

        .menu-buttons {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .menu-button {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .menu-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .menu-button i {
            font-size: 30px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .menu-button span {
            font-weight: bold;
        }

        .daily-checkin {
            width: 100%;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .checkin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkin-title {
            font-size: 18px;
            font-weight: bold;
        }

        .checkin-button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkin-button:hover {
            background-color: var(--light-color);
        }

        .checkin-button:disabled {
            background-color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .checkin-progress {
            display: flex;
            justify-content: space-between;
        }

        .checkin-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }

        .checkin-day-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .checkin-day-circle.checked {
            background-color: white;
            color: var(--primary-color);
        }

        .checkin-day-label {
            font-size: 10px;
        }

        .daily-tasks {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tasks-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark-color);
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .task-progress {
            font-size: 14px;
            color: #666;
        }

        .task-reward {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
        }

        .task-claim-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }

        .task-claim-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* 关卡选择页面 */
        .level-select {
            padding-bottom: 60px;
        }

        .level-map {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .level-path {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 10px;
            background-color: #ddd;
            transform: translateY(-50%);
        }

        .level-node {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .level-node:hover {
            transform: scale(1.1);
        }

        .level-node.locked {
            background-color: #ccc;
            border-color: #999;
            color: #666;
            cursor: not-allowed;
        }

        .level-node.completed {
            background-color: var(--success-color);
            color: white;
        }

        .level-stars {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
        }

        .level-star {
            color: var(--warning-color);
            font-size: 12px;
            margin: 0 1px;
        }

        .game-plays {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            padding: 15px;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plays-count {
            display: flex;
            align-items: center;
        }

        .plays-icon {
            margin-right: 5px;
            color: var(--primary-color);
        }

        .plays-actions {
            display: flex;
        }

        .play-action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            margin-left: 10px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .play-action-button i {
            margin-right: 5px;
        }

        /* 游戏页面 */
        .game-board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .game-info {
            width: 100%;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .game-level {
            font-weight: bold;
        }

        .game-score {
            display: flex;
            align-items: center;
        }

        .game-score i {
            margin-right: 5px;
            color: var(--primary-color);
        }

        .game-moves {
            display: flex;
            align-items: center;
        }

        .game-moves i {
            margin-right: 5px;
            color: var(--secondary-color);
        }

        .game-board {
            background-color: #f0f0f0;
            border-radius: 15px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-gap: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .game-cell {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .game-cell:hover {
            transform: scale(1.05);
        }

        .game-cell.selected {
            box-shadow: 0 0 0 3px var(--primary-color);
            transform: scale(1.1);
        }

        .game-cell.matched {
            animation: matchedAnimation 0.5s;
        }

        @keyframes matchedAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(0); opacity: 0; }
        }

        .game-element {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .element-red {
            background-color: #FF6B6B;
        }

        .element-blue {
            background-color: #4D96FF;
        }

        .element-green {
            background-color: #6BCB77;
        }

        .element-yellow {
            background-color: #FFD93D;
        }

        .element-purple {
            background-color: #9C51E0;
        }

        .element-orange {
            background-color: #FF9A3D;
        }

        .element-rocket-h {
            background-color: #FF6B6B;
            width: 100%;
            height: 40%;
            border-radius: 10px;
        }

        .element-rocket-v {
            background-color: #FF6B6B;
            width: 40%;
            height: 100%;
            border-radius: 10px;
        }

        .element-bomb {
            background-color: #FF6B6B;
            width: 80%;
            height: 80%;
            border-radius: 10px;
        }

        .element-rainbow {
            background: linear-gradient(45deg, #FF6B6B, #4D96FF, #6BCB77, #FFD93D, #9C51E0);
            width: 80%;
            height: 80%;
            border-radius: 50%;
        }

        .game-obstacle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
        }

        .obstacle-ice {
            background-color: rgba(173, 216, 230, 0.7);
        }

        .obstacle-ice::after {
            content: "❄️";
            font-size: 20px;
        }

        .obstacle-cage {
            background-color: rgba(169, 169, 169, 0.7);
        }

        .obstacle-cage::after {
            content: "🔒";
            font-size: 20px;
        }

        .game-powerups {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }

        .powerup-button {
            background-color: white;
            border-radius: 15px;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .powerup-button:hover {
            transform: translateY(-5px);
        }

        .powerup-button.active {
            box-shadow: 0 0 0 3px var(--primary-color);
        }

        .powerup-count {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: var(--primary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* 成就页面 */
        .achievements-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .achievement-card {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: white;
            font-size: 24px;
        }

        .achievement-icon.completed {
            background-color: var(--success-color);
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .achievement-progress {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-weight: bold;
            margin-left: 10px;
        }

        /* 排行榜页面 */
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 15px;
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .leaderboard-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .leaderboard-list {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .leaderboard-rank.top1 {
            background-color: gold;
            color: white;
        }

        .leaderboard-rank.top2 {
            background-color: silver;
            color: white;
        }

        .leaderboard-rank.top3 {
            background-color: #CD7F32;
            color: white;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            overflow: hidden;
        }

        .leaderboard-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .leaderboard-avatar i {
            font-size: 20px;
            color: white;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .leaderboard-coins {
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-size: 14px;
        }

        .leaderboard-reward {
            background-color: var(--accent-color);
            color: var(--dark-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        /* 提现页面 */
        .withdrawal-form {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .withdrawal-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .withdrawal-rate {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .withdrawal-amount {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 18px;
        }

        .withdrawal-button {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .withdrawal-button:hover {
            background-color: #e55555;
        }

        .withdrawal-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .withdrawal-history {
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .withdrawal-history-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .withdrawal-history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .withdrawal-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .withdrawal-history-item:last-child {
            border-bottom: none;
        }

        .withdrawal-history-details {
            flex: 1;
        }

        .withdrawal-history-amount {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .withdrawal-history-date {
            font-size: 14px;
            color: #666;
        }

        .withdrawal-history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* 底部导航 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .nav-item:hover {
            transform: translateY(-3px);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* 页脚 */
        .app-footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* 加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 提示框 */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* 模态框 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }

        .modal-button-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }

        .modal-button-secondary {
            background-color: #f0f0f0;
            color: var(--dark-color);
            border: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-title">万花消消乐</div>
            <div class="coins-display">
                <i class="fas fa-coins coins-icon"></i>
                <span id="header-coins">0</span>
            </div>
        </div>

        <div class="app-content">
            <!-- 登录页面 -->
            <div class="page login-page active" id="login-page">
                <div class="game-logo">
                    <i class="fas fa-gem"></i>
                </div>
                <h1 class="login-title">万花消消乐</h1>
                <p class="login-subtitle">消除宝石，赢取万花币</p>
                <button class="login-button" id="login-button">
                    <i class="fab fa-telegram-plane"></i> 使用Telegram登录
                </button>
            </div>

            <!-- 主菜单页面 -->
            <div class="page main-menu" id="main-menu-page">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <h3 id="user-name">玩家</h3>
                        <div class="user-coins">
                            <i class="fas fa-coins"></i>
                            <span id="user-coins">0</span> 万花币
                        </div>
                    </div>
                </div>

                <div class="menu-buttons">
                    <div class="menu-button" id="play-button">
                        <i class="fas fa-play"></i>
                        <span>开始游戏</span>
                    </div>
                    <div class="menu-button" id="achievements-button">
                        <i class="fas fa-trophy"></i>
                        <span>成就</span>
                    </div>
                    <div class="menu-button" id="leaderboard-button">
                        <i class="fas fa-crown"></i>
                        <span>排行榜</span>
                    </div>
                    <div class="menu-button" id="withdrawal-button">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>提现</span>
                    </div>
                </div>

                <div class="daily-checkin">
                    <div class="checkin-header">
                        <div class="checkin-title">每日签到</div>
                        <button class="checkin-button" id="checkin-button">签到</button>
                    </div>
                    <div class="checkin-progress" id="checkin-progress">
                        <!-- 签到进度将通过JS动态生成 -->
                    </div>
                </div>

                <div class="daily-tasks">
                    <div class="tasks-header">
                        <div class="tasks-title">每日任务</div>
                    </div>
                    <div id="daily-tasks-list">
                        <!-- 每日任务将通过JS动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 关卡选择页面 -->
            <div class="page level-select" id="level-select-page">
                <div class="level-map" id="level-map">
                    <div class="level-path"></div>
                    <!-- 关卡节点将通过JS动态生成 -->
                </div>
                <div class="game-plays">
                    <div class="plays-count">
                        <i class="fas fa-gamepad plays-icon"></i>
                        <span>剩余次数: <span id="remaining-plays">0</span></span>
                    </div>
                    <div class="plays-actions">
                        <button class="play-action-button" id="watch-ad-button">
                            <i class="fas fa-ad"></i> 看广告
                        </button>
                        <button class="play-action-button" id="share-button">
                            <i class="fas fa-share-alt"></i> 分享
                        </button>
                    </div>
                </div>
            </div>

            <!-- 游戏页面 -->
            <div class="page game-page" id="game-page">
                <div class="game-board-container">
                    <div class="game-info">
                        <div class="game-level">关卡 <span id="current-level">1</span></div>
                        <div class="game-score">
                            <i class="fas fa-star"></i>
                            <span id="game-score">0</span>
                        </div>
                        <div class="game-moves">
                            <i class="fas fa-hand-pointer"></i>
                            <span id="game-moves">0</span>
                        </div>
                    </div>
                    <div class="game-board" id="game-board">
                        <!-- 游戏棋盘将通过JS动态生成 -->
                    </div>
                    <div class="game-powerups">
                        <div class="powerup-button" id="powerup-refresh">
                            <i class="fas fa-sync-alt"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-bomb">
                            <i class="fas fa-bomb"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-hammer">
                            <i class="fas fa-hammer"></i>
                            <div class="powerup-count">3</div>
                        </div>
                        <div class="powerup-button" id="powerup-color">
                            <i class="fas fa-palette"></i>
                            <div class="powerup-count">3</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成就页面 -->
            <div class="page achievements-page" id="achievements-page">
                <div class="achievements-list" id="achievements-list">
                    <!-- 成就列表将通过JS动态生成 -->
                </div>
            </div>

            <!-- 排行榜页面 -->
            <div class="page leaderboard-page" id="leaderboard-page">
                <div class="leaderboard-tabs">
                    <div class="leaderboard-tab active" data-period="daily">日榜</div>
                    <div class="leaderboard-tab" data-period="weekly">周榜</div>
                    <div class="leaderboard-tab" data-period="monthly">月榜</div>
                </div>
                <div class="leaderboard-list" id="leaderboard-list">
                    <!-- 排行榜列表将通过JS动态生成 -->
                </div>
            </div>

            <!-- 提现页面 -->
            <div class="page withdrawal-page" id="withdrawal-page">
                <div class="withdrawal-form">
                    <div class="form-group">
                        <label class="form-label">提现金额 (万花币)</label>
                        <input type="number" class="form-input" id="withdrawal-amount" placeholder="最少1000万花币" min="1000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">支付宝账号</label>
                        <input type="text" class="form-input" id="alipay-account" placeholder="请输入支付宝账号">
                    </div>
                    <div class="form-group">
                        <label class="form-label">真实姓名</label>
                        <input type="text" class="form-input" id="real-name" placeholder="请输入真实姓名">
                    </div>
                    <div class="withdrawal-info">
                        <div class="withdrawal-rate">
                            <span>汇率</span>
                            <span>1000万花币 = 10元</span>
                        </div>
                        <div class="withdrawal-amount">
                            <span>预计到账</span>
                            <span id="withdrawal-rmb">0元</span>
                        </div>
                    </div>
                    <button class="withdrawal-button" id="submit-withdrawal">提交提现申请</button>
                </div>
                <div class="withdrawal-history">
                    <div class="withdrawal-history-header">提现记录</div>
                    <div class="withdrawal-history-list" id="withdrawal-history-list">
                        <!-- 提现记录将通过JS动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="main-menu-page">
                <i class="fas fa-home nav-icon"></i>
                <div class="nav-label">首页</div>
            </div>
            <div class="nav-item" data-page="level-select-page">
                <i class="fas fa-gamepad nav-icon"></i>
                <div class="nav-label">游戏</div>
            </div>
            <div class="nav-item" data-page="achievements-page">
                <i class="fas fa-trophy nav-icon"></i>
                <div class="nav-label">成就</div>
            </div>
            <div class="nav-item" data-page="leaderboard-page">
                <i class="fas fa-crown nav-icon"></i>
                <div class="nav-label">排行</div>
            </div>
            <div class="nav-item" data-page="withdrawal-page">
                <i class="fas fa-money-bill-wave nav-icon"></i>
                <div class="nav-label">提现</div>
            </div>
        </div>

        <div class="app-footer">
            本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank" class="footer-link">@bjxc010</a> 开发
        </div>
    </div>

    <!-- 提示框 -->
    <div class="toast" id="toast"></div>

    <!-- 模态框 -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">提示</div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- 模态框内容 -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- 模态框按钮 -->
            </div>
        </div>
    </div>

    <script>
        // API地址
        const API_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';

        // 游戏状态
        const gameState = {
            user: null,
            currentLevel: 1,
            gameBoard: [],
            selectedCell: null,
            score: 0,
            moves: 0,
            maxMoves: 20,
            gameActive: false,
            powerups: {
                refresh: 3,
                bomb: 3,
                hammer: 3,
                color: 3
            }
        };

        // DOM元素
        const elements = {
            // 页面
            pages: {
                login: document.getElementById('login-page'),
                mainMenu: document.getElementById('main-menu-page'),
                levelSelect: document.getElementById('level-select-page'),
                game: document.getElementById('game-page'),
                achievements: document.getElementById('achievements-page'),
                leaderboard: document.getElementById('leaderboard-page'),
                withdrawal: document.getElementById('withdrawal-page')
            },
            // 用户信息
            userAvatar: document.getElementById('user-avatar'),
            userName: document.getElementById('user-name'),
            userCoins: document.getElementById('user-coins'),
            headerCoins: document.getElementById('header-coins'),
            // 游戏元素
            gameBoard: document.getElementById('game-board'),
            currentLevel: document.getElementById('current-level'),
            gameScore: document.getElementById('game-score'),
            gameMoves: document.getElementById('game-moves'),
            // 关卡选择
            levelMap: document.getElementById('level-map'),
            remainingPlays: document.getElementById('remaining-plays'),
            // 签到
            checkinButton: document.getElementById('checkin-button'),
            checkinProgress: document.getElementById('checkin-progress'),
            // 每日任务
            dailyTasksList: document.getElementById('daily-tasks-list'),
            // 成就
            achievementsList: document.getElementById('achievements-list'),
            // 排行榜
            leaderboardTabs: document.querySelectorAll('.leaderboard-tab'),
            leaderboardList: document.getElementById('leaderboard-list'),
            // 提现
            withdrawalAmount: document.getElementById('withdrawal-amount'),
            alipayAccount: document.getElementById('alipay-account'),
            realName: document.getElementById('real-name'),
            withdrawalRmb: document.getElementById('withdrawal-rmb'),
            withdrawalHistoryList: document.getElementById('withdrawal-history-list'),
            // 其他
            toast: document.getElementById('toast'),
            modal: document.getElementById('modal'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalFooter: document.getElementById('modal-footer'),
            modalClose: document.getElementById('modal-close')
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查URL参数中是否有user_id
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            
            if (userId) {
                // 如果有user_id，直接获取用户信息
                fetchUser(userId);
            } else {
                // 否则显示登录页面
                showPage('login');
            }
            
            // 绑定事件
            bindEvents();
        });

        // 绑定事件
        function bindEvents() {
            // 登录按钮
            document.getElementById('login-button').addEventListener('click', () => {
                // 在实际应用中，这里应该调用Telegram登录API
                // 这里简化处理，直接模拟登录
                const mockUser = {
                    id: 123456789,
                    first_name: '测试',
                    last_name: '用户',
                    username: 'testuser',
                    photo_url: null
                };
                
                login(mockUser);
            });
            
            // 底部导航
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const pageId = item.getAttribute('data-page');
                    showPage(pageId);
                    
                    // 更新导航栏激活状态
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    item.classList.add('active');
                });
            });
            
            // 主菜单按钮
            document.getElementById('play-button').addEventListener('click', () => {
                showPage('levelSelect');
                loadLevelMap();
                loadGamePlays();
            });
            
            document.getElementById('achievements-button').addEventListener('click', () => {
                showPage('achievements');
                loadAchievements();
            });
            
            document.getElementById('leaderboard-button').addEventListener('click', () => {
                showPage('leaderboard');
                loadLeaderboard('monthly');
            });
            
            document.getElementById('withdrawal-button').addEventListener('click', () => {
                showPage('withdrawal');
                loadWithdrawalHistory();
            });
            
            // 签到按钮
            elements.checkinButton.addEventListener('click', () => {
                dailyCheckin();
            });
            
            // 游戏次数按钮
            document.getElementById('watch-ad-button').addEventListener('click', () => {
                // 模拟看广告
                addGamePlay('ad');
            });
            
            document.getElementById('share-button').addEventListener('click', () => {
                // 模拟分享
                shareGame();
            });
            
            // 提现表单
            elements.withdrawalAmount.addEventListener('input', updateWithdrawalRmb);
            document.getElementById('submit-withdrawal').addEventListener('click', submitWithdrawal);
            
            // 排行榜标签
            elements.leaderboardTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const period = tab.getAttribute('data-period');
                    
                    // 更新标签激活状态
                    elements.leaderboardTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 加载对应排行榜
                    loadLeaderboard(period);
                });
            });
            
            // 模态框关闭按钮
            elements.modalClose.addEventListener('click', closeModal);
            
            // 点击模态框外部关闭
            elements.modal.addEventListener('click', (e) => {
                if (e.target === elements.modal) {
                    closeModal();
                }
            });
        }

        // 显示页面
        function showPage(pageId) {
            // 隐藏所有页面
            Object.values(elements.pages).forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            if (elements.pages[pageId]) {
                elements.pages[pageId].classList.add('active');
            }
        }

        // 显示提示
        function showToast(message, duration = 3000) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, duration);
        }

        // 显示模态框
        function showModal(title, content, buttons = []) {
            elements.modalTitle.textContent = title;
            elements.modalBody.innerHTML = content;
            
            // 清空按钮容器
            elements.modalFooter.innerHTML = '';
            
            // 添加按钮
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.textContent = button.text;
                btn.className = `modal-button ${button.primary ? 'modal-button-primary' : 'modal-button-secondary'}`;
                
                btn.addEventListener('click', () => {
                    if (button.onClick) {
                        button.onClick();
                    }
                    closeModal();
                });
                
                elements.modalFooter.appendChild(btn);
            });
            
            // 显示模态框
            elements.modal.classList.add('active');
        }

        // 关闭模态框
        function closeModal() {
            elements.modal.classList.remove('active');
        }

        // 登录
        async function login(telegramData) {
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ telegramData })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 保存用户信息
                gameState.user = data.user;
                
                // 更新UI
                updateUserUI();
                
                // 显示主菜单
                showPage('mainMenu');
                
                // 更新导航栏激活状态
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="main-menu-page"]').classList.add('active');
                
                // 加载签到状态
                loadCheckinStatus();
                
                // 加载每日任务
                loadDailyTasks();
                
                // 如果是新用户，显示欢迎消息
                if (data.isNewUser) {
                    showToast('欢迎来到万花消消乐！您已获得50万花币作为注册奖励。');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('登录失败，请重试');
            }
        }

        // 获取用户信息
        async function fetchUser(userId) {
            try {
                const response = await fetch(`${API_URL}/user?user_id=${userId}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    showPage('login');
                    return;
                }
                
                // 保存用户信息
                gameState.user = data.user;
                
                // 更新UI
                updateUserUI();
                
                // 显示主菜单
                showPage('mainMenu');
                
                // 更新导航栏激活状态
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                document.querySelector('.nav-item[data-page="main-menu-page"]').classList.add('active');
                
                // 加载签到状态
                loadCheckinStatus();
                
                // 加载每日任务
                loadDailyTasks();
            } catch (error) {
                console.error('Fetch user error:', error);
                showToast('获取用户信息失败');
                showPage('login');
            }
        }

        // 更新用户UI
        function updateUserUI() {
            if (!gameState.user) return;
            
            // 更新用户头像
            if (gameState.user.photo_url) {
                elements.userAvatar.innerHTML = `<img src="${gameState.user.photo_url}" alt="Avatar">`;
            } else {
                elements.userAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            
            // 更新用户名
            elements.userName.textContent = gameState.user.first_name || '玩家';
            
            // 更新万花币
            elements.userCoins.textContent = gameState.user.flower_coins || 0;
            elements.headerCoins.textContent = gameState.user.flower_coins || 0;
        }

        // 加载签到状态
        async function loadCheckinStatus() {
            try {
                // 这里应该调用API获取签到状态
                // 简化处理，直接模拟
                const checkinData = {
                    consecutive_days: 3,
                    can_checkin: true
                };
                
                // 更新签到进度UI
                updateCheckinProgress(checkinData.consecutive_days);
                
                // 更新签到按钮
                elements.checkinButton.disabled = !checkinData.can_checkin;
                elements.checkinButton.textContent = checkinData.can_checkin ? '签到' : '已签到';
            } catch (error) {
                console.error('Load checkin status error:', error);
            }
        }

        // 更新签到进度UI
        function updateCheckinProgress(consecutiveDays) {
            elements.checkinProgress.innerHTML = '';
            
            for (let i = 1; i <= 7; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'checkin-day';
                
                const circleElement = document.createElement('div');
                circleElement.className = 'checkin-day-circle';
                
                if (i <= consecutiveDays) {
                    circleElement.classList.add('checked');
                }
                
                circleElement.textContent = i;
                
                const labelElement = document.createElement('div');
                labelElement.className = 'checkin-day-label';
                labelElement.textContent = `第${i}天`;
                
                dayElement.appendChild(circleElement);
                dayElement.appendChild(labelElement);
                
                elements.checkinProgress.appendChild(dayElement);
            }
        }

        // 每日签到
        async function dailyCheckin() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/daily_checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: gameState.user.id })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新用户万花币
                gameState.user.flower_coins += data.flower_coins_earned;
                updateUserUI();
                
                // 更新签到进度
                updateCheckinProgress(data.consecutive_days);
                
                // 禁用签到按钮
                elements.checkinButton.disabled = true;
                elements.checkinButton.textContent = '已签到';
                
                // 显示成功消息
                showToast(`签到成功！获得${data.flower_coins_earned}万花币`);
            } catch (error) {
                console.error('Daily checkin error:', error);
                showToast('签到失败，请重试');
            }
        }

        // 加载每日任务
        async function loadDailyTasks() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/daily_tasks?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新每日任务UI
                updateDailyTasksUI(data.daily_tasks);
            } catch (error) {
                console.error('Load daily tasks error:', error);
                showToast('加载每日任务失败');
            }
        }

        // 更新每日任务UI
        function updateDailyTasksUI(tasks) {
            elements.dailyTasksList.innerHTML = '';
            
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                
                const taskInfo = document.createElement('div');
                taskInfo.className = 'task-info';
                
                const taskName = document.createElement('div');
                taskName.className = 'task-name';
                taskName.textContent = task.description;
                
                const taskProgress = document.createElement('div');
                taskProgress.className = 'task-progress';
                taskProgress.textContent = `${task.progress_value}/${task.target_value}`;
                
                taskInfo.appendChild(taskName);
                taskInfo.appendChild(taskProgress);
                
                const taskReward = document.createElement('div');
                taskReward.className = 'task-reward';
                taskReward.innerHTML = `<i class="fas fa-coins"></i> ${task.flower_coins_reward}`;
                
                if (task.completed && !task.flower_coins_claimed) {
                    const claimButton = document.createElement('button');
                    claimButton.className = 'task-claim-button';
                    claimButton.textContent = '领取';
                    
                    claimButton.addEventListener('click', () => {
                        claimTaskReward(task.id);
                    });
                    
                    taskReward.appendChild(claimButton);
                }
                
                taskElement.appendChild(taskInfo);
                taskElement.appendChild(taskReward);
                
                elements.dailyTasksList.appendChild(taskElement);
            });
        }

        // 领取任务奖励
        async function claimTaskReward(taskId) {
            if (!gameState.user) return;
            
            try {
                // 这里应该调用API领取任务奖励
                // 简化处理，直接模拟
                const reward = 50;
                
                // 更新用户万花币
                gameState.user.flower_coins += reward;
                updateUserUI();
                
                // 重新加载每日任务
                loadDailyTasks();
                
                // 显示成功消息
                showToast(`任务奖励领取成功！获得${reward}万花币`);
            } catch (error) {
                console.error('Claim task reward error:', error);
                showToast('领取任务奖励失败');
            }
        }

        // 加载关卡地图
        async function loadLevelMap() {
            try {
                const response = await fetch(`${API_URL}/levels`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新关卡地图UI
                updateLevelMapUI(data.levels);
            } catch (error) {
                console.error('Load levels error:', error);
                showToast('加载关卡失败');
            }
        }

        // 更新关卡地图UI
        function updateLevelMapUI(levels) {
            // 清除现有关卡节点
            const existingNodes = elements.levelMap.querySelectorAll('.level-node');
            existingNodes.forEach(node => node.remove());
            
            // 创建新关卡节点
            levels.forEach((level, index) => {
                const node = document.createElement('div');
                node.className = 'level-node';
                node.textContent = level.level_number;
                
                // 设置位置
                const position = calculateNodePosition(index, levels.length);
                node.style.left = `${position.x}%`;
                node.style.top = `${position.y}%`;
                
                // 添加点击事件
                node.addEventListener('click', () => {
                    startLevel(level.id);
                });
                
                elements.levelMap.appendChild(node);
                
                // 如果关卡已完成，添加星星
                if (index < 3) { // 模拟前3个关卡已完成
                    node.classList.add('completed');
                    
                    const stars = document.createElement('div');
                    stars.className = 'level-stars';
                    
                    for (let i = 0; i < 3; i++) {
                        const star = document.createElement('i');
                        star.className = 'fas fa-star level-star';
                        stars.appendChild(star);
                    }
                    
                    node.appendChild(stars);
                }
            });
        }

        // 计算关卡节点位置
        function calculateNodePosition(index, total) {
            // 简化处理，将节点排列在一条曲线上
            const x = (index / (total - 1)) * 80 + 10; // 10% - 90%
            const y = 50 + Math.sin((index / (total - 1)) * Math.PI) * 20; // 波浪形
            
            return { x, y };
        }

        // 加载游戏次数
        async function loadGamePlays() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/game_plays?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 计算剩余游戏次数
                const gamePlay = data.game_play;
                const remainingPlays = 7 - gamePlay.free_plays_used + 
                                     (5 - gamePlay.ad_plays_used) + 
                                     (3 - gamePlay.share_plays_used) + 
                                     gamePlay.gift_plays_used;
                
                // 更新UI
                elements.remainingPlays.textContent = remainingPlays;
            } catch (error) {
                console.error('Load game plays error:', error);
                showToast('加载游戏次数失败');
            }
        }

        // 添加游戏次数
        async function addGamePlay(type) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/use_game_play`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: gameState.user.id,
                        play_type: type
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 重新加载游戏次数
                loadGamePlays();
                
                // 显示成功消息
                if (type === 'ad') {
                    showToast('观看广告成功！获得1次游戏机会');
                }
            } catch (error) {
                console.error('Add game play error:', error);
                showToast('添加游戏次数失败');
            }
        }

        // 分享游戏
        async function shareGame() {
            if (!gameState.user) return;
            
            try {
                // 模拟分享到Telegram
                const shareUrl = `https://t.me/share/url?url=https://beijingshunyi.github.io/game-web/?user_id=${gameState.user.id}&text=来玩万花消消乐，消除宝石赢取万花币！`;
                window.open(shareUrl, '_blank');
                
                // 记录分享
                const response = await fetch(`${API_URL}/record_share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: gameState.user.id,
                        share_type: 'telegram_group'
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 重新加载游戏次数
                loadGamePlays();
                
                // 显示成功消息
                showToast('分享成功！获得2次游戏机会');
            } catch (error) {
                console.error('Share game error:', error);
                showToast('分享失败');
            }
        }

        // 开始关卡
        async function startLevel(levelId) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/level?level_id=${levelId}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 保存关卡信息
                gameState.currentLevel = data.level;
                
                // 初始化游戏
                initGame();
                
                // 显示游戏页面
                showPage('game');
            } catch (error) {
                console.error('Start level error:', error);
                showToast('开始关卡失败');
            }
        }

        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            gameState.score = 0;
            gameState.moves = 0;
            gameState.gameActive = true;
            gameState.selectedCell = null;
            
            // 更新UI
            elements.currentLevel.textContent = gameState.currentLevel.level_number;
            elements.gameScore.textContent = gameState.score;
            elements.gameMoves.textContent = gameState.moves;
            
            // 生成游戏棋盘
            generateGameBoard();
        }

        // 生成游戏棋盘
        function generateGameBoard() {
            // 清空棋盘
            elements.gameBoard.innerHTML = '';
            
            // 获取棋盘尺寸
            const boardSize = gameState.currentLevel.board_config.size;
            const rows = boardSize[1];
            const cols = boardSize[0];
            
            // 设置棋盘网格
            elements.gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            elements.gameBoard.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            // 生成游戏元素
            gameState.gameBoard = [];
            
            for (let row = 0; row < rows; row++) {
                gameState.gameBoard[row] = [];
                
                for (let col = 0; col < cols; col++) {
                    // 创建单元格
                    const cell = document.createElement('div');
                    cell.className = 'game-cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    // 随机生成元素类型
                    const elementTypes = gameState.currentLevel.board_config.elements;
                    const elementType = elementTypes[Math.floor(Math.random() * elementTypes.length)];
                    
                    // 创建游戏元素
                    const element = document.createElement('div');
                    element.className = `game-element element-${elementType}`;
                    
                    // 添加点击事件
                    cell.addEventListener('click', () => {
                        handleCellClick(row, col);
                    });
                    
                    cell.appendChild(element);
                    elements.gameBoard.appendChild(cell);
                    
                    // 保存到游戏状态
                    gameState.gameBoard[row][col] = {
                        type: elementType,
                        element: element,
                        cell: cell
                    };
                }
            }
        }

        // 处理单元格点击
        function handleCellClick(row, col) {
            if (!gameState.gameActive) return;
            
            const clickedCell = gameState.gameBoard[row][col];
            
            if (!gameState.selectedCell) {
                // 选择第一个单元格
                gameState.selectedCell = { row, col };
                clickedCell.cell.classList.add('selected');
            } else {
                // 尝试匹配
                const selectedRow = gameState.selectedCell.row;
                const selectedCol = gameState.selectedCell.col;
                
                // 检查是否相邻
                const isAdjacent = 
                    (Math.abs(selectedRow - row) === 1 && selectedCol === col) ||
                    (Math.abs(selectedCol - col) === 1 && selectedRow === row);
                
                if (isAdjacent) {
                    // 交换元素
                    swapElements(selectedRow, selectedCol, row, col);
                } else {
                    // 选择新的单元格
                    gameState.gameBoard[selectedRow][selectedCol].cell.classList.remove('selected');
                    gameState.selectedCell = { row, col };
                    clickedCell.cell.classList.add('selected');
                }
            }
        }

        // 交换元素
        function swapElements(row1, col1, row2, col2) {
            // 交换游戏状态中的元素
            const temp = gameState.gameBoard[row1][col1];
            gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
            gameState.gameBoard[row2][col2] = temp;
            
            // 更新UI
            updateGameBoard();
            
            // 检查匹配
            setTimeout(() => {
                const matches = findMatches();
                
                if (matches.length > 0) {
                    // 有匹配，处理消除
                    processMatches(matches);
                    
                    // 增加移动次数
                    gameState.moves++;
                    elements.gameMoves.textContent = gameState.moves;
                    
                    // 检查游戏是否结束
                    checkGameEnd();
                } else {
                    // 没有匹配，交换回来
                    const temp = gameState.gameBoard[row1][col1];
                    gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
                    gameState.gameBoard[row2][col2] = temp;
                    
                    // 更新UI
                    updateGameBoard();
                }
                
                // 清除选择
                if (gameState.selectedCell) {
                    gameState.gameBoard[gameState.selectedCell.row][gameState.selectedCell.col].cell.classList.remove('selected');
                    gameState.selectedCell = null;
                }
            }, 300);
        }

        // 更新游戏棋盘UI
        function updateGameBoard() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const cellData = gameState.gameBoard[row][col];
                    cellData.element.className = `game-element element-${cellData.type}`;
                }
            }
        }

        // 查找匹配
        function findMatches() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            const matches = [];
            
            // 检查水平匹配
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols - 2; col++) {
                    const type = gameState.gameBoard[row][col].type;
                    
                    if (type && 
                        gameState.gameBoard[row][col + 1].type === type && 
                        gameState.gameBoard[row][col + 2].type === type) {
                        
                        // 找到匹配，继续检查是否有更多
                        let matchLength = 3;
                        while (col + matchLength < cols && gameState.gameBoard[row][col + matchLength].type === type) {
                            matchLength++;
                        }
                        
                        // 添加到匹配列表
                        const match = [];
                        for (let i = 0; i < matchLength; i++) {
                            match.push({ row, col: col + i });
                        }
                        
                        matches.push(match);
                        
                        // 跳过已匹配的元素
                        col += matchLength - 1;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let col = 0; col < cols; col++) {
                for (let row = 0; row < rows - 2; row++) {
                    const type = gameState.gameBoard[row][col].type;
                    
                    if (type && 
                        gameState.gameBoard[row + 1][col].type === type && 
                        gameState.gameBoard[row + 2][col].type === type) {
                        
                        // 找到匹配，继续检查是否有更多
                        let matchLength = 3;
                        while (row + matchLength < rows && gameState.gameBoard[row + matchLength][col].type === type) {
                            matchLength++;
                        }
                        
                        // 添加到匹配列表
                        const match = [];
                        for (let i = 0; i < matchLength; i++) {
                            match.push({ row: row + i, col });
                        }
                        
                        matches.push(match);
                        
                        // 跳过已匹配的元素
                        row += matchLength - 1;
                    }
                }
            }
            
            return matches;
        }

        // 处理匹配
        function processMatches(matches) {
            // 标记匹配的元素
            const matchedCells = new Set();
            
            matches.forEach(match => {
                match.forEach(cell => {
                    const key = `${cell.row},${cell.col}`;
                    if (!matchedCells.has(key)) {
                        matchedCells.add(key);
                        gameState.gameBoard[cell.row][cell.col].cell.classList.add('matched');
                    }
                });
            });
            
            // 计算得分
            const score = matchedCells.size * 10;
            gameState.score += score;
            elements.gameScore.textContent = gameState.score;
            
            // 处理消除和下落
            setTimeout(() => {
                // 移除匹配的元素
                matchedCells.forEach(key => {
                    const [row, col] = key.split(',').map(Number);
                    gameState.gameBoard[row][col].type = null;
                });
                
                // 元素下落
                dropElements();
                
                // 填充新元素
                fillBoard();
                
                // 更新UI
                updateGameBoard();
                
                // 检查新的匹配
                setTimeout(() => {
                    const newMatches = findMatches();
                    
                    if (newMatches.length > 0) {
                        // 有新的匹配，继续处理
                        processMatches(newMatches);
                    }
                }, 300);
            }, 500);
        }

        // 元素下落
        function dropElements() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            
            // 从下往上处理每一列
            for (let col = 0; col < cols; col++) {
                let emptyRow = rows - 1;
                
                // 从底部向上查找空位
                for (let row = rows - 1; row >= 0; row--) {
                    if (gameState.gameBoard[row][col].type !== null) {
                        // 如果当前行有元素，且下方有空位，则下落
                        if (row < emptyRow) {
                            gameState.gameBoard[emptyRow][col].type = gameState.gameBoard[row][col].type;
                            gameState.gameBoard[row][col].type = null;
                        }
                        emptyRow--;
                    }
                }
            }
        }

        // 填充棋盘
        function fillBoard() {
            const rows = gameState.gameBoard.length;
            const cols = gameState.gameBoard[0].length;
            const elementTypes = gameState.currentLevel.board_config.elements;
            
            // 填充空位
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    if (gameState.gameBoard[row][col].type === null) {
                        // 随机生成新元素
                        const elementType = elementTypes[Math.floor(Math.random() * elementTypes.length)];
                        gameState.gameBoard[row][col].type = elementType;
                    }
                }
            }
        }

        // 检查游戏结束
        function checkGameEnd() {
            // 检查步数是否用完
            if (gameState.moves >= gameState.currentLevel.max_moves) {
                // 游戏结束
                gameState.gameActive = false;
                
                // 计算星级
                let stars = 0;
                const scorePercentage = gameState.score / gameState.currentLevel.objectives.target;
                
                if (scorePercentage >= 1) stars = 3;
                else if (scorePercentage >= 0.7) stars = 2;
                else if (scorePercentage >= 0.4) stars = 1;
                
                // 显示结果
                showGameResult(stars);
            }
        }

        // 显示游戏结果
        function showGameResult(stars) {
            const completed = stars > 0;
            
            // 计算奖励万花币
            let flowerCoins = 0;
            if (completed) {
                if (gameState.currentLevel.difficulty === 'normal') {
                    flowerCoins = 10 + (stars - 1) * 5;  // 1星10，2星15，3星20
                } else if (gameState.currentLevel.difficulty === 'hard') {
                    flowerCoins = 25 + (stars - 1) * 5;  // 1星25，2星30，3星35
                }
            }
            
            // 构建结果消息
            let message = `<div style="text-align: center;">`;
            message += `<h2>关卡 ${gameState.currentLevel.level_number} ${completed ? '完成' : '失败'}</h2>`;
            message += `<div style="margin: 20px 0;">`;
            
            // 显示星级
            for (let i = 0; i < 3; i++) {
                if (i < stars) {
                    message += `<i class="fas fa-star" style="color: gold; font-size: 30px; margin: 0 5px;"></i>`;
                } else {
                    message += `<i class="far fa-star" style="color: #ccc; font-size: 30px; margin: 0 5px;"></i>`;
                }
            }
            
            message += `</div>`;
            message += `<p>得分: ${gameState.score}</p>`;
            
            if (completed) {
                message += `<p>获得: ${flowerCoins} 万花币</p>`;
            }
            
            message += `</div>`;
            
            // 显示模态框
            showModal('游戏结果', message, [
                {
                    text: '返回关卡选择',
                    onClick: () => {
                        showPage('levelSelect');
                        loadGamePlays();
                    }
                }
            ]);
            
            // 提交游戏结果
            submitGameResult(stars, flowerCoins);
        }

        // 提交游戏结果
        async function submitGameResult(stars, flowerCoins) {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/game_result`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: gameState.user.id,
                        level_id: gameState.currentLevel.id,
                        moves_used: gameState.moves,
                        score: gameState.score,
                        stars_earned: stars,
                        completed: stars > 0
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Submit game result error:', data.error);
                    return;
                }
                
                // 更新用户万花币
                if (flowerCoins > 0) {
                    gameState.user.flower_coins += flowerCoins;
                    updateUserUI();
                }
            } catch (error) {
                console.error('Submit game result error:', error);
            }
        }

        // 加载成就
        async function loadAchievements() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/achievements?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新成就UI
                updateAchievementsUI(data.achievements);
            } catch (error) {
                console.error('Load achievements error:', error);
                showToast('加载成就失败');
            }
        }

        // 更新成就UI
        function updateAchievementsUI(achievements) {
            elements.achievementsList.innerHTML = '';
            
            achievements.forEach(achievement => {
                const achievementElement = document.createElement('div');
                achievementElement.className = 'achievement-card';
                
                const iconElement = document.createElement('div');
                iconElement.className = 'achievement-icon';
                if (achievement.completed) {
                    iconElement.classList.add('completed');
                }
                iconElement.innerHTML = '<i class="fas fa-trophy"></i>';
                
                const detailsElement = document.createElement('div');
                detailsElement.className = 'achievement-details';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'achievement-name';
                nameElement.textContent = achievement.name;
                
                const descriptionElement = document.createElement('div');
                descriptionElement.className = 'achievement-description';
                descriptionElement.textContent = achievement.description;
                
                const progressElement = document.createElement('div');
                progressElement.className = 'achievement-progress';
                
                const progressBarElement = document.createElement('div');
                progressBarElement.className = 'achievement-progress-bar';
                
                // 计算进度百分比
                let progressPercentage = 0;
                if (achievement.progress_value > 0) {
                    // 这里需要根据不同类型的成就计算进度
                    progressPercentage = Math.min(100, (achievement.progress_value / 10) * 100);
                }
                
                progressBarElement.style.width = `${progressPercentage}%`;
                
                progressElement.appendChild(progressBarElement);
                
                detailsElement.appendChild(nameElement);
                detailsElement.appendChild(descriptionElement);
                detailsElement.appendChild(progressElement);
                
                const rewardElement = document.createElement('div');
                rewardElement.className = 'achievement-reward';
                rewardElement.innerHTML = `<i class="fas fa-coins"></i> ${achievement.flower_coins_reward}`;
                
                achievementElement.appendChild(iconElement);
                achievementElement.appendChild(detailsElement);
                achievementElement.appendChild(rewardElement);
                
                elements.achievementsList.appendChild(achievementElement);
            });
        }

        // 加载排行榜
        async function loadLeaderboard(period) {
            try {
                const response = await fetch(`${API_URL}/leaderboard?period=${period}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新排行榜UI
                updateLeaderboardUI(data.leaderboard);
            } catch (error) {
                console.error('Load leaderboard error:', error);
                showToast('加载排行榜失败');
            }
        }

        // 更新排行榜UI
        function updateLeaderboardUI(leaderboard) {
            elements.leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                elements.leaderboardList.innerHTML = '<div style="text-align: center; padding: 20px;">暂无排行榜数据</div>';
                return;
            }
            
            leaderboard.forEach((entry, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'leaderboard-item';
                
                const rankElement = document.createElement('div');
                rankElement.className = 'leaderboard-rank';
                if (index === 0) rankElement.classList.add('top1');
                else if (index === 1) rankElement.classList.add('top2');
                else if (index === 2) rankElement.classList.add('top3');
                rankElement.textContent = index + 1;
                
                const avatarElement = document.createElement('div');
                avatarElement.className = 'leaderboard-avatar';
                
                if (entry.users && entry.users.photo_url) {
                    avatarElement.innerHTML = `<img src="${entry.users.photo_url}" alt="Avatar">`;
                } else {
                    avatarElement.innerHTML = '<i class="fas fa-user"></i>';
                }
                
                const infoElement = document.createElement('div');
                infoElement.className = 'leaderboard-info';
                
                const nameElement = document.createElement('div');
                nameElement.className = 'leaderboard-name';
                nameElement.textContent = entry.users ? (entry.users.first_name || '玩家') : '玩家';
                
                const coinsElement = document.createElement('div');
                coinsElement.className = 'leaderboard-coins';
                coinsElement.innerHTML = `<i class="fas fa-coins"></i> ${entry.flower_coins_earned}`;
                
                infoElement.appendChild(nameElement);
                infoElement.appendChild(coinsElement);
                
                let rewardElement = null;
                if (index < 5) {
                    rewardElement = document.createElement('div');
                    rewardElement.className = 'leaderboard-reward';
                    
                    if (index === 0) rewardElement.textContent = '50元';
                    else if (index === 1) rewardElement.textContent = '30元';
                    else if (index === 2) rewardElement.textContent = '20元';
                    else rewardElement.textContent = '10元';
                }
                
                itemElement.appendChild(rankElement);
                itemElement.appendChild(avatarElement);
                itemElement.appendChild(infoElement);
                
                if (rewardElement) {
                    itemElement.appendChild(rewardElement);
                }
                
                elements.leaderboardList.appendChild(itemElement);
            });
        }

        // 更新提现人民币金额
        function updateWithdrawalRmb() {
            const amount = parseInt(elements.withdrawalAmount.value) || 0;
            const rmb = (amount / 1000) * 10;
            elements.withdrawalRmb.textContent = `${rmb.toFixed(2)}元`;
        }

        // 提交提现申请
        async function submitWithdrawal() {
            if (!gameState.user) return;
            
            const amount = parseInt(elements.withdrawalAmount.value);
            const alipayAccount = elements.alipayAccount.value.trim();
            const realName = elements.realName.value.trim();
            
            if (!amount || amount < 1000) {
                showToast('提现金额最少为1000万花币');
                return;
            }
            
            if (!alipayAccount) {
                showToast('请输入支付宝账号');
                return;
            }
            
            if (!realName) {
                showToast('请输入真实姓名');
                return;
            }
            
            if (amount > gameState.user.flower_coins) {
                showToast('万花币余额不足');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/withdrawal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: gameState.user.id,
                        amount,
                        alipay_account: alipayAccount,
                        real_name: realName
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新用户万花币
                gameState.user.flower_coins -= amount;
                updateUserUI();
                
                // 清空表单
                elements.withdrawalAmount.value = '';
                elements.alipayAccount.value = '';
                elements.realName.value = '';
                elements.withdrawalRmb.textContent = '0元';
                
                // 显示成功消息
                showToast('提现申请提交成功，请等待审核');
                
                // 重新加载提现记录
                loadWithdrawalHistory();
            } catch (error) {
                console.error('Submit withdrawal error:', error);
                showToast('提交提现申请失败');
            }
        }

        // 加载提现记录
        async function loadWithdrawalHistory() {
            if (!gameState.user) return;
            
            try {
                const response = await fetch(`${API_URL}/withdrawal?user_id=${gameState.user.id}`);
                const data = await response.json();
                
                if (data.error) {
                    showToast(data.error);
                    return;
                }
                
                // 更新提现记录UI
                updateWithdrawalHistoryUI(data.withdrawals);
            } catch (error) {
                console.error('Load withdrawal history error:', error);
                showToast('加载提现记录失败');
            }
        }

        // 更新提现记录UI
        function updateWithdrawalHistoryUI(withdrawals) {
            elements.withdrawalHistoryList.innerHTML = '';
            
            if (withdrawals.length === 0) {
                elements.withdrawalHistoryList.innerHTML = '<div style="text-align: center; padding: 20px;">暂无提现记录</div>';
                return;
            }
            
            withdrawals.forEach(withdrawal => {
                const itemElement = document.createElement('div');
                itemElement.className = 'withdrawal-history-item';
                
                const detailsElement = document.createElement('div');
                detailsElement.className = 'withdrawal-history-details';
                
                const amountElement = document.createElement('div');
                amountElement.className = 'withdrawal-history-amount';
                amountElement.textContent = `${withdrawal.amount}万花币 (${withdrawal.rmb_amount}元)`;
                
                const dateElement = document.createElement('div');
                dateElement.className = 'withdrawal-history-date';
                dateElement.textContent = new Date(withdrawal.created_at).toLocaleString();
                
                detailsElement.appendChild(amountElement);
                detailsElement.appendChild(dateElement);
                
                const statusElement = document.createElement('div');
                statusElement.className = 'withdrawal-history-status';
                
                if (withdrawal.status === 'pending') {
                    statusElement.classList.add('status-pending');
                    statusElement.textContent = '待审核';
                } else if (withdrawal.status === 'approved') {
                    statusElement.classList.add('status-approved');
                    statusElement.textContent = '已通过';
                } else if (withdrawal.status === 'rejected') {
                    statusElement.classList.add('status-rejected');
                    statusElement.textContent = '已拒绝';
                }
                
                itemElement.appendChild(detailsElement);
                itemElement.appendChild(statusElement);
                
                elements.withdrawalHistoryList.appendChild(itemElement);
            });
        }
    </script>
</body>
</html>
