<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万花楼消消乐</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* 入口页面样式 */
        .entry-screen {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .entry-logo {
            width: 120px;
            height: 120px;
            background-color: #ff6b6b;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .entry-logo i {
            font-size: 60px;
            color: white;
        }
        
        .entry-title {
            font-size: 32px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .entry-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .entry-button {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .entry-button:hover {
            background-color: #ff5252;
            transform: scale(1.05);
        }
        
        .entry-button i {
            margin-right: 10px;
        }
        
        .entry-qr {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .entry-qr img {
            width: 150px;
            height: 150px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .entry-qr-text {
            font-size: 14px;
            color: #666;
        }
        
        /* 主界面样式 */
        .main-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        .coins {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        
        .coins i {
            margin-right: 5px;
        }
        
        .level-map {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }
        
        .level-map h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .levels {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .level {
            aspect-ratio: 1;
            background-color: #f0f0f0;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .level:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .level.unlocked {
            background-color: #4ecdc4;
            color: white;
        }
        
        .level.completed {
            background-color: #ff6b6b;
            color: white;
        }
        
        .level-stars {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            font-size: 10px;
        }
        
        .bottom-nav {
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-item:hover {
            transform: translateY(-3px);
        }
        
        .nav-item i {
            font-size: 24px;
            margin-bottom: 5px;
            color: #ff6b6b;
        }
        
        .nav-item span {
            font-size: 12px;
        }
        
        /* 游戏界面样式 */
        .game-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .game-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-info {
            display: flex;
            flex-direction: column;
        }
        
        .game-info h3 {
            margin-bottom: 5px;
        }
        
        .game-stats {
            display: flex;
            gap: 15px;
        }
        
        .game-board {
            background-color: white;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 5px;
            aspect-ratio: 1;
            flex-grow: 1;
        }
        
        .tile {
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tile.selected {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.8);
        }
        
        .tile.red { background-color: #ff6b6b; }
        .tile.blue { background-color: #4dabf7; }
        .tile.green { background-color: #51cf66; }
        .tile.yellow { background-color: #ffd43b; }
        .tile.purple { background-color: #9775fa; }
        
        .game-footer {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 15px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .game-item {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .game-item:hover {
            transform: scale(1.1);
        }
        
        .game-item i {
            font-size: 24px;
            color: #ff6b6b;
        }
        
        /* 任务界面样式 */
        .tasks-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .tasks-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .tasks-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .task-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .task-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .task-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .task-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-info h4 {
            margin-bottom: 5px;
        }
        
        .task-info p {
            font-size: 14px;
            color: #666;
        }
        
        .task-progress {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .task-progress-bar {
            height: 100%;
            background-color: #4ecdc4;
            border-radius: 4px;
        }
        
        .task-reward {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .task-reward-amount {
            background-color: #ffd43b;
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .task-claim-btn {
            background-color: #4ecdc4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-claim-btn:hover {
            background-color: #3dbcb3;
        }
        
        .task-claim-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        /* 签到界面样式 */
        .checkin-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .checkin-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .checkin-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .checkin-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
            width: 100%;
        }
        
        .checkin-day {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            position: relative;
        }
        
        .checkin-day.checked {
            background-color: #4ecdc4;
            color: white;
        }
        
        .checkin-day.today {
            border: 2px solid #ff6b6b;
        }
        
        .checkin-day-number {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .checkin-day-reward {
            font-size: 12px;
        }
        
        .checkin-btn {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .checkin-btn:hover {
            background-color: #ff5252;
            transform: scale(1.05);
        }
        
        .checkin-btn:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }
        
        /* 排行榜界面样式 */
        .leaderboard-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .leaderboard-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .leaderboard-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .leaderboard-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .leaderboard-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            background-color: #f8f9fa;
        }
        
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .leaderboard-rank.top1 {
            background-color: #ffd43b;
            color: #333;
        }
        
        .leaderboard-rank.top2 {
            background-color: #adb5bd;
            color: white;
        }
        
        .leaderboard-rank.top3 {
            background-color: #cd7f32;
            color: white;
        }
        
        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #dee2e6;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }
        
        .leaderboard-info {
            flex-grow: 1;
        }
        
        .leaderboard-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .leaderboard-coins {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
        }
        
        .leaderboard-coins i {
            margin-right: 5px;
            color: #ffd43b;
        }
        
        /* 提现界面样式 */
        .withdraw-screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .withdraw-header {
            background-color: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .withdraw-content {
            background-color: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            flex-grow: 1;
        }
        
        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .withdraw-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .withdraw-amount-label {
            font-weight: bold;
        }
        
        .withdraw-amount-value {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .withdraw-submit {
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .withdraw-submit:hover {
            background-color: #ff5252;
        }
        
        .withdraw-history {
            margin-top: 30px;
        }
        
        .withdraw-history h3 {
            margin-bottom: 15px;
        }
        
        .withdraw-history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .withdraw-history-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .withdraw-history-info {
            display: flex;
            flex-direction: column;
        }
        
        .withdraw-history-amount {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .withdraw-history-date {
            font-size: 14px;
            color: #666;
        }
        
        .withdraw-history-status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .withdraw-history-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .withdraw-history-status.approved {
            background-color: #d4edda;
            color: #155724;
        }
        
        .withdraw-history-status.rejected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* 页脚样式 */
        .footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: #666;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        .footer a {
            color: #ff6b6b;
            text-decoration: none;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .modal-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .modal-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .modal-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* 游戏结束界面 */
        .game-over {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .game-over-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .game-over-score {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .game-over-stars {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .game-over-star {
            font-size: 30px;
            color: #e9ecef;
            margin: 0 5px;
        }
        
        .game-over-star.filled {
            color: #ffd43b;
        }
        
        .game-over-reward {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .game-over-reward-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .game-over-reward-amount {
            font-size: 20px;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .game-over-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .game-over-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .game-over-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .game-over-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .game-over-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .game-over-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* 游戏次数提示 */
        .play-limit {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .play-limit-content {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }
        
        .play-limit-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .play-limit-message {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .play-limit-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .play-limit-btn {
            padding: 12px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .play-limit-btn-primary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .play-limit-btn-primary:hover {
            background-color: #ff5252;
        }
        
        .play-limit-btn-secondary {
            background-color: #e9ecef;
            color: #333;
        }
        
        .play-limit-btn-secondary:hover {
            background-color: #dee2e6;
        }
        
        /* 加载动画 */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header {
                padding: 10px;
            }
            
            .level-map {
                padding: 15px;
            }
            
            .levels {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 入口页面 -->
        <div class="entry-screen" id="entryScreen">
            <div class="entry-logo">
                <i class="fas fa-gamepad"></i>
            </div>
            <h1 class="entry-title">万花楼消消乐</h1>
            <p class="entry-message">请通过Telegram机器人进入游戏</p>
            <button class="entry-button" onclick="openTelegramBot()">
                <i class="fab fa-telegram"></i> 打开Telegram机器人
            </button>
            <div class="entry-qr">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://t.me/bjxcwhljiluBot" alt="Telegram机器人二维码">
                <p class="entry-qr-text">扫描二维码或搜索 @bjxcwhljiluBot</p>
            </div>
        </div>
        
        <!-- 主界面 -->
        <div class="main-screen" id="mainScreen">
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span id="username">玩家</span>
                </div>
                <div class="coins">
                    <i class="fas fa-coins"></i>
                    <span id="userCoins">0</span>
                </div>
            </div>
            
            <div class="level-map">
                <h2>关卡地图</h2>
                <div class="levels" id="levelsList">
                    <!-- 关卡将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="bottom-nav">
                <div class="nav-item" onclick="showScreen('tasksScreen')">
                    <i class="fas fa-tasks"></i>
                    <span>任务</span>
                </div>
                <div class="nav-item" onclick="showScreen('checkinScreen')">
                    <i class="fas fa-calendar-check"></i>
                    <span>签到</span>
                </div>
                <div class="nav-item" onclick="showScreen('leaderboardScreen')">
                    <i class="fas fa-trophy"></i>
                    <span>排行榜</span>
                </div>
                <div class="nav-item" onclick="showScreen('withdrawScreen')">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>提现</span>
                </div>
            </div>
        </div>
        
        <!-- 游戏界面 -->
        <div class="game-screen" id="gameScreen">
            <div class="game-header">
                <div class="game-info">
                    <h3 id="levelName">第1关</h3>
                    <div>目标: <span id="levelTarget">1000</span>分</div>
                </div>
                <div class="game-stats">
                    <div>步数: <span id="movesLeft">20</span></div>
                    <div>分数: <span id="currentScore">0</span></div>
                </div>
            </div>
            
            <div class="game-board" id="gameBoard">
                <!-- 游戏棋盘将通过JavaScript动态生成 -->
            </div>
            
            <div class="game-footer">
                <div class="game-item" onclick="useItem('refresh')">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="game-item" onclick="useItem('bomb')">
                    <i class="fas fa-bomb"></i>
                </div>
                <div class="game-item" onclick="useItem('rocket')">
                    <i class="fas fa-rocket"></i>
                </div>
                <div class="game-item" onclick="useItem('rainbow')">
                    <i class="fas fa-rainbow"></i>
                </div>
            </div>
        </div>
        
        <!-- 任务界面 -->
        <div class="tasks-screen" id="tasksScreen">
            <div class="tasks-header">
                <h2>任务中心</h2>
            </div>
            
            <div class="tasks-content">
                <div class="task-tabs">
                    <div class="task-tab active" onclick="switchTaskTab('daily')">每日任务</div>
                    <div class="task-tab" onclick="switchTaskTab('achievement')">成就</div>
                </div>
                
                <div class="task-list" id="dailyTasksList">
                    <!-- 每日任务将通过JavaScript动态生成 -->
                </div>
                
                <div class="task-list" id="achievementsList" style="display: none;">
                    <!-- 成就将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 签到界面 -->
        <div class="checkin-screen" id="checkinScreen">
            <div class="checkin-header">
                <h2>每日签到</h2>
            </div>
            
            <div class="checkin-content">
                <div class="checkin-calendar" id="checkinCalendar">
                    <!-- 签到日历将通过JavaScript动态生成 -->
                </div>
                
                <button class="checkin-btn" id="checkinBtn" onclick="checkin()">签到</button>
            </div>
        </div>
        
        <!-- 排行榜界面 -->
        <div class="leaderboard-screen" id="leaderboardScreen">
            <div class="leaderboard-header">
                <h2>排行榜</h2>
            </div>
            
            <div class="leaderboard-content">
                <div class="leaderboard-tabs">
                    <div class="leaderboard-tab active" onclick="switchLeaderboardTab('monthly')">月榜</div>
                    <div class="leaderboard-tab" onclick="switchLeaderboardTab('total')">总榜</div>
                </div>
                
                <div class="leaderboard-list" id="leaderboardList">
                    <!-- 排行榜将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 提现界面 -->
        <div class="withdraw-screen" id="withdrawScreen">
            <div class="withdraw-header">
                <h2>提现</h2>
            </div>
            
            <div class="withdraw-content">
                <div class="withdraw-amount">
                    <span class="withdraw-amount-label">可提现金额</span>
                    <span class="withdraw-amount-value" id="withdrawAmount">0</span>
                </div>
                
                <form class="withdraw-form" id="withdrawForm" onsubmit="submitWithdraw(event)">
                    <div class="form-group">
                        <label for="alipayAccount">支付宝账号</label>
                        <input type="text" id="alipayAccount" required placeholder="请输入支付宝账号">
                    </div>
                    
                    <div class="form-group">
                        <label for="realName">真实姓名</label>
                        <input type="text" id="realName" required placeholder="请输入真实姓名">
                    </div>
                    
                    <button type="submit" class="withdraw-submit">提现</button>
                </form>
                
                <div class="withdraw-history">
                    <h3>提现记录</h3>
                    <div class="withdraw-history-list" id="withdrawHistoryList">
                        <!-- 提现记录将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <div class="footer">
            本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发
        </div>
    </div>
    
    <!-- 游戏结束界面 -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <div class="game-over-title" id="gameOverTitle">关卡完成</div>
            <div class="game-over-score">得分: <span id="gameOverScore">0</span></div>
            <div class="game-over-stars" id="gameOverStars">
                <div class="game-over-star"><i class="fas fa-star"></i></div>
                <div class="game-over-star"><i class="fas fa-star"></i></div>
                <div class="game-over-star"><i class="fas fa-star"></i></div>
            </div>
            <div class="game-over-reward">
                <div class="game-over-reward-label">获得奖励</div>
                <div class="game-over-reward-amount"><i class="fas fa-coins"></i> <span id="gameOverReward">0</span></div>
            </div>
            <div class="game-over-buttons">
                <button class="game-over-btn-secondary" onclick="backToMain()">返回地图</button>
                <button class="game-over-btn-primary" onclick="nextLevel()">下一关</button>
            </div>
        </div>
    </div>
    
    <!-- 游戏次数提示 -->
    <div class="play-limit" id="playLimit">
        <div class="play-limit-content">
            <div class="play-limit-title">游戏次数已用完</div>
            <div class="play-limit-message">
                今日免费游戏次数已用完，可以通过以下方式获取额外游戏次数：
            </div>
            <div class="play-limit-options">
                <button class="play-limit-btn-primary" onclick="shareToTelegram()">分享到Telegram群组 (+2次)</button>
                <button class="play-limit-btn-secondary" onclick="watchAd()">观看广告 (+1次)</button>
            </div>
        </div>
    </div>
    
    <!-- 加载动画 -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
    </div>
    
    <script>
        // 全局变量
        const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev';
        const BOT_USERNAME = 'bjxcwhljiluBot';
        let currentUser = null;
        let currentLevel = null;
        let gameBoard = [];
        let selectedTile = null;
        let movesLeft = 0;
        let currentScore = 0;
        let gameActive = false;
        let playCount = 0;
        const MAX_PLAYS_PER_DAY = 7;
        
        // 统一错误处理函数
        function handleError(error, message = '操作失败，请稍后重试') {
            console.error(error);
            alert(message);
        }
        
        // 数据验证函数
        function validateFormData(data) {
            const errors = [];
            
            // 验证支付宝账号
            if (data.alipayAccount) {
                const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                const phoneRegex = /^1[3-9]\d{9}$/;
                
                if (!emailRegex.test(data.alipayAccount) && !phoneRegex.test(data.alipayAccount)) {
                    errors.push('支付宝账号格式不正确，请输入邮箱或手机号码');
                }
            }
            
            // 验证真实姓名
            if (data.realName && !/^[\u4e00-\u9fa5a-zA-Z]{2,20}$/.test(data.realName)) {
                errors.push('真实姓名只能包含中文或英文，长度2-20个字符');
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        // 游戏元素类型
        const TILE_TYPES = [
            { type: 'red', icon: '🍎' },
            { type: 'blue', icon: '🍇' },
            { type: 'green', icon: '🍊' },
            { type: 'yellow', icon: '🍋' },
            { type: 'purple', icon: '🍒' }
        ];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否通过Telegram进入
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            
            if (!userId) {
                // 显示入口页面
                document.getElementById('entryScreen').style.display = 'flex';
            } else {
                // 直接进入游戏
                initGame(userId);
            }
        });
        
        // 打开Telegram机器人
        function openTelegramBot() {
            // 检查是否在Telegram应用内
            if (window.Telegram && window.Telegram.WebApp) {
                // 在Telegram应用内，可以直接打开机器人
                window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
            } else {
                // 不在Telegram应用内，尝试打开Telegram应用
                const telegramUrl = `tg://resolve?domain=${BOT_USERNAME}`;
                
                // 尝试打开Telegram应用
                window.open(telegramUrl, '_blank');
                
                // 如果无法打开，则打开网页版
                setTimeout(() => {
                    window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
                }, 500);
            }
        }
        
        // 初始化游戏
        async function initGame(userId) {
            try {
                showLoader();
                
                // 隐藏入口页面
                document.getElementById('entryScreen').style.display = 'none';
                
                // 获取用户信息
                await loadUserInfo(userId);
                
                // 加载关卡
                await loadLevels();
                
                // 加载每日任务
                await loadDailyTasks();
                
                // 加载成就
                await loadAchievements();
                
                // 初始化签到日历
                initCheckinCalendar();
                
                // 显示主界面
                showScreen('mainScreen');
            } catch (error) {
                console.error('Error initializing game:', error);
                alert('初始化游戏失败，请重试');
            } finally {
                hideLoader();
            }
        }
        
        // 显示加载动画
        function showLoader() {
            document.getElementById('loader').style.display = 'flex';
        }
        
        // 隐藏加载动画
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }
        
        // 显示界面
        function showScreen(screenId) {
            // 隐藏所有界面
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('tasksScreen').style.display = 'none';
            document.getElementById('checkinScreen').style.display = 'none';
            document.getElementById('leaderboardScreen').style.display = 'none';
            document.getElementById('withdrawScreen').style.display = 'none';
            
            // 显示指定界面
            document.getElementById(screenId).style.display = 'flex';
            
            // 如果是排行榜界面，加载数据
            if (screenId === 'leaderboardScreen') {
                loadLeaderboard();
            }
            
            // 如果是提现界面，更新可提现金额
            if (screenId === 'withdrawScreen') {
                updateWithdrawAmount();
                loadWithdrawHistory();
            }
        }
        
        // 加载用户信息
        async function loadUserInfo(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/info?user_id=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    const usernameEl = document.getElementById('username');
                    const userCoinsEl = document.getElementById('userCoins');
                    
                    if (usernameEl) usernameEl.textContent = currentUser.first_name || '玩家';
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // 检查今日游戏次数
                    const today = new Date().toDateString();
                    const lastPlayDate = new Date(currentUser.last_play_date).toDateString();
                    
                    if (today === lastPlayDate) {
                        playCount = currentUser.play_count;
                    } else {
                        playCount = 0;
                    }
                } else {
                    handleError(data.error || '获取用户信息失败', '加载用户信息失败');
                    throw new Error(data.error || '获取用户信息失败');
                }
            } catch (error) {
                handleError(error, '加载用户信息失败');
                throw error;
            }
        }
        
        // 加载关卡
        async function loadLevels() {
            try {
                if (!currentUser || !currentUser.telegram_id) {
                    handleError('用户信息不完整', '加载关卡失败');
                    throw new Error('用户信息不完整');
                }
                
                const response = await fetch(`${API_BASE_URL}/api/user/levels?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const levelsList = document.getElementById('levelsList');
                    if (!levelsList) return;
                    
                    levelsList.innerHTML = '';
                    
                    // 生成10个关卡
                    for (let i = 1; i <= 10; i++) {
                        const userLevel = data.find(ul => ul.level_id === i);
                        const level = document.createElement('div');
                        level.className = 'level';
                        level.textContent = i;
                        
                        if (userLevel) {
                            if (userLevel.completed) {
                                level.classList.add('completed');
                                
                                // 添加星星
                                const stars = document.createElement('div');
                                stars.className = 'level-stars';
                                for (let j = 0; j < userLevel.stars; j++) {
                                    stars.innerHTML += '<i class="fas fa-star"></i>';
                                }
                                level.appendChild(stars);
                            } else {
                                level.classList.add('unlocked');
                            }
                        } else if (i === 1 || (data[i-2] && data[i-2].completed)) {
                            level.classList.add('unlocked');
                        }
                        
                        level.onclick = () => startLevel(i);
                        levelsList.appendChild(level);
                    }
                } else {
                    handleError('加载关卡失败', '加载关卡失败');
                    throw new Error('加载关卡失败');
                }
            } catch (error) {
                handleError(error, '加载关卡失败');
                throw error;
            }
        }
        
        // 开始关卡
        async function startLevel(levelId) {
            // 检查游戏次数
            if (playCount >= MAX_PLAYS_PER_DAY) {
                document.getElementById('playLimit').style.display = 'flex';
                return;
            }
            
            // 获取关卡信息
            let level;
            if (levelId <= 5) {
                level = {
                    id: levelId,
                    name: `第${levelId}关`,
                    difficulty: 1,
                    target_score: 1000 * levelId,
                    target_moves: 20 + (levelId - 1) * 5
                };
            } else {
                level = {
                    id: levelId,
                    name: `第${levelId}关`,
                    difficulty: 2,
                    target_score: 4000 + (levelId - 6) * 1000,
                    target_moves: 30 + (levelId - 6) * 5
                };
            }
            
            currentLevel = level;
            movesLeft = level.target_moves;
            currentScore = 0;
            
            // 更新游戏界面
            document.getElementById('levelName').textContent = level.name;
            document.getElementById('levelTarget').textContent = level.target_score;
            document.getElementById('movesLeft').textContent = movesLeft;
            document.getElementById('currentScore').textContent = currentScore;
            
            // 初始化游戏棋盘
            initGameBoard();
            
            // 显示游戏界面
            showScreen('gameScreen');
            
            // 激活游戏
            gameActive = true;
        }
        
        // 初始化游戏棋盘
        function initGameBoard() {
            const boardElement = document.getElementById('gameBoard');
            boardElement.innerHTML = '';
            gameBoard = [];
            
            // 创建8x8的棋盘
            for (let row = 0; row < 8; row++) {
                gameBoard[row] = [];
                for (let col = 0; col < 8; col++) {
                    // 随机选择一个元素类型
                    const tileType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)];
                    
                    // 创建棋盘元素
                    const tile = document.createElement('div');
                    tile.className = `tile ${tileType.type}`;
                    tile.textContent = tileType.icon;
                    tile.dataset.row = row;
                    tile.dataset.col = col;
                    tile.dataset.type = tileType.type;
                    
                    // 添加点击事件
                    tile.addEventListener('click', () => {
                        if (gameActive && typeof selectTile === 'function' && row !== undefined && col !== undefined) {
                            selectTile(row, col);
                        }
                    });
                    
                    boardElement.appendChild(tile);
                    gameBoard[row][col] = {
                        type: tileType.type,
                        element: tile
                    };
                }
            }
            
            // 确保初始棋盘没有匹配
            while (hasMatches()) {
                shuffleBoard();
            }
        }
        
        // 选择棋盘元素
        function selectTile(row, col) {
            if (!gameActive) return;
            
            const tile = gameBoard[row][col].element;
            
            if (selectedTile === null) {
                // 选择第一个元素
                selectedTile = { row, col };
                tile.classList.add('selected');
            } else {
                // 选择第二个元素
                const prevTile = gameBoard[selectedTile.row][selectedTile.col].element;
                prevTile.classList.remove('selected');
                
                // 检查是否相邻
                if (isAdjacent(selectedTile.row, selectedTile.col, row, col)) {
                    // 交换元素
                    swapTiles(selectedTile.row, selectedTile.col, row, col);
                    
                    // 检查匹配
                    setTimeout(() => {
                        if (!checkMatches()) {
                            // 如果没有匹配，交换回来
                            swapTiles(selectedTile.row, selectedTile.col, row, col);
                        }
                    }, 300);
                }
                
                selectedTile = null;
            }
        }
        
        // 检查两个元素是否相邻
        function isAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            
            return (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
        }
        
        // 交换两个元素
        function swapTiles(row1, col1, row2, col2) {
            // 交换数据
            const temp = gameBoard[row1][col1];
            gameBoard[row1][col1] = gameBoard[row2][col2];
            gameBoard[row2][col2] = temp;
            
            // 更新DOM
            const tile1 = gameBoard[row1][col1].element;
            const tile2 = gameBoard[row2][col2].element;
            
            tile1.dataset.row = row1;
            tile1.dataset.col = col1;
            
            tile2.dataset.row = row2;
            tile2.dataset.col = col2;
            
            // 更新样式
            updateTileDisplay(row1, col1);
            updateTileDisplay(row2, col2);
        }
        
        // 更新元素显示
        function updateTileDisplay(row, col) {
            const tile = gameBoard[row][col];
            const tileType = TILE_TYPES.find(t => t.type === tile.type);
            
            tile.element.className = `tile ${tile.type}`;
            tile.element.textContent = tileType.icon;
            tile.element.dataset.type = tile.type;
        }
        
        // 检查是否有匹配
        function hasMatches() {
            // 检查水平匹配
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 6; col++) {
                    if (gameBoard[row][col].type === gameBoard[row][col + 1].type &&
                        gameBoard[row][col].type === gameBoard[row][col + 2].type) {
                        return true;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 8; col++) {
                    if (gameBoard[row][col].type === gameBoard[row + 1][col].type &&
                        gameBoard[row][col].type === gameBoard[row + 2][col].type) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // 检查并处理匹配
        function checkMatches() {
            const matches = [];
            
            // 检查水平匹配
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 6; col++) {
                    if (gameBoard[row][col].type === gameBoard[row][col + 1].type &&
                        gameBoard[row][col].type === gameBoard[row][col + 2].type) {
                        
                        // 检查是否有4个或更多匹配
                        let matchLength = 3;
                        while (col + matchLength < 8 && gameBoard[row][col].type === gameBoard[row][col + matchLength].type) {
                            matchLength++;
                        }
                        
                        // 添加匹配
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row, col: col + i });
                        }
                        
                        col += matchLength - 1;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 8; col++) {
                    if (gameBoard[row][col].type === gameBoard[row + 1][col].type &&
                        gameBoard[row][col].type === gameBoard[row + 2][col].type) {
                        
                        // 检查是否有4个或更多匹配
                        let matchLength = 3;
                        while (row + matchLength < 8 && gameBoard[row][col].type === gameBoard[row + matchLength][col].type) {
                            matchLength++;
                        }
                        
                        // 添加匹配
                        for (let i = 0; i < matchLength; i++) {
                            matches.push({ row: row + i, col });
                        }
                        
                        row += matchLength - 1;
                    }
                }
            }
            
            // 如果有匹配，处理它们
            if (matches.length > 0) {
                processMatches(matches);
                return true;
            }
            
            return false;
        }
        
        // 处理匹配
        function processMatches(matches) {
            // 标记匹配的元素
            const matchedTiles = new Set();
            matches.forEach(match => {
                const key = `${match.row},${match.col}`;
                matchedTiles.add(key);
            });
            
            // 计算分数
            const scoreGain = matches.length * 10;
            currentScore += scoreGain;
            const currentScoreEl = document.getElementById('currentScore');
            if (currentScoreEl) currentScoreEl.textContent = currentScore;
            
            // 移除匹配的元素
            matchedTiles.forEach(key => {
                const [row, col] = key.split(',').map(Number);
                gameBoard[row][col].element.style.opacity = '0.5';
            });
            
            // 使用setTimeout链替代嵌套setTimeout，提高性能
            setTimeout(processMatchesStep1, 300);
        }
        
        function processMatchesStep1() {
            dropTiles();
            setTimeout(processMatchesStep2, 300);
        }
        
        function processMatchesStep2() {
            fillBoard();
            setTimeout(processMatchesStep3, 300);
        }
        
        function processMatchesStep3() {
            if (!checkMatches()) {
                // 没有更多匹配，减少步数
                movesLeft--;
                const movesLeftEl = document.getElementById('movesLeft');
                if (movesLeftEl) movesLeftEl.textContent = movesLeft;
                
                // 检查游戏是否结束
                if (movesLeft <= 0 || currentScore >= currentLevel.target_score) {
                    endGame();
                }
            }
        }
        
        // 下落元素
        function dropTiles() {
            for (let col = 0; col < 8; col++) {
                let emptySpaces = 0;
                
                // 从底部向上扫描
                for (let row = 7; row >= 0; row--) {
                    if (gameBoard[row][col].element.style.opacity === '0.5') {
                        // 标记为空
                        emptySpaces++;
                    } else if (emptySpaces > 0) {
                        // 下落元素
                        gameBoard[row + emptySpaces][col] = gameBoard[row][col];
                        gameBoard[row][col] = { type: null, element: gameBoard[row][col].element };
                        
                        // 更新DOM
                        gameBoard[row + emptySpaces][col].element.dataset.row = row + emptySpaces;
                        updateTileDisplay(row + emptySpaces, col);
                        
                        // 重置原位置
                        gameBoard[row][col].element.style.opacity = '1';
                    }
                }
            }
        }
        
        // 填充棋盘
        function fillBoard() {
            for (let col = 0; col < 8; col++) {
                for (let row = 0; row < 8; row++) {
                    if (!gameBoard[row][col].type) {
                        // 随机选择一个元素类型
                        const tileType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)];
                        
                        // 更新数据
                        gameBoard[row][col].type = tileType.type;
                        
                        // 更新DOM
                        updateTileDisplay(row, col);
                    }
                }
            }
        }
        
        // 洗牌
        function shuffleBoard() {
            // 收集所有元素类型
            const types = [];
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    types.push(gameBoard[row][col].type);
                }
            }
            
            // 随机排序
            for (let i = types.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [types[i], types[j]] = [types[j], types[i]];
            }
            
            // 重新分配类型
            let index = 0;
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    gameBoard[row][col].type = types[index++];
                    updateTileDisplay(row, col);
                }
            }
        }
        
        // 使用道具
        function useItem(itemType) {
            if (!gameActive) return;
            
            switch (itemType) {
                case 'refresh':
                    shuffleBoard();
                    break;
                case 'bomb':
                    // 随机消除3x3区域
                    const centerRow = Math.floor(Math.random() * 6) + 1;
                    const centerCol = Math.floor(Math.random() * 6) + 1;
                    
                    const matches = [];
                    for (let row = centerRow - 1; row <= centerRow + 1; row++) {
                        for (let col = centerCol - 1; col <= centerCol + 1; col++) {
                            matches.push({ row, col });
                        }
                    }
                    
                    processMatches(matches);
                    break;
                case 'rocket':
                    // 随机消除一行或一列
                    const isRow = Math.random() > 0.5;
                    const index = Math.floor(Math.random() * 8);
                    
                    const rocketMatches = [];
                    if (isRow) {
                        for (let col = 0; col < 8; col++) {
                            rocketMatches.push({ row: index, col });
                        }
                    } else {
                        for (let row = 0; row < 8; row++) {
                            rocketMatches.push({ row, col: index });
                        }
                    }
                    
                    processMatches(rocketMatches);
                    break;
                case 'rainbow':
                    // 随机选择一种类型并消除所有该类型的元素
                    const targetType = TILE_TYPES[Math.floor(Math.random() * TILE_TYPES.length)].type;
                    
                    const rainbowMatches = [];
                    for (let row = 0; row < 8; row++) {
                        for (let col = 0; col < 8; col++) {
                            if (gameBoard[row][col].type === targetType) {
                                rainbowMatches.push({ row, col });
                            }
                        }
                    }
                    
                    processMatches(rainbowMatches);
                    break;
            }
        }
        
        // 结束游戏
        async function endGame() {
            gameActive = false;
            
            // 计算星星数量
            let stars = 0;
            const scorePercentage = currentScore / currentLevel.target_score;
            
            if (scorePercentage >= 1) {
                stars = 3;
            } else if (scorePercentage >= 0.7) {
                stars = 2;
            } else if (scorePercentage >= 0.4) {
                stars = 1;
            }
            
            // 计算奖励
            const isCompleted = currentScore >= currentLevel.target_score;
            let reward = 0;
            
            if (isCompleted) {
                if (currentLevel.difficulty === 1) {
                    reward = 10 + (stars - 1) * 5;
                } else {
                    reward = 25 + (stars - 1) * 5;
                }
            }
            
            // 更新游戏结束界面
            const gameOverTitleEl = document.getElementById('gameOverTitle');
            const gameOverScoreEl = document.getElementById('gameOverScore');
            const gameOverRewardEl = document.getElementById('gameOverReward');
            const gameOverEl = document.getElementById('gameOver');
            
            if (gameOverTitleEl) gameOverTitleEl.textContent = isCompleted ? '关卡完成' : '游戏结束';
            if (gameOverScoreEl) gameOverScoreEl.textContent = currentScore;
            
            // 更新星星
            const starElements = document.querySelectorAll('.game-over-star');
            if (starElements.length > 0) {
                starElements.forEach((star, index) => {
                    if (index < stars) {
                        star.classList.add('filled');
                    } else {
                        star.classList.remove('filled');
                    }
                });
            }
            
            if (gameOverRewardEl) gameOverRewardEl.textContent = reward;
            if (gameOverEl) gameOverEl.style.display = 'flex';
            
            // 保存游戏结果
            if (isCompleted) {
                try {
                    if (!currentUser || !currentUser.telegram_id) {
                        throw new Error('用户信息不完整');
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/api/game/session`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: currentUser.telegram_id,
                            levelId: currentLevel.id,
                            score: currentScore,
                            moves: currentLevel.target_moves - movesLeft,
                            stars: stars,
                            completed: true
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // 更新用户万花币
                        currentUser.flower_coins += data.reward;
                        const userCoinsEl = document.getElementById('userCoins');
                        if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                        
                        // 更新关卡任务进度
                        if (typeof updateDailyTaskProgress === 'function') {
                            updateDailyTaskProgress('level', 1);
                            
                            // 更新分数任务进度
                            updateDailyTaskProgress('score', currentScore);
                        }
                        
                        // 更新成就进度
                        if (typeof updateAchievementProgress === 'function') {
                            updateAchievementProgress('levels_completed', currentLevel.id);
                            updateAchievementProgress('single_score', currentScore);
                        }
                    } else {
                        handleError('Failed to save game session: ' + data.error, '保存游戏记录失败');
                    }
                } catch (error) {
                    handleError(error, '保存游戏记录失败');
                }
            }
            
            // 增加游戏次数并确保不会为负
            playCount = Math.max(0, playCount + 1);
        }
        
        // 返回主界面
        function backToMain() {
            document.getElementById('gameOver').style.display = 'none';
            showScreen('mainScreen');
        }
        
        // 下一关
        function nextLevel() {
            document.getElementById('gameOver').style.display = 'none';
            
            if (currentLevel.id < 10) {
                startLevel(currentLevel.id + 1);
            } else {
                showScreen('mainScreen');
            }
        }
        
        // 加载每日任务
        async function loadDailyTasks() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const tasksList = document.getElementById('dailyTasksList');
                    if (!tasksList) return;
                    
                    tasksList.innerHTML = '';
                    
                    // 创建文档片段以减少DOM操作
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach(task => {
                        const taskItem = document.createElement('div');
                        taskItem.className = 'task-item';
                        
                        const progressPercentage = Math.min(100, (task.progress / task.target_value) * 100);
                        
                        taskItem.innerHTML = `
                            <div class="task-info">
                                <h4>${task.name}</h4>
                                <p>${task.description}</p>
                                <div class="task-progress">
                                    <div class="task-progress-bar" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                            <div class="task-reward">
                                <div class="task-reward-amount"><i class="fas fa-coins"></i> ${task.reward}</div>
                                <button class="task-claim-btn" onclick="claimDailyTaskReward(${task.id})" ${!task.completed || task.rewarded ? 'disabled' : ''}>
                                    ${task.rewarded ? '已领取' : (task.completed ? '领取' : '未完成')}
                                </button>
                            </div>
                        `;
                        
                        fragment.appendChild(taskItem);
                    });
                    
                    // 一次性添加所有元素
                    tasksList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, '加载每日任务失败');
            }
        }
        
        // 领取每日任务奖励
        async function claimDailyTaskReward(taskId) {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        taskId: taskId,
                        action: 'claim'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户万花币
                    currentUser.flower_coins += data.reward;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // 重新加载任务
                    await loadDailyTasks();
                    
                    // 显示成功消息
                    alert(`成功领取 ${data.reward} 万花币！`);
                } else {
                    handleError(data.error || '领取奖励失败', '领取奖励失败');
                }
            } catch (error) {
                handleError(error, '领取奖励失败');
            } finally {
                hideLoader();
            }
        }
        
        // 更新每日任务进度
        async function updateDailyTaskProgress(taskType, progress) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/daily/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        taskType: taskType,
                        progress: progress
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.taskCompleted) {
                    // 任务完成，重新加载任务列表
                    await loadDailyTasks();
                }
            } catch (error) {
                console.error('Error updating daily task progress:', error);
            }
        }
        
        // 加载成就
        async function loadAchievements() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/achievements?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const achievementsList = document.getElementById('achievementsList');
                    if (!achievementsList) return;
                    
                    achievementsList.innerHTML = '';
                    
                    // 创建文档片段以减少DOM操作
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach(achievement => {
                        const achievementItem = document.createElement('div');
                        achievementItem.className = 'task-item';
                        
                        const progressPercentage = Math.min(100, (achievement.progress / achievement.target_value) * 100);
                        
                        achievementItem.innerHTML = `
                            <div class="task-info">
                                <h4>${achievement.name}</h4>
                                <p>${achievement.description}</p>
                                <div class="task-progress">
                                    <div class="task-progress-bar" style="width: ${progressPercentage}%"></div>
                                </div>
                            </div>
                            <div class="task-reward">
                                <div class="task-reward-amount"><i class="fas fa-coins"></i> ${achievement.reward}</div>
                                <button class="task-claim-btn" onclick="claimAchievementReward(${achievement.id})" ${!achievement.completed || achievement.rewarded ? 'disabled' : ''}>
                                    ${achievement.rewarded ? '已领取' : (achievement.completed ? '领取' : '未完成')}
                                </button>
                            </div>
                        `;
                        
                        fragment.appendChild(achievementItem);
                    });
                    
                    // 一次性添加所有元素
                    achievementsList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, '加载成就失败');
            }
        }
        
        // 领取成就奖励
        async function claimAchievementReward(achievementId) {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/achievements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        achievementId: achievementId,
                        action: 'claim'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户万花币
                    currentUser.flower_coins += data.reward;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // 重新加载成就
                    await loadAchievements();
                    
                    // 显示成功消息
                    alert(`成功领取成就奖励 ${data.reward} 万花币！`);
                } else {
                    handleError(data.error || '领取成就奖励失败', '领取成就奖励失败');
                }
            } catch (error) {
                handleError(error, '领取成就奖励失败');
            } finally {
                hideLoader();
            }
        }
        
        // 更新成就进度
        async function updateAchievementProgress(achievementType, progress) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/achievements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        achievementType: achievementType,
                        progress: progress
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.achievementCompleted) {
                    // 成就完成，重新加载成就列表
                    await loadAchievements();
                }
            } catch (error) {
                console.error('Error updating achievement progress:', error);
            }
        }
        
        // 初始化签到日历
        function initCheckinCalendar() {
            const calendar = document.getElementById('checkinCalendar');
            calendar.innerHTML = '';
            
            // 获取当前日期
            const now = new Date();
            const currentDay = now.getDate();
            
            // 生成7天的签到日历
            for (let i = 1; i <= 7; i++) {
                const day = document.createElement('div');
                day.className = 'checkin-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'checkin-day-number';
                dayNumber.textContent = i;
                
                const dayReward = document.createElement('div');
                dayReward.className = 'checkin-day-reward';
                dayReward.textContent = Math.min(10 + (i - 1) * 5, 70);
                
                day.appendChild(dayNumber);
                day.appendChild(dayReward);
                
                if (i === currentDay) {
                    day.classList.add('today');
                }
                
                calendar.appendChild(day);
            }
        }
        
        // 签到
        async function checkin() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户万花币
                    currentUser.flower_coins += data.reward;
                    document.getElementById('userCoins').textContent = currentUser.flower_coins;
                    
                    // 更新签到按钮
                    const checkinBtn = document.getElementById('checkinBtn');
                    checkinBtn.textContent = '已签到';
                    checkinBtn.disabled = true;
                    
                    // 显示成功消息
                    alert(`签到成功！获得 ${data.reward} 万花币，连续签到 ${data.consecutiveDays} 天`);
                } else {
                    alert('签到失败: ' + data.error);
                }
            } catch (error) {
                console.error('Error checking in:', error);
                alert('签到失败');
            } finally {
                hideLoader();
            }
        }
        
        // 加载排行榜
        async function loadLeaderboard() {
            try {
                showLoader();
                const response = await fetch(`${API_BASE_URL}/api/leaderboard?user_id=${currentUser.telegram_id}`);
                const data = await response.json();
                
                if (data && Array.isArray(data)) {
                    const leaderboardList = document.getElementById('leaderboardList');
                    if (!leaderboardList) return;
                    
                    leaderboardList.innerHTML = '';
                    
                    // 创建文档片段以减少DOM操作
                    const fragment = document.createDocumentFragment();
                    
                    data.forEach((player, index) => {
                        const playerItem = document.createElement('div');
                        playerItem.className = 'leaderboard-item';
                        
                        let rankClass = '';
                        if (index === 0) rankClass = 'top1';
                        else if (index === 1) rankClass = 'top2';
                        else if (index === 2) rankClass = 'top3';
                        
                        playerItem.innerHTML = `
                            <div class="leaderboard-rank ${rankClass}">${index + 1}</div>
                            <div class="leaderboard-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${player.users?.first_name || '玩家'}</div>
                                <div class="leaderboard-coins">
                                    <i class="fas fa-coins"></i> ${player.flower_coins}
                                </div>
                            </div>
                        `;
                        
                        fragment.appendChild(playerItem);
                    });
                    
                    // 一次性添加所有元素
                    leaderboardList.appendChild(fragment);
                }
            } catch (error) {
                handleError(error, '加载排行榜失败');
            } finally {
                hideLoader();
            }
        }
        
        // 更新提现金额
        function updateWithdrawAmount() {
            const withdrawAmount = Math.floor(currentUser.flower_coins / 1000) * 10;
            document.getElementById('withdrawAmount').textContent = `${withdrawAmount}元`;
        }
        
        // 提交提现
        async function submitWithdraw(event) {
            event.preventDefault();
            
            const alipayAccountInput = document.getElementById('alipayAccount');
            const realNameInput = document.getElementById('realName');
            const withdrawForm = document.getElementById('withdrawForm');
            
            if (!alipayAccountInput || !realNameInput) {
                handleError('表单元素不存在', '提现有误');
                return;
            }
            
            const alipayAccount = alipayAccountInput.value.trim();
            const realName = realNameInput.value.trim();
            
            // 计算提现金额（1000万花币 = 10元）
            const amount = Math.floor(currentUser.flower_coins / 1000) * 1000;
            
            if (amount < 1000) {
                handleError('提现金额不足，至少需要1000万花币', '提现金额不足');
                return;
            }
            
            // 验证表单数据
            const validation = validateFormData({ alipayAccount, realName });
            if (!validation.isValid) {
                alert(validation.errors.join('\n'));
                return;
            }
            
            try {
                showLoader();
                
                if (!currentUser || !currentUser.telegram_id) {
                    throw new Error('用户信息不完整');
                }
                
                const response = await fetch(`${API_BASE_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.telegram_id,
                        amount: amount,
                        alipayAccount: alipayAccount,
                        realName: realName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 更新用户万花币
                    currentUser.flower_coins -= amount;
                    const userCoinsEl = document.getElementById('userCoins');
                    if (userCoinsEl) userCoinsEl.textContent = currentUser.flower_coins;
                    
                    // 更新提现金额
                    if (typeof updateWithdrawAmount === 'function') {
                        updateWithdrawAmount();
                    }
                    
                    // 重新加载提现记录
                    if (typeof loadWithdrawHistory === 'function') {
                        await loadWithdrawHistory();
                    }
                    
                    // 显示成功消息
                    alert('提现申请已提交，请等待审核');
                    
                    // 重置表单
                    if (withdrawForm) {
                        withdrawForm.reset();
                    }
                } else {
                    handleError(data.error || '提现失败', '提现有误');
                }
            } catch (error) {
                handleError(error, '提现有误');
            } finally {
                hideLoader();
            }
        }
        
        // 加载提现记录
        async function loadWithdrawHistory() {
            try {
                const withdrawHistoryList = document.getElementById('withdrawHistoryList');
                if (!withdrawHistoryList) return;
                
                // 这里应该有一个获取提现记录的API
                // 由于没有实现，暂时显示模拟数据
                
                // 模拟数据
                const mockWithdrawals = [
                    { date: '2023-07-15', amount: 50, status: '已完成' },
                    { date: '2023-07-01', amount: 30, status: '已完成' }
                ];
                
                if (mockWithdrawals.length === 0) {
                    withdrawHistoryList.innerHTML = '<div style="text-align: center; color: #666;">暂无提现记录</div>';
                    return;
                }
                
                withdrawHistoryList.innerHTML = '';
                
                mockWithdrawals.forEach(withdrawal => {
                    const item = document.createElement('div');
                    item.className = 'withdraw-history-item';
                    item.innerHTML = `
                        <div class="withdraw-history-date">${withdrawal.date}</div>
                        <div class="withdraw-history-amount">${withdrawal.amount}元</div>
                        <div class="withdraw-history-status ${withdrawal.status === '已完成' ? 'completed' : 'pending'}">
                            ${withdrawal.status}
                        </div>
                    `;
                    withdrawHistoryList.appendChild(item);
                });
            } catch (error) {
                handleError(error, '加载提现记录失败');
            }
        }
        
        // 分享到Telegram
        function shareToTelegram() {
            const text = `我在玩万花楼消消乐，快来一起玩吧！\nhttps://beijingshunyi.github.io/game-web/?user_id=${currentUser.telegram_id}`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(text)}`;
            
            window.open(url, '_blank');
            
            // 假设分享成功，增加游戏次数
            playCount = Math.max(0, playCount - 2);
            document.getElementById('playLimit').style.display = 'none';
            
            alert('分享成功，获得2次游戏机会！');
        }
        
        // 观看广告
        function watchAd() {
            // 这里应该有观看广告的逻辑
            // 由于没有实现，模拟广告观看流程
            try {
                const adContainer = document.createElement('div');
                adContainer.className = 'ad-container';
                adContainer.innerHTML = `
                    <div class="ad-content">
                        <div class="ad-title">广告观看</div>
                        <div class="ad-message">正在播放广告...</div>
                        <div class="ad-countdown">10秒后关闭</div>
                        <button class="ad-close-btn" disabled>关闭</button>
                    </div>
                `;
                
                document.body.appendChild(adContainer);
                
                // 模拟广告倒计时
                let countdown = 10;
                const countdownEl = adContainer.querySelector('.ad-countdown');
                const closeBtn = adContainer.querySelector('.ad-close-btn');
                
                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = `${countdown}秒后关闭`;
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                        closeBtn.disabled = false;
                        closeBtn.textContent = '关闭';
                    }
                }, 1000);
                
                closeBtn.addEventListener('click', () => {
                    clearInterval(timer);
                    document.body.removeChild(adContainer);
                    
                    // 增加游戏次数
                    playCount = Math.max(0, playCount - 1);
                    const playLimitEl = document.getElementById('playLimit');
                    if (playLimitEl) playLimitEl.style.display = 'none';
                    
                    alert('广告观看完成，获得1次游戏机会');
                });
            } catch (error) {
                handleError(error, '广告观看失败');
            }
        }
        
        // 切换任务标签
        function switchTaskTab(tab) {
            const tabs = document.querySelectorAll('.task-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            
            if (tab === 'daily') {
                document.getElementById('dailyTasksList').style.display = 'flex';
                document.getElementById('achievementsList').style.display = 'none';
            } else {
                document.getElementById('dailyTasksList').style.display = 'none';
                document.getElementById('achievementsList').style.display = 'flex';
            }
        }
        
        // 切换排行榜标签
        function switchLeaderboardTab(tab) {
            const tabs = document.querySelectorAll('.leaderboard-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            
            // 重新加载排行榜
            loadLeaderboard();
        }
    </script>
</body>
</html>
