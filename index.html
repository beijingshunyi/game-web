<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>万花消消乐</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }
        /* 首页样式 */
        .home-page {
            padding: 20px 15px;
            text-align: center;
        }
        .game-logo {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 15px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(106, 17, 203, 0.3);
        }
        .player-info {
            display: flex;
            justify-content: space-around;
            background: rgba(106, 17, 203, 0.1);
            padding: 12px;
            border-radius: 15px;
            margin: 15px 0;
        }
        .info-item {
            text-align: center;
        }
        .info-value {
            font-size: 20px;
            font-weight: 700;
            color: #6a11cb;
        }
        .info-label {
            font-size: 12px;
            color: #666;
        }
        .start-button {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 30px;
            margin: 15px 0;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
            transition: all 0.3s ease;
            width: 80%;
            max-width: 300px;
        }
        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 17, 203, 0.6);
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        .feature-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 20px 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(106, 17, 203, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(106, 17, 203, 0.25);
            background: linear-gradient(135deg, #ffffff 0%, #f0f2ff 100%);
        }
        .feature-card.ranking {
            background: linear-gradient(135deg, #fff9c4 0%, #ffd54f 100%);
        }
        .feature-card.ranking::before {
            background: linear-gradient(to right, #fbc02d, #ff8f00);
        }
        .feature-card.achievements {
            background: linear-gradient(135deg, #c8e6c9 0%, #81c784 100%);
        }
        .feature-card.achievements::before {
            background: linear-gradient(to right, #388e3c, #1b5e20);
        }
        .feature-card.shop {
            background: linear-gradient(135deg, #bbdefb 0%, #64b5f6 100%);
        }
        .feature-card.shop::before {
            background: linear-gradient(to right, #1976d2, #0d47a1);
        }
        .feature-card.checkin {
            background: linear-gradient(135deg, #ffcdd2 0%, #e57373 100%);
        }
        .feature-card.checkin::before {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
        }
        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
            text-align: center;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feature-card.ranking .feature-icon {
            background: linear-gradient(to right, #fbc02d, #ff8f00);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feature-card.achievements .feature-icon {
            background: linear-gradient(to right, #388e3c, #1b5e20);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feature-card.shop .feature-icon {
            background: linear-gradient(to right, #1976d2, #0d47a1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feature-card.checkin .feature-icon {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feature-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 16px;
            color: #333;
            text-align: center;
        }
        .feature-desc {
            font-size: 12px;
            color: #6a11cb;
            text-align: center;
            font-weight: 500;
        }
        .feature-card.ranking .feature-desc {
            color: #f57f17;
        }
        .feature-card.achievements .feature-desc {
            color: #1b5e20;
        }
        .feature-card.shop .feature-desc {
            color: #0d47a1;
        }
        .feature-card.checkin .feature-desc {
            color: #b71c1c;
        }
        /* 底部信息 */
        .footer-info {
            text-align: center;
            padding: 15px 10px;
            font-size: 11px;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        .footer-info a {
            color: #6a11cb;
            text-decoration: none;
        }
        .footer-info a:hover {
            text-decoration: underline;
        }
        /* 首页欢迎区域 */
        .welcome-section {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: white;
            padding: 20px 15px;
            border-radius: 15px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        .welcome-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .welcome-subtitle {
            font-size: 14px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        .decoration {
            position: absolute;
            font-size: 20px;
            opacity: 0.2;
        }
        .dec-1 { top: 8px; left: 8px; }
        .dec-2 { top: 8px; right: 8px; }
        .dec-3 { bottom: 8px; left: 8px; }
        .dec-4 { bottom: 8px; right: 8px; }
        .game-stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 15px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }
        .stat-label {
            font-size: 11px;
            opacity: 0.8;
        }
        /* 用户个人信息样式 */
        .user-profile {
            display: flex;
            align-items: center;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6a11cb;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-right: 15px;
            font-size: 14px;
        }
        .user-details {
            flex: 1;
        }
        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .user-id {
            font-size: 12px;
            opacity: 0.9;
        }
        .user-coins {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        .coin-icon {
            margin-right: 5px;
            font-size: 18px;
        }
        .coin-amount {
            font-size: 18px;
        }
        /* 游戏页面样式 */
        .game-page {
            display: none;
        }
        /* 顶部导航栏 */
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #6a11cb;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 14px;
        }
        .coins {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
        }
        .coin-icon {
            color: gold;
            font-size: 16px;
        }
        .coin-count {
            font-weight: 600;
            font-size: 14px;
        }
        .nav-buttons {
            display: flex;
            gap: 8px;
        }
        .nav-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            color: #6a11cb;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            font-size: 16px;
            font-weight: bold;
        }
        .nav-button:hover {
            background: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .nav-button .button-label {
            position: absolute;
            bottom: -20px;
            font-size: 10px;
            white-space: nowrap;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        /* 游戏区域 */
        .game-area {
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .level-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #6a11cb;
            font-size: 14px;
            background: rgba(106, 17, 203, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
        }
        .move-timer {
            color: #6a11cb;
            font-weight: bold;
        }
        .progress-container {
            width: 100%;
            max-width: 400px;
            height: 12px;
            background: #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(106, 17, 203, 0.5);
        }
        .game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 3px solid #6a11cb;
            border-radius: 12px;
            padding: 8px;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
            touch-action: manipulation;
            position: relative;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
        }
        .game-cell {
            aspect-ratio: 1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        .game-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%);
            border-radius: 10px;
            z-index: 1;
        }
        .game-cell > * {
            position: relative;
            z-index: 2;
        }
        .game-cell.special {
            animation: pulse 1.5s infinite;
        }
        .game-cell.selected {
            transform: scale(0.9);
            box-shadow: 0 0 0 3px #6a11cb, 0 0 15px rgba(106, 17, 203, 0.6);
            z-index: 10;
        }
        .game-cell.matched {
            animation: matched 0.5s ease forwards;
        }
        .game-cell.falling {
            transition: transform 0.3s ease;
        }
        /* 特殊方块样式 */
        .game-cell.special.bomb {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            animation: pulse 1.5s infinite;
        }
        .game-cell.special.rainbow {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            animation: rainbow 2s infinite;
        }
        @keyframes rainbow {
            0% { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); }
            16% { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
            33% { background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
            50% { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
            66% { background: linear-gradient(135deg, #a6c0fe 0%, #f68084 100%); }
            83% { background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%); }
            100% { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); }
        }
        /* 障碍物样式 */
        .ice {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border: 2px solid #4dd0e1;
            box-shadow: 0 0 10px rgba(77, 208, 225, 0.5);
        }
        .lock {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #9c27b0;
            box-shadow: 0 0 10px rgba(156, 39, 176, 0.5);
        }
        .stone {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            border: 2px solid #616161;
            box-shadow: 0 0 10px rgba(97, 97, 97, 0.5);
        }
        .time-bomb {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef5350 100%);
            border: 2px solid #f44336;
            animation: pulse 1s infinite;
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.7);
        }
        /* 道具栏 */
        .tools-bar {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 400px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        .tool-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .tool-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 8px;
            position: relative;
            transition: all 0.3s ease;
        }
        .tool-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .tool-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-name {
            font-size: 11px;
            color: #666;
        }
        /* 底部功能区 */
        .footer {
            padding: 12px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .action-button {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.4);
            font-size: 13px;
            min-width: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.6);
        }
        .action-button:active {
            transform: translateY(-1px);
        }
        .action-button:disabled {
            background: #cccccc;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 90%;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-content.ranking-modal {
            background: linear-gradient(135deg, #fff9c4 0%, #ffd54f 100%);
        }
        .modal-content.achievements-modal {
            background: linear-gradient(135deg, #c8e6c9 0%, #81c784 100%);
        }
        .modal-content.shop-modal {
            background: linear-gradient(135deg, #bbdefb 0%, #64b5f6 100%);
        }
        .modal-content.checkin-modal {
            background: linear-gradient(135deg, #ffcdd2 0%, #e57373 100%);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(106, 17, 203, 0.2);
        }
        .modal-content.ranking-modal .modal-header {
            border-bottom: 2px solid rgba(245, 127, 23, 0.3);
        }
        .modal-content.achievements-modal .modal-header {
            border-bottom: 2px solid rgba(27, 94, 32, 0.3);
        }
        .modal-content.shop-modal .modal-header {
            border-bottom: 2px solid rgba(13, 71, 161, 0.3);
        }
        .modal-content.checkin-modal .modal-header {
            border-bottom: 2px solid rgba(183, 28, 28, 0.3);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #6a11cb;
        }
        .modal-content.ranking-modal .modal-title {
            color: #f57f17;
        }
        .modal-content.achievements-modal .modal-title {
            color: #1b5e20;
        }
        .modal-content.shop-modal .modal-title {
            color: #0d47a1;
        }
        .modal-content.checkin-modal .modal-title {
            color: #b71c1c;
        }
        .close-button {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .close-button:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #666;
        }
        .modal-buttons {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .modal-button {
            padding: 10px 15px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .primary-button {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.4);
        }
        .primary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 17, 203, 0.6);
        }
        /* 道具商店 */
        .tools-shop {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .tool-shop-item {
            background: white;
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }
        .tool-shop-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
        }
        .tool-shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .tool-shop-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        .tool-shop-name {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 15px;
            color: #333;
        }
        .tool-shop-price {
            color: gold;
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 16px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .ranking-coins {
            font-weight: 700;
            color: gold;
            font-size: 14px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* 签到弹窗 */
        .sign-in-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .sign-in-modal h2 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }
        .sign-in-modal p {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }
        .sign-in-modal button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        .sign-in-modal button:hover {
            background-color: #0056b3;
        }
        /* 隐藏滚动条 */
        .sign-in-modal::-webkit-scrollbar {
            display: none;
        }
        .sign-in-modal {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 成就系统 */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .achievement-item {
            background: white;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }
        .achievement-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
        }
        .achievement-item.locked {
            opacity: 0.6;
            background: #f5f5f5;
        }
        .achievement-item.locked::before {
            background: #ccc;
        }
        .achievement-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .achievement-name {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        .achievement-item.locked .achievement-name {
            color: #999;
        }
        /* 排行榜 */
        .ranking-list {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        .ranking-list::-webkit-scrollbar {
            width: 6px;
        }
        .ranking-list::-webkit-scrollbar-thumb {
            background: #6a11cb;
            border-radius: 3px;
        }
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }
        .ranking-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(to bottom, #6a11cb, #2575fc);
        }
        .ranking-item.top-1 {
            background: linear-gradient(135deg, #fff9c4 0%, #ffd54f 100%);
            box-shadow: 0 5px 15px rgba(245, 127, 23, 0.3);
        }
        .ranking-item.top-1::before {
            background: linear-gradient(to bottom, #fbc02d, #ff8f00);
        }
        .ranking-item.top-2 {
            background: linear-gradient(135deg, #e0e0e0 0%, #9e9e9e 100%);
            box-shadow: 0 5px 15px rgba(158, 158, 158, 0.3);
        }
        .ranking-item.top-2::before {
            background: linear-gradient(to bottom, #9e9e9e, #616161);
        }
        .ranking-item.top-3 {
            background: linear-gradient(135deg, #ffcc80 0%, #ffa726 100%);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }
        .ranking-item.top-3::before {
            background: linear-gradient(to bottom, #fb8c00, #ef6c00);
        }
        .ranking-position {
            font-weight: 800;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            font-size: 14px;
        }
        .ranking-item.top-1 .ranking-position {
            background: linear-gradient(to right, #fbc02d, #ff8f00);
        }
        .ranking-item.top-2 .ranking-position {
            background: linear-gradient(to right, #9e9e9e, #616161);
        }
        .ranking-item.top-3 .ranking-position {
            background: linear-gradient(to right, #fb8c00, #ef6c00);
        }
        .ranking-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 12px;
            font-size: 16px;
            color: #6a11cb;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ranking-info {
            flex: 1;
            text-align: left;
        }
        .ranking-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 3px;
            color: #333;
        }
        .ranking-coins {
            font-weight: 700;
            color: gold;
            font-size: 14px;
            background: linear-gradient(to right, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* 签到弹窗 */
        .checkin-content {
            padding: 15px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
            border: 1px solid rgba(106, 17, 203, 0.1);
        }
        .checkin-title {
            font-size: 18px;
            font-weight: 700;
            color: #b71c1c;
            margin-bottom: 15px;
        }
        .checkin-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .checkin-item {
            text-align: center;
        }
        .checkin-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }
        .checkin-value {
            font-size: 18px;
            font-weight: 700;
            color: #b71c1c;
        }
        .checkin-reward {
            background: linear-gradient(135deg, #ffcdd2 0%, #e57373 100%);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        .checkin-reward-text {
            font-size: 16px;
            font-weight: 700;
            color: #b71c1c;
            margin-bottom: 10px;
        }
        .checkin-reward-amount {
            font-size: 24px;
            font-weight: 800;
            color: gold;
            background: linear-gradient(to right, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* 响应式设计 */
        @media (max-width: 500px) {
            .header {
                padding: 10px;
            }
            
            .game-board {
                max-width: 100%;
            }
            
            .footer {
                padding: 10px;
                gap: 8px;
            }
            
            .action-button {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 70px;
            }
            
            .game-logo {
                font-size: 32px;
            }
            
            .welcome-title {
                font-size: 18px;
            }
            
            .welcome-subtitle {
                font-size: 13px;
            }
        }
        /* 动画效果 */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop {
            animation: pop 0.3s ease;
        }
        @keyframes firework {
            0% { transform: translate(0, 0); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)); opacity: 0; }
        }
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: firework 1s ease-out forwards;
        }
        @keyframes matched {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(0); opacity: 0; }
        }
        @keyframes fall {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes modalAppear {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* 游戏欢迎提示 */
        .game-welcome {
            text-align: center;
            padding: 10px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            font-weight: 600;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 首页 -->
        <div class="home-page" id="home-page">
            <div class="welcome-section">
                <div class="decoration dec-1 floating floating-1">🍬</div>
                <div class="decoration dec-2 floating floating-2">🍭</div>
                <div class="decoration dec-3 floating floating-3">🍫</div>
                <div class="decoration dec-4 floating floating-4">🧁</div>
                <div class="welcome-title">欢迎来到万花消消乐</div>
                <div class="welcome-subtitle">挑战你的消除技巧，收集万花币，解锁成就</div>
            </div>
            
            <!-- 添加个人信息区域 -->
            <div class="user-profile">
                <div class="user-avatar">
                    <div class="avatar-icon">玩家朋友</div>
                </div>
                <div class="user-details">
                    <div class="user-name">玩家朋友</div>
                    <div class="user-id">ID: <span id="user-id-display">-</span></div>
                </div>
                <div class="user-coins">
                    <span class="coin-icon">🪙</span>
                    <span class="coin-amount" id="home-user-coins">20</span>
                </div>
            </div>
            
            <div class="game-stats">
                <div class="stat-item">
                    <div class="stat-value">6000</div>
                    <div class="stat-label">精彩关卡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">50+</div>
                    <div class="stat-label">独特道具</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">∞</div>
                    <div class="stat-label">无尽乐趣</div>
                </div>
            </div>
            
            <div class="player-info">
                <div class="info-item">
                    <div class="info-value" id="home-coins">20</div>
                    <div class="info-label">万花币</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="home-level">1</div>
                    <div class="info-label">当前关卡</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="home-achievements">3</div>
                    <div class="info-label">成就</div>
                </div>
            </div>
            
            <button class="start-button" id="start-game">开始游戏</button>
            
            <div class="feature-grid">
                <div class="feature-card" onclick="openModal('ranking-modal')">
                    <div class="feature-icon">🏆</div>
                    <div class="feature-title">排行榜</div>
                    <div class="feature-desc">查看玩家排名</div>
                </div>
                <div class="feature-card" onclick="openModal('achievements-modal')">
                    <div class="feature-icon">⭐</div>
                    <div class="feature-title">成就系统</div>
                    <div class="feature-desc">解锁游戏成就</div>
                </div>
                <div class="feature-card" onclick="openModal('shop-modal')">
                    <div class="feature-icon">🛒</div>
                    <div class="feature-title">道具商店</div>
                    <div class="feature-desc">购买游戏道具</div>
                </div>
                <div class="feature-card" onclick="openModal('checkin-modal')">
                    <div class="feature-icon">📅</div>
                    <div class="feature-title">每日签到</div>
                    <div class="feature-desc">领取签到奖励</div>
                </div>
                <div class="feature-card" onclick="openModal('withdraw-modal')">
                    <div class="feature-icon">💰</div>
                    <div class="feature-title">提现</div>
                    <div class="feature-desc">万花币提现</div>
                </div>
            </div>
            
            <div class="footer-info">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
        <!-- 游戏页面 -->
        <div class="game-page" id="game-page">
            <!-- 顶部导航栏 -->
            <div class="header">
                <div class="user-info">
                    <div class="avatar">玩家朋友</div>
                    <div class="coins">
                        <span class="coin-icon">🪙</span>
                        <span class="coin-count" id="coin-count">20</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-button" id="checkin-btn" title="签到">
                        📅
                        <span class="button-label">签到</span>
                    </button>
                    <button class="nav-button" id="ranking-btn" title="排行榜">
                        🏆
                        <span class="button-label">排行</span>
                    </button>
                    <button class="nav-button" id="achievements-btn" title="成就">
                        ⭐
                        <span class="button-label">成就</span>
                    </button>
                    <button class="nav-button" id="withdraw-btn" title="提现">
                        💰
                        <span class="button-label">提现</span>
                    </button>
                </div>
            </div>
            <!-- 游戏区域 -->
            <div class="game-area">
                <div class="game-welcome">
                    欢迎回来，玩家朋友！
                </div>
                
                <div class="level-info">
                    <span>第 <span id="current-level">1</span> 关</span>
                    <span>目标: <span id="target-score">500</span> 分</span>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                
                <div class="game-board" id="game-board">
                    <!-- 游戏格子将通过JavaScript生成 -->
                </div>
                
                <div class="level-info">
                    <span>剩余步数: <span id="moves-left">30</span></span>
                    <span>当前得分: <span id="current-score">0</span></span>
                    <span>倒计时: <span id="move-timer" class="move-timer">10</span>s</span>
                </div>
                
                <!-- 道具栏 -->
                <div class="tools-bar">
                    <div class="tool-item" id="hammer-tool">
                        <div class="tool-icon">
                            🔨
                            <div class="tool-count" id="hammer-count">2</div>
                        </div>
                        <div class="tool-name">锤子</div>
                    </div>
                    <div class="tool-item" id="bomb-tool">
                        <div class="tool-icon">
                            💣
                            <div class="tool-count" id="bomb-count">1</div>
                        </div>
                        <div class="tool-name">炸弹</div>
                    </div>
                    <div class="tool-item" id="shuffle-tool">
                        <div class="tool-icon">
                            🔄
                            <div class="tool-count" id="shuffle-count">3</div>
                        </div>
                        <div class="tool-name">洗牌</div>
                    </div>
                    <div class="tool-item" id="magic-tool">
                        <div class="tool-icon">
                            ✨
                            <div class="tool-count" id="magic-count">0</div>
                        </div>
                        <div class="tool-name">魔法棒</div>
                    </div>
                </div>
            </div>
            <!-- 底部功能区 -->
            <div class="footer">
                <button class="action-button" id="restart-btn">
                    <span>🔄</span>
                    <span>重新开始</span>
                </button>
                <button class="action-button" id="shop-btn">
                    <span>🛒</span>
                    <span>道具商店</span>
                </button>
                <button class="action-button" id="home-btn">
                    <span>🏠</span>
                    <span>首页</span>
                </button>
            </div>
            
            <div class="footer-info">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 道具商店弹窗 -->
    <div class="modal" id="shop-modal">
        <div class="modal-content shop-modal">
            <div class="modal-header">
                <div class="modal-title">道具商店</div>
                <button class="close-button" onclick="closeModal('shop-modal')">&times;</button>
            </div>
            <div class="tools-shop">
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">🔨</div>
                    <div class="tool-shop-name">锤子</div>
                    <div class="tool-shop-price">50🪙</div>
                    <button class="modal-button primary-button" onclick="buyTool('hammer')">购买</button>
                </div>
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">💣</div>
                    <div class="tool-shop-name">炸弹</div>
                    <div class="tool-shop-price">80🪙</div>
                    <button class="modal-button primary-button" onclick="buyTool('bomb')">购买</button>
                </div>
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">🔄</div>
                    <div class="tool-shop-name">洗牌</div>
                    <div class="tool-shop-price">60🪙</div>
                    <button class="modal-button primary-button" onclick="buyTool('shuffle')">购买</button>
                </div>
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">✨</div>
                    <div class="tool-shop-name">魔法棒</div>
                    <div class="tool-shop-price">100🪙</div>
                    <button class="modal-button primary-button" onclick="buyTool('magic')">购买</button>
                </div>
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">🔨</div>
                    <div class="tool-shop-name">锤子(看广告)</div>
                    <div class="tool-shop-price">免费</div>
                    <button class="modal-button primary-button" onclick="getToolByAd('hammer')">看广告获取</button>
                </div>
                <div class="tool-shop-item">
                    <div class="tool-shop-icon">🔄</div>
                    <div class="tool-shop-name">洗牌(看广告)</div>
                    <div class="tool-shop-price">免费</div>
                    <button class="modal-button primary-button" onclick="getToolByAd('shuffle')">看广告获取</button>
                </div>
            </div>
            <div class="footer-info" style="margin-top: 20px; font-size: 10px;">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 签到弹窗 -->
    <div class="modal" id="checkin-modal">
        <div class="modal-content checkin-modal">
            <div class="modal-header">
                <div class="modal-title">每日签到</div>
                <button class="close-button" onclick="closeModal('checkin-modal')">&times;</button>
            </div>
            <div class="checkin-content">
                <div class="checkin-title">签到成功！</div>
                <div class="checkin-reward">
                    <div class="checkin-reward-text">今日签到奖励</div>
                    <div class="checkin-reward-amount">10 万花币</div>
                </div>
                <div class="checkin-info">
                    <div class="checkin-item">
                        <div class="checkin-label">累计签到天数</div>
                        <div class="checkin-value">5 天</div>
                    </div>
                    <div class="checkin-item">
                        <div class="checkin-label">连续签到天数</div>
                        <div class="checkin-value">3 天</div>
                    </div>
                </div>
                <div class="checkin-info">
                    <div class="checkin-item">
                        <div class="checkin-label">累计奖励</div>
                        <div class="checkin-value">50 万花币</div>
                    </div>
                    <div class="checkin-item">
                        <div class="checkin-label">连续签到奖励</div>
                        <div class="checkin-value">30 万花币</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-button" onclick="closeModal('checkin-modal')">关闭</button>
            </div>
            <div class="footer-info" style="margin-top: 20px; font-size: 10px;">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 排行榜弹窗 -->
    <div class="modal" id="ranking-modal">
        <div class="modal-content ranking-modal">
            <div class="modal-header">
                <div class="modal-title">月度排行榜</div>
                <button class="close-button" onclick="closeModal('ranking-modal')">&times;</button>
            </div>
            <div class="ranking-list" id="ranking-list">
                <!-- 排行榜将通过JavaScript生成 -->
            </div>
            <div class="footer-info" style="margin-top: 20px; font-size: 10px;">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 成就系统弹窗 -->
    <div class="modal" id="achievements-modal">
        <div class="modal-content achievements-modal">
            <div class="modal-header">
                <div class="modal-title">成就系统</div>
                <button class="close-button" onclick="closeModal('achievements-modal')">&times;</button>
            </div>
            <div class="achievements-grid" id="achievements-grid">
                <!-- 成就将通过JavaScript生成 -->
            </div>
            <div class="footer-info" style="margin-top: 20px; font-size: 10px;">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 提现弹窗 -->
    <div class="modal" id="withdraw-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">提现申请</div>
                <button class="close-button" onclick="closeModal('withdraw-modal')">&times;</button>
            </div>
            <form id="withdraw-form">
                <div style="margin: 15px 0; text-align: left;">
                    <label>支付宝账号:</label><br>
                    <input type="text" id="alipay-account" placeholder="请输入支付宝账号" style="width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                <div style="margin: 15px 0; text-align: left;">
                    <label>真实姓名:</label><br>
                    <input type="text" id="real-name" placeholder="请输入真实姓名" style="width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                <div style="margin: 15px 0; text-align: left;">
                    <label>提现金额 (万花币):</label><br>
                    <input type="number" id="withdraw-amount" placeholder="最小1000，需为1000的倍数" style="width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="modal-button primary-button">提交申请</button>
                </div>
            </form>
            <div class="footer-info">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <!-- 次数不足弹窗 -->
    <div class="modal" id="attempts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">游戏次数不足</div>
                <button class="close-button" onclick="closeModal('attempts-modal')">&times;</button>
            </div>
            <p>您今天的免费游戏次数已用完</p>
            <div class="modal-buttons">
                <button class="modal-button primary-button" id="watch-ad-btn">观看广告 (+2次)</button>
                <button class="modal-button primary-button" id="share-group-btn">分享到群组 (+2次)</button>
            </div>
            <div class="footer-info" style="margin-top: 20px; font-size: 10px;">
                <p>本游戏由北京修车【万花楼】赞助；由 <a href="https://t.me/bjxc010" target="_blank">@bjxc010</a> 开发</p>
                <p>© 2025 万花楼 - 消消乐 版权所有</p>
            </div>
        </div>
    </div>
    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://ylnfjlltesnlfanrxfoy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsbmZqbGx0ZXNubGZhbnJ4Zm95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMDc0MjMsImV4cCI6MjA3MTY4MzQyM30.czuQwYoFd7Ew9f-PBaojhsWJkXrBEtkqTRdhfX-DWFk';
        
        // 初始化Supabase客户端
        let supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // 游戏配置
        const emojis = ['🍬', '🍭', '🍫', '🧁', '🍪', '🍩'];
        const BOARD_SIZE = 8;
        
        // 游戏状态
        let gameState = {
            board: [],
            selectedCell: null,
            score: 0,
            moves: 30,
            level: 1,
            targetScore: 500,
            coins: 20,  // 新用户首次登录送20万花币
            isDragging: false,
            dragStart: null,
            dragEnd: null,
            tools: {
                hammer: 2,
                bomb: 1,
                shuffle: 3,
                magic: 0
            },
            moveTimer: null,        // 步数倒计时定时器
            moveTimeLeft: 10,       // 每步剩余时间（秒）
            baseMoveTime: 10,       // 基础步数时间
            userId: null            // 用户ID
        };
        // 障碍物类型
        const obstacleTypes = {
            ICE: 'ice',           // 冰块 - 需要多次消除才能破坏
            LOCK: 'lock',         // 锁链 - 锁定相邻方块
            STONE: 'stone',       // 石头 - 无法移动，需要特殊道具破坏
            BOMB: 'time-bomb'     // 定时炸弹 - 步数减少时会倒计时
        };
        // 成就系统
        const achievements = [
            { id: 1, name: "初出茅庐", description: "完成第1关", icon: "👶", unlocked: true },
            { id: 2, name: "小试牛刀", description: "完成第10关", icon: "新人玩家", unlocked: false },
            { id: 3, name: "渐入佳境", description: "完成第50关", icon: "🚀", unlocked: false },
            { id: 4, name: "炉火纯青", description: "完成第100关", icon: "🔥", unlocked: false },
            { id: 5, name: "登峰造极", description: "完成第500关", icon: "🏔️", unlocked: false },
            { id: 6, name: "无敌寂寞", description: "完成第1000关", icon: "😎", unlocked: false },
            { id: 7, name: "消除大师", description: "单次消除10个方块", icon: "🎯", unlocked: false },
            { id: 8, name: "连击高手", description: "一次操作引发3次连锁消除", icon: "⚡", unlocked: false },
            { id: 9, name: "完美通关", description: "以满步数完成关卡", icon: "💯", unlocked: false },
            { id: 10, name: "财源滚滚", description: "累计获得10000万花币", icon: "💰", unlocked: false },
            { id: 11, name: "坚持不懈", description: "连续签到7天", icon: "📅", unlocked: false },
            { id: 12, name: "社交达人", description: "分享游戏10次", icon: "📱", unlocked: false }
        ];
        // 为关卡预设成就
        for (let i = 1; i <= 60; i++) {
            const levelRange = (i - 1) * 100 + 1;
            const levelRangeEnd = i * 100;
            achievements.push({
                id: 12 + i,
                name: `关卡征服者 ${levelRange}-${levelRangeEnd}`,
                description: `完成第${levelRange}到${levelRangeEnd}关`,
                icon: "🏅",
                unlocked: false
            });
        }
        
        // 初始化游戏
        async function initGame() {
            // 获取用户ID
            const urlParams = new URLSearchParams(window.location.search);
            gameState.userId = urlParams.get('user_id');
            
            // 如果没有用户ID，提示错误
            if (!gameState.userId) {
                alert('缺少用户信息，请通过Telegram重新进入游戏');
                // 显示错误信息在页面上
                document.getElementById('home-page').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2 style="color: #ff4757;">游戏初始化失败</h2>
                        <p>缺少用户信息，请通过Telegram重新进入游戏</p>
                        <p>请访问我们的Telegram机器人: @bjxcyouxiBot</p>
                    </div>
                `;
                return;
            }
            
            // 从数据库加载用户数据
            await loadUserData();
            
            // 更新用户信息显示
            updateHomeUI();
            
            // 绑定首页事件
            document.getElementById('start-game').addEventListener('click', showGamePage);
            
            // 绑定游戏页面事件
            document.getElementById('restart-btn').addEventListener('click', resetGame);
            document.getElementById('shop-btn').addEventListener('click', () => openModal('shop-modal'));
            document.getElementById('home-btn').addEventListener('click', showHomePage);
            document.getElementById('checkin-btn').addEventListener('click', () => openModal('checkin-modal'));
            document.getElementById('ranking-btn').addEventListener('click', () => openModal('ranking-modal'));
            document.getElementById('achievements-btn').addEventListener('click', showAchievements);
            document.getElementById('withdraw-btn').addEventListener('click', () => openModal('withdraw-modal'));
            document.getElementById('withdraw-form').addEventListener('submit', submitWithdraw);
            document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
            document.getElementById('share-group-btn').addEventListener('click', shareToGroup);
            
            // 绑定道具事件
            document.getElementById('hammer-tool').addEventListener('click', () => useTool('hammer'));
            document.getElementById('bomb-tool').addEventListener('click', () => useTool('bomb'));
            document.getElementById('shuffle-tool').addEventListener('click', () => useTool('shuffle'));
            document.getElementById('magic-tool').addEventListener('click', () => useTool('magic'));
            
            updateUI();
        }
        // 从数据库加载用户数据
        async function loadUserData() {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    // 获取用户游戏数据
                    const { data, error } = await supabase
                        .from('user_game_data')
                        .select('*')
                        .eq('user_id', gameState.userId)
                        .single();
                    if (error) {
                        // 如果是数据不存在的错误，初始化默认数据
                        if (error.code === 'PGRST116') {
                            console.log('User data not found, will use default values');
                            // 使用默认值，不需要报错
                            return true;
                        }
                        console.error('加载用户数据出错:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }
                    if (data) {
                        gameState.level = data.current_level;
                        gameState.coins = data.total_coins;
                        gameState.tools = {
                            hammer: data.hammer || 2,
                            bomb: data.bomb || 1,
                            shuffle: data.shuffle || 3,
                            magic: data.magic || 0
                        };
                    }
                    return true;
                } catch (err) {
                    console.error(`Attempt ${attempt} failed loading user data:`, err);
                    if (attempt === 3) {
                        console.error('Max retries reached for loading user data');
                        showFloatingText('加载用户数据失败，请检查网络连接', '#ff4757');
                        return false;
                    }
                    // 等待后重试
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * attempt));
                }
            }
        }
        // 创建新的用户游戏数据记录
        async function createNewUserGameData() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_game_data`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        user_id: gameState.userId,
                        current_level: gameState.level,
                        total_coins: gameState.coins,
                        free_attempts: 6,
                        daily_attempts_reset: new Date().toISOString()
                    })
                });
                
                if (!response.ok) {
                    console.error('创建用户游戏数据失败:', await response.text());
                }
            } catch (error) {
                console.error('创建用户游戏数据时出错:', error);
            }
        }
        // 保存用户数据到数据库
        async function saveUserData() {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const { error } = await supabase
                        .from('user_game_data')
                        .upsert({
                            user_id: gameState.userId,
                            current_level: gameState.level,
                            total_coins: gameState.coins
                        }, {
                            onConflict: 'user_id'
                        });
                    if (error) {
                        console.error('保存用户数据出错:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }
                    return true;
                } catch (err) {
                    console.error(`Attempt ${attempt} failed saving user data:`, err);
                    if (attempt === 3) {
                        console.error('Max retries reached for saving user data');
                        showFloatingText('保存数据失败，请检查网络连接', '#ff4757');
                        return false;
                    }
                    // 等待后重试
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * attempt));
                }
            }
        }
        // 保存交易记录
        async function saveTransaction(amount, type, status) {
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const { error } = await supabase
                        .from('coin_transactions')
                        .insert({
                            user_id: gameState.userId,
                            amount: -amount, // 提现为负数
                            type: type,
                            status: status
                        });
                    if (error) {
                        console.error('保存交易记录出错:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }
                    return true;
                } catch (err) {
                    console.error(`Attempt ${attempt} failed saving transaction:`, err);
                    if (attempt === 3) {
                        return false;
                    }
                    // 等待后重试
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * attempt));
                }
            }
        }
        
        // 绑定事件
        function bindEvents() {
            // 绑定首页事件
            document.getElementById('start-game').addEventListener('click', showGamePage);
            
            // 绑定游戏页面事件
            document.getElementById('restart-btn').addEventListener('click', resetGame);
            document.getElementById('shop-btn').addEventListener('click', () => openModal('shop-modal'));
            document.getElementById('home-btn').addEventListener('click', showHomePage);
            document.getElementById('checkin-btn').addEventListener('click', showCheckinModal);
            document.getElementById('ranking-btn').addEventListener('click', () => openModal('ranking-modal'));
            document.getElementById('achievements-btn').addEventListener('click', showAchievements);
            document.getElementById('withdraw-btn').addEventListener('click', () => openModal('withdraw-modal'));
            document.getElementById('withdraw-form').addEventListener('submit', submitWithdraw);
            document.getElementById('watch-ad-btn').addEventListener('click', watchAd);
            document.getElementById('share-group-btn').addEventListener('click', shareToGroup);
            
            // 绑定道具事件
            document.getElementById('hammer-tool').addEventListener('click', () => useTool('hammer'));
            document.getElementById('bomb-tool').addEventListener('click', () => useTool('bomb'));
            document.getElementById('shuffle-tool').addEventListener('click', () => useTool('shuffle'));
            document.getElementById('magic-tool').addEventListener('click', () => useTool('magic'));
        }
        // 显示游戏页面
        function showGamePage() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'block';
            createBoard();
            renderBoard();
            setupTouchEvents();
            // 启动第一步计时器
            resetMoveTimer();
        }
        // 显示首页
        function showHomePage() {
            // 清除当前计时器
            if (gameState.moveTimer) {
                clearInterval(gameState.moveTimer);
                gameState.moveTimer = null;
            }
            
            document.getElementById('game-page').style.display = 'none';
            document.getElementById('home-page').style.display = 'block';
            updateHomeUI();
        }
        // 更新首页UI
        function updateHomeUI() {
            document.getElementById('home-coins').textContent = gameState.coins;
            document.getElementById('home-user-coins').textContent = gameState.coins;
            document.getElementById('home-level').textContent = gameState.level;
            document.getElementById('home-achievements').textContent = achievements.filter(a => a.unlocked).length;
            if (gameState.userId) {
                document.getElementById('user-id-display').textContent = gameState.userId;
            }
        }
        // 创建游戏板
        function createBoard() {
            gameState.board = [];
            for (let i = 0; i < BOARD_SIZE; i++) {
                gameState.board[i] = [];
                for (let j = 0; j < BOARD_SIZE; j++) {
                    // 根据关卡确定是否生成障碍物
                    // 调整障碍物生成率，使游戏更具挑战性
                    const obstacleChance = Math.min(0.3, gameState.level * 0.005);
                    
                    if (Math.random() < obstacleChance && !(i === 0 && j === 0) && !(i === BOARD_SIZE-1 && j === BOARD_SIZE-1)) {
                        // 生成障碍物
                        // 关卡越高，出现更强的障碍物概率越大
                        let obstacleType;
                        const levelFactor = gameState.level / 100;
                        
                        if (Math.random() < 0.1 + levelFactor) {
                            obstacleType = obstacleTypes.STONE;
                        } else if (Math.random() < 0.3 + levelFactor) {
                            obstacleType = obstacleTypes.LOCK;
                        } else {
                            obstacleType = obstacleTypes.ICE;
                        }
                        
                        gameState.board[i][j] = {
                            type: obstacleType,
                            special: null,
                            durability: obstacleType === obstacleTypes.ICE ? 2 : 
                                       obstacleType === obstacleTypes.STONE ? 999 : 1
                        };
                    } else {
                        // 生成普通方块
                        gameState.board[i][j] = {
                            type: getRandomEmoji(),
                            special: null,
                            durability: 1
                        };
                    }
                }
            }
            
            // 确保初始状态没有可消除的组合
            while (hasMatches()) {
                shuffleBoardInternal();
            }
            
            // 根据关卡调整步数，使游戏更具挑战性
            // 调整步数和目标分数的平衡性
            if (gameState.level <= 10) {
                gameState.moves = 25; // 前10关25步
            } else if (gameState.level <= 30) {
                gameState.moves = 23; // 11-30关23步
            } else if (gameState.level <= 60) {
                gameState.moves = 21; // 31-60关21步
            } else if (gameState.level <= 100) {
                gameState.moves = 20; // 61-100关20步
            } else if (gameState.level <= 200) {
                gameState.moves = 19; // 101-200关19步
            } else if (gameState.level <= 500) {
                gameState.moves = 18; // 201-500关18步
            } else if (gameState.level <= 1000) {
                gameState.moves = 17; // 501-1000关17步
            } else if (gameState.level <= 2000) {
                gameState.moves = 16; // 1001-2000关16步
            } else {
                gameState.moves = 15; // 2001+关15步
            }
            
            // 调整目标分数计算方式，使其与步数更匹配
            // 使用更合理的公式来平衡步数和目标分数
            gameState.targetScore = 300 + Math.floor(gameState.level * 25 * (1 + gameState.level * 0.05));
            
            // 随着关卡增加，减少每步时间
            gameState.baseMoveTime = Math.max(5, 12 - Math.floor(gameState.level / 12));
            gameState.moveTimeLeft = gameState.baseMoveTime;
        }
        // 渲染游戏板
        function renderBoard() {
            const boardElement = document.getElementById('game-board');
            if (!boardElement) return;
            
            // 使用文档片段来减少重排次数
            const fragment = document.createDocumentFragment();
            const cells = boardElement.querySelectorAll('.game-cell');
            let cellIndex = 0;
            
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    let cell;
                    // 重用现有的单元格元素，减少DOM操作
                    if (cellIndex < cells.length) {
                        cell = cells[cellIndex];
                        // 清除之前的类和内容
                        cell.className = 'game-cell';
                        cell.textContent = '';
                    } else {
                        cell = document.createElement('div');
                        cell.className = 'game-cell';
                    }
                    
                    const cellData = gameState.board[i][j];
                    
                    // 根据类型设置显示内容和样式
                    switch(cellData.type) {
                        case obstacleTypes.ICE:
                            cell.textContent = '❄️';
                            cell.classList.add('ice');
                            break;
                        case obstacleTypes.LOCK:
                            cell.textContent = '🔗';
                            cell.classList.add('lock');
                            break;
                        case obstacleTypes.STONE:
                            cell.textContent = '🪨';
                            cell.classList.add('stone');
                            break;
                        case obstacleTypes.BOMB:
                            cell.textContent = '💣';
                            cell.classList.add('time-bomb');
                            break;
                        default:
                            cell.textContent = cellData.type;
                    }
                    
                    // 添加特殊方块样式
                    if (cellData.special) {
                        cell.classList.add('special', cellData.special);
                    }
                    
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    if (cellIndex >= cells.length) {
                        fragment.appendChild(cell);
                    }
                    cellIndex++;
                }
            }
            
            // 删除多余的单元格
            while (cells.length > cellIndex) {
                cells[cells.length - 1].remove();
            }
            
            // 只有在有新元素时才添加到DOM
            if (fragment.childNodes.length > 0) {
                boardElement.appendChild(fragment);
            }
        }
        // 设置触摸事件
        function setupTouchEvents() {
            const board = document.getElementById('game-board');
            
            // 清除已有的事件监听器，防止重复绑定
            board.removeEventListener('touchstart', handleTouchStart);
            board.removeEventListener('touchmove', handleTouchMove);
            board.removeEventListener('touchend', handleTouchEnd);
            board.removeEventListener('mousedown', handleMouseDown);
            board.removeEventListener('mousemove', handleMouseMove);
            board.removeEventListener('mouseup', handleMouseUp);
            board.removeEventListener('mouseleave', handleMouseUp);
            
            // 重新添加事件监听器
            board.addEventListener('touchstart', handleTouchStart, { passive: false });
            board.addEventListener('touchmove', handleTouchMove, { passive: false });
            board.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // 鼠标事件作为备选
            board.addEventListener('mousedown', handleMouseDown);
            board.addEventListener('mousemove', handleMouseMove);
            board.addEventListener('mouseup', handleMouseUp);
            board.addEventListener('mouseleave', handleMouseUp);
        }
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const cell = document.elementFromPoint(touch.clientX, touch.clientY);
            if (cell && cell.classList.contains('game-cell')) {
                gameState.isDragging = true;
                gameState.dragStart = {
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col),
                    x: touch.clientX,
                    y: touch.clientY
                };
                cell.classList.add('selected');
            }
        }
        function handleTouchMove(e) {
            if (!gameState.isDragging) return;
            e.preventDefault();
        }
        function handleTouchEnd(e) {
            if (!gameState.isDragging) return;
            e.preventDefault();
            if (gameState.dragStart) {
                const touch = e.changedTouches[0];
                const cell = document.elementFromPoint(touch.clientX, touch.clientY);
                
                if (cell && cell.classList.contains('game-cell')) {
                    const startCell = document.querySelector(`.game-cell[data-row="${gameState.dragStart.row}"][data-col="${gameState.dragStart.col}"]`);
                    if (startCell) startCell.classList.remove('selected');
                    
                    gameState.dragEnd = {
                        row: parseInt(cell.dataset.row),
                        col: parseInt(cell.dataset.col)
                    };
                    
                    // 检查是否相邻
                    if (isAdjacent(gameState.dragStart.row, gameState.dragStart.col, gameState.dragEnd.row, gameState.dragEnd.col)) {
                        swapAndProcess(gameState.dragStart.row, gameState.dragStart.col, gameState.dragEnd.row, gameState.dragEnd.col);
                    }
                    
                    gameState.isDragging = false;
                    gameState.dragStart = null;
                    gameState.dragEnd = null;
                }
            }
        }
        function handleMouseDown(e) {
            const cell = e.target;
            if (cell && cell.classList.contains('game-cell')) {
                gameState.isDragging = true;
                gameState.dragStart = {
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col)
                };
                cell.classList.add('selected');
                e.preventDefault();
            }
        }
        function handleMouseMove(e) {
            if (!gameState.isDragging) return;
            e.preventDefault();
        }
        function handleMouseUp(e) {
            if (!gameState.isDragging) return;
            e.preventDefault();
            
            const cell = document.elementFromPoint(e.clientX, e.clientY);
            if (cell && cell.classList.contains('game-cell') && gameState.dragStart) {
                const startCell = document.querySelector(`.game-cell[data-row="${gameState.dragStart.row}"][data-col="${gameState.dragStart.col}"]`);
                if (startCell) startCell.classList.remove('selected');
                
                gameState.dragEnd = {
                    row: parseInt(cell.dataset.row),
                    col: parseInt(cell.dataset.col)
                };
                
                // 检查是否相邻
                if (isAdjacent(gameState.dragStart.row, gameState.dragStart.col, gameState.dragEnd.row, gameState.dragEnd.col)) {
                    swapAndProcess(gameState.dragStart.row, gameState.dragStart.col, gameState.dragEnd.row, gameState.dragEnd.col);
                }
            }
            
            gameState.isDragging = false;
            gameState.dragStart = null;
            gameState.dragEnd = null;
        }
        // 交换并处理游戏逻辑
        function swapAndProcess(row1, col1, row2, col2) {
            // 重置步数计时器
            resetMoveTimer();
            
            // 执行交换
            swapCells(row1, col1, row2, col2);
            
            // 检查是否有匹配
            if (hasMatches()) {
                // 有匹配，减少步数
                gameState.moves--;
                updateUI();
                
                // 处理匹配和得分
                processMatches();
            } else {
                // 没有匹配，交换回来
                swapCells(row1, col1, row2, col2);
                renderBoard();
            }
        }
        // 检查两个单元格是否相邻且可交换
        function isAdjacent(row1, col1, row2, col2) {
            const rowDiff = Math.abs(row1 - row2);
            const colDiff = Math.abs(col1 - col2);
            
            // 检查是否相邻
            const adjacent = (rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1);
            
            // 检查是否包含不可移动的障碍物
            const cell1Movable = gameState.board[row1][col1].type !== obstacleTypes.STONE && 
                                gameState.board[row1][col1].type !== obstacleTypes.LOCK;
            const cell2Movable = gameState.board[row2][col2].type !== obstacleTypes.STONE && 
                                gameState.board[row2][col2].type !== obstacleTypes.LOCK;
            
            return adjacent && cell1Movable && cell2Movable;
        }
        // 交换两个单元格
        function swapCells(row1, col1, row2, col2) {
            const temp = gameState.board[row1][col1];
            gameState.board[row1][col1] = gameState.board[row2][col2];
            gameState.board[row2][col2] = temp;
        }
        // 检查是否有匹配
        function hasMatches() {
            // 检查水平匹配
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE - 2; j++) {
                    // 只有普通方块才能参与匹配
                    if (gameState.board[i][j].type !== '' && 
                        !isObstacle(gameState.board[i][j].type) &&
                        gameState.board[i][j].type === gameState.board[i][j+1].type && 
                        gameState.board[i][j].type === gameState.board[i][j+2].type) {
                        return true;
                    }
                }
            }
            
            // 检查垂直匹配
            for (let i = 0; i < BOARD_SIZE - 2; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    // 只有普通方块才能参与匹配
                    if (gameState.board[i][j].type !== '' && 
                        !isObstacle(gameState.board[i][j].type) &&
                        gameState.board[i][j].type === gameState.board[i+1][j].type && 
                        gameState.board[i][j].type === gameState.board[i+2][j].type) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        // 检查是否为障碍物
        function isObstacle(type) {
            return [obstacleTypes.ICE, obstacleTypes.LOCK, obstacleTypes.STONE, obstacleTypes.BOMB].includes(type);
        }
        // 处理匹配
        async function processMatches() {
            // 查找所有匹配
            const matches = findMatches();
            
            if (matches.length > 0) {
                // 标记匹配的方块
                markMatches(matches);
                
                // 计算得分 - 调整万花币获取
                let scoreIncrease = 0;
                
                matches.forEach(match => {
                    match.forEach(pos => {
                        const cell = gameState.board[pos.row][pos.col];
                        // 如果是障碍物，减少耐久度
                        if (cell.durability > 1) {
                            cell.durability--;
                            // 如果耐久度为0，消除障碍物
                            if (cell.durability <= 0) {
                                cell.type = getRandomEmoji();
                                cell.durability = 1;
                                scoreIncrease += 5;
                            }
                        } else if (cell.durability === 1 && !isObstacle(cell.type)) {
                            // 普通方块被完全消除
                            cell.type = '';
                            cell.special = null;
                            scoreIncrease += 1;
                        }
                    });
                });
                
                gameState.score += scoreIncrease;
                // 万花币获取：10分等于1万花币
                gameState.coins += Math.floor(scoreIncrease / 10);
                
                // 保存数据到数据库
                saveUserData();
                
                // 显示动画效果
                animateMatches(matches);
                
                // 延迟更新界面 - 减少延迟时间以提高响应速度
                setTimeout(() => {
                    // 填充空位
                    fillEmptyCells();
                    
                    // 渲染更新后的游戏板
                    renderBoard();
                    
                    // 更新UI
                    updateUI();
                    
                    // 重新绑定触摸事件，确保游戏可以继续
                    setupTouchEvents();
                    
                    // 检查是否还有自动匹配 - 减少延迟时间以提高响应速度
                    setTimeout(() => {
                        if (hasMatches()) {
                            processMatches(); // 递归处理自动匹配
                        } else {
                            // 检查游戏是否结束
                            checkGameEnd();
                        }
                    }, 150); // 从300ms减少到150ms
                }, 150); // 从300ms减少到150ms
            } else {
                // 检查游戏是否结束
                checkGameEnd();
            }
        }
        // 查找所有匹配
        function findMatches() {
            const matches = [];
            
            // 查找水平匹配
            for (let i = 0; i < BOARD_SIZE; i++) {
                let count = 1;
                let currentType = gameState.board[i][0].type;
                let match = [{row: i, col: 0}];
                
                for (let j = 1; j < BOARD_SIZE; j++) {
                    // 只有普通方块才能参与匹配
                    if (gameState.board[i][j].type === currentType && currentType !== '' && !isObstacle(currentType)) {
                        count++;
                        match.push({row: i, col: j});
                    } else {
                        if (count >= 3) {
                            matches.push([...match]);
                        }
                        count = 1;
                        currentType = gameState.board[i][j].type;
                        match = [{row: i, col: j}];
                    }
                }
                
                if (count >= 3) {
                    matches.push([...match]);
                }
            }
            
            // 查找垂直匹配
            for (let j = 0; j < BOARD_SIZE; j++) {
                let count = 1;
                let currentType = gameState.board[0][j].type;
                let match = [{row: 0, col: j}];
                
                for (let i = 1; i < BOARD_SIZE; i++) {
                    // 只有普通方块才能参与匹配
                    if (gameState.board[i][j].type === currentType && currentType !== '' && !isObstacle(currentType)) {
                        count++;
                        match.push({row: i, col: j});
                    } else {
                        if (count >= 3) {
                            matches.push([...match]);
                        }
                        count = 1;
                        currentType = gameState.board[i][j].type;
                        match = [{row: i, col: j}];
                    }
                }
                
                if (count >= 3) {
                    matches.push([...match]);
                }
            }
            
            return matches;
        }
        // 标记匹配
        function markMatches(matches) {
            matches.forEach(match => {
                match.forEach(pos => {
                    const cell = document.querySelector(`.game-cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    if (cell) {
                        cell.classList.add('matched');
                    }
                });
            });
        }
        // 动画匹配效果
        function animateMatches(matches) {
            matches.forEach(match => {
                match.forEach(pos => {
                    const cell = document.querySelector(`.game-cell[data-row="${pos.row}"][data-col="${pos.col}"]`);
                    if (cell) {
                        cell.classList.add('matched');
                    }
                });
            });
        }
        // 填充空位 - 优化此函数以提高性能
        function fillEmptyCells() {
            for (let j = 0; j < BOARD_SIZE; j++) {
                let emptySpaces = 0;
                
                // 从底部开始处理每一列
                for (let i = BOARD_SIZE - 1; i >= 0; i--) {
                    if (gameState.board[i][j].type === '') {
                        emptySpaces++;
                    } else if (emptySpaces > 0 && 
                              gameState.board[i][j].type !== obstacleTypes.STONE && 
                              gameState.board[i][j].type !== obstacleTypes.LOCK) {
                        // 移动可移动的方块到空位（石头和锁链不能移动）
                        gameState.board[i + emptySpaces][j] = {...gameState.board[i][j]};
                        gameState.board[i][j] = {type: '', special: null, durability: 1};
                    }
                }
                
                // 填充顶部的空位
                for (let i = 0; i < emptySpaces; i++) {
                    if (gameState.board[i][j].type === '') {
                        gameState.board[i][j] = {
                            type: getRandomEmoji(),
                            special: null,
                            durability: 1
                        };
                    }
                }
            }
        }
        // 获取随机表情符号
        function getRandomEmoji() {
            return emojis[Math.floor(Math.random() * emojis.length)];
        }
        // 随机打乱游戏板内部
        function shuffleBoardInternal() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    // 只打乱普通方块，保留障碍物
                    if (!isObstacle(gameState.board[i][j].type)) {
                        gameState.board[i][j] = {
                            type: getRandomEmoji(),
                            special: null,
                            durability: 1
                        };
                    }
                }
            }
        }
        // 使用道具
        function useTool(toolName) {
            if (gameState.tools[toolName] > 0) {
                gameState.tools[toolName]--;
                updateToolCounts();
                
                switch (toolName) {
                    case 'hammer':
                        showFloatingText("使用了锤子道具，点击一个方块消除它", "#6a11cb");
                        // 进入选择模式
                        enableTargetSelectionMode('hammer');
                        break;
                    case 'bomb':
                        showFloatingText("使用了炸弹道具，点击中心点消除3x3区域内的方块", "#ff4757");
                        // 进入选择模式
                        enableTargetSelectionMode('bomb');
                        break;
                    case 'shuffle':
                        shuffleBoard();
                        showFloatingText("使用了洗牌道具", "#ffa502");
                        break;
                    case 'magic':
                        showFloatingText("使用了魔法棒道具，自动完成一次最佳消除", "#2ed573");
                        // 自动寻找并执行最佳消除
                        performMagicMove();
                        break;
                }
                
                // 保存道具使用情况
                saveUserData();
            } else {
                showFloatingText(`没有${getToolName(toolName)}道具了，请先购买`, "#ff4757");
            }
        }
        // 启用目标选择模式
        function enableTargetSelectionMode(toolName) {
            const board = document.getElementById('game-board');
            board.addEventListener('click', function handler(e) {
                if (e.target.classList.contains('game-cell')) {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    
                    switch (toolName) {
                        case 'hammer':
                            // 锤子消除单个方块
                            if (gameState.board[row][col].type !== obstacleTypes.STONE) {
                                gameState.board[row][col] = {type: '', special: null, durability: 1};
                                showFloatingText("锤子道具使用成功", "#6a11cb");
                            } else {
                                showFloatingText("无法破坏石头障碍物", "#ff4757");
                            }
                            break;
                        case 'bomb':
                            // 炸弹消除3x3区域
                            for (let i = Math.max(0, row - 1); i <= Math.min(BOARD_SIZE - 1, row + 1); i++) {
                                for (let j = Math.max(0, col - 1); j <= Math.min(BOARD_SIZE - 1, col + 1); j++) {
                                    if (gameState.board[i][j].type !== obstacleTypes.STONE) {
                                        gameState.board[i][j] = {type: '', special: null, durability: 1};
                                    }
                                }
                            }
                            showFloatingText("炸弹道具使用成功", "#ff4757");
                            break;
                    }
                    
                    // 更新游戏板
                    renderBoard();
                    board.removeEventListener('click', handler);
                }
            });
        }
        // 执行魔法移动
        function performMagicMove() {
            // 寻找最佳消除位置
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    // 检查水平交换
                    if (j < BOARD_SIZE - 1) {
                        // 检查两个方块是否都可以移动
                        if (gameState.board[i][j].type !== obstacleTypes.STONE && 
                            gameState.board[i][j].type !== obstacleTypes.LOCK &&
                            gameState.board[i][j+1].type !== obstacleTypes.STONE && 
                            gameState.board[i][j+1].type !== obstacleTypes.LOCK) {
                            // 交换
                            swapCells(i, j, i, j+1);
                            if (hasMatches()) {
                                // 找到有效移动，执行消除
                                gameState.moves--; // 使用魔法棒消耗一步
                                updateUI();
                                // 使用较小的延迟来提高响应速度
                                setTimeout(() => {
                                    processMatches();
                                }, 50);
                                return;
                            }
                            // 换回来
                            swapCells(i, j, i, j+1);
                        }
                    }
                    
                    // 检查垂直交换
                    if (i < BOARD_SIZE - 1) {
                        // 检查两个方块是否都可以移动
                        if (gameState.board[i][j].type !== obstacleTypes.STONE && 
                            gameState.board[i][j].type !== obstacleTypes.LOCK &&
                            gameState.board[i+1][j].type !== obstacleTypes.STONE && 
                            gameState.board[i+1][j].type !== obstacleTypes.LOCK) {
                            // 交换
                            swapCells(i, j, i+1, j);
                            if (hasMatches()) {
                                // 找到有效移动，执行消除
                                gameState.moves--; // 使用魔法棒消耗一步
                                updateUI();
                                // 使用较小的延迟来提高响应速度
                                setTimeout(() => {
                                    processMatches();
                                }, 50);
                                return;
                            }
                            // 换回来
                            swapCells(i, j, i+1, j);
                        }
                    }
                }
            }
            
            showFloatingText("未找到有效移动", "#ff4757");
        }
        // 洗牌功能 - 只洗可移动的方块
        function shuffleBoard() {
            // 收集所有可移动的方块
            const movableCells = [];
            const positions = [];
            
            for (let i = 0; i < BOARD_SIZE; i++) {
                for (let j = 0; j < BOARD_SIZE; j++) {
                    // 只收集可移动的普通方块
                    if (gameState.board[i][j].type !== obstacleTypes.STONE && 
                        gameState.board[i][j].type !== obstacleTypes.LOCK && 
                        gameState.board[i][j].durability <= 1 &&
                        gameState.board[i][j].type !== '') {
                        movableCells.push(gameState.board[i][j]);
                        positions.push({row: i, col: j});
                    }
                }
            }
            
            // 洗牌可移动方块
            for (let i = movableCells.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [movableCells[i], movableCells[j]] = [movableCells[j], movableCells[i]];
            }
            
            // 重新分配洗牌后的方块
            for (let i = 0; i < positions.length; i++) {
                const pos = positions[i];
                gameState.board[pos.row][pos.col] = movableCells[i];
            }
            
            renderBoard();
            showFloatingText("棋盘已重新排列", "#2575fc");
            
            // 重新绑定触摸事件，确保游戏可以继续
            setupTouchEvents();
        }
        // 获取道具名称
        function getToolName(toolName) {
            const names = {
                'hammer': '锤子',
                'bomb': '炸弹',
                'shuffle': '洗牌',
                'magic': '魔法棒'
            };
            return names[toolName] || toolName;
        }
        // 购买道具 - 调整道具价格
        function buyTool(toolName) {
            const prices = {
                'hammer': 50,     // 锤子：50🪙
                'bomb': 80,       // 炸弹：80🪙
                'shuffle': 60,    // 洗牌：60🪙
                'magic': 100      // 魔法棒：100🪙
            };
            
            const price = prices[toolName];
            if (gameState.coins >= price) {
                gameState.coins -= price;
                gameState.tools[toolName]++;
                updateUI();
                showFloatingText(`成功购买${getToolName(toolName)}道具`, "#2ed573");
                closeModal('shop-modal');
                
                // 保存数据到数据库
                saveUserData();
            } else {
                showFloatingText("万花币不足，无法购买该道具", "#ff4757");
            }
        }
        // 通过观看广告获取道具
        function getToolByAd(toolName) {
            // 模拟观看广告
            setTimeout(() => {
                gameState.tools[toolName]++;
                updateToolCounts();
                showFloatingText(`通过观看广告获得${getToolName(toolName)}道具`, "#2ed573");
                closeModal('shop-modal');
                
                // 保存数据到数据库
                saveUserData();
            }, 1000);
        }
        // 更新UI
        function updateUI() {
            document.getElementById('current-level').textContent = gameState.level;
            document.getElementById('target-score').textContent = gameState.targetScore;
            document.getElementById('moves-left').textContent = gameState.moves;
            document.getElementById('current-score').textContent = gameState.score;
            document.getElementById('coin-count').textContent = gameState.coins;
            
            // 更新道具数量
            updateToolCounts();
            
            // 更新进度条
            const progress = Math.min(100, Math.max(0, (gameState.score / gameState.targetScore) * 100));
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // 更新倒计时显示
            updateMoveTimerDisplay();
        }
        // 更新道具数量
        function updateToolCounts() {
            document.getElementById('hammer-count').textContent = gameState.tools.hammer;
            document.getElementById('bomb-count').textContent = gameState.tools.bomb;
            document.getElementById('shuffle-count').textContent = gameState.tools.shuffle;
            document.getElementById('magic-count').textContent = gameState.tools.magic;
        }
        // 更新倒计时显示
        function updateMoveTimerDisplay() {
            const timerElement = document.getElementById('move-timer');
            if (timerElement) {
                timerElement.textContent = gameState.moveTimeLeft;
                // 根据剩余时间改变颜色和大小
                if (gameState.moveTimeLeft <= 3) {
                    timerElement.style.color = '#ff4757'; // 红色
                    timerElement.style.fontWeight = 'bold';
                } else if (gameState.moveTimeLeft <= 5) {
                    timerElement.style.color = '#ffa502'; // 橙色
                } else {
                    timerElement.style.color = '#6a11cb'; // 紫色
                }
            }
        }
        // 重置步数计时器
        function resetMoveTimer() {
            // 清除之前的计时器
            if (gameState.moveTimer) {
                clearInterval(gameState.moveTimer);
                gameState.moveTimer = null;
            }
            
            // 重置时间
            gameState.moveTimeLeft = gameState.baseMoveTime;
            updateMoveTimerDisplay();
            
            // 启动新计时器
            gameState.moveTimer = setInterval(() => {
                gameState.moveTimeLeft--;
                updateMoveTimerDisplay();
                
                // 时间到
                if (gameState.moveTimeLeft <= 0) {
                    clearInterval(gameState.moveTimer);
                    gameState.moveTimer = null;
                    // 时间到提示，但不减少步数
                    showFloatingText("时间到！请加快操作速度", "#ff4757");
                    // 重启计时器
                    resetMoveTimer();
                }
            }, 1000);
        }
        // 检查游戏是否结束
        function checkGameEnd() {
            // 清除计时器
            if (gameState.moveTimer) {
                clearInterval(gameState.moveTimer);
                gameState.moveTimer = null;
            }
            
            if (gameState.moves <= 0) {
                if (gameState.score >= gameState.targetScore) {
                    // 通关 - 关卡奖励
                    const levelBonus = Math.min(5, 1 + Math.floor(gameState.level / 20));
                    gameState.coins += levelBonus;
                    showFireworks();
                    showFloatingText(`恭喜通关！获得${levelBonus}万花币奖励！`, "#2ed573");
                    
                    // 保存用户数据
                    saveUserData();
                    
                    setTimeout(() => {
                        nextLevel();
                    }, 2000);
                } else {
                    // 失败
                    showFloatingText(`游戏结束！差${gameState.targetScore - gameState.score}分通关`, "#ff4757");
                    setTimeout(() => {
                        showAttemptsModal();
                    }, 2000);
                }
            } else if (gameState.score >= gameState.targetScore) {
                // 提前通关 - 关卡奖励
                const levelBonus = Math.min(5, 1 + Math.floor(gameState.level / 20));
                gameState.coins += levelBonus;
                showFireworks();
                showFloatingText(`恭喜提前通关！获得${levelBonus}万花币奖励！`, "#2ed573");
                
                // 保存用户数据
                saveUserData();
                
                setTimeout(() => {
                    nextLevel();
                }, 2000);
            }
        }
        // 下一关
        function nextLevel() {
            // 清除当前计时器
            if (gameState.moveTimer) {
                clearInterval(gameState.moveTimer);
                gameState.moveTimer = null;
            }
            
            gameState.level++;
            // 随着关卡增加，目标分数增长更快
            gameState.targetScore = 500 + Math.floor(gameState.level * 30 * (1 + gameState.level * 0.08));
            // 步数随关卡递减，但不低于10步
            gameState.moves = Math.max(10, 30 - Math.floor(gameState.level / 3));
            gameState.score = 0;
            // 减少每步时间
            gameState.baseMoveTime = Math.max(5, 10 - Math.floor(gameState.level / 10));
            gameState.moveTimeLeft = gameState.baseMoveTime;
            createBoard();
            renderBoard();
            updateUI();
            // 重启计时器
            resetMoveTimer();
            showFloatingText(`第${gameState.level}关开始`, "#6a11cb");
            
            // 保存用户数据
            saveUserData();
        }
        // 重置游戏
        function resetGame() {
            // 清除当前计时器
            if (gameState.moveTimer) {
                clearInterval(gameState.moveTimer);
                gameState.moveTimer = null;
            }
            
            gameState.score = 0;
            gameState.moves = 30;
            gameState.baseMoveTime = 10;
            gameState.moveTimeLeft = gameState.baseMoveTime;
            createBoard();
            renderBoard();
            updateUI();
            // 重启计时器
            resetMoveTimer();
            showFloatingText("游戏已重置", "#6a11cb");
        }
        // 显示次数不足弹窗
        function showAttemptsModal() {
            openModal('attempts-modal');
        }
        // 观看广告
        function watchAd() {
            closeModal('attempts-modal');
            gameState.coins += 20; // 观看广告奖励
            showFloatingText('观看广告完成！获得20万花币奖励！', '#ffa502');
            updateUI();
            
            // 保存数据到数据库
            saveUserData();
        }
        // 分享到群组
        function shareToGroup() {
            closeModal('attempts-modal');
            showFloatingText('分享功能已触发，请在弹出的Telegram界面中选择群组分享', '#2ed573');
            // 实际实现中会调用Telegram分享功能
        }
        // 签到 - 调整签到奖励
        function checkin() {
            // 根据连续签到天数给奖励
            const reward = Math.min(10, 2 + Math.floor(Math.random() * 3)); // 2-10万花币
            gameState.coins += reward;
            showFloatingText(`签到成功！获得${reward}万花币奖励！`, '#2ed573');
            updateUI();
            closeModal('checkin-modal');
            
            // 保存数据到数据库
            saveUserData();
        }
        // 提交提现申请
        function submitWithdraw(e) {
            e.preventDefault();
            const account = document.getElementById('alipay-account').value;
            const name = document.getElementById('real-name').value;
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            
            if (!account || !name) {
                showFloatingText('请填写完整的支付宝账号和真实姓名', '#ff4757');
                return;
            }
            
            // 提现金额调整为1000起，以1000的倍数
            if (isNaN(amount) || amount < 1000 || amount % 1000 !== 0) {
                showFloatingText('提现金额必须是1000的倍数且不小于1000', '#ff4757');
                return;
            }
            
            if (amount > gameState.coins) {
                showFloatingText('万花币余额不足', '#ff4757');
                return;
            }
            
            gameState.coins -= amount;
            updateUI();
            closeModal('withdraw-modal');
            showFloatingText(`提现申请已提交！${amount}万花币已扣除，预计3个工作日内到账`, '#2ed573');
            
            // 保存数据到数据库
            saveUserData();
            
            // 记录提现交易
            saveTransaction(amount, '提现', 'completed');
        }
        // 显示成就
        function showAchievements() {
            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = '';
            
            achievements.forEach(achievement => {
                const item = document.createElement('div');
                item.className = `achievement-item ${achievement.unlocked ? '' : 'locked'}`;
                item.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                `;
                grid.appendChild(item);
            });
            
            openModal('achievements-modal');
        }
        // 打开弹窗
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        // 关闭弹窗
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        // 显示浮动文字
        function showFloatingText(text, color) {
            const floatingText = document.createElement('div');
            floatingText.textContent = text;
            floatingText.style.position = 'fixed';
            floatingText.style.top = '50%';
            floatingText.style.left = '50%';
            floatingText.style.transform = 'translate(-50%, -50%)';
            floatingText.style.backgroundColor = color;
            floatingText.style.color = 'white';
            floatingText.style.padding = '15px 25px';
            floatingText.style.borderRadius = '30px';
            floatingText.style.zIndex = '2000';
            floatingText.style.fontWeight = 'bold';
            floatingText.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
            floatingText.style.opacity = '0';
            floatingText.style.transition = 'opacity 0.3s, transform 0.3s';
            
            document.body.appendChild(floatingText);
            
            // 显示动画
            setTimeout(() => {
                floatingText.style.opacity = '1';
                floatingText.style.transform = 'translate(-50%, -50%) scale(1.1)';
            }, 10);
            
            // 移除元素
            setTimeout(() => {
                floatingText.style.opacity = '0';
                floatingText.style.transform = 'translate(-50%, -50%) scale(0.8)';
                setTimeout(() => {
                    document.body.removeChild(floatingText);
                }, 300);
            }, 2000);
        }
        // 显示烟花效果
        function showFireworks() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createFirework(Math.random() * window.innerWidth, Math.random() * window.innerHeight);
                }, i * 300);
            }
        }
        // 创建烟花粒子
        function createFirework(x, y) {
            const colors = ['#ff9a9e', '#fad0c4', '#a18cd1', '#fbc2eb', '#6a11cb', '#2575fc'];
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // 随机方向
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                const xOffset = Math.cos(angle) * distance;
                const yOffset = Math.sin(angle) * distance;
                
                particle.style.setProperty('--x', `${xOffset}px`);
                particle.style.setProperty('--y', `${yOffset}px`);
                
                document.body.appendChild(particle);
                
                // 2秒后移除
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }
        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
