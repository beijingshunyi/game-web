<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>万花币消消乐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // 配置Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#8A5CF7', // 主色调：紫色
            secondary: '#EC4899', // 辅助色：粉色
            accent: '#F59E0B', // 强调色：橙色
            dark: '#1F2937',
            light: '#F9FAFB'
          },
          fontFamily: {
            game: ['"Nunito"', '"Comic Sans MS"', 'sans-serif']
          },
          animation: {
            'pop': 'pop 0.3s ease-out',
            'shine': 'shine 1s ease-in-out',
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            pop: {
              '0%, 100%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.2)' },
            },
            shine: {
              '0%, 100%': { opacity: 1 },
              '50%': { opacity: 0.5 },
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .game-shadow {
        box-shadow: 0 10px 25px -5px rgba(138, 92, 247, 0.1), 0 8px 10px -6px rgba(138, 92, 247, 0.1);
      }
      .tile-shadow {
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
      }
      .btn-hover {
        transition: all 0.2s ease;
      }
      .btn-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .page-transition {
        transition: opacity 0.3s ease-in-out;
      }
      .progress-bar {
        height: 8px;
        background: linear-gradient(90deg, #8A5CF7 0%, #EC4899 100%);
        transition: width 0.5s ease-in-out;
      }
      .blur-bg {
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .element-common {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 24px;
        transition: all 0.3s ease;
      }
      .special-effect {
        position: relative;
        overflow: hidden;
      }
      .special-effect::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
          to right,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0.3) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        transform: rotate(30deg);
        animation: shine 3s infinite;
      }
      @keyframes shine {
        0% { transform: translateX(-100%) rotate(30deg); }
        100% { transform: translateX(100%) rotate(30deg); }
      }
    }
  </style>
  <!-- 引入Google字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-light to-purple-50 min-h-screen font-game text-dark overflow-x-hidden">
  <!-- Telegram Web App初始化 -->
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    // 全局状态管理
    const gameState = {
      user: null,
      balance: 0,
      currentLevel: 1,
      totalScore: 0,
      gamePlays: null,
      isPlaying: false,
      gameBoard: [],
      score: 0,
      moves: 0,
      targetScore: 0,
      movesAllowed: 0,
      levelData: null,
      leaderboard: [],
      selectedTile: null,
      comboCount: 0,
      comboMultiplier: 1,
      powerUps: {
        shuffle: 0,
        bomb: 0,
        extraMoves: 0,
        skipObstacle: 0
      },
      theme: 'spring' // 关卡主题：spring, summer, autumn, winter
    };
    
    // API基础URL
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';
    
    // 工具函数 - 发起API请求
    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const url = `${API_BASE_URL}/${endpoint}`;
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(url, options);
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || '请求失败');
        
        return result;
      } catch (error) {
        console.error('API请求错误:', error);
        showToast(error.message, 'error');
        throw error;
      }
    }
    
    // 显示提示信息
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg z-50 shadow-lg transition-all duration-300 opacity-0 translate-y-4 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        type === 'warning' ? 'bg-yellow-500' : 'bg-primary'
      } text-white`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      // 显示动画
      setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
      }, 10);
      
      // 自动消失
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // 显示分数弹出动画
    function showScorePopup(points, x, y) {
      const popup = document.createElement('div');
      popup.className = 'absolute text-green-600 font-bold text-lg opacity-0 transition-all duration-500';
      popup.textContent = `+${points}`;
      popup.style.left = `${x}px`;
      popup.style.top = `${y}px`;
      document.getElementById('game-board').appendChild(popup);
      
      setTimeout(() => {
        popup.classList.remove('opacity-0');
        popup.classList.add('opacity-100', 'translate-y-[-20px]');
      }, 10);
      
      setTimeout(() => {
        popup.remove();
      }, 1000);
    }
    
    // 页面导航
    function navigateTo(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('opacity-0', 'pointer-events-none');
        setTimeout(() => {
          page.classList.add('hidden');
        }, 300);
      });
      
      const targetPage = document.getElementById(pageId);
      targetPage.classList.remove('hidden');
      setTimeout(() => {
        targetPage.classList.remove('opacity-0', 'pointer-events-none');
      }, 50);
      
      // 特殊页面处理
      if (pageId === 'game-page' && !gameState.isPlaying) {
        startGame(gameState.currentLevel);
      } else if (pageId === 'leaderboard-page') {
        loadLeaderboard();
      } else if (pageId === 'profile-page') {
        updateProfileInfo();
      } else if (pageId === 'store-page') {
        updateStoreInfo();
      }
    }
    
    // 初始化用户
    async function initUser() {
      try {
        // 从URL获取用户信息
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('user_id');
        
        if (!telegramId) {
          // 尝试从Telegram Web App获取用户信息
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            await apiRequest('login', 'POST', {
              queryId: tg.initDataUnsafe.query_id,
              userId: user.id,
              firstName: user.first_name,
              lastName: user.last_name || '',
              username: user.username || ''
            });
            window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            return;
          } else {
            navigateTo('login-page');
            return;
          }
        }
        
        // 加载用户数据
        const userData = await apiRequest(`user?telegram_id=${telegramId}`);
        gameState.user = userData.user;
        gameState.balance = userData.balance.万花币_balance;
        gameState.currentLevel = userData.progress.current_level;
        gameState.totalScore = userData.progress.total_score;
        gameState.gamePlays = userData.gamePlays;
        
        // 设置关卡主题
        setLevelTheme(gameState.currentLevel);
        
        // 更新UI
        updateUserInterface();
        
        // 导航到首页
        navigateTo('home-page');
      } catch (error) {
        console.error('初始化用户失败:', error);
        showToast('登录失败，请重试', 'error');
        navigateTo('login-page');
      }
    }
    
    // 设置关卡主题
    function setLevelTheme(level) {
      if (level <= 20) {
        gameState.theme = 'spring';
      } else if (level <= 40) {
        gameState.theme = 'summer';
      } else if (level <= 60) {
        gameState.theme = 'autumn';
      } else {
        gameState.theme = 'winter';
      }
      
      // 更新主题样式
      const themeElement = document.getElementById('theme-style');
      if (themeElement) themeElement.remove();
      
      const style = document.createElement('style');
      style.id = 'theme-style';
      
      switch(gameState.theme) {
        case 'spring':
          style.textContent = `
            .bg-theme { background-color: #D1FAE5; }
            .text-theme { color: #10B981; }
            .border-theme { border-color: #10B981; }
          `;
          break;
        case 'summer':
          style.textContent = `
            .bg-theme { background-color: #DBEAFE; }
            .text-theme { color: #3B82F6; }
            .border-theme { border-color: #3B82F6; }
          `;
          break;
        case 'autumn':
          style.textContent = `
            .bg-theme { background-color: #FEE2E2; }
            .text-theme { color: #EF4444; }
            .border-theme { border-color: #EF4444; }
          `;
          break;
        case 'winter':
          style.textContent = `
            .bg-theme { background-color: #E0E7FF; }
            .text-theme { color: #6366F1; }
            .border-theme { border-color: #6366F1; }
          `;
          break;
      }
      
      document.head.appendChild(style);
    }
    
    // 更新用户界面
    function updateUserInterface() {
      // 更新余额显示
      document.querySelectorAll('.balance-display').forEach(el => {
        el.textContent = gameState.balance;
      });
      
      // 更新当前关卡
      document.getElementById('current-level-display').textContent = gameState.currentLevel;
      
      // 更新总分数
      document.getElementById('total-score-display').textContent = gameState.totalScore;
      
      // 更新游戏次数
      if (gameState.gamePlays) {
        const remainingFreePlays = 6 - gameState.gamePlays.free_plays_used;
        document.getElementById('remaining-plays').textContent = remainingFreePlays;
      }
      
      // 更新用户头像和名称
      if (gameState.user) {
        document.querySelectorAll('.user-name').forEach(el => {
          el.textContent = gameState.user.username || gameState.user.first_name;
        });
        
        // Telegram头像
        if (tg.initDataUnsafe?.user?.photo_url) {
          document.querySelectorAll('.user-avatar').forEach(el => {
            el.src = tg.initDataUnsafe.user.photo_url;
          });
        }
      }
    }
    
    // 更新个人中心信息
    function updateProfileInfo() {
      if (!gameState.user) return;
      
      document.getElementById('profile-telegram-id').textContent = gameState.user.telegram_id;
      document.getElementById('profile-join-date').textContent = new Date(gameState.user.created_at).toLocaleDateString();
      document.getElementById('profile-total-levels').textContent = gameState.currentLevel - 1;
      
      // 计算主题进度
      let themeProgress = 0;
      let nextTheme = '';
      
      if (gameState.currentLevel <= 20) {
        themeProgress = Math.min(100, (gameState.currentLevel / 20) * 100);
        nextTheme = '夏日海滩';
      } else if (gameState.currentLevel <= 40) {
        themeProgress = Math.min(100, ((gameState.currentLevel - 20) / 20) * 100);
        nextTheme = '秋日森林';
      } else if (gameState.currentLevel <= 60) {
        themeProgress = Math.min(100, ((gameState.currentLevel - 40) / 20) * 100);
        nextTheme = '冬日雪地';
      } else {
        themeProgress = 100;
        nextTheme = '已解锁全部主题';
      }
      
      document.getElementById('theme-progress-bar').style.width = `${themeProgress}%`;
      document.getElementById('next-theme').textContent = nextTheme;
    }
    
    // 更新商店信息
    function updateStoreInfo() {
      // 道具价格和描述
      const powerUpData = [
        { id: 'shuffle', name: '洗牌道具', desc: '重新排列当前棋盘元素', cost: 30, icon: 'fa-random' },
        { id: 'bomb', name: '爆炸道具', desc: '手动选择1个元素触发爆炸特效', cost: 60, icon: 'fa-bomb' },
        { id: 'extraMoves', name: '步数加成', desc: '关卡内额外增加5步', cost: 40, icon: 'fa-plus-circle' },
        { id: 'skipObstacle', name: '障碍跳过', desc: '直接消除1个指定障碍', cost: 80, icon: 'fa-ban' }
      ];
      
      const storeGrid = document.getElementById('store-grid');
      storeGrid.innerHTML = '';
      
      powerUpData.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'bg-white rounded-xl p-4 game-shadow flex flex-col items-center text-center btn-hover';
        itemElement.innerHTML = `
          <div class="w-14 h-14 rounded-full bg-primary/10 flex items-center justify-center mb-3">
            <i class="fa ${item.icon} text-primary text-2xl"></i>
          </div>
          <h3 class="font-bold mb-1">${item.name}</h3>
          <p class="text-sm text-gray-500 mb-3">${item.desc}</p>
          <div class="flex items-center justify-center text-accent font-bold mb-3">
            <i class="fa fa-diamond mr-1"></i> ${item.cost}
          </div>
          <button onclick="buyPowerUp('${item.id}', ${item.cost})" class="w-full bg-primary hover:bg-primary/90 text-white py-2 rounded-lg transition-colors">
            购买
          </button>
        `;
        storeGrid.appendChild(itemElement);
      });
      
      // 皮肤和背景
      const skinData = [
        { id: 'colorful', name: '炫彩花朵', desc: '彩色花朵元素皮肤', cost: 300, requiredLevel: 10 },
        { id: 'spring', name: '春日花园', desc: '春天主题背景', cost: 300, requiredLevel: 20 },
        { id: 'summer', name: '夏日海滩', desc: '夏天主题背景', cost: 400, requiredLevel: 40 }
      ];
      
      const skinGrid = document.getElementById('skin-grid');
      skinGrid.innerHTML = '';
      
      skinData.forEach(item => {
        const isUnlocked = gameState.currentLevel >= item.requiredLevel;
        const itemElement = document.createElement('div');
        itemElement.className = `bg-white rounded-xl p-4 game-shadow flex flex-col items-center text-center ${!isUnlocked ? 'opacity-50' : 'btn-hover'}`;
        itemElement.innerHTML = `
          <div class="w-14 h-14 rounded-full bg-secondary/10 flex items-center justify-center mb-3">
            <i class="fa fa-paint-brush text-secondary text-2xl"></i>
          </div>
          <h3 class="font-bold mb-1">${item.name}</h3>
          <p class="text-sm text-gray-500 mb-1">${item.desc}</p>
          <p class="text-xs text-gray-500 mb-3">
            ${isUnlocked ? `需要 ${item.requiredLevel} 关` : `已解锁 ${item.requiredLevel} 关`}
          </p>
          <div class="flex items-center justify-center text-accent font-bold mb-3">
            <i class="fa fa-diamond mr-1"></i> ${item.cost}
          </div>
          <button 
            onclick="${isUnlocked ? `buySkin('${item.id}', ${item.cost})` : ''}" 
            class="w-full ${isUnlocked ? 'bg-secondary hover:bg-secondary/90' : 'bg-gray-300 cursor-not-allowed'} text-white py-2 rounded-lg transition-colors"
            ${!isUnlocked ? 'disabled' : ''}
          >
            ${isUnlocked ? '购买' : '未解锁'}
          </button>
        `;
        skinGrid.appendChild(itemElement);
      });
    }
    
    // 购买道具
    async function buyPowerUp(type, cost) {
      if (gameState.balance < cost) {
        showToast('万花币不足', 'error');
        return;
      }
      
      // 更新道具数量和余额
      gameState.powerUps[type]++;
      gameState.balance -= cost;
      
      // 更新UI
      updateUserInterface();
      showToast(`成功购买${getPowerUpName(type)}`, 'success');
      
      // 这里应该有API调用保存道具数据到服务器
    }
    
    // 购买皮肤
    async function buySkin(type, cost) {
      if (gameState.balance < cost) {
        showToast('万花币不足', 'error');
        return;
      }
      
      // 更新余额
      gameState.balance -= cost;
      
      // 更新UI
      updateUserInterface();
      showToast(`成功购买${getSkinName(type)}`, 'success');
      
      // 这里应该有API调用保存皮肤数据到服务器
    }
    
    // 获取道具名称
    function getPowerUpName(type) {
      const names = {
        shuffle: '洗牌道具',
        bomb: '爆炸道具',
        extraMoves: '步数加成',
        skipObstacle: '障碍跳过'
      };
      return names[type] || type;
    }
    
    // 获取皮肤名称
    function getSkinName(type) {
      const names = {
        colorful: '炫彩花朵',
        spring: '春日花园',
        summer: '夏日海滩'
      };
      return names[type] || type;
    }
    
    // 使用道具
    function usePowerUp(type) {
      if (!gameState.isPlaying) return;
      
      if (gameState.powerUps[type] <= 0) {
        showToast(`没有${getPowerUpName(type)}，请前往商店购买`, 'warning');
        return;
      }
      
      switch(type) {
        case 'shuffle':
          shuffleBoard();
          gameState.powerUps.shuffle--;
          showToast('已使用洗牌道具', 'info');
          break;
          
        case 'bomb':
          // 进入选择模式
          gameState.selectedPowerUp = 'bomb';
          showToast('请选择要引爆的元素', 'info');
          break;
          
        case 'extraMoves':
          gameState.movesAllowed += 5;
          gameState.powerUps.extraMoves--;
          showToast('已增加5步', 'success');
          renderGameBoard();
          break;
          
        case 'skipObstacle':
          // 进入选择模式
          gameState.selectedPowerUp = 'skipObstacle';
          showToast('请选择要消除的障碍', 'info');
          break;
      }
      
      // 更新道具显示
      updatePowerUpDisplay();
    }
    
    // 处理签到
    async function handleCheckin() {
      try {
        const result = await apiRequest('checkin', 'POST', {
          telegram_id: gameState.user.telegram_id
        });
        
        if (result.success) {
          gameState.balance = result.balance;
          showToast(`签到成功！获得${result.reward}万花币，连续签到${result.streak}天`, 'success');
          updateUserInterface();
          document.getElementById('checkin-btn').disabled = true;
          document.getElementById('checkin-btn').innerHTML = '<i class="fa fa-check mr-1"></i> 今日已签到';
          document.getElementById('checkin-btn').classList.add('bg-green-500');
          document.getElementById('checkin-btn').classList.remove('bg-accent', 'hover:bg-accent/80');
        } else {
          showToast(result.message);
        }
      } catch (error) {
        console.error('签到失败:', error);
      }
    }
    
    // 检查是否可以玩游戏
    async function checkCanPlayGame() {
      try {
        const result = await apiRequest(`game-plays?telegram_id=${gameState.user.telegram_id}`);
        return result.canPlay;
      } catch (error) {
        console.error('检查游戏次数失败:', error);
        return false;
      }
    }
    
    // 记录游戏次数
    async function recordGamePlay(type) {
      try {
        const result = await apiRequest('record-play', 'POST', {
          telegram_id: gameState.user.telegram_id,
          type
        });
        
        gameState.gamePlays = result.gamePlays;
        updateUserInterface();
        return true;
      } catch (error) {
        console.error('记录游戏次数失败:', error);
        return false;
      }
    }
    
    // 增加游戏次数 (通过广告或分享)
    async function addGamePlays(type) {
      try {
        if (type === 'ad') {
          // 显示广告逻辑
          showToast('广告播放中...');
          // 模拟广告播放
          setTimeout(async () => {
            const result = await apiRequest('add-plays', 'POST', {
              telegram_id: gameState.user.telegram_id,
              type
            });
            
            if (result.success) {
              gameState.gamePlays = result.gamePlays;
              updateUserInterface();
              showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
            } else {
              showToast(result.message);
            }
          }, 3000);
        } else if (type === 'share') {
          // 分享逻辑
          if (tg.ShareButton) {
            tg.ShareButton.show();
            tg.onEvent('shareCompleted', async () => {
              const result = await apiRequest('add-plays', 'POST', {
                telegram_id: gameState.user.telegram_id,
                type
              });
              
              if (result.success) {
                gameState.gamePlays = result.gamePlays;
                updateUserInterface();
                showToast(`获得2次游戏机会！剩余次数: ${6 - result.gamePlays.free_plays_used}`, 'success');
              } else {
                showToast(result.message);
              }
            });
          } else {
            showToast('分享功能暂不可用');
          }
        }
      } catch (error) {
        console.error('增加游戏次数失败:', error);
      }
    }
    
    // 加载关卡数据
    async function loadLevelData(levelNumber) {
      try {
        const levelData = await apiRequest(`level?level=${levelNumber}`);
        gameState.levelData = levelData;
        return levelData;
      } catch (error) {
        console.error('加载关卡数据失败:', error);
        showToast('加载关卡失败，请重试', 'error');
        return null;
      }
    }
    
    // 初始化游戏板
    function initializeGameBoard() {
      // 根据关卡决定棋盘大小
      const size = gameState.currentLevel >= 20 ? 6 : 5;
      const board = [];
      
      // 根据主题选择元素
      let elements = [];
      switch(gameState.theme) {
        case 'spring':
          elements = ['fa-leaf', 'fa-pagelines', 'fa-petal', 'fa-flower', 'fa-rose', 'fa-lotus'];
          break;
        case 'summer':
          elements = ['fa-sun-o', 'fa-umbrella', 'fa-anchor', 'fa-ship', 'fa-fish', 'fa-tint'];
          break;
        case 'autumn':
          elements = ['fa-tree', 'fa-coffee', 'fa-pumpkin', 'fa-apple', 'fa-leaf', 'fa-fire'];
          break;
        case 'winter':
          elements = ['fa-snowflake-o', 'fa-snowman', 'fa-icecream', 'fa-pagelines', 'fa-gift', 'fa-star'];
          break;
        default:
          elements = ['fa-star', 'fa-moon-o', 'fa-sun-o', 'fa-diamond', 'fa-bell', 'fa-flower'];
      }
      
      for (let i = 0; i < size; i++) {
        const row = [];
        for (let j = 0; j < size; j++) {
          // 确保不会初始形成三个相同的连线
          let element;
          do {
            element = elements[Math.floor(Math.random() * elements.length)];
          } while (
            // 检查水平方向
            (j >= 2 && row[j-1].element === element && row[j-2].element === element) ||
            // 检查垂直方向
            (i >= 2 && board[i-1][j].element === element && board[i-2][j].element === element)
          );
          
          // 根据关卡添加障碍物
          let obstacle = null;
          const obstacleChance = Math.min(0.2, (gameState.currentLevel / 100) * 0.2);
          
          if (Math.random() < obstacleChance) {
            // 根据关卡难度选择障碍物类型
            const obstacleTypes = [];
            
            if (gameState.currentLevel >= 11) obstacleTypes.push('ice');
            if (gameState.currentLevel >= 21) obstacleTypes.push('chain');
            if (gameState.currentLevel >= 31) obstacleTypes.push('box');
            if (gameState.currentLevel >= 41) obstacleTypes.push('bomb');
            
            if (obstacleTypes.length > 0) {
              obstacle = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
              
              // 为特殊障碍物添加属性
              if (obstacle === 'bomb') {
                obstacle = { type: 'bomb', timer: 5 + Math.floor(Math.random() * 5) };
              }
            }
          }
          
          row.push({
            element,
            obstacle,
            x: j,
            y: i,
            matched: false,
            selected: false,
            special: null // 特殊元素类型：line, bomb, cross
          });
        }
        board.push(row);
      }
      
      // 确保初始棋盘有可消除的组合
      let matches = findMatches(board);
      if (matches.length === 0) {
        return initializeGameBoard(); // 重新生成
      }
      
      return board;
    }
    
    // 更新道具显示
    function updatePowerUpDisplay() {
      document.getElementById('shuffle-count').textContent = gameState.powerUps.shuffle;
      document.getElementById('bomb-count').textContent = gameState.powerUps.bomb;
      document.getElementById('extraMoves-count').textContent = gameState.powerUps.extraMoves;
      document.getElementById('skipObstacle-count').textContent = gameState.powerUps.skipObstacle;
    }
    
    // 渲染游戏板
    function renderGameBoard() {
      const gameBoardElement = document.getElementById('game-board');
      gameBoardElement.innerHTML = '';
      
      // 设置网格尺寸
      const size = gameState.gameBoard.length;
      gameBoardElement.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
      
      // 更新道具显示
      updatePowerUpDisplay();
      
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          const tileElement = document.createElement('div');
          tileElement.className = `relative element-common tile-shadow cursor-pointer ${
            tile.selected ? 'ring-4 ring-accent scale-110 z-10' : ''
          } ${tile.special ? 'special-effect' : ''}`;
          
          // 根据主题设置颜色
          switch(gameState.theme) {
            case 'spring':
              tileElement.classList.add('bg-green-100', 'text-green-600');
              break;
            case 'summer':
              tileElement.classList.add('bg-blue-100', 'text-blue-600');
              break;
            case 'autumn':
              tileElement.classList.add('bg-orange-100', 'text-orange-600');
              break;
            case 'winter':
              tileElement.classList.add('bg-purple-100', 'text-purple-600');
              break;
            default:
              tileElement.classList.add('bg-purple-100', 'text-purple-600');
          }
          
          // 添加元素图标
          tileElement.innerHTML = `<i class="fa ${tile.element}"></i>`;
          
          // 特殊元素标记
          if (tile.special === 'line') {
            tileElement.innerHTML += '<div class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">L</div>';
          } else if (tile.special === 'bomb') {
            tileElement.innerHTML += '<div class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">B</div>';
          } else if (tile.special === 'cross') {
            tileElement.innerHTML += '<div class="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">X</div>';
          }
          
          // 添加障碍物
          if (tile.obstacle) {
            const obstacleType = typeof tile.obstacle === 'object' ? tile.obstacle.type : tile.obstacle;
            
            if (obstacleType === 'ice') {
              tileElement.innerHTML += '<div class="absolute inset-0 bg-blue-200/70 flex items-center justify-center"><i class="fa fa-snowflake-o text-blue-800"></i></div>';
            } else if (obstacleType === 'chain') {
              tileElement.innerHTML += '<div class="absolute inset-0 flex items-center justify-center"><i class="fa fa-link text-gray-800 text-xl"></i></div>';
            } else if (obstacleType === 'box') {
              tileElement.innerHTML += '<div class="absolute w-3/4 h-3/4 bg-gray-700 rounded-sm flex items-center justify-center"><i class="fa fa-cube text-gray-400"></i></div>';
            } else if (obstacleType === 'bomb') {
              const timer = tile.obstacle.timer;
              tileElement.innerHTML += `<div class="absolute -top-1 -right-1 bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">${timer}</div>`;
            }
          }
          
          // 保存位置数据
          tileElement.dataset.row = rowIndex;
          tileElement.dataset.col = colIndex;
          
          // 添加点击事件
          tileElement.addEventListener('click', () => handleTileClick(rowIndex, colIndex));
          
          // 添加触摸事件支持滑动
          let touchStartX = 0;
          let touchStartY = 0;
          
          tileElement.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            // 选中当前方块
            if (!gameState.selectedTile) {
              handleTileClick(rowIndex, colIndex);
            }
          });
          
          tileElement.addEventListener('touchend', (e) => {
            if (!gameState.selectedTile) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const diffX = touchEndX - touchStartX;
            const diffY = touchEndY - touchStartY;
            
            // 确定滑动方向
            let direction = '';
            if (Math.abs(diffX) > Math.abs(diffY)) {
              direction = diffX > 0 ? 'right' : 'left';
            } else {
              direction = diffY > 0 ? 'down' : 'up';
            }
            
            // 计算目标位置
            let targetRow = gameState.selectedTile.row;
            let targetCol = gameState.selectedTile.col;
            
            switch(direction) {
              case 'up': targetRow--; break;
              case 'down': targetRow++; break;
              case 'left': targetCol--; break;
              case 'right': targetCol++; break;
            }
            
            // 检查目标位置是否有效
            if (targetRow >= 0 && targetRow < gameState.gameBoard.length && 
                targetCol >= 0 && targetCol < gameState.gameBoard[0].length) {
              handleTileClick(targetRow, targetCol);
            }
          });
          
          gameBoardElement.appendChild(tileElement);
        });
      });
      
      // 更新分数和步数显示
      document.getElementById('game-score').textContent = gameState.score;
      document.getElementById('target-score').textContent = gameState.targetScore;
      document.getElementById('remaining-moves').textContent = gameState.movesAllowed - gameState.moves;
      
      // 更新进度条
      const progressPercent = Math.min(100, (gameState.score / gameState.targetScore) * 100);
      document.getElementById('level-progress').style.width = `${progressPercent}%`;
      
      // 更新连击显示
      if (gameState.comboCount > 1) {
        const comboElement = document.getElementById('combo-display');
        comboElement.textContent = `${gameState.comboCount}x 连击!`;
        comboElement.classList.remove('opacity-0');
        comboElement.classList.add('opacity-100');
        
        clearTimeout(window.comboTimeout);
        window.comboTimeout = setTimeout(() => {
          comboElement.classList.remove('opacity-100');
          comboElement.classList.add('opacity-0');
        }, 1500);
      }
      
      // 更新炸弹计时器
      updateBombTimers();
    }
    
    // 更新炸弹计时器
    function updateBombTimers() {
      let bombExists = false;
      
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          if (tile.obstacle && typeof tile.obstacle === 'object' && tile.obstacle.type === 'bomb') {
            bombExists = true;
          }
        });
      });
      
      if (!bombExists) return;
      
      // 每步减少炸弹计时器
      if (window.bombTimerInterval) clearInterval(window.bombTimerInterval);
      
      window.bombTimerInterval = setInterval(() => {
        let bombExploded = false;
        
        gameState.gameBoard.forEach(row => {
          row.forEach(tile => {
            if (tile.obstacle && typeof tile.obstacle === 'object' && tile.obstacle.type === 'bomb') {
              tile.obstacle.timer--;
              
              if (tile.obstacle.timer <= 0) {
                // 炸弹爆炸
                bombExploded = true;
                explodeBomb(tile.y, tile.x);
              }
            }
          });
        });
        
        renderGameBoard();
        
        if (bombExploded) {
          clearInterval(window.bombTimerInterval);
        }
      }, 1000);
    }
    
    // 炸弹爆炸
    function explodeBomb(row, col) {
      // 消除3x3范围内的元素
      for (let i = Math.max(0, row - 1); i <= Math.min(gameState.gameBoard.length - 1, row + 1); i++) {
        for (let j = Math.max(0, col - 1); j <= Math.min(gameState.gameBoard[0].length - 1, col + 1); j++) {
          gameState.gameBoard[i][j].matched = true;
        }
      }
      
      // 扣分
      gameState.score = Math.max(0, gameState.score - 100);
      showToast('炸弹爆炸！扣100分', 'error');
      
      // 处理匹配
      processMatches(findMatches());
    }
    
    // 处理方块点击
    function handleTileClick(row, col) {
      // 如果正在使用道具
      if (gameState.selectedPowerUp) {
        handlePowerUpUse(row, col);
        return;
      }
      
      const tile = gameState.gameBoard[row][col];
      
      // 如果点击了有障碍物的方块且不能直接消除
      if (tile.obstacle && !can消除障碍物(tile.obstacle)) {
        showToast('需要消除周围元素来破坏这个障碍物', 'info');
        return;
      }
      
      // 检查是否有已选中的方块
      if (gameState.selectedTile) {
        // 找到已选中的方块
        const { row: selectedRow, col: selectedCol } = gameState.selectedTile;
        
        // 检查是否是同一个方块
        if (selectedRow === row && selectedCol === col) {
          // 取消选择
          deselectAllTiles();
          renderGameBoard();
          return;
        }
        
        // 检查是否相邻
        if (isAdjacent(selectedRow, selectedCol, row, col)) {
          // 交换方块
          swapTiles(selectedRow, selectedCol, row, col);
          
          // 检查是否有匹配
          const matches = findMatches();
          
          if (matches.length > 0) {
            // 有匹配，处理匹配
            gameState.moves++;
            processMatches(matches);
          } else {
            // 无匹配，交换回来
            setTimeout(() => {
              swapTiles(row, col, selectedRow, selectedCol);
              deselectAllTiles();
              renderGameBoard();
            }, 300);
          }
        } else {
          // 不相邻，取消之前的选择，选择新的
          deselectAllTiles();
          tile.selected = true;
          gameState.selectedTile = { row, col };
          renderGameBoard();
        }
      } else {
        // 没有已选中的，选中当前方块
        tile.selected = true;
        gameState.selectedTile = { row, col };
        renderGameBoard();
      }
    }
    
    // 检查是否可以直接消除障碍物
    function can消除障碍物(obstacle) {
      const type = typeof obstacle === 'object' ? obstacle.type : obstacle;
      // 只有炸弹可以被直接消除
      return type === 'bomb';
    }
    
    // 处理道具使用
    function handlePowerUpUse(row, col) {
      const powerUp = gameState.selectedPowerUp;
      gameState.selectedPowerUp = null;
      
      switch(powerUp) {
        case 'bomb':
          // 引爆选中位置
          gameState.gameBoard[row][col].matched = true;
          // 创建爆炸特效匹配
          const matches = [
            [
              { row, col },
              { row: Math.max(0, row-1), col },
              { row: Math.min(gameState.gameBoard.length-1, row+1), col },
              { row, col: Math.max(0, col-1) },
              { row, col: Math.min(gameState.gameBoard[0].length-1, col+1) }
            ]
          ];
          
          gameState.powerUps.bomb--;
          processMatches(matches);
          break;
          
        case 'skipObstacle':
          // 消除选中位置的障碍物
          if (gameState.gameBoard[row][col].obstacle) {
            gameState.gameBoard[row][col].obstacle = null;
            gameState.powerUps.skipObstacle--;
            showToast('已消除障碍', 'success');
            renderGameBoard();
          } else {
            showToast('这里没有障碍物', 'warning');
            gameState.powerUps.skipObstacle++; // 返还道具
          }
          break;
      }
    }
    
    // 检查是否相邻
    function isAdjacent(row1, col1, row2, col2) {
      return (
        (Math.abs(row1 - row2) === 1 && col1 === col2) ||
        (Math.abs(col1 - col2) === 1 && row1 === row2)
      );
    }
    
    // 交换方块
    function swapTiles(row1, col1, row2, col2) {
      // 添加交换动画类
      const tile1 = document.querySelector(`[data-row="${row1}"][data-col="${col1}"]`);
      const tile2 = document.querySelector(`[data-row="${row2}"][data-col="${col2}"]`);
      
      if (tile1 && tile2) {
        tile1.classList.add('animate-pop');
        tile2.classList.add('animate-pop');
      }
      
      // 实际交换数据
      const temp = gameState.gameBoard[row1][col1];
      gameState.gameBoard[row1][col1] = gameState.gameBoard[row2][col2];
      gameState.gameBoard[row2][col2] = temp;
      
      // 更新位置信息
      gameState.gameBoard[row1][col1].x = col1;
      gameState.gameBoard[row1][col1].y = row1;
      gameState.gameBoard[row2][col2].x = col2;
      gameState.gameBoard[row2][col2].y = row2;
      
      // 重新渲染
      renderGameBoard();
      
      // 移除动画类
      setTimeout(() => {
        if (tile1 && tile2) {
          tile1.classList.remove('animate-pop');
          tile2.classList.remove('animate-pop');
        }
      }, 300);
    }
    
    // 取消所有选择
    function deselectAllTiles() {
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          tile.selected = false;
        });
      });
      gameState.selectedTile = null;
    }
    
    // 洗牌棋盘
    function shuffleBoard() {
      const size = gameState.gameBoard.length;
      let shuffledBoard = [];
      
      // 收集所有元素
      const allTiles = [];
      gameState.gameBoard.forEach(row => {
        row.forEach(tile => {
          // 保留障碍物位置
          if (tile.obstacle) {
            allTiles.push({...tile});
          } else {
            allTiles.push({
              ...tile,
              matched: false,
              selected: false,
              special: null
            });
          }
        });
      });
      
      // 打乱顺序
      for (let i = allTiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allTiles[i], allTiles[j]] = [allTiles[j], allTiles[i]];
      }
      
      // 重新构建棋盘
      shuffledBoard = [];
      let index = 0;
      
      for (let i = 0; i < size; i++) {
        const row = [];
        for (let j = 0; j < size; j++) {
          const tile = allTiles[index];
          row.push({
            ...tile,
            x: j,
            y: i
          });
          index++;
        }
        shuffledBoard.push(row);
      }
      
      // 检查是否有匹配
      let matches = findMatches(shuffledBoard);
      
      // 如果没有匹配，重新洗牌
      if (matches.length === 0) {
        return shuffleBoard();
      }
      
      // 更新棋盘
      gameState.gameBoard = shuffledBoard;
      renderGameBoard();
    }
    
    // 查找匹配
    function findMatches(board = gameState.gameBoard) {
      const matches = [];
      const size = board.length;
      
      // 标记已检查的位置，避免重复匹配
      const checked = Array(size).fill().map(() => Array(size).fill(false));
      
      // 检查水平匹配
      for (let i = 0; i < size; i++) {
        let j = 0;
        while (j < size - 2) {
          const current = board[i][j];
          const next1 = board[i][j+1];
          const next2 = board[i][j+2];
          
          if (current.element === next1.element && current.element === next2.element && 
              !checked[i][j] && !checked[i][j+1] && !checked[i][j+2]) {
            const matchLength = findMatchLength(board, i, j, 0, 1);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i, col: j + k });
              checked[i][j + k] = true;
            }
            
            matches.push(match);
            j += matchLength;
          } else {
            j++;
          }
        }
      }
      
      // 检查垂直匹配
      for (let j = 0; j < size; j++) {
        let i = 0;
        while (i < size - 2) {
          const current = board[i][j];
          const next1 = board[i+1][j];
          const next2 = board[i+2][j];
          
          if (current.element === next1.element && current.element === next2.element &&
              !checked[i][j] && !checked[i+1][j] && !checked[i+2][j]) {
            const matchLength = findMatchLength(board, i, j, 1, 0);
            const match = [];
            
            for (let k = 0; k < matchLength; k++) {
              match.push({ row: i + k, col: j });
              checked[i + k][j] = true;
            }
            
            matches.push(match);
            i += matchLength;
          } else {
            i++;
          }
        }
      }
      
      // 检查L型和T型匹配（十字特效）
      const crossMatches = findCrossMatches(board, checked);
      crossMatches.forEach(match => {
        matches.push(match);
        match.forEach(pos => {
          checked[pos.row][pos.col] = true;
        });
      });
      
      return matches;
    }
    
    // 查找十字形匹配（L型和T型）
    function findCrossMatches(board, checked) {
      const matches = [];
      const size = board.length;
      
      for (let i = 1; i < size - 1; i++) {
        for (let j = 1; j < size - 1; j++) {
          if (checked[i][j]) continue;
          
          const center = board[i][j];
          
          // 检查T型匹配
          // 水平方向有匹配，垂直方向中间有一个匹配
          if (board[i][j-1].element === center.element && board[i][j+1].element === center.element &&
              (board[i-1][j].element === center.element || board[i+1][j].element === center.element)) {
            
            const match = [{row: i, col: j}];
            
            // 添加水平匹配
            if (board[i][j-1].element === center.element) match.push({row: i, col: j-1});
            if (board[i][j+1].element === center.element) match.push({row: i, col: j+1});
            
            // 添加垂直匹配
            if (board[i-1][j].element === center.element) match.push({row: i-1, col: j});
            if (board[i+1][j].element === center.element) match.push({row: i+1, col: j});
            
            // 确保匹配至少有4个元素
            if (match.length >= 4) {
              matches.push(match);
              continue;
            }
          }
          
          // 检查L型匹配
          // 两个方向各有两个匹配
          if (board[i-1][j].element === center.element && board[i][j-1].element === center.element &&
              (board[i-1][j-1].element === center.element)) {
            matches.push([
              {row: i, col: j},
              {row: i-1, col: j},
              {row: i, col: j-1},
              {row: i-1, col: j-1}
            ]);
            continue;
          }
          
          if (board[i-1][j].element === center.element && board[i][j+1].element === center.element &&
              (board[i-1][j+1].element === center.element)) {
            matches.push([
              {row: i, col: j},
              {row: i-1, col: j},
              {row: i, col: j+1},
              {row: i-1, col: j+1}
            ]);
            continue;
          }
          
          if (board[i+1][j].element === center.element && board[i][j-1].element === center.element &&
              (board[i+1][j-1].element === center.element)) {
            matches.push([
              {row: i, col: j},
              {row: i+1, col: j},
              {row: i, col: j-1},
              {row: i+1, col: j-1}
            ]);
            continue;
          }
          
          if (board[i+1][j].element === center.element && board[i][j+1].element === center.element &&
              (board[i+1][j+1].element === center.element)) {
            matches.push([
              {row: i, col: j},
              {row: i+1, col: j},
              {row: i, col: j+1},
              {row: i+1, col: j+1}
            ]);
            continue;
          }
        }
      }
      
      return matches;
    }
    
    // 查找匹配长度
    function findMatchLength(board, startRow, startCol, rowDir, colDir) {
      const type = board[startRow][startCol].element;
      let length = 1;
      
      let currentRow = startRow + rowDir;
      let currentCol = startCol + colDir;
      
      while (
        currentRow < board.length &&
        currentCol < board[0].length &&
        board[currentRow][currentCol].element === type
      ) {
        length++;
        currentRow += rowDir;
        currentCol += colDir;
      }
      
      return length;
    }
    
    // 处理匹配
    function processMatches(matches) {
      if (matches.length === 0) {
        // 检查游戏是否结束
        checkGameEnd();
        return;
      }
      
      // 增加连击计数
      gameState.comboCount++;
      gameState.comboMultiplier = 1 + Math.floor(gameState.comboCount / 5) * 0.2;
      
      // 标记匹配的方块并计算分数
      matches.forEach(match => {
        // 确定特效类型
        let specialType = null;
        
        if (match.length >= 5) {
          specialType = 'bomb'; // 爆炸特效
        } else if (match.length >= 4) {
          specialType = 'line'; // 直线特效
        } else if (match.length === 3 && isCrossMatch(match)) {
          specialType = 'cross'; // 十字特效
        }
        
        // 随机选择一个位置放置特效
        const specialPosition = match[Math.floor(Math.random() * match.length)];
        
        match.forEach(position => {
          const tile = gameState.gameBoard[position.row][position.col];
          tile.matched = true;
          
          // 设置特效
          if (specialType && position.row === specialPosition.row && position.col === specialPosition.col) {
            tile.special = specialType;
          }
          
          // 根据匹配长度和障碍物类型计算分数
          let points = Math.floor(10 * gameState.comboMultiplier);
          if (match.length >= 4) points = Math.floor(20 * gameState.comboMultiplier);
          if (match.length >= 5) points = Math.floor(50 * gameState.comboMultiplier);
          
          if (tile.obstacle) {
            const obstacleType = typeof tile.obstacle === 'object' ? tile.obstacle.type : tile.obstacle;
            if (obstacleType === 'ice') points = Math.floor(points * 1.5);
            if (obstacleType === 'chain') points = Math.floor(points * 2);
            if (obstacleType === 'box') points = Math.floor(points * 2.5);
            if (obstacleType === 'bomb') points = Math.floor(points * 3);
          }
          
          gameState.score += points;
          
          // 显示分数弹出动画
          const tileElement = document.querySelector(`[data-row="${position.row}"][data-col="${position.col}"]`);
          if (tileElement) {
            const rect = tileElement.getBoundingClientRect();
            const boardRect = document.getElementById('game-board').getBoundingClientRect();
            showScorePopup(points, rect.left - boardRect.left + rect.width/2, rect.top - boardRect.top);
          }
        });
      });
      
      // 重新渲染以显示匹配的方块
      renderGameBoard();
      
      // 移除匹配的方块并填充新方块
      setTimeout(() => {
        removeMatchedTiles();
        fillEmptySpaces();
        
        // 检查是否有新的匹配
        setTimeout(() => {
          const newMatches = findMatches();
          
          // 如果没有新匹配，重置连击
          if (newMatches.length === 0) {
            gameState.comboCount = 0;
            gameState.comboMultiplier = 1;
          }
          
          processMatches(newMatches);
        }, 500);
      }, 500);
    }
    
    // 检查是否是十字匹配
    function isCrossMatch(match) {
      // 检查匹配是否形成L型或T型
      if (match.length < 3) return false;
      
      // 获取所有行和列
      const rows = new Set(match.map(m => m.row));
      const cols = new Set(match.map(m => m.col));
      
      // 十字匹配至少有2行和2列
      return rows.size >= 2 && cols.size >= 2;
    }
    
    // 移除匹配的方块
    function removeMatchedTiles() {
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          if (tile.matched) {
            // 处理障碍物
            if (tile.obstacle) {
              const obstacleType = typeof tile.obstacle === 'object' ? tile.obstacle.type : tile.obstacle;
              
              if (obstacleType === 'ice') {
                // 冰障碍物只需要一次匹配即可消除
                gameState.gameBoard[rowIndex][colIndex] = null;
              } else if (obstacleType === 'chain') {
                // 链条障碍物需要两次匹配
                // 这里简化为一次匹配即可消除
                gameState.gameBoard[rowIndex][colIndex] = null;
              } else if (obstacleType === 'box') {
                // 箱子障碍物需要两次匹配
                gameState.gameBoard[rowIndex][colIndex] = createNewTile(colIndex, rowIndex, true);
              } else if (obstacleType === 'bomb') {
                // 炸弹障碍物直接消除
                gameState.gameBoard[rowIndex][colIndex] = null;
              }
            } else {
              // 普通方块直接替换
              gameState.gameBoard[rowIndex][colIndex] = null;
            }
          }
        });
      });
    }
    
    // 创建新方块
    function createNewTile(x, y, isDamagedBox = false) {
      // 根据主题选择元素
      let elements = [];
      switch(gameState.theme) {
        case 'spring':
          elements = ['fa-leaf', 'fa-pagelines', 'fa-petal', 'fa-flower', 'fa-rose', 'fa-lotus'];
          break;
        case 'summer':
          elements = ['fa-sun-o', 'fa-umbrella', 'fa-anchor', 'fa-ship', 'fa-fish', 'fa-tint'];
          break;
        case 'autumn':
          elements = ['fa-tree', 'fa-coffee', 'fa-pumpkin', 'fa-apple', 'fa-leaf', 'fa-fire'];
          break;
        case 'winter':
          elements = ['fa-snowflake-o', 'fa-snowman', 'fa-icecream', 'fa-pagelines', 'fa-gift', 'fa-star'];
          break;
        default:
          elements = ['fa-star', 'fa-moon-o', 'fa-sun-o', 'fa-diamond', 'fa-bell', 'fa-flower'];
      }
      
      const element = elements[Math.floor(Math.random() * elements.length)];
      
      // 受损箱子处理
      let obstacle = null;
      if (isDamagedBox) {
        obstacle = 'box_damaged';
      }
      
      return {
        element,
        obstacle,
        x,
        y,
        matched: false,
        selected: false,
        special: null
      };
    }
    
    // 填充空白位置
    function fillEmptySpaces() {
      const size = gameState.gameBoard.length;
      
      // 处理每一列
      for (let j = 0; j < size; j++) {
        // 下落现有方块
        for (let i = size - 1; i >= 0; i--) {
          if (gameState.gameBoard[i][j] === null) {
            // 查找上方最近的非空方块
            for (let k = i - 1; k >= 0; k--) {
              if (gameState.gameBoard[k][j] !== null) {
                // 下落方块
                gameState.gameBoard[i][j] = gameState.gameBoard[k][j];
                gameState.gameBoard[k][j] = null;
                gameState.gameBoard[i][j].y = i; // 更新位置
                break;
              }
            }
          }
        }
        
        // 顶部填充新方块
        for (let i = 0; i < size; i++) {
          if (gameState.gameBoard[i][j] === null) {
            gameState.gameBoard[i][j] = createNewTile(j, i);
          }
        }
      }
      
      renderGameBoard();
    }
    
    // 检查游戏是否结束
    function checkGameEnd() {
      if (gameState.moves >= gameState.movesAllowed) {
        // 步数用完，游戏结束
        gameState.isPlaying = false;
        clearInterval(window.bombTimerInterval);
        
        if (gameState.score >= gameState.targetScore) {
          // 通关成功
          showLevelComplete();
        } else {
          // 未通关
          showLevelFailed();
        }
      } else {
        // 检查是否还有可消除的组合
        const matches = findMatches();
        if (matches.length === 0) {
          // 没有可消除的组合，自动洗牌
          showToast('没有可消除的组合，自动洗牌', 'info');
          setTimeout(() => {
            shuffleBoard();
          }, 1000);
        }
      }
    }
    
    // 显示关卡完成
    async function showLevelComplete() {
      document.getElementById('level-complete-modal').classList.remove('hidden', 'opacity-0');
      setTimeout(() => {
        document.getElementById('level-complete-modal').classList.remove('opacity-0');
      }, 10);
      
      document.getElementById('level-complete-score').textContent = gameState.score;
      
      // 计算奖励
      const baseReward = gameState.levelData.reward;
      const bonusPercentage = Math.min(100, Math.floor((gameState.score - gameState.targetScore) / gameState.targetScore * 100));
      const bonus = Math.floor(baseReward * (bonusPercentage / 100));
      const totalReward = baseReward + bonus;
      
      document.getElementById('level-reward').textContent = totalReward;
      
      // 三星评定
      const starRating = Math.min(3, Math.floor(gameState.score / gameState.targetScore));
      const starsElement = document.getElementById('level-stars');
      starsElement.innerHTML = '';
      
      for (let i = 1; i <= 3; i++) {
        const star = document.createElement('i');
        star.className = `fa fa-star text-2xl ${i <= starRating ? 'text-yellow-400 animate-pulse' : 'text-gray-300'}`;
        starsElement.appendChild(star);
      }
      
      // 提交关卡完成
      try {
        await apiRequest('complete-level', 'POST', {
          telegram_id: gameState.user.telegram_id,
          levelNumber: gameState.currentLevel,
          score: gameState.score
        });
        
        // 更新用户数据
        await initUser();
      } catch (error) {
        console.error('提交关卡完成失败:', error);
      }
    }
    
    // 显示关卡失败
    function showLevelFailed() {
      document.getElementById('level-failed-modal').classList.remove('hidden', 'opacity-0');
      setTimeout(() => {
        document.getElementById('level-failed-modal').classList.remove('opacity-0');
      }, 10);
      
      document.getElementById('failed-score').textContent = gameState.score;
      document.getElementById('failed-target').textContent = gameState.targetScore;
    }
    
    // 复活游戏
    async function reviveGame() {
      // 观看广告复活
      showToast('广告播放中...');
      
      // 模拟广告播放
      setTimeout(() => {
        document.getElementById('level-failed-modal').classList.add('opacity-0');
        setTimeout(() => {
          document.getElementById('level-failed-modal').classList.add('hidden');
          
          // 恢复5步
          gameState.movesAllowed += 5;
          gameState.isPlaying = true;
          
          // 继续游戏
          renderGameBoard();
          showToast('已获得额外5步，继续游戏！', 'success');
        }, 300);
      }, 3000);
    }
    
    // 用万花币重试
    function retryWithCoins() {
      if (gameState.balance < 50) {
        showToast('万花币不足，无法重试', 'error');
        return;
      }
      
      // 扣减万花币
      gameState.balance -= 50;
      updateUserInterface();
      
      // 关闭模态框
      document.getElementById('level-failed-modal').classList.add('opacity-0');
      setTimeout(() => {
        document.getElementById('level-failed-modal').classList.add('hidden');
        // 重新开始当前关卡
        startGame(gameState.currentLevel);
      }, 300);
    }
    
    // 开始游戏
    async function startGame(levelNumber) {
      try {
        // 检查是否可以玩游戏
        const canPlay = await checkCanPlayGame();
        if (!canPlay) {
          showToast('没有剩余游戏次数，请观看广告或分享获取更多次数', 'error');
          navigateTo('home-page');
          return;
        }
        
        // 记录游戏次数
        await recordGamePlay('free');
        
        // 加载关卡数据
        const levelData = await loadLevelData(levelNumber);
        if (!levelData) return;
        
        // 初始化游戏状态
        gameState.isPlaying = true;
        gameState.score = 0;
        gameState.moves = 0;
        gameState.targetScore = levelData.target_score;
        gameState.movesAllowed = levelData.moves_allowed;
        gameState.gameBoard = initializeGameBoard();
        gameState.comboCount = 0;
        gameState.comboMultiplier = 1;
        
        // 清除炸弹计时器
        if (window.bombTimerInterval) clearInterval(window.bombTimerInterval);
        
        // 渲染游戏
        renderGameBoard();
        
        // 显示当前关卡
        document.getElementById('current-game-level').textContent = levelNumber;
        document.getElementById('level-target-display').textContent = levelData.target_score;
      } catch (error) {
        console.error('开始游戏失败:', error);
        showToast('无法开始游戏，请重试', 'error');
        navigateTo('home-page');
      }
    }
    
    // 加载排行榜
    async function loadLeaderboard() {
      try {
        const leaderboard = await apiRequest('leaderboard');
        gameState.leaderboard = leaderboard;
        
        const leaderboardElement = document.getElementById('leaderboard-list');
        leaderboardElement.innerHTML = '';
        
        leaderboard.forEach((entry, index) => {
          const entryElement = document.createElement('div');
          entryElement.className = `flex items-center justify-between p-3 mb-2 rounded-lg ${
            index === 0 ? 'bg-yellow-100 border-2 border-yellow-400' :
            index === 1 ? 'bg-gray-100 border-2 border-gray-400' :
            index === 2 ? 'bg-orange-100 border-2 border-orange-400' :
            'bg-white'
          } btn-hover`;
          
          entryElement.innerHTML = `
            <div class="flex items-center">
              <div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center mr-3 font-bold">
                ${entry.rank}
              </div>
              <div>
                <div class="font-bold">${entry.username}</div>
                <div class="text-sm text-gray-500">总分: ${entry.score}</div>
              </div>
            </div>
            ${index === 0 ? '<i class="fa fa-trophy text-yellow-500 text-2xl"></i>' : 
              index === 1 ? '<i class="fa fa-trophy text-gray-400 text-2xl"></i>' :
              index === 2 ? '<i class="fa fa-trophy text-orange-600 text-2xl"></i>' : ''}
          `;
          
          leaderboardElement.appendChild(entryElement);
        });
        
        // 显示奖励说明
        document.getElementById('leaderboard-rewards').innerHTML = `
          <div class="p-4 bg-gray-50 rounded-lg mt-4">
            <h3 class="font-bold text-lg mb-2">月度奖励</h3>
            <div class="flex justify-between items-center mb-1">
              <span>第1名: <i class="fa fa-trophy text-yellow-500"></i></span>
              <span class="font-bold">¥100</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第2名: <i class="fa fa-trophy text-gray-400"></i></span>
              <span class="font-bold">¥50</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第3名: <i class="fa fa-trophy text-orange-600"></i></span>
              <span class="font-bold">¥30</span>
            </div>
            <div class="flex justify-between items-center mb-1">
              <span>第4名:</span>
              <span class="font-bold">¥20</span>
            </div>
            <div class="flex justify-between items-center">
              <span>第5名:</span>
              <span class="font-bold">¥10</span>
            </div>
            <div class="text-sm text-gray-500 mt-2">
              奖励将在每月最后一天以现金形式发放
            </div>
          </div>
        `;
      } catch (error) {
        console.error('加载排行榜失败:', error);
        showToast('无法加载排行榜，请重试', 'error');
      }
    }
    
    // 提交提现请求
    async function submitWithdrawal() {
      const amount = parseInt(document.getElementById('withdrawal-amount').value);
      const alipayAccount = document.getElementById('alipay-account').value;
      const alipayName = document.getElementById('alipay-name').value;
      
      if (!amount || !alipayAccount || !alipayName) {
        showToast('请填写完整信息', 'error');
        return;
      }
      
      if (amount % 1000 !== 0) {
        showToast('提现金额必须是1000的倍数', 'error');
        return;
      }
      
      if (amount < 1000) {
        showToast('最低提现金额为1000万花币', 'error');
        return;
      }
      
      if (amount > gameState.balance) {
        showToast('余额不足', 'error');
        return;
      }
      
      try {
        const result = await apiRequest('withdrawal', 'POST', {
          telegram_id: gameState.user.telegram_id,
          amount,
          alipayAccount,
          alipayName
        });
        
        if (result.success) {
          showToast('提现请求已提交，等待处理', 'success');
          // 重置表单
          document.getElementById('withdrawal-form').reset();
          // 刷新余额
          await initUser();
          // 返回首页
          navigateTo('home-page');
        } else {
          showToast(result.message, 'error');
        }
      } catch (error) {
        console.error('提交提现请求失败:', error);
        showToast('提现请求失败，请重试', 'error');
      }
    }
    
    // 加载提现历史
    async function loadWithdrawalHistory() {
      try {
        const history = await apiRequest(`withdrawal-history?telegram_id=${gameState.user.telegram_id}`);
        
        const historyElement = document.getElementById('withdrawal-history');
        historyElement.innerHTML = '';
        
        if (history.length === 0) {
          historyElement.innerHTML = '<div class="text-center py-8 text-gray-500">暂无提现记录</div>';
          return;
        }
        
        history.forEach(request => {
          const statusClass = 
            request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
            request.status === 'approved' ? 'bg-green-100 text-green-800' :
            'bg-red-100 text-red-800';
          
          const statusText = 
            request.status === 'pending' ? '处理中' :
            request.status === 'approved' ? '已批准' :
            '已拒绝';
          
          const date = new Date(request.created_at).toLocaleString();
          
          const requestElement = document.createElement('div');
          requestElement.className = 'p-3 mb-2 rounded-lg border btn-hover';
          requestElement.innerHTML = `
            <div class="flex justify-between items-center mb-1">
              <span class="font-bold">${request.amount} 万花币</span>
              <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
            </div>
            <div class="text-sm text-gray-600 mb-1">支付宝: ${request.alipay_account}</div>
            <div class="text-sm text-gray-600 mb-1">姓名: ${request.alipay_name}</div>
            <div class="text-xs text-gray-500">申请时间: ${date}</div>
          `;
          
          historyElement.appendChild(requestElement);
        });
      } catch (error) {
        console.error('加载提现历史失败:', error);
        showToast('无法加载提现历史，请重试', 'error');
      }
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', () => {
      // 绑定导航事件
      document.getElementById('home-btn').addEventListener('click', () => navigateTo('home-page'));
      document.getElementById('play-btn').addEventListener('click', () => navigateTo('game-page'));
      document.getElementById('leaderboard-nav-btn').addEventListener('click', () => navigateTo('leaderboard-page'));
      document.getElementById('withdrawal-nav-btn').addEventListener('click', () => {
        navigateTo('withdrawal-page');
        loadWithdrawalHistory();
      });
      document.getElementById('store-nav-btn').addEventListener('click', () => navigateTo('store-page'));
      
      // 个人中心按钮
      document.querySelectorAll('.profile-btn').forEach(btn => {
        btn.addEventListener('click', () => navigateTo('profile-page'));
      });
      
      // 绑定签到按钮
      document.getElementById('checkin-btn').addEventListener('click', handleCheckin);
      
      // 绑定广告和分享按钮
      document.getElementById('watch-ad-btn').addEventListener('click', () => addGamePlays('ad'));
      document.getElementById('share-btn').addEventListener('click', () => addGamePlays('share'));
      
      // 绑定道具使用按钮
      document.getElementById('use-shuffle').addEventListener('click', () => usePowerUp('shuffle'));
      document.getElementById('use-bomb').addEventListener('click', () => usePowerUp('bomb'));
      document.getElementById('use-extraMoves').addEventListener('click', () => usePowerUp('extraMoves'));
      document.getElementById('use-skipObstacle').addEventListener('click', () => usePowerUp('skipObstacle'));
      
      // 绑定提现按钮
      // 确保元素存在后再绑定事件
document.addEventListener('DOMContentLoaded', function() {
  const loginButton = document.getElementById('login-button');
  if (loginButton) { // 增加存在性检查
    loginButton.addEventListener('click', login);
  } else {
    console.error('登录按钮元素未找到，请检查HTML结构或选择器');
  }
});

      
      // 绑定游戏模态框按钮
      document.getElementById('next-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete-modal').classList.add('opacity-0');
        setTimeout(() => {
          document.getElementById('level-complete-modal').classList.add('hidden');
          startGame(gameState.currentLevel);
        }, 300);
      });
      
      document.getElementById('retry-level-btn').addEventListener('click', () => {
        document.getElementById('level-failed-modal').classList.add('opacity-0');
        setTimeout(() => {
          document.getElementById('level-failed-modal').classList.add('hidden');
          startGame(gameState.currentLevel);
        }, 300);
      });
      
      document.getElementById('exit-level-btn').addEventListener('click', () => {
        document.getElementById('level-complete-modal').classList.add('opacity-0');
        document.getElementById('level-failed-modal').classList.add('opacity-0');
        setTimeout(() => {
          document.getElementById('level-complete-modal').classList.add('hidden');
          document.getElementById('level-failed-modal').classList.add('hidden');
          navigateTo('home-page');
        }, 300);
      });
      
      // 复活和重试按钮
      document.getElementById('revive-btn').addEventListener('click', reviveGame);
      document.getElementById('retry-with-coins-btn').addEventListener('click', retryWithCoins);
      
      // 初始化用户
      initUser();
    });
  </script>
  
  <!-- 登录页面 -->
  <div id="login-page" class="page flex flex-col items-center justify-center min-h-screen p-4 page-transition">
    <div class="text-center mb-10 animate-float">
      <div class="w-20 h-20 mx-auto mb-4 bg-primary rounded-full flex items-center justify-center">
        <i class="fa fa-gamepad text-white text-4xl"></i>
      </div>
      <h1 class="text-4xl font-bold text-primary mb-2">万花币消消乐</h1>
      <p class="text-gray-600">通过Telegram账号登录</p>
    </div>
    <button id="telegram-login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full flex items-center btn-hover">
      <i class="fa fa-telegram mr-2 text-xl"></i> 用Telegram登录
    </button>
    
    <!-- 页脚信息 -->
    <div class="absolute bottom-6 left-0 right-0 text-center px-4">
      <p class="text-gray-500 text-sm">
        本游戏由北京修车【万花楼】赞助 
        <a href="https://t.me/bjxc010" target="_blank" class="text-primary font-medium">@bjxc010</a> 开发
      </p>
    </div>
  </div>
  
  <!-- 首页 -->
  <div id="home-page" class="page hidden p-4 page-transition">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-primary">万花币消消乐</h1>
      <div class="flex items-center gap-3">
        <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center">
          <i class="fa fa-diamond mr-1"></i>
          <span class="balance-display">0</span> 万花币
        </div>
        <button class="profile-btn w-10 h-10 rounded-full overflow-hidden border-2 border-primary">
          <img src="https://picsum.photos/200/200" alt="用户头像" class="user-avatar w-full h-full object-cover">
        </button>
      </div>
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">当前进度</h2>
        <button id="checkin-btn" class="bg-accent hover:bg-accent/80 text-dark font-bold py-1 px-4 rounded-full text-sm btn-hover">
          <i class="fa fa-calendar-check-o mr-1"></i> 每日签到
        </button>
      </div>
      
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-light p-4 rounded-lg border border-gray-100 game-shadow">
          <div class="text-gray-500 text-sm mb-1">当前关卡</div>
          <div class="text-2xl font-bold" id="current-level-display">1</div>
        </div>
        <div class="bg-light p-4 rounded-lg border border-gray-100 game-shadow">
          <div class="text-gray-500 text-sm mb-1">总得分</div>
          <div class="text-2xl font-bold" id="total-score-display">0</div>
        </div>
        <div class="bg-light p-4 rounded-lg border border-gray-100 game-shadow">
          <div class="text-gray-500 text-sm mb-1">今日剩余次数</div>
          <div class="text-2xl font-bold" id="remaining-plays">6</div>
        </div>
        <div class="bg-light p-4 rounded-lg border border-gray-100 game-shadow">
          <div class="text-gray-500 text-sm mb-1">兑换比例</div>
          <div class="text-2xl font-bold">1000:10元</div>
        </div>
      </div>
      
      <button id="play-btn" class="w-full bg-primary hover:bg-primary/80 text-white font-bold py-3 rounded-lg text-lg pulse-animation btn-hover">
        开始游戏
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-4 mb-6">
      <button id="watch-ad-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-play-circle text-xl text-blue-500 mb-2"></i>
        <span>观看广告</span>
        <span class="text-sm text-gray-500">+2次游戏机会</span>
      </button>
      <button id="share-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-share-alt text-xl text-green-500 mb-2"></i>
        <span>分享游戏</span>
        <span class="text-sm text-gray-500">+2次游戏机会</span>
      </button>
    </div>
    
    <div class="grid grid-cols-2 gap-4 mb-16">
      <button id="leaderboard-nav-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-trophy text-2xl text-yellow-500 mb-2"></i>
        <span class="font-bold">排行榜</span>
        <span class="text-sm text-gray-500">月度奖励</span>
      </button>
      <button id="withdrawal-nav-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-money text-2xl text-green-600 mb-2"></i>
        <span class="font-bold">提现</span>
        <span class="text-sm text-gray-500">兑换现金</span>
      </button>
      <button id="store-nav-btn" class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-shopping-bag text-2xl text-purple-500 mb-2"></i>
        <span class="font-bold">商店</span>
        <span class="text-sm text-gray-500">道具和皮肤</span>
      </button>
      <div class="bg-white p-4 rounded-xl game-shadow flex flex-col items-center justify-center">
        <i class="fa fa-gift text-2xl text-red-500 mb-2"></i>
        <span class="font-bold">每日任务</span>
        <span class="text-sm text-gray-500">完成得奖励</span>
      </div>
    </div>
    
    <!-- 底部导航 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-6 flex justify-around items-center">
      <button id="home-nav-btn" class="flex flex-col items-center text-primary">
        <i class="fa fa-home text-xl"></i>
        <span class="text-xs mt-1">首页</span>
      </button>
      <button id="play-nav-btn" class="flex flex-col items-center text-gray-500" onclick="navigateTo('game-page')">
        <i class="fa fa-gamepad text-xl"></i>
        <span class="text-xs mt-1">游戏</span>
      </button>
      <button id="leaderboard-nav-btn-2" class="flex flex-col items-center text-gray-500" onclick="navigateTo('leaderboard-page')">
        <i class="fa fa-trophy text-xl"></i>
        <span class="text-xs mt-1">排行</span>
      </button>
      <button id="withdrawal-nav-btn-2" class="flex flex-col items-center text-gray-500" onclick="navigateTo('withdrawal-page')">
        <i class="fa fa-money text-xl"></i>
        <span class="text-xs mt-1">提现</span>
      </button>
    </div>
    
    <!-- 页脚信息 -->
    <div class="absolute bottom-16 left-0 right-0 text-center px-4">
      <p class="text-gray-500 text-sm">
        本游戏由北京修车【万花楼】赞助 
        <a href="https://t.me/bjxc010" target="_blank" class="text-primary font-medium">@bjxc010</a> 开发
      </p>
    </div>
  </div>
  
  <!-- 游戏页面 -->
  <div id="game-page" class="page hidden p-2 page-transition">
    <div class="flex justify-between items-center mb-2">
      <button id="home-btn" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full btn-hover">
        <i class="fa fa-home"></i>
      </button>
      <div class="text-center">
        <h2 class="font-bold">关卡 <span id="current-game-level">1</span></h2>
        <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
          <div id="level-progress" class="progress-bar rounded-full" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1">
          目标: <span id="level-target-display">0</span> 分
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="bg-primary/10 text-primary px-2 py-1 rounded-full text-sm flex items-center">
          <i class="fa fa-diamond mr-1"></i>
          <span class="balance-display">0</span>
        </div>
        <button class="profile-btn w-8 h-8 rounded-full overflow-hidden border-2 border-primary">
          <img src="https://picsum.photos/200/200" alt="用户头像" class="user-avatar w-full h-full object-cover">
        </button>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-3 mb-3 game-shadow">
      <div class="grid grid-cols-2 gap-2 text-center">
        <div class="bg-light p-2 rounded">
          <div class="text-sm text-gray-500">当前得分</div>
          <div class="font-bold text-lg" id="game-score">0</div>
        </div>
        <div class="bg-light p-2 rounded">
          <div class="text-sm text-gray-500">目标得分</div>
          <div class="font-bold text-lg" id="target-score">0</div>
        </div>
        <div class="bg-light p-2 rounded col-span-2">
          <div class="text-sm text-gray-500">剩余步数</div>
          <div class="font-bold text-lg" id="remaining-moves">0</div>
        </div>
      </div>
    </div>
    
    <!-- 连击显示 -->
    <div id="combo-display" class="absolute top-1/4 left-1/2 transform -translate-x-1/2 bg-accent text-white px-4 py-2 rounded-full font-bold opacity-0 transition-opacity duration-300 z-10">
      3x 连击!
    </div>
    
    <div id="game-board" class="w-full aspect-square bg-light rounded-lg game-shadow grid gap-1 p-1 mb-3 overflow-hidden"></div>
    
    <!-- 道具栏 -->
    <div class="grid grid-cols-4 gap-2 mb-16">
      <button id="use-shuffle" class="bg-white p-2 rounded-lg game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-random text-primary"></i>
        <span class="text-xs mt-1">洗牌</span>
        <span class="text-xs bg-primary/10 text-primary rounded-full px-1">x<span id="shuffle-count">0</span></span>
      </button>
      <button id="use-bomb" class="bg-white p-2 rounded-lg game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-bomb text-primary"></i>
        <span class="text-xs mt-1">炸弹</span>
        <span class="text-xs bg-primary/10 text-primary rounded-full px-1">x<span id="bomb-count">0</span></span>
      </button>
      <button id="use-extraMoves" class="bg-white p-2 rounded-lg game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-plus-circle text-primary"></i>
        <span class="text-xs mt-1">加步</span>
        <span class="text-xs bg-primary/10 text-primary rounded-full px-1">x<span id="extraMoves-count">0</span></span>
      </button>
      <button id="use-skipObstacle" class="bg-white p-2 rounded-lg game-shadow flex flex-col items-center justify-center btn-hover">
        <i class="fa fa-ban text-primary"></i>
        <span class="text-xs mt-1">消障</span>
        <span class="text-xs bg-primary/10 text-primary rounded-full px-1">x<span id="skipObstacle-count">0</span></span>
      </button>
    </div>
    
    <!-- 底部导航 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-6 flex justify-around items-center">
      <button id="home-nav-btn-2" class="flex flex-col items-center text-gray-500" onclick="navigateTo('home-page')">
        <i class="fa fa-home text-xl"></i>
        <span class="text-xs mt-1">首页</span>
      </button>
      <button class="flex flex-col items-center text-primary">
        <i class="fa fa-gamepad text-xl"></i>
        <span class="text-xs mt-1">游戏</span>
      </button>
      <button class="flex flex-col items-center text-gray-500" onclick="navigateTo('leaderboard-page')">
        <i class="fa fa-trophy text-xl"></i>
        <span class="text-xs mt-1">排行</span>
      </button>
      <button class="flex flex-col items-center text-gray-500" onclick="navigateTo('store-page')">
        <i class="fa fa-shopping-bag text-xl"></i>
        <span class="text-xs mt-1">商店</span>
      </button>
    </div>
    
    <!-- 页脚信息 -->
    <div class="absolute bottom-16 left-0 right-0 text-center px-4">
      <p class="text-gray-500 text-sm">
        本游戏由北京修车【万花楼】赞助 
        <a href="https://t.me/bjxc010" target="_blank" class="text-primary font-medium">@bjxc010</a> 开发
      </p>
    </div>
  </div>
  
  <!-- 关卡完成模态框 -->
  <div id="level-complete-modal" class="fixed inset-0 bg-black/70 blur-bg flex items-center justify-center z-50 hidden p-4 opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-xl p-6 max-w-md w-full text-center transform transition-transform duration-300 scale-95">
      <div class="text-green-500 text-5xl mb-4 animate-pop">
        <i class="fa fa-trophy"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">关卡完成！</h2>
      <p class="mb-4">恭喜你通过了关卡 <span id="completed-level">1</span></p>
      
      <div id="level-stars" class="flex justify-center gap-2 mb-4">
        <!-- 星星会动态生成 -->
      </div>
      
      <div class="bg-light p-4 rounded-lg mb-6">
        <div class="mb-2">你的得分: <span id="level-complete-score" class="font-bold">0</span></div>
        <div class="text-green-600 font-bold">获得奖励: <span id="level-reward">0</span> 万花币</div>
      </div>
      
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg btn-hover">
          返回首页
        </button>
        <button id="next-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg btn-hover">
          下一关
        </button>
      </div>
    </div>
  </div>
  
  <!-- 关卡失败模态框 -->
  <div id="level-failed-modal" class="fixed inset-0 bg-black/70 blur-bg flex items-center justify-center z-50 hidden p-4 opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-xl p-6 max-w-md w-full text-center transform transition-transform duration-300 scale-95">
      <div class="text-red-500 text-5xl mb-4">
        <i class="fa fa-times-circle"></i>
      </div>
      <h2 class="text-2xl font-bold mb-2">挑战失败</h2>
      <p class="mb-4">再接再厉，争取通过关卡！</p>
      
      <div class="bg-light p-4 rounded-lg mb-6">
        <div class="mb-2">你的得分: <span id="failed-score" class="font-bold">0</span></div>
        <div class="text-red-600">目标得分: <span id="failed-target" class="font-bold">0</span></div>
      </div>
      
      <div class="grid grid-cols-2 gap-3 mb-3">
        <button id="revive-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg btn-hover">
          <i class="fa fa-play-circle mr-1"></i> 看广告复活
        </button>
        <button id="retry-with-coins-btn" class="bg-accent hover:bg-accent/80 text-dark py-3 rounded-lg btn-hover">
          <i class="fa fa-diamond mr-1"></i> 50币重试
        </button>
      </div>
      
      <div class="flex gap-3">
        <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-lg btn-hover">
          返回首页
        </button>
        <button id="retry-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-lg btn-hover">
          再试一次
        </button>
      </div>
    </div>
  </div>
  
  <!-- 排行榜页面 -->
  <div id="leaderboard-page" class="page hidden p-4 page-transition">
    <div class="flex justify-between items-center mb-6">
      <button class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full btn-hover" onclick="navigateTo('home-page')">
        <i class="fa fa-arrow-left"></i>
      </button>
      <h1 class="text-2xl font-bold text-primary">全服排行榜</h1>
      <button class="profile-btn w-8 h-8 rounded-full overflow-hidden border-2 border-primary">
        <img src="https://picsum.photos/200/200" alt="用户头像" class="user-avatar w-full h-full object-cover">
      </button>
    </div>
    
    <div class="bg-white rounded-xl p-5 game-shadow mb-16">
      <h2 class="text-xl font-bold mb-4 text-center">本月排名</h2>
      <div id="leaderboard-list" class="space-y-2"></div>
      <div id="leaderboard-rewards"></div>
    </div>
    
    <!-- 底部导航 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-6 flex justify-around items-center">
      <button class="flex flex-col items-center text-gray-500" onclick="navigateTo('home-page')">
        <i class="fa fa-home text-xl"></i>
        <span class="text-xs mt-1">首页</span>
      </button>
      <button class="flex flex-col items-center text-gray-500" onclick="navigateTo('game-page')">
        <i class="fa fa-gamepad text-xl"></i>
        <span class="text-xs mt-1">游戏</span>
      </button>
      <button class="flex flex-col items-center text-primary">
        <i class="fa fa-trophy text-xl"></i>
        <span class="text-xs mt-1">排行</span>
      </button>
      <button class="flex flex-col items-center text-gray-500" onclick="navigateTo('withdrawal-page')">
        <i class="fa fa-money text-xl"></i>
        <span class="text-xs mt-1">提现</span>
      </button>
    </div>
    
    <!-- 页脚信息 -->
    <div class="absolute bottom-16 left-0 right-0 text-center px-4">
      <p class="text-gray-500 text-sm">
        本游戏由北京修车【万花楼】赞助 
        <a href="https://t.me/bjxc010" target="_blank" class="text-primary font-medium">@bjxc010</a> 开发
      </p>
    </div>
  </div>
  
  <!-- 提现页面 -->
  <div id="withdrawal-page" class="page hidden p-4 page-transition">
    <div class="flex justify-between items-center mb-6">
      
