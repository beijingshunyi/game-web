<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram Telegram万花楼监听管理控制系统</title>
  <!-- 引入依赖（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.7.0/dist/index.css">
  <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
  <script src="https://unpkg.com/element-plus@2.7.0/dist/index.full.min.js"></script>
  <script src="https://unpkg.com/axios@1.6.8/dist/axios.min.js"></script>
  
  <!-- Tailwind 配置（iOS 风格） -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ios: {
              blue: '#007AFF',       // iOS 主蓝色
              gray: {
                50: '#F9F9FB',      // 背景色
                100: '#F2F2F7',     // 卡片背景
                200: '#E5E5EA',     // 边框色
                300: '#D1D1D6',     // 分割线
                400: '#C7C7CC',     // 次要文本
                500: '#AEAEB2',     // 图标默认色
                600: '#8E8E93',     // 辅助文本
                700: '#636366',     // 主要文本
                800: '#3A3A3C',     // 标题文本
              }
            }
          },
          borderRadius: {
            'ios': '12px',          // iOS 风格圆角
            'ios-sm': '8px',        // 小尺寸圆角
          },
          boxShadow: {
            'ios': '0 2px 10px rgba(0, 0, 0, 0.08)', // iOS 柔和阴影
            'ios-hover': '0 4px 14px rgba(0, 0, 0, 0.12)', // hover 阴影
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .ios-card {
        @apply bg-ios-gray-100 rounded-ios shadow-ios transition-shadow hover:shadow-ios-hover;
      }
      .ios-btn {
        @apply rounded-ios-sm px-4 py-2 text-sm font-medium transition-all;
      }
      .ios-btn-primary {
        @apply bg-ios-blue text-white hover:bg-opacity-90;
      }
      .ios-btn-text {
        @apply text-ios-blue hover:bg-ios-gray-100;
      }
      .ios-input {
        @apply rounded-ios-sm border-ios-gray-200 focus:border-ios-blue focus:ring-1 focus:ring-ios-blue;
      }
      .sidebar-item {
        @apply flex items-center px-4 py-3.5 text-ios-gray-700 hover:bg-ios-gray-100 cursor-pointer transition-colors;
      }
      .sidebar-item-active {
        @apply bg-ios-gray-100 border-l-4 border-ios-blue font-medium;
      }
      .page-header {
        @apply flex justify-between items-center mb-5;
      }
    }
  </style>
  
  <!-- 覆盖 Element 样式为 iOS 风格 -->
  <style>
    /* 全局样式重置 */
    body {
      background-color: #F9F9FB !important;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
    }
    
    /* Element 表格样式 */
    .el-table {
      border-radius: 12px !important;
      overflow: hidden !important;
      border: none !important;
    }
    .el-table__header-wrapper, .el-table__body-wrapper {
      border: none !important;
    }
    .el-table th {
      background-color: #F2F2F7 !important;
      color: #636366 !important;
      font-weight: 500 !important;
      border-bottom: 1px solid #E5E5EA !important;
    }
    .el-table td {
      border-bottom: 1px solid #E5E5EA !important;
      color: #3A3A3C !important;
    }
    .el-table tr:hover td {
      background-color: #F9F9FB !important;
    }
    
    /* Element 弹窗样式 */
    .el-dialog {
      border-radius: 16px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
    }
    .el-dialog__header {
      padding: 18px 20px !important;
      border-bottom: 1px solid #E5E5EA !important;
    }
    .el-dialog__title {
      font-size: 18px !important;
      color: #3A3A3C !important;
      font-weight: 500 !important;
    }
    .el-dialog__body {
      padding: 20px !important;
    }
    .el-dialog__footer {
      padding: 12px 20px !important;
      border-top: 1px solid #E5E5EA !important;
    }
    
    /* Element 按钮样式 */
    .el-button--primary {
      background-color: #007AFF !important;
      border-color: #007AFF !important;
      border-radius: 8px !important;
      padding: 6px 16px !important;
    }
    .el-button--primary:hover {
      background-color: #0066CC !important;
      border-color: #0066CC !important;
    }
    .el-button--text {
      color: #007AFF !important;
    }
    .el-button--text:hover {
      color: #0066CC !important;
      background-color: #F2F2F7 !important;
    }
    
    /* Element 输入框样式 */
    .el-input__inner {
      border-radius: 8px !important;
      border: 1px solid #E5E5EA !important;
      padding: 10px 12px !important;
      color: #3A3A3C !important;
    }
    .el-input__inner:focus {
      border-color: #007AFF !important;
      box-shadow: 0 0 0 1px #007AFF !important;
    }
    
    /* Element 开关样式 */
    .el-switch {
      height: 26px !important;
    }
    .el-switch__core {
      width: 50px !important;
      height: 26px !important;
      border-radius: 13px !important;
    }
    .el-switch__button {
      width: 22px !important;
      height: 22px !important;
      top: 2px !important;
    }
    .el-switch.is-checked .el-switch__core {
      background-color: #007AFF !important;
    }
    .el-switch.is-checked .el-switch__button {
      transform: translateX(24px) !important;
    }
    
    /* Element 分页样式 */
    .el-pagination {
      margin-top: 20px !important;
    }
    .el-pager li {
      border-radius: 8px !important;
      margin: 0 4px !important;
      min-width: 32px !important;
      height: 32px !important;
      line-height: 32px !important;
    }
    .el-pager li.active {
      background-color: #007AFF !important;
      color: white !important;
    }
  </style>
</head>

<body class="flex h-screen overflow-hidden text-ios-gray-800">
  <div id="app" class="flex w-full h-full">
    <!-- 侧边栏（iOS 风格） -->
    <div class="w-64 border-r border-ios-gray-200 bg-white flex-shrink-0">
      <!-- 侧边栏顶部 -->
      <div class="p-5 border-b border-ios-gray-200">
        <h1 class="text-xl font-semibold text-ios-gray-800">监控管理系统</h1>
      </div>
      
      <!-- 侧边栏菜单 -->
      <div class="mt-1">
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'dashboard' }"
          @click="changePage('dashboard')"
        >
          <i class="el-icon-menu mr-3 text-ios-gray-500"></i>
          <span>仪表盘</span>
        </div>
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'monitorLogs' }"
          @click="changePage('monitorLogs')"
        >
          <i class="el-icon-document mr-3 text-ios-gray-500"></i>
          <span>监控日志</span>
        </div>
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'sendRecords' }"
          @click="changePage('sendRecords')"
        >
          <i class="el-icon-message mr-3 text-ios-gray-500"></i>
          <span>发送记录</span>
        </div>
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'keywords' }"
          @click="changePage('keywords')"
        >
          <i class="el-icon-tags mr-3 text-ios-gray-500"></i>
          <span>关键词管理</span>
        </div>
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'groups' }"
          @click="changePage('groups')"
        >
          <i class="el-icon-user-group mr-3 text-ios-gray-500"></i>
          <span>群组管理</span>
        </div>
        <div 
          class="sidebar-item" 
          :class="{ 'sidebar-item-active': currentPage === 'system' }"
          @click="changePage('system')"
        >
          <i class="el-icon-cog mr-3 text-ios-gray-500"></i>
          <span>系统配置</span>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- 顶部导航栏（iOS 风格） -->
      <div class="h-14 border-b border-ios-gray-200 flex justify-end items-center px-6 bg-white">
        <el-dropdown placement="bottom-end">
          <div class="flex items-center cursor-pointer text-ios-gray-700">
            <div class="w-8 h-8 rounded-full bg-ios-gray-100 flex items-center justify-center mr-2">
              <i class="el-icon-user text-ios-gray-600"></i>
            </div>
            <span class="text-sm">管理员</span>
            <i class="el-icon-arrow-down ml-2 text-ios-gray-500"></i>
          </div>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item class="text-ios-gray-700">
                <i class="el-icon-user mr-2 text-ios-gray-500"></i>个人中心
              </el-dropdown-item>
              <el-dropdown-item class="text-ios-gray-700">
                <i class="el-icon-switch-button mr-2 text-ios-gray-500"></i>退出登录
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>

      <!-- 内容区域 -->
      <div class="flex-1 overflow-auto p-6">
        <!-- 1. 仪表盘页面 -->
        <div v-if="currentPage === 'dashboard'" class="page-content">
          <!-- 数据卡片区域 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-6">
            <!-- 今日日志卡片 -->
            <div class="ios-card p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-ios-gray-600 text-sm">今日监控日志</p>
                  <h3 class="text-2xl font-semibold mt-1">{{ dashboardData.todayLogs }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-ios-blue">
                  <i class="el-icon-document"></i>
                </div>
              </div>
              <div class="text-xs text-green-500 flex items-center">
                <i class="el-icon-arrow-up mr-1"></i> 12% 较昨日
              </div>
            </div>

            <!-- 今日发送卡片 -->
            <div class="ios-card p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-ios-gray-600 text-sm">今日发送私信</p>
                  <h3 class="text-2xl font-semibold mt-1">{{ dashboardData.todaySends }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-50 flex items-center justify-center text-green-500">
                  <i class="el-icon-message"></i>
                </div>
              </div>
              <div class="text-xs text-green-500 flex items-center">
                <i class="el-icon-arrow-up mr-1"></i> 8% 较昨日
              </div>
            </div>

            <!-- 启用关键词卡片 -->
            <div class="ios-card p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-ios-gray-600 text-sm">启用关键词</p>
                  <h3 class="text-2xl font-semibold mt-1">{{ dashboardData.activeKeywords }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-500">
                  <i class="el-icon-tags"></i>
                </div>
              </div>
              <div class="text-xs text-ios-gray-600">
                共 {{ dashboardData.totalKeywords }} 个关键词
              </div>
            </div>

            <!-- 启用群组卡片 -->
            <div class="ios-card p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <p class="text-ios-gray-600 text-sm">启用监控群组</p>
                  <h3 class="text-2xl font-semibold mt-1">{{ dashboardData.activeGroups }}</h3>
                </div>
                <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-500">
                  <i class="el-icon-user-group"></i>
                </div>
              </div>
              <div class="text-xs text-ios-gray-600">
                共 {{ dashboardData.totalGroups }} 个群组
              </div>
            </div>
          </div>

          <!-- 最近日志表格 -->
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">最近监控日志</h2>
              <el-button type="text" size="small" @click="loadDashboardData()">
                <i class="el-icon-refresh text-ios-gray-500 mr-1"></i> 刷新
              </el-button>
            </div>
            <el-table :data="dashboardData.recentLogs" border style="width: 100%;">
              <el-table-column prop="created_at" label="时间" width="170" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ formatTime(scope.row.created_at) }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="group_id" label="群组ID" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.group_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="user_id" label="用户ID" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.user_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="matched_keywords" label="匹配关键词">
                <template #default="scope">
                  <div class="flex flex-wrap gap-1">
                    <span v-for="kw in (scope.row.matched_keywords || [])" :key="kw" class="text-xs bg-blue-50 text-ios-blue px-2 py-0.5 rounded-ios-sm">
                      {{ kw }}
                    </span>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="message" label="消息内容" show-overflow-tooltip>
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.message }}</span>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- 2. 监控日志页面 -->
        <div v-if="currentPage === 'monitorLogs'" class="page-content">
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">监控日志管理</h2>
              <div class="flex items-center gap-2">
                <el-input 
                  v-model="logSearch" 
                  placeholder="搜索消息内容" 
                  size="small" 
                  class="ios-input w-48"
                  @keyup.enter="fetchMonitorLogs()"
                ></el-input>
                <el-button type="primary" size="small" @click="fetchMonitorLogs()">
                  <i class="el-icon-search mr-1"></i> 搜索
                </el-button>
              </div>
            </div>
            <el-table :data="monitorLogs" border style="width: 100%; margin-bottom: 16px;">
              <el-table-column prop="id" label="ID" width="180" align="center">
                <template #default="scope">
                  <span class="text-sm text-ios-gray-600">{{ scope.row.id?.slice(0, 8) }}...</span>
                </template>
              </el-table-column>
              <el-table-column prop="created_at" label="时间" width="170" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ formatTime(scope.row.created_at) }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="group_id" label="群组ID" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.group_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="user_id" label="用户ID" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.user_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="matched_keywords" label="匹配关键词">
                <template #default="scope">
                  <div class="flex flex-wrap gap-1">
                    <span v-for="kw in (scope.row.matched_keywords || [])" :key="kw" class="text-xs bg-blue-50 text-ios-blue px-2 py-0.5 rounded-ios-sm">
                      {{ kw }}
                    </span>
                  </div>
                </template>
              </el-table-column>
              <el-table-column prop="message" label="消息内容" show-overflow-tooltip>
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.message }}</span>
                </template>
              </el-table-column>
            </el-table>
            <el-pagination
              @size-change="handleLogSizeChange"
              @current-change="handleLogCurrentChange"
              :current-page="logPage"
              :page-sizes="[10, 20, 50]"
              :page-size="logPageSize"
              layout="total, sizes, prev, pager, next, jumper"
              :total="logTotal"
              background
            ></el-pagination>
          </div>
        </div>

        <!-- 3. 发送记录页面 -->
        <div v-if="currentPage === 'sendRecords'" class="page-content">
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">私信发送记录</h2>
              <el-button type="text" size="small" @click="fetchSendRecords()">
                <i class="el-icon-refresh text-ios-gray-500 mr-1"></i> 刷新
              </el-button>
            </div>
            <el-table :data="sendRecords" border style="width: 100%; margin-bottom: 16px;">
              <el-table-column prop="id" label="ID" width="180" align="center">
                <template #default="scope">
                  <span class="text-sm text-ios-gray-600">{{ scope.row.id?.slice(0, 8) }}...</span>
                </template>
              </el-table-column>
              <el-table-column prop="created_at" label="发送时间" width="170" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ formatTime(scope.row.created_at) }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="group_id" label="来源群组" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.group_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="user_id" label="接收用户" width="140" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.user_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="status" label="状态" width="120" align="center">
                <template #default="scope">
                  <el-tag 
                    :type="scope.row.status === 'success' ? 'success' : 'danger'"
                    class="text-xs"
                  >
                    {{ scope.row.status === 'success' ? '发送成功' : '发送失败' }}
                  </el-tag>
                </template>
              </el-table-column>
              <el-table-column prop="message" label="发送内容" show-overflow-tooltip>
                <template #default="scope">
                  <span class="text-sm">{{ (scope.row.message || '').slice(0, 50) }}...</span>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- 4. 关键词管理页面 -->
        <div v-if="currentPage === 'keywords'" class="page-content">
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">关键词管理</h2>
              <el-button type="primary" size="small" @click="openAddKeywordDialog()">
                <i class="el-icon-plus mr-1"></i> 添加关键词
              </el-button>
            </div>
            <el-table :data="keywords" border style="width: 100%; margin-bottom: 16px;">
              <el-table-column prop="id" label="ID" width="180" align="center">
                <template #default="scope">
                  <span class="text-sm text-ios-gray-600">{{ scope.row.id?.slice(0, 8) }}...</span>
                </template>
              </el-table-column>
              <el-table-column prop="keyword" label="关键词" width="200" align="center">
                <template #default="scope">
                  <span class="text-sm font-medium">{{ scope.row.keyword }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="is_active" label="状态" width="140" align="center">
                <template #default="scope">
                  <el-switch 
                    v-model="scope.row.is_active" 
                    @change="updateKeywordStatus(scope.row)"
                  ></el-switch>
                </template>
              </el-table-column>
              <el-table-column prop="created_at" label="创建时间" width="170" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ formatTime(scope.row.created_at) }}</span>
                </template>
              </el-table-column>
              <el-table-column label="操作" width="120" align="center">
                <template #default="scope">
                  <el-button 
                    type="text" 
                    size="small" 
                    @click="deleteKeyword(scope.row.id)"
                    class="text-red-500"
                  >
                    <i class="el-icon-delete mr-1"></i> 删除
                  </el-button>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- 5. 群组管理页面 -->
        <div v-if="currentPage === 'groups'" class="page-content">
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">群组管理</h2>
              <el-button type="primary" size="small" @click="openAddGroupDialog()">
                <i class="el-icon-plus mr-1"></i> 添加群组
              </el-button>
            </div>
            <el-table :data="groups" border style="width: 100%; margin-bottom: 16px;">
              <el-table-column prop="id" label="ID" width="180" align="center">
                <template #default="scope">
                  <span class="text-sm text-ios-gray-600">{{ scope.row.id?.slice(0, 8) }}...</span>
                </template>
              </el-table-column>
              <el-table-column prop="group_id" label="群组ID" width="180" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.group_id }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="group_name" label="群组名称">
                <template #default="scope">
                  <span class="text-sm">{{ scope.row.group_name || '未知群组' }}</span>
                </template>
              </el-table-column>
              <el-table-column prop="is_active" label="监控状态" width="140" align="center">
                <template #default="scope">
                  <el-switch 
                    v-model="scope.row.is_active" 
                    @change="updateGroupStatus(scope.row)"
                  ></el-switch>
                </template>
              </el-table-column>
              <el-table-column prop="created_at" label="添加时间" width="170" align="center">
                <template #default="scope">
                  <span class="text-sm">{{ formatTime(scope.row.created_at) }}</span>
                </template>
              </el-table-column>
            </el-table>
          </div>
        </div>

        <!-- 6. 系统配置页面 -->
        <div v-if="currentPage === 'system'" class="page-content">
          <div class="ios-card p-5">
            <div class="page-header">
              <h2 class="text-lg font-semibold">系统配置</h2>
              <el-button type="primary" size="small" @click="saveSystemConfig()">
                <i class="el-icon-save mr-1"></i> 保存配置
              </el-button>
            </div>
            <el-form :model="systemConfig" label-width="140px" style="width: 100%; max-width: 600px;">
              <el-form-item label="Telegram API ID" class="mb-4">
                <el-input 
                  v-model="systemConfig.telegram_api_id" 
                  class="ios-input"
                  placeholder="请输入Telegram API ID"
                ></el-input>
              </el-form-item>
              <el-form-item label="Telegram API HASH" class="mb-4">
                <el-input 
                  v-model="systemConfig.telegram_api_hash" 
                  class="ios-input"
                  placeholder="请输入Telegram API HASH"
                ></el-input>
              </el-form-item>
              <el-form-item label="Telegram 账号ID" class="mb-4">
                <el-input 
                  v-model="systemConfig.telegram_account_id" 
                  class="ios-input"
                  placeholder="请输入Telegram账号ID"
                ></el-input>
              </el-form-item>
              <el-form-item label="Worker API 地址" class="mb-4">
                <el-input 
                  v-model="systemConfig.worker_api_url" 
                  class="ios-input"
                  placeholder="https://xxx.workers.dev/api"
                ></el-input>
              </el-form-item>
            </el-form>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加关键词弹窗 -->
    <el-dialog 
      title="添加关键词" 
      :visible.sync="addKeywordVisible" 
      width="320px"
      :close-on-click-modal="false"
    >
      <el-form :model="newKeyword" label-width="70px" class="mt-2">
        <el-form-item label="关键词">
          <el-input 
            v-model="newKeyword.keyword" 
            class="ios-input"
            placeholder="请输入要监控的关键词"
          ></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button type="text" @click="addKeywordVisible = false">取消</el-button>
        <el-button type="primary" @click="addKeyword()">确定</el-button>
      </template>
    </el-dialog>

    <!-- 添加群组弹窗 -->
    <el-dialog 
      title="添加群组" 
      :visible.sync="addGroupVisible" 
      width="320px"
      :close-on-click-modal="false"
    >
      <el-form :model="newGroup" label-width="70px" class="mt-2">
        <el-form-item label="群组ID">
          <el-input 
            v-model="newGroup.group_id" 
            class="ios-input"
            placeholder="请输入群组ID（负数）"
          ></el-input>
        </el-form-item>
        <el-form-item label="群组名称">
          <el-input 
            v-model="newGroup.group_name" 
            class="ios-input"
            placeholder="请输入群组名称"
          ></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button type="text" @click="addGroupVisible = false">取消</el-button>
        <el-button type="primary" @click="addGroup()">确定</el-button>
      </template>
    </el-dialog>
  </div>

  <script>
    // 1. 从Element Plus中导入所需组件
    const { 
      ElMessageBox, 
      ElMessage 
    } = ElementPlus;

    // 2. 初始化Axios（核心：修复CORS问题，移除credentials: include）
    const api = axios.create({
      baseURL: 'https://wanhua-game.bingkuijing.workers.dev/api',
      headers: {
        'Content-Type': 'application/json'
      },
      // 关键修复：删除 credentials: 'include'，避免跨域请求携带Cookie导致CORS错误
      withCredentials: false
    });

    // 3. 初始化Vue实例
    const { createApp, ref, onMounted, reactive, toRefs } = Vue;
    const app = createApp({
      setup() {
        // 4. 全局状态（初始化所有数组为[]）
        const state = reactive({
          // 页面切换
          currentPage: 'dashboard',
          
          // 仪表盘数据
          dashboardData: {
            todayLogs: 0,
            todaySends: 0,
            activeKeywords: 0,
            totalKeywords: 0,
            activeGroups: 0,
            totalGroups: 0,
            recentLogs: []
          },
          
          // 监控日志数据
          monitorLogs: [],
          logPage: 1,
          logPageSize: 10,
          logTotal: 0,
          logSearch: '',
          
          // 发送记录数据
          sendRecords: [],
          
          // 关键词数据
          keywords: [],
          addKeywordVisible: false,
          newKeyword: { keyword: '' },
          
          // 群组数据
          groups: [],
          addGroupVisible: false,
          newGroup: { group_id: '', group_name: '未知群组' },
          
          // 系统配置数据
          systemConfig: {}
        });

        // 5. 页面切换方法
        const changePage = (page) => {
          state.currentPage = page;
          ElMessage.info(`加载${getPageName(page)}中...`);
          switch(page) {
            case 'dashboard':
              loadDashboardData();
              break;
            case 'monitorLogs':
              fetchMonitorLogs();
              break;
            case 'sendRecords':
              fetchSendRecords();
              break;
            case 'keywords':
              fetchKeywords();
              break;
            case 'groups':
              fetchGroups();
              break;
            case 'system':
              fetchSystemConfig();
              break;
          }
        };

        // 辅助函数：获取页面名称
        const getPageName = (page) => {
          const pageMap = {
            'dashboard': '仪表盘',
            'monitorLogs': '监控日志',
            'sendRecords': '发送记录',
            'keywords': '关键词管理',
            'groups': '群组管理',
            'system': '系统配置'
          };
          return pageMap[page] || '数据';
        };

        // 6. 工具函数：格式化时间
        const formatTime = (timeStr) => {
          if (!timeStr) return '暂无时间';
          try {
            const date = new Date(timeStr);
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          } catch (e) {
            return '时间格式错误';
          }
        };

        // 7. 仪表盘数据加载
        const loadDashboardData = async () => {
          try {
            // 加载监控日志（最近10条）
            const logRes = await api.get('/logs/monitor?limit=10');
            state.dashboardData.recentLogs = Array.isArray(logRes.data.logs) ? logRes.data.logs : [];
            state.dashboardData.todayLogs = typeof logRes.data.total === 'number' ? logRes.data.total : 0;
            
            // 加载发送记录
            const sendRes = await api.get('/logs/send');
            state.dashboardData.todaySends = Array.isArray(sendRes.data) ? sendRes.data.length : 0;
            
            // 加载关键词
            const keywordRes = await api.get('/config/keywords');
            const keywords = Array.isArray(keywordRes.data) ? keywordRes.data : [];
            state.dashboardData.totalKeywords = keywords.length;
            state.dashboardData.activeKeywords = keywords.filter(k => k.is_active).length;
            
            // 加载群组
            const groupRes = await api.get('/config/groups');
            const groups = Array.isArray(groupRes.data) ? groupRes.data : [];
            state.dashboardData.totalGroups = groups.length;
            state.dashboardData.activeGroups = groups.filter(g => g.is_active).length;
            
            ElMessage.success('仪表盘数据加载成功');
          } catch (error) {
            console.error('仪表盘加载错误:', error);
            // 错误时重置数据为安全值
            state.dashboardData.recentLogs = [];
            state.dashboardData.todayLogs = 0;
            state.dashboardData.todaySends = 0;
            // 区分CORS错误并给出明确提示
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('数据加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`仪表盘加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 8. 监控日志加载
        const fetchMonitorLogs = async () => {
          try {
            let url = `/logs/monitor?page=${state.logPage}&limit=${state.logPageSize}`;
            if (state.logSearch) {
              url += `&search=${encodeURIComponent(state.logSearch)}`;
            }
            
            const res = await api.get(url);
            state.monitorLogs = Array.isArray(res.data.logs) ? res.data.logs : [];
            state.logTotal = typeof res.data.total === 'number' ? res.data.total : 0;
            
            ElMessage.success(`加载到 ${state.monitorLogs.length} 条日志`);
          } catch (error) {
            console.error('日志加载错误:', error);
            state.monitorLogs = [];
            state.logTotal = 0;
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('日志加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`日志加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 监控日志分页事件
        const handleLogSizeChange = (val) => {
          state.logPageSize = val;
          fetchMonitorLogs();
        };

        const handleLogCurrentChange = (val) => {
          state.logPage = val;
          fetchMonitorLogs();
        };

        // 9. 发送记录加载
        const fetchSendRecords = async () => {
          try {
            const res = await api.get('/logs/send');
            state.sendRecords = Array.isArray(res.data) ? res.data : [];
            ElMessage.success(`加载到 ${state.sendRecords.length} 条发送记录`);
          } catch (error) {
            console.error('发送记录加载错误:', error);
            state.sendRecords = [];
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('发送记录加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`发送记录加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 10. 关键词管理
        const fetchKeywords = async () => {
          try {
            const res = await api.get('/config/keywords');
            state.keywords = Array.isArray(res.data) ? res.data : [];
            ElMessage.success(`加载到 ${state.keywords.length} 个关键词`);
          } catch (error) {
            console.error('关键词加载错误:', error);
            state.keywords = [];
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('关键词加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`关键词加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 打开添加关键词弹窗
        const openAddKeywordDialog = () => {
          state.newKeyword.keyword = '';
          state.addKeywordVisible = true;
        };

        // 添加关键词
        const addKeyword = async () => {
          if (!state.newKeyword.keyword.trim()) {
            ElMessage.warning('请输入关键词');
            return;
          }

          try {
            await api.post('/config/keywords', {
              keyword: state.newKeyword.keyword.trim(),
              is_active: true
            });
            
            state.addKeywordVisible = false;
            fetchKeywords();
            ElMessage.success('关键词添加成功');
          } catch (error) {
            console.error('添加关键词错误:', error);
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('添加关键词失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`添加失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 更新关键词状态
        const updateKeywordStatus = async (keyword) => {
          try {
            await api.patch('/config/keywords', {
              id: keyword.id,
              is_active: keyword.is_active
            });
            ElMessage.success('状态更新成功');
          } catch (error) {
            console.error('更新关键词错误:', error);
            // 回滚状态
            keyword.is_active = !keyword.is_active;
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('更新关键词失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`更新失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 删除关键词
        const deleteKeyword = async (id) => {
          try {
            await ElMessageBox.confirm(
              '确定要删除该关键词吗？删除后将不再监控此关键词',
              '提示',
              {
                confirmButtonText: '确定',
                cancelButtonText: '取消',
                type: 'warning'
              }
            );

            await api.delete(`/config/keywords?id=${id}`);
            fetchKeywords();
            ElMessage.success('关键词删除成功');
          } catch (error) {
            if (error.name !== 'Cancel') {
              console.error('删除关键词错误:', error);
              if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                ElMessage.error('删除关键词失败：跨域访问被拒绝，请检查Worker配置');
              } else {
                ElMessage.error(`删除失败: ${error.message.slice(0, 50)}`);
              }
            }
          }
        };

        // 11. 群组管理
        const fetchGroups = async () => {
          try {
            const res = await api.get('/config/groups');
            state.groups = Array.isArray(res.data) ? res.data : [];
            ElMessage.success(`加载到 ${state.groups.length} 个群组`);
          } catch (error) {
            console.error('群组加载错误:', error);
            state.groups = [];
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('群组加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`群组加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 打开添加群组弹窗
        const openAddGroupDialog = () => {
          state.newGroup.group_id = '';
          state.newGroup.group_name = '未知群组';
          state.addGroupVisible = true;
        };

        // 添加群组
        const addGroup = async () => {
          if (!state.newGroup.group_id.trim() || isNaN(Number(state.newGroup.group_id))) {
            ElMessage.warning('请输入有效的群组ID（数字）');
            return;
          }

          try {
            await api.post('/config/groups', {
              group_id: Number(state.newGroup.group_id.trim()),
              group_name: state.newGroup.group_name.trim() || '未知群组',
              is_active: true
            });
            
            state.addGroupVisible = false;
            fetchGroups();
            ElMessage.success('群组添加成功');
          } catch (error) {
            console.error('添加群组错误:', error);
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('添加群组失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`添加失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 更新群组状态
        const updateGroupStatus = async (group) => {
          try {
            await api.patch('/config/groups', {
              id: group.id,
              is_active: group.is_active
            });
            ElMessage.success('状态更新成功');
          } catch (error) {
            console.error('更新群组错误:', error);
            // 回滚状态
            group.is_active = !group.is_active;
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('更新群组失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`更新失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 12. 系统配置
        const fetchSystemConfig = async () => {
          try {
            const res = await api.get('/config/system');
            const configMap = {};
            if (Array.isArray(res.data)) {
              res.data.forEach(item => {
                configMap[item.config_key] = item.config_value;
              });
            }
            // 设置默认值
            configMap.worker_api_url = configMap.worker_api_url || 'https://wanhua-game.bingkuijing.workers.dev/api';
            state.systemConfig = configMap;
            ElMessage.success('系统配置加载成功');
          } catch (error) {
            console.error('配置加载错误:', error);
            state.systemConfig = {};
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('配置加载失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`配置加载失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 保存系统配置
        const saveSystemConfig = async () => {
          try {
            // 转换为数组格式批量更新
            const configList = Object.entries(state.systemConfig).map(([key, value]) => ({
              config_key: key,
              config_value: value
            }));

            // 逐个更新配置
            for (const config of configList) {
              const res = await api.get(`/config/system?config_key=${config.config_key}`);
              if (Array.isArray(res.data) && res.data.length > 0) {
                await api.patch('/config/system', {
                  id: res.data[0].id,
                  config_value: config.config_value
                });
              }
            }

            ElMessage.success('系统配置保存成功');
          } catch (error) {
            console.error('保存配置错误:', error);
            if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
              ElMessage.error('保存配置失败：跨域访问被拒绝，请检查Worker配置');
            } else {
              ElMessage.error(`保存失败: ${error.message.slice(0, 50)}`);
            }
          }
        };

        // 13. 初始化加载仪表盘数据
        onMounted(() => {
          loadDashboardData();
        });

        return {
          ...toRefs(state),
          changePage,
          formatTime,
          loadDashboardData,
          fetchMonitorLogs,
          handleLogSizeChange,
          handleLogCurrentChange,
          fetchSendRecords,
          fetchKeywords,
          openAddKeywordDialog,
          addKeyword,
          updateKeywordStatus,
          deleteKeyword,
          fetchGroups,
          openAddGroupDialog,
          addGroup,
          updateGroupStatus,
          fetchSystemConfig,
          saveSystemConfig
        };
      }
    });

    // 14. 全局注册Element Plus组件
    app.use(ElementPlus);
    app.mount('#app');
  </script>
</body>
</html>
