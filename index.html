<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>万花币消消乐</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Tailwind配置（万花主题色+游戏风格）
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#E879F9', // 粉紫主色
            secondary: '#60A5FA', // 浅蓝辅助色
            accent: '#FBBF24', // 暖黄强调色
            dark: '#1E293B',
            light: '#F8FAFC',
            flower: '#EC4899', // 花朵红
            star: '#F59E0B', // 星星黄
            moon: '#8B5CF6', // 月亮紫
            sun: '#EF4444', // 太阳红
            gem: '#10B981', // 宝石绿
            bell: '#3B82F6' // 铃铛蓝
          },
          fontFamily: {
            game: ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif']
          },
          boxShadow: {
            'game': '0 8px 24px rgba(149, 157, 165, 0.2)',
            'card': '0 4px 12px rgba(149, 157, 165, 0.15)',
            'btn': '0 2px 8px rgba(232, 121, 249, 0.4)'
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto { content-visibility: auto; }
      .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      .bg-gradient-game { background: linear-gradient(135deg, #F0ABFC 0%, #60A5FA 100%); }
      .tile-hover { transform: scale(1.08); transition: transform 0.2s ease; }
      .tile-active { transform: scale(1.1); box-shadow: 0 0 12px rgba(232, 121, 249, 0.6); }
      .particle { position: absolute; pointer-events: none; animation: particle 0.8s ease-out forwards; }
      .shuffle-animation { animation: shuffle 0.5s ease-in-out; }
      .progress-bar { transition: width 0.5s ease; }
      .btn-hover { transition: all 0.3s ease; }
      .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(232, 121, 249, 0.5); }
      .card-hover { transition: all 0.3s ease; }
      .card-hover:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(149, 157, 165, 0.2); }
      .level-lock { position: relative; }
      .level-lock::after {
        content: '\f023';
        font-family: 'FontAwesome';
        position: absolute;
        inset-0 flex items-center justify-center;
        background: rgba(0,0,0,0.5);
        color: white;
        font-size: 24px;
        border-radius: 8px;
      }
    }

    /* 粒子特效（消除反馈） */
    @keyframes particle {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(0.5); }
    }

    /* 洗牌动画 */
    @keyframes shuffle {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(10deg); }
      100% { transform: rotate(0deg); }
    }

    /* 消除动画 */
    @keyframes eliminate {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }

    .eliminate { animation: eliminate 0.3s ease-out forwards; }

    /* 特效动画（直线/爆炸/十字） */
    @keyframes lineEffect {
      0% { transform: scaleX(0); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: scaleX(1); opacity: 0; }
    }

    .line-effect { animation: lineEffect 0.5s ease-out forwards; transform-origin: left; }

    @keyframes bombEffect {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.5); opacity: 0.8; }
      100% { transform: scale(2); opacity: 0; }
    }

    .bomb-effect { 
      animation: bombEffect 0.6s ease-out forwards; 
      position: absolute; 
      border-radius: 50%; 
      background: rgba(245, 158, 11, 0.6); 
      z-index: 10;
    }

    @keyframes crossEffect {
      0% { transform: scale(0); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    .cross-effect { 
      animation: crossEffect 0.6s ease-out forwards; 
      position: absolute; 
      z-index: 10;
    }
  </style>
</head>
<body class="bg-light min-h-screen font-game text-dark overflow-x-hidden">
  <!-- 公共底部（所有页面都会显示） -->
  <div class="fixed bottom-0 left-0 right-0 bg-white py-2 px-4 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] z-40">
    <div class="text-center text-sm text-gray-600">
      本游戏由北京修车【万花楼】赞助 
      <a href="tg://resolve?domain=bjxc010" class="text-primary font-medium hover:underline" target="_blank">
        由 @bjxc010 开发
      </a>
    </div>
  </div>

  <!-- 页面容器（底部留空避免被遮挡） -->
  <div class="pb-12">
    <!-- 1. 登录页面 -->
    <div id="login-page" class="page flex flex-col items-center justify-center min-h-screen p-4">
      <div class="w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-24 h-24 bg-gradient-game rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fa fa-pagelines text-white text-4xl"></i>
          </div>
          <h1 class="text-3xl font-bold text-dark text-shadow mb-2">万花币消消乐</h1>
          <p class="text-gray-500">通过Telegram账号快速登录</p>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-game">
          <button id="telegram-login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center btn-hover">
            <i class="fa fa-telegram mr-2 text-xl"></i> 用Telegram账号登录
          </button>
          <div class="text-center text-xs text-gray-400 mt-4">
            登录即表示同意游戏用户协议
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 首页 -->
    <div id="home-page" class="page hidden p-4">
      <!-- 顶部导航（含个人中心入口） -->
      <div class="flex justify-between items-center mb-6 pt-2">
        <h1 class="text-2xl font-bold text-dark text-shadow">万花币消消乐</h1>
        <div class="flex items-center gap-3">
          <!-- 余额显示 -->
          <div class="bg-primary/10 text-primary px-3 py-1.5 rounded-full flex items-center text-sm">
            <i class="fa fa-diamond mr-1"></i>
            <span class="balance-display">0</span> 万花币
          </div>
          <!-- 个人中心入口（右上角） -->
          <button id="personal-center-btn" class="w-10 h-10 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('personal-center-page')">
            <i class="fa fa-user text-primary"></i>
          </button>
        </div>
      </div>

      <!-- 游戏进度卡片 -->
      <div class="bg-white rounded-2xl p-5 shadow-game mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">当前进度</h2>
          <button id="checkin-btn" class="bg-accent hover:bg-accent/80 text-dark font-bold py-1.5 px-4 rounded-full text-sm btn-hover flex items-center">
            <i class="fa fa-calendar mr-1"></i> 每日签到
            <span class="ml-1 bg-white text-xs px-1.5 py-0.5 rounded-full">x<span id="checkin-streak">0</span></span>
          </button>
        </div>

        <!-- 进度数据 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">当前关卡</div>
            <div class="text-2xl font-bold current-level-display">1</div>
          </div>
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">总得分</div>
            <div class="text-2xl font-bold total-score-display">0</div>
          </div>
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">今日剩余次数</div>
            <div class="text-2xl font-bold remaining-plays">6</div>
          </div>
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">兑换比例</div>
            <div class="text-2xl font-bold">1000:10元</div>
          </div>
        </div>

        <!-- 开始游戏按钮 -->
        <button id="play-btn" class="w-full bg-gradient-game text-white font-bold py-3.5 rounded-xl text-lg btn-hover shadow-btn flex items-center justify-center" onclick="navigateTo('game-page')">
          <i class="fa fa-play-circle mr-2"></i> 开始游戏
        </button>
      </div>

      <!-- 功能入口（广告/分享/排行榜/提现） -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <button id="watch-ad-btn" class="bg-white p-4 rounded-2xl shadow-card flex flex-col items-center justify-center btn-hover">
          <div class="w-12 h-12 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mb-2">
            <i class="fa fa-play-circle text-xl"></i>
          </div>
          <span class="font-medium">观看广告</span>
          <span class="text-xs text-gray-500">+2次游戏机会</span>
        </button>
        <button id="share-btn" class="bg-white p-4 rounded-2xl shadow-card flex flex-col items-center justify-center btn-hover">
          <div class="w-12 h-12 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-2">
            <i class="fa fa-share-alt text-xl"></i>
          </div>
          <span class="font-medium">分享游戏</span>
          <span class="text-xs text-gray-500">+2次游戏机会</span>
        </button>
        <button id="leaderboard-nav-btn" class="bg-white p-4 rounded-2xl shadow-card flex flex-col items-center justify-center btn-hover" onclick="navigateTo('leaderboard-page')">
          <div class="w-12 h-12 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center mb-2">
            <i class="fa fa-trophy text-xl"></i>
          </div>
          <span class="font-medium">排行榜</span>
          <span class="text-xs text-gray-500">月度现金奖励</span>
        </button>
        <button id="withdrawal-nav-btn" class="bg-white p-4 rounded-2xl shadow-card flex flex-col items-center justify-center btn-hover" onclick="navigateTo('withdrawal-page')">
          <div class="w-12 h-12 bg-green-100 text-green-500 rounded-full flex items-center justify-center mb-2">
            <i class="fa fa-money text-xl"></i>
          </div>
          <span class="font-medium">提现</span>
          <span class="text-xs text-gray-500">支付宝兑换</span>
        </button>
      </div>

      <!-- 关卡预览（前5关） -->
      <div class="bg-white rounded-2xl p-5 shadow-game">
        <h2 class="text-xl font-bold mb-4">关卡预览</h2>
        <div class="grid grid-cols-5 gap-2">
          <button class="level-btn bg-primary/10 text-primary rounded-lg p-2 flex items-center justify-center font-bold btn-hover" onclick="startGame(1)">1</button>
          <button class="level-btn bg-primary/10 text-primary rounded-lg p-2 flex items-center justify-center font-bold btn-hover" onclick="startGame(2)">2</button>
          <button class="level-btn bg-primary/10 text-primary rounded-lg p-2 flex items-center justify-center font-bold btn-hover" onclick="startGame(3)">3</button>
          <button class="level-btn bg-primary/10 text-primary rounded-lg p-2 flex items-center justify-center font-bold btn-hover" onclick="startGame(4)">4</button>
          <button class="level-btn bg-primary/10 text-primary rounded-lg p-2 flex items-center justify-center font-bold btn-hover" onclick="startGame(5)">5</button>
        </div>
      </div>
    </div>

    <!-- 3. 游戏页面 -->
    <div id="game-page" class="page hidden p-4">
      <!-- 顶部导航 -->
      <div class="flex justify-between items-center mb-4 pt-2">
        <button id="game-home-btn" class="w-10 h-10 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('home-page')">
          <i class="fa fa-arrow-left text-dark"></i>
        </button>
        <div class="text-center">
          <h2 class="font-bold text-lg">关卡 <span id="current-game-level" class="current-level-display">1</span></h2>
        </div>
        <div class="flex items-center gap-2">
          <!-- 余额显示 -->
          <div class="bg-primary/10 text-primary px-2.5 py-1 rounded-full flex items-center text-xs">
            <i class="fa fa-diamond mr-1"></i>
            <span class="balance-display">0</span>
          </div>
          <!-- 个人中心入口 -->
          <button class="w-8 h-8 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('personal-center-page')">
            <i class="fa fa-user text-primary text-xs"></i>
          </button>
        </div>
      </div>

      <!-- 游戏状态面板 -->
      <div class="bg-white rounded-2xl p-4 shadow-game mb-4 mx-auto max-w-md">
        <div class="grid grid-cols-2 gap-3">
          <!-- 得分 -->
          <div class="bg-light p-3 rounded-xl">
            <div class="text-gray-500 text-xs mb-1">当前得分</div>
            <div class="font-bold text-lg" id="game-score">0</div>
          </div>
          <!-- 目标 -->
          <div class="bg-light p-3 rounded-xl">
            <div class="text-gray-500 text-xs mb-1" id="target-label">目标得分</div>
            <div class="font-bold text-lg" id="target-value">0</div>
          </div>
          <!-- 步数 -->
          <div class="bg-light p-3 rounded-xl">
            <div class="text-gray-500 text-xs mb-1">剩余步数</div>
            <div class="font-bold text-lg" id="remaining-moves">0</div>
          </div>
          <!-- 时间（限时关卡显示） -->
          <div class="bg-light p-3 rounded-xl hidden" id="time-container">
            <div class="text-gray-500 text-xs mb-1">剩余时间</div>
            <div class="font-bold text-lg text-red-500" id="time-left">00:00</div>
          </div>
        </div>

        <!-- 进度条 -->
        <div class="mt-3">
          <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1">
            <div id="game-progress-bar" class="bg-primary h-1.5 rounded-full progress-bar" style="width: 0%"></div>
          </div>
          <div class="text-xs text-gray-500" id="progress-text">0/0</div>
        </div>
      </div>

      <!-- 游戏棋盘（居中） -->
      <div class="flex justify-center mb-4">
        <div id="game-board" class="grid gap-1 p-2 bg-gray-100 rounded-2xl shadow-game"></div>
      </div>

      <!-- 道具栏 -->
      <div class="max-w-md mx-auto bg-white rounded-2xl p-3 shadow-game mb-4 overflow-x-auto">
        <div class="flex gap-2">
          <button id="道具-shuffle-btn" class="flex-shrink-0 bg-light rounded-xl px-3 py-2 flex items-center btn-hover" onclick="use道具('shuffle')">
            <i class="fa fa-refresh text-primary mr-1"></i>
            <span class="text-sm">洗牌道具 (30币)</span>
          </button>
          <button id="道具-bomb-btn" class="flex-shrink-0 bg-light rounded-xl px-3 py-2 flex items-center btn-hover" onclick="use道具('bomb')">
            <i class="fa fa-bomb text-accent mr-1"></i>
            <span class="text-sm">爆炸特效 (60币)</span>
          </button>
          <button id="道具-add_steps-btn" class="flex-shrink-0 bg-light rounded-xl px-3 py-2 flex items-center btn-hover" onclick="use道具('add_steps')">
            <i class="fa fa-plus text-green-500 mr-1"></i>
            <span class="text-sm">步数加成 (40币)</span>
          </button>
          <button id="道具-skip_obstacle-btn" class="flex-shrink-0 bg-light rounded-xl px-3 py-2 flex items-center btn-hover" onclick="use道具('skip_obstacle')">
            <i class="fa fa-ban text-red-500 mr-1"></i>
            <span class="text-sm">障碍跳过 (80币)</span>
          </button>
        </div>
      </div>

      <!-- 底部操作按钮 -->
      <div class="max-w-md mx-auto flex gap-3">
        <button id="game-restart-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-dark font-bold py-2.5 rounded-xl btn-hover" onclick="startGame(gameState.currentLevel)">
          <i class="fa fa-refresh mr-1"></i> 重新开始
        </button>
        <button id="game-exit-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white font-bold py-2.5 rounded-xl btn-hover" onclick="navigateTo('home-page')">
          <i class="fa fa-home mr-1"></i> 退出关卡
        </button>
      </div>
    </div>

    <!-- 4. 个人中心页面 -->
    <div id="personal-center-page" class="page hidden p-4">
      <!-- 顶部导航 -->
      <div class="flex justify-between items-center mb-6 pt-2">
        <button class="w-10 h-10 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('home-page')">
          <i class="fa fa-arrow-left text-dark"></i>
        </button>
        <h1 class="text-2xl font-bold text-dark text-shadow">个人中心</h1>
        <div class="w-10"></div> <!-- 占位 -->
      </div>

      <!-- 用户信息卡片 -->
      <div class="bg-white rounded-2xl p-5 shadow-game mb-6">
        <div class="flex items-center gap-4">
          <!-- 用户头像 -->
          <div class="w-20 h-20 rounded-full overflow-hidden border-4 border-primary/20">
            <img id="user-avatar" src="https://via.placeholder.com/100" alt="用户头像" class="w-full h-full object-cover">
          </div>
          <!-- 用户信息 -->
          <div>
            <h2 id="user-name" class="text-xl font-bold">未登录</h2>
            <p id="user-telegram-id" class="text-gray-500 text-sm">@telegram_id</p>
            <div class="mt-2 flex items-center gap-2">
              <div class="bg-primary/10 text-primary px-3 py-1 rounded-full flex items-center text-sm">
                <i class="fa fa-diamond mr-1"></i>
                <span class="balance-display">0</span> 万花币
              </div>
              <div class="bg-accent/10 text-accent px-3 py-1 rounded-full flex items-center text-sm">
                <i class="fa fa-calendar mr-1"></i>
                连续签到 <span id="personal-streak">0</span> 天
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 游戏统计 -->
      <div class="bg-white rounded-2xl p-5 shadow-game mb-6">
        <h2 class="text-xl font-bold mb-4">游戏统计</h2>
        <div class="grid grid-cols-3 gap-3">
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">已通关卡</div>
            <div class="text-2xl font-bold" id="stat-levels">0</div>
          </div>
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">总得分</div>
            <div class="text-2xl font-bold" id="stat-score">0</div>
          </div>
          <div class="bg-light p-4 rounded-xl border border-gray-100 card-hover">
            <div class="text-gray-500 text-xs mb-1">最长签到</div>
            <div class="text-2xl font-bold" id="stat-streak">0</div>
          </div>
        </div>
      </div>

      <!-- 成就列表 -->
      <div class="bg-white rounded-2xl p-5 shadow-game">
        <h2 class="text-xl font-bold mb-4">我的成就</h2>
        <div id="achievements-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
          <!-- 成就内容由JS动态生成 -->
          <div class="text-center py-8 text-gray-500">加载成就中...</div>
        </div>
      </div>
    </div>

    <!-- 5. 排行榜页面 -->
    <div id="leaderboard-page" class="page hidden p-4">
      <!-- 顶部导航 -->
      <div class="flex justify-between items-center mb-6 pt-2">
        <button class="w-10 h-10 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('home-page')">
          <i class="fa fa-arrow-left text-dark"></i>
        </button>
        <h1 class="text-2xl font-bold text-dark text-shadow">全服排行榜</h1>
        <div class="w-10"></div> <!-- 占位 -->
      </div>

      <!-- 奖励说明 -->
      <div class="bg-white rounded-2xl p-5 shadow-game mb-6">
        <h2 class="text-xl font-bold mb-3">月度奖励</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="bg-yellow-50 rounded-xl p-3 text-center card-hover border-2 border-yellow-200">
            <div class="text-yellow-500 font-bold text-lg mb-1">第1名</div>
            <div class="text-2xl font-bold text-dark">¥100</div>
            <div class="text-xs text-gray-500 mt-1">现金奖励</div>
          </div>
          <div class="bg-gray-50 rounded-xl p-3 text-center card-hover border-2 border-gray-200">
            <div class="text-gray-500 font-bold text-lg mb-1">第2名</div>
            <div class="text-2xl font-bold text-dark">¥50</div>
            <div class="text-xs text-gray-500 mt-1">现金奖励</div>
          </div>
          <div class="bg-orange-50 rounded-xl p-3 text-center card-hover border-2 border-orange-200">
            <div class="text-orange-500 font-bold text-lg mb-1">第3名</div>
            <div class="text-2xl font-bold text-dark">¥30</div>
            <div class="text-xs text-gray-500 mt-1">现金奖励</div>
          </div>
          <div class="bg-green-50 rounded-xl p-3 text-center card-hover border-2 border-green-200">
            <div class="text-green-500 font-bold text-lg mb-1">第4名</div>
            <div class="text-2xl font-bold text-dark">¥20</div>
            <div class="text-xs text-gray-500 mt-1">现金奖励</div>
          </div>
          <div class="bg-blue-50 rounded-xl p-3 text-center card-hover border-2 border-blue-200">
            <div class="text-blue-500 font-bold text-lg mb-1">第5名</div>
            <div class="text-2xl font-bold text-dark">¥10</div>
            <div class="text-xs text-gray-500 mt-1">现金奖励</div>
          </div>
        </div>
        <div class="text-center text-xs text-gray-500 mt-3">
          奖励将在每月最后一天通过支付宝发放
        </div>
      </div>

      <!-- 排行榜列表 -->
      <div class="bg-white rounded-2xl p-5 shadow-game">
        <h2 class="text-xl font-bold mb-4">本月排名</h2>
        <div id="leaderboard-list" class="space-y-3">
          <!-- 排行榜内容由JS动态生成 -->
          <div class="text-center py-8 text-gray-500">加载排行榜中...</div>
        </div>
      </div>
    </div>

    <!-- 6. 提现页面 -->
    <div id="withdrawal-page" class="page hidden p-4">
      <!-- 顶部导航 -->
      <div class="flex justify-between items-center mb-6 pt-2">
        <button class="w-10 h-10 rounded-full bg-white shadow-card flex items-center justify-center btn-hover" onclick="navigateTo('home-page')">
          <i class="fa fa-arrow-left text-dark"></i>
        </button>
        <h1 class="text-2xl font-bold text-dark text-shadow">提现中心</h1>
        <div class="bg-primary/10 text-primary px-3 py-1.5 rounded-full flex items-center text-sm">
          <i class="fa fa-diamond mr-1"></i>
          <span class="balance-display">0</span> 万花币
        </div>
      </div>

      <!-- 提现表单 -->
      <div class="bg-white rounded-2xl p-5 shadow-game mb-6 max-w-md mx-auto">
        <h2 class="text-xl font-bold mb-4">申请提现</h2>
        <form id="withdrawal-form" class="space-y-4">
          <div>
            <label class="block text-gray-700 text-sm mb-1.5">提现金额 (万花币)</label>
            <div class="relative">
              <input 
                type="number" 
                id="withdrawal-amount" 
                class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary" 
                placeholder="1000" 
                step="1000" 
                min="1000"
              >
              <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">
                最低1000，1000的倍数
              </div>
            </div>
            <p class="text-xs text-gray-500 mt-1">1000万花币 = 10元人民币</p>
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm mb-1.5">支付宝账号</label>
            <input 
              type="text" 
              id="alipay-account" 
              class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary" 
              placeholder="手机号或邮箱"
            >
          </div>
          
          <div>
            <label class="block text-gray-700 text-sm mb-1.5">支付宝姓名</label>
            <input 
              type="text" 
              id="alipay-name" 
              class="w-full p-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary" 
              placeholder="真实姓名（与支付宝一致）"
            >
          </div>
          
          <button 
            type="button" 
            id="submit-withdrawal-btn" 
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl btn-hover shadow-btn"
            onclick="submitWithdrawal()"
          >
            提交提现申请
          </button>
        </form>
      </div>

      <!-- 提现历史 -->
      <div class="bg-white rounded-2xl p-5 shadow-game max-w-md mx-auto">
        <h2 class="text-xl font-bold mb-4">提现历史</h2>
        <div id="withdrawal-history" class="space-y-3">
          <!-- 提现历史由JS动态生成 -->
          <div class="text-center py-8 text-gray-500">暂无提现记录</div>
        </div>
      </div>
    </div>

    <!-- 游戏弹窗：关卡完成 -->
    <div id="level-complete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center shadow-xl transform transition-all">
        <div class="text-green-500 text-5xl mb-4">
          <i class="fa fa-check-circle"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">关卡完成！</h2>
        <p class="mb-4">恭喜你通过了关卡 <span id="completed-level" class="current-level-display">1</span></p>
        
        <!-- 奖励信息 -->
        <div class="bg-light p-4 rounded-xl mb-5">
          <div class="mb-2 flex justify-between">
            <span>你的得分:</span>
            <span id="level-complete-score" class="font-bold">0</span>
          </div>
          <div class="mb-2 flex justify-between">
            <span>三星奖励:</span>
            <span id="three-star-reward" class="font-bold text-yellow-500">0</span> 万花币
          </div>
          <div class="flex justify-between text-green-600 font-bold">
            <span>总奖励:</span>
            <span id="level-reward">0</span> 万花币
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex gap-3">
          <button id="exit-level-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-xl btn-hover" onclick="navigateTo('home-page')">
            返回首页
          </button>
          <button id="next-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-xl btn-hover" onclick="startGame(gameState.currentLevel + 1)">
            下一关
          </button>
        </div>
      </div>
    </div>

    <!-- 游戏弹窗：关卡失败 -->
    <div id="level-failed-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
      <div class="bg-white rounded-2xl p-6 max-w-md w-full text-center shadow-xl">
        <div class="text-red-500 text-5xl mb-4">
          <i class="fa fa-times-circle"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">挑战失败</h2>
        <p class="mb-4">再接再厉，争取通过关卡！</p>
        
        <!-- 分数信息 -->
        <div class="bg-light p-4 rounded-xl mb-5">
          <div class="mb-2 flex justify-between">
            <span>你的得分:</span>
            <span id="failed-score" class="font-bold">0</span>
          </div>
          <div class="flex justify-between text-red-500">
            <span>目标得分:</span>
            <span id="failed-target" class="font-bold">0</span>
          </div>
        </div>
        
        <!-- 复活选项 -->
        <div class="grid grid-cols-2 gap-3 mb-5">
          <button id="revive-ad-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl btn-hover flex items-center justify-center">
            <i class="fa fa-play-circle mr-1"></i> 看广告复活
          </button>
          <button id="revive-coin-btn" class="bg-accent hover:bg-accent/80 text-dark py-2 rounded-xl btn-hover flex items-center justify-center">
            <i class="fa fa-diamond mr-1"></i> 50币复活
          </button>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex gap-3">
          <button id="failed-exit-btn" class="flex-1 bg-gray-200 hover:bg-gray-300 py-3 rounded-xl btn-hover" onclick="navigateTo('home-page')">
            返回首页
          </button>
          <button id="retry-level-btn" class="flex-1 bg-primary hover:bg-primary/80 text-white py-3 rounded-xl btn-hover" onclick="startGame(gameState.currentLevel)">
            再试一次
          </button>
        </div>
      </div>
    </div>

    <!-- 游戏弹窗：道具选择（爆炸/障碍跳过） -->
    <div id="道具-selection-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden p-4">
      <div class="bg-white rounded-2xl p-5 max-w-md w-full shadow-xl">
        <h2 id="道具-selection-title" class="text-xl font-bold mb-3 text-center">选择目标</h2>
        <p id="道具-selection-desc" class="text-sm text-gray-500 mb-4 text-center">点击棋盘上的元素/障碍进行操作</p>
        <button id="道具-cancel-btn" class="w-full bg-gray-200 hover:bg-gray-300 py-2.5 rounded-xl btn-hover" onclick="close道具Selection()">
          取消
        </button>
      </div>
    </div>
  </div>

  <!-- 游戏核心逻辑脚本 -->
  <script>
    // Telegram Web App初始化
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#E879F9'); // 顶部栏匹配主色
    tg.setBackgroundColor('#F8FAFC');

    // 全局状态管理（完整功能）
    const gameState = {
      user: null,
      balance: 0,
      currentLevel: 1,
      totalScore: 0,
      gamePlays: null,
      checkinStreak: 0,
      achievements: [],
      isPlaying: false,
      gameBoard: [],
      score: 0,
      moves: 0,
      targetScore: 0,
      movesAllowed: 0,
      timeLimit: 0,
      timeLeft: 0,
      timerInterval: null,
      targetType: 'score', // score/collect/obstacle_clear/boss_clear
      targetValue: 0,
      currentTargetProgress: 0,
      levelData: null,
      boardSize: { rows: 5, cols: 5 }, // 20关后切换为6×6
      selectedTile: null,
      isAnimating: false,
      selected道具Type: null, // 当前选中的道具类型
      道具: {
        shuffle: { used: 0, max: 2, cost: 30, name: '洗牌道具' },
        bomb: { used: 0, max: 1, cost: 60, name: '爆炸特效' },
        add_steps: { used: 0, max: 1, cost: 40, name: '步数加成' },
        skip_obstacle: { used: 0, max: 1, cost: 80, name: '障碍跳过' }
      },
      leaderboard: [],
      developerLink: 'tg://resolve?domain=bjxc010'
    };

    // API基础URL
    const API_BASE_URL = 'https://wanhua-game.bingkuijing.workers.dev/api';

    // 元素配置（万花主题：花朵、星星、月亮、太阳、宝石、铃铛）
    const tileConfig = {
      'flower': { icon: 'fa-pagelines', color: 'flower' },
      'star': { icon: 'fa-star', color: 'star' },
      'moon': { icon: 'fa-moon-o', color: 'moon' },
      'sun': { icon: 'fa-sun-o', color: 'sun' },
      'gem': { icon: 'fa-diamond', color: 'gem' },
      'bell': { icon: 'fa-bell-o', color: 'bell' }
    };

    // 障碍配置
    const obstacleConfig = {
      'ice': { icon: 'fa-snowflake-o', color: 'secondary', clearCount: 1, desc: '冰块（消除1次解冻）' },
      'chain': { icon: 'fa-link', color: 'dark', clearCount: 2, desc: '锁链（消除2次解锁）' },
      'boss': { icon: 'fa-dragon', color: 'accent', clearCount: 3, desc: 'BOSS（特效击中3次击败）' }
    };

    // ====================== 基础工具函数 ======================
    // API请求（带超时+错误处理）
    async function apiRequest(endpoint, method = 'GET', data = null) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

        const url = `${API_BASE_URL}/${endpoint}`;
        const options = { 
          method, 
          headers: { 'Content-Type': 'application/json' },
          signal: controller.signal
        };
        
        if (data) options.body = JSON.stringify(data);
        
        const response = await fetch(url, options);
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || '请求失败');
        
        return result;
      } catch (error) {
        console.error('API请求错误:', error);
        showToast(error.message || '网络请求超时，请重试', 'error');
        throw error;
      }
    }

    // 显示提示（带图标+动画）
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl z-50 flex items-center gap-2 shadow-lg transition-all duration-300 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        type === 'warning' ? 'bg-yellow-500' : 'bg-primary'
      } text-white font-medium`;
      
      const icon = type === 'error' ? 'fa-times-circle' :
                  type === 'success' ? 'fa-check-circle' :
                  type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
      
      toast.innerHTML = `<i class="fa ${icon}"></i> <span>${message}</span>`;
      document.body.appendChild(toast);
      
      // 入场动画
      setTimeout(() => toast.classList.add('translate-y-0'), 10);
      
      // 退场动画
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // 创建消除粒子特效
    function createParticles(x, y, count, color) {
      for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.width = `${Math.random() * 8 + 4}px`;
        particle.style.height = `${Math.random() * 8 + 4}px`;
        particle.style.backgroundColor = `var(--tw-color-${color})`;
        particle.style.borderRadius = '50%';
        particle.style.transform = `translate(${(Math.random() - 0.5) * 40}px, ${(Math.random() - 0.5) * 40}px)`;
        document.body.appendChild(particle);
        
        setTimeout(() => particle.remove(), 800);
      }
    }

    // 显示特效动画（直线/爆炸/十字）
    function showEffectAnimation(type, row, col) {
      const gameBoard = document.getElementById('game-board');
      const boardRect = gameBoard.getBoundingClientRect();
      const tileSize = boardRect.width / gameState.boardSize.cols;
      
      const tileX = boardRect.left + col * tileSize + tileSize / 2;
      const tileY = boardRect.top + row * tileSize + tileSize / 2;
      
      if (type === 'line') {
        // 直线特效（随机水平/垂直）
        const isHorizontal = Math.random() > 0.5;
        const effect = document.createElement('div');
        effect.className = 'line-effect';
        effect.style.position = 'absolute';
        effect.style.height = isHorizontal ? '4px' : '100%';
        effect.style.width = isHorizontal ? '100%' : '4px';
        effect.style.backgroundColor = 'rgba(232, 121, 249, 0.8)';
        effect.style.left = isHorizontal ? boardRect.left : tileX - 2;
        effect.style.top = isHorizontal ? tileY - 2 : boardRect.top;
        effect.style.zIndex = '20';
        
        document.body.appendChild(effect);
        setTimeout(() => effect.remove(), 500);
      } else if (type === 'bomb') {
        // 爆炸特效
        const effect = document.createElement('div');
        effect.className = 'bomb-effect';
        effect.style.width = `${tileSize * 3}px`;
        effect.style.height = `${tileSize * 3}px`;
        effect.style.left = `${tileX - tileSize * 1.5}px`;
        effect.style.top = `${tileY - tileSize * 1.5}px`;
        
        document.body.appendChild(effect);
        setTimeout(() => effect.remove(), 600);
      } else if (type === 'cross') {
        // 十字特效
        const horizontal = document.createElement('div');
        horizontal.className = 'cross-effect';
        horizontal.style.height = '4px';
        horizontal.style.width = `${tileSize * 3}px`;
        horizontal.style.backgroundColor = 'rgba(59, 130, 246, 0.8)';
        horizontal.style.left = `${tileX - tileSize * 1.5}px`;
        horizontal.style.top = `${tileY - 2}px`;
        
        const vertical = document.createElement('div');
        vertical.className = 'cross-effect';
        vertical.style.width = '4px';
        vertical.style.height = `${tileSize * 3}px`;
        vertical.style.backgroundColor = 'rgba(59, 130, 246, 0.8)';
        vertical.style.left = `${tileX - 2}px`;
        vertical.style.top = `${tileY - tileSize * 1.5}px`;
        
        document.body.appendChild(horizontal);
        document.body.appendChild(vertical);
        setTimeout(() => {
          horizontal.remove();
          vertical.remove();
        }, 600);
      }
    }

    // 页面导航（带过渡动画）
    function navigateTo(pageId) {
      // 停止游戏计时器
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }

      // 隐藏所有页面（退场动画）
      document.querySelectorAll('.page').forEach(page => {
        page.classList.add('opacity-0', 'transition-opacity', 'duration-300');
        setTimeout(() => page.classList.add('hidden'), 300);
      });

      // 显示目标页面（入场动画）
      const targetPage = document.getElementById(pageId);
      setTimeout(() => {
        targetPage.classList.remove('hidden');
        setTimeout(() => targetPage.classList.remove('opacity-0'), 10);
      }, 300);

      // 特殊页面初始化
      if (pageId === 'game-page' && !gameState.isPlaying) {
        startGame(gameState.currentLevel);
      } else if (pageId === 'leaderboard-page') {
        loadLeaderboard();
      } else if (pageId === 'personal-center-page') {
        loadPersonalCenter();
      } else if (pageId === 'withdrawal-page') {
        loadWithdrawalHistory();
      }
    }

    // ====================== 用户系统 ======================
    // 初始化用户（加载完整信息）
    async function initUser() {
      try {
        // 从URL获取用户ID
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('user_id');
        
        if (!telegramId) {
          // 从Telegram Web App获取用户信息
          if (tg.initDataUnsafe?.user) {
            const user = tg.initDataUnsafe.user;
            await apiRequest('login', 'POST', {
              queryId: tg.initDataUnsafe.query_id,
              userId: user.id,
              firstName: user.first_name,
              lastName: user.last_name || '',
              username: user.username || ''
            });
            window.location.search = `user_id=${user.id}&username=${encodeURIComponent(user.username || '')}`;
            return;
          } else {
            navigateTo('login-page');
            return;
          }
        }
        
        // 加载用户详细信息（含成就、签到 streak）
        const userData = await apiRequest(`user/info?telegram_id=${telegramId}`);
        gameState.user = userData.user;
        gameState.balance = userData.balance.万花币_balance;
        gameState.currentLevel = userData.progress.current_level;
        gameState.totalScore = userData.progress.total_score;
        gameState.gamePlays = userData.gamePlays;
        gameState.checkinStreak = userData.checkinStreak;
        gameState.achievements = userData.achievements;
        
        // 切换棋盘大小（20关后6×6）
        if (gameState.currentLevel > 20) {
          gameState.boardSize = { rows: 6, cols: 6 };
        }
        
        // 更新全局UI
        updateUserInterface();
        
        // 导航到首页
        navigateTo('home-page');
      } catch (error) {
        console.error('初始化用户失败:', error);
        showToast('登录失败，请重试', 'error');
        navigateTo('login-page');
      }
    }

    // 更新所有页面的用户UI
    function updateUserInterface() {
      // 余额显示（所有页面）
      document.querySelectorAll('.balance-display').forEach(el => {
        el.textContent = gameState.balance.toLocaleString();
      });
      
      // 当前关卡（所有页面）
      document.querySelectorAll('.current-level-display').forEach(el => {
        el.textContent = gameState.currentLevel;
      });
      
      // 总分数（所有页面）
      document.querySelectorAll('.total-score-display').forEach(el => {
        el.textContent = gameState.totalScore.toLocaleString();
      });
      
      // 游戏次数（首页）
      if (gameState.gamePlays && document.querySelector('.remaining-plays')) {
        const remainingFreePlays = 6 - gameState.gamePlays.free_plays_used;
        document.querySelectorAll('.remaining-plays').forEach(el => {
          el.textContent = remainingFreePlays;
        });
      }
      
      // 连续签到（首页+个人中心）
      if (document.getElementById('checkin-streak')) {
        document.getElementById('checkin-streak').textContent = gameState.checkinStreak;
      }
      if (document.getElementById('personal-streak')) {
        document.getElementById('personal-streak').textContent = gameState.checkinStreak;
      }
      
      // 个人中心用户信息
      if (gameState.user) {
        if (document.getElementById('user-avatar')) {
          document.getElementById('user-avatar').src = gameState.user.avatar_url || 'https://via.placeholder.com/100';
          document.getElementById('user-avatar').alt = gameState.user.first_name || '用户';
        }
        if (document.getElementById('user-name')) {
          document.getElementById('user-name').textContent = `${gameState.user.first_name || ''} ${gameState.user.last_name || ''}`.trim() || '未知用户';
        }
        if (document.getElementById('user-telegram-id')) {
          document.getElementById('user-telegram-id').textContent = `@${gameState.user.username || gameState.user.telegram_id}`;
        }
        if (document.getElementById('stat-levels')) {
          document.getElementById('stat-levels').textContent = gameState.currentLevel;
        }
        if (document.getElementById('stat-score')) {
          document.getElementById('stat-score').textContent = gameState.totalScore.toLocaleString();
        }
        if (document.getElementById('stat-streak')) {
          document.getElementById('stat-streak').textContent = gameState.checkinStreak;
        }
      }
      
      // 游戏页面道具按钮状态
      if (document.getElementById('道具-shuffle-btn')) {
        Object.keys(gameState.道具).forEach(key => {
          const btn = document.getElementById(`道具-${key}-btn`);
          if (btn) {
            const 道具 = gameState.道具[key];
            btn.disabled = 道具.used >= 道具.max || gameState.balance < 道具.cost;
            
            if (btn.disabled) {
              btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
              btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            btn.innerHTML = `<i class="${
              key === 'shuffle' ? 'fa-refresh text-primary' :
              key === 'bomb' ? 'fa-bomb text-accent' :
              key === 'add_steps' ? 'fa-plus text-green-500' : 'fa-ban text-red-500'
            } mr-1"></i>
            <span class="text-sm">${道具.name} (${道具.cost}币)</span>
            <span class="ml-1 text-xs text-gray-500">${道具.used}/${道具.max}</span>`;
          }
        });
      }
    }

    // 每日签到
    async function handleCheckin() {
      try {
        const checkinBtn = document.getElementById('checkin-btn');
        checkinBtn.disabled = true;
        checkinBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 签到中...';
        
        const result = await apiRequest('checkin', 'POST', {
          telegram_id: gameState.user.telegram_id
        });
        
        if (result.success) {
          gameState.balance = result.balance;
          gameState.checkinStreak = result.streak;
          showToast(`签到成功！获得${result.reward}万花币，连续签到${result.streak}天`, 'success');
          
          // 签到粒子特效
          const btnRect = checkinBtn.getBoundingClientRect();
          createParticles(btnRect.left + btnRect.width/2, btnRect.top + btnRect.height/2, 30, 'accent');
          
          // 更新按钮状态
          checkinBtn.innerHTML = '<i class="fa fa-check mr-1"></i> 今日已签到';
          checkinBtn.classList.add('bg-green-500');
          checkinBtn.classList.remove('bg-accent');
        } else {
          showToast(result.message);
          checkinBtn.disabled = false;
          checkinBtn.innerHTML = '<i class="fa fa-calendar mr-1"></i> 每日签到 <span class="ml-1 bg-white text-xs px-1.5 py-0.5 rounded-full">x<span id="checkin-streak">0</span></span>';
        }
        
        updateUserInterface();
      } catch (error) {
        console.error('签到失败:', error);
        const checkinBtn = document.getElementById('checkin-btn');
        checkinBtn.disabled = false;
        checkinBtn.innerHTML = '<i class="fa fa-calendar mr-1"></i> 每日签到 <span class="ml-1 bg-white text-xs px-1.5 py-0.5 rounded-full">x<span id="checkin-streak">0</span></span>';
      }
    }

    // 加载个人中心（成就+统计）
    async function loadPersonalCenter() {
      try {
        // 更新成就列表
        const achievementsContainer = document.getElementById('achievements-list');
        achievementsContainer.innerHTML = '';
        
        if (gameState.achievements.length === 0) {
          achievementsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">暂无成就</div>';
          return;
        }
        
        gameState.achievements.forEach(ach => {
          const progressPercent = (ach.progress / ach.target) * 100;
          
          const achievementCard = document.createElement('div');
          achievementCard.className = `bg-white rounded-xl p-4 border border-gray-100 shadow-sm card-hover ${
            ach.completed ? 'border-green-200 bg-green-50' : ''
          }`;
          
          achievementCard.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-bold text-lg ${ach.completed ? 'text-green-600' : 'text-dark'}">${ach.achievement_name}</h3>
              ${ach.completed ? '<i class="fa fa-check-circle text-green-500"></i>' : ''}
            </div>
            <p class="text-gray-600 text-sm mb-3">${ach.description}</p>
            <div class="w-full bg-gray-200 rounded-full h-1.5 mb-1">
              <div class="progress-bar h-1.5 rounded-full ${
                ach.completed ? 'bg-green-500' : 'bg-primary'
              }" style="width: ${progressPercent}%"></div>
            </div>
            <div class="text-xs text-gray-500 flex justify-between">
              <span>${ach.progress}/${ach.target}</span>
              ${ach.completed ? `<span class="text-green-500">已获得 ${ach.reward} 万花币</span>` : ''}
            </div>
          `;
          
          achievementsContainer.appendChild(achievementCard);
        });
        
        // 更新游戏统计（已在updateUserInterface中处理）
      } catch (error) {
        console.error('加载个人中心失败:', error);
        showToast('加载个人中心失败，请重试', 'error');
      }
    }

    // ====================== 游戏核心逻辑 ======================
    // 加载关卡数据（支持多种目标类型）
    async function loadLevelData(levelNumber) {
      try {
        const levelData = await apiRequest(`level?level=${levelNumber}`);
        gameState.levelData = levelData;
        
        // 初始化关卡状态
        gameState.targetType = levelData.target_type;
        gameState.targetScore = levelData.target_score;
        gameState.targetValue = levelData.target_value;
        gameState.currentTargetProgress = 0;
        gameState.movesAllowed = levelData.moves_allowed;
        gameState.timeLimit = levelData.time_limit;
        gameState.timeLeft = levelData.time_limit;
        
        // 重置道具使用次数
        Object.keys(gameState.道具).forEach(key => {
          gameState.道具[key].used = 0;
        });
        
        // 更新目标标签
        const targetLabel = document.getElementById('target-label');
        const progressText = document.getElementById('progress-text');
        if (targetLabel && progressText) {
          switch (gameState.targetType) {
            case 'score':
              targetLabel.textContent = '目标得分';
              progressText.textContent = `${gameState.score}/${gameState.targetScore}`;
              break;
            case 'collect':
              const collectType = levelData.obstacles?.collectType || '花朵';
              targetLabel.textContent = `收集${collectType}`;
              progressText.textContent = `${gameState.currentTargetProgress}/${gameState.targetValue}`;
              break;
            case 'obstacle_clear':
              targetLabel.textContent = '清除障碍';
              progressText.textContent = `${gameState.currentTargetProgress}/${gameState.targetValue}`;
              break;
            case 'boss_clear':
              targetLabel.textContent = '击败BOSS';
              progressText.textContent = `${gameState.currentTargetProgress}/${gameState.targetValue}`;
              break;
          }
        }
        
        // 更新目标值显示
        const targetValueEl = document.getElementById('target-value');
        if (targetValueEl) {
          targetValueEl.textContent = gameState.targetType === 'score' ? 
            gameState.targetScore : gameState.targetValue;
        }
        
        return levelData;
      } catch (error) {
        console.error('加载关卡数据失败:', error);
        showToast('加载关卡失败，请重试', 'error');
        return null;
      }
    }

    // 初始化游戏棋盘（5×5/6×6 + 障碍 + 无初始匹配）
    function initializeGameBoard(rows, cols, obstacles) {
      const board = [];
      const tileTypes = Object.keys(tileConfig);
      
      // 初始化空棋盘
      for (let i = 0; i < rows; i++) {
        board.push([]);
        for (let j = 0; j < cols; j++) {
          board[i].push(null);
        }
      }
      
      // 填充基础元素（确保无初始匹配）
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          let type;
          let isValid = false;
          
          // 尝试生成无初始匹配的元素
          while (!isValid) {
            type = tileTypes[Math.floor(Math.random() * tileTypes.length)];
            board[i][j] = {
              type,
              obstacle: null,
              obstacleClearCount: 0,
              effect: null, // line/bomb/cross（特效类型）
              x: j,
              y: i,
              matched: false,
              selected: false
            };
            
            // 检查水平方向是否有3连
            const hasHorizontalMatch = j >= 2 && 
              board[i][j-1]?.type === type && 
              board[i][j-2]?.type === type;
            
            // 检查垂直方向是否有3连
            const hasVerticalMatch = i >= 2 && 
              board[i-1][j]?.type === type && 
              board[i-2][j]?.type === type;
            
            isValid = !hasHorizontalMatch && !hasVerticalMatch;
          }
        }
      }
      
      // 添加障碍（根据关卡配置）
      if (obstacles && obstacles.type) {
        // 单一障碍类型
        if (obstacles.type === 'single' && obstacles.obstacle && obstacles.count > 0) {
          let added = 0;
          while (added < obstacles.count) {
            const i = Math.floor(Math.random() * rows);
            const j = Math.floor(Math.random() * cols);
            
            if (!board[i][j].obstacle) {
              board[i][j].obstacle = obstacles.obstacle;
              board[i][j].obstacleClearCount = 0;
              added++;
            }
          }
        }
        
        // 混合障碍类型
        if (obstacles.type === 'mixed' && obstacles.obstacles && obstacles.counts) {
          obstacles.obstacles.forEach((obsType, idx) => {
            const count = obstacles.counts[idx] || 0;
            let added = 0;
            while (added < count) {
              const i = Math.floor(Math.random() * rows);
              const j = Math.floor(Math.random() * cols);
              
              if (!board[i][j].obstacle) {
                board[i][j].obstacle = obsType;
                board[i][j].obstacleClearCount = 0;
                added++;
              }
            }
          });
        }
      }
      
      return board;
    }

    // 渲染游戏棋盘（支持触摸+鼠标操作）
    function renderGameBoard() {
      if (!gameState.isPlaying) return;
      
      const gameBoard = document.getElementById('game-board');
      gameBoard.innerHTML = '';
      
      // 棋盘尺寸（响应式，最大400px）
      const boardSize = Math.min(window.innerWidth - 32, 400);
      gameBoard.style.width = `${boardSize}px`;
      gameBoard.style.height = `${boardSize}px`;
      gameBoard.style.gridTemplateColumns = `repeat(${gameState.boardSize.cols}, 1fr)`;
      gameBoard.style.gridTemplateRows = `repeat(${gameState.boardSize.rows}, 1fr)`;
      
      // 渲染每个方块
      gameState.gameBoard.forEach((row, rowIndex) => {
        row.forEach((tile, colIndex) => {
          if (!tile) return;
          
          const tileEl = document.createElement('div');
          const tileSize = `${100 / gameState.boardSize.cols}%`;
          
          // 基础样式
          tileEl.className = `relative flex items-center justify-center rounded-lg shadow-sm transition
